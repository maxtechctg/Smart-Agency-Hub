{"file_contents":{"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/lib/auth-context.tsx":{"content":"import { createContext, useContext, useState, useEffect, ReactNode } from \"react\";\nimport { User } from \"@shared/schema\";\n\ninterface AuthContextType {\n  user: User | null;\n  login: (user: User) => void;\n  logout: () => void;\n  isLoading: boolean;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const [user, setUser] = useState<User | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    const storedUser = localStorage.getItem(\"user\");\n    if (storedUser) {\n      setUser(JSON.parse(storedUser));\n    }\n    setIsLoading(false);\n  }, []);\n\n  const login = (user: User) => {\n    setUser(user);\n    localStorage.setItem(\"user\", JSON.stringify(user));\n  };\n\n  const logout = () => {\n    setUser(null);\n    localStorage.removeItem(\"user\");\n    localStorage.removeItem(\"token\");\n  };\n\n  return (\n    <AuthContext.Provider value={{ user, login, logout, isLoading }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":1248,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"server/services/email.ts":{"content":"import nodemailer from \"nodemailer\";\nimport type { Task, Invoice, Lead, User } from \"@shared/schema\";\n\ninterface EmailConfig {\n  host: string;\n  port: number;\n  secure: boolean;\n  auth?: {\n    user: string;\n    pass: string;\n  };\n  tls?: {\n    rejectUnauthorized: boolean;\n  };\n}\n\nclass EmailService {\n  private transporter: nodemailer.Transporter | null = null;\n  private from: string = \"MaxTech BD <info@maxtechbd.com>\";\n  \n  private getFromAddress(): string {\n    // Use SMTP user email as \"from\" address for better deliverability\n    const smtpUser = process.env.SMTP_USER || process.env.EMAIL_USER;\n    if (smtpUser) {\n      return `MaxTech BD <${smtpUser}>`;\n    }\n    return this.from;\n  }\n  \n  private getEmailFooter(): string {\n    return `\n      <div style=\"background: #f3f4f6; padding: 20px; text-align: center; margin-top: 20px; border-top: 3px solid #C8102E;\">\n        <h3 style=\"color: #C8102E; margin: 0 0 10px 0;\">MaxTech BD</h3>\n        <p style=\"margin: 5px 0; font-size: 12px; color: #6b7280;\">\n          522, SK Mujib Road (4th Floor), Agrabad, Double Mooring<br>\n          Chattogram, Bangladesh\n        </p>\n        <p style=\"margin: 5px 0; font-size: 12px; color: #6b7280;\">\n          Phone: +8801843180008 | Email: info@maxtechbd.com\n        </p>\n      </div>\n    `;\n  }\n\n  constructor() {\n    this.initialize();\n  }\n\n  private async initialize() {\n    // Support both SMTP_ and EMAIL_ prefixes for flexibility\n    const emailHost = process.env.SMTP_HOST || process.env.EMAIL_HOST || \"smtp.gmail.com\";\n    const emailPort = parseInt(process.env.SMTP_PORT || process.env.EMAIL_PORT || \"587\");\n    const emailUser = process.env.SMTP_USER || process.env.EMAIL_USER;\n    const emailPass = process.env.SMTP_PASS || process.env.EMAIL_PASS;\n\n    if (!emailUser || !emailPass) {\n      console.warn(\"Email credentials not configured. Email notifications disabled.\");\n      return;\n    }\n\n    // Some shared hosting providers use certificates for their main domain\n    // Set SMTP_IGNORE_TLS=true only if you trust your mail server\n    const ignoreTls = process.env.SMTP_IGNORE_TLS === \"true\";\n    \n    const config: any = {\n      host: emailHost,\n      port: emailPort,\n      secure: emailPort === 465,\n      connectionTimeout: 10000, // 10 seconds timeout\n      greetingTimeout: 10000,\n      socketTimeout: 15000,\n    };\n    \n    if (ignoreTls) {\n      config.tls = { rejectUnauthorized: false };\n      console.log(\"Warning: TLS certificate validation disabled for SMTP\");\n    }\n\n    if (emailUser && emailPass) {\n      config.auth = {\n        user: emailUser,\n        pass: emailPass,\n      };\n    }\n\n    try {\n      console.log(`Connecting to SMTP: ${emailHost}:${emailPort} as ${emailUser}`);\n      this.transporter = nodemailer.createTransport(config);\n      if (this.transporter) {\n        await this.transporter.verify();\n        console.log(`Email service initialized successfully (from: ${emailUser})`);\n      }\n    } catch (error: any) {\n      console.error(\"Failed to initialize email service:\", error?.message || error);\n      // Don't null the transporter - try to send anyway\n      // Some servers don't support SMTP verify but still accept mail\n      console.log(\"Will attempt to send emails despite verify failure\");\n    }\n  }\n\n  private async sendEmail(to: string, subject: string, html: string) {\n    if (!this.transporter) {\n      console.warn(`Email not sent to ${to}: Email service not configured`);\n      return false;\n    }\n\n    try {\n      await this.transporter.sendMail({\n        from: this.getFromAddress(),\n        to,\n        subject,\n        html,\n      });\n      console.log(`Email sent to ${to}: ${subject}`);\n      return true;\n    } catch (error) {\n      console.error(`Failed to send email to ${to}:`, error);\n      return false;\n    }\n  }\n\n  async sendTaskAssignment(task: Task & { project?: { name: string } }, assignee: User) {\n    const subject = `New Task Assigned: ${task.title}`;\n    const html = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n          .header { background: #C8102E; color: white; padding: 20px; border-radius: 8px 8px 0 0; }\n          .content { background: #f9fafb; padding: 20px; }\n          .task-details { background: white; padding: 15px; border-radius: 6px; margin: 15px 0; }\n          .label { font-weight: bold; color: #6b7280; }\n          .button { display: inline-block; background: #C8102E; color: white; padding: 12px 24px; \n                    text-decoration: none; border-radius: 6px; margin-top: 15px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <h1>New Task Assigned</h1>\n          </div>\n          <div class=\"content\">\n            <p>Hi ${assignee.fullName},</p>\n            <p>You have been assigned a new task:</p>\n            \n            <div class=\"task-details\">\n              <p><span class=\"label\">Task:</span> ${task.title}</p>\n              ${task.description ? `<p><span class=\"label\">Description:</span> ${task.description}</p>` : ''}\n              ${task.project ? `<p><span class=\"label\">Project:</span> ${task.project.name}</p>` : ''}\n              ${task.priority ? `<p><span class=\"label\">Priority:</span> ${task.priority.toUpperCase()}</p>` : ''}\n              ${task.deadline ? `<p><span class=\"label\">Deadline:</span> ${new Date(task.deadline).toLocaleDateString()}</p>` : ''}\n            </div>\n            \n            <a href=\"${process.env.APP_URL || 'http://localhost:5000'}/tasks\" class=\"button\">View Task</a>\n            \n            ${this.getEmailFooter()}\n          </div>\n        </div>\n      </body>\n      </html>\n    `;\n\n    return this.sendEmail(assignee.email, subject, html);\n  }\n\n  async sendInvoiceReminder(invoice: Invoice & { client?: { name: string; email: string } }) {\n    if (!invoice.client) {\n      console.warn(\"Cannot send invoice reminder: client information missing\");\n      return false;\n    }\n\n    const daysUntilDue = Math.ceil(\n      (new Date(invoice.dueDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24)\n    );\n\n    const subject = daysUntilDue < 0 \n      ? `Overdue Invoice Reminder - ${invoice.invoiceNumber}`\n      : `Invoice Due Soon - ${invoice.invoiceNumber}`;\n\n    const html = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n          .header { background: ${daysUntilDue < 0 ? '#dc2626' : '#C8102E'}; color: white; padding: 20px; border-radius: 8px 8px 0 0; }\n          .content { background: #f9fafb; padding: 20px; }\n          .invoice-details { background: white; padding: 15px; border-radius: 6px; margin: 15px 0; }\n          .label { font-weight: bold; color: #6b7280; }\n          .amount { font-size: 24px; font-weight: bold; color: ${daysUntilDue < 0 ? '#dc2626' : '#C8102E'}; }\n          .button { display: inline-block; background: #C8102E; color: white; padding: 12px 24px; \n                    text-decoration: none; border-radius: 6px; margin-top: 15px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <h1>${daysUntilDue < 0 ? 'Overdue Invoice' : 'Invoice Reminder'}</h1>\n          </div>\n          <div class=\"content\">\n            <p>Dear ${invoice.client.name},</p>\n            <p>${daysUntilDue < 0 \n                ? 'This is a reminder that the following invoice is overdue:' \n                : `Your invoice is due ${daysUntilDue === 0 ? 'today' : `in ${daysUntilDue} days`}:`\n              }</p>\n            \n            <div class=\"invoice-details\">\n              <p><span class=\"label\">Invoice Number:</span> ${invoice.invoiceNumber}</p>\n              <p><span class=\"label\">Amount:</span> <span class=\"amount\">${Number(invoice.amount).toLocaleString()}</span></p>\n              <p><span class=\"label\">Due Date:</span> ${new Date(invoice.dueDate).toLocaleDateString()}</p>\n              ${invoice.notes ? `<p><span class=\"label\">Notes:</span> ${invoice.notes}</p>` : ''}\n            </div>\n            \n            <p>Please arrange payment at your earliest convenience.</p>\n            \n            <a href=\"${process.env.APP_URL || 'http://localhost:5000'}/invoices\" class=\"button\">View Invoice</a>\n            \n            ${this.getEmailFooter()}\n          </div>\n        </div>\n      </body>\n      </html>\n    `;\n\n    return this.sendEmail(invoice.client.email, subject, html);\n  }\n\n  async sendLeadFollowUp(lead: Lead & { assignedUser?: User }) {\n    if (!lead.assignedUser) {\n      console.warn(\"Cannot send lead follow-up: assignee information missing\");\n      return false;\n    }\n\n    const subject = `Lead Follow-up Reminder: ${lead.name}`;\n    const html = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n          .header { background: #C8102E; color: white; padding: 20px; border-radius: 8px 8px 0 0; }\n          .content { background: #f9fafb; padding: 20px; }\n          .lead-details { background: white; padding: 15px; border-radius: 6px; margin: 15px 0; }\n          .label { font-weight: bold; color: #6b7280; }\n          .button { display: inline-block; background: #C8102E; color: white; padding: 12px 24px; \n                    text-decoration: none; border-radius: 6px; margin-top: 15px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <h1>Lead Follow-up Reminder</h1>\n          </div>\n          <div class=\"content\">\n            <p>Hi ${lead.assignedUser.fullName},</p>\n            <p>It's time to follow up with this lead:</p>\n            \n            <div class=\"lead-details\">\n              <p><span class=\"label\">Name:</span> ${lead.name}</p>\n              <p><span class=\"label\">Email:</span> ${lead.email}</p>\n              ${lead.phone ? `<p><span class=\"label\">Phone:</span> ${lead.phone}</p>` : ''}\n              <p><span class=\"label\">Status:</span> ${lead.status.toUpperCase()}</p>\n              ${lead.source ? `<p><span class=\"label\">Source:</span> ${lead.source}</p>` : ''}\n              ${lead.notes ? `<p><span class=\"label\">Notes:</span> ${lead.notes}</p>` : ''}\n            </div>\n            \n            <a href=\"${process.env.APP_URL || 'http://localhost:5000'}/leads\" class=\"button\">View Lead</a>\n            \n            ${this.getEmailFooter()}\n          </div>\n        </div>\n      </body>\n      </html>\n    `;\n\n    return this.sendEmail(lead.assignedUser.email, subject, html);\n  }\n\n  async sendWelcomeEmail(user: User) {\n    const subject = \"Welcome to MaxTech BD\";\n    const html = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n          .header { background: #C8102E; color: white; padding: 20px; border-radius: 8px 8px 0 0; text-align: center; }\n          .content { background: #f9fafb; padding: 20px; }\n          .button { display: inline-block; background: #C8102E; color: white; padding: 12px 24px; \n                    text-decoration: none; border-radius: 6px; margin-top: 15px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <h1>Welcome to MaxTech BD!</h1>\n          </div>\n          <div class=\"content\">\n            <p>Hi ${user.fullName},</p>\n            <p>Welcome to MaxTech BD Agency Management System! Your account has been created successfully.</p>\n            \n            <p><strong>Your account details:</strong></p>\n            <ul>\n              <li>Email: ${user.email}</li>\n              <li>Role: ${user.role}</li>\n            </ul>\n            \n            <p>You can now log in and start managing your agency operations efficiently.</p>\n            \n            <a href=\"${process.env.APP_URL || 'http://localhost:5000'}/login\" class=\"button\">Log In Now</a>\n            \n            <p style=\"margin-top: 20px;\">\n              If you have any questions, feel free to reach out to our support team.\n            </p>\n            \n            ${this.getEmailFooter()}\n          </div>\n        </div>\n      </body>\n      </html>\n    `;\n\n    return this.sendEmail(user.email, subject, html);\n  }\n\n  async sendLeadServiceIntroduction(lead: Lead): Promise<boolean> {\n    const subject = \"Discover Our Premium Digital Services - MaxTech BD\";\n    const html = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.8; color: #333; margin: 0; padding: 0; }\n          .container { max-width: 600px; margin: 0 auto; background: #ffffff; }\n          .header { background: linear-gradient(135deg, #C8102E 0%, #8B0000 100%); color: white; padding: 30px; text-align: center; }\n          .header h1 { margin: 0; font-size: 24px; }\n          .content { padding: 30px; background: #f9fafb; }\n          .service-box { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; border-left: 4px solid #C8102E; }\n          .service-box h3 { color: #C8102E; margin: 0 0 10px 0; }\n          .cta-button { display: inline-block; background: #C8102E; color: white; padding: 14px 28px; \n                       text-decoration: none; border-radius: 6px; margin: 20px 0; font-weight: bold; }\n          .whatsapp-btn { display: inline-block; background: #25D366; color: white; padding: 14px 28px; \n                         text-decoration: none; border-radius: 6px; margin: 10px 0; font-weight: bold; }\n          .contact-info { background: #1f2937; color: white; padding: 20px; margin-top: 20px; border-radius: 8px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <h1>Welcome to MaxTech BD</h1>\n            <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Your Partner in Digital Excellence</p>\n          </div>\n          <div class=\"content\">\n            <p>Dear ${lead.name},</p>\n            <p>Thank you for your interest in MaxTech BD! We are a leading digital agency based in Bangladesh, specializing in delivering world-class solutions to businesses worldwide.</p>\n            \n            <h2 style=\"color: #C8102E;\">Our Services</h2>\n            \n            <div class=\"service-box\">\n              <h3>Web Development</h3>\n              <p>Custom websites, e-commerce platforms, web applications using React, Node.js, and modern technologies.</p>\n            </div>\n            \n            <div class=\"service-box\">\n              <h3>Mobile App Development</h3>\n              <p>Native and cross-platform mobile applications for iOS and Android.</p>\n            </div>\n            \n            <div class=\"service-box\">\n              <h3>UI/UX Design</h3>\n              <p>User-centered design, wireframing, prototyping, and brand identity design.</p>\n            </div>\n            \n            <div class=\"service-box\">\n              <h3>Digital Marketing</h3>\n              <p>SEO, social media marketing, content marketing, and PPC campaigns.</p>\n            </div>\n            \n            <div class=\"service-box\">\n              <h3>Custom Software Solutions</h3>\n              <p>Tailored business solutions, CRM systems, and enterprise applications.</p>\n            </div>\n            \n            <p style=\"text-align: center; margin-top: 30px;\">\n              <a href=\"https://wa.me/8801843180008\" class=\"whatsapp-btn\">Chat on WhatsApp</a>\n            </p>\n            \n            <div class=\"contact-info\">\n              <h3 style=\"margin: 0 0 15px 0; color: #C8102E;\">Get in Touch</h3>\n              <p style=\"margin: 5px 0;\">Phone: +8801843180008</p>\n              <p style=\"margin: 5px 0;\">Email: info@maxtechbd.com</p>\n              <p style=\"margin: 5px 0;\">Address: 522, SK Mujib Road (4th Floor), Agrabad, Chattogram</p>\n            </div>\n            \n            ${this.getEmailFooter()}\n          </div>\n        </div>\n      </body>\n      </html>\n    `;\n\n    return this.sendEmail(lead.email, subject, html);\n  }\n\n  async sendLeadCompanyProfile(lead: Lead): Promise<boolean> {\n    const subject = \"About MaxTech BD - Your Trusted Technology Partner\";\n    const html = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.8; color: #333; margin: 0; padding: 0; }\n          .container { max-width: 600px; margin: 0 auto; background: #ffffff; }\n          .header { background: linear-gradient(135deg, #C8102E 0%, #8B0000 100%); color: white; padding: 30px; text-align: center; }\n          .content { padding: 30px; background: #f9fafb; }\n          .highlight-box { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\n          .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }\n          .stat-item { background: #C8102E; color: white; padding: 20px; border-radius: 8px; text-align: center; }\n          .stat-number { font-size: 28px; font-weight: bold; }\n          .whatsapp-btn { display: inline-block; background: #25D366; color: white; padding: 14px 28px; \n                         text-decoration: none; border-radius: 6px; font-weight: bold; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <h1>MaxTech BD</h1>\n            <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Smart Agency Control Hub</p>\n          </div>\n          <div class=\"content\">\n            <p>Dear ${lead.name},</p>\n            \n            <h2 style=\"color: #C8102E;\">Who We Are</h2>\n            <p>MaxTech BD is a premier digital agency headquartered in Chattogram, Bangladesh. We specialize in delivering innovative technology solutions to businesses worldwide, helping them achieve their digital transformation goals.</p>\n            \n            <div class=\"highlight-box\">\n              <h3 style=\"color: #C8102E; margin-top: 0;\">Our Mission</h3>\n              <p>To empower businesses with cutting-edge technology solutions that drive growth, efficiency, and success in the digital age.</p>\n            </div>\n            \n            <div class=\"stat-grid\">\n              <div class=\"stat-item\">\n                <div class=\"stat-number\">100+</div>\n                <div>Projects Delivered</div>\n              </div>\n              <div class=\"stat-item\">\n                <div class=\"stat-number\">50+</div>\n                <div>Happy Clients</div>\n              </div>\n              <div class=\"stat-item\">\n                <div class=\"stat-number\">5+</div>\n                <div>Years Experience</div>\n              </div>\n              <div class=\"stat-item\">\n                <div class=\"stat-number\">24/7</div>\n                <div>Support Available</div>\n              </div>\n            </div>\n            \n            <div class=\"highlight-box\">\n              <h3 style=\"color: #C8102E; margin-top: 0;\">Why Choose Us?</h3>\n              <ul>\n                <li>Experienced team of developers and designers</li>\n                <li>Competitive pricing with quality assurance</li>\n                <li>Timely delivery and transparent communication</li>\n                <li>Post-delivery support and maintenance</li>\n                <li>Global client base with local expertise</li>\n              </ul>\n            </div>\n            \n            <p style=\"text-align: center; margin-top: 30px;\">\n              <a href=\"https://wa.me/8801843180008\" class=\"whatsapp-btn\">Schedule a Meeting</a>\n            </p>\n            \n            ${this.getEmailFooter()}\n          </div>\n        </div>\n      </body>\n      </html>\n    `;\n\n    return this.sendEmail(lead.email, subject, html);\n  }\n\n  async sendLeadPricingBrochure(lead: Lead): Promise<boolean> {\n    const subject = \"MaxTech BD - Service Pricing & Packages\";\n    const html = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.8; color: #333; margin: 0; padding: 0; }\n          .container { max-width: 600px; margin: 0 auto; background: #ffffff; }\n          .header { background: linear-gradient(135deg, #C8102E 0%, #8B0000 100%); color: white; padding: 30px; text-align: center; }\n          .content { padding: 30px; background: #f9fafb; }\n          .pricing-card { background: white; border-radius: 8px; padding: 25px; margin: 15px 0; border: 2px solid #e5e7eb; text-align: center; }\n          .pricing-card.featured { border-color: #C8102E; }\n          .pricing-title { color: #C8102E; font-size: 20px; font-weight: bold; margin-bottom: 10px; }\n          .pricing-price { font-size: 32px; font-weight: bold; color: #1f2937; }\n          .pricing-features { text-align: left; margin: 20px 0; }\n          .pricing-features li { padding: 5px 0; }\n          .cta-button { display: inline-block; background: #C8102E; color: white; padding: 12px 24px; \n                       text-decoration: none; border-radius: 6px; font-weight: bold; margin-top: 15px; }\n          .whatsapp-btn { display: inline-block; background: #25D366; color: white; padding: 14px 28px; \n                         text-decoration: none; border-radius: 6px; font-weight: bold; }\n          .note { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 20px 0; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <h1>Our Pricing Plans</h1>\n            <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Flexible Solutions for Every Budget</p>\n          </div>\n          <div class=\"content\">\n            <p>Dear ${lead.name},</p>\n            <p>Thank you for your interest in our services. Here are our competitive pricing packages:</p>\n            \n            <div class=\"pricing-card\">\n              <div class=\"pricing-title\">Basic Website</div>\n              <div class=\"pricing-price\">From $299</div>\n              <ul class=\"pricing-features\">\n                <li>5-7 Pages Responsive Website</li>\n                <li>Modern UI/UX Design</li>\n                <li>Contact Form Integration</li>\n                <li>SEO Optimized</li>\n                <li>1 Month Free Support</li>\n              </ul>\n              <a href=\"https://wa.me/8801843180008?text=Hi, I'm interested in Basic Website package\" class=\"cta-button\">Get Started</a>\n            </div>\n            \n            <div class=\"pricing-card featured\">\n              <div class=\"pricing-title\">E-Commerce Solution</div>\n              <div class=\"pricing-price\">From $799</div>\n              <ul class=\"pricing-features\">\n                <li>Full E-Commerce Functionality</li>\n                <li>Payment Gateway Integration</li>\n                <li>Product Management System</li>\n                <li>Order Tracking</li>\n                <li>3 Months Free Support</li>\n              </ul>\n              <a href=\"https://wa.me/8801843180008?text=Hi, I'm interested in E-Commerce Solution\" class=\"cta-button\">Get Started</a>\n            </div>\n            \n            <div class=\"pricing-card\">\n              <div class=\"pricing-title\">Custom Software</div>\n              <div class=\"pricing-price\">Custom Quote</div>\n              <ul class=\"pricing-features\">\n                <li>Tailored Business Solutions</li>\n                <li>CRM/ERP Systems</li>\n                <li>API Integrations</li>\n                <li>Scalable Architecture</li>\n                <li>Ongoing Maintenance</li>\n              </ul>\n              <a href=\"https://wa.me/8801843180008?text=Hi, I need a custom software solution\" class=\"cta-button\">Request Quote</a>\n            </div>\n            \n            <div class=\"note\">\n              <strong>Note:</strong> All prices are starting prices. Final cost depends on specific requirements and project scope. Contact us for a detailed quote tailored to your needs.\n            </div>\n            \n            <p style=\"text-align: center; margin-top: 30px;\">\n              <a href=\"https://wa.me/8801843180008\" class=\"whatsapp-btn\">Discuss Your Project</a>\n            </p>\n            \n            ${this.getEmailFooter()}\n          </div>\n        </div>\n      </body>\n      </html>\n    `;\n\n    return this.sendEmail(lead.email, subject, html);\n  }\n\n  async sendLeadFollowUpEmail(lead: Lead): Promise<boolean> {\n    const subject = \"Following Up - How Can We Help You? - MaxTech BD\";\n    const html = `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.8; color: #333; margin: 0; padding: 0; }\n          .container { max-width: 600px; margin: 0 auto; background: #ffffff; }\n          .header { background: linear-gradient(135deg, #C8102E 0%, #8B0000 100%); color: white; padding: 30px; text-align: center; }\n          .content { padding: 30px; background: #f9fafb; }\n          .cta-box { background: white; border-radius: 8px; padding: 25px; margin: 20px 0; text-align: center; border: 2px solid #C8102E; }\n          .whatsapp-btn { display: inline-block; background: #25D366; color: white; padding: 14px 28px; \n                         text-decoration: none; border-radius: 6px; font-weight: bold; margin: 10px; }\n          .email-btn { display: inline-block; background: #C8102E; color: white; padding: 14px 28px; \n                      text-decoration: none; border-radius: 6px; font-weight: bold; margin: 10px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <h1>We'd Love to Hear From You!</h1>\n          </div>\n          <div class=\"content\">\n            <p>Dear ${lead.name},</p>\n            \n            <p>We hope this email finds you well! We recently reached out about our digital services and wanted to follow up to see if you have any questions.</p>\n            \n            <p>At MaxTech BD, we understand that choosing the right technology partner is an important decision. We're here to help answer any questions you might have about:</p>\n            \n            <ul>\n              <li>Our services and capabilities</li>\n              <li>Pricing and project timelines</li>\n              <li>Our development process</li>\n              <li>Past projects and case studies</li>\n            </ul>\n            \n            <div class=\"cta-box\">\n              <h3 style=\"color: #C8102E; margin-top: 0;\">Ready to Start Your Project?</h3>\n              <p>Let's discuss how we can help bring your ideas to life!</p>\n              <a href=\"https://wa.me/8801843180008\" class=\"whatsapp-btn\">WhatsApp Us</a>\n              <a href=\"mailto:info@maxtechbd.com\" class=\"email-btn\">Email Us</a>\n            </div>\n            \n            <p>If you're not ready to move forward just yet, no problem at all! Feel free to keep our information on file for when the time is right.</p>\n            \n            <p>We look forward to the opportunity to work with you!</p>\n            \n            <p>Best regards,<br><strong>The MaxTech BD Team</strong></p>\n            \n            ${this.getEmailFooter()}\n          </div>\n        </div>\n      </body>\n      </html>\n    `;\n\n    return this.sendEmail(lead.email, subject, html);\n  }\n\n  getTemplateSubject(templateName: string): string {\n    const subjects: Record<string, string> = {\n      \"service_introduction\": \"Discover Our Premium Digital Services - MaxTech BD\",\n      \"company_profile\": \"About MaxTech BD - Your Trusted Technology Partner\",\n      \"pricing_brochure\": \"MaxTech BD - Service Pricing & Packages\",\n      \"follow_up_reminder\": \"Following Up - How Can We Help You? - MaxTech BD\",\n    };\n    return subjects[templateName] || \"Message from MaxTech BD\";\n  }\n\n  async sendLeadTemplateEmail(lead: Lead, templateName: string): Promise<boolean> {\n    switch (templateName) {\n      case \"service_introduction\":\n        return this.sendLeadServiceIntroduction(lead);\n      case \"company_profile\":\n        return this.sendLeadCompanyProfile(lead);\n      case \"pricing_brochure\":\n        return this.sendLeadPricingBrochure(lead);\n      case \"follow_up_reminder\":\n        return this.sendLeadFollowUpEmail(lead);\n      default:\n        console.warn(`Unknown template: ${templateName}`);\n        return false;\n    }\n  }\n\n  isConfigured(): boolean {\n    return this.transporter !== null;\n  }\n}\n\nexport const emailService = new EmailService();\n","path":null,"size_bytes":28776,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { Users, UserPlus, Briefcase, DollarSign, TrendingUp, Clock, CheckSquare, FileText, Folder } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport ClientDashboard from \"./client-dashboard\";\nimport { formatDistanceToNow } from \"date-fns\";\n\ninterface AdminDashboardStats {\n  totalLeads: number;\n  totalClients: number;\n  activeProjects: number;\n  monthlyRevenue: number;\n  monthlyExpenses: number;\n  attendanceRate: number;\n  leadsGrowth: number;\n  revenueGrowth: number;\n}\n\ninterface DeveloperDashboardStats {\n  totalProjects: number;\n  activeProjects: number;\n  totalTasks: number;\n  myTasks: number;\n  completedTasks: number;\n  totalFiles: number;\n  attendanceRate: number;\n}\n\ninterface AdminRecentActivity {\n  leads: Array<{ id: string; name: string; createdAt: string }>;\n  projects: Array<{ id: string; name: string; status: string; createdAt: string }>;\n  invoices: Array<{ id: string; invoiceNumber: string; amount: string; createdAt: string }>;\n}\n\ninterface DeveloperRecentActivity {\n  tasks: Array<{ id: string; title: string; status: string; createdAt: string }>;\n  files: Array<{ id: string; name: string; createdAt: string }>;\n}\n\ninterface AdminUpcomingDeadlines {\n  projects: Array<{ id: string; name: string; endDate: string; status: string }>;\n  tasks: Array<{ id: string; title: string; dueDate: string; priority: string; status: string }>;\n}\n\ninterface DeveloperUpcomingDeadlines {\n  tasks: Array<{ id: string; title: string; dueDate: string; priority: string; status: string }>;\n}\n\nexport default function Dashboard() {\n  const { user } = useAuth();\n  const { data: stats, isLoading } = useQuery<AdminDashboardStats | DeveloperDashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  const { data: recentActivity, isLoading: isLoadingActivity } = useQuery<AdminRecentActivity | DeveloperRecentActivity>({\n    queryKey: [\"/api/dashboard/recent-activity\"],\n    enabled: !!user?.role && user.role !== \"client\",\n  });\n\n  const { data: upcomingDeadlines, isLoading: isLoadingDeadlines } = useQuery<AdminUpcomingDeadlines | DeveloperUpcomingDeadlines>({\n    queryKey: [\"/api/dashboard/upcoming-deadlines\"],\n    enabled: !!user?.role && user.role !== \"client\",\n  });\n\n  // Render client-specific dashboard for client role\n  if (user?.role === \"client\") {\n    return <ClientDashboard />;\n  }\n\n  // Wait for user role to be loaded to prevent flashing sensitive data\n  if (!user?.role) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-3xl font-bold\">Dashboard</h1>\n        </div>\n        <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3, 4, 5, 6].map((i) => (\n            <Card key={i}>\n              <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                <div className=\"h-4 bg-muted rounded w-24 animate-pulse\" />\n                <div className=\"h-8 w-8 bg-muted rounded animate-pulse\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-8 bg-muted rounded w-16 mb-2 animate-pulse\" />\n                <div className=\"h-3 bg-muted rounded w-20 animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  // Developer-specific KPIs (sanitized, no sensitive data)\n  const developerKpis: Array<{\n    title: string;\n    value: string | number;\n    icon: any;\n    color: string;\n    bgColor: string;\n  }> = [\n    {\n      title: \"Total Projects\",\n      value: (stats as DeveloperDashboardStats)?.totalProjects ?? 0,\n      icon: Folder,\n      color: \"text-purple-600\",\n      bgColor: \"bg-purple-100 dark:bg-purple-950\",\n    },\n    {\n      title: \"Active Projects\",\n      value: (stats as DeveloperDashboardStats)?.activeProjects ?? 0,\n      icon: Briefcase,\n      color: \"text-blue-600\",\n      bgColor: \"bg-blue-100 dark:bg-blue-950\",\n    },\n    {\n      title: \"All Tasks\",\n      value: (stats as DeveloperDashboardStats)?.totalTasks ?? 0,\n      icon: CheckSquare,\n      color: \"text-green-600\",\n      bgColor: \"bg-green-100 dark:bg-green-950\",\n    },\n    {\n      title: \"My Tasks\",\n      value: (stats as DeveloperDashboardStats)?.myTasks ?? 0,\n      icon: CheckSquare,\n      color: \"text-indigo-600\",\n      bgColor: \"bg-indigo-100 dark:bg-indigo-950\",\n    },\n    {\n      title: \"Completed Tasks\",\n      value: (stats as DeveloperDashboardStats)?.completedTasks ?? 0,\n      icon: CheckSquare,\n      color: \"text-emerald-600\",\n      bgColor: \"bg-emerald-100 dark:bg-emerald-950\",\n    },\n    {\n      title: \"Total Files\",\n      value: (stats as DeveloperDashboardStats)?.totalFiles ?? 0,\n      icon: FileText,\n      color: \"text-orange-600\",\n      bgColor: \"bg-orange-100 dark:bg-orange-950\",\n    },\n    {\n      title: \"My Attendance\",\n      value: `${(stats as DeveloperDashboardStats)?.attendanceRate ?? 0}%`,\n      icon: Clock,\n      color: \"text-cyan-600\",\n      bgColor: \"bg-cyan-100 dark:bg-cyan-950\",\n    },\n  ];\n\n  // Admin/Operational Head KPIs (full access)\n  const adminKpis: Array<{\n    title: string;\n    value: string | number;\n    icon: any;\n    trend?: number;\n    color: string;\n    bgColor: string;\n  }> = [\n    {\n      title: \"Total Leads\",\n      value: (stats as AdminDashboardStats)?.totalLeads ?? 0,\n      icon: UserPlus,\n      trend: (stats as AdminDashboardStats)?.leadsGrowth ?? 0,\n      color: \"text-blue-600\",\n      bgColor: \"bg-blue-100 dark:bg-blue-950\",\n    },\n    {\n      title: \"Active Clients\",\n      value: (stats as AdminDashboardStats)?.totalClients ?? 0,\n      icon: Users,\n      trend: 0,\n      color: \"text-green-600\",\n      bgColor: \"bg-green-100 dark:bg-green-950\",\n    },\n    {\n      title: \"Active Projects\",\n      value: (stats as AdminDashboardStats)?.activeProjects ?? 0,\n      icon: Briefcase,\n      trend: 0,\n      color: \"text-purple-600\",\n      bgColor: \"bg-purple-100 dark:bg-purple-950\",\n    },\n    {\n      title: \"Monthly Revenue\",\n      value: (stats as AdminDashboardStats)?.monthlyRevenue ?? 0,\n      icon: DollarSign,\n      trend: (stats as AdminDashboardStats)?.revenueGrowth ?? 0,\n      color: \"text-emerald-600\",\n      bgColor: \"bg-emerald-100 dark:bg-emerald-950\",\n    },\n    {\n      title: \"Monthly Expenses\",\n      value: `${(stats as AdminDashboardStats)?.monthlyExpenses ?? 0}`,\n      icon: TrendingUp,\n      trend: 0,\n      color: \"text-red-600\",\n      bgColor: \"bg-red-100 dark:bg-red-950\",\n    },\n    {\n      title: \"Attendance Rate\",\n      value: `${(stats as AdminDashboardStats)?.attendanceRate ?? 0}%`,\n      icon: Clock,\n      trend: 0,\n      color: \"text-orange-600\",\n      bgColor: \"bg-orange-100 dark:bg-orange-950\",\n    },\n  ];\n\n  // Select KPIs based on user role\n  const kpis = user?.role === \"developer\" ? developerKpis : adminKpis;\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-3xl font-bold\">Dashboard</h1>\n        </div>\n        <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3, 4, 5, 6].map((i) => (\n            <Card key={i}>\n              <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                <div className=\"h-4 bg-muted rounded w-24 animate-pulse\" />\n                <div className=\"h-8 w-8 bg-muted rounded animate-pulse\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-8 bg-muted rounded w-16 mb-2 animate-pulse\" />\n                <div className=\"h-3 bg-muted rounded w-20 animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case \"high\": return { text: \"text-orange-600\", bg: \"bg-orange-100 dark:bg-orange-950\" };\n      case \"medium\": return { text: \"text-yellow-600\", bg: \"bg-yellow-100 dark:bg-yellow-950\" };\n      case \"low\": return { text: \"text-blue-600\", bg: \"bg-blue-100 dark:bg-blue-950\" };\n      default: return { text: \"text-gray-600\", bg: \"bg-gray-100 dark:bg-gray-950\" };\n    }\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"active\": return \"text-green-500\";\n      case \"in_progress\": return \"text-blue-500\";\n      case \"pending\": return \"text-yellow-500\";\n      case \"completed\": case \"done\": return \"text-purple-500\";\n      default: return \"text-gray-500\";\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-dashboard-title\">Dashboard</h1>\n          <p className=\"text-sm text-muted-foreground\">Welcome to MaxTech BD Control Hub</p>\n        </div>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n        {kpis.map((kpi) => (\n          <Card key={kpi.title} data-testid={`card-kpi-${kpi.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">{kpi.title}</CardTitle>\n              <div className={`p-2 rounded-md ${kpi.bgColor}`}>\n                <kpi.icon className={`h-4 w-4 ${kpi.color}`} />\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid={`text-${kpi.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                {kpi.value}\n              </div>\n              {'trend' in kpi && typeof kpi.trend === 'number' && kpi.trend !== 0 && (\n                <p className=\"text-xs text-muted-foreground\">\n                  {kpi.trend > 0 ? \"+\" : \"\"}\n                  {kpi.trend}% from last month\n                </p>\n              )}\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Recent Activity</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {isLoadingActivity ? (\n              <div className=\"space-y-4\">\n                {[1, 2, 3].map((i) => (\n                  <div key={i} className=\"flex items-center gap-4 p-3 rounded-md bg-muted/50\">\n                    <div className=\"w-2 h-2 bg-muted rounded-full animate-pulse\" />\n                    <div className=\"flex-1 space-y-2\">\n                      <div className=\"h-4 bg-muted rounded w-3/4 animate-pulse\" />\n                      <div className=\"h-3 bg-muted rounded w-1/2 animate-pulse\" />\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : user?.role === \"developer\" ? (\n              <div className=\"space-y-4\">\n                {recentActivity && 'tasks' in recentActivity && recentActivity.tasks.length > 0 ? (\n                  recentActivity.tasks.slice(0, 3).map((task) => (\n                    <div key={task.id} className=\"flex items-center gap-4 p-3 rounded-md bg-muted/50\">\n                      <div className={`w-2 h-2 rounded-full ${getStatusColor(task.status)}`} />\n                      <div className=\"flex-1\">\n                        <p className=\"text-sm font-medium\">{task.title}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {task.status}  {formatDistanceToNow(new Date(task.createdAt), { addSuffix: true })}\n                        </p>\n                      </div>\n                    </div>\n                  ))\n                ) : (\n                  <p className=\"text-sm text-muted-foreground\">No recent activity</p>\n                )}\n                {recentActivity && 'files' in recentActivity && recentActivity.files.length > 0 && (\n                  recentActivity.files.slice(0, 2).map((file) => (\n                    <div key={file.id} className=\"flex items-center gap-4 p-3 rounded-md bg-muted/50\">\n                      <div className=\"w-2 h-2 bg-purple-500 rounded-full\" />\n                      <div className=\"flex-1\">\n                        <p className=\"text-sm font-medium\">File uploaded: {file.name}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {formatDistanceToNow(new Date(file.createdAt), { addSuffix: true })}\n                        </p>\n                      </div>\n                    </div>\n                  ))\n                )}\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {recentActivity && 'leads' in recentActivity && recentActivity.leads.map((lead) => (\n                  <div key={lead.id} className=\"flex items-center gap-4 p-3 rounded-md bg-muted/50\">\n                    <div className=\"w-2 h-2 bg-green-500 rounded-full\" />\n                    <div className=\"flex-1\">\n                      <p className=\"text-sm font-medium\">New lead added: {lead.name}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {formatDistanceToNow(new Date(lead.createdAt), { addSuffix: true })}\n                      </p>\n                    </div>\n                  </div>\n                ))}\n                {recentActivity && 'projects' in recentActivity && recentActivity.projects.map((project) => (\n                  <div key={project.id} className=\"flex items-center gap-4 p-3 rounded-md bg-muted/50\">\n                    <div className={`w-2 h-2 rounded-full ${getStatusColor(project.status)}`} />\n                    <div className=\"flex-1\">\n                      <p className=\"text-sm font-medium\">Project: {project.name}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {project.status}  {formatDistanceToNow(new Date(project.createdAt), { addSuffix: true })}\n                      </p>\n                    </div>\n                  </div>\n                ))}\n                {recentActivity && 'invoices' in recentActivity && recentActivity.invoices.map((invoice) => (\n                  <div key={invoice.id} className=\"flex items-center gap-4 p-3 rounded-md bg-muted/50\">\n                    <div className=\"w-2 h-2 bg-orange-500 rounded-full\" />\n                    <div className=\"flex-1\">\n                      <p className=\"text-sm font-medium\">Invoice: {invoice.invoiceNumber}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        BDT {invoice.amount}  {formatDistanceToNow(new Date(invoice.createdAt), { addSuffix: true })}\n                      </p>\n                    </div>\n                  </div>\n                ))}\n                {(!recentActivity || ('leads' in recentActivity && recentActivity.leads.length === 0 && recentActivity.projects.length === 0 && recentActivity.invoices.length === 0)) && (\n                  <p className=\"text-sm text-muted-foreground\">No recent activity</p>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>{user?.role === \"developer\" ? \"My Upcoming Tasks\" : \"Upcoming Deadlines\"}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {isLoadingDeadlines ? (\n              <div className=\"space-y-4\">\n                {[1, 2, 3].map((i) => (\n                  <div key={i} className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\">\n                    <div className=\"space-y-2 flex-1\">\n                      <div className=\"h-4 bg-muted rounded w-3/4 animate-pulse\" />\n                      <div className=\"h-3 bg-muted rounded w-1/2 animate-pulse\" />\n                    </div>\n                    <div className=\"h-6 w-16 bg-muted rounded animate-pulse ml-4\" />\n                  </div>\n                ))}\n              </div>\n            ) : user?.role === \"developer\" ? (\n              <div className=\"space-y-4\">\n                {upcomingDeadlines && 'tasks' in upcomingDeadlines && upcomingDeadlines.tasks.length > 0 ? (\n                  upcomingDeadlines.tasks.map((task) => {\n                    const priorityColors = getPriorityColor(task.priority);\n                    const daysUntil = Math.ceil((new Date(task.dueDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));\n                    return (\n                      <div key={task.id} className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\">\n                        <div>\n                          <p className=\"text-sm font-medium\">{task.title}</p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            Due in {daysUntil} {daysUntil === 1 ? 'day' : 'days'}\n                          </p>\n                        </div>\n                        <span className={`text-xs font-medium ${priorityColors.text} ${priorityColors.bg} px-2 py-1 rounded capitalize`}>\n                          {task.priority}\n                        </span>\n                      </div>\n                    );\n                  })\n                ) : (\n                  <p className=\"text-sm text-muted-foreground\">No upcoming tasks</p>\n                )}\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {upcomingDeadlines && 'projects' in upcomingDeadlines && upcomingDeadlines.projects.map((project) => {\n                  const daysUntil = Math.ceil((new Date(project.endDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));\n                  const priority = daysUntil <= 3 ? 'high' : daysUntil <= 7 ? 'medium' : 'low';\n                  const priorityColors = getPriorityColor(priority);\n                  return (\n                    <div key={project.id} className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\">\n                      <div>\n                        <p className=\"text-sm font-medium\">{project.name}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          Due in {daysUntil} {daysUntil === 1 ? 'day' : 'days'}\n                        </p>\n                      </div>\n                      <span className={`text-xs font-medium ${priorityColors.text} ${priorityColors.bg} px-2 py-1 rounded capitalize`}>\n                        {priority}\n                      </span>\n                    </div>\n                  );\n                })}\n                {upcomingDeadlines && 'tasks' in upcomingDeadlines && upcomingDeadlines.tasks.map((task) => {\n                  const priorityColors = getPriorityColor(task.priority);\n                  const daysUntil = Math.ceil((new Date(task.dueDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));\n                  return (\n                    <div key={task.id} className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\">\n                      <div>\n                        <p className=\"text-sm font-medium\">{task.title}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          Due in {daysUntil} {daysUntil === 1 ? 'day' : 'days'}\n                        </p>\n                      </div>\n                      <span className={`text-xs font-medium ${priorityColors.text} ${priorityColors.bg} px-2 py-1 rounded capitalize`}>\n                        {task.priority}\n                      </span>\n                    </div>\n                  );\n                })}\n                {(!upcomingDeadlines || ('projects' in upcomingDeadlines && upcomingDeadlines.projects.length === 0 && upcomingDeadlines.tasks.length === 0)) && (\n                  <p className=\"text-sm text-muted-foreground\">No upcoming deadlines</p>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":20021,"size_tokens":null},"client/src/lib/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState, ReactNode } from \"react\";\n\ntype Theme = \"light\" | \"dark\";\n\ninterface ThemeContextType {\n  theme: Theme;\n  toggleTheme: () => void;\n}\n\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\n\nexport function ThemeProvider({ children }: { children: ReactNode }) {\n  const [theme, setTheme] = useState<Theme>(\"light\");\n\n  useEffect(() => {\n    const stored = localStorage.getItem(\"theme\") as Theme;\n    if (stored) {\n      setTheme(stored);\n      document.documentElement.classList.toggle(\"dark\", stored === \"dark\");\n    }\n  }, []);\n\n  const toggleTheme = () => {\n    const newTheme = theme === \"light\" ? \"dark\" : \"light\";\n    setTheme(newTheme);\n    localStorage.setItem(\"theme\", newTheme);\n    document.documentElement.classList.toggle(\"dark\", newTheme === \"dark\");\n  };\n\n  return (\n    <ThemeContext.Provider value={{ theme, toggleTheme }}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const context = useContext(ThemeContext);\n  if (context === undefined) {\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":1170,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Shield, Users, BarChart3, Zap, CheckCircle2, Eye, EyeOff } from \"lucide-react\";\nimport logoImage from \"@assets/Untitled_design__1_-removebg-preview_1764044009686.png\";\n\nconst loginSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n});\n\ntype LoginFormData = z.infer<typeof loginSchema>;\n\nexport default function Login() {\n  const [, setLocation] = useLocation();\n  const { login } = useAuth();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n\n  const form = useForm<LoginFormData>({\n    resolver: zodResolver(loginSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n    },\n  });\n\n  const onSubmit = async (data: LoginFormData) => {\n    setIsLoading(true);\n    try {\n      const response = await fetch(\"/api/auth/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Invalid credentials\");\n      }\n\n      const { user, token } = await response.json();\n      localStorage.setItem(\"token\", token);\n      login(user);\n      toast({\n        title: \"Welcome back!\",\n        description: \"You have successfully logged in.\",\n      });\n      setLocation(\"/\");\n    } catch (error) {\n      toast({\n        title: \"Login failed\",\n        description: \"Invalid email or password\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const features = [\n    { icon: Shield, title: \"Secure & Reliable\", description: \"Enterprise-grade security for your data\" },\n    { icon: Users, title: \"Team Management\", description: \"Manage your entire team in one place\" },\n    { icon: BarChart3, title: \"Analytics\", description: \"Real-time insights and reports\" },\n    { icon: Zap, title: \"Fast & Efficient\", description: \"Streamlined workflow automation\" },\n  ];\n\n  return (\n    <div className=\"min-h-screen flex\">\n      {/* Left Panel - Branding & Features */}\n      <div className=\"hidden lg:flex lg:w-1/2 bg-gradient-to-br from-primary via-primary/90 to-primary/80 relative overflow-hidden\">\n        {/* Decorative Elements */}\n        <div className=\"absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmZmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTM2IDM0djItSDI0di0yaDEyek0zNiAyNHYySDI0di0yaDEyeiIvPjwvZz48L2c+PC9zdmc+')] opacity-30\"></div>\n        <div className=\"absolute -top-24 -left-24 w-96 h-96 bg-white/10 rounded-full blur-3xl\"></div>\n        <div className=\"absolute -bottom-24 -right-24 w-96 h-96 bg-white/10 rounded-full blur-3xl\"></div>\n        \n        <div className=\"relative z-10 flex flex-col justify-center px-12 xl:px-20 text-white\">\n          {/* Logo */}\n          <div className=\"mb-8\">\n            <div className=\"bg-white/95 backdrop-blur-sm rounded-2xl p-4 inline-block shadow-2xl\">\n              <img src={logoImage} alt=\"MaxTech BD\" className=\"h-16 object-contain\" />\n            </div>\n          </div>\n          \n          {/* Headline */}\n          <h1 className=\"text-4xl xl:text-5xl font-bold mb-4 leading-tight\">\n            Smart Agency<br />Control Hub\n          </h1>\n          <p className=\"text-lg xl:text-xl text-white/80 mb-12 max-w-md\">\n            Streamline your agency operations with our comprehensive management platform.\n          </p>\n          \n          {/* Features Grid */}\n          <div className=\"grid grid-cols-2 gap-6\">\n            {features.map((feature, index) => (\n              <div \n                key={index}\n                className=\"flex items-start gap-3 bg-white/10 backdrop-blur-sm rounded-xl p-4 hover:bg-white/15 transition-colors\"\n              >\n                <div className=\"p-2 bg-white/20 rounded-lg\">\n                  <feature.icon className=\"w-5 h-5\" />\n                </div>\n                <div>\n                  <h3 className=\"font-semibold text-sm\">{feature.title}</h3>\n                  <p className=\"text-xs text-white/70 mt-0.5\">{feature.description}</p>\n                </div>\n              </div>\n            ))}\n          </div>\n\n          {/* Trust Badges */}\n          <div className=\"mt-12 pt-8 border-t border-white/20\">\n            <div className=\"flex items-center gap-6 text-sm text-white/70\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-300\" />\n                <span>99.9% Uptime</span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-300\" />\n                <span>24/7 Support</span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-300\" />\n                <span>Secure</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Right Panel - Login Form */}\n      <div className=\"w-full lg:w-1/2 flex items-center justify-center p-6 sm:p-12 bg-background\">\n        <div className=\"w-full max-w-md\">\n          {/* Mobile Logo */}\n          <div className=\"lg:hidden flex justify-center mb-8\">\n            <img src={logoImage} alt=\"MaxTech BD\" className=\"h-16 object-contain\" />\n          </div>\n\n          {/* Welcome Header */}\n          <div className=\"text-center mb-8\">\n            <h2 className=\"text-3xl font-bold text-foreground mb-2\">Welcome Back</h2>\n            <p className=\"text-muted-foreground\">Sign in to continue to your dashboard</p>\n          </div>\n\n          {/* Login Form */}\n          <div className=\"bg-card rounded-2xl border shadow-sm p-8\">\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-5\">\n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm font-medium\">Email Address</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"you@example.com\" \n                          className=\"h-12 px-4 bg-background border-border/50 focus:border-primary transition-colors\"\n                          {...field} \n                          data-testid=\"input-email\" \n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"password\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm font-medium\">Password</FormLabel>\n                      <FormControl>\n                        <div className=\"relative\">\n                          <Input \n                            type={showPassword ? \"text\" : \"password\"}\n                            placeholder=\"Enter your password\" \n                            className=\"h-12 px-4 pr-12 bg-background border-border/50 focus:border-primary transition-colors\"\n                            {...field} \n                            data-testid=\"input-password\" \n                          />\n                          <button\n                            type=\"button\"\n                            onClick={() => setShowPassword(!showPassword)}\n                            className=\"absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors\"\n                            data-testid=\"button-toggle-password\"\n                          >\n                            {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                          </button>\n                        </div>\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex items-center justify-between text-sm\">\n                  <label className=\"flex items-center gap-2 cursor-pointer\">\n                    <input type=\"checkbox\" className=\"w-4 h-4 rounded border-border text-primary focus:ring-primary\" />\n                    <span className=\"text-muted-foreground\">Remember me</span>\n                  </label>\n                  <a href=\"#\" className=\"text-primary hover:underline font-medium\">Forgot password?</a>\n                </div>\n\n                <Button \n                  type=\"submit\" \n                  className=\"w-full h-12 text-base font-semibold shadow-lg hover:shadow-xl transition-all\" \n                  disabled={isLoading} \n                  data-testid=\"button-login\"\n                >\n                  {isLoading ? (\n                    <span className=\"flex items-center gap-2\">\n                      <svg className=\"animate-spin h-5 w-5\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                      </svg>\n                      Signing in...\n                    </span>\n                  ) : \"Sign In\"}\n                </Button>\n              </form>\n            </Form>\n          </div>\n\n          {/* Footer */}\n          <div className=\"mt-8 text-center text-xs text-muted-foreground\">\n            <p> 2024 MaxTech BD. All rights reserved.</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10516,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"replit.md":{"content":"# MaxTech BD - Smart Agency Control Hub\n\n## Overview\nMaxTech BD is a comprehensive enterprise agency management system designed to streamline operations across various departments. It integrates 12 core modules for managing leads, clients, projects, staff, and finances within a single platform. The system aims to enhance efficiency, improve decision-making through real-time data, and provide a unified control hub for agencies. Key capabilities include robust CRM, project management, financial tracking, HR and payroll functionalities with biometric device integration, and a dedicated client portal for transparent communication.\n\n## User Preferences\nI prefer simple language. I want iterative development. Ask before making major changes.\n\n## System Architecture\n\n### UI/UX Decisions\nThe frontend is built with React, TypeScript, Vite, Tailwind CSS, and shadcn/ui, ensuring a modern, responsive, and accessible user interface. The design emphasizes a consistent visual language and intuitive navigation through a professionally organized sidebar menu with four main sections:\n- **MAIN MENU**: Dashboard, Leads, Clients, Projects, Tasks, Team, Communication (expandable: Chat, Files)\n- **HR MANAGEMENT**: Attendance, Employees, Departments, Leave Management, Payroll (expandable: Salary Sheet, Salary Slip, Attendance Report, Leave Summary)\n- **ACCOUNTS & FINANCE**: Invoices, Payments, Expense Categories, Salary Payments, Financial Reports, Profit & Loss, General Ledger, Payroll Report, Payment Receipt\n- **SETTINGS**: Office Settings, Profile, Logout\n\nThe sidebar features bold uppercase section headers, expandable/collapsible sub-menus for Communication and Payroll, consistent spacing between groups, and proper visual hierarchy. Client-facing interfaces are tailored to provide relevant information without overwhelming the user.\n\n### Technical Implementations\n- **Frontend**: React, TypeScript, Vite, Tailwind CSS, shadcn/ui.\n- **Backend**: Express.js, TypeScript.\n- **Database**: PostgreSQL (Neon) with Drizzle ORM.\n- **Authentication**: JWT with role-based access control (Admin, Operational Head, Developer, Client). Tokens are stored in localStorage with auto-logout on 401. Both REST API and WebSocket use the same JWT_SECRET for consistent token verification.\n- **Data Handling**: Comprehensive 4-layer date handling architecture for standardization, including shared utilities, backend serialization, and frontend normalization to ensure timezone-safe and accurate date representations across the system.\n- **Email Notifications**: NodeMailer-based service with scheduled tasks for welcome emails, task assignments, invoice reminders, and lead follow-up reminders.\n- **Real-time Communication**: WebSocket server for live chat with auto-subscription feature. Features project-based message broadcasting, JWT authentication, and automatic reconnection with exponential backoff. Messages follow industry-standard UX (WhatsApp/Messenger pattern).\n- **HR and Payroll**: Advanced HR module with 14 new database tables for departments, designations, employees, attendance devices, leave management, payroll, and performance tracking. Includes a pluggable device adapter system for biometric devices and an attendance sync service.\n- **File Management**: Secure file upload, download, and delete functionalities with authentication and client-specific authorization for downloads.\n- **PDF Generation**: Uses `pdfkit` library for generating professional PDF documents (e.g., invoices, payroll reports).\n- **Financial Reporting**: Uses `recharts` library for interactive financial dashboards with visual analytics.\n- **Form Validation**: Implemented using `react-hook-form` with `Zod` schemas, including `z.coerce.number()`, `z.coerce.date()`, and `z.coerce.string()` for robust type coercion and validation.\n- **Data Fetching**: All pages use `React Query` for data fetching with proper loading states and error handling.\n- **Testing**: Extensive `data-testid` coverage (40+ instances per page) for automated testing compliance.\n- **Decimal-Safe Calculations**: Monetary calculations use `sumAmounts()` utility with null-safe guards for precision.\n\n### Feature Specifications\n- **Core Modules**: Authentication, Dashboard, CRM (Leads, Clients), Projects, Tasks, Staff Attendance, Finance (Income/Expenses), Invoices, Unified Inbox Chat, Files, Audit Logs, Client Portal.\n- **Floating Chat Widget (Unified Inbox)**: Intercom-style unified inbox accessible from all pages via a floating button. All roles see unified inbox: Admins see all project messages; Developers see messages from assigned projects; Clients see ALL messages (including admin/team replies) from their own projects. Auto-routes replies to correct project. Uses React Portal.\n- **Client Portal**: Dedicated dashboard for client role with filtered access to projects, invoices, payments, files, and project credentials. Data access is strictly controlled to their specific projects via `clientId`.\n- **Project Credentials Manager**: Dedicated separate section (not inside Projects) for admin/operational_head to manage software project credentials including: hosting platform, live link, admin panel link, database URL, server credentials, thumbnail image, short description, notes, and YouTube video URLs. Features thumbnail upload via multer, two video types (Short Presentable 1-2min, Full Features Demo), and full CRUD operations. Clients see their project credentials in the Client Portal with copy-to-clipboard functionality and video buttons.\n- **Access Control**: Robust RBAC implemented across all endpoints with the following role-based permissions:\n  - **Admin**: Full unrestricted access to all projects, files, and system resources\n  - **Operational Head**: Full unrestricted access to all projects and files (management/supervisor role)\n  - **Developer**: Project-scoped access - restricted to projects they're assigned to via tasks\n  - **Client**: Strictly limited to their own projects via clientId - cannot access other clients' data\n  \n  Standard access patterns (used in /api/files, /api/messages, /api/messages/upload):\n  - Client role: Always verify project ownership via clientId\n  - Developer role: For chat/communication features, verify task assignment to project\n  - Admin/Operational_head: Full access without additional checks (by design for management oversight)\n  \n  **Chat File Upload Exception**: The `/api/messages/upload` endpoint implements stricter security:\n  - Admin: Full unrestricted access\n  - Operational_head: Restricted to projects they're assigned to via tasks (like developers)\n  - Developer: Restricted to projects they're assigned to via tasks\n  - Client: Strictly limited to their own projects via clientId\n- **HR Management**: Employee management, departments & designations, attendance (biometric device management, punch log, correction requests), leave management, and payroll management (salary structure, generation, records).\n- **Attendance Reports & Job Cards**: Comprehensive HR attendance report with employee-wise job card feature. When filtering by a single employee, the system automatically displays a Job Card indicator with detailed employee information and provides specialized export buttons (\"Export Job Card PDF/Excel/Word\"). Job cards include comprehensive analytics: working days, on-time count, total hours, overtime calculation, and daily check-in/check-out breakdown. Manual attendance entry validates employee record existence to prevent \"Unknown\" employee issues in reports. **Professional PDF Design**: Employee Job Card PDF features corporate-grade layout with non-overlapping three-section header using explicit bounding boxes (logo: 40-120px, company: 125-395px, job card: 405-555px), proper height calculation via PDFKit's heightOfString() for accurate text positioning, full-width employee info panel with grey background, 6-card attendance summary grid (32) with rounded borders and color coding, corporate-style daily attendance table with alternating row colors, and professional footer with MaxTech BD branding. The header implementation uses dynamic height measurement to prevent text overflow and overlap issues.\n- **Accounts Module**: Financial dashboard, expense categories (income/expense), salary payments (ledger linking), financial reports (monthly/yearly), profit & loss statement (detailed breakdown), general ledger (transaction history).\n- **Payroll Reports**: Interactive payroll report page with month/year selector, employee-wise salary breakdown, and professional PDF, Excel, and Word export capabilities with MaxTech BD branding. **Professional Payroll-Grade PDF Design (A4 Landscape)**: Salary sheet PDF follows standard payroll report format with comprehensive earnings and deductions breakdown. Features include: professional header with company logo and full contact details; 19-column detailed table showing Employee Code, Name, Department, Designation; earnings breakdown (Basic, HRA, Medical, Conveyance, Other Allowances, Gross Salary); attendance data (Present Days, Absent Days, Late Days, Half Days, OT Hours); deductions breakdown (Late Deduction, Loan Deduction, Other Deductions); and Net Payable Salary. **Totals Row**: Bottom row displays grand totals for all financial columns, attendance summary, and total net payable highlighted in red. **Signature Section**: Three-column signature block (Prepared By, Verified By, Approved By) with horizontal lines. **Footer**: \"MaxTech BD | Smart Agency Control Hub\" branding. Layout optimized for A4 landscape format to accommodate all columns with proper readability, matching industry-standard payroll report formats (SAP, Oracle, Zoho, Odoo).\n\n### System Design Choices\n- **Modularity**: Designed with a modular approach for independent development and maintenance.\n- **Scalability**: PostgreSQL and Express.js provide a scalable foundation.\n- **Security**: Emphasis on security with JWT authentication, RBAC, secure API endpoints, and prevention of self-approval.\n- **Automation**: Integration of schedulers for automated tasks like email reminders and biometric device synchronization.\n- **Error Handling**: Comprehensive error handling, loading states, and user-friendly alerts.\n\n## External Dependencies\n- **Database**: PostgreSQL (Neon).\n- **ORM**: Drizzle ORM.\n- **Email Service**: Nodemailer.\n- **Biometric Devices**: Pluggable adapter system for devices (e.g., ZKTeco, Suprema).\n- **Frontend Libraries**: React, Vite, Tailwind CSS, shadcn/ui, React Query, react-hook-form, Zod, recharts.\n- **Backend Libraries**: Express.js, pdfkit.","path":null,"size_bytes":10585,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/pages/client-dashboard.tsx":{"content":"import { Briefcase, FileText, DollarSign, CheckCircle, Clock, AlertCircle, Globe, Key, Database, Play, Video, ExternalLink, Copy, Check, Server, Image as ImageIcon } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { type Project, type Invoice, type Payment, type ProjectCredentials } from \"@shared/schema\";\n\ninterface ClientDashboardStats {\n  totalProjects: number;\n  activeProjects: number;\n  completedProjects: number;\n  totalInvoices: number;\n  totalSpent: number;\n  pendingAmount: number;\n  paidInvoices: number;\n}\n\nexport default function ClientDashboard() {\n  const { toast } = useToast();\n  const [copiedField, setCopiedField] = useState<string | null>(null);\n\n  const { data: stats, isLoading: statsLoading } = useQuery<ClientDashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  const { data: projects } = useQuery<Project[]>({\n    queryKey: [\"/api/projects\"],\n  });\n\n  const { data: invoices } = useQuery<Invoice[]>({\n    queryKey: [\"/api/invoices\"],\n  });\n\n  const { data: payments } = useQuery<Payment[]>({\n    queryKey: [\"/api/payments\"],\n  });\n\n  const { data: credentials } = useQuery<ProjectCredentials[]>({\n    queryKey: [\"/api/project-credentials/client\"],\n  });\n\n  const copyToClipboard = async (text: string, field: string) => {\n    try {\n      await navigator.clipboard.writeText(text);\n      setCopiedField(field);\n      toast({ title: \"Copied to clipboard\" });\n      setTimeout(() => setCopiedField(null), 2000);\n    } catch {\n      toast({ title: \"Failed to copy\", variant: \"destructive\" });\n    }\n  };\n\n  const kpis = [\n    {\n      title: \"Total Projects\",\n      value: stats?.totalProjects ?? 0,\n      icon: Briefcase,\n      color: \"text-purple-600\",\n      bgColor: \"bg-purple-100 dark:bg-purple-950\",\n    },\n    {\n      title: \"Active Projects\",\n      value: stats?.activeProjects ?? 0,\n      icon: Clock,\n      color: \"text-blue-600\",\n      bgColor: \"bg-blue-100 dark:bg-blue-950\",\n    },\n    {\n      title: \"Completed Projects\",\n      value: stats?.completedProjects ?? 0,\n      icon: CheckCircle,\n      color: \"text-green-600\",\n      bgColor: \"bg-green-100 dark:bg-green-950\",\n    },\n    {\n      title: \"Total Spent\",\n      value: `${stats?.totalSpent?.toFixed(2) ?? \"0.00\"}`,\n      icon: DollarSign,\n      color: \"text-emerald-600\",\n      bgColor: \"bg-emerald-100 dark:bg-emerald-950\",\n    },\n    {\n      title: \"Pending Amount\",\n      value: `${stats?.pendingAmount?.toFixed(2) ?? \"0.00\"}`,\n      icon: AlertCircle,\n      color: \"text-orange-600\",\n      bgColor: \"bg-orange-100 dark:bg-orange-950\",\n    },\n    {\n      title: \"Paid Invoices\",\n      value: stats?.paidInvoices ?? 0,\n      icon: FileText,\n      color: \"text-teal-600\",\n      bgColor: \"bg-teal-100 dark:bg-teal-950\",\n    },\n  ];\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"planning\": return \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\";\n      case \"active\": return \"bg-blue-100 text-blue-700 dark:bg-blue-950 dark:text-blue-300\";\n      case \"on-hold\": return \"bg-yellow-100 text-yellow-700 dark:bg-yellow-950 dark:text-yellow-300\";\n      case \"completed\": return \"bg-green-100 text-green-700 dark:bg-green-950 dark:text-green-300\";\n      case \"draft\": return \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\";\n      case \"sent\": return \"bg-blue-100 text-blue-700 dark:bg-blue-950 dark:text-blue-300\";\n      case \"paid\": return \"bg-green-100 text-green-700 dark:bg-green-950 dark:text-green-300\";\n      case \"overdue\": return \"bg-red-100 text-red-700 dark:bg-red-950 dark:text-red-300\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  if (statsLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-3xl font-bold\">Client Portal</h1>\n        </div>\n        <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3, 4, 5, 6].map((i) => (\n            <Card key={i}>\n              <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                <div className=\"h-4 bg-muted rounded w-24 animate-pulse\" />\n                <div className=\"h-8 w-8 bg-muted rounded animate-pulse\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-8 bg-muted rounded w-16 mb-2 animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-client-dashboard-title\">Client Portal</h1>\n          <p className=\"text-sm text-muted-foreground\">Track your projects, invoices, and payments</p>\n        </div>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n        {kpis.map((kpi) => (\n          <Card key={kpi.title} data-testid={`card-kpi-${kpi.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">{kpi.title}</CardTitle>\n              <div className={`p-2 rounded-md ${kpi.bgColor}`}>\n                <kpi.icon className={`h-4 w-4 ${kpi.color}`} />\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid={`text-${kpi.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                {kpi.value}\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      <div className=\"grid gap-6 lg:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Active Projects</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {projects?.filter(p => p.status === \"active\").slice(0, 5).map((project) => (\n                <div key={project.id} className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\" data-testid={`project-${project.id}`}>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium\">{project.name}</p>\n                    <p className=\"text-xs text-muted-foreground mb-2\">{project.description}</p>\n                    <Progress value={project.progress ?? 0} className=\"h-2\" />\n                  </div>\n                  <Badge className={`ml-4 ${getStatusColor(project.status)}`}>\n                    {project.progress}%\n                  </Badge>\n                </div>\n              ))}\n              {(!projects || projects.filter(p => p.status === \"active\").length === 0) && (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">No active projects</p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Recent Invoices</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {invoices?.slice(0, 5).map((invoice) => (\n                <div key={invoice.id} className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\" data-testid={`invoice-${invoice.id}`}>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium\">{invoice.invoiceNumber}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Due: {new Date(invoice.dueDate).toLocaleDateString()}\n                    </p>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-sm font-medium\">${Number(invoice.amount).toFixed(2)}</span>\n                    <Badge className={getStatusColor(invoice.status)}>\n                      {invoice.status}\n                    </Badge>\n                  </div>\n                </div>\n              ))}\n              {(!invoices || invoices.length === 0) && (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">No invoices yet</p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Recent Payments</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            {payments?.slice(0, 5).map((payment) => (\n              <div key={payment.id} className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\" data-testid={`payment-${payment.id}`}>\n                <div className=\"flex-1\">\n                  <p className=\"text-sm font-medium\">Payment via {payment.paymentMethod}</p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {new Date(payment.paymentDate).toLocaleDateString()}\n                  </p>\n                  {payment.notes && (\n                    <p className=\"text-xs text-muted-foreground mt-1\">{payment.notes}</p>\n                  )}\n                </div>\n                <span className=\"text-sm font-medium text-green-600\">${Number(payment.amount).toFixed(2)}</span>\n              </div>\n            ))}\n            {(!payments || payments.length === 0) && (\n              <p className=\"text-sm text-muted-foreground text-center py-4\">No payments yet</p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {credentials && credentials.length > 0 && (\n        <div className=\"space-y-4\">\n          <h2 className=\"text-xl font-semibold\">Your Project Credentials</h2>\n          <div className=\"grid gap-4 md:grid-cols-2\">\n            {credentials.map((credential) => (\n              <Card key={credential.id} data-testid={`credential-card-${credential.id}`}>\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start gap-3\">\n                    {credential.thumbnailUrl ? (\n                      <img \n                        src={`/${credential.thumbnailUrl}`} \n                        alt={credential.projectName}\n                        className=\"h-14 w-14 rounded-md object-cover border\"\n                        data-testid={`credential-thumbnail-${credential.id}`}\n                      />\n                    ) : (\n                      <div className=\"h-14 w-14 rounded-md bg-muted flex items-center justify-center\">\n                        <ImageIcon className=\"h-6 w-6 text-muted-foreground\" />\n                      </div>\n                    )}\n                    <div className=\"flex-1 min-w-0\">\n                      <CardTitle className=\"text-base\" data-testid={`credential-name-${credential.id}`}>\n                        {credential.projectName}\n                      </CardTitle>\n                      {credential.hostingPlatform && (\n                        <Badge variant=\"secondary\" className=\"mt-1\">\n                          <Server className=\"h-3 w-3 mr-1\" />\n                          {credential.hostingPlatform}\n                        </Badge>\n                      )}\n                      {credential.shortDescription && (\n                        <p className=\"text-xs text-muted-foreground mt-2 line-clamp-2\">\n                          {credential.shortDescription}\n                        </p>\n                      )}\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"space-y-2\">\n                    {credential.liveLink && (\n                      <div className=\"flex items-center justify-between gap-2 text-sm\">\n                        <div className=\"flex items-center gap-2 text-muted-foreground min-w-0\">\n                          <Globe className=\"h-4 w-4 shrink-0\" />\n                          <span className=\"truncate\">Live Website</span>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-7 w-7\"\n                            onClick={() => copyToClipboard(credential.liveLink!, `live-${credential.id}`)}\n                            data-testid={`button-copy-live-${credential.id}`}\n                          >\n                            {copiedField === `live-${credential.id}` ? <Check className=\"h-3 w-3\" /> : <Copy className=\"h-3 w-3\" />}\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-7 w-7\"\n                            onClick={() => window.open(credential.liveLink!, \"_blank\")}\n                            data-testid={`button-open-live-${credential.id}`}\n                          >\n                            <ExternalLink className=\"h-3 w-3\" />\n                          </Button>\n                        </div>\n                      </div>\n                    )}\n\n                    {credential.adminPanelLink && (\n                      <div className=\"flex items-center justify-between gap-2 text-sm\">\n                        <div className=\"flex items-center gap-2 text-muted-foreground min-w-0\">\n                          <Key className=\"h-4 w-4 shrink-0\" />\n                          <span className=\"truncate\">Admin Panel</span>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-7 w-7\"\n                            onClick={() => copyToClipboard(credential.adminPanelLink!, `admin-${credential.id}`)}\n                            data-testid={`button-copy-admin-${credential.id}`}\n                          >\n                            {copiedField === `admin-${credential.id}` ? <Check className=\"h-3 w-3\" /> : <Copy className=\"h-3 w-3\" />}\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-7 w-7\"\n                            onClick={() => window.open(credential.adminPanelLink!, \"_blank\")}\n                            data-testid={`button-open-admin-${credential.id}`}\n                          >\n                            <ExternalLink className=\"h-3 w-3\" />\n                          </Button>\n                        </div>\n                      </div>\n                    )}\n\n                    {credential.databaseUrl && (\n                      <div className=\"flex items-center justify-between gap-2 text-sm\">\n                        <div className=\"flex items-center gap-2 text-muted-foreground min-w-0\">\n                          <Database className=\"h-4 w-4 shrink-0\" />\n                          <span className=\"truncate\">Database URL</span>\n                        </div>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-7 w-7\"\n                          onClick={() => copyToClipboard(credential.databaseUrl!, `db-${credential.id}`)}\n                          data-testid={`button-copy-db-${credential.id}`}\n                        >\n                          {copiedField === `db-${credential.id}` ? <Check className=\"h-3 w-3\" /> : <Copy className=\"h-3 w-3\" />}\n                        </Button>\n                      </div>\n                    )}\n\n                    {credential.serverCredentials && (\n                      <div className=\"flex items-center justify-between gap-2 text-sm\">\n                        <div className=\"flex items-center gap-2 text-muted-foreground min-w-0\">\n                          <Server className=\"h-4 w-4 shrink-0\" />\n                          <span className=\"truncate\">Server Credentials</span>\n                        </div>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-7 w-7\"\n                          onClick={() => copyToClipboard(credential.serverCredentials!, `server-${credential.id}`)}\n                          data-testid={`button-copy-server-${credential.id}`}\n                        >\n                          {copiedField === `server-${credential.id}` ? <Check className=\"h-3 w-3\" /> : <Copy className=\"h-3 w-3\" />}\n                        </Button>\n                      </div>\n                    )}\n                  </div>\n\n                  {(credential.shortVideoUrl || credential.fullVideoUrl) && (\n                    <div className=\"flex items-center gap-2 pt-2 border-t\">\n                      {credential.shortVideoUrl && (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          className=\"flex-1\"\n                          onClick={() => window.open(credential.shortVideoUrl!, \"_blank\")}\n                          data-testid={`button-short-video-${credential.id}`}\n                        >\n                          <Play className=\"h-3 w-3 mr-1\" />\n                          Presentable Video\n                        </Button>\n                      )}\n                      {credential.fullVideoUrl && (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          className=\"flex-1\"\n                          onClick={() => window.open(credential.fullVideoUrl!, \"_blank\")}\n                          data-testid={`button-full-video-${credential.id}`}\n                        >\n                          <Video className=\"h-3 w-3 mr-1\" />\n                          Full Features Demo\n                        </Button>\n                      )}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":18447,"size_tokens":null},"server/hr/routes.ts":{"content":"/**\n * HR & Payroll Routes Module\n * Handles all HR, Payroll, Leave, Attendance Device, and Performance endpoints\n */\n\nimport { Express } from \"express\";\nimport { eq, desc, and, gte, lte, sql } from \"drizzle-orm\";\nimport { AuthRequest } from \"../middleware/auth\";\nimport {\n  departments,\n  designations,\n  employees,\n  users,\n  hrSettings,\n  attendanceDevices,\n  deviceLogs,\n  leaveTypes,\n  leaveRequests,\n  leaveBalances,\n  punchCorrections,\n  salaryStructure,\n  payroll,\n  salarySlips,\n  performanceScores,\n  insertDepartmentSchema,\n  insertDesignationSchema,\n  insertEmployeeSchema,\n  insertHrSettingsSchema,\n  insertAttendanceDeviceSchema,\n  insertDeviceLogSchema,\n  insertLeaveTypeSchema,\n  insertLeaveRequestSchema,\n  insertLeaveBalanceSchema,\n  insertPunchCorrectionSchema,\n  insertSalaryStructureSchema,\n  insertPayrollSchema,\n  insertSalarySlipSchema,\n  insertPerformanceScoreSchema,\n} from \"@shared/schema\";\n\nexport function registerHrPayrollRoutes(\n  app: Express,\n  db: any,\n  authenticateToken: any,\n  auditMiddleware: any\n) {\n  // ==================== HR SETTINGS ====================\n\n  app.get(\"/api/hr-settings\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const [settings] = await db.select().from(hrSettings).limit(1);\n      if (!settings) {\n        // Create default settings if none exist\n        const [newSettings] = await db.insert(hrSettings).values({}).returning();\n        return res.json(newSettings);\n      }\n      res.json(settings);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/hr-settings/:id\", authenticateToken, auditMiddleware(\"update\", \"hr_settings\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      // Convert numeric fields from number to string to match schema expectations\n      const requestBody = { ...req.body };\n      if (typeof requestBody.overtimeRateMultiplier === 'number') {\n        requestBody.overtimeRateMultiplier = requestBody.overtimeRateMultiplier.toString();\n      }\n      if (typeof requestBody.halfDayHours === 'number') {\n        requestBody.halfDayHours = requestBody.halfDayHours.toString();\n      }\n      if (typeof requestBody.fullDayHours === 'number') {\n        requestBody.fullDayHours = requestBody.fullDayHours.toString();\n      }\n      if (typeof requestBody.minimumHoursForPresent === 'number') {\n        requestBody.minimumHoursForPresent = requestBody.minimumHoursForPresent.toString();\n      }\n      \n      const data = insertHrSettingsSchema.parse(requestBody);\n      const [updated] = await db.update(hrSettings)\n        .set({ ...data, updatedAt: new Date() })\n        .where(eq(hrSettings.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // ==================== DEPARTMENTS ====================\n\n  app.get(\"/api/departments\", authenticateToken, async (req, res) => {\n    try {\n      const allDepartments = await db.select().from(departments).orderBy(departments.name);\n      res.json(allDepartments);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/departments\", authenticateToken, auditMiddleware(\"create\", \"department\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const data = insertDepartmentSchema.parse(req.body);\n      const [department] = await db.insert(departments).values(data).returning();\n      res.json(department);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/departments/:id\", authenticateToken, auditMiddleware(\"update\", \"department\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const data = insertDepartmentSchema.partial().parse(req.body);\n      const [updated] = await db.update(departments)\n        .set(data)\n        .where(eq(departments.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/departments/:id\", authenticateToken, auditMiddleware(\"delete\", \"department\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      await db.delete(departments).where(eq(departments.id, req.params.id));\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // ==================== DESIGNATIONS ====================\n\n  app.get(\"/api/designations\", authenticateToken, async (req, res) => {\n    try {\n      const allDesignations = await db.select().from(designations).orderBy(designations.title);\n      res.json(allDesignations);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/designations\", authenticateToken, auditMiddleware(\"create\", \"designation\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const data = insertDesignationSchema.parse(req.body);\n      const [designation] = await db.insert(designations).values(data).returning();\n      res.json(designation);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/designations/:id\", authenticateToken, auditMiddleware(\"update\", \"designation\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const data = insertDesignationSchema.partial().parse(req.body);\n      const [updated] = await db.update(designations)\n        .set(data)\n        .where(eq(designations.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/designations/:id\", authenticateToken, auditMiddleware(\"delete\", \"designation\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      await db.delete(designations).where(eq(designations.id, req.params.id));\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // ==================== EMPLOYEES ====================\n\n  app.get(\"/api/employees\", authenticateToken, async (req, res) => {\n    try {\n      const allEmployees = await db.select({\n        id: employees.id,\n        userId: employees.userId,\n        employeeId: employees.employeeId,\n        departmentId: employees.departmentId,\n        designationId: employees.designationId,\n        joiningDate: employees.joiningDate,\n        status: employees.status,\n        createdAt: employees.createdAt,\n        // Include user data via aggregation\n        users: sql`COALESCE((\n          SELECT json_agg(json_build_object(\n            'id', ${users.id},\n            'fullName', ${users.fullName},\n            'email', ${users.email},\n            'role', ${users.role}\n          ))\n          FROM ${users}\n          WHERE ${users.id} = ${employees.userId}\n        ), '[]'::json)`.as('users'),\n        // Include department data\n        department: sql`(\n          SELECT json_build_object(\n            'id', ${departments.id},\n            'name', ${departments.name}\n          )\n          FROM ${departments}\n          WHERE ${departments.id} = ${employees.departmentId}\n        )`.as('department'),\n      })\n        .from(employees)\n        .orderBy(employees.employeeId);\n      \n      res.json(allEmployees);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/employees\", authenticateToken, auditMiddleware(\"create\", \"employee\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const data = insertEmployeeSchema.parse(req.body);\n      const [employee] = await db.insert(employees).values(data).returning();\n      res.json(employee);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/employees/:id\", authenticateToken, auditMiddleware(\"update\", \"employee\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const data = insertEmployeeSchema.partial().parse(req.body);\n      const [updated] = await db.update(employees)\n        .set(data)\n        .where(eq(employees.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // ==================== ATTENDANCE DEVICES ====================\n\n  app.get(\"/api/attendance-devices\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const devices = await db.select().from(attendanceDevices).orderBy(attendanceDevices.name);\n      res.json(devices);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/attendance-devices\", authenticateToken, auditMiddleware(\"create\", \"attendance_device\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      const data = insertAttendanceDeviceSchema.parse(req.body);\n      const [device] = await db.insert(attendanceDevices).values(data).returning();\n      res.json(device);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/attendance-devices/:id\", authenticateToken, auditMiddleware(\"update\", \"attendance_device\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      const data = insertAttendanceDeviceSchema.partial().parse(req.body);\n      const [updated] = await db.update(attendanceDevices)\n        .set(data)\n        .where(eq(attendanceDevices.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/attendance-devices/:id\", authenticateToken, auditMiddleware(\"delete\", \"attendance_device\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      await db.delete(attendanceDevices).where(eq(attendanceDevices.id, req.params.id));\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Device Logs\n  app.get(\"/api/device-logs\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const logs = await db.select().from(deviceLogs)\n        .orderBy(desc(deviceLogs.punchTime))\n        .limit(200);\n      res.json(logs);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Device Sync Operations\n  app.post(\"/api/attendance-devices/:id/sync\", authenticateToken, auditMiddleware(\"sync\", \"attendance_device\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { attendanceSyncService } = await import(\"../services/attendanceSync\");\n      const count = await attendanceSyncService.syncDeviceById(req.params.id);\n      \n      res.json({ success: true, logssynced: count });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/attendance-devices/:id/test\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { attendanceSyncService } = await import(\"../services/attendanceSync\");\n      const connected = await attendanceSyncService.testDeviceConnection(req.params.id);\n      \n      res.json({ success: connected, message: connected ? \"Device connected successfully\" : \"Failed to connect to device\" });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/attendance-devices/sync-all\", authenticateToken, auditMiddleware(\"sync_all\", \"attendance_device\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { attendanceSyncService } = await import(\"../services/attendanceSync\");\n      \n      // Trigger async sync without waiting\n      attendanceSyncService.syncAllDevices();\n      \n      res.json({ success: true, message: \"Device sync initiated\" });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // ==================== LEAVE TYPES ====================\n\n  app.get(\"/api/leave-types\", authenticateToken, async (req, res) => {\n    try {\n      const types = await db.select().from(leaveTypes).orderBy(leaveTypes.name);\n      res.json(types);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/leave-types\", authenticateToken, auditMiddleware(\"create\", \"leave_type\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const data = insertLeaveTypeSchema.parse(req.body);\n      const [leaveType] = await db.insert(leaveTypes).values(data).returning();\n      res.json(leaveType);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/leave-types/:id\", authenticateToken, auditMiddleware(\"update\", \"leave_type\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const data = insertLeaveTypeSchema.partial().parse(req.body);\n      const [updated] = await db.update(leaveTypes)\n        .set(data)\n        .where(eq(leaveTypes.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // ==================== LEAVE REQUESTS ====================\n\n  app.get(\"/api/leave-requests\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      let requests;\n      if (req.userRole === \"admin\" || req.userRole === \"operational_head\") {\n        requests = await db.select().from(leaveRequests)\n          .orderBy(desc(leaveRequests.createdAt));\n      } else {\n        // Developers can only see their own leave requests\n        const [employee] = await db.select().from(employees)\n          .where(eq(employees.userId, req.userId!))\n          .limit(1);\n        \n        if (!employee) {\n          return res.status(404).json({ error: \"Employee record not found\" });\n        }\n        \n        requests = await db.select().from(leaveRequests)\n          .where(eq(leaveRequests.employeeId, employee.id))\n          .orderBy(desc(leaveRequests.createdAt));\n      }\n      res.json(requests);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/leave-requests\", authenticateToken, auditMiddleware(\"create\", \"leave_request\"), async (req: AuthRequest, res) => {\n    try {\n      const data = insertLeaveRequestSchema.parse(req.body);\n      const [request] = await db.insert(leaveRequests).values(data).returning();\n      res.json(request);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/leave-requests/:id\", authenticateToken, auditMiddleware(\"update\", \"leave_request\"), async (req: AuthRequest, res) => {\n    try {\n      const data = insertLeaveRequestSchema.partial().parse(req.body);\n      \n      // Get existing leave request to prevent self-approval\n      const [existing] = await db.select()\n        .from(leaveRequests)\n        .where(eq(leaveRequests.id, req.params.id))\n        .limit(1);\n      \n      if (!existing) {\n        return res.status(404).json({ error: \"Leave request not found\" });\n      }\n      \n      // If approving/rejecting, enforce strict role and self-approval checks\n      if (data.status === \"approved\" || data.status === \"rejected\") {\n        if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n          return res.status(403).json({ error: \"Only admins and operational heads can approve/reject leave requests\" });\n        }\n        \n        // Prevent self-approval\n        if (existing.employeeId === req.userId) {\n          return res.status(403).json({ error: \"You cannot approve your own leave request\" });\n        }\n        \n        data.approvedBy = req.userId;\n        data.approvedAt = new Date();\n      }\n      \n      const [updated] = await db.update(leaveRequests)\n        .set(data)\n        .where(eq(leaveRequests.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Leave Balances\n  app.get(\"/api/leave-balances\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      const employeeId = req.query.employeeId as string;\n      const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear();\n      \n      let balances;\n      if (employeeId) {\n        balances = await db.select().from(leaveBalances)\n          .where(and(\n            eq(leaveBalances.employeeId, employeeId),\n            eq(leaveBalances.year, year)\n          ));\n      } else {\n        balances = await db.select().from(leaveBalances)\n          .where(eq(leaveBalances.year, year));\n      }\n      \n      res.json(balances);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // ==================== PUNCH CORRECTIONS ====================\n\n  app.get(\"/api/punch-corrections\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      let corrections;\n      if (req.userRole === \"admin\" || req.userRole === \"operational_head\") {\n        corrections = await db.select().from(punchCorrections)\n          .orderBy(desc(punchCorrections.createdAt));\n      } else {\n        const [employee] = await db.select().from(employees)\n          .where(eq(employees.userId, req.userId!))\n          .limit(1);\n        \n        if (!employee) {\n          return res.status(404).json({ error: \"Employee record not found\" });\n        }\n        \n        corrections = await db.select().from(punchCorrections)\n          .where(eq(punchCorrections.employeeId, employee.id))\n          .orderBy(desc(punchCorrections.createdAt));\n      }\n      res.json(corrections);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/punch-corrections\", authenticateToken, auditMiddleware(\"create\", \"punch_correction\"), async (req: AuthRequest, res) => {\n    try {\n      const data = insertPunchCorrectionSchema.parse(req.body);\n      \n      // Ensure status is set to pending for new requests\n      const correctionData = {\n        ...data,\n        status: \"pending\" as const,\n      };\n      \n      const [correction] = await db.insert(punchCorrections).values(correctionData).returning();\n      res.json(correction);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/punch-corrections/:id\", authenticateToken, auditMiddleware(\"update\", \"punch_correction\"), async (req: AuthRequest, res) => {\n    try {\n      const data = insertPunchCorrectionSchema.partial().parse(req.body);\n      \n      // Get existing correction to prevent self-approval\n      const [existing] = await db.select()\n        .from(punchCorrections)\n        .where(eq(punchCorrections.id, req.params.id))\n        .limit(1);\n      \n      if (!existing) {\n        return res.status(404).json({ error: \"Punch correction not found\" });\n      }\n      \n      // If approving/rejecting, enforce strict role and self-approval checks\n      if (data.status === \"approved\" || data.status === \"rejected\") {\n        if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n          return res.status(403).json({ error: \"Only admins and operational heads can approve/reject punch corrections\" });\n        }\n        \n        // Prevent self-approval\n        if (existing.employeeId === req.userId) {\n          return res.status(403).json({ error: \"You cannot approve your own punch correction\" });\n        }\n        \n        data.approvedBy = req.userId;\n        data.approvedAt = new Date();\n      }\n      \n      const [updated] = await db.update(punchCorrections)\n        .set(data)\n        .where(eq(punchCorrections.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // ==================== SALARY STRUCTURE ====================\n\n  app.get(\"/api/salary-structure\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const allStructures = await db.select().from(salaryStructure);\n      res.json(allStructures);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/salary-structure\", authenticateToken, auditMiddleware(\"create\", \"salary_structure\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      const data = insertSalaryStructureSchema.parse(req.body);\n      const [structure] = await db.insert(salaryStructure).values(data).returning();\n      res.json(structure);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/salary-structure/:id\", authenticateToken, auditMiddleware(\"update\", \"salary_structure\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      const data = insertSalaryStructureSchema.partial().parse(req.body);\n      const [updated] = await db.update(salaryStructure)\n        .set(data)\n        .where(eq(salaryStructure.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // ==================== PAYROLL ====================\n\n  app.get(\"/api/payroll\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const month = req.query.month ? parseInt(req.query.month as string) : new Date().getMonth() + 1;\n      const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear();\n      \n      const payrollRecords = await db.select().from(payroll)\n        .where(and(\n          eq(payroll.month, month),\n          eq(payroll.year, year)\n        ))\n        .orderBy(payroll.createdAt);\n      \n      res.json(payrollRecords);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/payroll\", authenticateToken, auditMiddleware(\"create\", \"payroll\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      const data = insertPayrollSchema.parse(req.body);\n      const [payrollRecord] = await db.insert(payroll).values({\n        ...data,\n        generatedBy: req.userId,\n      }).returning();\n      \n      res.json(payrollRecord);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/payroll/:id\", authenticateToken, auditMiddleware(\"update\", \"payroll\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied. Admin only.\" });\n      }\n      \n      const data = insertPayrollSchema.partial().parse(req.body);\n      const [updated] = await db.update(payroll)\n        .set(data)\n        .where(eq(payroll.id, req.params.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // ==================== SALARY SLIPS ====================\n\n  app.get(\"/api/salary-slips\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      const payrollId = req.query.payrollId as string;\n      \n      if (payrollId) {\n        const [slip] = await db.select().from(salarySlips)\n          .where(eq(salarySlips.payrollId, payrollId))\n          .limit(1);\n        return res.json(slip);\n      }\n      \n      const slips = await db.select().from(salarySlips)\n        .orderBy(desc(salarySlips.generatedAt));\n      res.json(slips);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // ==================== PERFORMANCE SCORES ====================\n\n  app.get(\"/api/performance-scores\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const month = req.query.month ? parseInt(req.query.month as string) : new Date().getMonth() + 1;\n      const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear();\n      \n      const scores = await db.select().from(performanceScores)\n        .where(and(\n          eq(performanceScores.month, month),\n          eq(performanceScores.year, year)\n        ));\n      \n      res.json(scores);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/performance-scores\", authenticateToken, auditMiddleware(\"create\", \"performance_score\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const data = insertPerformanceScoreSchema.parse(req.body);\n      const [score] = await db.insert(performanceScores).values(data).returning();\n      res.json(score);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n}\n","path":null,"size_bytes":28538,"size_tokens":null},"client/src/pages/register.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Shield, Users, BarChart3, Zap, CheckCircle2, Eye, EyeOff, UserPlus } from \"lucide-react\";\nimport logoImage from \"@assets/Untitled_design__1_-removebg-preview_1764044009686.png\";\n\nconst registerSchema = z.object({\n  fullName: z.string().min(2, \"Name must be at least 2 characters\"),\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n});\n\ntype RegisterFormData = z.infer<typeof registerSchema>;\n\nexport default function Register() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n\n  const form = useForm<RegisterFormData>({\n    resolver: zodResolver(registerSchema),\n    defaultValues: {\n      fullName: \"\",\n      email: \"\",\n      password: \"\",\n    },\n  });\n\n  const onSubmit = async (data: RegisterFormData) => {\n    setIsLoading(true);\n    try {\n      const response = await fetch(\"/api/auth/register\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Registration failed\");\n      }\n\n      toast({\n        title: \"Account created!\",\n        description: \"Please sign in with your credentials.\",\n      });\n      setLocation(\"/login\");\n    } catch (error: any) {\n      toast({\n        title: \"Registration failed\",\n        description: error.message || \"Please try again later\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const benefits = [\n    { icon: Shield, title: \"Secure Platform\", description: \"Your data is protected with enterprise-grade security\" },\n    { icon: Users, title: \"Team Collaboration\", description: \"Work seamlessly with your entire team\" },\n    { icon: BarChart3, title: \"Powerful Analytics\", description: \"Get insights to make better decisions\" },\n    { icon: Zap, title: \"Boost Productivity\", description: \"Streamline your daily operations\" },\n  ];\n\n  return (\n    <div className=\"min-h-screen flex\">\n      {/* Left Panel - Branding & Benefits */}\n      <div className=\"hidden lg:flex lg:w-1/2 bg-gradient-to-br from-primary via-primary/90 to-primary/80 relative overflow-hidden\">\n        {/* Decorative Elements */}\n        <div className=\"absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmZmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTM2IDM0djItSDI0di0yaDEyek0zNiAyNHYySDI0di0yaDEyeiIvPjwvZz48L2c+PC9zdmc+')] opacity-30\"></div>\n        <div className=\"absolute -top-24 -left-24 w-96 h-96 bg-white/10 rounded-full blur-3xl\"></div>\n        <div className=\"absolute -bottom-24 -right-24 w-96 h-96 bg-white/10 rounded-full blur-3xl\"></div>\n        \n        <div className=\"relative z-10 flex flex-col justify-center px-12 xl:px-20 text-white\">\n          {/* Logo */}\n          <div className=\"mb-8\">\n            <div className=\"bg-white/95 backdrop-blur-sm rounded-2xl p-4 inline-block shadow-2xl\">\n              <img src={logoImage} alt=\"MaxTech BD\" className=\"h-16 object-contain\" />\n            </div>\n          </div>\n          \n          {/* Headline */}\n          <h1 className=\"text-4xl xl:text-5xl font-bold mb-4 leading-tight\">\n            Join MaxTech BD<br />Today\n          </h1>\n          <p className=\"text-lg xl:text-xl text-white/80 mb-12 max-w-md\">\n            Create your account and start managing your agency operations more efficiently.\n          </p>\n          \n          {/* Benefits Grid */}\n          <div className=\"grid grid-cols-2 gap-6\">\n            {benefits.map((benefit, index) => (\n              <div \n                key={index}\n                className=\"flex items-start gap-3 bg-white/10 backdrop-blur-sm rounded-xl p-4 hover:bg-white/15 transition-colors\"\n              >\n                <div className=\"p-2 bg-white/20 rounded-lg\">\n                  <benefit.icon className=\"w-5 h-5\" />\n                </div>\n                <div>\n                  <h3 className=\"font-semibold text-sm\">{benefit.title}</h3>\n                  <p className=\"text-xs text-white/70 mt-0.5\">{benefit.description}</p>\n                </div>\n              </div>\n            ))}\n          </div>\n\n          {/* Trust Badges */}\n          <div className=\"mt-12 pt-8 border-t border-white/20\">\n            <div className=\"flex items-center gap-6 text-sm text-white/70\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-300\" />\n                <span>Free to Start</span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-300\" />\n                <span>No Credit Card</span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-300\" />\n                <span>Quick Setup</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Right Panel - Register Form */}\n      <div className=\"w-full lg:w-1/2 flex items-center justify-center p-6 sm:p-12 bg-background\">\n        <div className=\"w-full max-w-md\">\n          {/* Mobile Logo */}\n          <div className=\"lg:hidden flex justify-center mb-8\">\n            <img src={logoImage} alt=\"MaxTech BD\" className=\"h-16 object-contain\" />\n          </div>\n\n          {/* Welcome Header */}\n          <div className=\"text-center mb-8\">\n            <div className=\"inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 mb-4\">\n              <UserPlus className=\"w-8 h-8 text-primary\" />\n            </div>\n            <h2 className=\"text-3xl font-bold text-foreground mb-2\">Create Account</h2>\n            <p className=\"text-muted-foreground\">Join the MaxTech BD team</p>\n          </div>\n\n          {/* Register Form */}\n          <div className=\"bg-card rounded-2xl border shadow-sm p-8\">\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-5\">\n                <FormField\n                  control={form.control}\n                  name=\"fullName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm font-medium\">Full Name</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"John Doe\" \n                          className=\"h-12 px-4 bg-background border-border/50 focus:border-primary transition-colors\"\n                          {...field} \n                          data-testid=\"input-fullname\" \n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm font-medium\">Email Address</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"you@example.com\" \n                          className=\"h-12 px-4 bg-background border-border/50 focus:border-primary transition-colors\"\n                          {...field} \n                          data-testid=\"input-email\" \n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"password\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm font-medium\">Password</FormLabel>\n                      <FormControl>\n                        <div className=\"relative\">\n                          <Input \n                            type={showPassword ? \"text\" : \"password\"}\n                            placeholder=\"Create a strong password\" \n                            className=\"h-12 px-4 pr-12 bg-background border-border/50 focus:border-primary transition-colors\"\n                            {...field} \n                            data-testid=\"input-password\" \n                          />\n                          <button\n                            type=\"button\"\n                            onClick={() => setShowPassword(!showPassword)}\n                            className=\"absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors\"\n                            data-testid=\"button-toggle-password\"\n                          >\n                            {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                          </button>\n                        </div>\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"bg-muted/50 rounded-lg p-3 text-sm text-muted-foreground text-center\">\n                  New accounts are created with Developer role by default.\n                </div>\n\n                <Button \n                  type=\"submit\" \n                  className=\"w-full h-12 text-base font-semibold shadow-lg hover:shadow-xl transition-all\" \n                  disabled={isLoading} \n                  data-testid=\"button-register\"\n                >\n                  {isLoading ? (\n                    <span className=\"flex items-center gap-2\">\n                      <svg className=\"animate-spin h-5 w-5\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                        <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                      </svg>\n                      Creating account...\n                    </span>\n                  ) : \"Create Account\"}\n                </Button>\n              </form>\n            </Form>\n          </div>\n\n          {/* Login Link */}\n          <p className=\"text-center mt-6 text-muted-foreground\">\n            Already have an account?{\" \"}\n            <Link href=\"/login\" className=\"text-primary hover:underline font-semibold\">\n              Sign In\n            </Link>\n          </p>\n\n          {/* Footer */}\n          <div className=\"mt-8 text-center text-xs text-muted-foreground\">\n            <p> 2024 MaxTech BD. All rights reserved.</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11544,"size_tokens":null},"client/src/pages/attendance.tsx":{"content":"import { useState } from \"react\";\nimport { Clock, Calendar } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { type Attendance } from \"@shared/schema\";\nimport { useAuth } from \"@/lib/auth-context\";\n\nexport default function AttendancePage() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const { data: attendanceRecords, isLoading } = useQuery<Attendance[]>({\n    queryKey: [\"/api/attendance\"],\n  });\n\n  const checkInMutation = useMutation({\n    mutationFn: () => apiRequest(\"POST\", \"/api/attendance/check-in\"),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n      toast({ title: \"Success\", description: \"Checked in successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const checkOutMutation = useMutation({\n    mutationFn: () => apiRequest(\"POST\", \"/api/attendance/check-out\"),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n      toast({ title: \"Success\", description: \"Checked out successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const todayAttendance = attendanceRecords?.find(\n    (record) =>\n      new Date(record.date).toDateString() === new Date().toDateString() &&\n      record.userId === user?.id\n  );\n\n  const handleCheckIn = async () => {\n    checkInMutation.mutate();\n  };\n\n  const handleCheckOut = async () => {\n    checkOutMutation.mutate();\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"on-time\": return \"bg-green-100 text-green-700 dark:bg-green-950 dark:text-green-300\";\n      case \"late\": return \"bg-red-100 text-red-700 dark:bg-red-950 dark:text-red-300\";\n      case \"absent\": return \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"h-8 bg-muted rounded w-32 mb-6 animate-pulse\" />\n        <div className=\"grid gap-6 md:grid-cols-2\">\n          <Card>\n            <CardContent className=\"p-6\">\n              <div className=\"h-20 bg-muted rounded animate-pulse\" />\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Attendance</h1>\n        <p className=\"text-sm text-muted-foreground\">Track your work hours</p>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Clock className=\"w-5 h-5\" />\n              Today's Attendance\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {todayAttendance ? (\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Check-in</span>\n                  <span className=\"font-mono font-semibold\" data-testid=\"text-check-in-time\">\n                    {todayAttendance.checkIn ? new Date(todayAttendance.checkIn).toLocaleTimeString() : \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Check-out</span>\n                  <span className=\"font-mono font-semibold\" data-testid=\"text-check-out-time\">\n                    {todayAttendance.checkOut ? new Date(todayAttendance.checkOut).toLocaleTimeString() : \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Status</span>\n                  <Badge className={getStatusColor(todayAttendance.status)} data-testid=\"badge-status\">\n                    {todayAttendance.status}\n                  </Badge>\n                </div>\n                {!todayAttendance.checkOut && (\n                  <Button\n                    onClick={handleCheckOut}\n                    disabled={checkOutMutation.isPending}\n                    className=\"w-full\"\n                    variant=\"destructive\"\n                    data-testid=\"button-check-out\"\n                  >\n                    {checkOutMutation.isPending ? \"Processing...\" : \"Check Out\"}\n                  </Button>\n                )}\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                <p className=\"text-sm text-muted-foreground text-center\">\n                  You haven't checked in today\n                </p>\n                <Button\n                  onClick={handleCheckIn}\n                  disabled={checkInMutation.isPending}\n                  className=\"w-full\"\n                  data-testid=\"button-check-in\"\n                >\n                  {checkInMutation.isPending ? \"Processing...\" : \"Check In Now\"}\n                </Button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Calendar className=\"w-5 h-5\" />\n              This Month\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-3 gap-4 text-center\">\n              <div>\n                <p className=\"text-2xl font-bold\" data-testid=\"text-days-present\">\n                  {attendanceRecords?.filter((r) => r.status !== \"absent\").length ?? 0}\n                </p>\n                <p className=\"text-xs text-muted-foreground\">Days Present</p>\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-red-600\" data-testid=\"text-late-days\">\n                  {attendanceRecords?.filter((r) => r.status === \"late\").length ?? 0}\n                </p>\n                <p className=\"text-xs text-muted-foreground\">Late Days</p>\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-gray-600\" data-testid=\"text-absent-days\">\n                  {attendanceRecords?.filter((r) => r.status === \"absent\").length ?? 0}\n                </p>\n                <p className=\"text-xs text-muted-foreground\">Absent</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Attendance History</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {!attendanceRecords || attendanceRecords.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <p className=\"text-sm text-muted-foreground\">No attendance records yet</p>\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {attendanceRecords.slice(0, 10).map((record) => (\n                <div\n                  key={record.id}\n                  className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\"\n                  data-testid={`record-${record.id}`}\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <Calendar className=\"w-4 h-4 text-muted-foreground\" />\n                    <span className=\"font-medium\">\n                      {new Date(record.date).toLocaleDateString()}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center gap-4\">\n                    <div className=\"text-sm font-mono\">\n                      {record.checkIn ? new Date(record.checkIn).toLocaleTimeString() : \"-\"}\n                      {\"  \"}\n                      {record.checkOut ? new Date(record.checkOut).toLocaleTimeString() : \"-\"}\n                    </div>\n                    <Badge className={getStatusColor(record.status)}>\n                      {record.status}\n                    </Badge>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":8591,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/pages/chat.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Send, AlertCircle, Paperclip, FileText, Image } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { getWebSocketUrl } from \"@/lib/websocket\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { type Message, type Project } from \"@shared/schema\";\nimport { useAuth } from \"@/lib/auth-context\";\n\nexport default function Chat() {\n  const { user, logout } = useAuth();\n  const { toast } = useToast();\n  const [selectedProject, setSelectedProject] = useState<string>(\"\");\n  const [message, setMessage] = useState(\"\");\n  const [wsStatus, setWsStatus] = useState<\"connecting\" | \"connected\" | \"disconnected\" | \"error\">(\"connecting\");\n  const [wsError, setWsError] = useState<string | null>(null);\n  const wsRef = useRef<WebSocket | null>(null);\n  const selectedProjectRef = useRef<string>(\"\");\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  \n  // Keep selectedProjectRef in sync with selectedProject\n  useEffect(() => {\n    selectedProjectRef.current = selectedProject;\n  }, [selectedProject]);\n\n  const { data: projects } = useQuery<Project[]>({\n    queryKey: [\"/api/projects\"],\n  });\n  \n  const { data: messages, isLoading } = useQuery<Message[]>({\n    queryKey: [\"/api/messages\", selectedProject],\n    queryFn: async () => {\n      if (!selectedProject) return [];\n      const token = localStorage.getItem(\"token\");\n      const headers: HeadersInit = {\n        \"Content-Type\": \"application/json\",\n      };\n      if (token) {\n        headers[\"Authorization\"] = `Bearer ${token}`;\n      }\n      \n      // Append projectId as query parameter for client users\n      const url = `/api/messages?projectId=${selectedProject}`;\n      const res = await fetch(url, { headers, credentials: \"include\" });\n      \n      if (!res.ok) {\n        if (res.status === 401) {\n          localStorage.removeItem(\"token\");\n          localStorage.removeItem(\"user\");\n          window.location.href = \"/login\";\n        }\n        const errorData = await res.json().catch(() => ({ error: \"Request failed\" }));\n        throw new Error(errorData.error || `Request failed with status ${res.status}`);\n      }\n      \n      return res.json();\n    },\n    enabled: !!selectedProject,\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: (data: { projectId: string; content: string }) =>\n      apiRequest(\"POST\", \"/api/messages\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages\", selectedProject] });\n      setMessage(\"\");\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const uploadFileMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      formData.append(\"projectId\", selectedProject);\n\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(\"/api/messages/upload\", {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n        body: formData,\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"File upload failed\");\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages\", selectedProject] });\n      toast({ title: \"Success\", description: \"File uploaded successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // WebSocket connection - independent of project selection\n  useEffect(() => {\n    let wsUrl: string;\n    try {\n      wsUrl = getWebSocketUrl();\n    } catch (error: any) {\n      setWsStatus(\"error\");\n      setWsError(error.message || \"Failed to initialize WebSocket connection\");\n      return;\n    }\n    \n    let reconnectAttempts = 0;\n    const maxReconnectAttempts = 5;\n    const reconnectDelay = 3000;\n    let authFailure = false;\n\n    const connect = () => {\n      if (authFailure) {\n        console.log(\"Chat: Not reconnecting due to authentication failure\");\n        return;\n      }\n\n      console.log(\"Chat: Connecting to WebSocket\");\n      setWsStatus(\"connecting\");\n      setWsError(null);\n      \n      const ws = new WebSocket(wsUrl);\n      wsRef.current = ws;\n\n      ws.onopen = () => {\n        console.log(\"WebSocket connected\");\n        setWsStatus(\"connected\");\n        setWsError(null);\n        reconnectAttempts = 0;\n        \n        // Subscribe to current project if one is selected (use ref to get latest value)\n        const currentProject = selectedProjectRef.current;\n        if (currentProject) {\n          ws.send(JSON.stringify({\n            type: \"subscribe\",\n            projectId: currentProject\n          }));\n          console.log(`Auto-subscribed to project on (re)connect: ${currentProject}`);\n        }\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          \n          if (data.type === \"new_message\") {\n            // Invalidate messages query to refetch with new message\n            queryClient.invalidateQueries({ queryKey: [\"/api/messages\", data.projectId] });\n          } else if (data.type === \"connected\") {\n            console.log(\"WebSocket authentication successful\");\n            setWsStatus(\"connected\");\n          }\n        } catch (error) {\n          console.error(\"Error parsing WebSocket message:\", error);\n        }\n      };\n\n      ws.onerror = (error) => {\n        console.error(\"WebSocket error:\", error);\n        setWsStatus(\"error\");\n      };\n\n      ws.onclose = (event) => {\n        console.log(\"WebSocket disconnected\", event.code, event.reason);\n        setWsStatus(\"disconnected\");\n        \n        // Check if close was due to authentication failure (code 1008)\n        if (event.code === 1008 || event.reason?.includes(\"Authentication\")) {\n          authFailure = true;\n          setWsError(\"Authentication failed. Your session may have expired. Please log in again.\");\n          setWsStatus(\"error\");\n          \n          toast({\n            title: \"Authentication Error\",\n            description: \"Your session has expired. Please log in again.\",\n            variant: \"destructive\",\n          });\n          \n          // Auto-logout after 3 seconds\n          setTimeout(() => {\n            logout();\n          }, 3000);\n          return;\n        }\n        \n        // Attempt to reconnect with exponential backoff\n        if (reconnectAttempts < maxReconnectAttempts && !authFailure) {\n          reconnectAttempts++;\n          console.log(`Reconnecting in ${reconnectDelay}ms (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);\n          setTimeout(() => {\n            connect();\n          }, reconnectDelay * reconnectAttempts);\n        } else if (!authFailure) {\n          console.error(\"Max reconnection attempts reached\");\n          setWsError(\"Failed to connect to chat server after multiple attempts.\");\n          setWsStatus(\"error\");\n        }\n      };\n    };\n\n    connect();\n\n    return () => {\n      if (wsRef.current) {\n        // Prevent reconnection on intentional close\n        wsRef.current.onclose = null;\n        if (wsRef.current.readyState === WebSocket.OPEN) {\n          wsRef.current.close();\n        }\n      }\n    };\n  }, []); // Only connect once on mount\n\n  // Subscribe to project when selected (after connection is established)\n  useEffect(() => {\n    if (!selectedProject || !wsRef.current) return;\n\n    const ws = wsRef.current;\n\n    const subscribe = () => {\n      if (ws.readyState === WebSocket.OPEN) {\n        ws.send(JSON.stringify({\n          type: \"subscribe\",\n          projectId: selectedProject\n        }));\n        console.log(`Subscribed to project: ${selectedProject}`);\n      }\n    };\n\n    // If already open, subscribe immediately\n    if (ws.readyState === WebSocket.OPEN) {\n      subscribe();\n    } else if (ws.readyState === WebSocket.CONNECTING) {\n      // Wait for connection to open\n      const handleOpen = () => {\n        subscribe();\n        ws.removeEventListener(\"open\", handleOpen);\n      };\n      ws.addEventListener(\"open\", handleOpen);\n    }\n\n    // Cleanup: unsubscribe when project changes or component unmounts\n    return () => {\n      if (ws.readyState === WebSocket.OPEN) {\n        ws.send(JSON.stringify({\n          type: \"unsubscribe\",\n          projectId: selectedProject\n        }));\n        console.log(`Unsubscribed from project: ${selectedProject}`);\n      }\n    };\n  }, [selectedProject]);\n\n  // Auto-scroll to bottom when messages change\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  const handleSend = async () => {\n    if (!message.trim() || !selectedProject) return;\n    sendMessageMutation.mutate({ projectId: selectedProject, content: message });\n  };\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!selectedProject) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a project first\",\n        variant: \"destructive\",\n      });\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n      return;\n    }\n\n    // Validate file size (10MB max)\n    const maxSize = 10 * 1024 * 1024;\n    if (file.size > maxSize) {\n      toast({\n        title: \"Error\",\n        description: \"File size exceeds 10MB limit\",\n        variant: \"destructive\",\n      });\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n      return;\n    }\n\n    uploadFileMutation.mutate(file);\n    // Reset file input\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const handleAttachmentClick = () => {\n    fileInputRef.current?.click();\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Team Chat</h1>\n        <p className=\"text-sm text-muted-foreground\">Project-wise communication</p>\n      </div>\n\n      {wsStatus === \"error\" && wsError && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Connection Error</AlertTitle>\n          <AlertDescription>{wsError}</AlertDescription>\n        </Alert>\n      )}\n\n      {wsStatus === \"connecting\" && (\n        <Alert>\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Connecting...</AlertTitle>\n          <AlertDescription>Establishing connection to chat server...</AlertDescription>\n        </Alert>\n      )}\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">Select Project</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <Select onValueChange={setSelectedProject} value={selectedProject}>\n            <SelectTrigger data-testid=\"select-project\">\n              <SelectValue placeholder=\"Choose a project to view messages\" />\n            </SelectTrigger>\n            <SelectContent>\n              {projects?.map((project) => (\n                <SelectItem key={project.id} value={project.id}>\n                  {project.name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </CardContent>\n      </Card>\n\n      {selectedProject && (\n        <Card className=\"flex flex-col h-[600px]\">\n          <CardContent className=\"flex-1 overflow-y-auto p-6 space-y-4\">\n            {isLoading ? (\n              <div className=\"flex items-center justify-center h-full\">\n                <div className=\"text-sm text-muted-foreground\">Loading messages...</div>\n              </div>\n            ) : !messages || messages.length === 0 ? (\n              <div className=\"flex items-center justify-center h-full\">\n                <div className=\"text-center\">\n                  <h3 className=\"text-lg font-semibold mb-2\">No messages yet</h3>\n                  <p className=\"text-sm text-muted-foreground\">Start the conversation</p>\n                </div>\n              </div>\n            ) : (\n              <>\n                {messages.map((msg) => (\n                  <div\n                    key={msg.id}\n                    className={`flex gap-3 ${msg.userId === user?.id ? \"flex-row-reverse\" : \"\"}`}\n                    data-testid={`message-${msg.id}`}\n                  >\n                    <Avatar className=\"w-8 h-8\">\n                      <AvatarFallback className=\"text-xs\">U</AvatarFallback>\n                    </Avatar>\n                    <div className={`flex flex-col ${msg.userId === user?.id ? \"items-end\" : \"\"}`}>\n                      <div\n                        className={`rounded-lg p-3 max-w-md ${\n                          msg.userId === user?.id\n                            ? \"bg-primary text-primary-foreground\"\n                            : \"bg-muted\"\n                        }`}\n                      >\n                        {msg.content && <p className=\"text-sm\">{msg.content}</p>}\n                        {msg.fileUrl && msg.fileType?.startsWith(\"image/\") && (\n                          <img\n                            src={msg.fileUrl}\n                            alt={msg.fileName || \"Image\"}\n                            className=\"max-w-full rounded-md mt-2\"\n                            data-testid={`image-${msg.id}`}\n                          />\n                        )}\n                        {msg.fileUrl && !msg.fileType?.startsWith(\"image/\") && (\n                          <a\n                            href={msg.fileUrl}\n                            target=\"_blank\"\n                            rel=\"noopener noreferrer\"\n                            className=\"flex items-center gap-2 text-sm hover:underline\"\n                            data-testid={`file-link-${msg.id}`}\n                          >\n                            <FileText className=\"w-4 h-4\" />\n                            <span>{msg.fileName || \"Download file\"}</span>\n                          </a>\n                        )}\n                      </div>\n                      <span className=\"text-xs text-muted-foreground mt-1\">\n                        {new Date(msg.createdAt).toLocaleTimeString()}\n                      </span>\n                    </div>\n                  </div>\n                ))}\n                <div ref={messagesEndRef} />\n              </>\n            )}\n          </CardContent>\n          <CardContent className=\"border-t p-4\">\n            <div className=\"flex gap-2\">\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                onChange={handleFileSelect}\n                className=\"hidden\"\n                accept=\"image/*,.pdf,.doc,.docx,.txt\"\n                data-testid=\"input-file\"\n              />\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                onClick={handleAttachmentClick}\n                disabled={!selectedProject || uploadFileMutation.isPending}\n                data-testid=\"button-attach\"\n              >\n                <Paperclip className=\"w-4 h-4\" />\n              </Button>\n              <Input\n                placeholder=\"Type a message...\"\n                value={message}\n                onChange={(e) => setMessage(e.target.value)}\n                onKeyPress={(e) => e.key === \"Enter\" && handleSend()}\n                disabled={sendMessageMutation.isPending}\n                data-testid=\"input-message\"\n              />\n              <Button onClick={handleSend} disabled={sendMessageMutation.isPending} data-testid=\"button-send\">\n                <Send className=\"w-4 h-4\" />\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":16390,"size_tokens":null},"client/src/pages/leads.tsx":{"content":"// src/pages/leads.tsx\nimport { useState, useRef } from \"react\";\nimport { Plus, Mail, Phone, Calendar, Search, X, Trash, Upload, FileSpreadsheet, Download, AlertCircle, CheckCircle2, Send, History, Clock, Check, XCircle, Sparkles } from \"lucide-react\";\nimport { SmartLeadFinder } from \"@/components/smart-lead-finder\";\nimport Swal from \"sweetalert2\";\nimport \"sweetalert2/dist/sweetalert2.min.css\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\n\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\n\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nimport { insertLeadSchema, type Lead, type LeadEmail, LEAD_SOURCES, LEAD_EMAIL_TEMPLATES } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { normalizeLeadData } from \"@/lib/normalizeDateInputs\";\n\nconst EMAIL_TEMPLATE_LABELS: Record<string, string> = {\n  service_introduction: \"Service Introduction\",\n  company_profile: \"Company Profile\",\n  pricing_brochure: \"Pricing Brochure\",\n  follow_up_reminder: \"Follow-up Reminder\",\n};\n\nconst ALL_SENTINEL = \"__ALL__\";\n\n// Required fields except notes\nconst leadFormSchema = insertLeadSchema.merge(\n  z.object({\n    name: z.string().min(1, \"Name is required\"),\n    email: z.string().email(\"Enter a valid email\"),\n    phone: z.string().min(1, \"Phone is required\"),\n    status: z.string().min(1, \"Status is required\"),\n    source: z.string().min(1, \"Source is required\"),\n    notes: z.string().optional(),\n    followUpDate: z.string().min(1, \"Follow-up date is required\"),\n  }),\n);\n\ntype LeadFormData = z.infer<typeof leadFormSchema>;\n\n/**\n * Ensure SweetAlert is placed above any other modals/overlays and accepts pointer events.\n * We use a very large z-index (max 32-bit signed int) to be safe.\n */\nfunction applySwalZIndex() {\n  try {\n    const container = Swal.getContainer ? Swal.getContainer() : null;\n    const popup = Swal.getPopup ? Swal.getPopup() : null;\n    const backdrop = container?.querySelector(\n      \".swal2-backdrop\",\n    ) as HTMLElement | null;\n    // Super-high z-index\n    const z = \"2147483647\";\n    if (container) {\n      container.style.zIndex = z;\n      container.style.pointerEvents = \"auto\";\n      // also ensure full-screen backdrop receives pointer events correctly\n      if (backdrop) {\n        backdrop.style.zIndex = z;\n        backdrop.style.pointerEvents = \"auto\";\n      }\n    }\n    if (popup) {\n      popup.style.zIndex = String(Number(z) + 1);\n      popup.style.pointerEvents = \"auto\";\n    }\n  } catch (e) {\n    // ignore\n    // console.warn(\"applySwalZIndex failed\", e);\n  }\n}\n\nfunction extractErrorMessage(err: any): string {\n  if (!err) return \"An unknown error occurred.\";\n  if (typeof err === \"string\") return err;\n  if (err?.response?.data?.message) return err.response.data.message;\n  if (err?.response?.data) {\n    try {\n      if (typeof err.response.data === \"string\") return err.response.data;\n      return JSON.stringify(err.response.data);\n    } catch {\n      // fallthrough\n    }\n  }\n  if (err?.message) return err.message;\n  if (err instanceof Response) {\n    try {\n      return `Request failed with status ${err.status}`;\n    } catch {\n      return `Request failed with status ${err.status}`;\n    }\n  }\n  return \"Request failed.\";\n}\n\nexport default function Leads() {\n  const [open, setOpen] = useState(false);\n  const [editingLead, setEditingLead] = useState<Lead | null>(null);\n\n  const [searchInput, setSearchInput] = useState(\"\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const [statusFilter, setStatusFilter] = useState<string>(\"\");\n  const [sourceFilter, setSourceFilter] = useState<string>(\"\");\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"\");\n  \n  // Bulk selection states\n  const [selectedLeadIds, setSelectedLeadIds] = useState<Set<string>>(new Set());\n  const [bulkMessageOpen, setBulkMessageOpen] = useState(false);\n  const [bulkMessageSubject, setBulkMessageSubject] = useState(\"\");\n  const [bulkMessageContent, setBulkMessageContent] = useState(\"\");\n  const [isSendingBulk, setIsSendingBulk] = useState(false);\n\n  // Bulk upload states\n  const [bulkUploadOpen, setBulkUploadOpen] = useState(false);\n  const [uploadResult, setUploadResult] = useState<{\n    success: number;\n    failed: number;\n    errors: { row: number; name: string; error: string }[];\n  } | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  // Email states\n  const [emailDialogOpen, setEmailDialogOpen] = useState(false);\n  const [selectedLeadForEmail, setSelectedLeadForEmail] = useState<Lead | null>(null);\n  const [selectedTemplate, setSelectedTemplate] = useState<string>(\"\");\n  const [isSendingEmail, setIsSendingEmail] = useState(false);\n\n  // Smart Lead Finder state\n  const [smartFinderOpen, setSmartFinderOpen] = useState(false);\n\n  const { toast } = useToast();\n\n  // Email history query\n  const { data: emailHistory = [], refetch: refetchEmails } = useQuery<LeadEmail[]>({\n    queryKey: [\"/api/leads\", selectedLeadForEmail?.id, \"emails\"],\n    queryFn: async () => {\n      if (!selectedLeadForEmail) return [];\n      const res = await apiRequest(\"GET\", `/api/leads/${selectedLeadForEmail.id}/emails`);\n      return res as LeadEmail[];\n    },\n    enabled: !!selectedLeadForEmail,\n  });\n\n  const handleSearch = () => {\n    setSearchQuery(searchInput);\n  };\n\n  // Fetch categories from database\n  const { data: categories = [] } = useQuery<{ id: number; name: string; isActive: boolean }[]>({\n    queryKey: [\"/api/lead-categories\"],\n  });\n  \n  const activeCategories = categories.filter(c => c.isActive);\n\n  const queryParams = new URLSearchParams();\n  if (searchQuery.trim()) queryParams.append(\"search\", searchQuery);\n  if (statusFilter.trim()) queryParams.append(\"status\", statusFilter);\n  if (sourceFilter.trim()) queryParams.append(\"source\", sourceFilter);\n  if (categoryFilter.trim()) queryParams.append(\"category\", categoryFilter);\n\n  const queryString = queryParams.toString();\n\n  // React Query v5 object signature\n  const {\n    data: leads = [],\n    isLoading,\n    refetch,\n  } = useQuery<Lead[]>({\n    queryKey: [\"leads\", queryString],\n    queryFn: async () => {\n      const url = `/api/leads${queryString ? `?${queryString}` : \"\"}`;\n      const res = await apiRequest(\"GET\", url);\n      return res as Lead[];\n    },\n    keepPreviousData: true,\n  });\n\n  // Create Lead\n  const createMutation = useMutation({\n    mutationFn: (data: LeadFormData) => apiRequest(\"POST\", \"/api/leads\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"leads\"] });\n      toast({ title: \"Success\", description: \"Lead created successfully\" });\n      setOpen(false);\n      setEditingLead(null);\n      form.reset();\n      void refetch();\n    },\n    onError: (error: any) => {\n      const msg = extractErrorMessage(error);\n      // if backend returns 400 or message contains duplicate -> show friendly SweetAlert\n      if (\n        error?.response?.status === 400 ||\n        /duplicate|already exists|unique/i.test(msg)\n      ) {\n        Swal.fire({\n          title: \"Duplicate lead\",\n          text: msg || \"A lead with the same details already exists.\",\n          icon: \"warning\",\n          didOpen: applySwalZIndex,\n          // safety: repeat inline styles via willOpen too\n          willOpen: applySwalZIndex,\n        });\n      } else {\n        Swal.fire({\n          title: \"Failed to create lead\",\n          text: msg,\n          icon: \"error\",\n          didOpen: applySwalZIndex,\n          willOpen: applySwalZIndex,\n        });\n      }\n      console.error(\"Create lead error:\", error);\n    },\n  });\n\n  // Update Lead\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: LeadFormData }) =>\n      apiRequest(\"PATCH\", `/api/leads/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"leads\"] });\n      toast({ title: \"Success\", description: \"Lead updated successfully\" });\n      setOpen(false);\n      setEditingLead(null);\n      form.reset();\n      void refetch();\n    },\n    onError: (error: any) => {\n      const msg = extractErrorMessage(error);\n      if (\n        error?.response?.status === 400 ||\n        /duplicate|already exists|unique/i.test(msg)\n      ) {\n        Swal.fire({\n          title: \"Duplicate lead\",\n          text: msg || \"A lead with the same details already exists.\",\n          icon: \"warning\",\n          didOpen: applySwalZIndex,\n          willOpen: applySwalZIndex,\n        });\n      } else {\n        Swal.fire({\n          title: \"Failed to update lead\",\n          text: msg,\n          icon: \"error\",\n          didOpen: applySwalZIndex,\n          willOpen: applySwalZIndex,\n        });\n      }\n      console.error(\"Update lead error:\", error);\n    },\n  });\n\n  // Delete Lead\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/leads/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"leads\"] });\n      Swal.fire({\n        title: \"Deleted\",\n        text: \"Lead removed successfully\",\n        icon: \"success\",\n        timer: 1500,\n        showConfirmButton: false,\n        didOpen: applySwalZIndex,\n        willOpen: applySwalZIndex,\n      });\n      void refetch();\n    },\n    onError: (error: any) => {\n      const msg = extractErrorMessage(error);\n      Swal.fire({\n        title: \"Failed to delete\",\n        text: msg,\n        icon: \"error\",\n        didOpen: applySwalZIndex,\n        willOpen: applySwalZIndex,\n      });\n      console.error(\"Delete lead error:\", error);\n    },\n  });\n\n  // SweetAlert2 delete confirmation\n  const handleDelete = async (id: string) => {\n    const result = await Swal.fire({\n      title: \"Delete Lead?\",\n      text: \"This action cannot be undone.\",\n      icon: \"warning\",\n      showCancelButton: true,\n      confirmButtonText: \"Delete\",\n      cancelButtonText: \"Cancel\",\n      confirmButtonColor: \"#dc2626\",\n      didOpen: applySwalZIndex,\n      willOpen: applySwalZIndex,\n    });\n\n    if (result.isConfirmed) {\n      Swal.fire({\n        title: \"Deleting...\",\n        allowOutsideClick: false,\n        didOpen: () => {\n          applySwalZIndex();\n          Swal.showLoading();\n        },\n        willOpen: applySwalZIndex,\n      });\n\n      deleteMutation.mutate(id);\n    }\n  };\n\n  const form = useForm<LeadFormData>({\n    resolver: zodResolver(leadFormSchema),\n    defaultValues: {\n      name: \"\",\n      email: \"\",\n      phone: \"\",\n      status: \"new\",\n      source: undefined,\n      notes: \"\",\n      followUpDate: \"\",\n    },\n  });\n\n  const onSubmit = (data: LeadFormData) => {\n    const payload = normalizeLeadData(data);\n    if (editingLead) {\n      updateMutation.mutate({ id: editingLead.id, data: payload });\n    } else {\n      createMutation.mutate(payload);\n    }\n  };\n\n  const handleEdit = (lead: Lead) => {\n    setEditingLead(lead);\n    form.reset({\n      name: lead.name,\n      email: lead.email,\n      phone: lead.phone,\n      status: lead.status,\n      source: lead.source as any,\n      notes: lead.notes || \"\",\n      followUpDate: lead.followUpDate\n        ? new Date(lead.followUpDate).toISOString().split(\"T\")[0]\n        : \"\",\n    });\n    setOpen(true);\n  };\n\n  // Email functions\n  const openEmailDialog = (lead: Lead) => {\n    setSelectedLeadForEmail(lead);\n    setSelectedTemplate(\"\");\n    setEmailDialogOpen(true);\n  };\n\n  const handleSendEmail = async () => {\n    if (!selectedLeadForEmail || !selectedTemplate) return;\n    \n    setIsSendingEmail(true);\n    try {\n      const response = await apiRequest(\"POST\", `/api/leads/${selectedLeadForEmail.id}/emails/send`, {\n        templateName: selectedTemplate,\n      }) as { success: boolean; message: string };\n      \n      if (response.success) {\n        toast({ title: \"Success\", description: response.message });\n        refetchEmails();\n        setSelectedTemplate(\"\");\n      } else {\n        toast({ title: \"Error\", description: response.message, variant: \"destructive\" });\n      }\n    } catch (error: any) {\n      toast({ \n        title: \"Error\", \n        description: error?.message || \"Failed to send email\", \n        variant: \"destructive\" \n      });\n    } finally {\n      setIsSendingEmail(false);\n    }\n  };\n\n  const handleSendWelcomeEmails = async (lead: Lead) => {\n    setIsSendingEmail(true);\n    try {\n      const response = await apiRequest(\"POST\", `/api/leads/${lead.id}/emails/send-welcome`) as { \n        message: string; \n        results: { templateName: string; success: boolean }[] \n      };\n      \n      toast({ title: \"Success\", description: response.message });\n      \n      // If email dialog is open for this lead, refresh\n      if (selectedLeadForEmail?.id === lead.id) {\n        refetchEmails();\n      }\n    } catch (error: any) {\n      toast({ \n        title: \"Error\", \n        description: error?.message || \"Failed to send welcome emails\", \n        variant: \"destructive\" \n      });\n    } finally {\n      setIsSendingEmail(false);\n    }\n  };\n\n  const handleAddNew = () => {\n    setEditingLead(null);\n    form.reset({\n      name: \"\",\n      email: \"\",\n      phone: \"\",\n      status: \"new\",\n      source: undefined,\n      notes: \"\",\n      followUpDate: \"\",\n    });\n    setOpen(true);\n  };\n\n  // Bulk upload handlers\n  const handleBulkUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    setIsUploading(true);\n    setUploadResult(null);\n\n    try {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(\"/api/leads/bulk-upload\", {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n        body: formData,\n      });\n\n      const result = await response.json();\n\n      if (!response.ok) {\n        throw new Error(result.error || \"Upload failed\");\n      }\n\n      setUploadResult({\n        success: result.success,\n        failed: result.failed,\n        errors: result.errors || [],\n      });\n\n      if (result.success > 0) {\n        queryClient.invalidateQueries({ queryKey: [\"leads\"] });\n        toast({\n          title: \"Upload Complete\",\n          description: result.message,\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Upload Failed\",\n        description: error.message || \"Failed to upload file\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsUploading(false);\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n    }\n  };\n\n  const downloadTemplate = () => {\n    const csvContent = `name,email,phone,status,source,notes,followUpDate\nJohn Doe,john@example.com,+1234567890,new,Facebook,Sample lead note,2025-01-15\nJane Smith,jane@example.com,+0987654321,contacted,LinkedIn,Another lead,2025-02-20`;\n    \n    const blob = new Blob([csvContent], { type: \"text/csv;charset=utf-8;\" });\n    const link = document.createElement(\"a\");\n    link.href = URL.createObjectURL(blob);\n    link.download = \"leads_template.csv\";\n    link.click();\n    URL.revokeObjectURL(link.href);\n  };\n\n  const statusColor = (status: string) => {\n    switch (status) {\n      case \"new\":\n        return \"bg-blue-200 text-blue-800\";\n      case \"contacted\":\n        return \"bg-yellow-200 text-yellow-800\";\n      case \"qualified\":\n        return \"bg-green-200 text-green-800\";\n      case \"converted\":\n        return \"bg-purple-200 text-purple-800\";\n      default:\n        return \"bg-gray-200 text-gray-700\";\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between gap-2\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Leads</h1>\n          <p className=\"text-sm text-muted-foreground\">Manage your clients</p>\n        </div>\n        <div className=\"flex gap-2 flex-wrap\">\n          <Button variant=\"outline\" onClick={() => setSmartFinderOpen(true)} data-testid=\"button-smart-finder\">\n            <Sparkles className=\"w-4 h-4 mr-2\" /> Smart Lead Finder\n          </Button>\n          <Button variant=\"outline\" onClick={() => setBulkUploadOpen(true)} data-testid=\"button-bulk-upload\">\n            <Upload className=\"w-4 h-4 mr-2\" /> Bulk Upload\n          </Button>\n          <Button onClick={handleAddNew} data-testid=\"button-add-lead\">\n            <Plus className=\"w-4 h-4 mr-2\" /> Add Lead\n          </Button>\n        </div>\n      </div>\n\n      {/* SEARCH + FILTERS */}\n      <Card>\n        <CardContent className=\"p-4 space-y-3\">\n          {/* Search */}\n          <div className=\"flex gap-2\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search by name...\"\n                value={searchInput}\n                onChange={(e) => setSearchInput(e.target.value)}\n                onKeyDown={(e) => e.key === \"Enter\" && handleSearch()}\n                className=\"pl-10\"\n              />\n              {searchInput && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7\"\n                  onClick={() => {\n                    setSearchInput(\"\");\n                    setSearchQuery(\"\");\n                  }}\n                >\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              )}\n            </div>\n            <Button onClick={handleSearch}>\n              <Search className=\"w-4 h-4 mr-2\" /> Search\n            </Button>\n          </div>\n\n          {/* Filters */}\n          <div className=\"flex flex-wrap gap-3\">\n            {/* Status */}\n            <Select\n              value={statusFilter || ALL_SENTINEL}\n              onValueChange={(v) =>\n                setStatusFilter(v === ALL_SENTINEL ? \"\" : v)\n              }\n            >\n              <SelectTrigger className=\"w-48\">\n                <SelectValue placeholder=\"Filter by status\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value={ALL_SENTINEL}>All Statuses</SelectItem>\n                <SelectItem value=\"new\">New</SelectItem>\n                <SelectItem value=\"contacted\">Contacted</SelectItem>\n                <SelectItem value=\"qualified\">Qualified</SelectItem>\n                <SelectItem value=\"converted\">Converted</SelectItem>\n              </SelectContent>\n            </Select>\n\n            {/* Source */}\n            <Select\n              value={sourceFilter || ALL_SENTINEL}\n              onValueChange={(v) =>\n                setSourceFilter(v === ALL_SENTINEL ? \"\" : v)\n              }\n            >\n              <SelectTrigger className=\"w-48\">\n                <SelectValue placeholder=\"Filter by source\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value={ALL_SENTINEL}>All Sources</SelectItem>\n                {LEAD_SOURCES.map((s) => (\n                  <SelectItem key={s} value={s}>\n                    {s}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            \n            {/* Category */}\n            <Select\n              value={categoryFilter || ALL_SENTINEL}\n              onValueChange={(v) =>\n                setCategoryFilter(v === ALL_SENTINEL ? \"\" : v)\n              }\n              data-testid=\"select-category-filter\"\n            >\n              <SelectTrigger className=\"w-48\">\n                <SelectValue placeholder=\"Filter by category\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value={ALL_SENTINEL}>All Categories</SelectItem>\n                {activeCategories.map((c) => (\n                  <SelectItem key={c.id} value={c.name}>\n                    {c.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n\n            {(statusFilter || sourceFilter || searchQuery || categoryFilter) && (\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setSearchInput(\"\");\n                  setSearchQuery(\"\");\n                  setStatusFilter(\"\");\n                  setSourceFilter(\"\");\n                  setCategoryFilter(\"\");\n                }}\n              >\n                Clear All\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* MODAL */}\n      <Dialog open={open} onOpenChange={setOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingLead ? \"Edit Lead\" : \"Add New Lead\"}\n            </DialogTitle>\n            <DialogDescription>\n              {editingLead\n                ? \"Update this lead's information\"\n                : \"Create a new lead\"}\n            </DialogDescription>\n          </DialogHeader>\n\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <div className=\"grid md:grid-cols-2 gap-4\">\n                {/* NAME */}\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} required />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* EMAIL */}\n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email</FormLabel>\n                      <FormControl>\n                        <Input {...field} required />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* PHONE */}\n                <FormField\n                  control={form.control}\n                  name=\"phone\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Phone</FormLabel>\n                      <FormControl>\n                        <Input {...field} required />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* SOURCE */}\n                <FormField\n                  control={form.control}\n                  name=\"source\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Source</FormLabel>\n                      <Select\n                        value={field.value ?? \"\"}\n                        onValueChange={field.onChange}\n                      >\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Select source\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {LEAD_SOURCES.map((s) => (\n                            <SelectItem key={s} value={s}>\n                              {s}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* STATUS */}\n                <FormField\n                  control={form.control}\n                  name=\"status\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Status</FormLabel>\n                      <Select\n                        value={field.value}\n                        onValueChange={field.onChange}\n                      >\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Select status\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"new\">New</SelectItem>\n                          <SelectItem value=\"contacted\">Contacted</SelectItem>\n                          <SelectItem value=\"qualified\">Qualified</SelectItem>\n                          <SelectItem value=\"converted\">Converted</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* FOLLOW-UP */}\n                <FormField\n                  control={form.control}\n                  name=\"followUpDate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Follow-up Date</FormLabel>\n                      <FormControl>\n                        <Input type=\"date\" {...field} required />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              {/* NOTES */}\n              <FormField\n                control={form.control}\n                name=\"notes\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Notes (optional)</FormLabel>\n                    <FormControl>\n                      <Textarea {...field} />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"flex justify-end gap-2\">\n                <Button variant=\"outline\" onClick={() => setOpen(false)}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\">\n                  {editingLead ? \"Update Lead\" : \"Create Lead\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Bulk Selection Bar */}\n      {selectedLeadIds.size > 0 && (\n        <Card className=\"mb-4 border-primary\">\n          <CardContent className=\"p-4 flex items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-4\">\n              <Badge variant=\"secondary\" data-testid=\"text-selected-count\">\n                {selectedLeadIds.size} lead{selectedLeadIds.size !== 1 ? 's' : ''} selected\n              </Badge>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setSelectedLeadIds(new Set())}\n                data-testid=\"button-clear-selection\"\n              >\n                Clear Selection\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => {\n                  const allIds = new Set(leads.map(l => l.id));\n                  setSelectedLeadIds(allIds);\n                }}\n                data-testid=\"button-select-all\"\n              >\n                Select All ({leads.length})\n              </Button>\n            </div>\n            <Button\n              onClick={() => setBulkMessageOpen(true)}\n              data-testid=\"button-bulk-message\"\n            >\n              <Send className=\"w-4 h-4 mr-2\" />\n              Send Bulk Message\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* LEADS LIST */}\n      {isLoading ? (\n        <p>Loading...</p>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {leads.map((lead) => {\n            const leadId = lead.id;\n            const isSelected = selectedLeadIds.has(leadId);\n            \n            return (\n              <Card\n                key={lead.id}\n                className={`relative cursor-pointer hover:shadow-lg ${isSelected ? 'ring-2 ring-primary' : ''}`}\n                onClick={() => handleEdit(lead)}\n                data-testid={`card-lead-${lead.id}`}\n              >\n                {/* CHECKBOX */}\n                <div \n                  className=\"absolute top-2 left-2 z-10\"\n                  onClick={(e) => e.stopPropagation()}\n                >\n                  <Checkbox\n                    checked={isSelected}\n                    onCheckedChange={(checked) => {\n                      const newSet = new Set(selectedLeadIds);\n                      if (checked) {\n                        newSet.add(leadId);\n                      } else {\n                        newSet.delete(leadId);\n                      }\n                      setSelectedLeadIds(newSet);\n                    }}\n                    data-testid={`checkbox-lead-${lead.id}`}\n                  />\n                </div>\n                \n                {/* ACTION BUTTONS */}\n                <div className=\"absolute top-2 right-2 flex gap-1 z-10\">\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      openEmailDialog(lead);\n                    }}\n                    title=\"Send Email\"\n                    data-testid={`button-email-${lead.id}`}\n                    className=\"bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40\"\n                  >\n                    <Send className=\"w-4 h-4 text-blue-600\" />\n                  </Button>\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      handleDelete(lead.id);\n                    }}\n                    title=\"Delete Lead\"\n                    data-testid={`button-delete-${lead.id}`}\n                    className=\"bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/40\"\n                  >\n                    <Trash className=\"w-4 h-4 text-red-600\" />\n                  </Button>\n                </div>\n\n                <CardContent className=\"p-6 pt-10 space-y-2\">\n                  <h3 className=\"font-bold text-lg\">{lead.name}</h3>\n                  <div className=\"flex flex-wrap gap-1\">\n                    <Badge className={statusColor(lead.status)}>\n                      {lead.status}\n                    </Badge>\n                    {lead.category && (\n                      <Badge variant=\"outline\" data-testid={`badge-category-${lead.id}`}>\n                        {lead.category}\n                      </Badge>\n                    )}\n                  </div>\n\n                  <div className=\"text-sm space-y-1\">\n                    <div className=\"flex gap-2 items-center\">\n                      <Mail className=\"w-4 h-4\" />\n                      {lead.email}\n                    </div>\n\n                    <div className=\"flex gap-2 items-center\">\n                      <Phone className=\"w-4 h-4\" />\n                      {lead.phone}\n                    </div>\n\n                    <div className=\"flex gap-2 items-center\">\n                      <Calendar className=\"w-4 h-4\" />\n                      Follow-up:{\" \"}\n                      {new Date(lead.followUpDate).toLocaleDateString()}\n                    </div>\n\n                    <p className=\"text-xs text-muted-foreground\">\n                      Source: {lead.source}\n                    </p>\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n\n      {/* Smart Lead Finder Dialog */}\n      <SmartLeadFinder open={smartFinderOpen} onOpenChange={setSmartFinderOpen} />\n\n      {/* Bulk Upload Dialog */}\n      <Dialog open={bulkUploadOpen} onOpenChange={(open) => {\n        setBulkUploadOpen(open);\n        if (!open) {\n          setUploadResult(null);\n        }\n      }}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <FileSpreadsheet className=\"w-5 h-5\" />\n              Bulk Upload Leads\n            </DialogTitle>\n            <DialogDescription>\n              Upload a CSV or Excel file to import multiple leads at once.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            {/* Template Download */}\n            <div className=\"p-4 bg-muted rounded-md\">\n              <h4 className=\"font-medium mb-2\">Required Format</h4>\n              <p className=\"text-sm text-muted-foreground mb-3\">\n                Your file must include these columns: <strong>name</strong>, <strong>email</strong>, phone, status, source, notes, followUpDate\n              </p>\n              <div className=\"text-xs text-muted-foreground mb-3 space-y-1\">\n                <p><strong>Valid statuses:</strong> new, contacted, qualified, converted</p>\n                <p><strong>Valid sources:</strong> Facebook, LinkedIn, Fiverr, Upwork, Freelancer.com, People per Hour, Reference, Local Market, Legit</p>\n                <p><strong>Date format:</strong> YYYY-MM-DD (e.g., 2025-01-15)</p>\n              </div>\n              <Button variant=\"outline\" size=\"sm\" onClick={downloadTemplate} data-testid=\"button-download-template\">\n                <Download className=\"w-4 h-4 mr-2\" /> Download Template\n              </Button>\n            </div>\n\n            {/* File Upload */}\n            <div className=\"space-y-2\">\n              <label className=\"block text-sm font-medium\">Select File</label>\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                accept=\".csv,.xlsx,.xls\"\n                onChange={handleBulkUpload}\n                disabled={isUploading}\n                className=\"block w-full text-sm text-foreground\n                  file:mr-4 file:py-2 file:px-4\n                  file:rounded-md file:border-0\n                  file:text-sm file:font-medium\n                  file:bg-primary file:text-primary-foreground\n                  hover:file:bg-primary/90\n                  cursor-pointer\"\n                data-testid=\"input-file-upload\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Supported formats: CSV, Excel (.xlsx, .xls)\n              </p>\n            </div>\n\n            {/* Upload Progress */}\n            {isUploading && (\n              <div className=\"flex items-center gap-2 p-4 bg-muted rounded-md\">\n                <svg className=\"animate-spin h-5 w-5 text-primary\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                  <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                </svg>\n                <span className=\"text-sm\">Uploading and processing leads...</span>\n              </div>\n            )}\n\n            {/* Upload Results */}\n            {uploadResult && (\n              <div className=\"space-y-3\">\n                <div className=\"flex gap-4\">\n                  <div className=\"flex items-center gap-2 text-green-600\">\n                    <CheckCircle2 className=\"w-5 h-5\" />\n                    <span className=\"font-medium\">{uploadResult.success} successful</span>\n                  </div>\n                  {uploadResult.failed > 0 && (\n                    <div className=\"flex items-center gap-2 text-red-600\">\n                      <AlertCircle className=\"w-5 h-5\" />\n                      <span className=\"font-medium\">{uploadResult.failed} failed</span>\n                    </div>\n                  )}\n                </div>\n\n                {/* Error Details */}\n                {uploadResult.errors.length > 0 && (\n                  <div className=\"max-h-48 overflow-y-auto border rounded-md\">\n                    <table className=\"w-full text-sm\">\n                      <thead className=\"bg-muted sticky top-0\">\n                        <tr>\n                          <th className=\"text-left p-2 font-medium\">Row</th>\n                          <th className=\"text-left p-2 font-medium\">Name</th>\n                          <th className=\"text-left p-2 font-medium\">Error</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {uploadResult.errors.map((err, idx) => (\n                          <tr key={idx} className=\"border-t\">\n                            <td className=\"p-2\">{err.row}</td>\n                            <td className=\"p-2\">{err.name}</td>\n                            <td className=\"p-2 text-red-600\">{err.error}</td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n\n          <div className=\"flex justify-end gap-2 pt-4\">\n            <Button variant=\"outline\" onClick={() => setBulkUploadOpen(false)} data-testid=\"button-close-bulk-upload\">\n              Close\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Email Dialog */}\n      <Dialog open={emailDialogOpen} onOpenChange={(open) => {\n        setEmailDialogOpen(open);\n        if (!open) {\n          setSelectedLeadForEmail(null);\n          setSelectedTemplate(\"\");\n        }\n      }}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Send className=\"w-5 h-5\" />\n              Send Email to Lead\n            </DialogTitle>\n            {selectedLeadForEmail && (\n              <DialogDescription>\n                Send marketing or follow-up emails to {selectedLeadForEmail.name} ({selectedLeadForEmail.email})\n              </DialogDescription>\n            )}\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            {/* Send Individual Template */}\n            <div className=\"space-y-3\">\n              <label className=\"text-sm font-medium\">Select Email Template</label>\n              <Select value={selectedTemplate} onValueChange={setSelectedTemplate}>\n                <SelectTrigger data-testid=\"select-email-template\">\n                  <SelectValue placeholder=\"Choose a template...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {LEAD_EMAIL_TEMPLATES.map((template) => (\n                    <SelectItem key={template} value={template}>\n                      {EMAIL_TEMPLATE_LABELS[template] || template}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n\n              <Button\n                onClick={handleSendEmail}\n                disabled={!selectedTemplate || isSendingEmail}\n                className=\"w-full\"\n                data-testid=\"button-send-template-email\"\n              >\n                {isSendingEmail ? (\n                  <span className=\"flex items-center gap-2\">\n                    <Clock className=\"w-4 h-4 animate-spin\" />\n                    Sending...\n                  </span>\n                ) : (\n                  <span className=\"flex items-center gap-2\">\n                    <Send className=\"w-4 h-4\" />\n                    Send Selected Template\n                  </span>\n                )}\n              </Button>\n            </div>\n\n            {/* Quick Actions */}\n            <div className=\"border-t pt-4\">\n              <label className=\"text-sm font-medium text-muted-foreground\">Quick Actions</label>\n              <Button\n                variant=\"outline\"\n                onClick={() => selectedLeadForEmail && handleSendWelcomeEmails(selectedLeadForEmail)}\n                disabled={isSendingEmail}\n                className=\"w-full mt-2\"\n                data-testid=\"button-send-welcome-emails\"\n              >\n                {isSendingEmail ? (\n                  <span className=\"flex items-center gap-2\">\n                    <Clock className=\"w-4 h-4 animate-spin\" />\n                    Sending...\n                  </span>\n                ) : (\n                  <span className=\"flex items-center gap-2\">\n                    <Mail className=\"w-4 h-4\" />\n                    Send All Welcome Emails (3 Templates)\n                  </span>\n                )}\n              </Button>\n            </div>\n\n            {/* Email History */}\n            <div className=\"border-t pt-4\">\n              <div className=\"flex items-center gap-2 mb-3\">\n                <History className=\"w-4 h-4\" />\n                <label className=\"text-sm font-medium\">Email History</label>\n              </div>\n              \n              {emailHistory.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">\n                  No emails sent to this lead yet.\n                </p>\n              ) : (\n                <ScrollArea className=\"h-48\">\n                  <div className=\"space-y-2\">\n                    {emailHistory.map((email) => (\n                      <div\n                        key={email.id}\n                        className=\"flex items-center justify-between p-2 rounded-md bg-muted/50\"\n                        data-testid={`email-history-${email.id}`}\n                      >\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-sm font-medium truncate\">\n                            {EMAIL_TEMPLATE_LABELS[email.templateName] || email.templateName}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {email.sentAt \n                              ? new Date(email.sentAt).toLocaleString() \n                              : new Date(email.createdAt).toLocaleString()}\n                          </p>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          {email.status === \"sent\" ? (\n                            <Badge variant=\"outline\" className=\"text-green-600 border-green-600\">\n                              <Check className=\"w-3 h-3 mr-1\" />\n                              Sent\n                            </Badge>\n                          ) : email.status === \"failed\" ? (\n                            <Badge variant=\"outline\" className=\"text-red-600 border-red-600\">\n                              <XCircle className=\"w-3 h-3 mr-1\" />\n                              Failed\n                            </Badge>\n                          ) : (\n                            <Badge variant=\"outline\" className=\"text-yellow-600 border-yellow-600\">\n                              <Clock className=\"w-3 h-3 mr-1\" />\n                              Pending\n                            </Badge>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex justify-end gap-2 pt-4\">\n            <Button variant=\"outline\" onClick={() => setEmailDialogOpen(false)} data-testid=\"button-close-email-dialog\">\n              Close\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n      \n      {/* Bulk Message Composer Dialog */}\n      <Dialog open={bulkMessageOpen} onOpenChange={(open) => {\n        setBulkMessageOpen(open);\n        if (!open) {\n          setBulkMessageSubject(\"\");\n          setBulkMessageContent(\"\");\n        }\n      }}>\n        <DialogContent className=\"sm:max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Send className=\"w-5 h-5\" />\n              Send Bulk Message\n            </DialogTitle>\n            <DialogDescription>\n              Send a promotional email to {selectedLeadIds.size} selected lead{selectedLeadIds.size !== 1 ? 's' : ''}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            {/* Recipients Preview */}\n            <div>\n              <label className=\"text-sm font-medium\">Recipients</label>\n              <div className=\"mt-2 p-3 bg-muted rounded-md max-h-24 overflow-y-auto\">\n                <div className=\"flex flex-wrap gap-1\">\n                  {Array.from(selectedLeadIds).slice(0, 10).map((id) => {\n                    const lead = leads.find(l => l.id === id);\n                    return lead ? (\n                      <Badge key={id} variant=\"outline\" className=\"text-xs\">\n                        {lead.name}\n                      </Badge>\n                    ) : null;\n                  })}\n                  {selectedLeadIds.size > 10 && (\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      +{selectedLeadIds.size - 10} more\n                    </Badge>\n                  )}\n                </div>\n              </div>\n            </div>\n            \n            {/* Subject */}\n            <div>\n              <label className=\"text-sm font-medium\">Subject</label>\n              <Input\n                value={bulkMessageSubject}\n                onChange={(e) => setBulkMessageSubject(e.target.value)}\n                placeholder=\"Enter email subject...\"\n                className=\"mt-2\"\n                data-testid=\"input-bulk-subject\"\n              />\n            </div>\n            \n            {/* Message Content */}\n            <div>\n              <label className=\"text-sm font-medium\">Message</label>\n              <Textarea\n                value={bulkMessageContent}\n                onChange={(e) => setBulkMessageContent(e.target.value)}\n                placeholder=\"Enter your promotional message...\"\n                className=\"mt-2 min-h-[200px]\"\n                data-testid=\"input-bulk-message\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-2\">\n                Use {\"{name}\"} to personalize the message with the recipient's name.\n              </p>\n            </div>\n            \n            {/* Actions */}\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setBulkMessageOpen(false)}\n                disabled={isSendingBulk}\n                data-testid=\"button-cancel-bulk\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={async () => {\n                  if (!bulkMessageSubject.trim() || !bulkMessageContent.trim()) {\n                    toast({\n                      title: \"Missing Information\",\n                      description: \"Please enter both subject and message content.\",\n                      variant: \"destructive\",\n                    });\n                    return;\n                  }\n                  \n                  setIsSendingBulk(true);\n                  try {\n                    const selectedLeads = leads.filter(l => selectedLeadIds.has(l.id));\n                    const leadIds = selectedLeads.map(l => l.id);\n                    \n                    const response = await apiRequest(\"POST\", \"/api/leads/bulk-message\", {\n                      leadIds,\n                      subject: bulkMessageSubject,\n                      content: bulkMessageContent,\n                    });\n                    \n                    const result = response as { success: number; failed: number; errors: string[] };\n                    \n                    if (result.success > 0) {\n                      toast({\n                        title: \"Bulk Message Sent\",\n                        description: `Successfully sent to ${result.success} recipient${result.success !== 1 ? 's' : ''}${result.failed > 0 ? `. ${result.failed} failed.` : ''}`,\n                      });\n                      setBulkMessageOpen(false);\n                      setSelectedLeadIds(new Set());\n                      setBulkMessageSubject(\"\");\n                      setBulkMessageContent(\"\");\n                    } else {\n                      toast({\n                        title: \"Send Failed\",\n                        description: result.errors.join(\", \") || \"Failed to send messages\",\n                        variant: \"destructive\",\n                      });\n                    }\n                  } catch (error: any) {\n                    toast({\n                      title: \"Error\",\n                      description: error.message || \"Failed to send bulk message\",\n                      variant: \"destructive\",\n                    });\n                  } finally {\n                    setIsSendingBulk(false);\n                  }\n                }}\n                disabled={isSendingBulk || !bulkMessageSubject.trim() || !bulkMessageContent.trim()}\n                data-testid=\"button-send-bulk\"\n              >\n                {isSendingBulk ? (\n                  <span className=\"flex items-center gap-2\">\n                    <Clock className=\"w-4 h-4 animate-spin\" />\n                    Sending...\n                  </span>\n                ) : (\n                  <span className=\"flex items-center gap-2\">\n                    <Send className=\"w-4 h-4\" />\n                    Send to {selectedLeadIds.size} Lead{selectedLeadIds.size !== 1 ? 's' : ''}\n                  </span>\n                )}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":50560,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/pages/finance.tsx":{"content":"import { useState } from \"react\";\nimport { Plus, TrendingUp, TrendingDown, DollarSign } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { insertIncomeSchema, insertExpenseSchema, type Income, type Expense } from \"@shared/schema\";\nimport { normalizeIncomeData, normalizeExpenseData } from \"@/lib/normalizeDateInputs\";\n\ntype IncomeFormData = z.infer<typeof insertIncomeSchema>;\ntype ExpenseFormData = z.infer<typeof insertExpenseSchema>;\n\nimport { z } from \"zod\";\n\nconst incomeCategories = [\"Project Payment\", \"Consulting\", \"Product Sales\", \"Other\"];\nconst expenseCategories = [\"Salary\", \"Office Rent\", \"Utilities\", \"Software\", \"Marketing\", \"Other\"];\n\nexport default function Finance() {\n  const [incomeOpen, setIncomeOpen] = useState(false);\n  const [expenseOpen, setExpenseOpen] = useState(false);\n  const { toast } = useToast();\n\n  const { data: incomes, isLoading: incomesLoading } = useQuery<Income[]>({\n    queryKey: [\"/api/income\"],\n  });\n  const { data: expenses, isLoading: expensesLoading } = useQuery<Expense[]>({\n    queryKey: [\"/api/expenses\"],\n  });\n\n  const createIncomeMutation = useMutation({\n    mutationFn: (data: IncomeFormData) => apiRequest(\"POST\", \"/api/income\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/income\"] });\n      toast({ title: \"Success\", description: \"Income added successfully\" });\n      setIncomeOpen(false);\n      incomeForm.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const createExpenseMutation = useMutation({\n    mutationFn: (data: ExpenseFormData) => apiRequest(\"POST\", \"/api/expenses\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/expenses\"] });\n      toast({ title: \"Success\", description: \"Expense added successfully\" });\n      setExpenseOpen(false);\n      expenseForm.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const incomeForm = useForm<IncomeFormData>({\n    resolver: zodResolver(insertIncomeSchema),\n    defaultValues: {\n      source: \"\",\n      amount: \"0\",\n      category: \"\",\n      description: \"\",\n    },\n  });\n\n  const expenseForm = useForm<ExpenseFormData>({\n    resolver: zodResolver(insertExpenseSchema),\n    defaultValues: {\n      title: \"\",\n      amount: \"0\",\n      category: \"\",\n      description: \"\",\n    },\n  });\n\n  const onIncomeSubmit = async (data: IncomeFormData) => {\n    const normalizedData = normalizeIncomeData(data);\n    createIncomeMutation.mutate(normalizedData);\n  };\n\n  const onExpenseSubmit = async (data: ExpenseFormData) => {\n    const normalizedData = normalizeExpenseData(data);\n    createExpenseMutation.mutate(normalizedData);\n  };\n\n  const totalIncome = incomes?.reduce((sum, income) => sum + Number(income.amount), 0) ?? 0;\n  const totalExpenses = expenses?.reduce((sum, expense) => sum + Number(expense.amount), 0) ?? 0;\n  const balance = totalIncome - totalExpenses;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Finance</h1>\n          <p className=\"text-sm text-muted-foreground\">Track income and expenses</p>\n        </div>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-3\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Income</CardTitle>\n            <div className=\"p-2 rounded-md bg-green-100 dark:bg-green-950\">\n              <TrendingUp className=\"h-4 w-4 text-green-600\" />\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-total-income\">\n              {totalIncome.toFixed(2)}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Expenses</CardTitle>\n            <div className=\"p-2 rounded-md bg-red-100 dark:bg-red-950\">\n              <TrendingDown className=\"h-4 w-4 text-red-600\" />\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-total-expenses\">\n              {totalExpenses.toFixed(2)}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Net Balance</CardTitle>\n            <div className=\"p-2 rounded-md bg-blue-100 dark:bg-blue-950\">\n              <DollarSign className=\"h-4 w-4 text-blue-600\" />\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${balance >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid=\"text-balance\">\n              {balance.toFixed(2)}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs defaultValue=\"income\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"income\" data-testid=\"tab-income\">Income</TabsTrigger>\n          <TabsTrigger value=\"expenses\" data-testid=\"tab-expenses\">Expenses</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"income\" className=\"space-y-4\">\n          <div className=\"flex justify-end\">\n            <Dialog open={incomeOpen} onOpenChange={setIncomeOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-add-income\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Add Income\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Add Income</DialogTitle>\n                  <DialogDescription>Record a new income entry</DialogDescription>\n                </DialogHeader>\n                <Form {...incomeForm}>\n                  <form onSubmit={incomeForm.handleSubmit(onIncomeSubmit)} className=\"space-y-4\">\n                    <FormField\n                      control={incomeForm.control}\n                      name=\"source\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Source</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Client ABC Payment\" {...field} data-testid=\"input-source\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <div className=\"grid gap-4 md:grid-cols-2\">\n                      <FormField\n                        control={incomeForm.control}\n                        name=\"amount\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Amount</FormLabel>\n                            <FormControl>\n                              <Input type=\"number\" placeholder=\"5000\" {...field} data-testid=\"input-amount\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={incomeForm.control}\n                        name=\"category\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Category</FormLabel>\n                            <Select onValueChange={field.onChange} defaultValue={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-category\">\n                                  <SelectValue placeholder=\"Select category\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                {incomeCategories.map((cat) => (\n                                  <SelectItem key={cat} value={cat}>\n                                    {cat}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    <FormField\n                      control={incomeForm.control}\n                      name=\"description\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Description</FormLabel>\n                          <FormControl>\n                            <Textarea placeholder=\"Additional details...\" {...field} value={field.value ?? \"\"} data-testid=\"input-description\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <div className=\"flex justify-end gap-2\">\n                      <Button type=\"button\" variant=\"outline\" onClick={() => setIncomeOpen(false)}>Cancel</Button>\n                      <Button type=\"submit\" data-testid=\"button-submit-income\">Add Income</Button>\n                    </div>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n          </div>\n\n          {incomesLoading ? (\n            <div className=\"space-y-3\">\n              {[1, 2, 3].map((i) => (\n                <Card key={i}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"h-5 bg-muted rounded w-3/4 mb-2 animate-pulse\" />\n                    <div className=\"h-4 bg-muted rounded w-1/2 animate-pulse\" />\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : !incomes || incomes.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-16\">\n                <h3 className=\"text-lg font-semibold mb-2\">No income recorded</h3>\n                <p className=\"text-sm text-muted-foreground mb-4\">Add your first income entry</p>\n                <Button onClick={() => setIncomeOpen(true)}>Add Income</Button>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-2\">\n              {incomes.map((income) => (\n                <Card key={income.id} data-testid={`card-income-${income.id}`}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex-1\">\n                        <h3 className=\"font-semibold\">{income.source}</h3>\n                        <div className=\"flex items-center gap-2 mt-1\">\n                          <Badge variant=\"outline\">{income.category}</Badge>\n                          <span className=\"text-xs text-muted-foreground\">\n                            {new Date(income.date).toLocaleDateString()}\n                          </span>\n                        </div>\n                      </div>\n                      <div className=\"text-lg font-bold text-green-600\" data-testid={`text-amount-${income.id}`}>\n                        +{Number(income.amount).toFixed(2)}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"expenses\" className=\"space-y-4\">\n          <div className=\"flex justify-end\">\n            <Dialog open={expenseOpen} onOpenChange={setExpenseOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-add-expense\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Add Expense\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Add Expense</DialogTitle>\n                  <DialogDescription>Record a new expense</DialogDescription>\n                </DialogHeader>\n                <Form {...expenseForm}>\n                  <form onSubmit={expenseForm.handleSubmit(onExpenseSubmit)} className=\"space-y-4\">\n                    <FormField\n                      control={expenseForm.control}\n                      name=\"title\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Title</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Office Supplies\" {...field} data-testid=\"input-title\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <div className=\"grid gap-4 md:grid-cols-2\">\n                      <FormField\n                        control={expenseForm.control}\n                        name=\"amount\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Amount</FormLabel>\n                            <FormControl>\n                              <Input type=\"number\" placeholder=\"500\" {...field} data-testid=\"input-amount\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={expenseForm.control}\n                        name=\"category\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Category</FormLabel>\n                            <Select onValueChange={field.onChange} defaultValue={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-category\">\n                                  <SelectValue placeholder=\"Select category\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                {expenseCategories.map((cat) => (\n                                  <SelectItem key={cat} value={cat}>\n                                    {cat}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    <FormField\n                      control={expenseForm.control}\n                      name=\"description\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Description</FormLabel>\n                          <FormControl>\n                            <Textarea placeholder=\"Additional details...\" {...field} value={field.value ?? \"\"} data-testid=\"input-description\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <div className=\"flex justify-end gap-2\">\n                      <Button type=\"button\" variant=\"outline\" onClick={() => setExpenseOpen(false)}>Cancel</Button>\n                      <Button type=\"submit\" data-testid=\"button-submit-expense\">Add Expense</Button>\n                    </div>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n          </div>\n\n          {expensesLoading ? (\n            <div className=\"space-y-3\">\n              {[1, 2, 3].map((i) => (\n                <Card key={i}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"h-5 bg-muted rounded w-3/4 mb-2 animate-pulse\" />\n                    <div className=\"h-4 bg-muted rounded w-1/2 animate-pulse\" />\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : !expenses || expenses.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-16\">\n                <h3 className=\"text-lg font-semibold mb-2\">No expenses recorded</h3>\n                <p className=\"text-sm text-muted-foreground mb-4\">Add your first expense</p>\n                <Button onClick={() => setExpenseOpen(true)}>Add Expense</Button>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-2\">\n              {expenses.map((expense) => (\n                <Card key={expense.id} data-testid={`card-expense-${expense.id}`}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex-1\">\n                        <h3 className=\"font-semibold\">{expense.title}</h3>\n                        <div className=\"flex items-center gap-2 mt-1\">\n                          <Badge variant=\"outline\">{expense.category}</Badge>\n                          <span className=\"text-xs text-muted-foreground\">\n                            {new Date(expense.date).toLocaleDateString()}\n                          </span>\n                        </div>\n                      </div>\n                      <div className=\"text-lg font-bold text-red-600\" data-testid={`text-amount-${expense.id}`}>\n                        -{Number(expense.amount).toFixed(2)}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":19207,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient } from \"@tanstack/react-query\";\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: async ({ queryKey }) => {\n        const url = queryKey[0] as string;\n        const token = localStorage.getItem(\"token\");\n        \n        const headers: HeadersInit = {\n          \"Content-Type\": \"application/json\",\n        };\n        \n        if (token) {\n          headers[\"Authorization\"] = `Bearer ${token}`;\n        }\n\n        const res = await fetch(url, {\n          headers,\n          credentials: \"include\",\n        });\n\n        if (!res.ok) {\n          if (res.status === 401) {\n            localStorage.removeItem(\"token\");\n            localStorage.removeItem(\"user\");\n            window.location.href = \"/login\";\n          }\n          const errorData = await res.json().catch(() => ({ error: \"Request failed\" }));\n          throw new Error(errorData.error || `Request failed with status ${res.status}`);\n        }\n\n        return res.json();\n      },\n      staleTime: 1000 * 60,\n      refetchOnWindowFocus: false,\n    },\n  },\n});\n\ntype RequestMethod = \"GET\" | \"POST\" | \"PUT\" | \"PATCH\" | \"DELETE\";\n\nexport async function apiRequest<T = any>(\n  method: RequestMethod,\n  url: string,\n  data?: any\n): Promise<T> {\n  const token = localStorage.getItem(\"token\");\n  \n  const headers: HeadersInit = {\n    \"Content-Type\": \"application/json\",\n  };\n  \n  if (token) {\n    headers[\"Authorization\"] = `Bearer ${token}`;\n  }\n\n  const options: RequestInit = {\n    method,\n    headers,\n    credentials: \"include\",\n  };\n\n  if (data && method !== \"GET\") {\n    options.body = JSON.stringify(data);\n  }\n\n  const res = await fetch(url, options);\n\n  if (!res.ok) {\n    if (res.status === 401) {\n      localStorage.removeItem(\"token\");\n      localStorage.removeItem(\"user\");\n      window.location.href = \"/login\";\n    }\n    const errorData = await res.json().catch(() => ({ error: \"Request failed\" }));\n    throw new Error(errorData.error || `Request failed with status ${res.status}`);\n  }\n\n  return res.json();\n}\n","path":null,"size_bytes":2051,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/pages/clients.tsx":{"content":"// screenshot (uploaded): /mnt/data/9f60c74e-08f2-49de-a525-fffdf9c8129e.png\n\nimport { useState } from \"react\";\nimport { Plus, Mail, Phone, MessageCircle, Trash2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { insertClientSchema, type Client } from \"@shared/schema\";\nimport Swal from \"sweetalert2\";\nimport { z } from \"zod\";\n\nimport PhoneInput from \"react-phone-input-2\";\nimport \"react-phone-input-2/lib/style.css\";\n\ntype ClientFormData = z.infer<typeof insertClientSchema>;\n\nexport default function Clients() {\n  const [open, setOpen] = useState(false);\n  const [editingClient, setEditingClient] = useState<Client | null>(null);\n  const { toast } = useToast();\n\n  const { data: clients, isLoading } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: ClientFormData) =>\n      apiRequest(\"POST\", \"/api/clients\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      toast({ title: \"Success\", description: \"Client created successfully\" });\n      setOpen(false);\n      setEditingClient(null);\n      form.reset();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: ClientFormData }) =>\n      apiRequest(\"PATCH\", `/api/clients/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      toast({ title: \"Success\", description: \"Client updated successfully\" });\n      setOpen(false);\n      setEditingClient(null);\n      form.reset();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/clients/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      toast({ title: \"Success\", description: \"Client deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const form = useForm<ClientFormData>({\n    resolver: zodResolver(insertClientSchema),\n    defaultValues: {\n      name: \"\",\n      email: \"\",\n      phone: \"\",\n      company: \"\",\n      whatsapp: \"\",\n      address: \"\",\n    },\n  });\n\n  const onSubmit = async (data: ClientFormData) => {\n    // Phone is stored in the form as \"+<digits>\" (react-phone-input-2 onChange prepends '+')\n    if (editingClient) {\n      updateMutation.mutate({ id: editingClient.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const handleEdit = (client: Client) => {\n    setEditingClient(client);\n\n    // Keep phone value as-is (we store with leading +). PhoneInput expects a value without spaces/plus when showing,\n    // but in the field render we'll normalize it.\n    form.reset({\n      name: client.name,\n      email: client.email,\n      phone: client.phone || \"\",\n      company: client.company || \"\",\n      whatsapp: client.whatsapp || \"\",\n      address: client.address || \"\",\n    });\n\n    setOpen(true);\n  };\n\n  const handleAddNew = () => {\n    setEditingClient(null);\n    form.reset({\n      name: \"\",\n      email: \"\",\n      phone: \"\",\n      company: \"\",\n      whatsapp: \"\",\n      address: \"\",\n    });\n    setOpen(true);\n  };\n\n  const handleDelete = async (e: React.MouseEvent, client: Client) => {\n    e.stopPropagation(); // Prevent card click event\n    const result = await Swal.fire({\n      title: \"Delete Client?\",\n      text: `Are you sure you want to delete ${client.name}? This action cannot be undone.`,\n      icon: \"warning\",\n      showCancelButton: true,\n      confirmButtonColor: \"#ef4444\",\n      cancelButtonColor: \"#6b7280\",\n      confirmButtonText: \"Yes, delete it\",\n      cancelButtonText: \"Cancel\",\n    });\n    if (result.isConfirmed) {\n      deleteMutation.mutate(client.id);\n    }\n  };\n\n  const getInitials = (name: string) => {\n    return name\n      .split(\" \")\n      .map((n) => n[0])\n      .join(\"\")\n      .toUpperCase()\n      .slice(0, 2);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"h-8 bg-muted rounded w-32 mb-6 animate-pulse\" />\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardContent className=\"p-6\">\n                <div className=\"h-12 w-12 bg-muted rounded-full mb-3 animate-pulse\" />\n                <div className=\"h-6 bg-muted rounded w-3/4 mb-2 animate-pulse\" />\n                <div className=\"h-4 bg-muted rounded w-1/2 animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">\n            Clients\n          </h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Manage your active clients\n          </p>\n        </div>\n        <Button data-testid=\"button-add-client\" onClick={handleAddNew}>\n          <Plus className=\"w-4 h-4 mr-2\" /> Add Client\n        </Button>\n\n        <Dialog open={open} onOpenChange={setOpen}>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingClient ? \"Edit Client\" : \"Add New Client\"}\n              </DialogTitle>\n              <DialogDescription>\n                {editingClient\n                  ? \"Update client information\"\n                  : \"Create a new client profile\"}\n              </DialogDescription>\n            </DialogHeader>\n\n            <Form {...form}>\n              <form\n                onSubmit={form.handleSubmit(onSubmit)}\n                className=\"space-y-4\"\n              >\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <FormField\n                    control={form.control}\n                    name=\"name\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Name</FormLabel>\n                        <FormControl>\n                          <Input\n                            placeholder=\"John Doe\"\n                            {...field}\n                            data-testid=\"input-name\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"company\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Company</FormLabel>\n                        <FormControl>\n                          <Input\n                            placeholder=\"Acme Inc\"\n                            {...field}\n                            value={field.value ?? \"\"}\n                            data-testid=\"input-company\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email</FormLabel>\n                        <FormControl>\n                          <Input\n                            placeholder=\"john@example.com\"\n                            {...field}\n                            data-testid=\"input-email\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  {/* Phone field replaced with react-phone-input-2 */}\n                  <FormField\n                    control={form.control}\n                    name=\"phone\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Phone</FormLabel>\n                        <FormControl>\n                          <PhoneInput\n                            country={\"bd\"} // default country\n                            value={\n                              field.value ? field.value.replace(/\\D/g, \"\") : \"\"\n                            }\n                            onChange={(value: string) => {\n                              // `value` comes without + and may contain spaces. Store with leading + and no spaces.\n                              const digitsOnly = value.replace(/\\D/g, \"\");\n                              field.onChange(\n                                digitsOnly ? `+${digitsOnly}` : \"\",\n                              );\n                            }}\n                            inputProps={{\n                              name: field.name,\n                              required: false,\n                              autoFocus: false,\n                            }}\n                            inputStyle={{\n                              width: \"100%\",\n                              height: 42,\n                              borderRadius: 6,\n                            }}\n                            buttonStyle={{\n                              borderTopLeftRadius: 6,\n                              borderBottomLeftRadius: 6,\n                              paddingLeft: 8,\n                              paddingRight: 8,\n                            }}\n                            containerStyle={{\n                              width: \"100%\",\n                            }}\n                            enableAreaCodes={true}\n                            enableSearch={true}\n                            disableSearchIcon={false}\n                          />\n                        </FormControl>\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          Enter full phone number (country + number). Example:\n                          +1 5551234567\n                        </p>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"whatsapp\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>WhatsApp</FormLabel>\n                        <FormControl>\n                          <Input\n                            placeholder=\"+1234567890\"\n                            {...field}\n                            value={field.value ?? \"\"}\n                            data-testid=\"input-whatsapp\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"address\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Address</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Street address...\"\n                          {...field}\n                          value={field.value ?? \"\"}\n                          data-testid=\"input-address\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex justify-end gap-2\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setOpen(false)}\n                  >\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" data-testid=\"button-submit-client\">\n                    {editingClient ? \"Update Client\" : \"Create Client\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {!clients || clients.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n              <Plus className=\"w-8 h-8 text-muted-foreground\" />\n            </div>\n            <h3 className=\"text-lg font-semibold mb-2\">No clients yet</h3>\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              Start by adding your first client\n            </p>\n            <Button onClick={() => setOpen(true)}>Add Client</Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {clients.map((client) => (\n            <Card\n              key={client.id}\n              className=\"hover-elevate cursor-pointer relative\"\n              data-testid={`card-client-${client.id}`}\n              onClick={() => handleEdit(client)}\n            >\n              {/* DELETE BUTTON: high z-index and stopPropagation in handler */}\n              <div className=\"absolute top-3 right-3 z-20\">\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  className=\"h-8 w-8 text-muted-foreground hover:text-destructive\"\n                  onClick={(e) => handleDelete(e, client)}\n                  data-testid={`button-delete-${client.id}`}\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </Button>\n              </div>\n\n              {/* CONSISTENT PADDING / MARGINS FOR CARD */}\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-start gap-4 mb-4\">\n                  <Avatar>\n                    <AvatarFallback className=\"bg-primary text-primary-foreground\">\n                      {getInitials(client.name)}\n                    </AvatarFallback>\n                  </Avatar>\n\n                  <div className=\"flex-1 min-w-0\">\n                    <h3\n                      className=\"font-semibold text-lg truncate\"\n                      data-testid={`text-client-name-${client.id}`}\n                    >\n                      {client.name}\n                    </h3>\n                    {client.company && (\n                      <p className=\"text-sm text-muted-foreground truncate\">\n                        {client.company}\n                      </p>\n                    )}\n                  </div>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground\">\n                    <Mail className=\"w-4 h-4 flex-shrink-0\" />\n                    <span className=\"truncate\">{client.email}</span>\n                  </div>\n\n                  {client.phone && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <Phone className=\"w-4 h-4 flex-shrink-0\" />\n                      <span>{client.phone}</span>\n                    </div>\n                  )}\n\n                  {client.whatsapp && (\n                    <div className=\"flex items-center gap-2\">\n                      <MessageCircle className=\"w-4 h-4 flex-shrink-0 text-green-600\" />\n                      <a\n                        href={`https://wa.me/${client.whatsapp.replace(/\\D/g, \"\")}`}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"text-green-600 hover:underline\"\n                        data-testid={`link-whatsapp-${client.id}`}\n                      >\n                        Chat on WhatsApp\n                      </a>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":17143,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport express from \"express\";\nimport bcrypt from \"bcrypt\";\nimport { eq, desc, asc, sql, inArray, and, gte, lte, ne, isNotNull } from \"drizzle-orm\";\nimport { db } from \"./db\";\nimport {\n  users,\n  leads,\n  leadEmails,\n  leadCategories,\n  leadMessageHistory,\n  clients,\n  projects,\n  tasks,\n  messages,\n  files,\n  attendance,\n  income,\n  expenses,\n  expenseCategories,\n  invoices,\n  payments,\n  payroll,\n  salaryAdjustments,\n  auditLogs,\n  notifications,\n  employees,\n  departments,\n  designations,\n  salaryStructure,\n  deviceLogs,\n  hrSettings,\n  projectCredentials,\n  insertUserSchema,\n  insertLeadSchema,\n  insertLeadEmailSchema,\n  insertLeadCategorySchema,\n  bulkEmailSchema,\n  insertClientSchema,\n  insertProjectSchema,\n  insertTaskSchema,\n  insertMessageSchema,\n  insertFileSchema,\n  insertAttendanceSchema,\n  insertIncomeSchema,\n  insertExpenseSchema,\n  insertExpenseCategorySchema,\n  insertInvoiceSchema,\n  insertPaymentSchema,\n  insertNotificationSchema,\n  insertProjectCredentialsSchema,\n  LEAD_EMAIL_TEMPLATES,\n  DEFAULT_LEAD_CATEGORIES,\n  HOSTING_PLATFORMS,\n} from \"@shared/schema\";\nimport { authenticateToken, generateToken, type AuthRequest } from \"./middleware/auth\";\nimport { auditLog, auditMiddleware } from \"./middleware/audit\";\nimport { emailService } from \"./services/email\";\nimport { serpApiService } from \"./services/serpapi\";\nimport { wsService } from \"./websocket\";\nimport { notificationService } from \"./services/notification\";\nimport multer from \"multer\";\nimport fs from \"fs/promises\";\nimport path from \"path\";\nimport PDFDocument from \"pdfkit\";\nimport { formatCurrency, calculateLineTotal, sumAmounts } from \"@shared/currency\";\nimport type { InvoiceItem } from \"@shared/schema\";\nimport { \n  addReportHeader, \n  addReportFooter, \n  createTableHeader, \n  createTableRow, \n  addSummarySection,\n  BRAND_COLORS,\n  COMPANY_INFO\n} from \"./utils/reportTemplate\";\nimport ExcelJS from \"exceljs\";\nimport { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, HeadingLevel, BorderStyle, ShadingType, Packer } from \"docx\";\nimport Decimal from \"decimal.js-light\";\nimport { format } from \"date-fns\";\n\nconst upload = multer({ dest: \"uploads/\" });\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  app.use(express.json());\n\n  // Auth routes - NO PUBLIC REGISTRATION\n  // All user accounts (including clients) must be created by admin via Team page\n  \n  app.post(\"/api/auth/login\", async (req, res) => {\n    try {\n      const { email, password } = req.body;\n\n      const [user] = await db.select().from(users).where(eq(users.email, email)).limit(1);\n      if (!user) {\n        return res.status(401).json({ error: \"Invalid credentials\" });\n      }\n\n      const validPassword = await bcrypt.compare(password, user.password);\n      if (!validPassword) {\n        return res.status(401).json({ error: \"Invalid credentials\" });\n      }\n\n      await auditLog(user.id, \"login\", \"user\", user.id);\n\n      const token = generateToken(user.id, user.role);\n      res.json({ user: { ...user, password: undefined }, token });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Dashboard stats\n  app.get(\"/api/dashboard/stats\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole === \"client\") {\n        // Client-specific stats\n        const [user] = await db.select().from(users).where(eq(users.id, req.userId!)).limit(1);\n        if (!user?.clientId) {\n          return res.status(403).json({ error: \"No client associated with this account\" });\n        }\n        \n        const clientProjects = await db.select().from(projects).where(eq(projects.clientId, user.clientId));\n        const activeProjects = clientProjects.filter(p => p.status === \"active\");\n        const completedProjects = clientProjects.filter(p => p.status === \"completed\");\n        \n        const clientInvoices = await db.select().from(invoices).where(eq(invoices.clientId, user.clientId));\n        const totalSpent = clientInvoices.reduce((sum, inv) => sum + Number(inv.amount), 0);\n        const paidInvoices = clientInvoices.filter(inv => inv.status === \"paid\");\n        const pendingAmount = clientInvoices\n          .filter(inv => inv.status !== \"paid\")\n          .reduce((sum, inv) => sum + Number(inv.amount), 0);\n        \n        return res.json({\n          totalProjects: clientProjects.length,\n          activeProjects: activeProjects.length,\n          completedProjects: completedProjects.length,\n          totalInvoices: clientInvoices.length,\n          totalSpent,\n          pendingAmount,\n          paidInvoices: paidInvoices.length,\n        });\n      }\n      \n      if (req.userRole === \"developer\") {\n        // Developer-specific stats (only allowed resources)\n        const allProjects = await db.select().from(projects);\n        const activeProjects = allProjects.filter(p => p.status === \"active\");\n        const allTasks = await db.select().from(tasks);\n        const myTasks = allTasks.filter(t => t.assignedTo === req.userId);\n        const myAttendance = await db.select().from(attendance).where(eq(attendance.userId, req.userId!));\n        const allFiles = await db.select().from(files);\n        \n        const attendanceRate = myAttendance.length > 0\n          ? (myAttendance.filter(a => a.status !== \"absent\").length / myAttendance.length) * 100\n          : 0;\n\n        return res.json({\n          totalProjects: allProjects.length,\n          activeProjects: activeProjects.length,\n          totalTasks: allTasks.length,\n          myTasks: myTasks.length,\n          completedTasks: myTasks.filter(t => t.status === \"done\").length,\n          totalFiles: allFiles.length,\n          attendanceRate: Math.round(attendanceRate),\n        });\n      }\n      \n      // Admin/Operational Head dashboard stats\n      const allLeads = await db.select().from(leads);\n      const allClients = await db.select().from(clients);\n      const allProjects = await db.select().from(projects).where(eq(projects.status, \"active\"));\n      const allIncome = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n      const allAttendance = await db.select().from(attendance);\n\n      const monthlyRevenue = allIncome.reduce((sum, i) => sum + Number(i.amount), 0);\n      const monthlyExpenses = allExpenses.reduce((sum, e) => sum + Number(e.amount), 0);\n      const attendanceRate = allAttendance.length > 0\n        ? (allAttendance.filter(a => a.status !== \"absent\").length / allAttendance.length) * 100\n        : 0;\n\n      res.json({\n        totalLeads: allLeads.length,\n        totalClients: allClients.length,\n        activeProjects: allProjects.length,\n        monthlyRevenue,\n        monthlyExpenses,\n        attendanceRate: Math.round(attendanceRate),\n        leadsGrowth: 0,\n        revenueGrowth: 0,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Dashboard Recent Activity\n  app.get(\"/api/dashboard/recent-activity\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole === \"developer\") {\n        // Developer: recent tasks, files\n        const recentTasks = await db.select({\n          id: tasks.id,\n          title: tasks.title,\n          status: tasks.status,\n          createdAt: tasks.createdAt,\n        })\n          .from(tasks)\n          .where(eq(tasks.assignedTo, req.userId!))\n          .orderBy(desc(tasks.createdAt))\n          .limit(5);\n\n        const recentFiles = await db.select({\n          id: files.id,\n          name: files.fileName,\n          createdAt: files.createdAt,\n        })\n          .from(files)\n          .where(eq(files.uploadedBy, req.userId!))\n          .orderBy(desc(files.createdAt))\n          .limit(5);\n\n        return res.json({\n          tasks: recentTasks,\n          files: recentFiles,\n        });\n      }\n\n      // Admin/Operational Head: recent leads, projects, invoices\n      const recentLeads = await db.select({\n        id: leads.id,\n        name: leads.name,\n        createdAt: leads.createdAt,\n      })\n        .from(leads)\n        .orderBy(desc(leads.createdAt))\n        .limit(3);\n\n      const recentProjects = await db.select({\n        id: projects.id,\n        name: projects.name,\n        status: projects.status,\n        createdAt: projects.createdAt,\n      })\n        .from(projects)\n        .orderBy(desc(projects.createdAt))\n        .limit(3);\n\n      const recentInvoices = await db.select({\n        id: invoices.id,\n        invoiceNumber: invoices.invoiceNumber,\n        amount: invoices.amount,\n        createdAt: invoices.createdAt,\n      })\n        .from(invoices)\n        .orderBy(desc(invoices.createdAt))\n        .limit(3);\n\n      res.json({\n        leads: recentLeads,\n        projects: recentProjects,\n        invoices: recentInvoices,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Dashboard Upcoming Deadlines\n  app.get(\"/api/dashboard/upcoming-deadlines\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      const now = new Date();\n\n      if (req.userRole === \"developer\") {\n        // Developer: upcoming tasks assigned to them\n        const upcomingTasks = await db.select({\n          id: tasks.id,\n          title: tasks.title,\n          dueDate: tasks.deadline,\n          priority: tasks.priority,\n          status: tasks.status,\n        })\n          .from(tasks)\n          .where(\n            and(\n              eq(tasks.assignedTo, req.userId!),\n              sql`${tasks.deadline} IS NOT NULL`,\n              sql`${tasks.deadline} >= ${now.toISOString()}`,\n              ne(tasks.status, \"done\")\n            )\n          )\n          .orderBy(asc(tasks.deadline))\n          .limit(5);\n\n        return res.json({ tasks: upcomingTasks });\n      }\n\n      // Admin/Operational Head: upcoming project and task deadlines\n      const upcomingProjects = await db.select({\n        id: projects.id,\n        name: projects.name,\n        endDate: projects.deadline,\n        status: projects.status,\n      })\n        .from(projects)\n        .where(\n          and(\n            sql`${projects.deadline} IS NOT NULL`,\n            sql`${projects.deadline} >= ${now.toISOString()}`,\n            ne(projects.status, \"completed\")\n          )\n        )\n        .orderBy(asc(projects.deadline))\n        .limit(5);\n\n      const upcomingTasks = await db.select({\n        id: tasks.id,\n        title: tasks.title,\n        dueDate: tasks.deadline,\n        priority: tasks.priority,\n        status: tasks.status,\n      })\n        .from(tasks)\n        .where(\n          and(\n            sql`${tasks.deadline} IS NOT NULL`,\n            sql`${tasks.deadline} >= ${now.toISOString()}`,\n            ne(tasks.status, \"done\")\n          )\n        )\n        .orderBy(asc(tasks.deadline))\n        .limit(5);\n\n      res.json({\n        projects: upcomingProjects,\n        tasks: upcomingTasks,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Users\n  app.get(\"/api/users\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Client and developer role users can only see their own record\n      if (req.userRole === \"client\" || req.userRole === \"developer\") {\n        const [user] = await db.select().from(users).where(eq(users.id, req.userId!)).limit(1);\n        if (!user) {\n          return res.status(404).json({ error: \"User not found\" });\n        }\n        return res.json([{ ...user, password: undefined }]);\n      }\n      \n      // Only admin and operational_head can see all users\n      const allUsers = await db.select().from(users);\n      res.json(allUsers.map(u => ({ ...u, password: undefined })));\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Admin-only: Create any user with specified role\n  app.post(\"/api/users\", authenticateToken, auditMiddleware(\"create\", \"user\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admins can create users\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Admin access required\" });\n      }\n\n      const { fullName, email, password, role, clientId } = req.body;\n      \n      if (!fullName || !email || !password || !role) {\n        return res.status(400).json({ error: \"Missing required fields\" });\n      }\n\n      // Validate role\n      if (![\"admin\", \"operational_head\", \"developer\", \"client\"].includes(role)) {\n        return res.status(400).json({ error: \"Invalid role\" });\n      }\n\n      // If role is client, clientId is required\n      if (role === \"client\" && !clientId) {\n        return res.status(400).json({ error: \"clientId is required for client role\" });\n      }\n\n      // Check if email already exists\n      const existingUser = await db.select().from(users).where(eq(users.email, email)).limit(1);\n      if (existingUser.length > 0) {\n        return res.status(400).json({ error: \"Email already registered\" });\n      }\n\n      // If clientId provided, verify client exists\n      if (clientId) {\n        const [client] = await db.select().from(clients).where(eq(clients.id, clientId)).limit(1);\n        if (!client) {\n          return res.status(400).json({ error: \"Client not found\" });\n        }\n      }\n\n      const hashedPassword = await bcrypt.hash(password, 10);\n\n      const [user] = await db.insert(users).values({\n        fullName,\n        email,\n        password: hashedPassword,\n        role,\n        clientId: role === \"client\" ? clientId : null,\n      }).returning();\n\n      res.json({ ...user, password: undefined });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Legacy: Admin-only create client user endpoint (kept for backward compatibility)\n  app.post(\"/api/users/client\", authenticateToken, auditMiddleware(\"create\", \"client_user\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admins can create client users\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Admin access required\" });\n      }\n\n      const { fullName, email, password, clientId } = req.body;\n      \n      if (!fullName || !email || !password || !clientId) {\n        return res.status(400).json({ error: \"Missing required fields\" });\n      }\n\n      // Check if email already exists\n      const existingUser = await db.select().from(users).where(eq(users.email, email)).limit(1);\n      if (existingUser.length > 0) {\n        return res.status(400).json({ error: \"Email already registered\" });\n      }\n\n      // Verify client exists\n      const [client] = await db.select().from(clients).where(eq(clients.id, clientId)).limit(1);\n      if (!client) {\n        return res.status(400).json({ error: \"Client not found\" });\n      }\n\n      const hashedPassword = await bcrypt.hash(password, 10);\n\n      const [user] = await db.insert(users).values({\n        fullName,\n        email,\n        password: hashedPassword,\n        role: \"client\",\n        clientId,\n      }).returning();\n\n      res.json({ ...user, password: undefined });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Update user\n  app.patch(\"/api/users/:id\", authenticateToken, auditMiddleware(\"update\", \"user\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin can update users\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Admin access required\" });\n      }\n\n      const { fullName, email, role, clientId, password } = req.body;\n      const updateData: any = {};\n\n      if (fullName !== undefined) updateData.fullName = fullName;\n      if (email !== undefined) updateData.email = email;\n      if (role !== undefined) updateData.role = role;\n      if (clientId !== undefined) updateData.clientId = clientId;\n      if (password) {\n        updateData.password = await bcrypt.hash(password, 10);\n      }\n\n      const [user] = await db.update(users)\n        .set(updateData)\n        .where(eq(users.id, req.params.id))\n        .returning();\n\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      res.json({ ...user, password: undefined });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Delete user\n  app.delete(\"/api/users/:id\", authenticateToken, auditMiddleware(\"delete\", \"user\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin can delete users\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Admin access required\" });\n      }\n\n      // Prevent deleting yourself\n      if (req.params.id === req.userId) {\n        return res.status(400).json({ error: \"Cannot delete your own account\" });\n      }\n\n      const [user] = await db.delete(users)\n        .where(eq(users.id, req.params.id))\n        .returning();\n\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      res.json({ message: \"User deleted successfully\" });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Leads\n  app.get(\"/api/leads\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access leads\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { search, status, source, category } = req.query;\n\n      // Build dynamic where conditions\n      const conditions = [];\n      \n      if (search && typeof search === \"string\") {\n        conditions.push(sql`LOWER(${leads.name}) LIKE LOWER(${'%' + search + '%'})`);\n      }\n      \n      if (status && typeof status === \"string\") {\n        conditions.push(eq(leads.status, status));\n      }\n      \n      if (source && typeof source === \"string\") {\n        conditions.push(eq(leads.source, source));\n      }\n      \n      if (category && typeof category === \"string\") {\n        conditions.push(eq(leads.category, category));\n      }\n\n      // Apply filters if any, otherwise get all leads\n      const allLeads = conditions.length > 0\n        ? await db.select().from(leads).where(and(...conditions)).orderBy(desc(leads.createdAt))\n        : await db.select().from(leads).orderBy(desc(leads.createdAt));\n      \n      res.json(allLeads);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/leads\", authenticateToken, auditMiddleware(\"create\", \"lead\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can create leads\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertLeadSchema.parse(req.body);\n\n      // Check for duplicate email\n      if (data.email) {\n        const existingByEmail = await db.select().from(leads).where(eq(leads.email, data.email)).limit(1);\n        if (existingByEmail.length > 0) {\n          return res.status(400).json({ error: `Lead with email \"${data.email}\" already exists` });\n        }\n      }\n\n      // Check for duplicate phone\n      if (data.phone) {\n        const existingByPhone = await db.select().from(leads).where(eq(leads.phone, data.phone)).limit(1);\n        if (existingByPhone.length > 0) {\n          return res.status(400).json({ error: `Lead with phone number \"${data.phone}\" already exists` });\n        }\n      }\n\n      const [lead] = await db.insert(leads).values(data).returning();\n      res.json(lead);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Bulk upload leads from CSV/Excel\n  app.post(\"/api/leads/bulk-upload\", authenticateToken, upload.single(\"file\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can bulk upload leads\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      const filePath = req.file.path;\n      const originalName = req.file.originalname.toLowerCase();\n      \n      let parsedRows: any[] = [];\n      \n      // Parse based on file type\n      if (originalName.endsWith(\".csv\")) {\n        // CSV parsing\n        const { parse } = await import(\"csv-parse/sync\");\n        const fs = await import(\"fs\");\n        const fileContent = fs.readFileSync(filePath, \"utf-8\");\n        parsedRows = parse(fileContent, {\n          columns: true,\n          skip_empty_lines: true,\n          trim: true,\n        });\n      } else if (originalName.endsWith(\".xlsx\") || originalName.endsWith(\".xls\")) {\n        // Excel parsing\n        const ExcelJS = await import(\"exceljs\");\n        const workbook = new ExcelJS.Workbook();\n        await workbook.xlsx.readFile(filePath);\n        const worksheet = workbook.worksheets[0];\n        \n        if (!worksheet) {\n          return res.status(400).json({ error: \"No worksheet found in Excel file\" });\n        }\n\n        const headers: string[] = [];\n        worksheet.getRow(1).eachCell((cell, colNumber) => {\n          headers[colNumber - 1] = String(cell.value || \"\").trim().toLowerCase();\n        });\n\n        worksheet.eachRow((row, rowNumber) => {\n          if (rowNumber === 1) return; // Skip header\n          const rowData: any = {};\n          row.eachCell((cell, colNumber) => {\n            const header = headers[colNumber - 1];\n            if (header) {\n              let value = cell.value;\n              // Handle date objects\n              if (value instanceof Date) {\n                value = value.toISOString().split(\"T\")[0];\n              }\n              rowData[header] = value;\n            }\n          });\n          if (Object.keys(rowData).length > 0) {\n            parsedRows.push(rowData);\n          }\n        });\n      } else {\n        // Clean up uploaded file\n        const fs = await import(\"fs\");\n        fs.unlinkSync(filePath);\n        return res.status(400).json({ error: \"Unsupported file format. Please upload CSV or Excel (.xlsx) file\" });\n      }\n\n      // Clean up uploaded file\n      const fs = await import(\"fs\");\n      fs.unlinkSync(filePath);\n\n      if (parsedRows.length === 0) {\n        return res.status(400).json({ error: \"No data found in file\" });\n      }\n\n      // Valid statuses and sources\n      const validStatuses = [\"new\", \"contacted\", \"qualified\", \"converted\"];\n      const validSources = [\"Facebook\", \"LinkedIn\", \"Fiverr\", \"Upwork\", \"Freelancer.com\", \"People per Hour\", \"Reference\", \"Local Market\", \"Legit\"];\n\n      const results = {\n        success: 0,\n        failed: 0,\n        errors: [] as { row: number; name: string; error: string }[],\n      };\n\n      // Process each row\n      for (let i = 0; i < parsedRows.length; i++) {\n        const row = parsedRows[i];\n        const rowNum = i + 2; // +2 because of 0-index and header row\n\n        try {\n          // Normalize column names (case-insensitive)\n          const normalizedRow: any = {};\n          for (const key of Object.keys(row)) {\n            normalizedRow[key.toLowerCase().trim()] = row[key];\n          }\n\n          // Extract and validate fields\n          const name = String(normalizedRow.name || \"\").trim();\n          const email = String(normalizedRow.email || \"\").trim();\n          const phone = String(normalizedRow.phone || \"\").trim();\n          const status = String(normalizedRow.status || \"new\").trim().toLowerCase();\n          const source = String(normalizedRow.source || \"\").trim();\n          const notes = String(normalizedRow.notes || \"\").trim();\n          let followUpDate = normalizedRow.followupdate || normalizedRow[\"follow_up_date\"] || normalizedRow[\"followup_date\"] || normalizedRow.follow_up_date || \"\";\n          \n          // Convert followUpDate to string if it's an object\n          if (followUpDate && typeof followUpDate === \"object\" && followUpDate instanceof Date) {\n            followUpDate = followUpDate.toISOString().split(\"T\")[0];\n          } else if (followUpDate) {\n            followUpDate = String(followUpDate).trim();\n          }\n\n          // Validation\n          if (!name) {\n            results.failed++;\n            results.errors.push({ row: rowNum, name: name || \"(empty)\", error: \"Name is required\" });\n            continue;\n          }\n          if (!email) {\n            results.failed++;\n            results.errors.push({ row: rowNum, name, error: \"Email is required\" });\n            continue;\n          }\n          // Basic email validation\n          if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\n            results.failed++;\n            results.errors.push({ row: rowNum, name, error: \"Invalid email format\" });\n            continue;\n          }\n          if (!validStatuses.includes(status)) {\n            results.failed++;\n            results.errors.push({ row: rowNum, name, error: `Invalid status \"${status}\". Valid: ${validStatuses.join(\", \")}` });\n            continue;\n          }\n          if (source && !validSources.some(s => s.toLowerCase() === source.toLowerCase())) {\n            results.failed++;\n            results.errors.push({ row: rowNum, name, error: `Invalid source \"${source}\". Valid: ${validSources.join(\", \")}` });\n            continue;\n          }\n\n          // Check for duplicate email\n          const existingByEmail = await db.select().from(leads).where(eq(leads.email, email)).limit(1);\n          if (existingByEmail.length > 0) {\n            results.failed++;\n            results.errors.push({ row: rowNum, name, error: `Lead with email \"${email}\" already exists` });\n            continue;\n          }\n\n          // Check for duplicate phone (if provided)\n          if (phone) {\n            const existingByPhone = await db.select().from(leads).where(eq(leads.phone, phone)).limit(1);\n            if (existingByPhone.length > 0) {\n              results.failed++;\n              results.errors.push({ row: rowNum, name, error: `Lead with phone \"${phone}\" already exists` });\n              continue;\n            }\n          }\n\n          // Find matching source (case-insensitive)\n          const matchedSource = validSources.find(s => s.toLowerCase() === source.toLowerCase()) || null;\n\n          // Prepare lead data\n          const leadData: any = {\n            name,\n            email,\n            phone: phone || null,\n            status,\n            source: matchedSource,\n            notes: notes || null,\n          };\n\n          // Handle follow-up date\n          if (followUpDate) {\n            // Parse date in YYYY-MM-DD format\n            const dateMatch = String(followUpDate).match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n            if (dateMatch) {\n              leadData.followUpDate = new Date(followUpDate);\n            }\n          }\n\n          // Insert lead\n          await db.insert(leads).values(leadData);\n          results.success++;\n        } catch (err: any) {\n          results.failed++;\n          results.errors.push({ row: rowNum, name: row.name || \"(unknown)\", error: err.message || \"Unknown error\" });\n        }\n      }\n\n      res.json({\n        message: `Imported ${results.success} lead(s) successfully${results.failed > 0 ? `, ${results.failed} failed` : \"\"}`,\n        success: results.success,\n        failed: results.failed,\n        errors: results.errors,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to process file\" });\n    }\n  });\n\n  // Smart Lead Finder - Search for businesses using SerpAPI\n  app.post(\"/api/leads/smart-finder/search\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can use smart lead finder\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { keyword, location, page = 1, perPage = 40, previousTotal = 0 } = req.body;\n\n      if (!keyword || typeof keyword !== \"string\" || keyword.trim().length < 2) {\n        return res.status(400).json({ error: \"Please provide a valid search keyword (at least 2 characters)\" });\n      }\n\n      if (!serpApiService.isConfigured()) {\n        return res.status(500).json({ error: \"Smart Lead Finder is not configured. Please add SERPAPI_KEY to your secrets.\" });\n      }\n\n      // Search for businesses with pagination\n      const searchResults = await serpApiService.searchBusinesses({\n        keyword: keyword.trim(),\n        location: location?.trim(),\n        page: Number(page),\n        perPage: Number(perPage),\n        previousTotal: Number(previousTotal) || 0,\n      });\n\n      res.json({\n        keyword: keyword.trim(),\n        location: location?.trim() || null,\n        ...searchResults,\n      });\n    } catch (error: any) {\n      console.error(\"Smart Lead Finder error:\", error.message);\n      res.status(500).json({ error: error.message || \"Failed to search for businesses\" });\n    }\n  });\n\n  // Smart Lead Finder - Search ALL results at once (for Select All functionality)\n  app.post(\"/api/leads/smart-finder/search-all\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can use smart lead finder\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { keyword, location } = req.body;\n\n      if (!keyword || typeof keyword !== \"string\" || keyword.trim().length < 2) {\n        return res.status(400).json({ error: \"Please provide a valid search keyword (at least 2 characters)\" });\n      }\n\n      if (!location || typeof location !== \"string\" || location.trim().length < 2) {\n        return res.status(400).json({ error: \"Please provide a location for business search\" });\n      }\n\n      if (!serpApiService.isConfigured()) {\n        return res.status(500).json({ error: \"Smart Lead Finder is not configured. Please add SERPAPI_KEY to your secrets.\" });\n      }\n\n      // Fetch ALL results at once\n      const searchResults = await serpApiService.searchAllBusinesses({\n        keyword: keyword.trim(),\n        location: location.trim(),\n      });\n\n      res.json({\n        keyword: keyword.trim(),\n        location: location.trim(),\n        results: searchResults.results,\n        totalResults: searchResults.totalResults,\n      });\n    } catch (error: any) {\n      console.error(\"Smart Lead Finder search-all error:\", error.message);\n      res.status(500).json({ error: error.message || \"Failed to search for businesses\" });\n    }\n  });\n\n  // Smart Lead Finder - Bulk import selected leads\n  app.post(\"/api/leads/smart-finder/import\", authenticateToken, auditMiddleware(\"create\", \"lead\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can import leads\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { selectedLeads, defaultCategory, defaultSource } = req.body;\n\n      if (!Array.isArray(selectedLeads) || selectedLeads.length === 0) {\n        return res.status(400).json({ error: \"Please select at least one lead to import\" });\n      }\n\n      const results = {\n        success: 0,\n        failed: 0,\n        skipped: 0,\n        errors: [] as { name: string; error: string }[],\n        duplicates: [] as { name: string; reason: string }[],\n        imported: [] as any[],\n      };\n\n      for (const lead of selectedLeads) {\n        try {\n          const name = String(lead.name || \"\").trim();\n          const email = lead.email ? String(lead.email).trim() : null;\n          const phone = lead.phone ? String(lead.phone).trim() : null;\n          const website = lead.website ? String(lead.website).trim() : null;\n          // User's selected category takes priority, but fall back to API's category if user didn't select one\n          // Using nullish coalescing (??) to preserve API data when user leaves selector blank\n          const category = (defaultCategory && defaultCategory.trim())\n            ? String(defaultCategory).trim() \n            : (lead.category ? String(lead.category).trim() : null);\n\n          // Validation: name is required\n          if (!name) {\n            results.failed++;\n            results.errors.push({ name: \"(empty)\", error: \"Name is required\" });\n            continue;\n          }\n\n          // Validation: at least one contact method (email, phone, or website)\n          if (!email && !phone && !website) {\n            results.failed++;\n            results.errors.push({ name, error: \"At least one contact method (email, phone, or website) is required\" });\n            continue;\n          }\n\n          // Validate email format if provided\n          if (email && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\n            results.failed++;\n            results.errors.push({ name, error: \"Invalid email format\" });\n            continue;\n          }\n\n          // Check for duplicates by email, website, OR business name\n          let isDuplicate = false;\n          let duplicateReason = \"\";\n\n          // 1. Check by email\n          if (email) {\n            const existingByEmail = await db.select().from(leads).where(eq(leads.email, email)).limit(1);\n            if (existingByEmail.length > 0) {\n              isDuplicate = true;\n              duplicateReason = `Email \"${email}\" already exists`;\n            }\n          }\n\n          // 2. Check by website\n          if (!isDuplicate && website) {\n            const existingByWebsite = await db.select().from(leads).where(eq(leads.website, website)).limit(1);\n            if (existingByWebsite.length > 0) {\n              isDuplicate = true;\n              duplicateReason = `Website \"${website}\" already exists`;\n            }\n          }\n\n          // 3. Check by business name (normalized: lowercase, trim, remove common punctuation)\n          if (!isDuplicate && name) {\n            // Normalize the name: lowercase, trim, remove periods and common suffixes\n            const normalizedName = name.toLowerCase().trim()\n              .replace(/[.,\\-]/g, '')\n              .replace(/\\s+/g, ' ')\n              .replace(/\\s*(ltd|llc|inc|corp|co|company|limited|pvt|private)\\.?\\s*$/i, '');\n            \n            const existingByName = await db.select().from(leads).where(\n              sql`LOWER(REGEXP_REPLACE(REGEXP_REPLACE(${leads.name}, '[.,\\-]', '', 'g'), '\\s*(ltd|llc|inc|corp|co|company|limited|pvt|private)\\.?\\s*$', '', 'i')) = ${normalizedName}`\n            ).limit(1);\n            if (existingByName.length > 0) {\n              isDuplicate = true;\n              duplicateReason = `Business name \"${name}\" already exists (similar to \"${existingByName[0].name}\")`;\n            }\n          }\n\n          if (isDuplicate) {\n            results.skipped++;\n            results.duplicates.push({ name, reason: duplicateReason });\n            continue;\n          }\n\n          // Build notes with additional info\n          const notesArr: string[] = [];\n          if (lead.address) notesArr.push(`Address: ${lead.address}`);\n          if (lead.rating) notesArr.push(`Rating: ${lead.rating}/5`);\n          if (lead.reviews) notesArr.push(`Reviews: ${lead.reviews}`);\n          if (lead.source && lead.source !== \"Smart Lead Finder\") notesArr.push(`Found via: ${lead.source}`);\n\n          // Set follow-up date to 7 days from now\n          const followUpDate = new Date();\n          followUpDate.setDate(followUpDate.getDate() + 7);\n\n          // Insert lead with user-selected source or default\n          const source = defaultSource \n            ? String(defaultSource).trim() \n            : \"Smart Lead Finder\";\n            \n          const [newLead] = await db.insert(leads).values({\n            name,\n            email,\n            phone,\n            website,\n            category,\n            status: \"new\",\n            source,\n            notes: notesArr.length > 0 ? notesArr.join(\"\\n\") : null,\n            followUpDate,\n          }).returning();\n\n          results.success++;\n          results.imported.push(newLead);\n        } catch (err: any) {\n          results.failed++;\n          results.errors.push({ name: lead.name || \"(unknown)\", error: err.message || \"Unknown error\" });\n        }\n      }\n\n      const message = [\n        `Imported ${results.success} lead(s) successfully`,\n        results.skipped > 0 ? `${results.skipped} skipped (duplicates)` : \"\",\n        results.failed > 0 ? `${results.failed} failed` : \"\"\n      ].filter(Boolean).join(\", \");\n\n      res.json({\n        message,\n        success: results.success,\n        skipped: results.skipped,\n        failed: results.failed,\n        errors: results.errors,\n        duplicates: results.duplicates,\n        imported: results.imported,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to import leads\" });\n    }\n  });\n\n  // Lead Categories\n  app.get(\"/api/lead-categories\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access lead categories\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const categories = await db.select().from(leadCategories).orderBy(asc(leadCategories.name));\n      res.json(categories);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/lead-categories\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin can create categories\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertLeadCategorySchema.parse(req.body);\n      const [category] = await db.insert(leadCategories).values(data).returning();\n      res.json(category);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/lead-categories/seed\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin can seed categories\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Check if any categories exist\n      const existing = await db.select().from(leadCategories).limit(1);\n      if (existing.length > 0) {\n        return res.status(400).json({ error: \"Categories already exist. Use the add category feature instead.\" });\n      }\n\n      // Seed default categories\n      const categories = [];\n      for (const name of DEFAULT_LEAD_CATEGORIES) {\n        const [category] = await db.insert(leadCategories).values({\n          name,\n          isActive: true,\n        }).returning();\n        categories.push(category);\n      }\n\n      res.json({ message: `Created ${categories.length} default categories`, categories });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/lead-categories/:id\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin can update categories\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertLeadCategorySchema.partial().parse(req.body);\n      const [category] = await db.update(leadCategories).set(data).where(eq(leadCategories.id, req.params.id)).returning();\n      res.json(category);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/lead-categories/:id\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin can delete categories\n      if (req.userRole !== \"admin\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      await db.delete(leadCategories).where(eq(leadCategories.id, req.params.id));\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Bulk Email to Leads\n  app.post(\"/api/leads/bulk-email\", authenticateToken, auditMiddleware(\"create\", \"lead_email\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can send bulk emails\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { leadIds, subject, message } = bulkEmailSchema.parse(req.body);\n\n      // Get leads with email addresses\n      const leadsToEmail = await db.select().from(leads).where(inArray(leads.id, leadIds));\n      \n      const results = {\n        success: 0,\n        failed: 0,\n        skipped: 0,\n        errors: [] as { name: string; error: string }[],\n        sent: [] as { leadId: string; name: string; email: string }[],\n      };\n\n      for (const lead of leadsToEmail) {\n        try {\n          if (!lead.email) {\n            results.skipped++;\n            results.errors.push({ name: lead.name, error: \"No email address\" });\n            continue;\n          }\n\n          // Send email\n          const emailResult = await emailService.sendEmail({\n            to: lead.email,\n            subject: subject,\n            text: message,\n            html: `<div style=\"font-family: Arial, sans-serif; line-height: 1.6;\">\n              ${message.split('\\n').map(line => `<p>${line}</p>`).join('')}\n              <hr style=\"border: 1px solid #eee; margin-top: 30px;\">\n              <p style=\"color: #666; font-size: 12px;\">This email was sent by MaxTech BD</p>\n            </div>`,\n          });\n\n          if (emailResult.success) {\n            // Save to message history\n            await db.insert(leadMessageHistory).values({\n              leadId: lead.id,\n              subject,\n              message,\n              status: \"sent\",\n              sentBy: req.userId!,\n            });\n\n            results.success++;\n            results.sent.push({ leadId: lead.id, name: lead.name, email: lead.email });\n          } else {\n            // Save failed attempt to history\n            await db.insert(leadMessageHistory).values({\n              leadId: lead.id,\n              subject,\n              message,\n              status: \"failed\",\n              sentBy: req.userId!,\n              errorMessage: emailResult.error,\n            });\n\n            results.failed++;\n            results.errors.push({ name: lead.name, error: emailResult.error || \"Failed to send\" });\n          }\n        } catch (err: any) {\n          results.failed++;\n          results.errors.push({ name: lead.name, error: err.message || \"Unknown error\" });\n        }\n      }\n\n      const statusMessage = [\n        `Sent ${results.success} email(s) successfully`,\n        results.skipped > 0 ? `${results.skipped} skipped (no email)` : \"\",\n        results.failed > 0 ? `${results.failed} failed` : \"\"\n      ].filter(Boolean).join(\", \");\n\n      res.json({\n        message: statusMessage,\n        success: results.success,\n        skipped: results.skipped,\n        failed: results.failed,\n        errors: results.errors,\n        sent: results.sent,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to send bulk emails\" });\n    }\n  });\n\n  // Get message history for a lead\n  app.get(\"/api/leads/:id/messages\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can view message history\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const messages = await db.select({\n        id: leadMessageHistory.id,\n        subject: leadMessageHistory.subject,\n        message: leadMessageHistory.message,\n        status: leadMessageHistory.status,\n        sentAt: leadMessageHistory.sentAt,\n        errorMessage: leadMessageHistory.errorMessage,\n        sentBy: users.fullName,\n      })\n        .from(leadMessageHistory)\n        .leftJoin(users, eq(leadMessageHistory.sentBy, users.id))\n        .where(eq(leadMessageHistory.leadId, req.params.id))\n        .orderBy(desc(leadMessageHistory.sentAt));\n\n      res.json(messages);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/leads/:id\", authenticateToken, auditMiddleware(\"update\", \"lead\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can update leads\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertLeadSchema.partial().parse(req.body);\n      const [lead] = await db.update(leads).set(data).where(eq(leads.id, req.params.id)).returning();\n      res.json(lead);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/leads/:id\", authenticateToken, auditMiddleware(\"delete\", \"lead\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can delete leads\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      await db.delete(leads).where(eq(leads.id, req.params.id));\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Lead Email Routes\n  app.get(\"/api/leads/:id/emails\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can view lead emails\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const emails = await db\n        .select()\n        .from(leadEmails)\n        .where(eq(leadEmails.leadId, req.params.id))\n        .orderBy(desc(leadEmails.createdAt));\n\n      res.json(emails);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/leads/:id/emails/send\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can send emails to leads\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { templateName } = req.body;\n      \n      if (!templateName || !LEAD_EMAIL_TEMPLATES.includes(templateName)) {\n        return res.status(400).json({ \n          error: \"Invalid template. Valid templates: \" + LEAD_EMAIL_TEMPLATES.join(\", \") \n        });\n      }\n\n      // Get lead info\n      const [lead] = await db\n        .select()\n        .from(leads)\n        .where(eq(leads.id, req.params.id))\n        .limit(1);\n\n      if (!lead) {\n        return res.status(404).json({ error: \"Lead not found\" });\n      }\n\n      // Get email subject\n      const subject = emailService.getTemplateSubject(templateName);\n\n      // Create email record\n      const [emailRecord] = await db\n        .insert(leadEmails)\n        .values({\n          leadId: lead.id,\n          templateName,\n          subject,\n          status: \"pending\",\n          sentBy: req.userId!,\n        })\n        .returning();\n\n      // Send email\n      const success = await emailService.sendLeadTemplateEmail(lead, templateName);\n\n      // Update email record with result\n      if (success) {\n        await db\n          .update(leadEmails)\n          .set({ status: \"sent\", sentAt: new Date() })\n          .where(eq(leadEmails.id, emailRecord.id));\n      } else {\n        await db\n          .update(leadEmails)\n          .set({ status: \"failed\", errorMessage: \"Email service failed to send\" })\n          .where(eq(leadEmails.id, emailRecord.id));\n      }\n\n      // Get updated record\n      const [updatedEmail] = await db\n        .select()\n        .from(leadEmails)\n        .where(eq(leadEmails.id, emailRecord.id))\n        .limit(1);\n\n      res.json({\n        success,\n        message: success ? \"Email sent successfully\" : \"Failed to send email\",\n        email: updatedEmail,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Send welcome emails to new lead (batch)\n  app.post(\"/api/leads/:id/emails/send-welcome\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can send welcome emails\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Get lead info\n      const [lead] = await db\n        .select()\n        .from(leads)\n        .where(eq(leads.id, req.params.id))\n        .limit(1);\n\n      if (!lead) {\n        return res.status(404).json({ error: \"Lead not found\" });\n      }\n\n      const templatesToSend = [\"service_introduction\", \"company_profile\", \"pricing_brochure\"];\n      const results = [];\n\n      for (const templateName of templatesToSend) {\n        const subject = emailService.getTemplateSubject(templateName);\n        \n        // Create email record\n        const [emailRecord] = await db\n          .insert(leadEmails)\n          .values({\n            leadId: lead.id,\n            templateName,\n            subject,\n            status: \"pending\",\n            sentBy: req.userId!,\n          })\n          .returning();\n\n        // Send email\n        const success = await emailService.sendLeadTemplateEmail(lead, templateName);\n\n        // Update record\n        if (success) {\n          await db\n            .update(leadEmails)\n            .set({ status: \"sent\", sentAt: new Date() })\n            .where(eq(leadEmails.id, emailRecord.id));\n        } else {\n          await db\n            .update(leadEmails)\n            .set({ status: \"failed\", errorMessage: \"Email service failed to send\" })\n            .where(eq(leadEmails.id, emailRecord.id));\n        }\n\n        results.push({ templateName, success });\n      }\n\n      const successCount = results.filter(r => r.success).length;\n      res.json({\n        message: `Sent ${successCount}/${templatesToSend.length} welcome emails`,\n        results,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Clients\n  app.get(\"/api/clients\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access clients\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const allClients = await db.select().from(clients).orderBy(desc(clients.createdAt));\n      res.json(allClients);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/clients\", authenticateToken, auditMiddleware(\"create\", \"client\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can create clients\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertClientSchema.parse(req.body);\n      \n      // Check for duplicate email\n      const [existingClient] = await db\n        .select()\n        .from(clients)\n        .where(eq(clients.email, data.email))\n        .limit(1);\n      \n      if (existingClient) {\n        return res.status(400).json({ error: \"A client with this email already exists\" });\n      }\n\n      const [client] = await db.insert(clients).values(data).returning();\n      res.json(client);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/clients/:id\", authenticateToken, auditMiddleware(\"update\", \"client\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can update clients\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertClientSchema.partial().parse(req.body);\n      const [client] = await db.update(clients).set(data).where(eq(clients.id, req.params.id)).returning();\n      res.json(client);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/clients/:id\", authenticateToken, auditMiddleware(\"delete\", \"client\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can delete clients\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Check if client has associated projects\n      const clientProjects = await db\n        .select()\n        .from(projects)\n        .where(eq(projects.clientId, req.params.id))\n        .limit(1);\n      \n      if (clientProjects.length > 0) {\n        return res.status(400).json({ \n          error: \"Cannot delete client with associated projects. Please delete or reassign projects first.\" \n        });\n      }\n\n      await db.delete(clients).where(eq(clients.id, req.params.id));\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Projects\n  app.get(\"/api/projects\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      let allProjects;\n      if (req.userRole === \"client\") {\n        // Get user's client ID\n        const [user] = await db.select().from(users).where(eq(users.id, req.userId!)).limit(1);\n        if (!user?.clientId) {\n          return res.status(403).json({ error: \"No client associated with this account\" });\n        }\n        allProjects = await db.select().from(projects)\n          .where(eq(projects.clientId, user.clientId))\n          .orderBy(desc(projects.createdAt));\n      } else {\n        allProjects = await db.select().from(projects).orderBy(desc(projects.createdAt));\n      }\n      res.json(allProjects);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/projects\", authenticateToken, auditMiddleware(\"create\", \"project\"), async (req: AuthRequest, res) => {\n    try {\n      const data = insertProjectSchema.parse(req.body);\n      const [project] = await db.insert(projects).values({\n        ...data,\n        createdBy: req.userId,\n      }).returning();\n      res.json(project);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/projects/:id\", authenticateToken, auditMiddleware(\"update\", \"project\"), async (req: AuthRequest, res) => {\n    try {\n      const data = insertProjectSchema.partial().parse(req.body);\n      const [project] = await db.update(projects).set(data).where(eq(projects.id, req.params.id)).returning();\n      res.json(project);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Tasks\n  app.get(\"/api/tasks\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      let allTasks: any[];\n      \n      // CLIENT SECURITY: Clients can only view tasks from their own projects (read-only)\n      if (req.userRole === \"client\") {\n        // Get user's clientId\n        const [user] = await db.select().from(users).where(eq(users.id, req.userId!)).limit(1);\n        if (!user?.clientId) {\n          return res.status(403).json({ error: \"No client associated with this user\" });\n        }\n        \n        // Get all projects for this client\n        const clientProjects = await db.select().from(projects).where(eq(projects.clientId, user.clientId));\n        const projectIds = clientProjects.map(p => p.id);\n        \n        if (projectIds.length > 0) {\n          // Use inArray for safe parameter binding (prevents SQL injection)\n          allTasks = await db.select().from(tasks)\n            .where(inArray(tasks.projectId, projectIds))\n            .orderBy(desc(tasks.createdAt));\n        } else {\n          allTasks = [];\n        }\n      } else {\n        allTasks = await db.select().from(tasks).orderBy(desc(tasks.createdAt));\n      }\n      \n      res.json(allTasks);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/tasks\", authenticateToken, auditMiddleware(\"create\", \"task\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can create tasks\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertTaskSchema.parse(req.body);\n      const [task] = await db.insert(tasks).values(data).returning();\n      \n      // Send email notification to assignee if assigned\n      if (task.assignedTo) {\n        const [assignee] = await db.select().from(users).where(eq(users.id, task.assignedTo)).limit(1);\n        if (assignee) {\n          const [project] = await db.select().from(projects).where(eq(projects.id, task.projectId)).limit(1);\n          await emailService.sendTaskAssignment({ ...task, project }, assignee);\n        }\n      }\n      \n      res.json(task);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/tasks/:id\", authenticateToken, auditMiddleware(\"update\", \"task\"), async (req: AuthRequest, res) => {\n    try {\n      const data = insertTaskSchema.partial().parse(req.body);\n      const [task] = await db.update(tasks).set(data).where(eq(tasks.id, req.params.id)).returning();\n      res.json(task);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Attendance\n  app.get(\"/api/attendance\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      let allAttendance;\n      if (req.userRole === \"admin\" || req.userRole === \"operational_head\") {\n        allAttendance = await db.select().from(attendance).orderBy(desc(attendance.date));\n      } else {\n        allAttendance = await db.select().from(attendance).where(eq(attendance.userId, req.userId!)).orderBy(desc(attendance.date));\n      }\n      res.json(allAttendance);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/attendance/check-in\", authenticateToken, auditMiddleware(\"check-in\", \"attendance\"), async (req: AuthRequest, res) => {\n    try {\n      const [existing] = await db.select().from(attendance)\n        .where(eq(attendance.userId, req.userId!))\n        .orderBy(desc(attendance.date))\n        .limit(1);\n\n      if (existing && new Date(existing.date).toDateString() === new Date().toDateString() && existing.checkIn) {\n        return res.status(400).json({ error: \"Already checked in today\" });\n      }\n\n      const today = new Date().toISOString().split('T')[0];\n      const [record] = await db.insert(attendance).values({\n        userId: req.userId!,\n        date: today,\n        checkIn: new Date(),\n        status: \"on-time\",\n      }).returning();\n\n      res.json(record);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/attendance/check-out\", authenticateToken, auditMiddleware(\"check-out\", \"attendance\"), async (req: AuthRequest, res) => {\n    try {\n      const [existing] = await db.select().from(attendance)\n        .where(eq(attendance.userId, req.userId!))\n        .orderBy(desc(attendance.date))\n        .limit(1);\n\n      if (!existing || !existing.checkIn) {\n        return res.status(400).json({ error: \"No check-in found for today\" });\n      }\n\n      if (existing.checkOut) {\n        return res.status(400).json({ error: \"Already checked out today\" });\n      }\n\n      const [record] = await db.update(attendance)\n        .set({ checkOut: new Date() })\n        .where(eq(attendance.id, existing.id))\n        .returning();\n\n      res.json(record);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Manual attendance entry - Admin only\n  app.post(\"/api/attendance/manual\", authenticateToken, auditMiddleware(\"create\", \"attendance\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can manually add attendance\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { userId, date, status, checkIn, checkOut, notes } = req.body;\n\n      // DEBUG: Log incoming status\n      console.log(\" Manual Attendance - Received status:\", status, \"| Type:\", typeof status);\n      console.log(\" Full request body:\", JSON.stringify(req.body));\n\n      // Validate required fields\n      if (!userId || !date || !status) {\n        return res.status(400).json({ error: \"User ID, date, and status are required\" });\n      }\n\n      // CRITICAL FIX: Verify that the user exists and has an employee record\n      const [userRecord] = await db.select().from(users).where(eq(users.id, userId)).limit(1);\n      if (!userRecord) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      // Check if user has an employee record\n      const [employeeRecord] = await db.select().from(employees)\n        .where(eq(employees.userId, userId))\n        .limit(1);\n      \n      if (!employeeRecord) {\n        return res.status(400).json({ \n          error: \"This user does not have an employee record. Please create an employee record first before adding attendance.\" \n        });\n      }\n\n      // Convert time strings to proper timestamps by combining with date\n      let checkInTimestamp = null;\n      let checkOutTimestamp = null;\n\n      if (checkIn && checkIn.trim() !== \"\") {\n        // Combine date (YYYY-MM-DD) with time (HH:MM) to create ISO timestamp\n        checkInTimestamp = new Date(`${date}T${checkIn}:00`);\n        \n        // Validate timestamp\n        if (isNaN(checkInTimestamp.getTime())) {\n          return res.status(400).json({ error: \"Invalid check-in time format\" });\n        }\n      }\n\n      if (checkOut && checkOut.trim() !== \"\") {\n        // Combine date (YYYY-MM-DD) with time (HH:MM) to create ISO timestamp\n        checkOutTimestamp = new Date(`${date}T${checkOut}:00`);\n        \n        // Validate timestamp\n        if (isNaN(checkOutTimestamp.getTime())) {\n          return res.status(400).json({ error: \"Invalid check-out time format\" });\n        }\n      }\n\n      // Check if attendance already exists for this user and date\n      const [existing] = await db.select().from(attendance)\n        .where(and(\n          eq(attendance.userId, userId),\n          sql`${attendance.date} = ${date}`\n        ))\n        .limit(1);\n\n      let record;\n      if (existing) {\n        // Update existing attendance\n        console.log(\" UPDATING existing attendance with status:\", status);\n        [record] = await db.update(attendance)\n          .set({\n            status,\n            checkIn: checkInTimestamp,\n            checkOut: checkOutTimestamp,\n            notes,\n          })\n          .where(eq(attendance.id, existing.id))\n          .returning();\n      } else {\n        // Create new attendance record\n        console.log(\" CREATING new attendance with status:\", status);\n        [record] = await db.insert(attendance).values({\n          userId,\n          date,\n          status,\n          checkIn: checkInTimestamp,\n          checkOut: checkOutTimestamp,\n          notes,\n        }).returning();\n      }\n\n      console.log(\" SAVED record - status:\", record.status);\n      res.json(record);\n    } catch (error: any) {\n      console.error(\"Manual attendance error:\", error);\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // GET /api/employees - Fetch all active employees with user information\n  app.get(\"/api/employees\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access employee list\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Fetch all active employees with their user information\n      const employeeList = await db\n        .select({\n          id: employees.id,\n          userId: employees.userId,\n          employeeId: employees.employeeId,\n          departmentId: employees.departmentId,\n          designationId: employees.designationId,\n          status: employees.status,\n          user: {\n            id: users.id,\n            fullName: users.fullName,\n            email: users.email,\n          },\n        })\n        .from(employees)\n        .innerJoin(users, eq(employees.userId, users.id))\n        .where(eq(employees.status, \"active\"));\n\n      res.json(employeeList);\n    } catch (error: any) {\n      console.error(\"Employees GET error:\", error);\n      res.status(500).json({ error: \"Failed to fetch employees\" });\n    }\n  });\n\n  // Income\n  app.get(\"/api/income\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access finance records\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const allIncome = await db.select().from(income).orderBy(desc(income.date));\n      res.json(allIncome);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/income\", authenticateToken, auditMiddleware(\"create\", \"income\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can create income records\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertIncomeSchema.parse(req.body);\n      const [incomeRecord] = await db.insert(income).values({\n        ...data,\n        createdBy: req.userId,\n      }).returning();\n      res.json(incomeRecord);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Expenses\n  app.get(\"/api/expenses\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access finance records\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const allExpenses = await db.select().from(expenses).orderBy(desc(expenses.date));\n      res.json(allExpenses);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/expenses\", authenticateToken, auditMiddleware(\"create\", \"expense\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can create expense records\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertExpenseSchema.parse(req.body);\n      const [expense] = await db.insert(expenses).values({\n        ...data,\n        createdBy: req.userId,\n      }).returning();\n      res.json(expense);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Expense Categories\n  app.get(\"/api/expense-categories\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const categories = await db.select().from(expenseCategories).orderBy(expenseCategories.name);\n      res.json(categories);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/expense-categories\", authenticateToken, auditMiddleware(\"create\", \"expense_category\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertExpenseCategorySchema.parse(req.body);\n      const [category] = await db.insert(expenseCategories).values(data).returning();\n      res.json(category);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/expense-categories/:id\", authenticateToken, auditMiddleware(\"update\", \"expense_category\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { id } = req.params;\n      const data = insertExpenseCategorySchema.partial().parse(req.body);\n      const [category] = await db.update(expenseCategories).set(data).where(eq(expenseCategories.id, id)).returning();\n      res.json(category);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/expense-categories/:id\", authenticateToken, auditMiddleware(\"delete\", \"expense_category\"), async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { id } = req.params;\n      await db.delete(expenseCategories).where(eq(expenseCategories.id, id));\n      res.json({ message: \"Category deleted\" });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Invoices\n  app.get(\"/api/invoices\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      let allInvoices;\n      if (req.userRole === \"client\") {\n        // Get user's client ID\n        const [user] = await db.select().from(users).where(eq(users.id, req.userId!)).limit(1);\n        if (!user?.clientId) {\n          return res.status(403).json({ error: \"No client associated with this account\" });\n        }\n        allInvoices = await db.select().from(invoices)\n          .where(eq(invoices.clientId, user.clientId))\n          .orderBy(desc(invoices.createdAt));\n      } else if (req.userRole === \"admin\" || req.userRole === \"operational_head\") {\n        allInvoices = await db.select().from(invoices).orderBy(desc(invoices.createdAt));\n      } else {\n        // Developers and other roles don't have access to invoices\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      res.json(allInvoices);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/invoices\", authenticateToken, auditMiddleware(\"create\", \"invoice\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can create invoices\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertInvoiceSchema.parse(req.body);\n      const [invoice] = await db.insert(invoices).values(data).returning();\n      res.json(invoice);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/invoices/:id\", authenticateToken, auditMiddleware(\"update\", \"invoice\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can update invoices\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const data = insertInvoiceSchema.partial().parse(req.body);\n      const [invoice] = await db.update(invoices).set(data).where(eq(invoices.id, req.params.id)).returning();\n      \n      // Send email notification when invoice is marked as sent\n      if (data.status === \"sent\" && invoice.clientId) {\n        const [client] = await db.select().from(clients).where(eq(clients.id, invoice.clientId)).limit(1);\n        if (client) {\n          await emailService.sendInvoiceReminder({ ...invoice, client });\n        }\n      }\n      \n      res.json(invoice);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.get(\"/api/invoices/:id/download\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      const invoiceId = req.params.id;\n      \n      // Get invoice with client information\n      const [invoice] = await db.select().from(invoices).where(eq(invoices.id, invoiceId)).limit(1);\n      \n      if (!invoice) {\n        return res.status(404).json({ error: \"Invoice not found\" });\n      }\n      \n      // Check access permissions\n      if (req.userRole === \"client\") {\n        // Clients can only download their own invoices\n        const [user] = await db.select().from(users).where(eq(users.id, req.userId!)).limit(1);\n        if (!user?.clientId || user.clientId !== invoice.clientId) {\n          return res.status(403).json({ error: \"Access denied\" });\n        }\n      } else if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        // Developers and other roles don't have access\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      // Get client details\n      const [client] = await db.select().from(clients).where(eq(clients.id, invoice.clientId)).limit(1);\n      \n      if (!client) {\n        return res.status(404).json({ error: \"Client not found\" });\n      }\n      \n      // Generate PDF using pdfkit with professional design\n      const doc = new PDFDocument({ \n        margin: 40,\n        size: 'A4',\n        bufferPages: true\n      });\n      \n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"Invoice-${invoice.invoiceNumber}.pdf\"`);\n      \n      // Pipe the PDF to the response\n      doc.pipe(res);\n      \n      // ===== PROFESSIONAL HEADER SECTION =====\n      // Background color bar for header\n      doc.save();\n      doc.rect(0, 0, 595, 120).fill('#F8F9FA');\n      doc.restore();\n      \n      // Company Logo\n      try {\n        const logoPath = path.join(__dirname, \"../attached_assets/Untitled design (1)_1763794635122.png\");\n        doc.image(logoPath, 40, 30, { width: 80, height: 80 });\n      } catch (error) {\n        console.warn(\"Logo not found, skipping logo in PDF\");\n      }\n      \n      // Company Information (right side of header)\n      doc.fontSize(14).font(\"Helvetica-Bold\").fillColor(\"#C8102E\");\n      doc.text(\"MaxTech BD\", 350, 35, { width: 200, align: \"right\" });\n      \n      doc.fontSize(9).font(\"Helvetica\").fillColor(\"#212121\");\n      doc.text(\"522, SK Mujib Road (4th Floor)\", 350, 52, { width: 200, align: \"right\" });\n      doc.text(\"Agrabad, Double Mooring\", 350, 64, { width: 200, align: \"right\" });\n      doc.text(\"Chattogram, Bangladesh\", 350, 76, { width: 200, align: \"right\" });\n      doc.text(\"Phone: +8801843180008\", 350, 92, { width: 200, align: \"right\" });\n      doc.text(\"Email: info@maxtechbd.com\", 350, 104, { width: 200, align: \"right\" });\n      \n      // ===== INVOICE TITLE =====\n      doc.fontSize(32).font(\"Helvetica-Bold\").fillColor(\"#C8102E\");\n      doc.text(\"INVOICE\", 40, 145);\n      \n      // ===== TWO-COLUMN SECTION: Invoice Details & Bill To =====\n      const detailsStartY = 200;\n      \n      // Left Column - Invoice Details Box\n      doc.save();\n      doc.rect(40, detailsStartY, 250, 110).stroke(\"#E5E7EB\");\n      doc.rect(40, detailsStartY, 250, 30).fillAndStroke(\"#F3F4F6\", \"#E5E7EB\");\n      doc.restore();\n      \n      doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#374151\");\n      doc.text(\"Invoice Details\", 50, detailsStartY + 8);\n      \n      doc.fontSize(10).font(\"Helvetica\").fillColor(\"#6B7280\");\n      doc.text(\"Invoice Number:\", 50, detailsStartY + 45);\n      doc.text(\"Invoice Date:\", 50, detailsStartY + 62);\n      doc.text(\"Due Date:\", 50, detailsStartY + 79);\n      doc.text(\"Status:\", 50, detailsStartY + 96);\n      \n      doc.font(\"Helvetica-Bold\").fillColor(\"#111827\");\n      doc.text(invoice.invoiceNumber, 160, detailsStartY + 45);\n      doc.text(new Date(invoice.createdAt).toLocaleDateString('en-US', { \n        year: 'numeric', month: 'short', day: 'numeric' \n      }), 160, detailsStartY + 62);\n      doc.text(new Date(invoice.dueDate).toLocaleDateString('en-US', { \n        year: 'numeric', month: 'short', day: 'numeric' \n      }), 160, detailsStartY + 79);\n      \n      // Status badge\n      const statusColors: Record<string, string> = {\n        'draft': '#9CA3AF',\n        'sent': '#3B82F6',\n        'paid': '#10B981',\n        'overdue': '#EF4444'\n      };\n      doc.fillColor(statusColors[invoice.status] || '#9CA3AF');\n      doc.text(invoice.status.toUpperCase(), 160, detailsStartY + 96);\n      \n      // Right Column - Bill To Box\n      doc.save();\n      doc.rect(305, detailsStartY, 250, 110).stroke(\"#E5E7EB\");\n      doc.rect(305, detailsStartY, 250, 30).fillAndStroke(\"#F3F4F6\", \"#E5E7EB\");\n      doc.restore();\n      \n      doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#374151\");\n      doc.text(\"Bill To\", 315, detailsStartY + 8);\n      \n      doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#111827\");\n      doc.text(client.name, 315, detailsStartY + 45, { width: 230 });\n      \n      doc.fontSize(10).font(\"Helvetica\").fillColor(\"#6B7280\");\n      let billToY = detailsStartY + 62;\n      if (client.email) {\n        doc.text(client.email, 315, billToY, { width: 230 });\n        billToY += 15;\n      }\n      if (client.phone) {\n        doc.text(client.phone, 315, billToY, { width: 230 });\n      }\n      \n      // ===== ITEMS TABLE =====\n      const tableTop = 340;\n      const rowHeight = 40;\n      let currentY = tableTop + 35;\n      \n      // Check if invoice has itemized lines\n      const invoiceItems = invoice.items && Array.isArray(invoice.items) && invoice.items.length > 0 \n        ? invoice.items as InvoiceItem[]\n        : null;\n      \n      if (invoiceItems) {\n        // Render itemized invoice with quantity, rate, and amount columns\n        // Table Header\n        doc.save();\n        doc.rect(40, tableTop, 515, 35).fillAndStroke(\"#C8102E\", \"#C8102E\");\n        doc.restore();\n        \n        doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#FFFFFF\");\n        doc.text(\"Description\", 50, tableTop + 11, { width: 220 });\n        doc.text(\"Qty\", 280, tableTop + 11, { width: 50, align: \"right\" });\n        doc.text(\"Rate\", 340, tableTop + 11, { width: 80, align: \"right\" });\n        doc.text(\"Amount\", 430, tableTop + 11, { width: 115, align: \"right\" });\n        \n        // Calculate line totals from quantity * rate (single source of truth)\n        const calculatedLineTotals: string[] = [];\n        \n        // Render each item\n        invoiceItems.forEach((item, index) => {\n          const bgColor = index % 2 === 0 ? \"#FAFAFA\" : \"#FFFFFF\";\n          doc.save();\n          doc.rect(40, currentY, 515, rowHeight).fillAndStroke(bgColor, \"#E5E7EB\");\n          doc.restore();\n          \n          // Calculate line total from quantity * rate\n          const lineTotal = calculateLineTotal(item.quantity || 0, item.rate || 0);\n          calculatedLineTotals.push(lineTotal);\n          \n          doc.fontSize(10).font(\"Helvetica\").fillColor(\"#374151\");\n          doc.text(item.description || 'Item', 50, currentY + 13, { width: 220 });\n          doc.text(String(item.quantity || 0), 280, currentY + 13, { width: 50, align: \"right\" });\n          doc.text(formatCurrency(item.rate || 0, { prefix: '' }), 340, currentY + 13, { width: 80, align: \"right\" });\n          doc.font(\"Helvetica-Bold\").fillColor(\"#111827\");\n          doc.text(formatCurrency(lineTotal), 430, currentY + 13, { width: 115, align: \"right\" });\n          \n          currentY += rowHeight;\n        });\n        \n        // Calculate subtotal from calculated line totals (not stored amounts)\n        const subtotal = sumAmounts(calculatedLineTotals);\n        \n      } else {\n        // Render simple single-amount invoice\n        // Table Header\n        doc.save();\n        doc.rect(40, tableTop, 515, 35).fillAndStroke(\"#C8102E\", \"#C8102E\");\n        doc.restore();\n        \n        doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#FFFFFF\");\n        doc.text(\"Description\", 50, tableTop + 11);\n        doc.text(\"Amount\", 450, tableTop + 11, { width: 95, align: \"right\" });\n        \n        // Render single row\n        doc.save();\n        doc.rect(40, currentY, 515, rowHeight).fillAndStroke(\"#FAFAFA\", \"#E5E7EB\");\n        doc.restore();\n        \n        doc.fontSize(10).font(\"Helvetica\").fillColor(\"#374151\");\n        doc.text(\"Invoice Amount\", 50, currentY + 13);\n        doc.font(\"Helvetica-Bold\").fillColor(\"#111827\");\n        doc.text(formatCurrency(invoice.amount), 450, currentY + 13, { width: 95, align: \"right\" });\n        \n        currentY += rowHeight;\n      }\n      \n      // ===== SUMMARY SECTION =====\n      currentY += rowHeight + 20;\n      \n      // Subtotal\n      doc.fontSize(10).font(\"Helvetica\").fillColor(\"#6B7280\");\n      doc.text(\"Subtotal:\", 350, currentY);\n      doc.font(\"Helvetica\").fillColor(\"#374151\");\n      doc.text(formatCurrency(invoice.amount), 450, currentY, { width: 95, align: \"right\" });\n      \n      currentY += 25;\n      \n      // Total Amount Due - Highlighted (draw background first, then text)\n      const totalBoxX = 310;\n      const totalBoxWidth = 245;\n      const totalBoxRight = totalBoxX + totalBoxWidth;\n      \n      doc.save();\n      doc.rect(totalBoxX, currentY - 5, totalBoxWidth, 40).fillAndStroke(\"#F3F4F6\", \"#E5E7EB\");\n      doc.restore();\n      \n      doc.fontSize(13).font(\"Helvetica-Bold\").fillColor(\"#111827\");\n      doc.text(\"Total Amount Due:\", totalBoxX + 10, currentY + 8);\n      doc.fontSize(16).fillColor(\"#C8102E\");\n      doc.text(formatCurrency(invoice.amount), totalBoxRight - 105, currentY + 6, { width: 95, align: \"right\" });\n      \n      // ===== NOTES SECTION =====\n      if (invoice.notes) {\n        currentY += 70;\n        const notesBoxHeight = Math.min(invoice.notes.length / 2 + 60, 150);\n        \n        doc.save();\n        doc.rect(40, currentY, 515, notesBoxHeight).stroke(\"#E5E7EB\");\n        doc.rect(40, currentY, 515, 25).fillAndStroke(\"#F3F4F6\", \"#E5E7EB\");\n        doc.restore();\n        \n        doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#374151\");\n        doc.text(\"Notes\", 50, currentY + 7);\n        \n        doc.fontSize(10).font(\"Helvetica\").fillColor(\"#6B7280\");\n        doc.text(invoice.notes, 50, currentY + 35, { width: 495, align: \"left\" });\n      }\n      \n      // ===== FOOTER =====\n      const footerY = 720;\n      doc.save();\n      doc.rect(0, footerY, 595, 100).fill(\"#F8F9FA\");\n      doc.restore();\n      \n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(\"#C8102E\");\n      doc.text(\"Thank you for your business!\", 0, footerY + 20, { width: 595, align: \"center\" });\n      \n      doc.fontSize(8).font(\"Helvetica\").fillColor(\"#6B7280\");\n      doc.text(\"MaxTech BD\", 0, footerY + 40, { width: 595, align: \"center\" });\n      doc.text(\"522, SK Mujib Road (4th Floor), Agrabad, Double Mooring, Chattogram, Bangladesh\", 0, footerY + 52, { width: 595, align: \"center\" });\n      doc.text(\"Phone: +8801843180008 | Email: info@maxtechbd.com\", 0, footerY + 64, { width: 595, align: \"center\" });\n      \n      // Finalize the PDF\n      doc.end();\n    } catch (error: any) {\n      console.error(\"PDF generation error:\", error);\n      res.status(500).json({ error: \"Failed to generate PDF\" });\n    }\n  });\n\n  // P&L PDF Export\n  app.get(\"/api/profit-loss/export-pdf\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export P&L\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n      const category = (req.query.category as string) || \"all\";\n\n      if (!month || !year) {\n        return res.status(400).json({ error: \"Month and year are required\" });\n      }\n\n      const months = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n\n      // Calculate date range\n      const startDate = new Date(year, month - 1, 1);\n      const endDate = new Date(year, month, 0);\n\n      // Fetch data\n      const allIncomes = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n      const allPayrolls = await db.select().from(payroll);\n\n      // Filter by date\n      let periodIncomes = allIncomes.filter(inc => {\n        const itemDate = new Date(inc.date);\n        return itemDate >= startDate && itemDate <= endDate;\n      });\n\n      let periodExpenses = allExpenses.filter(exp => {\n        const itemDate = new Date(exp.date);\n        return itemDate >= startDate && itemDate <= endDate;\n      });\n\n      let periodPayrolls = allPayrolls.filter(\n        p => p.status === \"paid\" && p.month === month && p.year === year\n      );\n\n      // Apply category filter\n      if (category !== \"all\") {\n        periodIncomes = periodIncomes.filter(inc => inc.category === category);\n        periodExpenses = periodExpenses.filter(exp => exp.category === category);\n        periodPayrolls = [];\n      }\n\n      // Calculate totals using Decimal.js for precision\n      // Group by category (keep as string arrays for Decimal precision)\n      const incomeGrouped = periodIncomes.reduce((acc, inc) => {\n        if (!acc[inc.category]) acc[inc.category] = [];\n        acc[inc.category].push(inc.amount);\n        return acc;\n      }, {} as Record<string, string[]>);\n\n      const expenseGrouped = periodExpenses.reduce((acc, exp) => {\n        if (!acc[exp.category]) acc[exp.category] = [];\n        acc[exp.category].push(exp.amount);\n        return acc;\n      }, {} as Record<string, string[]>);\n\n      // Calculate category totals using Decimal.js\n      const incomeByCategory: Record<string, number> = {};\n      Object.entries(incomeGrouped).forEach(([cat, amounts]) => {\n        incomeByCategory[cat] = Number(sumAmounts(amounts));\n      });\n\n      const expenseByCategory: Record<string, number> = {};\n      Object.entries(expenseGrouped).forEach(([cat, amounts]) => {\n        expenseByCategory[cat] = Number(sumAmounts(amounts));\n      });\n\n      const totalIncome = Number(sumAmounts(periodIncomes.map(inc => inc.amount)));\n      const totalExpenses = Number(sumAmounts(periodExpenses.map(exp => exp.amount)));\n      const totalPayroll = Number(sumAmounts(periodPayrolls.map(p => p.netSalary)));\n      const totalCosts = totalExpenses + totalPayroll;\n      const grossProfit = totalIncome - totalCosts;\n      const profitMargin = ((grossProfit / (totalIncome || 1)) * 100);\n\n      // Generate PDF using shared template\n      const doc = new PDFDocument({ margin: 40, size: 'A4', bufferPages: true });\n\n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      const categoryLabel = category !== \"all\" ? `-${category}` : \"\";\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"P&L-${months[month-1]}-${year}${categoryLabel}.pdf\"`);\n\n      doc.pipe(res);\n\n      // Add branded header\n      const subtitle = category !== \"all\" \n        ? `${months[month-1]} ${year} - Category: ${category}`\n        : `${months[month-1]} ${year}`;\n      \n      let currentY = addReportHeader({\n        doc,\n        title: \"Profit & Loss Statement\",\n        subtitle,\n        includeDate: true\n      });\n\n      currentY += 10;\n\n      // Revenue Section\n      doc.fontSize(14).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n      doc.text(\"REVENUE\", 40, currentY);\n      currentY += 25;\n\n      currentY = createTableHeader(doc, currentY, [\n        { label: \"Category\", width: 350, align: \"left\" },\n        { label: \"Amount\", width: 165, align: \"right\" }\n      ]);\n\n      let rowIndex = 0;\n      Object.entries(incomeByCategory).forEach(([cat, amount]) => {\n        currentY = createTableRow(doc, currentY, [\n          { text: cat, width: 350, align: \"left\" },\n          { text: formatCurrency(amount), width: 165, align: \"right\" }\n        ], rowIndex % 2 === 0);\n        rowIndex++;\n      });\n\n      if (Object.keys(incomeByCategory).length === 0) {\n        currentY = createTableRow(doc, currentY, [\n          { text: \"No income recorded\", width: 350, align: \"left\" },\n          { text: formatCurrency(0), width: 165, align: \"right\" }\n        ], true);\n      }\n\n      // Total Revenue\n      currentY = createTableRow(doc, currentY, [\n        { text: \"Total Revenue\", width: 350, align: \"left\", bold: true },\n        { text: formatCurrency(totalIncome), width: 165, align: \"right\", bold: true }\n      ], false);\n\n      currentY += 20;\n\n      // Operating Expenses Section\n      doc.fontSize(14).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n      doc.text(\"OPERATING EXPENSES\", 40, currentY);\n      currentY += 25;\n\n      currentY = createTableHeader(doc, currentY, [\n        { label: \"Category\", width: 350, align: \"left\" },\n        { label: \"Amount\", width: 165, align: \"right\" }\n      ]);\n\n      rowIndex = 0;\n      Object.entries(expenseByCategory).forEach(([cat, amount]) => {\n        currentY = createTableRow(doc, currentY, [\n          { text: cat, width: 350, align: \"left\" },\n          { text: formatCurrency(amount), width: 165, align: \"right\" }\n        ], rowIndex % 2 === 0);\n        rowIndex++;\n      });\n\n      if (Object.keys(expenseByCategory).length === 0) {\n        currentY = createTableRow(doc, currentY, [\n          { text: \"No expenses recorded\", width: 350, align: \"left\" },\n          { text: formatCurrency(0), width: 165, align: \"right\" }\n        ], true);\n      }\n\n      // Total Operating Expenses\n      currentY = createTableRow(doc, currentY, [\n        { text: \"Total Operating Expenses\", width: 350, align: \"left\", bold: true },\n        { text: formatCurrency(totalExpenses), width: 165, align: \"right\", bold: true }\n      ], false);\n\n      currentY += 20;\n\n      // Payroll Section\n      doc.fontSize(14).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n      doc.text(\"PAYROLL EXPENSES\", 40, currentY);\n      currentY += 25;\n\n      currentY = createTableHeader(doc, currentY, [\n        { label: \"Description\", width: 350, align: \"left\" },\n        { label: \"Amount\", width: 165, align: \"right\" }\n      ]);\n\n      currentY = createTableRow(doc, currentY, [\n        { text: `Employee Salaries (${periodPayrolls.length} payments)`, width: 350, align: \"left\" },\n        { text: formatCurrency(totalPayroll), width: 165, align: \"right\" }\n      ], true);\n\n      currentY = createTableRow(doc, currentY, [\n        { text: \"Total Costs\", width: 350, align: \"left\", bold: true },\n        { text: formatCurrency(totalCosts), width: 165, align: \"right\", bold: true }\n      ], false);\n\n      currentY += 30;\n\n      // Net Profit/Loss Summary\n      currentY = addSummarySection(doc, currentY, [\n        { label: \"Total Revenue\", value: formatCurrency(totalIncome) },\n        { label: \"Total Costs\", value: formatCurrency(totalCosts) },\n        { label: \"Net Profit/Loss\", value: `${grossProfit >= 0 ? '' : '-'}${formatCurrency(Math.abs(grossProfit))}`, highlight: true },\n        { label: \"Profit Margin\", value: `${profitMargin.toFixed(2)}%` }\n      ]);\n\n      // Add footer\n      addReportFooter(doc);\n\n      doc.end();\n    } catch (error: any) {\n      console.error(\"P&L PDF export error:\", error);\n      res.status(500).json({ error: \"Failed to export PDF\" });\n    }\n  });\n\n  // P&L Excel Export\n  app.get(\"/api/profit-loss/export-excel\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export P&L\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n      const category = (req.query.category as string) || \"all\";\n\n      if (!month || !year) {\n        return res.status(400).json({ error: \"Month and year are required\" });\n      }\n\n      const months = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n\n      // Calculate date range\n      const startDate = new Date(year, month - 1, 1);\n      const endDate = new Date(year, month, 0);\n\n      // Fetch data\n      const allIncomes = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n      const allPayrolls = await db.select().from(payroll);\n\n      // Filter by date\n      let periodIncomes = allIncomes.filter(inc => {\n        const itemDate = new Date(inc.date);\n        return itemDate >= startDate && itemDate <= endDate;\n      });\n\n      let periodExpenses = allExpenses.filter(exp => {\n        const itemDate = new Date(exp.date);\n        return itemDate >= startDate && itemDate <= endDate;\n      });\n\n      let periodPayrolls = allPayrolls.filter(\n        p => p.status === \"paid\" && p.month === month && p.year === year\n      );\n\n      // Apply category filter\n      if (category !== \"all\") {\n        periodIncomes = periodIncomes.filter(inc => inc.category === category);\n        periodExpenses = periodExpenses.filter(exp => exp.category === category);\n        periodPayrolls = [];\n      }\n\n      // Calculate totals using Decimal.js for precision\n      // Group by category (keep as string arrays for Decimal precision)\n      const incomeGrouped = periodIncomes.reduce((acc, inc) => {\n        if (!acc[inc.category]) acc[inc.category] = [];\n        acc[inc.category].push(inc.amount);\n        return acc;\n      }, {} as Record<string, string[]>);\n\n      const expenseGrouped = periodExpenses.reduce((acc, exp) => {\n        if (!acc[exp.category]) acc[exp.category] = [];\n        acc[exp.category].push(exp.amount);\n        return acc;\n      }, {} as Record<string, string[]>);\n\n      // Calculate category totals using Decimal.js\n      const incomeByCategory: Record<string, number> = {};\n      Object.entries(incomeGrouped).forEach(([cat, amounts]) => {\n        incomeByCategory[cat] = Number(sumAmounts(amounts));\n      });\n\n      const expenseByCategory: Record<string, number> = {};\n      Object.entries(expenseGrouped).forEach(([cat, amounts]) => {\n        expenseByCategory[cat] = Number(sumAmounts(amounts));\n      });\n\n      const totalIncome = Number(sumAmounts(periodIncomes.map(inc => inc.amount)));\n      const totalExpenses = Number(sumAmounts(periodExpenses.map(exp => exp.amount)));\n      const totalPayroll = Number(sumAmounts(periodPayrolls.map(p => p.netSalary)));\n      const totalCosts = totalExpenses + totalPayroll;\n      const grossProfit = totalIncome - totalCosts;\n      const profitMargin = ((grossProfit / (totalIncome || 1)) * 100);\n\n      // Create Excel workbook\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Profit & Loss\");\n\n      // Set column widths\n      worksheet.columns = [\n        { width: 40 },\n        { width: 20 }\n      ];\n\n      // Add company header with branding\n      worksheet.mergeCells('A1:B1');\n      const titleRow = worksheet.getCell('A1');\n      titleRow.value = COMPANY_INFO.name;\n      titleRow.font = { size: 16, bold: true, color: { argb: 'FFE11D26' } };\n      titleRow.alignment = { horizontal: 'center', vertical: 'middle' };\n\n      worksheet.mergeCells('A2:B2');\n      const addressRow1 = worksheet.getCell('A2');\n      addressRow1.value = COMPANY_INFO.address1;\n      addressRow1.font = { size: 10 };\n      addressRow1.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A3:B3');\n      const addressRow2 = worksheet.getCell('A3');\n      addressRow2.value = `${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`;\n      addressRow2.font = { size: 10 };\n      addressRow2.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A4:B4');\n      const contactRow = worksheet.getCell('A4');\n      contactRow.value = `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`;\n      contactRow.font = { size: 10 };\n      contactRow.alignment = { horizontal: 'center' };\n\n      // Add report title\n      worksheet.addRow([]);\n      worksheet.mergeCells('A6:B6');\n      const reportTitle = worksheet.getCell('A6');\n      reportTitle.value = \"Profit & Loss Statement\";\n      reportTitle.font = { size: 18, bold: true };\n      reportTitle.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A7:B7');\n      const subtitle = worksheet.getCell('A7');\n      subtitle.value = category !== \"all\" \n        ? `${months[month-1]} ${year} - Category: ${category}`\n        : `${months[month-1]} ${year}`;\n      subtitle.font = { size: 12 };\n      subtitle.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A8:B8');\n      const dateRow = worksheet.getCell('A8');\n      dateRow.value = `Generated on: ${new Date().toLocaleString()}`;\n      dateRow.font = { size: 10, italic: true };\n      dateRow.alignment = { horizontal: 'center' };\n\n      let currentRow = 10;\n\n      // Revenue Section\n      worksheet.getCell(`A${currentRow}`).value = \"REVENUE\";\n      worksheet.getCell(`A${currentRow}`).font = { size: 14, bold: true, color: { argb: 'FFE11D26' } };\n      currentRow += 2;\n\n      // Revenue header\n      const revenueHeaderRow = worksheet.getRow(currentRow);\n      revenueHeaderRow.values = [\"Category\", \"Amount\"];\n      revenueHeaderRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      revenueHeaderRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE11D26' } };\n      revenueHeaderRow.alignment = { horizontal: 'left', vertical: 'middle' };\n      currentRow++;\n\n      // Revenue items\n      Object.entries(incomeByCategory).forEach(([cat, amount]) => {\n        const row = worksheet.getRow(currentRow);\n        row.values = [cat, formatCurrency(amount)];\n        row.alignment = { horizontal: 'left', vertical: 'middle' };\n        currentRow++;\n      });\n\n      if (Object.keys(incomeByCategory).length === 0) {\n        worksheet.getRow(currentRow).values = [\"No income recorded\", formatCurrency(0)];\n        currentRow++;\n      }\n\n      // Total Revenue\n      const totalRevenueRow = worksheet.getRow(currentRow);\n      totalRevenueRow.values = [\"Total Revenue\", formatCurrency(totalIncome)];\n      totalRevenueRow.font = { bold: true };\n      totalRevenueRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };\n      currentRow += 2;\n\n      // Operating Expenses Section\n      worksheet.getCell(`A${currentRow}`).value = \"OPERATING EXPENSES\";\n      worksheet.getCell(`A${currentRow}`).font = { size: 14, bold: true, color: { argb: 'FFE11D26' } };\n      currentRow += 2;\n\n      // Expenses header\n      const expenseHeaderRow = worksheet.getRow(currentRow);\n      expenseHeaderRow.values = [\"Category\", \"Amount\"];\n      expenseHeaderRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      expenseHeaderRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE11D26' } };\n      expenseHeaderRow.alignment = { horizontal: 'left', vertical: 'middle' };\n      currentRow++;\n\n      // Expense items\n      Object.entries(expenseByCategory).forEach(([cat, amount]) => {\n        const row = worksheet.getRow(currentRow);\n        row.values = [cat, formatCurrency(amount)];\n        row.alignment = { horizontal: 'left', vertical: 'middle' };\n        currentRow++;\n      });\n\n      if (Object.keys(expenseByCategory).length === 0) {\n        worksheet.getRow(currentRow).values = [\"No expenses recorded\", formatCurrency(0)];\n        currentRow++;\n      }\n\n      // Total Operating Expenses\n      const totalExpensesRow = worksheet.getRow(currentRow);\n      totalExpensesRow.values = [\"Total Operating Expenses\", formatCurrency(totalExpenses)];\n      totalExpensesRow.font = { bold: true };\n      totalExpensesRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };\n      currentRow += 2;\n\n      // Payroll Section\n      worksheet.getCell(`A${currentRow}`).value = \"PAYROLL EXPENSES\";\n      worksheet.getCell(`A${currentRow}`).font = { size: 14, bold: true, color: { argb: 'FFE11D26' } };\n      currentRow += 2;\n\n      // Payroll header\n      const payrollHeaderRow = worksheet.getRow(currentRow);\n      payrollHeaderRow.values = [\"Description\", \"Amount\"];\n      payrollHeaderRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      payrollHeaderRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE11D26' } };\n      payrollHeaderRow.alignment = { horizontal: 'left', vertical: 'middle' };\n      currentRow++;\n\n      // Payroll item\n      const payrollRow = worksheet.getRow(currentRow);\n      payrollRow.values = [`Employee Salaries (${periodPayrolls.length} payments)`, formatCurrency(totalPayroll)];\n      payrollRow.alignment = { horizontal: 'left', vertical: 'middle' };\n      currentRow++;\n\n      // Total Costs\n      const totalCostsRow = worksheet.getRow(currentRow);\n      totalCostsRow.values = [\"Total Costs\", formatCurrency(totalCosts)];\n      totalCostsRow.font = { bold: true };\n      totalCostsRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };\n      currentRow += 2;\n\n      // Summary Section\n      currentRow++;\n      const summaryRow1 = worksheet.getRow(currentRow);\n      summaryRow1.values = [\"Total Revenue\", formatCurrency(totalIncome)];\n      summaryRow1.font = { size: 11 };\n      currentRow++;\n\n      const summaryRow2 = worksheet.getRow(currentRow);\n      summaryRow2.values = [\"Total Costs\", formatCurrency(totalCosts)];\n      summaryRow2.font = { size: 11 };\n      currentRow++;\n\n      const profitRow = worksheet.getRow(currentRow);\n      profitRow.values = [\"Net Profit/Loss\", `${grossProfit >= 0 ? '' : '-'}${formatCurrency(Math.abs(grossProfit))}`];\n      profitRow.font = { size: 12, bold: true, color: { argb: grossProfit >= 0 ? 'FF10B981' : 'FFEF4444' } };\n      currentRow++;\n\n      const marginRow = worksheet.getRow(currentRow);\n      marginRow.values = [\"Profit Margin\", `${profitMargin.toFixed(2)}%`];\n      marginRow.font = { size: 11 };\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      const categoryLabel = category !== \"all\" ? `-${category}` : \"\";\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"P&L-${months[month-1]}-${year}${categoryLabel}.xlsx\"`);\n\n      // Write to response\n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error: any) {\n      console.error(\"P&L Excel export error:\", error);\n      res.status(500).json({ error: \"Failed to export Excel\" });\n    }\n  });\n\n  // P&L Word Export\n  app.get(\"/api/profit-loss/export-word\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export P&L\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n      const category = (req.query.category as string) || \"all\";\n\n      if (!month || !year) {\n        return res.status(400).json({ error: \"Month and year are required\" });\n      }\n\n      const months = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n\n      // Calculate date range\n      const startDate = new Date(year, month - 1, 1);\n      const endDate = new Date(year, month, 0);\n\n      // Fetch data\n      const allIncomes = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n      const allPayrolls = await db.select().from(payroll);\n\n      // Filter by date\n      let periodIncomes = allIncomes.filter(inc => {\n        const itemDate = new Date(inc.date);\n        return itemDate >= startDate && itemDate <= endDate;\n      });\n\n      let periodExpenses = allExpenses.filter(exp => {\n        const itemDate = new Date(exp.date);\n        return itemDate >= startDate && itemDate <= endDate;\n      });\n\n      let periodPayrolls = allPayrolls.filter(\n        p => p.status === \"paid\" && p.month === month && p.year === year\n      );\n\n      // Apply category filter\n      if (category !== \"all\") {\n        periodIncomes = periodIncomes.filter(inc => inc.category === category);\n        periodExpenses = periodExpenses.filter(exp => exp.category === category);\n        periodPayrolls = [];\n      }\n\n      // Calculate totals using Decimal.js for precision\n      // Group by category (keep as string arrays for Decimal precision)\n      const incomeGrouped = periodIncomes.reduce((acc, inc) => {\n        if (!acc[inc.category]) acc[inc.category] = [];\n        acc[inc.category].push(inc.amount);\n        return acc;\n      }, {} as Record<string, string[]>);\n\n      const expenseGrouped = periodExpenses.reduce((acc, exp) => {\n        if (!acc[exp.category]) acc[exp.category] = [];\n        acc[exp.category].push(exp.amount);\n        return acc;\n      }, {} as Record<string, string[]>);\n\n      // Calculate category totals using Decimal.js\n      const incomeByCategory: Record<string, number> = {};\n      Object.entries(incomeGrouped).forEach(([cat, amounts]) => {\n        incomeByCategory[cat] = Number(sumAmounts(amounts));\n      });\n\n      const expenseByCategory: Record<string, number> = {};\n      Object.entries(expenseGrouped).forEach(([cat, amounts]) => {\n        expenseByCategory[cat] = Number(sumAmounts(amounts));\n      });\n\n      const totalIncome = Number(sumAmounts(periodIncomes.map(inc => inc.amount)));\n      const totalExpenses = Number(sumAmounts(periodExpenses.map(exp => exp.amount)));\n      const totalPayroll = Number(sumAmounts(periodPayrolls.map(p => p.netSalary)));\n      const totalCosts = totalExpenses + totalPayroll;\n      const grossProfit = totalIncome - totalCosts;\n      const profitMargin = ((grossProfit / (totalIncome || 1)) * 100);\n\n      // Create Word document\n      const doc = new Document({\n        sections: [{\n          properties: {},\n          children: [\n            // Company Header\n            new Paragraph({\n              children: [new TextRun({ text: COMPANY_INFO.name, bold: true, size: 32, color: \"E11D26\" })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: COMPANY_INFO.address1,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n            \n            // Report Title\n            new Paragraph({\n              text: \"Profit & Loss Statement\",\n              heading: HeadingLevel.HEADING_1,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: category !== \"all\" \n                ? `${months[month-1]} ${year} - Category: ${category}`\n                : `${months[month-1]} ${year}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [new TextRun({ text: `Generated on: ${new Date().toLocaleString()}`, italics: true })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n\n            // Revenue Section\n            new Paragraph({\n              children: [new TextRun({ text: \"REVENUE\", bold: true, size: 24, color: \"E11D26\" })],\n              spacing: { before: 200, after: 200 }\n            }),\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                // Header\n                new TableRow({\n                  children: [\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Category\", bold: true })] })],\n                      width: { size: 70, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Amount\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 30, type: WidthType.PERCENTAGE }\n                    })\n                  ]\n                }),\n                // Revenue items\n                ...Object.entries(incomeByCategory).map(([cat, amount]) =>\n                  new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph(cat)] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(amount), alignment: AlignmentType.RIGHT })] })\n                    ]\n                  })\n                ),\n                // Total Revenue\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Total Revenue\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: formatCurrency(totalIncome), bold: true })], alignment: AlignmentType.RIGHT })] })\n                  ]\n                })\n              ]\n            }),\n\n            // Operating Expenses Section\n            new Paragraph({\n              children: [new TextRun({ text: \"OPERATING EXPENSES\", bold: true, size: 24, color: \"E11D26\" })],\n              spacing: { before: 400, after: 200 }\n            }),\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                // Header\n                new TableRow({\n                  children: [\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Category\", bold: true })] })],\n                      width: { size: 70, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Amount\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 30, type: WidthType.PERCENTAGE }\n                    })\n                  ]\n                }),\n                // Expense items\n                ...Object.entries(expenseByCategory).map(([cat, amount]) =>\n                  new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph(cat)] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(amount), alignment: AlignmentType.RIGHT })] })\n                    ]\n                  })\n                ),\n                // Total Expenses\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Total Operating Expenses\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: formatCurrency(totalExpenses), bold: true })], alignment: AlignmentType.RIGHT })] })\n                  ]\n                })\n              ]\n            }),\n\n            // Payroll Section\n            new Paragraph({\n              children: [new TextRun({ text: \"PAYROLL EXPENSES\", bold: true, size: 24, color: \"E11D26\" })],\n              spacing: { before: 400, after: 200 }\n            }),\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                new TableRow({\n                  children: [\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Description\", bold: true })] })],\n                      width: { size: 70, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Amount\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 30, type: WidthType.PERCENTAGE }\n                    })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph(`Employee Salaries (${periodPayrolls.length} payments)`)] }),\n                    new TableCell({ children: [new Paragraph({ text: formatCurrency(totalPayroll), alignment: AlignmentType.RIGHT })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Total Costs\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: formatCurrency(totalCosts), bold: true })], alignment: AlignmentType.RIGHT })] })\n                  ]\n                })\n              ]\n            }),\n\n            // Summary\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 400 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Total Revenue: \", bold: true }),\n                new TextRun(formatCurrency(totalIncome))\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Total Costs: \", bold: true }),\n                new TextRun(formatCurrency(totalCosts))\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Net Profit/Loss: \", bold: true, size: 28 }),\n                new TextRun({ \n                  text: `${grossProfit >= 0 ? '' : '-'}${formatCurrency(Math.abs(grossProfit))}`,\n                  bold: true,\n                  size: 28,\n                  color: grossProfit >= 0 ? \"10B981\" : \"EF4444\"\n                })\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Profit Margin: \", bold: true }),\n                new TextRun(`${profitMargin.toFixed(2)}%`)\n              ]\n            }),\n\n            // Footer\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 600 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.name} | ${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER\n            })\n          ]\n        }]\n      });\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      const categoryLabel = category !== \"all\" ? `-${category}` : \"\";\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"P&L-${months[month-1]}-${year}${categoryLabel}.docx\"`);\n\n      // Write to response using Packer\n      const { Packer } = await import(\"docx\");\n      const buffer = await Packer.toBuffer(doc);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"P&L Word export error:\", error);\n      res.status(500).json({ error: \"Failed to export Word document\" });\n    }\n  });\n\n  // === GENERAL LEDGER EXPORTS ===\n\n  // General Ledger PDF Export\n  app.get(\"/api/general-ledger/export-pdf\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export General Ledger\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Fetch all data\n      const allIncomes = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n      const allPayrolls = await db.select().from(payroll);\n\n      // Create ledger entries\n      type LedgerEntry = {\n        date: string;\n        type: \"income\" | \"expense\" | \"payroll\";\n        description: string;\n        category: string;\n        debit: string;\n        credit: string;\n      };\n\n      const ledgerEntries: LedgerEntry[] = [];\n\n      // Income entries (debits)\n      allIncomes.forEach(inc => {\n        ledgerEntries.push({\n          date: typeof inc.date === 'string' ? inc.date : inc.date.toISOString(),\n          type: \"income\",\n          description: inc.source,\n          category: inc.category,\n          debit: inc.amount,\n          credit: \"0\",\n        });\n      });\n\n      // Expense entries (credits)\n      allExpenses.forEach(exp => {\n        ledgerEntries.push({\n          date: typeof exp.date === 'string' ? exp.date : exp.date.toISOString(),\n          type: \"expense\",\n          description: exp.title,\n          category: exp.category,\n          debit: \"0\",\n          credit: exp.amount,\n        });\n      });\n\n      // Payroll entries (credits)\n      allPayrolls.filter(p => p.status === \"paid\").forEach(pay => {\n        ledgerEntries.push({\n          date: new Date(pay.year, pay.month - 1, 1).toISOString(),\n          type: \"payroll\",\n          description: `Payroll ${pay.month}/${pay.year}`,\n          category: \"Payroll\",\n          debit: \"0\",\n          credit: pay.netSalary,\n        });\n      });\n\n      // Sort by date (oldest first for chronological balance calculation)\n      ledgerEntries.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());\n\n      // Calculate running balance using Decimal.js\n      let runningBalance = new Decimal(0);\n      const entriesWithBalance = ledgerEntries.map(entry => {\n        const debitAmount = new Decimal(entry.debit);\n        const creditAmount = new Decimal(entry.credit);\n        runningBalance = runningBalance.plus(debitAmount).minus(creditAmount);\n        return {\n          ...entry,\n          balance: runningBalance.toFixed(2)\n        };\n      });\n\n      // Calculate totals using Decimal.js (keep as strings for precision)\n      const totalDebits = sumAmounts(entriesWithBalance.map(e => e.debit));\n      const totalCredits = sumAmounts(entriesWithBalance.map(e => e.credit));\n      const finalBalance = new Decimal(totalDebits).minus(totalCredits).toFixed(2);\n      const finalBalanceNum = parseFloat(finalBalance);\n\n      // Generate PDF using shared template\n      const doc = new PDFDocument({ margin: 40, size: 'A4', bufferPages: true });\n\n      // Add header\n      let currentY = addReportHeader({\n        doc,\n        title: \"General Ledger\",\n        subtitle: `Complete Transaction History`,\n        includeDate: true\n      });\n\n      currentY += 10;\n\n      // Table header\n      currentY = createTableHeader(doc, currentY, [\n        { label: \"Date\", width: 80, align: \"left\" },\n        { label: \"Description\", width: 150, align: \"left\" },\n        { label: \"Category\", width: 80, align: \"left\" },\n        { label: \"Debit\", width: 75, align: \"right\" },\n        { label: \"Credit\", width: 75, align: \"right\" },\n        { label: \"Balance\", width: 75, align: \"right\" }\n      ]);\n\n      // Table rows\n      let isEven = false;\n      entriesWithBalance.forEach((entry, index) => {\n        // Check if we need a new page\n        if (currentY > 700) {\n          addReportFooter(doc);\n          doc.addPage();\n          currentY = 40;\n        }\n\n        currentY = createTableRow(doc, currentY, [\n          { text: format(new Date(entry.date), 'dd/MM/yyyy'), width: 80, align: \"left\" },\n          { text: entry.description, width: 150, align: \"left\" },\n          { text: entry.category, width: 80, align: \"left\" },\n          { text: entry.debit !== \"0\" ? formatCurrency(entry.debit) : \"-\", width: 75, align: \"right\" },\n          { text: entry.credit !== \"0\" ? formatCurrency(entry.credit) : \"-\", width: 75, align: \"right\" },\n          { text: formatCurrency(entry.balance), width: 75, align: \"right\", bold: true }\n        ], isEven);\n\n        isEven = !isEven;\n      });\n\n      // Summary Section\n      currentY += 20;\n      currentY = addSummarySection(doc, currentY, [\n        { label: \"Total Debits\", value: formatCurrency(totalDebits) },\n        { label: \"Total Credits\", value: formatCurrency(totalCredits) },\n        { label: \"Final Balance\", value: `${finalBalanceNum >= 0 ? '' : '-'}${formatCurrency(Math.abs(finalBalanceNum))}`, highlight: true }\n      ]);\n\n      // Add footer\n      addReportFooter(doc);\n\n      // Stream to response\n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", \"attachment; filename=General-Ledger.pdf\");\n\n      doc.pipe(res);\n      doc.end();\n    } catch (error: any) {\n      console.error(\"General Ledger PDF export error:\", error);\n      res.status(500).json({ error: \"Failed to export PDF\" });\n    }\n  });\n\n  // General Ledger Excel Export\n  app.get(\"/api/general-ledger/export-excel\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export General Ledger\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Fetch all data\n      const allIncomes = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n      const allPayrolls = await db.select().from(payroll);\n\n      // Create ledger entries\n      type LedgerEntry = {\n        date: string;\n        type: \"income\" | \"expense\" | \"payroll\";\n        description: string;\n        category: string;\n        debit: string;\n        credit: string;\n      };\n\n      const ledgerEntries: LedgerEntry[] = [];\n\n      // Income entries (debits)\n      allIncomes.forEach(inc => {\n        ledgerEntries.push({\n          date: typeof inc.date === 'string' ? inc.date : inc.date.toISOString(),\n          type: \"income\",\n          description: inc.source,\n          category: inc.category,\n          debit: inc.amount,\n          credit: \"0\",\n        });\n      });\n\n      // Expense entries (credits)\n      allExpenses.forEach(exp => {\n        ledgerEntries.push({\n          date: typeof exp.date === 'string' ? exp.date : exp.date.toISOString(),\n          type: \"expense\",\n          description: exp.title,\n          category: exp.category,\n          debit: \"0\",\n          credit: exp.amount,\n        });\n      });\n\n      // Payroll entries (credits)\n      allPayrolls.filter(p => p.status === \"paid\").forEach(pay => {\n        ledgerEntries.push({\n          date: new Date(pay.year, pay.month - 1, 1).toISOString(),\n          type: \"payroll\",\n          description: `Payroll ${pay.month}/${pay.year}`,\n          category: \"Payroll\",\n          debit: \"0\",\n          credit: pay.netSalary,\n        });\n      });\n\n      // Sort by date (oldest first for chronological balance calculation)\n      ledgerEntries.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());\n\n      // Calculate running balance using Decimal.js\n      let runningBalance = new Decimal(0);\n      const entriesWithBalance = ledgerEntries.map(entry => {\n        const debitAmount = new Decimal(entry.debit);\n        const creditAmount = new Decimal(entry.credit);\n        runningBalance = runningBalance.plus(debitAmount).minus(creditAmount);\n        return {\n          ...entry,\n          balance: runningBalance.toFixed(2)\n        };\n      });\n\n      // Calculate totals using Decimal.js (keep as strings for precision)\n      const totalDebits = sumAmounts(entriesWithBalance.map(e => e.debit));\n      const totalCredits = sumAmounts(entriesWithBalance.map(e => e.credit));\n      const finalBalance = new Decimal(totalDebits).minus(totalCredits).toFixed(2);\n      const finalBalanceNum = parseFloat(finalBalance);\n\n      // Create Excel workbook\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"General Ledger\");\n\n      // Set column widths\n      worksheet.columns = [\n        { width: 15 },  // Date\n        { width: 35 },  // Description\n        { width: 20 },  // Category\n        { width: 18 },  // Debit\n        { width: 18 },  // Credit\n        { width: 18 }   // Balance\n      ];\n\n      // Add company header with branding\n      worksheet.mergeCells('A1:F1');\n      const titleRow = worksheet.getCell('A1');\n      titleRow.value = COMPANY_INFO.name;\n      titleRow.font = { size: 16, bold: true, color: { argb: 'FFE11D26' } };\n      titleRow.alignment = { horizontal: 'center', vertical: 'middle' };\n\n      worksheet.mergeCells('A2:F2');\n      const addressRow1 = worksheet.getCell('A2');\n      addressRow1.value = COMPANY_INFO.address1;\n      addressRow1.font = { size: 10 };\n      addressRow1.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A3:F3');\n      const addressRow2 = worksheet.getCell('A3');\n      addressRow2.value = `${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`;\n      addressRow2.font = { size: 10 };\n      addressRow2.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A4:F4');\n      const contactRow = worksheet.getCell('A4');\n      contactRow.value = `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`;\n      contactRow.font = { size: 10 };\n      contactRow.alignment = { horizontal: 'center' };\n\n      // Add report title\n      worksheet.addRow([]);\n      worksheet.mergeCells('A6:F6');\n      const reportTitle = worksheet.getCell('A6');\n      reportTitle.value = \"General Ledger\";\n      reportTitle.font = { size: 18, bold: true };\n      reportTitle.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A7:F7');\n      const subtitle = worksheet.getCell('A7');\n      subtitle.value = \"Complete Transaction History\";\n      subtitle.font = { size: 12 };\n      subtitle.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A8:F8');\n      const dateRow = worksheet.getCell('A8');\n      dateRow.value = `Generated on: ${new Date().toLocaleString()}`;\n      dateRow.font = { size: 10, italic: true };\n      dateRow.alignment = { horizontal: 'center' };\n\n      let currentRow = 10;\n\n      // Table header\n      const headerRow = worksheet.getRow(currentRow);\n      headerRow.values = [\"Date\", \"Description\", \"Category\", \"Debit\", \"Credit\", \"Balance\"];\n      headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE11D26' } };\n      headerRow.alignment = { horizontal: 'left', vertical: 'middle' };\n      currentRow++;\n\n      // Add data rows\n      entriesWithBalance.forEach(entry => {\n        const row = worksheet.getRow(currentRow);\n        row.values = [\n          format(new Date(entry.date), 'dd/MM/yyyy'),\n          entry.description,\n          entry.category,\n          entry.debit !== \"0\" ? formatCurrency(entry.debit) : \"-\",\n          entry.credit !== \"0\" ? formatCurrency(entry.credit) : \"-\",\n          formatCurrency(entry.balance)\n        ];\n        row.alignment = { horizontal: 'left', vertical: 'middle' };\n        currentRow++;\n      });\n\n      // Add summary section\n      currentRow += 2;\n      const summaryRow1 = worksheet.getRow(currentRow);\n      summaryRow1.values = [\"\", \"\", \"\", \"\", \"Total Debits\", formatCurrency(totalDebits)];\n      summaryRow1.font = { bold: true };\n      currentRow++;\n\n      const summaryRow2 = worksheet.getRow(currentRow);\n      summaryRow2.values = [\"\", \"\", \"\", \"\", \"Total Credits\", formatCurrency(totalCredits)];\n      summaryRow2.font = { bold: true };\n      currentRow++;\n\n      const summaryRow3 = worksheet.getRow(currentRow);\n      summaryRow3.values = [\"\", \"\", \"\", \"\", \"Final Balance\", `${finalBalanceNum >= 0 ? '' : '-'}${formatCurrency(Math.abs(finalBalanceNum))}`];\n      summaryRow3.font = { size: 12, bold: true, color: { argb: finalBalanceNum >= 0 ? 'FF10B981' : 'FFEF4444' } };\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", \"attachment; filename=General-Ledger.xlsx\");\n\n      // Write to response\n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error: any) {\n      console.error(\"General Ledger Excel export error:\", error);\n      res.status(500).json({ error: \"Failed to export Excel\" });\n    }\n  });\n\n  // General Ledger Word Export\n  app.get(\"/api/general-ledger/export-word\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export General Ledger\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      // Fetch all data\n      const allIncomes = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n      const allPayrolls = await db.select().from(payroll);\n\n      // Create ledger entries\n      type LedgerEntry = {\n        date: string;\n        type: \"income\" | \"expense\" | \"payroll\";\n        description: string;\n        category: string;\n        debit: string;\n        credit: string;\n      };\n\n      const ledgerEntries: LedgerEntry[] = [];\n\n      // Income entries (debits)\n      allIncomes.forEach(inc => {\n        ledgerEntries.push({\n          date: typeof inc.date === 'string' ? inc.date : inc.date.toISOString(),\n          type: \"income\",\n          description: inc.source,\n          category: inc.category,\n          debit: inc.amount,\n          credit: \"0\",\n        });\n      });\n\n      // Expense entries (credits)\n      allExpenses.forEach(exp => {\n        ledgerEntries.push({\n          date: typeof exp.date === 'string' ? exp.date : exp.date.toISOString(),\n          type: \"expense\",\n          description: exp.title,\n          category: exp.category,\n          debit: \"0\",\n          credit: exp.amount,\n        });\n      });\n\n      // Payroll entries (credits)\n      allPayrolls.filter(p => p.status === \"paid\").forEach(pay => {\n        ledgerEntries.push({\n          date: new Date(pay.year, pay.month - 1, 1).toISOString(),\n          type: \"payroll\",\n          description: `Payroll ${pay.month}/${pay.year}`,\n          category: \"Payroll\",\n          debit: \"0\",\n          credit: pay.netSalary,\n        });\n      });\n\n      // Sort by date (oldest first for chronological balance calculation)\n      ledgerEntries.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());\n\n      // Calculate running balance using Decimal.js\n      let runningBalance = new Decimal(0);\n      const entriesWithBalance = ledgerEntries.map(entry => {\n        const debitAmount = new Decimal(entry.debit);\n        const creditAmount = new Decimal(entry.credit);\n        runningBalance = runningBalance.plus(debitAmount).minus(creditAmount);\n        return {\n          ...entry,\n          balance: runningBalance.toFixed(2)\n        };\n      });\n\n      // Calculate totals using Decimal.js (keep as strings for precision)\n      const totalDebits = sumAmounts(entriesWithBalance.map(e => e.debit));\n      const totalCredits = sumAmounts(entriesWithBalance.map(e => e.credit));\n      const finalBalance = new Decimal(totalDebits).minus(totalCredits).toFixed(2);\n      const finalBalanceNum = parseFloat(finalBalance);\n\n      // Create Word document\n      const doc = new Document({\n        sections: [{\n          properties: {},\n          children: [\n            // Company Header\n            new Paragraph({\n              children: [new TextRun({ text: COMPANY_INFO.name, bold: true, size: 32, color: \"E11D26\" })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: COMPANY_INFO.address1,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n            \n            // Report Title\n            new Paragraph({\n              children: [new TextRun({ text: \"General Ledger\", bold: true, size: 28 })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: \"Complete Transaction History\",\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [new TextRun({ text: `Generated on: ${new Date().toLocaleString()}`, italics: true })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n\n            // Ledger Table\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                // Header\n                new TableRow({\n                  children: [\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Date\", bold: true })], alignment: AlignmentType.LEFT })],\n                      width: { size: 12, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Description\", bold: true })], alignment: AlignmentType.LEFT })],\n                      width: { size: 30, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Category\", bold: true })], alignment: AlignmentType.LEFT })],\n                      width: { size: 18, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Debit\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 13, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Credit\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 13, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Balance\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 14, type: WidthType.PERCENTAGE }\n                    })\n                  ]\n                }),\n                // Data rows\n                ...entriesWithBalance.map(entry =>\n                  new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph({ text: format(new Date(entry.date), 'dd/MM/yyyy'), alignment: AlignmentType.LEFT })] }),\n                      new TableCell({ children: [new Paragraph({ text: entry.description, alignment: AlignmentType.LEFT })] }),\n                      new TableCell({ children: [new Paragraph({ text: entry.category, alignment: AlignmentType.LEFT })] }),\n                      new TableCell({ children: [new Paragraph({ text: entry.debit !== \"0\" ? formatCurrency(entry.debit) : \"-\", alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ text: entry.credit !== \"0\" ? formatCurrency(entry.credit) : \"-\", alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: formatCurrency(entry.balance), bold: true })], alignment: AlignmentType.RIGHT })] })\n                    ]\n                  })\n                )\n              ]\n            }),\n\n            // Summary\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 400 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Total Debits: \", bold: true }),\n                new TextRun(formatCurrency(totalDebits))\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Total Credits: \", bold: true }),\n                new TextRun(formatCurrency(totalCredits))\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Final Balance: \", bold: true, size: 28 }),\n                new TextRun({ \n                  text: `${finalBalanceNum >= 0 ? '' : '-'}${formatCurrency(Math.abs(finalBalanceNum))}`,\n                  bold: true,\n                  size: 28,\n                  color: finalBalanceNum >= 0 ? \"10B981\" : \"EF4444\"\n                })\n              ]\n            }),\n\n            // Footer\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 600 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.name} | ${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER\n            })\n          ]\n        }]\n      });\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", \"attachment; filename=General-Ledger.docx\");\n\n      // Write to response using Packer\n      const { Packer } = await import(\"docx\");\n      const buffer = await Packer.toBuffer(doc);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"General Ledger Word export error:\", error);\n      res.status(500).json({ error: \"Failed to export Word document\" });\n    }\n  });\n\n  // Financial Reports PDF Export\n  app.get(\"/api/financial-reports/export-pdf\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export Financial Reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const period = (req.query.period || \"12months\") as \"6months\" | \"12months\";\n      const monthsCount = period === \"6months\" ? 6 : 12;\n\n      // Fetch all data\n      const allIncomes = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n\n      // Calculate monthly data using Decimal.js\n      const now = new Date();\n      type MonthlyData = {\n        month: string;\n        income: string;\n        expenses: string;\n        profit: string;\n      };\n\n      const monthlyData: MonthlyData[] = [];\n      for (let i = monthsCount - 1; i >= 0; i--) {\n        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);\n        const startDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);\n        const endDate = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0, 23, 59, 59);\n\n        const monthIncomes = allIncomes.filter(inc => {\n          const incDate = new Date(typeof inc.date === 'string' ? inc.date : inc.date.toISOString());\n          return incDate >= startDate && incDate <= endDate;\n        });\n\n        const monthExpenses = allExpenses.filter(exp => {\n          const expDate = new Date(typeof exp.date === 'string' ? exp.date : exp.date.toISOString());\n          return expDate >= startDate && expDate <= endDate;\n        });\n\n        const totalIncome = sumAmounts(monthIncomes.map(inc => inc.amount));\n        const totalExpenses = sumAmounts(monthExpenses.map(exp => exp.amount));\n        const profit = new Decimal(totalIncome).minus(totalExpenses).toFixed(2);\n\n        monthlyData.push({\n          month: format(monthDate, 'MMM yyyy'),\n          income: totalIncome,\n          expenses: totalExpenses,\n          profit: profit,\n        });\n      }\n\n      // Calculate totals using Decimal.js\n      const totalIncome = sumAmounts(monthlyData.map(m => m.income));\n      const totalExpenses = sumAmounts(monthlyData.map(m => m.expenses));\n      const totalProfit = new Decimal(totalIncome).minus(totalExpenses).toFixed(2);\n      const totalProfitNum = parseFloat(totalProfit);\n      const avgMonthlyIncome = new Decimal(totalIncome).dividedBy(monthsCount).toFixed(2);\n      const avgMonthlyExpenses = new Decimal(totalExpenses).dividedBy(monthsCount).toFixed(2);\n\n      // Generate PDF using shared template\n      const doc = new PDFDocument({ margin: 40, size: 'A4', bufferPages: true });\n\n      // Add header\n      let currentY = addReportHeader({\n        doc,\n        title: \"Financial Reports\",\n        subtitle: `${period === \"6months\" ? \"Last 6 Months\" : \"Last 12 Months\"} Analysis`,\n        includeDate: true\n      });\n\n      currentY += 10;\n\n      // Summary section\n      currentY = addSummarySection(doc, currentY, [\n        { label: \"Total Income\", value: formatCurrency(totalIncome) },\n        { label: \"Total Expenses\", value: formatCurrency(totalExpenses) },\n        { label: \"Net Profit\", value: `${totalProfitNum >= 0 ? '' : '-'}${formatCurrency(Math.abs(totalProfitNum))}`, highlight: true },\n        { label: \"Avg Monthly Income\", value: formatCurrency(avgMonthlyIncome) },\n        { label: \"Avg Monthly Expenses\", value: formatCurrency(avgMonthlyExpenses) }\n      ]);\n\n      currentY += 20;\n\n      // Table header\n      currentY = createTableHeader(doc, currentY, [\n        { label: \"Month\", width: 120, align: \"left\" },\n        { label: \"Income\", width: 120, align: \"right\" },\n        { label: \"Expenses\", width: 120, align: \"right\" },\n        { label: \"Net Profit/Loss\", width: 120, align: \"right\" }\n      ]);\n\n      // Table rows\n      let isEven = false;\n      monthlyData.forEach((data, index) => {\n        // Check if we need a new page\n        if (currentY > 700) {\n          addReportFooter(doc);\n          doc.addPage();\n          currentY = 40;\n        }\n\n        const profitNum = parseFloat(data.profit);\n        currentY = createTableRow(doc, currentY, [\n          { text: data.month, width: 120, align: \"left\" },\n          { text: formatCurrency(data.income), width: 120, align: \"right\" },\n          { text: formatCurrency(data.expenses), width: 120, align: \"right\" },\n          { text: `${profitNum >= 0 ? '+' : '-'}${formatCurrency(Math.abs(profitNum))}`, width: 120, align: \"right\", bold: true }\n        ], isEven);\n\n        isEven = !isEven;\n      });\n\n      // Add footer\n      addReportFooter(doc);\n\n      // Stream to response\n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", \"attachment; filename=Financial-Reports.pdf\");\n\n      doc.pipe(res);\n      doc.end();\n    } catch (error: any) {\n      console.error(\"Financial Reports PDF export error:\", error);\n      res.status(500).json({ error: \"Failed to export PDF\" });\n    }\n  });\n\n  // Financial Reports Excel Export\n  app.get(\"/api/financial-reports/export-excel\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export Financial Reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const period = (req.query.period || \"12months\") as \"6months\" | \"12months\";\n      const monthsCount = period === \"6months\" ? 6 : 12;\n\n      // Fetch all data\n      const allIncomes = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n\n      // Calculate monthly data using Decimal.js\n      const now = new Date();\n      type MonthlyData = {\n        month: string;\n        income: string;\n        expenses: string;\n        profit: string;\n      };\n\n      const monthlyData: MonthlyData[] = [];\n      for (let i = monthsCount - 1; i >= 0; i--) {\n        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);\n        const startDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);\n        const endDate = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0, 23, 59, 59);\n\n        const monthIncomes = allIncomes.filter(inc => {\n          const incDate = new Date(typeof inc.date === 'string' ? inc.date : inc.date.toISOString());\n          return incDate >= startDate && incDate <= endDate;\n        });\n\n        const monthExpenses = allExpenses.filter(exp => {\n          const expDate = new Date(typeof exp.date === 'string' ? exp.date : exp.date.toISOString());\n          return expDate >= startDate && expDate <= endDate;\n        });\n\n        const totalIncome = sumAmounts(monthIncomes.map(inc => inc.amount));\n        const totalExpenses = sumAmounts(monthExpenses.map(exp => exp.amount));\n        const profit = new Decimal(totalIncome).minus(totalExpenses).toFixed(2);\n\n        monthlyData.push({\n          month: format(monthDate, 'MMM yyyy'),\n          income: totalIncome,\n          expenses: totalExpenses,\n          profit: profit,\n        });\n      }\n\n      // Calculate totals using Decimal.js\n      const totalIncome = sumAmounts(monthlyData.map(m => m.income));\n      const totalExpenses = sumAmounts(monthlyData.map(m => m.expenses));\n      const totalProfit = new Decimal(totalIncome).minus(totalExpenses).toFixed(2);\n      const totalProfitNum = parseFloat(totalProfit);\n      const avgMonthlyIncome = new Decimal(totalIncome).dividedBy(monthsCount).toFixed(2);\n      const avgMonthlyExpenses = new Decimal(totalExpenses).dividedBy(monthsCount).toFixed(2);\n\n      // Create Excel workbook\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Financial Reports\");\n\n      // Set column widths\n      worksheet.columns = [\n        { width: 20 },  // Month\n        { width: 18 },  // Income\n        { width: 18 },  // Expenses\n        { width: 20 }   // Net Profit/Loss\n      ];\n\n      // Add company header with branding\n      worksheet.mergeCells('A1:D1');\n      const titleRow = worksheet.getCell('A1');\n      titleRow.value = COMPANY_INFO.name;\n      titleRow.font = { size: 16, bold: true, color: { argb: 'FFE11D26' } };\n      titleRow.alignment = { horizontal: 'center', vertical: 'middle' };\n\n      worksheet.mergeCells('A2:D2');\n      const addressRow1 = worksheet.getCell('A2');\n      addressRow1.value = COMPANY_INFO.address1;\n      addressRow1.font = { size: 10 };\n      addressRow1.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A3:D3');\n      const addressRow2 = worksheet.getCell('A3');\n      addressRow2.value = `${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`;\n      addressRow2.font = { size: 10 };\n      addressRow2.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A4:D4');\n      const contactRow = worksheet.getCell('A4');\n      contactRow.value = `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`;\n      contactRow.font = { size: 10 };\n      contactRow.alignment = { horizontal: 'center' };\n\n      // Add report title\n      worksheet.addRow([]);\n      worksheet.mergeCells('A6:D6');\n      const reportTitle = worksheet.getCell('A6');\n      reportTitle.value = \"Financial Reports\";\n      reportTitle.font = { size: 18, bold: true };\n      reportTitle.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A7:D7');\n      const subtitle = worksheet.getCell('A7');\n      subtitle.value = `${period === \"6months\" ? \"Last 6 Months\" : \"Last 12 Months\"} Analysis`;\n      subtitle.font = { size: 12 };\n      subtitle.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A8:D8');\n      const dateRow = worksheet.getCell('A8');\n      dateRow.value = `Generated on: ${new Date().toLocaleString()}`;\n      dateRow.font = { size: 10, italic: true };\n      dateRow.alignment = { horizontal: 'center' };\n\n      let currentRow = 10;\n\n      // Summary section\n      const summaryRow1 = worksheet.getRow(currentRow);\n      summaryRow1.values = [\"Total Income\", formatCurrency(totalIncome), \"Avg Monthly Income\", formatCurrency(avgMonthlyIncome)];\n      summaryRow1.font = { bold: true };\n      currentRow++;\n\n      const summaryRow2 = worksheet.getRow(currentRow);\n      summaryRow2.values = [\"Total Expenses\", formatCurrency(totalExpenses), \"Avg Monthly Expenses\", formatCurrency(avgMonthlyExpenses)];\n      summaryRow2.font = { bold: true };\n      currentRow++;\n\n      const summaryRow3 = worksheet.getRow(currentRow);\n      summaryRow3.values = [\"Net Profit\", `${totalProfitNum >= 0 ? '' : '-'}${formatCurrency(Math.abs(totalProfitNum))}`, \"\", \"\"];\n      summaryRow3.font = { size: 12, bold: true, color: { argb: totalProfitNum >= 0 ? 'FF10B981' : 'FFEF4444' } };\n      currentRow += 3;\n\n      // Table header\n      const headerRow = worksheet.getRow(currentRow);\n      headerRow.values = [\"Month\", \"Income\", \"Expenses\", \"Net Profit/Loss\"];\n      headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE11D26' } };\n      headerRow.alignment = { horizontal: 'left', vertical: 'middle' };\n      currentRow++;\n\n      // Add data rows\n      monthlyData.forEach(data => {\n        const row = worksheet.getRow(currentRow);\n        const profitNum = parseFloat(data.profit);\n        row.values = [\n          data.month,\n          formatCurrency(data.income),\n          formatCurrency(data.expenses),\n          `${profitNum >= 0 ? '+' : '-'}${formatCurrency(Math.abs(profitNum))}`\n        ];\n        row.alignment = { horizontal: 'left', vertical: 'middle' };\n        currentRow++;\n      });\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", \"attachment; filename=Financial-Reports.xlsx\");\n\n      // Write to response\n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error: any) {\n      console.error(\"Financial Reports Excel export error:\", error);\n      res.status(500).json({ error: \"Failed to export Excel\" });\n    }\n  });\n\n  // Financial Reports Word Export\n  app.get(\"/api/financial-reports/export-word\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export Financial Reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const period = (req.query.period || \"12months\") as \"6months\" | \"12months\";\n      const monthsCount = period === \"6months\" ? 6 : 12;\n\n      // Fetch all data\n      const allIncomes = await db.select().from(income);\n      const allExpenses = await db.select().from(expenses);\n\n      // Calculate monthly data using Decimal.js\n      const now = new Date();\n      type MonthlyData = {\n        month: string;\n        income: string;\n        expenses: string;\n        profit: string;\n      };\n\n      const monthlyData: MonthlyData[] = [];\n      for (let i = monthsCount - 1; i >= 0; i--) {\n        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);\n        const startDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);\n        const endDate = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0, 23, 59, 59);\n\n        const monthIncomes = allIncomes.filter(inc => {\n          const incDate = new Date(typeof inc.date === 'string' ? inc.date : inc.date.toISOString());\n          return incDate >= startDate && incDate <= endDate;\n        });\n\n        const monthExpenses = allExpenses.filter(exp => {\n          const expDate = new Date(typeof exp.date === 'string' ? exp.date : exp.date.toISOString());\n          return expDate >= startDate && expDate <= endDate;\n        });\n\n        const totalIncome = sumAmounts(monthIncomes.map(inc => inc.amount));\n        const totalExpenses = sumAmounts(monthExpenses.map(exp => exp.amount));\n        const profit = new Decimal(totalIncome).minus(totalExpenses).toFixed(2);\n\n        monthlyData.push({\n          month: format(monthDate, 'MMM yyyy'),\n          income: totalIncome,\n          expenses: totalExpenses,\n          profit: profit,\n        });\n      }\n\n      // Calculate totals using Decimal.js\n      const totalIncome = sumAmounts(monthlyData.map(m => m.income));\n      const totalExpenses = sumAmounts(monthlyData.map(m => m.expenses));\n      const totalProfit = new Decimal(totalIncome).minus(totalExpenses).toFixed(2);\n      const totalProfitNum = parseFloat(totalProfit);\n      const avgMonthlyIncome = new Decimal(totalIncome).dividedBy(monthsCount).toFixed(2);\n      const avgMonthlyExpenses = new Decimal(totalExpenses).dividedBy(monthsCount).toFixed(2);\n\n      // Create Word document\n      const doc = new Document({\n        sections: [{\n          properties: {},\n          children: [\n            // Company Header\n            new Paragraph({\n              children: [new TextRun({ text: COMPANY_INFO.name, bold: true, size: 32, color: \"E11D26\" })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: COMPANY_INFO.address1,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n            \n            // Report Title\n            new Paragraph({\n              children: [new TextRun({ text: \"Financial Reports\", bold: true, size: 28, color: \"E11D26\" })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: `${period === \"6months\" ? \"Last 6 Months\" : \"Last 12 Months\"} Analysis`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [new TextRun({ text: `Generated on: ${new Date().toLocaleString()}`, italics: true })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n\n            // Summary\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Total Income: \", bold: true }),\n                new TextRun(formatCurrency(totalIncome))\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Total Expenses: \", bold: true }),\n                new TextRun(formatCurrency(totalExpenses))\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Net Profit: \", bold: true, size: 28 }),\n                new TextRun({ \n                  text: `${totalProfitNum >= 0 ? '' : '-'}${formatCurrency(Math.abs(totalProfitNum))}`,\n                  bold: true,\n                  size: 28,\n                  color: totalProfitNum >= 0 ? \"10B981\" : \"EF4444\"\n                })\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Avg Monthly Income: \", bold: true }),\n                new TextRun(formatCurrency(avgMonthlyIncome))\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Avg Monthly Expenses: \", bold: true }),\n                new TextRun(formatCurrency(avgMonthlyExpenses))\n              ],\n              spacing: { after: 300 }\n            }),\n\n            // Monthly Breakdown Table\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                // Header\n                new TableRow({\n                  children: [\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Month\", bold: true })], alignment: AlignmentType.LEFT })],\n                      width: { size: 25, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Income\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 25, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Expenses\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 25, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Net Profit/Loss\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 25, type: WidthType.PERCENTAGE }\n                    })\n                  ]\n                }),\n                // Data rows\n                ...monthlyData.map(data => {\n                  const profitNum = parseFloat(data.profit);\n                  return new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph({ text: data.month, alignment: AlignmentType.LEFT })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(data.income), alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(data.expenses), alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ \n                        children: [new TextRun({ \n                          text: `${profitNum >= 0 ? '+' : '-'}${formatCurrency(Math.abs(profitNum))}`, \n                          bold: true,\n                          color: profitNum >= 0 ? \"10B981\" : \"EF4444\"\n                        })], \n                        alignment: AlignmentType.RIGHT \n                      })] })\n                    ]\n                  });\n                })\n              ]\n            }),\n\n            // Footer\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 600 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.name} | ${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER\n            })\n          ]\n        }]\n      });\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", \"attachment; filename=Financial-Reports.docx\");\n\n      // Write to response using Packer\n      const { Packer } = await import(\"docx\");\n      const buffer = await Packer.toBuffer(doc);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Financial Reports Word export error:\", error);\n      res.status(500).json({ error: \"Failed to export Word document\" });\n    }\n  });\n\n  // ========== SALARY PROCESSING SYSTEM API ENDPOINTS ==========\n  \n  // POST /api/payroll/generate - Generate salary for selected month/year based on attendance\n  app.post(\"/api/payroll/generate\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can generate salary\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { month, year } = req.body;\n\n      // Validate month and year\n      if (!month || !year || month < 1 || month > 12 || year < 2000 || year > 2100) {\n        return res.status(400).json({ error: \"Valid month (1-12) and year (2000-2100) are required\" });\n      }\n\n      // Delete existing payroll records for this month/year to allow regeneration\n      await db.delete(payroll).where(and(eq(payroll.month, month), eq(payroll.year, year)));\n\n      // Get HR settings to check if overtime is enabled\n      const [settings] = await db.select().from(hrSettings).limit(1);\n      const overtimeEnabled = settings?.overtimeEnabled ?? false;\n\n      console.log(\" PAYROLL GENERATION - Overtime Enabled:\", overtimeEnabled);\n\n      // Fetch all active employees with salary structure\n      const employeesWithSalary = await db\n        .select({\n          employee: employees,\n          user: users,\n          salaryStructure: salaryStructure,\n        })\n        .from(employees)\n        .leftJoin(users, eq(employees.userId, users.id))\n        .leftJoin(salaryStructure, eq(employees.id, salaryStructure.employeeId));\n\n      // Calculate salary for each employee\n      const payrollRecords = [];\n      for (const record of employeesWithSalary) {\n        if (!record.salaryStructure) continue; // Skip employees without salary structure\n\n        const employeeId = record.employee.id;\n        const basicSalary = parseFloat(record.salaryStructure.basicSalary || \"0\");\n        const houseAllowance = parseFloat(record.salaryStructure.houseAllowance || \"0\");\n        const medicalAllowance = parseFloat(record.salaryStructure.medicalAllowance || \"0\");\n        const travelAllowance = parseFloat(record.salaryStructure.travelAllowance || \"0\");\n        const foodAllowance = parseFloat(record.salaryStructure.foodAllowance || \"0\");\n        const otherAllowances = parseFloat(record.salaryStructure.otherAllowances || \"0\");\n        const totalAllowances = houseAllowance + medicalAllowance + travelAllowance + foodAllowance + otherAllowances;\n\n        // Calculate attendance stats for the month\n        const firstDay = `${year}-${String(month).padStart(2, \"0\")}-01`;\n        const lastDay = new Date(year, month, 0).toISOString().split(\"T\")[0];\n\n        const attendanceRecords = await db\n          .select()\n          .from(attendance)\n          .where(\n            and(\n              eq(attendance.userId, record.employee.userId!),\n              sql`${attendance.date} >= ${firstDay}`,\n              sql`${attendance.date} <= ${lastDay}`\n            )\n          );\n\n        // Count attendance stats\n        let totalPresentDays = 0;\n        let totalAbsentDays = 0;\n        let totalLateDays = 0;\n        let totalOvertimeHours = 0;\n        let totalHalfDays = 0; // Track half-days separately for proper deduction calculation\n\n        attendanceRecords.forEach((att) => {\n          if (att.status === \"present\") totalPresentDays++;\n          else if (att.status === \"absent\") totalAbsentDays++;\n          else if (att.status === \"late\") {\n            // Count late as present day + increment late counter\n            totalPresentDays++;\n            totalLateDays++;\n          }\n          else if (att.status === \"half-day\" || att.status === \"half_day\") {\n            totalHalfDays++;\n            // Count half-day as present for display purposes, deduction handled separately\n            totalPresentDays++;\n          }\n\n          // Calculate overtime hours ONLY if overtime is enabled in HR settings\n          if (overtimeEnabled && att.checkIn && att.checkOut) {\n            const checkIn = new Date(att.checkIn);\n            const checkOut = new Date(att.checkOut);\n            \n            // Validate that both timestamps are valid and checkOut is after checkIn\n            if (!isNaN(checkIn.getTime()) && !isNaN(checkOut.getTime()) && checkOut > checkIn) {\n              const hoursWorked = (checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60);\n              \n              // Only calculate overtime if worked more than 8 hours\n              if (hoursWorked > 8) {\n                totalOvertimeHours += hoursWorked - 8;\n              }\n            }\n          }\n        });\n\n        // Apply Late Policy: 3 Lates = 1 Absent (auto-convert)\n        const lateAbsents = Math.floor(totalLateDays / 3);\n        totalAbsentDays += lateAbsents;\n\n        // Calculate deductions\n        const dailyRate = basicSalary / 30;\n        const hourlyRate = dailyRate / 8;\n\n        const absentDeduction = dailyRate * totalAbsentDays;\n        const lateDeduction = dailyRate * (totalLateDays % 3) * (1 / 3); // Remaining lates not yet converted to absent\n        const halfDayDeduction = dailyRate * 0.5 * totalHalfDays; // Half-day = 0.5  daily rate\n        \n        // ONLY calculate overtime amount if overtime is enabled\n        const overtimeAmount = overtimeEnabled ? (hourlyRate * 1.5 * totalOvertimeHours) : 0;\n        \n        if (!overtimeEnabled && totalOvertimeHours > 0) {\n          console.log(` Overtime DISABLED - Skipping ${totalOvertimeHours.toFixed(2)} hours for employee ${record.employee.employeeId}`);\n        }\n\n        // Calculate final salary\n        const grossSalary = basicSalary + totalAllowances;\n        const totalDeductions = absentDeduction + lateDeduction + halfDayDeduction;\n        const netSalary = grossSalary - totalDeductions + overtimeAmount;\n\n        // Create payroll record\n        const [newPayroll] = await db\n          .insert(payroll)\n          .values({\n            employeeId: employeeId,\n            month: month,\n            year: year,\n            basicSalary: basicSalary.toFixed(2),\n            totalAllowances: totalAllowances.toFixed(2),\n            overtimeAmount: overtimeAmount.toFixed(2),\n            loanDeduction: \"0\",\n            lateDeduction: (absentDeduction + lateDeduction).toFixed(2),\n            otherDeductions: halfDayDeduction.toFixed(2),\n            grossSalary: grossSalary.toFixed(2),\n            netSalary: netSalary.toFixed(2),\n            totalLateDays: totalLateDays,\n            totalAbsentDays: Math.floor(totalAbsentDays), // Round down for display\n            totalPresentDays: Math.floor(totalPresentDays),\n            totalHalfDays: totalHalfDays,\n            totalOvertimeHours: totalOvertimeHours.toFixed(2),\n            workingDays: 30,\n            status: \"generated\",\n            generatedBy: req.userId,\n          })\n          .returning();\n\n        payrollRecords.push(newPayroll);\n      }\n\n      res.json({\n        success: true,\n        message: `Salary generated for ${payrollRecords.length} employees`,\n        count: payrollRecords.length,\n      });\n    } catch (error: any) {\n      console.error(\"Salary generation error:\", error);\n      res.status(500).json({ error: \"Failed to generate salary\" });\n    }\n  });\n\n  // POST /api/payroll/:id/adjustments - Add manual adjustment to payroll\n  app.post(\"/api/payroll/:id/adjustments\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const payrollId = req.params.id;\n      const { type, amount, reason } = req.body;\n\n      // Validate input\n      if (!type || !amount || !reason) {\n        return res.status(400).json({ error: \"Type, amount, and reason are required\" });\n      }\n\n      if (![\"bonus\", \"penalty\", \"loan_deduction\", \"advance\", \"other\"].includes(type)) {\n        return res.status(400).json({ error: \"Invalid adjustment type\" });\n      }\n\n      // Check if payroll record exists\n      const [payrollRecord] = await db.select().from(payroll).where(eq(payroll.id, payrollId));\n      if (!payrollRecord) {\n        return res.status(404).json({ error: \"Payroll record not found\" });\n      }\n\n      // Create adjustment record\n      await db.insert(salaryAdjustments).values({\n        payrollId: payrollId,\n        type: type,\n        amount: amount.toString(),\n        reason: reason,\n        createdBy: req.userId!,\n      });\n\n      // Recalculate net salary with adjustments\n      const adjustments = await db.select().from(salaryAdjustments).where(eq(salaryAdjustments.payrollId, payrollId));\n\n      let totalAdjustments = 0;\n      adjustments.forEach((adj) => {\n        const adjAmount = parseFloat(adj.amount);\n        if (adj.type === \"bonus\") {\n          totalAdjustments += adjAmount;\n        } else {\n          totalAdjustments -= adjAmount;\n        }\n      });\n\n      const baseNetSalary = parseFloat(payrollRecord.grossSalary) - parseFloat(payrollRecord.lateDeduction) + parseFloat(payrollRecord.overtimeAmount);\n      const newNetSalary = baseNetSalary + totalAdjustments;\n\n      // Update payroll record with new net salary and other deductions\n      await db\n        .update(payroll)\n        .set({\n          otherDeductions: Math.abs(totalAdjustments < 0 ? totalAdjustments : 0).toFixed(2),\n          netSalary: newNetSalary.toFixed(2),\n        })\n        .where(eq(payroll.id, payrollId));\n\n      res.json({ success: true, message: \"Adjustment added successfully\" });\n    } catch (error: any) {\n      console.error(\"Add adjustment error:\", error);\n      res.status(500).json({ error: \"Failed to add adjustment\" });\n    }\n  });\n\n  // GET /api/payroll/:id/adjustments - Get all adjustments for a payroll record\n  app.get(\"/api/payroll/:id/adjustments\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const payrollId = req.params.id;\n      const adjustments = await db\n        .select({\n          adjustment: salaryAdjustments,\n          createdBy: users,\n        })\n        .from(salaryAdjustments)\n        .leftJoin(users, eq(salaryAdjustments.createdBy, users.id))\n        .where(eq(salaryAdjustments.payrollId, payrollId));\n\n      res.json(adjustments);\n    } catch (error: any) {\n      console.error(\"Fetch adjustments error:\", error);\n      res.status(500).json({ error: \"Failed to fetch adjustments\" });\n    }\n  });\n\n  // PATCH /api/payroll/:id/status - Update payment status (generated -> paid)\n  app.patch(\"/api/payroll/:id/status\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const payrollId = req.params.id;\n      const { status } = req.body;\n\n      if (![\"draft\", \"generated\", \"paid\"].includes(status)) {\n        return res.status(400).json({ error: \"Invalid status\" });\n      }\n\n      const updateData: any = { status };\n      if (status === \"paid\") {\n        updateData.paidAt = new Date();\n      }\n\n      await db.update(payroll).set(updateData).where(eq(payroll.id, payrollId));\n\n      res.json({ success: true, message: \"Status updated successfully\" });\n    } catch (error: any) {\n      console.error(\"Update status error:\", error);\n      res.status(500).json({ error: \"Failed to update status\" });\n    }\n  });\n\n  // DELETE /api/payroll/:payrollId/adjustments/:adjustmentId - Delete a manual adjustment\n  app.delete(\"/api/payroll/:payrollId/adjustments/:adjustmentId\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { payrollId, adjustmentId } = req.params;\n\n      // Delete the adjustment\n      await db.delete(salaryAdjustments).where(eq(salaryAdjustments.id, adjustmentId));\n\n      // Recalculate net salary\n      const [payrollRecord] = await db.select().from(payroll).where(eq(payroll.id, payrollId));\n      if (!payrollRecord) {\n        return res.status(404).json({ error: \"Payroll record not found\" });\n      }\n\n      const adjustments = await db.select().from(salaryAdjustments).where(eq(salaryAdjustments.payrollId, payrollId));\n\n      let totalAdjustments = 0;\n      adjustments.forEach((adj) => {\n        const adjAmount = parseFloat(adj.amount);\n        if (adj.type === \"bonus\") {\n          totalAdjustments += adjAmount;\n        } else {\n          totalAdjustments -= adjAmount;\n        }\n      });\n\n      const baseNetSalary = parseFloat(payrollRecord.grossSalary) - parseFloat(payrollRecord.lateDeduction) + parseFloat(payrollRecord.overtimeAmount);\n      const newNetSalary = baseNetSalary + totalAdjustments;\n\n      await db\n        .update(payroll)\n        .set({\n          otherDeductions: Math.abs(totalAdjustments < 0 ? totalAdjustments : 0).toFixed(2),\n          netSalary: newNetSalary.toFixed(2),\n        })\n        .where(eq(payroll.id, payrollId));\n\n      res.json({ success: true, message: \"Adjustment deleted successfully\" });\n    } catch (error: any) {\n      console.error(\"Delete adjustment error:\", error);\n      res.status(500).json({ error: \"Failed to delete adjustment\" });\n    }\n  });\n\n  // Payroll Report GET endpoint (filtered by month/year)\n  app.get(\"/api/payroll-report\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access payroll reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      // Validate month and year - check for NaN FIRST before any other validation\n      if (isNaN(month) || isNaN(year) || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Valid month and year are required\" });\n      }\n\n      if (month < 1 || month > 12 || year < 2000 || year > 2100) {\n        return res.status(400).json({ error: \"Month must be 1-12 and year must be 2000-2100\" });\n      }\n\n      // Fetch payroll records for the selected month/year\n      const payrollRecords = await db\n        .select({\n          payroll: payroll,\n          employee: employees,\n          user: users,\n        })\n        .from(payroll)\n        .leftJoin(employees, eq(payroll.employeeId, employees.id))\n        .leftJoin(users, eq(employees.userId, users.id))\n        .where(and(eq(payroll.month, month), eq(payroll.year, year)));\n\n      return res.json(payrollRecords);\n    } catch (error: any) {\n      console.error(\"Payroll Report GET error:\", error);\n      return res.status(500).json({ error: \"Failed to fetch payroll report\" });\n    }\n  });\n\n  // Helper function for professional signature footer with smart positioning\n  function addSignatureFooter(doc: typeof PDFDocument.prototype, currentY: number): number {\n    const signatureBoxWidth = 165;\n    const signatureBoxHeight = 60;\n    const gap = 12;\n    const totalFooterHeight = signatureBoxHeight + 18; // Box + tagline\n    \n    // Check if we need a new page for signature block\n    if (currentY + totalFooterHeight > 750) {\n      doc.addPage();\n      currentY = 40;\n    }\n    \n    // Add some spacing before signature section\n    currentY += 15;\n    const footerY = currentY;\n    \n    const x1 = 40;\n    const x2 = x1 + signatureBoxWidth + gap;\n    const x3 = x2 + signatureBoxWidth + gap;\n    \n    const signatureFields = [\n      { label: \"Prepared By\", name: \"HR Manager\", position: x1 },\n      { label: \"Verified By\", name: \"Accounts Head\", position: x2 },\n      { label: \"Approved By\", name: \"Managing Director\", position: x3 }\n    ];\n    \n    signatureFields.forEach(field => {\n      // Signature box\n      doc.save();\n      doc.roundedRect(field.position, footerY, signatureBoxWidth, signatureBoxHeight, 3)\n         .strokeColor(\"#d6dae2\")\n         .lineWidth(1)\n         .stroke();\n      doc.restore();\n      \n      // Label\n      doc.fontSize(8).font(\"Helvetica\").fillColor(\"#6b7280\");\n      doc.text(field.label, field.position + 10, footerY + 10, { width: signatureBoxWidth - 20, align: \"left\" });\n      \n      // Signature line\n      doc.moveTo(field.position + 10, footerY + 35)\n         .lineTo(field.position + signatureBoxWidth - 10, footerY + 35)\n         .strokeColor(\"#d6dae2\")\n         .lineWidth(1)\n         .stroke();\n      \n      // Name\n      doc.fontSize(9).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.black);\n      doc.text(field.name, field.position + 10, footerY + 40, { width: signatureBoxWidth - 20, align: \"center\" });\n    });\n    \n    // Company tagline at bottom\n    doc.fontSize(7).font(\"Helvetica-Oblique\").fillColor(BRAND_COLORS.gray);\n    doc.text(\"MaxTech BD - Smart Agency Control Hub\", 40, footerY + signatureBoxHeight + 8, { width: 515, align: \"center\" });\n    \n    return footerY + totalFooterHeight;\n  }\n\n  // Payroll Report PDF Export - Corporate Grade Professional Design\n  app.get(\"/api/payroll-report/export-pdf\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export Payroll Reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      // Validate month and year - check for NaN FIRST before any other validation\n      if (isNaN(month) || isNaN(year) || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Valid month and year are required\" });\n      }\n\n      if (month < 1 || month > 12 || year < 2000 || year > 2100) {\n        return res.status(400).json({ error: \"Month must be 1-12 and year must be 2000-2100\" });\n      }\n\n      // Fetch payroll records for the selected month/year with employee and user data\n      const payrollRecords = await db\n        .select({\n          payroll: payroll,\n          employee: employees,\n          user: users,\n        })\n        .from(payroll)\n        .leftJoin(employees, eq(payroll.employeeId, employees.id))\n        .leftJoin(users, eq(employees.userId, users.id))\n        .where(and(eq(payroll.month, month), eq(payroll.year, year)));\n\n      // Calculate totals using Decimal.js with null-safe handling\n      const totalGrossSalary = sumAmounts(payrollRecords.map(r => r.payroll.grossSalary || \"0\"));\n      const totalDeductions = sumAmounts(\n        payrollRecords.flatMap(r => [\n          r.payroll.loanDeduction || \"0\",\n          r.payroll.lateDeduction || \"0\",\n          r.payroll.otherDeductions || \"0\"\n        ])\n      );\n      const totalNetSalary = sumAmounts(payrollRecords.map(r => r.payroll.netSalary || \"0\"));\n      const totalEmployees = payrollRecords.length;\n      const paidCount = payrollRecords.filter(r => r.payroll.status === \"paid\").length;\n\n      // ===== CORPORATE-GRADE PDF GENERATION =====\n      const doc = new PDFDocument({ margin: 30, size: 'A4', bufferPages: true });\n      const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n      \n      let currentY = 30;\n      const headerStartY = currentY;\n\n      // ===== PROFESSIONAL HEADER (Non-Overlapping Three-Section Layout) =====\n      const leftBounds = { x: 40, width: 90 };\n      const centerBounds = { x: 140, width: 240 };\n      const rightBounds = { x: 390, width: 165 };\n      \n      let maxHeaderHeight = 0;\n\n      // LEFT: Logo\n      let logoHeight = 75;\n      try {\n        const logoPath = path.join(__dirname, \"../attached_assets/Untitled design (1)_1763794635122.png\");\n        doc.image(logoPath, leftBounds.x, headerStartY, { width: 75, height: 75 });\n        maxHeaderHeight = Math.max(maxHeaderHeight, logoHeight);\n      } catch (error) {\n        console.warn(\"Logo not found\");\n        logoHeight = 0;\n      }\n\n      // CENTER: Company Details\n      let centerY = headerStartY;\n      let centerHeight = 0;\n\n      doc.fontSize(16).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n      const nameHeight = doc.heightOfString(\"MAXTECH BD\", { width: centerBounds.width, align: \"center\" });\n      doc.text(\"MAXTECH BD\", centerBounds.x, centerY, { width: centerBounds.width, align: \"center\" });\n      centerY += nameHeight + 4;\n      centerHeight += nameHeight + 4;\n\n      doc.fontSize(8).font(\"Helvetica\").fillColor(BRAND_COLORS.black);\n      const addr1Height = doc.heightOfString(\"522, SK Mujib Road (4th Floor)\", { width: centerBounds.width, align: \"center\" });\n      doc.text(\"522, SK Mujib Road (4th Floor)\", centerBounds.x, centerY, { width: centerBounds.width, align: \"center\" });\n      centerY += addr1Height + 2;\n      centerHeight += addr1Height + 2;\n\n      const addr2Height = doc.heightOfString(\"Agrabad, Double Mooring, Chattogram\", { width: centerBounds.width, align: \"center\" });\n      doc.text(\"Agrabad, Double Mooring, Chattogram\", centerBounds.x, centerY, { width: centerBounds.width, align: \"center\" });\n      centerY += addr2Height + 3;\n      centerHeight += addr2Height + 3;\n\n      doc.fontSize(7).font(\"Helvetica\").fillColor(BRAND_COLORS.gray);\n      const contactHeight = doc.heightOfString(\"Phone: +8801843180008 | Email: support@maxtechbd.com\", { width: centerBounds.width, align: \"center\" });\n      doc.text(\"Phone: +8801843180008 | Email: support@maxtechbd.com\", centerBounds.x, centerY, { width: centerBounds.width, align: \"center\" });\n      centerHeight += contactHeight;\n\n      maxHeaderHeight = Math.max(maxHeaderHeight, centerHeight);\n\n      // RIGHT: Report Info Box\n      let rightY = headerStartY;\n      const boxPadding = 10;\n      const boxInnerWidth = rightBounds.width - (2 * boxPadding);\n\n      doc.fontSize(10).font(\"Helvetica-Bold\");\n      const titleText = \"Salary Sheet\";\n      const titleHeight = doc.heightOfString(titleText, { width: boxInnerWidth, align: \"center\" });\n\n      doc.fontSize(7).font(\"Helvetica\");\n      const periodText = `Period: ${monthNames[month - 1]} ${year}`;\n      const periodHeight = doc.heightOfString(periodText, { width: boxInnerWidth, align: \"center\" });\n\n      const generatedText = `Generated: ${format(new Date(), \"MMM dd, yyyy\")}`;\n      const generatedHeight = doc.heightOfString(generatedText, { width: boxInnerWidth, align: \"center\" });\n\n      const lineSpacing = 4;\n      const boxHeight = boxPadding + titleHeight + lineSpacing + periodHeight + lineSpacing + generatedHeight + boxPadding;\n\n      doc.save();\n      doc.roundedRect(rightBounds.x, rightY, rightBounds.width, boxHeight, 3)\n         .fillAndStroke(\"#f7f8fa\", \"#d6dae2\");\n      doc.restore();\n\n      rightY += boxPadding;\n\n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n      doc.text(titleText, rightBounds.x + boxPadding, rightY, { width: boxInnerWidth, align: \"center\", lineBreak: false });\n      rightY += titleHeight + lineSpacing;\n\n      doc.fontSize(7).font(\"Helvetica\").fillColor(\"#6b7280\");\n      doc.text(periodText, rightBounds.x + boxPadding, rightY, { width: boxInnerWidth, align: \"center\", lineBreak: false });\n      rightY += periodHeight + lineSpacing;\n\n      doc.text(generatedText, rightBounds.x + boxPadding, rightY, { width: boxInnerWidth, align: \"center\", lineBreak: false });\n\n      maxHeaderHeight = Math.max(maxHeaderHeight, boxHeight);\n      currentY = headerStartY + maxHeaderHeight + 12;\n\n      // Header separator\n      doc.moveTo(40, currentY).lineTo(555, currentY).strokeColor(BRAND_COLORS.border).lineWidth(1).stroke();\n      currentY += 18;\n\n      // ===== SUMMARY CARDS (2 rows  3 columns) - Fixed Dimensions =====\n      const cardWidth = 165;\n      const cardHeight = 55;\n      const cardGap = 12;\n      const cardX1 = 40;\n      const cardX2 = cardX1 + cardWidth + cardGap;\n      const cardX3 = cardX2 + cardWidth + cardGap;\n\n      const summaryCards = [\n        { label: \"Total Employees\", value: totalEmployees.toString(), color: \"#3b82f6\" },\n        { label: \"Paid\", value: paidCount.toString(), color: \"#10b981\" },\n        { label: \"Pending\", value: (totalEmployees - paidCount).toString(), color: \"#f59e0b\" },\n        { label: \"Gross Salary\", value: formatCurrency(totalGrossSalary), color: \"#059669\" },\n        { label: \"Total Deductions\", value: formatCurrency(totalDeductions), color: \"#ef4444\" },\n        { label: \"Net Payroll\", value: formatCurrency(totalNetSalary), color: \"#3b82f6\" }\n      ];\n\n      const summaryStartY = currentY;\n\n      // Row 1\n      for (let i = 0; i < 3; i++) {\n        const card = summaryCards[i];\n        const xPos = i === 0 ? cardX1 : i === 1 ? cardX2 : cardX3;\n        \n        doc.save();\n        doc.roundedRect(xPos, summaryStartY, cardWidth, cardHeight, 4)\n           .fillAndStroke(\"#f7f8fa\", \"#d6dae2\");\n        doc.restore();\n\n        doc.fontSize(9).font(\"Helvetica\").fillColor(\"#6b7280\");\n        doc.text(card.label, xPos + 12, summaryStartY + 12, { width: cardWidth - 24, align: \"left\" });\n\n        doc.fontSize(13).font(\"Helvetica-Bold\").fillColor(card.color);\n        doc.text(card.value, xPos + 12, summaryStartY + 28, { width: cardWidth - 24, align: \"left\" });\n      }\n\n      // Row 2\n      const row2Y = summaryStartY + cardHeight + cardGap;\n      for (let i = 3; i < 6; i++) {\n        const card = summaryCards[i];\n        const xPos = (i - 3) === 0 ? cardX1 : (i - 3) === 1 ? cardX2 : cardX3;\n        \n        doc.save();\n        doc.roundedRect(xPos, row2Y, cardWidth, cardHeight, 4)\n           .fillAndStroke(\"#f7f8fa\", \"#d6dae2\");\n        doc.restore();\n\n        doc.fontSize(9).font(\"Helvetica\").fillColor(\"#6b7280\");\n        doc.text(card.label, xPos + 12, row2Y + 12, { width: cardWidth - 24, align: \"left\" });\n\n        doc.fontSize(13).font(\"Helvetica-Bold\").fillColor(card.color);\n        doc.text(card.value, xPos + 12, row2Y + 28, { width: cardWidth - 24, align: \"left\" });\n      }\n\n      currentY = row2Y + cardHeight + 18;\n\n      // ===== DETAILED SALARY TABLE =====\n      const tableX = 40;\n      const colWidths = [150, 90, 90, 90, 95]; // Employee, Basic, Allowances, Deductions, Net\n      const totalTableWidth = colWidths.reduce((sum, w) => sum + w, 0);\n\n      // Table Header\n      doc.save();\n      doc.rect(tableX, currentY, totalTableWidth, 32).fillAndStroke(BRAND_COLORS.primary, BRAND_COLORS.primary);\n      doc.restore();\n\n      doc.fontSize(9).font(\"Helvetica-Bold\").fillColor(\"#ffffff\");\n      const headerLabels = [\"Employee Name\", \"Basic Salary\", \"Allowances\", \"Deductions\", \"Net Salary\"];\n      let colX = tableX + 8;\n      headerLabels.forEach((label, i) => {\n        const align = i === 0 ? \"left\" : \"right\";\n        const width = colWidths[i] - 16;\n        doc.text(label, colX, currentY + 10, { width, align });\n        colX += colWidths[i];\n      });\n\n      currentY += 32;\n\n      // Table Rows\n      let isEven = false;\n      payrollRecords.forEach((record) => {\n        if (currentY > 680) {\n          // Start new page for next row\n          doc.addPage();\n          currentY = 40;\n          \n          // Re-draw table header on new page\n          doc.save();\n          doc.rect(tableX, currentY, totalTableWidth, 32).fillAndStroke(BRAND_COLORS.primary, BRAND_COLORS.primary);\n          doc.restore();\n\n          doc.fontSize(9).font(\"Helvetica-Bold\").fillColor(\"#ffffff\");\n          let headerColX = tableX + 8;\n          headerLabels.forEach((label, i) => {\n            const align = i === 0 ? \"left\" : \"right\";\n            const width = colWidths[i] - 16;\n            doc.text(label, headerColX, currentY + 10, { width, align });\n            headerColX += colWidths[i];\n          });\n\n          currentY += 32;\n          isEven = false; // Reset alternation on new page\n        }\n\n        const totalDed = sumAmounts([\n          record.payroll.loanDeduction || \"0\",\n          record.payroll.lateDeduction || \"0\",\n          record.payroll.otherDeductions || \"0\"\n        ]);\n\n        const bgColor = isEven ? \"#fbfbfb\" : \"#ffffff\";\n        \n        doc.save();\n        doc.rect(tableX, currentY, totalTableWidth, 28).fillAndStroke(bgColor, \"#e5e7eb\");\n        doc.restore();\n\n        doc.fontSize(9).font(\"Helvetica\").fillColor(BRAND_COLORS.black);\n        \n        colX = tableX + 8;\n        const rowData = [\n          { text: record.user?.fullName || \"Unknown\", align: \"left\" as const },\n          { text: formatCurrency(record.payroll.basicSalary || \"0\"), align: \"right\" as const },\n          { text: formatCurrency(record.payroll.totalAllowances || \"0\"), align: \"right\" as const },\n          { text: formatCurrency(totalDed), align: \"right\" as const },\n          { text: formatCurrency(record.payroll.netSalary || \"0\"), align: \"right\" as const, bold: true }\n        ];\n\n        rowData.forEach((item, i) => {\n          if (item.bold) doc.font(\"Helvetica-Bold\");\n          else doc.font(\"Helvetica\");\n          \n          const width = colWidths[i] - 16;\n          doc.text(item.text, colX, currentY + 8, { width, align: item.align });\n          colX += colWidths[i];\n        });\n\n        currentY += 28;\n        isEven = !isEven;\n      });\n\n      // Subtotal Rows\n      currentY += 5;\n\n      // Gross Earnings\n      doc.save();\n      doc.rect(tableX, currentY, totalTableWidth, 30).fillAndStroke(\"#f0fdf4\", \"#86efac\");\n      doc.restore();\n\n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(\"#065f46\");\n      doc.text(\"Total Gross Earnings\", tableX + 8, currentY + 9, { width: colWidths[0] + colWidths[1] + colWidths[2] - 16, align: \"right\" });\n      doc.text(formatCurrency(totalGrossSalary), tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 8, currentY + 9, { width: colWidths[4] - 16, align: \"right\" });\n      currentY += 30;\n\n      // Total Deductions\n      doc.save();\n      doc.rect(tableX, currentY, totalTableWidth, 30).fillAndStroke(\"#fef2f2\", \"#fca5a5\");\n      doc.restore();\n\n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(\"#991b1b\");\n      doc.text(\"Total Deductions\", tableX + 8, currentY + 9, { width: colWidths[0] + colWidths[1] + colWidths[2] - 16, align: \"right\" });\n      doc.text(formatCurrency(totalDeductions), tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 8, currentY + 9, { width: colWidths[4] - 16, align: \"right\" });\n      currentY += 30;\n\n      // Net Payroll\n      doc.save();\n      doc.rect(tableX, currentY, totalTableWidth, 35).fillAndStroke(\"#eff6ff\", \"#3b82f6\");\n      doc.restore();\n\n      doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#1e40af\");\n      doc.text(\"NET PAYROLL COST\", tableX + 8, currentY + 11, { width: colWidths[0] + colWidths[1] + colWidths[2] - 16, align: \"right\" });\n      doc.fontSize(13).font(\"Helvetica-Bold\");\n      doc.text(formatCurrency(totalNetSalary), tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 8, currentY + 10, { width: colWidths[4] - 16, align: \"right\" });\n      currentY += 35;\n\n      // Add signature footer with smart positioning\n      currentY = addSignatureFooter(doc, currentY);\n\n      // Stream response\n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Salary-Sheet-${monthNames[month - 1]}-${year}.pdf`);\n\n      doc.pipe(res);\n      doc.end();\n    } catch (error: any) {\n      console.error(\"Payroll Report PDF export error:\", error);\n      res.status(500).json({ error: \"Failed to export PDF\" });\n    }\n  });\n\n  // Payroll Report Excel Export\n  app.get(\"/api/payroll-report/export-excel\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export Payroll Reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      // Validate month and year - check for NaN FIRST before any other validation\n      if (isNaN(month) || isNaN(year) || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Valid month and year are required\" });\n      }\n\n      if (month < 1 || month > 12 || year < 2000 || year > 2100) {\n        return res.status(400).json({ error: \"Month must be 1-12 and year must be 2000-2100\" });\n      }\n\n      // Fetch payroll records\n      const payrollRecords = await db\n        .select({\n          payroll: payroll,\n          employee: employees,\n          user: users,\n        })\n        .from(payroll)\n        .leftJoin(employees, eq(payroll.employeeId, employees.id))\n        .leftJoin(users, eq(employees.userId, users.id))\n        .where(and(eq(payroll.month, month), eq(payroll.year, year)));\n\n      // Calculate totals with null-safe handling\n      const totalGrossSalary = sumAmounts(payrollRecords.map(r => r.payroll.grossSalary || \"0\"));\n      const totalDeductions = sumAmounts(\n        payrollRecords.flatMap(r => [\n          r.payroll.loanDeduction || \"0\",\n          r.payroll.lateDeduction || \"0\",\n          r.payroll.otherDeductions || \"0\"\n        ])\n      );\n      const totalNetSalary = sumAmounts(payrollRecords.map(r => r.payroll.netSalary || \"0\"));\n\n      // Create Excel workbook\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Payroll Report\");\n\n      // Set column widths\n      worksheet.columns = [\n        { width: 25 },  // Employee Name\n        { width: 15 },  // Employee ID\n        { width: 15 },  // Basic Salary\n        { width: 15 },  // Allowances\n        { width: 15 },  // Deductions\n        { width: 15 },  // Net Salary\n        { width: 12 },  // Present\n        { width: 12 }   // Status\n      ];\n\n      // Add company header\n      worksheet.mergeCells('A1:H1');\n      const titleRow = worksheet.getCell('A1');\n      titleRow.value = COMPANY_INFO.name;\n      titleRow.font = { size: 16, bold: true, color: { argb: 'FFE11D26' } };\n      titleRow.alignment = { horizontal: 'center', vertical: 'middle' };\n\n      worksheet.mergeCells('A2:H2');\n      const addressRow1 = worksheet.getCell('A2');\n      addressRow1.value = COMPANY_INFO.address1;\n      addressRow1.font = { size: 10 };\n      addressRow1.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A3:H3');\n      const addressRow2 = worksheet.getCell('A3');\n      addressRow2.value = `${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`;\n      addressRow2.font = { size: 10 };\n      addressRow2.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A4:H4');\n      const contactRow = worksheet.getCell('A4');\n      contactRow.value = `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`;\n      contactRow.font = { size: 10 };\n      contactRow.alignment = { horizontal: 'center' };\n\n      // Add report title\n      worksheet.addRow([]);\n      worksheet.mergeCells('A6:H6');\n      const reportTitle = worksheet.getCell('A6');\n      reportTitle.value = \"Payroll Report\";\n      reportTitle.font = { size: 18, bold: true };\n      reportTitle.alignment = { horizontal: 'center' };\n\n      const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n      worksheet.mergeCells('A7:H7');\n      const subtitle = worksheet.getCell('A7');\n      subtitle.value = `${monthNames[month - 1]} ${year}`;\n      subtitle.font = { size: 12 };\n      subtitle.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A8:H8');\n      const dateRow = worksheet.getCell('A8');\n      dateRow.value = `Generated on: ${new Date().toLocaleString()}`;\n      dateRow.font = { size: 10, italic: true };\n      dateRow.alignment = { horizontal: 'center' };\n\n      let currentRow = 10;\n\n      // Summary section\n      const summaryRow1 = worksheet.getRow(currentRow);\n      summaryRow1.values = [\"Total Employees\", payrollRecords.length, \"\", \"Gross Salary\", formatCurrency(totalGrossSalary)];\n      summaryRow1.font = { bold: true };\n      currentRow++;\n\n      const summaryRow2 = worksheet.getRow(currentRow);\n      summaryRow2.values = [\"Paid Employees\", payrollRecords.filter(r => r.payroll.status === \"paid\").length, \"\", \"Total Deductions\", formatCurrency(totalDeductions)];\n      summaryRow2.font = { bold: true };\n      currentRow++;\n\n      const summaryRow3 = worksheet.getRow(currentRow);\n      summaryRow3.values = [\"\", \"\", \"\", \"Net Payroll Cost\", formatCurrency(totalNetSalary)];\n      summaryRow3.font = { size: 12, bold: true, color: { argb: 'FF10B981' } };\n      currentRow += 3;\n\n      // Table header\n      const headerRow = worksheet.getRow(currentRow);\n      headerRow.values = [\"Employee Name\", \"Employee ID\", \"Basic Salary\", \"Allowances\", \"Deductions\", \"Net Salary\", \"Present\", \"Status\"];\n      headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE11D26' } };\n      headerRow.alignment = { horizontal: 'left', vertical: 'middle' };\n      currentRow++;\n\n      // Add data rows\n      payrollRecords.forEach(record => {\n        const totalDed = sumAmounts([\n          record.payroll.loanDeduction || \"0\",\n          record.payroll.lateDeduction || \"0\",\n          record.payroll.otherDeductions || \"0\"\n        ]);\n\n        const row = worksheet.getRow(currentRow);\n        row.values = [\n          record.user?.fullName || \"Unknown\",\n          record.employee?.employeeId || \"N/A\",\n          formatCurrency(record.payroll.basicSalary || \"0\"),\n          formatCurrency(record.payroll.totalAllowances || \"0\"),\n          formatCurrency(totalDed),\n          formatCurrency(record.payroll.netSalary || \"0\"),\n          `${record.payroll.totalPresentDays ?? 0}/${record.payroll.workingDays}`,\n          record.payroll.status || \"draft\"\n        ];\n        row.alignment = { horizontal: 'left', vertical: 'middle' };\n        currentRow++;\n      });\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Payroll-Report-${month}-${year}.xlsx`);\n\n      // Write to response\n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error: any) {\n      console.error(\"Payroll Report Excel export error:\", error);\n      res.status(500).json({ error: \"Failed to export Excel\" });\n    }\n  });\n\n  // Payroll Report Word Export\n  app.get(\"/api/payroll-report/export-word\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export Payroll Reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      // Validate month and year - check for NaN FIRST before any other validation\n      if (isNaN(month) || isNaN(year) || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Valid month and year are required\" });\n      }\n\n      if (month < 1 || month > 12 || year < 2000 || year > 2100) {\n        return res.status(400).json({ error: \"Month must be 1-12 and year must be 2000-2100\" });\n      }\n\n      // Fetch payroll records\n      const payrollRecords = await db\n        .select({\n          payroll: payroll,\n          employee: employees,\n          user: users,\n        })\n        .from(payroll)\n        .leftJoin(employees, eq(payroll.employeeId, employees.id))\n        .leftJoin(users, eq(employees.userId, users.id))\n        .where(and(eq(payroll.month, month), eq(payroll.year, year)));\n\n      // Calculate totals with null-safe handling\n      const totalGrossSalary = sumAmounts(payrollRecords.map(r => r.payroll.grossSalary || \"0\"));\n      const totalDeductions = sumAmounts(\n        payrollRecords.flatMap(r => [\n          r.payroll.loanDeduction || \"0\",\n          r.payroll.lateDeduction || \"0\",\n          r.payroll.otherDeductions || \"0\"\n        ])\n      );\n      const totalNetSalary = sumAmounts(payrollRecords.map(r => r.payroll.netSalary || \"0\"));\n\n      // Create Word document\n      const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n\n      const doc = new Document({\n        sections: [{\n          properties: {},\n          children: [\n            // Company Header\n            new Paragraph({\n              children: [new TextRun({ text: COMPANY_INFO.name, bold: true, size: 32, color: \"E11D26\" })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: COMPANY_INFO.address1,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n            \n            // Report Title\n            new Paragraph({\n              children: [new TextRun({ text: \"Payroll Report\", bold: true, size: 28, color: \"E11D26\" })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: `${monthNames[month - 1]} ${year}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [new TextRun({ text: `Generated on: ${new Date().toLocaleString()}`, italics: true })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n\n            // Summary\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Total Employees: \", bold: true }),\n                new TextRun(payrollRecords.length.toString())\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Paid Employees: \", bold: true }),\n                new TextRun(payrollRecords.filter(r => r.payroll.status === \"paid\").length.toString())\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Gross Salary: \", bold: true }),\n                new TextRun(formatCurrency(totalGrossSalary))\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Total Deductions: \", bold: true }),\n                new TextRun(formatCurrency(totalDeductions))\n              ],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              children: [\n                new TextRun({ text: \"Net Payroll Cost: \", bold: true, size: 28 }),\n                new TextRun({ \n                  text: formatCurrency(totalNetSalary),\n                  bold: true,\n                  size: 28,\n                  color: \"10B981\"\n                })\n              ],\n              spacing: { after: 300 }\n            }),\n\n            // Employee Breakdown Table\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                // Header\n                new TableRow({\n                  children: [\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Employee\", bold: true })], alignment: AlignmentType.LEFT })],\n                      width: { size: 25, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Basic\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 15, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Allowances\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 15, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Deductions\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 15, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Net Salary\", bold: true })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 15, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Status\", bold: true })], alignment: AlignmentType.CENTER })],\n                      width: { size: 15, type: WidthType.PERCENTAGE }\n                    })\n                  ]\n                }),\n                // Data rows\n                ...payrollRecords.map(record => {\n                  const totalDed = new Decimal(record.payroll.loanDeduction || \"0\")\n                    .plus(record.payroll.lateDeduction || \"0\")\n                    .plus(record.payroll.otherDeductions || \"0\")\n                    .toFixed(2);\n\n                  return new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph({ text: record.user?.fullName || \"Unknown\", alignment: AlignmentType.LEFT })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(record.payroll.basicSalary || \"0\"), alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(record.payroll.totalAllowances || \"0\"), alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(totalDed), alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ \n                        children: [new TextRun({ \n                          text: formatCurrency(record.payroll.netSalary || \"0\"), \n                          bold: true\n                        })], \n                        alignment: AlignmentType.RIGHT \n                      })] }),\n                      new TableCell({ children: [new Paragraph({ text: record.payroll.status || \"draft\", alignment: AlignmentType.CENTER })] })\n                    ]\n                  });\n                })\n              ]\n            }),\n\n            // Footer\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 600 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.name} | ${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER\n            })\n          ]\n        }]\n      });\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Payroll-Report-${month}-${year}.docx`);\n\n      // Write to response using Packer\n      const { Packer } = await import(\"docx\");\n      const buffer = await Packer.toBuffer(doc);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Payroll Report Word export error:\", error);\n      res.status(500).json({ error: \"Failed to export Word document\" });\n    }\n  });\n\n  // Salary Sheet GET endpoint (filtered by month/year)\n  // Shows ALL employees with salary structures, with payroll data if available\n  app.get(\"/api/salary-sheet\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access Salary Sheet\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      // Validate month and year - check for NaN FIRST before any other validation\n      if (isNaN(month) || isNaN(year) || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Valid month and year are required\" });\n      }\n\n      if (month < 1 || month > 12 || year < 2000 || year > 2100) {\n        return res.status(400).json({ error: \"Month must be 1-12 and year must be 2000-2100\" });\n      }\n\n      // Fetch ALL employees with salary structures\n      // Left join with payroll to get payroll data if it exists for this month/year\n      // Join with users, departments, designations for complete info\n      const salaryRecords = await db\n        .select({\n          employee: employees,\n          user: users,\n          department: departments,\n          designation: designations,\n          salaryStructure: salaryStructure,\n          payroll: payroll,\n        })\n        .from(employees)\n        .innerJoin(users, eq(employees.userId, users.id))\n        .innerJoin(salaryStructure, eq(salaryStructure.employeeId, employees.id))\n        .leftJoin(departments, eq(employees.departmentId, departments.id))\n        .leftJoin(designations, eq(employees.designationId, designations.id))\n        .leftJoin(\n          payroll,\n          and(\n            eq(payroll.employeeId, employees.id),\n            eq(payroll.month, month),\n            eq(payroll.year, year)\n          )\n        )\n        .where(eq(employees.status, \"active\"));\n\n      return res.json(salaryRecords);\n    } catch (error: any) {\n      console.error(\"Salary Sheet GET error:\", error);\n      return res.status(500).json({ error: \"Failed to fetch salary sheet\" });\n    }\n  });\n\n  // Salary Sheet PDF Export - Professional Corporate Format\n  app.get(\"/api/salary-sheet/export-pdf\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export Salary Sheet\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      // Validate month and year - check for NaN FIRST before any other validation\n      if (isNaN(month) || isNaN(year) || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Valid month and year are required\" });\n      }\n\n      if (month < 1 || month > 12 || year < 2000 || year > 2100) {\n        return res.status(400).json({ error: \"Month must be 1-12 and year must be 2000-2100\" });\n      }\n\n      // Fetch ALL employees with salary structures\n      const salaryRecords = await db\n        .select({\n          employee: employees,\n          user: users,\n          department: departments,\n          designation: designations,\n          salaryStructure: salaryStructure,\n          payroll: payroll,\n        })\n        .from(employees)\n        .innerJoin(users, eq(employees.userId, users.id))\n        .innerJoin(salaryStructure, eq(salaryStructure.employeeId, employees.id))\n        .leftJoin(departments, eq(employees.departmentId, departments.id))\n        .leftJoin(designations, eq(employees.designationId, designations.id))\n        .leftJoin(\n          payroll,\n          and(\n            eq(payroll.employeeId, employees.id),\n            eq(payroll.month, month),\n            eq(payroll.year, year)\n          )\n        )\n        .where(eq(employees.status, \"active\"));\n\n      // Calculate totals using Decimal.js with null-safe handling\n      const totalBasic = sumAmounts(salaryRecords.map(r => \n        r.payroll?.basicSalary || r.salaryStructure?.basicSalary || \"0\"\n      ));\n      const totalAllowances = sumAmounts(salaryRecords.map(r => \n        r.payroll?.totalAllowances || sumAmounts([\n          r.salaryStructure?.houseAllowance || \"0\",\n          r.salaryStructure?.foodAllowance || \"0\",\n          r.salaryStructure?.travelAllowance || \"0\",\n          r.salaryStructure?.medicalAllowance || \"0\",\n          r.salaryStructure?.otherAllowances || \"0\"\n        ])\n      ));\n      const totalOvertime = sumAmounts(salaryRecords.map(r => r.payroll?.overtimeAmount || \"0\"));\n      const totalDeductions = sumAmounts(\n        salaryRecords.flatMap(r => [\n          r.payroll?.loanDeduction || \"0\",\n          r.payroll?.lateDeduction || \"0\",\n          r.payroll?.otherDeductions || \"0\"\n        ])\n      );\n      const totalNetSalary = sumAmounts(salaryRecords.map(r => {\n        if (r.payroll?.netSalary) {\n          return r.payroll.netSalary;\n        }\n        const basic = r.salaryStructure?.basicSalary || \"0\";\n        const allowances = sumAmounts([\n          r.salaryStructure?.houseAllowance || \"0\",\n          r.salaryStructure?.foodAllowance || \"0\",\n          r.salaryStructure?.travelAllowance || \"0\",\n          r.salaryStructure?.medicalAllowance || \"0\",\n          r.salaryStructure?.otherAllowances || \"0\"\n        ]);\n        return sumAmounts([basic, allowances]);\n      }));\n      const totalEmployees = salaryRecords.length;\n\n      // ========== PROFESSIONAL PAYROLL PDF - A4 LANDSCAPE ==========\n      const doc = new PDFDocument({ \n        margin: 30, \n        size: 'A4', \n        layout: 'landscape', // Landscape for wide salary sheet\n        bufferPages: true \n      });\n\n      const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n\n      const pageWidth = 842; // A4 Landscape width\n      const pageHeight = 595; // A4 Landscape height\n      const margin = 30;\n      const contentWidth = pageWidth - (margin * 2);\n\n      // ========== PROFESSIONAL HEADER ==========\n      let currentY = margin;\n      \n      // Company Logo (Left)\n      try {\n        const logoPath = \"attached_assets/Untitled design (1)_1763794635122.png\";\n        doc.image(logoPath, margin, currentY, { width: 70, height: 35 });\n      } catch (error) {\n        console.warn(\"Logo not found:\", error);\n      }\n\n      // Company Info (Center)\n      const headerCenterX = margin + 120;\n      doc.fontSize(16).font(\"Helvetica-Bold\").fillColor(\"#E11D26\");\n      doc.text(\"MaxTech BD\", headerCenterX, currentY, { width: 500, align: \"center\" });\n      \n      doc.fontSize(9).font(\"Helvetica\").fillColor(\"#333333\");\n      doc.text(\"522, SK Mujib Road (4th Floor), Agrabad, Double Mooring, Chattogram, Bangladesh\", headerCenterX, currentY + 18, { width: 500, align: \"center\" });\n      doc.text(\"Phone: +8801843180008 | Email: info@maxtechbd.com\", headerCenterX, currentY + 30, { width: 500, align: \"center\" });\n\n      currentY += 50;\n      \n      // Separator line\n      doc.moveTo(margin, currentY).lineTo(pageWidth - margin, currentY).strokeColor(\"#E5E7EB\").lineWidth(1).stroke();\n      currentY += 15;\n\n      // Report Title\n      doc.fontSize(18).font(\"Helvetica-Bold\").fillColor(\"#1E1E1E\");\n      doc.text(`Salary Sheet  ${monthNames[month - 1]} ${year}`, margin, currentY, { width: contentWidth, align: \"center\" });\n      currentY += 25;\n\n      const now = new Date();\n      doc.fontSize(9).font(\"Helvetica\").fillColor(\"#999999\");\n      doc.text(`Generated on: ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}`, margin, currentY, { width: contentWidth, align: \"center\" });\n      currentY += 25;\n\n      // ========== COMPREHENSIVE SALARY TABLE ==========\n      const tableX = margin;\n      const tableWidth = contentWidth;\n      // Column widths for landscape A4 (782px total) - 19 columns\n      const colWidths = [\n        55,  // Emp Code\n        80,  // Name\n        45,  // Dept\n        50,  // Desig\n        40,  // Basic\n        35,  // HRA\n        35,  // Med\n        35,  // Conv\n        35,  // Other\n        45,  // Gross\n        30,  // Present\n        30,  // Absent\n        30,  // Late\n        30,  // Half\n        35,  // OT Hrs\n        40,  // Late Ded\n        40,  // Loan\n        40,  // Other Ded\n        52   // Net Pay\n      ];\n      const rowHeight = 22;\n      const cellPadding = 3;\n\n      // Helper function to draw table header\n      const drawTableHeader = (y: number): number => {\n        doc.rect(tableX, y, tableWidth, rowHeight).fillAndStroke(\"#E11D26\", \"#E11D26\");\n        \n        doc.fontSize(7).font(\"Helvetica-Bold\").fillColor(\"#FFFFFF\");\n        let headerX = tableX;\n        const headerY = y + 7;\n        \n        doc.text(\"Emp Code\", headerX + cellPadding, headerY, { width: colWidths[0] - (cellPadding * 2), lineBreak: false }); headerX += colWidths[0];\n        doc.text(\"Name\", headerX + cellPadding, headerY, { width: colWidths[1] - (cellPadding * 2), lineBreak: false }); headerX += colWidths[1];\n        doc.text(\"Dept\", headerX + cellPadding, headerY, { width: colWidths[2] - (cellPadding * 2), lineBreak: false }); headerX += colWidths[2];\n        doc.text(\"Desig\", headerX + cellPadding, headerY, { width: colWidths[3] - (cellPadding * 2), lineBreak: false }); headerX += colWidths[3];\n        doc.text(\"Basic\", headerX + cellPadding, headerY, { width: colWidths[4] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[4];\n        doc.text(\"HRA\", headerX + cellPadding, headerY, { width: colWidths[5] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[5];\n        doc.text(\"Med\", headerX + cellPadding, headerY, { width: colWidths[6] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[6];\n        doc.text(\"Conv\", headerX + cellPadding, headerY, { width: colWidths[7] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[7];\n        doc.text(\"Other\", headerX + cellPadding, headerY, { width: colWidths[8] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[8];\n        doc.text(\"Gross\", headerX + cellPadding, headerY, { width: colWidths[9] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[9];\n        doc.text(\"Pres\", headerX + cellPadding, headerY, { width: colWidths[10] - (cellPadding * 2), align: \"center\", lineBreak: false }); headerX += colWidths[10];\n        doc.text(\"Abs\", headerX + cellPadding, headerY, { width: colWidths[11] - (cellPadding * 2), align: \"center\", lineBreak: false }); headerX += colWidths[11];\n        doc.text(\"Late\", headerX + cellPadding, headerY, { width: colWidths[12] - (cellPadding * 2), align: \"center\", lineBreak: false }); headerX += colWidths[12];\n        doc.text(\"Half\", headerX + cellPadding, headerY, { width: colWidths[13] - (cellPadding * 2), align: \"center\", lineBreak: false }); headerX += colWidths[13];\n        doc.text(\"OT Hrs\", headerX + cellPadding, headerY, { width: colWidths[14] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[14];\n        doc.text(\"Late Ded\", headerX + cellPadding, headerY, { width: colWidths[15] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[15];\n        doc.text(\"Loan\", headerX + cellPadding, headerY, { width: colWidths[16] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[16];\n        doc.text(\"Oth Ded\", headerX + cellPadding, headerY, { width: colWidths[17] - (cellPadding * 2), align: \"right\", lineBreak: false }); headerX += colWidths[17];\n        doc.text(\"Net Pay\", headerX + cellPadding, headerY, { width: colWidths[18] - (cellPadding * 2), align: \"right\", lineBreak: false });\n        \n        return y + rowHeight;\n      };\n\n      // Draw table header\n      currentY = drawTableHeader(currentY);\n\n      // Employee rows with detailed breakdown\n      let isEven = false;\n      \n      // Calculate grand totals for all columns\n      let totalHRA = \"0\", totalMedical = \"0\", totalConv = \"0\", totalOtherAllow = \"0\", totalGross = \"0\";\n      let totalLateDeduct = \"0\", totalLoanDeduct = \"0\", totalOtherDeduct = \"0\";\n      let totalPresentDays = 0, totalAbsentDays = 0, totalLateDays = 0, totalHalfDays = 0;\n      let totalOTHours: number = 0;\n      \n      salaryRecords.forEach((record) => {\n        // Check if new page needed\n        if (currentY > pageHeight - 80) {\n          doc.addPage();\n          currentY = margin;\n          currentY = drawTableHeader(currentY);\n          isEven = false;\n        }\n\n        // Extract detailed salary components\n        const basicSalary = record.payroll?.basicSalary || record.salaryStructure?.basicSalary || \"0\";\n        const houseAllowance = record.salaryStructure?.houseAllowance || \"0\";\n        const medicalAllowance = record.salaryStructure?.medicalAllowance || \"0\";\n        const travelAllowance = record.salaryStructure?.travelAllowance || \"0\";\n        const otherAllowances = sumAmounts([\n          record.salaryStructure?.foodAllowance || \"0\",\n          record.salaryStructure?.otherAllowances || \"0\"\n        ]);\n        \n        const grossSalary = sumAmounts([basicSalary, houseAllowance, medicalAllowance, travelAllowance, otherAllowances]);\n        \n        // Attendance data\n        const presentDays = record.payroll?.totalPresentDays || 0;\n        const absentDays = record.payroll?.totalAbsentDays || 0;\n        const lateDays = record.payroll?.totalLateDays || 0;\n        const halfDays = record.payroll?.totalHalfDays || 0;\n        const otHours = Number(record.payroll?.totalOvertimeHours || 0);\n        \n        // Deductions breakdown\n        const lateDeduction = record.payroll?.lateDeduction || \"0\";\n        const loanDeduction = record.payroll?.loanDeduction || \"0\";\n        const otherDeductions = record.payroll?.otherDeductions || \"0\";\n        \n        const netSalary = record.payroll?.netSalary || sumAmounts([grossSalary, `-${lateDeduction}`, `-${loanDeduction}`, `-${otherDeductions}`]);\n\n        // Accumulate totals\n        totalHRA = sumAmounts([totalHRA, houseAllowance]);\n        totalMedical = sumAmounts([totalMedical, medicalAllowance]);\n        totalConv = sumAmounts([totalConv, travelAllowance]);\n        totalOtherAllow = sumAmounts([totalOtherAllow, otherAllowances]);\n        totalGross = sumAmounts([totalGross, grossSalary]);\n        totalLateDeduct = sumAmounts([totalLateDeduct, lateDeduction]);\n        totalLoanDeduct = sumAmounts([totalLoanDeduct, loanDeduction]);\n        totalOtherDeduct = sumAmounts([totalOtherDeduct, otherDeductions]);\n        totalPresentDays += presentDays;\n        totalAbsentDays += absentDays;\n        totalLateDays += lateDays;\n        totalHalfDays += halfDays;\n        totalOTHours += otHours;\n\n        // Draw row\n        const rowBg = isEven ? \"#F9F9F9\" : \"#FFFFFF\";\n        doc.rect(tableX, currentY, tableWidth, rowHeight).fillAndStroke(rowBg, \"#E5E7EB\");\n\n        doc.fontSize(7).font(\"Helvetica\").fillColor(\"#1E1E1E\");\n        let xPos = tableX;\n        const textY = currentY + 8;\n        \n        // Employee info\n        doc.text(record.employee?.employeeId || \"N/A\", xPos + cellPadding, textY, { width: colWidths[0] - (cellPadding * 2), lineBreak: false }); xPos += colWidths[0];\n        doc.text(record.user?.fullName || \"Unknown\", xPos + cellPadding, textY, { width: colWidths[1] - (cellPadding * 2), lineBreak: false }); xPos += colWidths[1];\n        doc.text(record.department?.name || \"N/A\", xPos + cellPadding, textY, { width: colWidths[2] - (cellPadding * 2), lineBreak: false }); xPos += colWidths[2];\n        doc.text(record.designation?.title || \"N/A\", xPos + cellPadding, textY, { width: colWidths[3] - (cellPadding * 2), lineBreak: false }); xPos += colWidths[3];\n        \n        // Earnings (right-aligned, no currency prefix)\n        doc.text(formatCurrency(basicSalary, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[4] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[4];\n        doc.text(formatCurrency(houseAllowance, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[5] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[5];\n        doc.text(formatCurrency(medicalAllowance, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[6] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[6];\n        doc.text(formatCurrency(travelAllowance, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[7] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[7];\n        doc.text(formatCurrency(otherAllowances, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[8] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[8];\n        doc.font(\"Helvetica-Bold\");\n        doc.text(formatCurrency(grossSalary, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[9] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[9];\n        \n        // Attendance (center-aligned)\n        doc.font(\"Helvetica\");\n        doc.text(presentDays.toString(), xPos + cellPadding, textY, { width: colWidths[10] - (cellPadding * 2), align: \"center\", lineBreak: false }); xPos += colWidths[10];\n        doc.text(absentDays.toString(), xPos + cellPadding, textY, { width: colWidths[11] - (cellPadding * 2), align: \"center\", lineBreak: false }); xPos += colWidths[11];\n        doc.text(lateDays.toString(), xPos + cellPadding, textY, { width: colWidths[12] - (cellPadding * 2), align: \"center\", lineBreak: false }); xPos += colWidths[12];\n        doc.text(halfDays.toString(), xPos + cellPadding, textY, { width: colWidths[13] - (cellPadding * 2), align: \"center\", lineBreak: false }); xPos += colWidths[13];\n        doc.text(otHours.toFixed(2), xPos + cellPadding, textY, { width: colWidths[14] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[14];\n        \n        // Deductions (right-aligned, no currency prefix)\n        doc.text(formatCurrency(lateDeduction, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[15] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[15];\n        doc.text(formatCurrency(loanDeduction, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[16] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[16];\n        doc.text(formatCurrency(otherDeductions, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[17] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[17];\n        \n        // Net Pay (bold, right-aligned, no currency prefix)\n        doc.font(\"Helvetica-Bold\").fillColor(\"#E11D26\");\n        doc.text(formatCurrency(netSalary, { prefix: '' }), xPos + cellPadding, textY, { width: colWidths[18] - (cellPadding * 2), align: \"right\", lineBreak: false });\n\n        currentY += rowHeight;\n        isEven = !isEven;\n      });\n\n      // ========== TOTALS ROW ==========\n      doc.rect(tableX, currentY, tableWidth, rowHeight + 2).fillAndStroke(\"#FFF9E6\", \"#E11D26\");\n\n      doc.fontSize(8).font(\"Helvetica-Bold\").fillColor(\"#1E1E1E\");\n      let xPos = tableX;\n      const totalsY = currentY + 9;\n      \n      doc.text(\"TOTALS\", xPos + cellPadding, totalsY, { width: colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] - (cellPadding * 2), lineBreak: false }); \n      xPos += colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3];\n      \n      doc.text(formatCurrency(totalBasic, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[4] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[4];\n      doc.text(formatCurrency(totalHRA, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[5] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[5];\n      doc.text(formatCurrency(totalMedical, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[6] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[6];\n      doc.text(formatCurrency(totalConv, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[7] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[7];\n      doc.text(formatCurrency(totalOtherAllow, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[8] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[8];\n      doc.fillColor(\"#E11D26\");\n      doc.text(formatCurrency(totalGross, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[9] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[9];\n      \n      doc.fillColor(\"#1E1E1E\");\n      doc.text(totalPresentDays.toString(), xPos + cellPadding, totalsY, { width: colWidths[10] - (cellPadding * 2), align: \"center\", lineBreak: false }); xPos += colWidths[10];\n      doc.text(totalAbsentDays.toString(), xPos + cellPadding, totalsY, { width: colWidths[11] - (cellPadding * 2), align: \"center\", lineBreak: false }); xPos += colWidths[11];\n      doc.text(totalLateDays.toString(), xPos + cellPadding, totalsY, { width: colWidths[12] - (cellPadding * 2), align: \"center\", lineBreak: false }); xPos += colWidths[12];\n      doc.text(totalHalfDays.toString(), xPos + cellPadding, totalsY, { width: colWidths[13] - (cellPadding * 2), align: \"center\", lineBreak: false }); xPos += colWidths[13];\n      doc.text(totalOTHours.toFixed(2), xPos + cellPadding, totalsY, { width: colWidths[14] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[14];\n      \n      doc.text(formatCurrency(totalLateDeduct, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[15] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[15];\n      doc.text(formatCurrency(totalLoanDeduct, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[16] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[16];\n      doc.text(formatCurrency(totalOtherDeduct, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[17] - (cellPadding * 2), align: \"right\", lineBreak: false }); xPos += colWidths[17];\n      \n      doc.fillColor(\"#E11D26\").fontSize(9);\n      doc.text(formatCurrency(totalNetSalary, { prefix: '' }), xPos + cellPadding, totalsY, { width: colWidths[18] - (cellPadding * 2), align: \"right\", lineBreak: false });\n\n      currentY += rowHeight + 2;\n\n      // ========== SIGNATURE SECTION ==========\n      currentY += 20;\n      \n      // Three signature lines\n      const signatureLineWidth = 150;\n      const sectionWidth = contentWidth / 3;\n      \n      const sig1X = margin + (sectionWidth / 2) - (signatureLineWidth / 2);\n      const sig2X = margin + sectionWidth + (sectionWidth / 2) - (signatureLineWidth / 2);\n      const sig3X = margin + (sectionWidth * 2) + (sectionWidth / 2) - (signatureLineWidth / 2);\n\n      // Draw signature lines\n      doc.strokeColor(\"#333333\").lineWidth(1);\n      doc.moveTo(sig1X, currentY).lineTo(sig1X + signatureLineWidth, currentY).stroke();\n      doc.moveTo(sig2X, currentY).lineTo(sig2X + signatureLineWidth, currentY).stroke();\n      doc.moveTo(sig3X, currentY).lineTo(sig3X + signatureLineWidth, currentY).stroke();\n\n      // Signature labels\n      doc.fontSize(10).font(\"Helvetica\").fillColor(\"#333333\");\n      doc.text(\"Prepared By\", sig1X, currentY + 10, { width: signatureLineWidth, align: \"center\", lineBreak: false });\n      doc.text(\"Verified By\", sig2X, currentY + 10, { width: signatureLineWidth, align: \"center\", lineBreak: false });\n      doc.text(\"Approved By\", sig3X, currentY + 10, { width: signatureLineWidth, align: \"center\", lineBreak: false });\n\n      currentY += 40;\n\n      // ========== FOOTER ==========\n      doc.moveTo(margin, currentY).lineTo(pageWidth - margin, currentY).strokeColor(\"#E5E7EB\").lineWidth(1).stroke();\n      \n      doc.fontSize(8).font(\"Helvetica\").fillColor(\"#999999\");\n      doc.text(\n        \"MaxTech BD | Smart Agency Control Hub\",\n        margin, currentY + 8, { width: contentWidth, align: \"center\", lineBreak: false }\n      );\n\n      // Stream to response\n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Salary-Sheet-${month}-${year}.pdf`);\n\n      doc.pipe(res);\n      doc.end();\n    } catch (error: any) {\n      console.error(\"Salary Sheet PDF export error:\", error);\n      res.status(500).json({ error: \"Failed to export PDF\" });\n    }\n  });\n\n  // Salary Sheet Excel Export\n  app.get(\"/api/salary-sheet/export-excel\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export Salary Sheet\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      // Validate month and year - check for NaN FIRST before any other validation\n      if (isNaN(month) || isNaN(year) || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Valid month and year are required\" });\n      }\n\n      if (month < 1 || month > 12 || year < 2000 || year > 2100) {\n        return res.status(400).json({ error: \"Month must be 1-12 and year must be 2000-2100\" });\n      }\n\n      // Fetch ALL employees with salary structures\n      const salaryRecords = await db\n        .select({\n          employee: employees,\n          user: users,\n          department: departments,\n          designation: designations,\n          salaryStructure: salaryStructure,\n          payroll: payroll,\n        })\n        .from(employees)\n        .innerJoin(users, eq(employees.userId, users.id))\n        .innerJoin(salaryStructure, eq(salaryStructure.employeeId, employees.id))\n        .leftJoin(departments, eq(employees.departmentId, departments.id))\n        .leftJoin(designations, eq(employees.designationId, designations.id))\n        .leftJoin(\n          payroll,\n          and(\n            eq(payroll.employeeId, employees.id),\n            eq(payroll.month, month),\n            eq(payroll.year, year)\n          )\n        )\n        .where(eq(employees.status, \"active\"));\n\n      // Calculate totals\n      const totalBasic = sumAmounts(salaryRecords.map(r => \n        r.payroll?.basicSalary || r.salaryStructure?.basicSalary || \"0\"\n      ));\n      const totalAllowances = sumAmounts(salaryRecords.map(r => \n        r.payroll?.totalAllowances || sumAmounts([\n          r.salaryStructure?.houseAllowance || \"0\",\n          r.salaryStructure?.foodAllowance || \"0\",\n          r.salaryStructure?.travelAllowance || \"0\",\n          r.salaryStructure?.medicalAllowance || \"0\",\n          r.salaryStructure?.otherAllowances || \"0\"\n        ])\n      ));\n      const totalDeductions = sumAmounts(\n        salaryRecords.flatMap(r => [\n          r.payroll?.loanDeduction || \"0\",\n          r.payroll?.lateDeduction || \"0\",\n          r.payroll?.otherDeductions || \"0\"\n        ])\n      );\n      const totalOvertime = sumAmounts(salaryRecords.map(r => r.payroll?.overtimeAmount || \"0\"));\n      const totalNetSalary = sumAmounts(salaryRecords.map(r => {\n        if (r.payroll?.netSalary) {\n          return r.payroll.netSalary;\n        }\n        const basic = r.salaryStructure?.basicSalary || \"0\";\n        const allowances = sumAmounts([\n          r.salaryStructure?.houseAllowance || \"0\",\n          r.salaryStructure?.foodAllowance || \"0\",\n          r.salaryStructure?.travelAllowance || \"0\",\n          r.salaryStructure?.medicalAllowance || \"0\",\n          r.salaryStructure?.otherAllowances || \"0\"\n        ]);\n        return sumAmounts([basic, allowances]);\n      }));\n\n      // Create Excel workbook\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Salary Sheet\");\n\n      // Set column widths\n      worksheet.columns = [\n        { width: 25 },  // Employee Name\n        { width: 15 },  // Employee ID\n        { width: 18 },  // Department\n        { width: 18 },  // Designation\n        { width: 15 },  // Basic Salary\n        { width: 15 },  // Allowances\n        { width: 15 },  // Deductions\n        { width: 15 },  // Overtime\n        { width: 16 },  // Net Salary\n        { width: 15 }   // Status\n      ];\n\n      // Add header with branding\n      const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n      \n      worksheet.mergeCells('A1:J1');\n      const titleRow = worksheet.getCell('A1');\n      titleRow.value = COMPANY_INFO.name;\n      titleRow.font = { name: 'Arial', size: 16, bold: true, color: { argb: 'FFE11D26' } };\n      titleRow.alignment = { horizontal: 'center', vertical: 'middle' };\n\n      worksheet.mergeCells('A2:J2');\n      const addressRow = worksheet.getCell('A2');\n      addressRow.value = `${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`;\n      addressRow.font = { name: 'Arial', size: 10 };\n      addressRow.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A3:J3');\n      const contactRow = worksheet.getCell('A3');\n      contactRow.value = `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`;\n      contactRow.font = { name: 'Arial', size: 10 };\n      contactRow.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A5:J5');\n      const reportTitleRow = worksheet.getCell('A5');\n      reportTitleRow.value = `Salary Sheet - ${monthNames[month - 1]} ${year}`;\n      reportTitleRow.font = { name: 'Arial', size: 14, bold: true };\n      reportTitleRow.alignment = { horizontal: 'center' };\n\n      // Add column headers\n      const headerRow = worksheet.addRow([\n        'Employee Name', 'Employee ID', 'Department', 'Designation', \n        'Basic Salary', 'Allowances', 'Deductions', 'Overtime', 'Net Salary', 'Payment Status'\n      ]);\n      headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      headerRow.fill = {\n        type: 'pattern',\n        pattern: 'solid',\n        fgColor: { argb: 'FFE11D26' }\n      };\n      headerRow.alignment = { horizontal: 'center', vertical: 'middle' };\n      headerRow.height = 22;\n\n      // Add data rows\n      salaryRecords.forEach((record) => {\n        const basicSalary = record.payroll?.basicSalary || record.salaryStructure?.basicSalary || \"0\";\n        const allowances = record.payroll?.totalAllowances || sumAmounts([\n          record.salaryStructure?.houseAllowance || \"0\",\n          record.salaryStructure?.foodAllowance || \"0\",\n          record.salaryStructure?.travelAllowance || \"0\",\n          record.salaryStructure?.medicalAllowance || \"0\",\n          record.salaryStructure?.otherAllowances || \"0\"\n        ]);\n        const overtime = record.payroll?.overtimeAmount || \"0\";\n        const deductions = sumAmounts([\n          record.payroll?.loanDeduction || \"0\",\n          record.payroll?.lateDeduction || \"0\",\n          record.payroll?.otherDeductions || \"0\"\n        ]);\n        const netSalary = record.payroll?.netSalary || sumAmounts([basicSalary, allowances, overtime, `-${deductions}`]);\n        const status = record.payroll?.status || \"Not Generated\";\n\n        const row = worksheet.addRow([\n          record.user?.fullName || \"Unknown\",\n          record.employee?.employeeId || \"N/A\",\n          record.department?.name || \"N/A\",\n          record.designation?.title || \"N/A\",\n          parseFloat(basicSalary),\n          parseFloat(allowances),\n          parseFloat(deductions),\n          parseFloat(overtime),\n          parseFloat(netSalary),\n          status\n        ]);\n\n        // Format currency cells\n        row.getCell(5).numFmt = '#,##0.00';\n        row.getCell(6).numFmt = '#,##0.00';\n        row.getCell(7).numFmt = '#,##0.00';\n        row.getCell(8).numFmt = '#,##0.00';\n        row.getCell(9).numFmt = '#,##0.00';\n        row.getCell(9).font = { bold: true };\n      });\n\n      // Add totals row\n      const totalsRow = worksheet.addRow([\n        'TOTAL',\n        '',\n        '',\n        '',\n        parseFloat(totalBasic),\n        parseFloat(totalAllowances),\n        parseFloat(totalDeductions),\n        parseFloat(totalOvertime),\n        parseFloat(totalNetSalary),\n        ''\n      ]);\n      totalsRow.font = { bold: true };\n      totalsRow.fill = {\n        type: 'pattern',\n        pattern: 'solid',\n        fgColor: { argb: 'FFE8E8E8' }\n      };\n      totalsRow.getCell(5).numFmt = '#,##0.00';\n      totalsRow.getCell(6).numFmt = '#,##0.00';\n      totalsRow.getCell(7).numFmt = '#,##0.00';\n      totalsRow.getCell(8).numFmt = '#,##0.00';\n      totalsRow.getCell(9).numFmt = '#,##0.00';\n\n      // Set response headers\n      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n      res.setHeader('Content-Disposition', `attachment; filename=Salary-Sheet-${month}-${year}.xlsx`);\n\n      // Write to response\n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error: any) {\n      console.error(\"Salary Sheet Excel export error:\", error);\n      res.status(500).json({ error: \"Failed to export Excel\" });\n    }\n  });\n\n  // Salary Sheet Word Export\n  app.get(\"/api/salary-sheet/export-word\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export Salary Sheet\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      // Validate month and year - check for NaN FIRST before any other validation\n      if (isNaN(month) || isNaN(year) || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Valid month and year are required\" });\n      }\n\n      if (month < 1 || month > 12 || year < 2000 || year > 2100) {\n        return res.status(400).json({ error: \"Month must be 1-12 and year must be 2000-2100\" });\n      }\n\n      // Fetch ALL employees with salary structures\n      const salaryRecords = await db\n        .select({\n          employee: employees,\n          user: users,\n          department: departments,\n          designation: designations,\n          salaryStructure: salaryStructure,\n          payroll: payroll,\n        })\n        .from(employees)\n        .innerJoin(users, eq(employees.userId, users.id))\n        .innerJoin(salaryStructure, eq(salaryStructure.employeeId, employees.id))\n        .leftJoin(departments, eq(employees.departmentId, departments.id))\n        .leftJoin(designations, eq(employees.designationId, designations.id))\n        .leftJoin(\n          payroll,\n          and(\n            eq(payroll.employeeId, employees.id),\n            eq(payroll.month, month),\n            eq(payroll.year, year)\n          )\n        )\n        .where(eq(employees.status, \"active\"));\n\n      // Calculate totals\n      const totalEmployees = salaryRecords.length;\n      const totalBasic = sumAmounts(salaryRecords.map(r => \n        r.payroll?.basicSalary || r.salaryStructure?.basicSalary || \"0\"\n      ));\n      const totalAllowances = sumAmounts(salaryRecords.map(r => \n        r.payroll?.totalAllowances || sumAmounts([\n          r.salaryStructure?.houseAllowance || \"0\",\n          r.salaryStructure?.foodAllowance || \"0\",\n          r.salaryStructure?.travelAllowance || \"0\",\n          r.salaryStructure?.medicalAllowance || \"0\",\n          r.salaryStructure?.otherAllowances || \"0\"\n        ])\n      ));\n      const totalDeductions = sumAmounts(\n        salaryRecords.flatMap(r => [\n          r.payroll?.loanDeduction || \"0\",\n          r.payroll?.lateDeduction || \"0\",\n          r.payroll?.otherDeductions || \"0\"\n        ])\n      );\n      const totalNetSalary = sumAmounts(salaryRecords.map(r => {\n        if (r.payroll?.netSalary) {\n          return r.payroll.netSalary;\n        }\n        const basic = r.salaryStructure?.basicSalary || \"0\";\n        const allowances = sumAmounts([\n          r.salaryStructure?.houseAllowance || \"0\",\n          r.salaryStructure?.foodAllowance || \"0\",\n          r.salaryStructure?.travelAllowance || \"0\",\n          r.salaryStructure?.medicalAllowance || \"0\",\n          r.salaryStructure?.otherAllowances || \"0\"\n        ]);\n        return sumAmounts([basic, allowances]);\n      }));\n\n      const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n\n      // Create Word document\n      const { Document, Paragraph, TextRun, Table, TableCell, TableRow, WidthType, AlignmentType, BorderStyle, ShadingType } = await import(\"docx\");\n\n      const doc = new Document({\n        sections: [{\n          properties: {},\n          children: [\n            // Header\n            new Paragraph({\n              children: [new TextRun({ text: COMPANY_INFO.name, bold: true, size: 32, color: \"E11D26\" })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 50 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 300 }\n            }),\n\n            // Title\n            new Paragraph({\n              children: [new TextRun({ text: `Salary Sheet - ${monthNames[month - 1]} ${year}`, bold: true, size: 28 })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n\n            // Summary Section\n            new Paragraph({\n              children: [new TextRun({ text: \"Summary\", bold: true, size: 22 })],\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Total Employees: ${totalEmployees}`,\n              spacing: { after: 50 }\n            }),\n            new Paragraph({\n              text: `Total Basic Salary: ${formatCurrency(totalBasic)}`,\n              spacing: { after: 50 }\n            }),\n            new Paragraph({\n              text: `Total Allowances: ${formatCurrency(totalAllowances)}`,\n              spacing: { after: 50 }\n            }),\n            new Paragraph({\n              text: `Total Deductions: ${formatCurrency(totalDeductions)}`,\n              spacing: { after: 50 }\n            }),\n            new Paragraph({\n              children: [new TextRun({ text: `Total Net Payable: ${formatCurrency(totalNetSalary)}`, bold: true, size: 24 })],\n              spacing: { after: 300 }\n            }),\n\n            // Salary table\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                // Header row\n                new TableRow({\n                  children: [\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Name\", bold: true, color: \"FFFFFF\" })], alignment: AlignmentType.LEFT })],\n                      width: { size: 15, type: WidthType.PERCENTAGE },\n                      shading: { fill: \"E11D26\", type: ShadingType.SOLID }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Emp ID\", bold: true, color: \"FFFFFF\" })], alignment: AlignmentType.LEFT })],\n                      width: { size: 10, type: WidthType.PERCENTAGE },\n                      shading: { fill: \"E11D26\", type: ShadingType.SOLID }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Dept\", bold: true, color: \"FFFFFF\" })], alignment: AlignmentType.LEFT })],\n                      width: { size: 12, type: WidthType.PERCENTAGE },\n                      shading: { fill: \"E11D26\", type: ShadingType.SOLID }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Desig\", bold: true, color: \"FFFFFF\" })], alignment: AlignmentType.LEFT })],\n                      width: { size: 12, type: WidthType.PERCENTAGE },\n                      shading: { fill: \"E11D26\", type: ShadingType.SOLID }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Basic\", bold: true, color: \"FFFFFF\" })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 10, type: WidthType.PERCENTAGE },\n                      shading: { fill: \"E11D26\", type: ShadingType.SOLID }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Allowances\", bold: true, color: \"FFFFFF\" })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 12, type: WidthType.PERCENTAGE },\n                      shading: { fill: \"E11D26\", type: ShadingType.SOLID }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Deductions\", bold: true, color: \"FFFFFF\" })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 12, type: WidthType.PERCENTAGE },\n                      shading: { fill: \"E11D26\", type: ShadingType.SOLID }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Net Salary\", bold: true, color: \"FFFFFF\" })], alignment: AlignmentType.RIGHT })],\n                      width: { size: 12, type: WidthType.PERCENTAGE },\n                      shading: { fill: \"E11D26\", type: ShadingType.SOLID }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ children: [new TextRun({ text: \"Status\", bold: true, color: \"FFFFFF\" })], alignment: AlignmentType.CENTER })],\n                      width: { size: 10, type: WidthType.PERCENTAGE },\n                      shading: { fill: \"E11D26\", type: ShadingType.SOLID }\n                    })\n                  ]\n                }),\n                // Data rows\n                ...salaryRecords.map(record => {\n                  const basicSalary = record.payroll?.basicSalary || record.salaryStructure?.basicSalary || \"0\";\n                  const allowances = record.payroll?.totalAllowances || sumAmounts([\n                    record.salaryStructure?.houseAllowance || \"0\",\n                    record.salaryStructure?.foodAllowance || \"0\",\n                    record.salaryStructure?.travelAllowance || \"0\",\n                    record.salaryStructure?.medicalAllowance || \"0\",\n                    record.salaryStructure?.otherAllowances || \"0\"\n                  ]);\n                  const deductions = sumAmounts([\n                    record.payroll?.loanDeduction || \"0\",\n                    record.payroll?.lateDeduction || \"0\",\n                    record.payroll?.otherDeductions || \"0\"\n                  ]);\n                  const netSalary = record.payroll?.netSalary || sumAmounts([basicSalary, allowances, `-${deductions}`]);\n                  const status = record.payroll?.status || \"Not Generated\";\n\n                  return new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph({ text: record.user?.fullName || \"Unknown\", alignment: AlignmentType.LEFT })] }),\n                      new TableCell({ children: [new Paragraph({ text: record.employee?.employeeId || \"N/A\", alignment: AlignmentType.LEFT })] }),\n                      new TableCell({ children: [new Paragraph({ text: record.department?.name || \"N/A\", alignment: AlignmentType.LEFT })] }),\n                      new TableCell({ children: [new Paragraph({ text: record.designation?.title || \"N/A\", alignment: AlignmentType.LEFT })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(basicSalary), alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(allowances), alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(deductions), alignment: AlignmentType.RIGHT })] }),\n                      new TableCell({ children: [new Paragraph({ \n                        children: [new TextRun({ \n                          text: formatCurrency(netSalary), \n                          bold: true\n                        })], \n                        alignment: AlignmentType.RIGHT \n                      })] }),\n                      new TableCell({ children: [new Paragraph({ text: status, alignment: AlignmentType.CENTER })] })\n                    ]\n                  });\n                })\n              ]\n            }),\n\n            // Signature Section\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 600, after: 400 }\n            }),\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } },\n              rows: [\n                new TableRow({\n                  children: [\n                    new TableCell({\n                      children: [\n                        new Paragraph({ text: \"__________________\", alignment: AlignmentType.CENTER }),\n                        new Paragraph({ text: \"Prepared By\", alignment: AlignmentType.CENTER })\n                      ],\n                      borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } },\n                      width: { size: 33, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [\n                        new Paragraph({ text: \"__________________\", alignment: AlignmentType.CENTER }),\n                        new Paragraph({ text: \"Verified By\", alignment: AlignmentType.CENTER })\n                      ],\n                      borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } },\n                      width: { size: 33, type: WidthType.PERCENTAGE }\n                    }),\n                    new TableCell({\n                      children: [\n                        new Paragraph({ text: \"__________________\", alignment: AlignmentType.CENTER }),\n                        new Paragraph({ text: \"Approved By\", alignment: AlignmentType.CENTER })\n                      ],\n                      borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } },\n                      width: { size: 33, type: WidthType.PERCENTAGE }\n                    })\n                  ]\n                })\n              ]\n            }),\n\n            // Footer\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 400 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.name} | ${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER\n            })\n          ]\n        }]\n      });\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Salary-Sheet-${month}-${year}.docx`);\n\n      // Write to response using Packer\n      const { Packer } = await import(\"docx\");\n      const buffer = await Packer.toBuffer(doc);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Salary Sheet Word export error:\", error);\n      res.status(500).json({ error: \"Failed to export Word document\" });\n    }\n  });\n\n  // Salary Slip (Individual Employee)\n  app.get(\"/api/salary-slip\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access salary slips\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const employeeId = req.query.employeeId as string;\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      if (!employeeId || !month || !year) {\n        return res.status(400).json({ error: \"Missing required parameters\" });\n      }\n\n      if (!Number.isInteger(month) || month < 1 || month > 12) {\n        return res.status(400).json({ error: \"Invalid month\" });\n      }\n\n      if (!Number.isInteger(year) || year < 2020 || year > 2100) {\n        return res.status(400).json({ error: \"Invalid year\" });\n      }\n\n      // Fetch employee with relations\n      const [employee] = await db.select({\n        id: employees.id,\n        employeeId: employees.employeeId,\n        userId: employees.userId,\n        departmentId: employees.departmentId,\n        designationId: employees.designationId,\n        user: {\n          id: users.id,\n          fullName: users.fullName\n        },\n        department: {\n          id: departments.id,\n          name: departments.name\n        },\n        designation: {\n          id: designations.id,\n          title: designations.title\n        }\n      })\n        .from(employees)\n        .leftJoin(users, eq(employees.userId, users.id))\n        .leftJoin(departments, eq(employees.departmentId, departments.id))\n        .leftJoin(designations, eq(employees.designationId, designations.id))\n        .where(eq(employees.id, employeeId))\n        .limit(1);\n\n      if (!employee) {\n        return res.status(404).json({ error: \"Employee not found\" });\n      }\n\n      // Fetch payroll record\n      const [payrollRecord] = await db.select()\n        .from(payroll)\n        .where(and(\n          eq(payroll.employeeId, employeeId),\n          eq(payroll.month, month),\n          eq(payroll.year, year)\n        ))\n        .limit(1);\n\n      if (!payrollRecord) {\n        return res.status(404).json({ error: \"No salary record found for this period\" });\n      }\n\n      // Fetch salary structure\n      const [salaryStructureRecord] = await db.select()\n        .from(salaryStructure)\n        .where(eq(salaryStructure.employeeId, employeeId))\n        .orderBy(desc(salaryStructure.effectiveFrom))\n        .limit(1);\n\n      res.json({\n        employee,\n        payroll: payrollRecord,\n        salaryStructure: salaryStructureRecord || null\n      });\n    } catch (error: any) {\n      console.error(\"Salary Slip fetch error:\", error);\n      res.status(500).json({ error: \"Failed to fetch salary slip\" });\n    }\n  });\n\n  // Salary Slip PDF Export\n  app.get(\"/api/salary-slip/export-pdf\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export salary slips\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const employeeId = req.query.employeeId as string;\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      if (!employeeId || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Invalid parameters\" });\n      }\n\n      // Fetch data\n      const [employee] = await db.select({\n        id: employees.id,\n        employeeId: employees.employeeId,\n        user: {\n          fullName: users.fullName\n        },\n        department: {\n          name: departments.name\n        },\n        designation: {\n          title: designations.title\n        }\n      })\n        .from(employees)\n        .leftJoin(users, eq(employees.userId, users.id))\n        .leftJoin(departments, eq(employees.departmentId, departments.id))\n        .leftJoin(designations, eq(employees.designationId, designations.id))\n        .where(eq(employees.id, employeeId))\n        .limit(1);\n\n      const [payrollRecord] = await db.select()\n        .from(payroll)\n        .where(and(\n          eq(payroll.employeeId, employeeId),\n          eq(payroll.month, month),\n          eq(payroll.year, year)\n        ))\n        .limit(1);\n\n      const [salaryStructureRecord] = await db.select()\n        .from(salaryStructure)\n        .where(eq(salaryStructure.employeeId, employeeId))\n        .orderBy(desc(salaryStructure.effectiveFrom))\n        .limit(1);\n\n      if (!employee || !payrollRecord) {\n        return res.status(404).json({ error: \"Salary slip not found\" });\n      }\n\n      const PDFDocument = (await import(\"pdfkit\")).default;\n      const doc = new PDFDocument({ margin: 40, size: \"A4\" });\n\n      const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n\n      // Compact header (no template - custom compact design)\n      // Header background\n      doc.rect(0, 0, 595, 70).fill(\"#F8F9FA\");\n      \n      // Company Logo (smaller)\n      try {\n        const path = await import(\"path\");\n        const logoPath = path.default.join(__dirname, \"../attached_assets/Untitled design (1)_1763794635122.png\");\n        doc.image(logoPath, 40, 15, { width: 50, height: 50 });\n      } catch (error) {\n        console.warn(\"Logo not found\");\n      }\n      \n      // Company name and info (compact - right side)\n      doc.fontSize(12).font(\"Helvetica-Bold\").fillColor(\"#E11D26\").text(\"MaxTech BD\", 400, 18, { width: 155, align: \"right\" });\n      doc.fontSize(7).font(\"Helvetica\").fillColor(\"#444444\")\n        .text(\"522, SK Mujib Road (4th Floor)\", 400, 32, { width: 155, align: \"right\" })\n        .text(\"Agrabad, Chattogram | +8801843180008\", 400, 42, { width: 155, align: \"right\" })\n        .text(\"info@maxtechbd.com\", 400, 52, { width: 155, align: \"right\" });\n\n      // Title centered\n      doc.fontSize(16).font(\"Helvetica-Bold\").fillColor(\"#1E1E1E\").text(\"SALARY SLIP\", 100, 25, { width: 280, align: \"center\" });\n      doc.fontSize(10).font(\"Helvetica\").fillColor(\"#444444\").text(`${monthNames[month - 1]} ${year}`, 100, 45, { width: 280, align: \"center\" });\n\n      let currentY = 80;\n\n      // Employee Information Section - 2 columns layout\n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(\"#E11D26\").text(\"Employee Information\", 40, currentY);\n      currentY += 15;\n\n      // Draw a light background box for employee info\n      doc.rect(40, currentY, 515, 50).fill(\"#FAFAFA\").stroke(\"#E5E7EB\");\n      currentY += 8;\n\n      const empInfoLeft = [\n        [\"Name:\", employee.user?.fullName || \"Unknown\"],\n        [\"Employee ID:\", employee.employeeId || \"N/A\"],\n        [\"Department:\", employee.department?.name || \"N/A\"]\n      ];\n      const empInfoRight = [\n        [\"Designation:\", employee.designation?.title || \"N/A\"],\n        [\"Working Days:\", `${payrollRecord.workingDays} days`],\n        [\"Status:\", payrollRecord.status || \"draft\"]\n      ];\n\n      empInfoLeft.forEach(([label, value], i) => {\n        doc.fontSize(8).font(\"Helvetica\").fillColor(\"#666666\").text(label, 50, currentY + i * 14, { width: 70 });\n        doc.font(\"Helvetica-Bold\").fillColor(\"#000000\").text(value, 120, currentY + i * 14, { width: 130 });\n      });\n\n      empInfoRight.forEach(([label, value], i) => {\n        doc.fontSize(8).font(\"Helvetica\").fillColor(\"#666666\").text(label, 300, currentY + i * 14, { width: 80 });\n        doc.font(\"Helvetica-Bold\").fillColor(\"#000000\").text(value, 375, currentY + i * 14, { width: 150 });\n      });\n\n      currentY += 55;\n\n      // Earnings and Deductions Side by Side\n      const leftX = 40;\n      const rightX = 300;\n      let leftY = currentY;\n      let rightY = currentY;\n\n      // Earnings Section Header\n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(\"#16a34a\").text(\"Earnings\", leftX, leftY);\n      leftY += 14;\n\n      const earnings = [[\"Basic Salary\", payrollRecord.basicSalary || \"0\"]];\n      if (salaryStructureRecord) {\n        earnings.push(\n          [\"House Allowance\", salaryStructureRecord.houseAllowance || \"0\"],\n          [\"Food Allowance\", salaryStructureRecord.foodAllowance || \"0\"],\n          [\"Travel Allowance\", salaryStructureRecord.travelAllowance || \"0\"],\n          [\"Medical Allowance\", salaryStructureRecord.medicalAllowance || \"0\"],\n          [\"Other Allowances\", salaryStructureRecord.otherAllowances || \"0\"]\n        );\n      }\n      earnings.push([\"Overtime Pay\", payrollRecord.overtimeAmount || \"0\"]);\n\n      const totalEarnings = new Decimal(payrollRecord.basicSalary || \"0\")\n        .plus(payrollRecord.totalAllowances || \"0\")\n        .plus(payrollRecord.overtimeAmount || \"0\")\n        .toFixed(2);\n\n      earnings.forEach(([label, amount]) => {\n        doc.fontSize(8).font(\"Helvetica\").fillColor(\"#000000\")\n          .text(label, leftX, leftY, { width: 130 })\n          .text(formatCurrency(amount), leftX + 130, leftY, { width: 80, align: \"right\" });\n        leftY += 14;\n      });\n\n      doc.fontSize(9).font(\"Helvetica-Bold\").fillColor(\"#16a34a\")\n        .text(\"Total Earnings\", leftX, leftY, { width: 130 })\n        .text(formatCurrency(totalEarnings), leftX + 130, leftY, { width: 80, align: \"right\" });\n      leftY += 16;\n\n      // Deductions Section Header\n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(\"#dc2626\").text(\"Deductions\", rightX, rightY);\n      rightY += 14;\n\n      const deductions = [\n        [\"Loan Deduction\", payrollRecord.loanDeduction || \"0\"],\n        [`Late Deduction (${payrollRecord.totalLateDays} days)`, payrollRecord.lateDeduction || \"0\"],\n        [\"Other Deductions\", payrollRecord.otherDeductions || \"0\"]\n      ];\n\n      const totalDeductions = new Decimal(payrollRecord.loanDeduction || \"0\")\n        .plus(payrollRecord.lateDeduction || \"0\")\n        .plus(payrollRecord.otherDeductions || \"0\")\n        .toFixed(2);\n\n      deductions.forEach(([label, amount]) => {\n        doc.fontSize(8).font(\"Helvetica\").fillColor(\"#000000\")\n          .text(label, rightX, rightY, { width: 140 })\n          .text(formatCurrency(amount), rightX + 140, rightY, { width: 80, align: \"right\" });\n        rightY += 14;\n      });\n\n      doc.fontSize(9).font(\"Helvetica-Bold\").fillColor(\"#dc2626\")\n        .text(\"Total Deductions\", rightX, rightY, { width: 140 })\n        .text(formatCurrency(totalDeductions), rightX + 140, rightY, { width: 80, align: \"right\" });\n\n      currentY = Math.max(leftY, rightY) + 15;\n\n      // Attendance Summary - single row\n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(\"#E11D26\").text(\"Attendance Summary\", 40, currentY);\n      currentY += 14;\n\n      const attData = [\n        [\"Present:\", (payrollRecord.totalPresentDays ?? 0).toString()],\n        [\"Absent:\", (payrollRecord.totalAbsentDays ?? 0).toString()],\n        [\"Late:\", (payrollRecord.totalLateDays ?? 0).toString()],\n        [\"OT Hours:\", payrollRecord.totalOvertimeHours || \"0\"]\n      ];\n      \n      attData.forEach(([label, value], i) => {\n        const xPos = 40 + i * 130;\n        doc.fontSize(8).font(\"Helvetica\").fillColor(\"#666666\").text(label, xPos, currentY, { width: 45 });\n        doc.font(\"Helvetica-Bold\").fillColor(\"#000000\").text(value, xPos + 45, currentY, { width: 70 });\n      });\n\n      currentY += 25;\n\n      // Net Salary Box (compact)\n      doc.rect(40, currentY, 515, 35).fillAndStroke(\"#E11D26\", \"#E11D26\");\n      doc.fontSize(12).fillColor(\"#FFFFFF\").font(\"Helvetica-Bold\")\n        .text(\"Net Salary:\", 55, currentY + 10)\n        .text(formatCurrency(payrollRecord.netSalary || \"0\"), 400, currentY + 10, { width: 140, align: \"right\" });\n\n      currentY += 50;\n\n      // Signature Section (compact)\n      doc.fontSize(9).fillColor(\"#000000\").font(\"Helvetica\")\n        .text(\"_____________________\", 80, currentY)\n        .text(\"Employee Signature\", 80, currentY + 12, { width: 120, align: \"center\" })\n        .text(\"_____________________\", 380, currentY)\n        .text(\"Authorized Signature\", 380, currentY + 12, { width: 120, align: \"center\" });\n\n      currentY += 40;\n\n      // Footer Note (compact)\n      doc.fontSize(7).fillColor(\"#888888\")\n        .text(\"This is a computer-generated salary slip and does not require a physical signature.\", 40, currentY, { width: 515, align: \"center\" })\n        .text(\"For any queries, please contact HR Department at info@maxtechbd.com\", 40, currentY + 10, { width: 515, align: \"center\" });\n\n      // Simple footer line\n      doc.moveTo(40, 780).lineTo(555, 780).strokeColor(\"#E5E7EB\").lineWidth(0.5).stroke();\n      doc.fontSize(7).fillColor(\"#888888\").text(\"MaxTech BD | Smart Agency Control Hub\", 40, 785, { width: 515, align: \"center\" });\n\n      // Stream to response\n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Salary-Slip-${employee.employeeId}-${month}-${year}.pdf`);\n\n      doc.pipe(res);\n      doc.end();\n    } catch (error: any) {\n      console.error(\"Salary Slip PDF export error:\", error);\n      res.status(500).json({ error: \"Failed to export PDF\" });\n    }\n  });\n\n  // Salary Slip Excel Export\n  app.get(\"/api/salary-slip/export-excel\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export salary slips\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const employeeId = req.query.employeeId as string;\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      if (!employeeId || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Invalid parameters\" });\n      }\n\n      // Fetch data (same as PDF)\n      const [employee] = await db.select({\n        id: employees.id,\n        employeeId: employees.employeeId,\n        user: { fullName: users.fullName },\n        department: { name: departments.name },\n        designation: { title: designations.title }\n      })\n        .from(employees)\n        .leftJoin(users, eq(employees.userId, users.id))\n        .leftJoin(departments, eq(employees.departmentId, departments.id))\n        .leftJoin(designations, eq(employees.designationId, designations.id))\n        .where(eq(employees.id, employeeId))\n        .limit(1);\n\n      const [payrollRecord] = await db.select()\n        .from(payroll)\n        .where(and(eq(payroll.employeeId, employeeId), eq(payroll.month, month), eq(payroll.year, year)))\n        .limit(1);\n\n      const [salaryStructureRecord] = await db.select()\n        .from(salaryStructure)\n        .where(eq(salaryStructure.employeeId, employeeId))\n        .orderBy(desc(salaryStructure.effectiveFrom))\n        .limit(1);\n\n      if (!employee || !payrollRecord) {\n        return res.status(404).json({ error: \"Salary slip not found\" });\n      }\n\n      const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n\n      const ExcelJS = (await import(\"exceljs\")).default;\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Salary Slip\");\n\n      // Set column widths\n      worksheet.columns = [\n        { width: 30 },\n        { width: 20 }\n      ];\n\n      // Add company header\n      worksheet.mergeCells('A1:B1');\n      const titleRow = worksheet.getCell('A1');\n      titleRow.value = COMPANY_INFO.name;\n      titleRow.font = { name: 'Arial', size: 16, bold: true, color: { argb: 'FFE11D26' } };\n      titleRow.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A2:B2');\n      const addressRow = worksheet.getCell('A2');\n      addressRow.value = `${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`;\n      addressRow.font = { name: 'Arial', size: 10 };\n      addressRow.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A3:B3');\n      const contactRow = worksheet.getCell('A3');\n      contactRow.value = `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`;\n      contactRow.font = { name: 'Arial', size: 10 };\n      contactRow.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A5:B5');\n      const slipTitleRow = worksheet.getCell('A5');\n      slipTitleRow.value = \"SALARY SLIP\";\n      slipTitleRow.font = { name: 'Arial', size: 14, bold: true };\n      slipTitleRow.alignment = { horizontal: 'center' };\n\n      worksheet.mergeCells('A6:B6');\n      const periodRow = worksheet.getCell('A6');\n      periodRow.value = `${monthNames[month - 1]} ${year}`;\n      periodRow.font = { name: 'Arial', size: 12 };\n      periodRow.alignment = { horizontal: 'center' };\n\n      let currentRow = 8;\n\n      // Employee Information\n      const empInfoHeader = worksheet.getRow(currentRow);\n      worksheet.mergeCells(`A${currentRow}:B${currentRow}`);\n      empInfoHeader.getCell(1).value = \"Employee Information\";\n      empInfoHeader.getCell(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      empInfoHeader.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE11D26' } };\n      currentRow++;\n\n      const empInfo = [\n        [\"Employee Name\", employee.user?.fullName || \"Unknown\"],\n        [\"Employee ID\", employee.employeeId || \"N/A\"],\n        [\"Department\", employee.department?.name || \"N/A\"],\n        [\"Designation\", employee.designation?.title || \"N/A\"],\n        [\"Working Days\", `${payrollRecord.workingDays} days`],\n        [\"Payment Status\", payrollRecord.status || \"draft\"]\n      ];\n\n      empInfo.forEach(([label, value]) => {\n        const row = worksheet.getRow(currentRow);\n        row.getCell(1).value = label;\n        row.getCell(1).font = { bold: true };\n        row.getCell(2).value = value;\n        currentRow++;\n      });\n\n      currentRow++;\n\n      // Earnings\n      const earningsHeader = worksheet.getRow(currentRow);\n      worksheet.mergeCells(`A${currentRow}:B${currentRow}`);\n      earningsHeader.getCell(1).value = \"Earnings\";\n      earningsHeader.getCell(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      earningsHeader.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF16A34A' } };\n      currentRow++;\n\n      const earnings = [\n        [\"Basic Salary\", parseFloat(payrollRecord.basicSalary || \"0\")],\n      ];\n\n      if (salaryStructureRecord) {\n        earnings.push(\n          [\"House Allowance\", parseFloat(salaryStructureRecord.houseAllowance || \"0\")],\n          [\"Food Allowance\", parseFloat(salaryStructureRecord.foodAllowance || \"0\")],\n          [\"Travel Allowance\", parseFloat(salaryStructureRecord.travelAllowance || \"0\")],\n          [\"Medical Allowance\", parseFloat(salaryStructureRecord.medicalAllowance || \"0\")],\n          [\"Other Allowances\", parseFloat(salaryStructureRecord.otherAllowances || \"0\")]\n        );\n      }\n\n      earnings.push([\"Overtime Pay\", parseFloat(payrollRecord.overtimeAmount || \"0\")]);\n\n      earnings.forEach(([label, amount]) => {\n        const row = worksheet.getRow(currentRow);\n        row.getCell(1).value = label;\n        row.getCell(2).value = amount;\n        row.getCell(2).numFmt = '#,##0.00';\n        currentRow++;\n      });\n\n      const totalEarnings = new Decimal(payrollRecord.basicSalary || \"0\")\n        .plus(payrollRecord.totalAllowances || \"0\")\n        .plus(payrollRecord.overtimeAmount || \"0\");\n\n      const totalEarningsRow = worksheet.getRow(currentRow);\n      totalEarningsRow.getCell(1).value = \"Total Earnings\";\n      totalEarningsRow.getCell(1).font = { bold: true };\n      totalEarningsRow.getCell(2).value = parseFloat(totalEarnings.toFixed(2));\n      totalEarningsRow.getCell(2).numFmt = '#,##0.00';\n      totalEarningsRow.getCell(2).font = { bold: true };\n      totalEarningsRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8E8E8' } };\n      currentRow++;\n      currentRow++;\n\n      // Deductions\n      const deductionsHeader = worksheet.getRow(currentRow);\n      worksheet.mergeCells(`A${currentRow}:B${currentRow}`);\n      deductionsHeader.getCell(1).value = \"Deductions\";\n      deductionsHeader.getCell(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      deductionsHeader.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFDC2626' } };\n      currentRow++;\n\n      const deductions = [\n        [\"Loan Deduction\", parseFloat(payrollRecord.loanDeduction || \"0\")],\n        [`Late Deduction (${payrollRecord.totalLateDays} days)`, parseFloat(payrollRecord.lateDeduction || \"0\")],\n        [\"Other Deductions\", parseFloat(payrollRecord.otherDeductions || \"0\")]\n      ];\n\n      deductions.forEach(([label, amount]) => {\n        const row = worksheet.getRow(currentRow);\n        row.getCell(1).value = label;\n        row.getCell(2).value = amount;\n        row.getCell(2).numFmt = '#,##0.00';\n        currentRow++;\n      });\n\n      const totalDeductions = new Decimal(payrollRecord.loanDeduction || \"0\")\n        .plus(payrollRecord.lateDeduction || \"0\")\n        .plus(payrollRecord.otherDeductions || \"0\");\n\n      const totalDeductionsRow = worksheet.getRow(currentRow);\n      totalDeductionsRow.getCell(1).value = \"Total Deductions\";\n      totalDeductionsRow.getCell(1).font = { bold: true };\n      totalDeductionsRow.getCell(2).value = parseFloat(totalDeductions.toFixed(2));\n      totalDeductionsRow.getCell(2).numFmt = '#,##0.00';\n      totalDeductionsRow.getCell(2).font = { bold: true };\n      totalDeductionsRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8E8E8' } };\n      currentRow++;\n      currentRow++;\n\n      // Attendance Summary\n      const attendanceHeader = worksheet.getRow(currentRow);\n      worksheet.mergeCells(`A${currentRow}:B${currentRow}`);\n      attendanceHeader.getCell(1).value = \"Attendance Summary\";\n      attendanceHeader.getCell(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };\n      attendanceHeader.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE11D26' } };\n      currentRow++;\n\n      const attendanceInfo = [\n        [\"Present Days\", payrollRecord.totalPresentDays ?? 0],\n        [\"Absent Days\", payrollRecord.totalAbsentDays ?? 0],\n        [\"Late Days\", payrollRecord.totalLateDays ?? 0],\n        [\"Overtime Hours\", payrollRecord.totalOvertimeHours || \"0\"]\n      ];\n\n      attendanceInfo.forEach(([label, value]) => {\n        const row = worksheet.getRow(currentRow);\n        row.getCell(1).value = label;\n        row.getCell(1).font = { bold: true };\n        row.getCell(2).value = value;\n        currentRow++;\n      });\n\n      currentRow++;\n\n      // Net Salary\n      const netSalaryRow = worksheet.getRow(currentRow);\n      netSalaryRow.getCell(1).value = \"NET SALARY\";\n      netSalaryRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FFFFFFFF' } };\n      netSalaryRow.getCell(2).value = parseFloat(payrollRecord.netSalary || \"0\");\n      netSalaryRow.getCell(2).numFmt = '#,##0.00';\n      netSalaryRow.getCell(2).font = { bold: true, size: 14, color: { argb: 'FFFFFFFF' } };\n      netSalaryRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE11D26' } };\n      netSalaryRow.height = 25;\n\n      // Write to buffer and send\n      const buffer = await workbook.xlsx.writeBuffer();\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Salary-Slip-${employee.employeeId}-${month}-${year}.xlsx`);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Salary Slip Excel export error:\", error);\n      res.status(500).json({ error: \"Failed to export Excel\" });\n    }\n  });\n\n  // Salary Slip Word Export\n  app.get(\"/api/salary-slip/export-word\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export salary slips\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const employeeId = req.query.employeeId as string;\n      const month = parseInt(req.query.month as string);\n      const year = parseInt(req.query.year as string);\n\n      if (!employeeId || !Number.isInteger(month) || !Number.isInteger(year)) {\n        return res.status(400).json({ error: \"Invalid parameters\" });\n      }\n\n      // Fetch data (same as PDF/Excel)\n      const [employee] = await db.select({\n        id: employees.id,\n        employeeId: employees.employeeId,\n        user: { fullName: users.fullName },\n        department: { name: departments.name },\n        designation: { title: designations.title }\n      })\n        .from(employees)\n        .leftJoin(users, eq(employees.userId, users.id))\n        .leftJoin(departments, eq(employees.departmentId, departments.id))\n        .leftJoin(designations, eq(employees.designationId, designations.id))\n        .where(eq(employees.id, employeeId))\n        .limit(1);\n\n      const [payrollRecord] = await db.select()\n        .from(payroll)\n        .where(and(eq(payroll.employeeId, employeeId), eq(payroll.month, month), eq(payroll.year, year)))\n        .limit(1);\n\n      const [salaryStructureRecord] = await db.select()\n        .from(salaryStructure)\n        .where(eq(salaryStructure.employeeId, employeeId))\n        .orderBy(desc(salaryStructure.effectiveFrom))\n        .limit(1);\n\n      if (!employee || !payrollRecord) {\n        return res.status(404).json({ error: \"Salary slip not found\" });\n      }\n\n      const monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n        \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n\n      const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle } = await import(\"docx\");\n\n      const totalEarnings = new Decimal(payrollRecord.basicSalary || \"0\")\n        .plus(payrollRecord.totalAllowances || \"0\")\n        .plus(payrollRecord.overtimeAmount || \"0\")\n        .toFixed(2);\n\n      const totalDeductions = new Decimal(payrollRecord.loanDeduction || \"0\")\n        .plus(payrollRecord.lateDeduction || \"0\")\n        .plus(payrollRecord.otherDeductions || \"0\")\n        .toFixed(2);\n\n      const doc = new Document({\n        sections: [{\n          properties: {},\n          children: [\n            // Header\n            new Paragraph({\n              children: [new TextRun({ text: COMPANY_INFO.name, bold: true, size: 32, color: \"E11D26\" })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 50 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              children: [new TextRun({ text: \"SALARY SLIP\", bold: true, size: 28 })],\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `${monthNames[month - 1]} ${year}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 300 }\n            }),\n\n            // Employee Information\n            new Paragraph({\n              children: [new TextRun({ text: \"Employee Information\", bold: true, color: \"E11D26\" })],\n              spacing: { after: 200 }\n            }),\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              borders: {\n                top: { style: BorderStyle.SINGLE, size: 1 },\n                bottom: { style: BorderStyle.SINGLE, size: 1 },\n                left: { style: BorderStyle.SINGLE, size: 1 },\n                right: { style: BorderStyle.SINGLE, size: 1 },\n              },\n              rows: [\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Employee Name\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: employee.user?.fullName || \"Unknown\" })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Employee ID\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: employee.employeeId || \"N/A\" })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Department\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: employee.department?.name || \"N/A\" })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Designation\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: employee.designation?.title || \"N/A\" })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Working Days\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: `${payrollRecord.workingDays} days` })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Payment Status\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: payrollRecord.status || \"draft\" })] })\n                  ]\n                })\n              ]\n            }),\n\n            // Spacing\n            new Paragraph({ text: \"\", spacing: { before: 300 } }),\n\n            // Earnings\n            new Paragraph({\n              children: [new TextRun({ text: \"Earnings\", bold: true, color: \"16A34A\" })],\n              spacing: { after: 200 }\n            }),\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ text: \"Basic Salary\" })] }),\n                    new TableCell({ children: [new Paragraph({ text: formatCurrency(payrollRecord.basicSalary || \"0\"), alignment: AlignmentType.RIGHT })] })\n                  ]\n                }),\n                ...(salaryStructureRecord ? [\n                  new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph({ text: \"House Allowance\" })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(salaryStructureRecord.houseAllowance || \"0\"), alignment: AlignmentType.RIGHT })] })\n                    ]\n                  }),\n                  new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph({ text: \"Food Allowance\" })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(salaryStructureRecord.foodAllowance || \"0\"), alignment: AlignmentType.RIGHT })] })\n                    ]\n                  }),\n                  new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph({ text: \"Travel Allowance\" })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(salaryStructureRecord.travelAllowance || \"0\"), alignment: AlignmentType.RIGHT })] })\n                    ]\n                  }),\n                  new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph({ text: \"Medical Allowance\" })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(salaryStructureRecord.medicalAllowance || \"0\"), alignment: AlignmentType.RIGHT })] })\n                    ]\n                  }),\n                  new TableRow({\n                    children: [\n                      new TableCell({ children: [new Paragraph({ text: \"Other Allowances\" })] }),\n                      new TableCell({ children: [new Paragraph({ text: formatCurrency(salaryStructureRecord.otherAllowances || \"0\"), alignment: AlignmentType.RIGHT })] })\n                    ]\n                  })\n                ] : []),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ text: \"Overtime Pay\" })] }),\n                    new TableCell({ children: [new Paragraph({ text: formatCurrency(payrollRecord.overtimeAmount || \"0\"), alignment: AlignmentType.RIGHT })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Total Earnings\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: formatCurrency(totalEarnings), bold: true })], alignment: AlignmentType.RIGHT })] })\n                  ]\n                })\n              ]\n            }),\n\n            // Spacing\n            new Paragraph({ text: \"\", spacing: { before: 300 } }),\n\n            // Deductions\n            new Paragraph({\n              children: [new TextRun({ text: \"Deductions\", bold: true, color: \"DC2626\" })],\n              spacing: { after: 200 }\n            }),\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ text: \"Loan Deduction\" })] }),\n                    new TableCell({ children: [new Paragraph({ text: formatCurrency(payrollRecord.loanDeduction || \"0\"), alignment: AlignmentType.RIGHT })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ text: `Late Deduction (${payrollRecord.totalLateDays} days)` })] }),\n                    new TableCell({ children: [new Paragraph({ text: formatCurrency(payrollRecord.lateDeduction || \"0\"), alignment: AlignmentType.RIGHT })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ text: \"Other Deductions\" })] }),\n                    new TableCell({ children: [new Paragraph({ text: formatCurrency(payrollRecord.otherDeductions || \"0\"), alignment: AlignmentType.RIGHT })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Total Deductions\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: formatCurrency(totalDeductions), bold: true })], alignment: AlignmentType.RIGHT })] })\n                  ]\n                })\n              ]\n            }),\n\n            // Spacing\n            new Paragraph({ text: \"\", spacing: { before: 300 } }),\n\n            // Attendance Summary\n            new Paragraph({\n              children: [new TextRun({ text: \"Attendance Summary\", bold: true, color: \"E11D26\" })],\n              spacing: { after: 200 }\n            }),\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Present Days\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: (payrollRecord.totalPresentDays ?? 0).toString() })] }),\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Absent Days\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: (payrollRecord.totalAbsentDays ?? 0).toString() })] })\n                  ]\n                }),\n                new TableRow({\n                  children: [\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Late Days\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: (payrollRecord.totalLateDays ?? 0).toString() })] }),\n                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: \"Overtime Hours\", bold: true })] })] }),\n                    new TableCell({ children: [new Paragraph({ text: payrollRecord.totalOvertimeHours || \"0\" })] })\n                  ]\n                })\n              ]\n            }),\n\n            // Spacing\n            new Paragraph({ text: \"\", spacing: { before: 400 } }),\n\n            // Net Salary\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                new TableRow({\n                  children: [\n                    new TableCell({ \n                      children: [new Paragraph({ children: [new TextRun({ text: \"NET SALARY\", bold: true, size: 28, color: \"FFFFFF\" })], alignment: AlignmentType.LEFT })],\n                      shading: { fill: \"E11D26\" }\n                    }),\n                    new TableCell({ \n                      children: [new Paragraph({ children: [new TextRun({ text: formatCurrency(payrollRecord.netSalary || \"0\"), bold: true, size: 28, color: \"FFFFFF\" })], alignment: AlignmentType.RIGHT })],\n                      shading: { fill: \"E11D26\" }\n                    })\n                  ]\n                })\n              ]\n            }),\n\n            // Spacing\n            new Paragraph({ text: \"\", spacing: { before: 600 } }),\n\n            // Signature Section\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              borders: {\n                top: { style: BorderStyle.NONE },\n                bottom: { style: BorderStyle.NONE },\n                left: { style: BorderStyle.NONE },\n                right: { style: BorderStyle.NONE },\n                insideHorizontal: { style: BorderStyle.NONE },\n                insideVertical: { style: BorderStyle.NONE }\n              },\n              rows: [\n                new TableRow({\n                  children: [\n                    new TableCell({ \n                      children: [\n                        new Paragraph({ text: \"_____________________\", alignment: AlignmentType.CENTER, spacing: { before: 600 } }),\n                        new Paragraph({ text: \"Employee Signature\", alignment: AlignmentType.CENTER, spacing: { before: 100 } })\n                      ],\n                      borders: {\n                        top: { style: BorderStyle.NONE },\n                        bottom: { style: BorderStyle.NONE },\n                        left: { style: BorderStyle.NONE },\n                        right: { style: BorderStyle.NONE }\n                      }\n                    }),\n                    new TableCell({ \n                      children: [\n                        new Paragraph({ text: \"_____________________\", alignment: AlignmentType.CENTER, spacing: { before: 600 } }),\n                        new Paragraph({ text: \"Authorized Signature\", alignment: AlignmentType.CENTER, spacing: { before: 100 } })\n                      ],\n                      borders: {\n                        top: { style: BorderStyle.NONE },\n                        bottom: { style: BorderStyle.NONE },\n                        left: { style: BorderStyle.NONE },\n                        right: { style: BorderStyle.NONE }\n                      }\n                    })\n                  ]\n                })\n              ]\n            }),\n\n            // Footer\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 400 }\n            }),\n            new Paragraph({\n              text: \"This is a computer-generated salary slip and does not require a physical signature.\",\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: \"For any queries, please contact HR Department at info@maxtechbd.com\",\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: `${COMPANY_INFO.name} | ${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n              alignment: AlignmentType.CENTER\n            })\n          ]\n        }]\n      });\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Salary-Slip-${employee.employeeId}-${month}-${year}.docx`);\n\n      // Write to response using Packer\n      const { Packer } = await import(\"docx\");\n      const buffer = await Packer.toBuffer(doc);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Salary Slip Word export error:\", error);\n      res.status(500).json({ error: \"Failed to export Word document\" });\n    }\n  });\n\n  // Payments\n  app.get(\"/api/payments\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      let allPayments: any[] = [];\n      if (req.userRole === \"client\") {\n        // Get user's client ID\n        const [user] = await db.select().from(users).where(eq(users.id, req.userId!)).limit(1);\n        if (!user?.clientId) {\n          return res.status(403).json({ error: \"No client associated with this account\" });\n        }\n        \n        // Get all invoices for this client first\n        const clientInvoices = await db.select().from(invoices).where(eq(invoices.clientId, user.clientId));\n        const invoiceIds = clientInvoices.map(inv => inv.id);\n        \n        if (invoiceIds.length > 0) {\n          // Use inArray for safe parameter binding (prevents SQL injection)\n          allPayments = await db.select().from(payments)\n            .where(inArray(payments.invoiceId, invoiceIds))\n            .orderBy(desc(payments.createdAt));\n        } else {\n          allPayments = [];\n        }\n      } else if (req.userRole === \"admin\" || req.userRole === \"operational_head\") {\n        // Only admin and operational_head can see all payments\n        allPayments = await db.select().from(payments).orderBy(desc(payments.createdAt));\n      } else {\n        // Developers and other roles don't have access to payments\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      res.json(allPayments);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/payments\", authenticateToken, auditMiddleware(\"create\", \"payment\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can create payments\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied. Only admin and operational head can create payments.\" });\n      }\n\n      const data = insertPaymentSchema.parse(req.body);\n      const [payment] = await db.insert(payments).values(data).returning();\n      res.json(payment);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.patch(\"/api/payments/:id\", authenticateToken, auditMiddleware(\"update\", \"payment\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can update payments\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied. Only admin and operational head can update payments.\" });\n      }\n\n      const data = insertPaymentSchema.partial().parse(req.body);\n      const [payment] = await db.update(payments).set(data).where(eq(payments.id, req.params.id)).returning();\n      \n      if (!payment) {\n        return res.status(404).json({ error: \"Payment not found\" });\n      }\n      \n      res.json(payment);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/payments/:id\", authenticateToken, auditMiddleware(\"delete\", \"payment\"), async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can delete payments\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied. Only admin and operational head can delete payments.\" });\n      }\n\n      const [payment] = await db.delete(payments).where(eq(payments.id, req.params.id)).returning();\n      \n      if (!payment) {\n        return res.status(404).json({ error: \"Payment not found\" });\n      }\n      \n      res.json({ message: \"Payment deleted successfully\" });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Payment Receipt\n  app.get(\"/api/payment-receipt\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can access payment receipts\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const paymentId = req.query.paymentId as string;\n\n      if (!paymentId) {\n        return res.status(400).json({ error: \"Payment ID is required\" });\n      }\n\n      // Fetch payment with invoice and client details\n      const [payment] = await db.select({\n        payment: {\n          id: payments.id,\n          amount: payments.amount,\n          paymentDate: payments.paymentDate,\n          paymentMethod: payments.paymentMethod,\n          notes: payments.notes\n        },\n        invoice: {\n          invoiceNumber: invoices.invoiceNumber,\n          amount: invoices.amount,\n          dueDate: invoices.dueDate,\n          status: invoices.status\n        },\n        client: {\n          companyName: clients.name,\n          email: clients.email,\n          phone: clients.phone\n        }\n      })\n        .from(payments)\n        .innerJoin(invoices, eq(payments.invoiceId, invoices.id))\n        .innerJoin(clients, eq(invoices.clientId, clients.id))\n        .where(eq(payments.id, paymentId))\n        .limit(1);\n\n      if (!payment) {\n        return res.status(404).json({ error: \"Payment receipt not found\" });\n      }\n\n      res.json(payment);\n    } catch (error: any) {\n      console.error(\"Payment Receipt fetch error:\", error);\n      res.status(500).json({ error: \"Failed to fetch payment receipt\" });\n    }\n  });\n\n  // Payment Receipt PDF Export\n  app.get(\"/api/payment-receipt/export-pdf\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export payment receipts\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const paymentId = req.query.paymentId as string;\n\n      if (!paymentId) {\n        return res.status(400).json({ error: \"Payment ID is required\" });\n      }\n\n      // Fetch payment receipt data\n      const [receiptData] = await db.select({\n        payment: {\n          id: payments.id,\n          amount: payments.amount,\n          paymentDate: payments.paymentDate,\n          paymentMethod: payments.paymentMethod,\n          notes: payments.notes\n        },\n        invoice: {\n          invoiceNumber: invoices.invoiceNumber,\n          amount: invoices.amount,\n          dueDate: invoices.dueDate,\n          status: invoices.status\n        },\n        client: {\n          companyName: clients.name,\n          email: clients.email,\n          phone: clients.phone\n        }\n      })\n        .from(payments)\n        .innerJoin(invoices, eq(payments.invoiceId, invoices.id))\n        .innerJoin(clients, eq(invoices.clientId, clients.id))\n        .where(eq(payments.id, paymentId))\n        .limit(1);\n\n      if (!receiptData) {\n        return res.status(404).json({ error: \"Payment receipt not found\" });\n      }\n\n      // Generate PDF using pdfkit with professional design matching Invoice/Salary Sheet\n      const doc = new PDFDocument({ \n        margin: 40,\n        size: 'A4',\n        bufferPages: true\n      });\n\n      // Set response headers\n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Payment-Receipt-${receiptData.payment.id.substring(0, 8)}.pdf`);\n\n      // Pipe the PDF to the response\n      doc.pipe(res);\n\n      // ===== PROFESSIONAL HEADER SECTION (matching Invoice style) =====\n      // Background color bar for header\n      doc.save();\n      doc.rect(0, 0, 595, 120).fill('#F8F9FA');\n      doc.restore();\n\n      // Company Logo\n      try {\n        const logoPath = path.join(__dirname, \"../attached_assets/Untitled design (1)_1763794635122.png\");\n        if (require('fs').existsSync(logoPath)) {\n          doc.image(logoPath, 40, 30, { width: 80, height: 80 });\n        } else {\n          console.warn(\"Logo file not found at:\", logoPath);\n        }\n      } catch (error) {\n        console.warn(\"Logo loading error:\", error);\n      }\n\n      // Company Information (right side of header)\n      doc.fontSize(14).font(\"Helvetica-Bold\").fillColor(\"#C8102E\");\n      doc.text(\"MaxTech BD\", 350, 35, { width: 200, align: \"right\" });\n\n      doc.fontSize(9).font(\"Helvetica\").fillColor(\"#212121\");\n      doc.text(\"522, SK Mujib Road (4th Floor)\", 350, 52, { width: 200, align: \"right\" });\n      doc.text(\"Agrabad, Double Mooring, Chattogram,\", 350, 64, { width: 200, align: \"right\" });\n      doc.text(\"Phone: +8801843180008\", 350, 76, { width: 200, align: \"right\" });\n      doc.text(\"Email: info@maxtechbd.com\", 350, 88, { width: 200, align: \"right\" });\n\n      // Document Title - reset position after header\n      const headerBottom = 120;\n      doc.x = doc.page.margins.left;\n      doc.y = headerBottom + 20;\n      \n      doc.fontSize(20).font(\"Helvetica-Bold\").fillColor(\"#111827\");\n      doc.text(\"PAYMENT RECEIPT\", 40, headerBottom + 20, { width: 515, align: \"center\" });\n\n      doc.fontSize(12).font(\"Helvetica\").fillColor(\"#6B7280\");\n      const receiptNumber = receiptData.payment.id.substring(0, 8).toUpperCase();\n      doc.text(`Receipt #: ${receiptNumber}`, 40, headerBottom + 45, { width: 515, align: \"center\" });\n\n      doc.fontSize(10).fillColor(\"#9CA3AF\");\n      doc.text(`Generated on: ${new Date().toLocaleString()}`, 40, headerBottom + 60, { width: 515, align: \"center\" });\n\n      // Reset position for content sections\n      let currentY = headerBottom + 90;\n      doc.x = doc.page.margins.left;\n      doc.y = currentY;\n\n      // ===== INFORMATION BOXES SECTION =====\n      // Save the baseline Y for both columns\n      const rowTop = currentY;\n      const cardHeight = 120;\n      \n      // Left Column - Payment Information\n      doc.save();\n      doc.rect(40, rowTop, 250, cardHeight).stroke(\"#E5E7EB\");\n      doc.rect(40, rowTop, 250, 30).fillAndStroke(\"#F3F4F6\", \"#E5E7EB\");\n      doc.restore();\n\n      doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#374151\");\n      doc.text(\"Payment Information\", 50, rowTop + 8);\n\n      doc.fontSize(10).font(\"Helvetica\").fillColor(\"#6B7280\");\n      doc.text(\"Receipt Number:\", 50, rowTop + 45);\n      doc.text(\"Payment Date:\", 50, rowTop + 62);\n      doc.text(\"Payment Method:\", 50, rowTop + 79);\n      doc.text(\"Amount Paid:\", 50, rowTop + 96);\n\n      doc.font(\"Helvetica-Bold\").fillColor(\"#111827\");\n      doc.text(receiptNumber, 160, rowTop + 45);\n      doc.text(format(new Date(receiptData.payment.paymentDate), \"MMMM dd, yyyy\"), 160, rowTop + 62);\n      doc.text(receiptData.payment.paymentMethod, 160, rowTop + 79);\n      doc.text(formatCurrency(receiptData.payment.amount || \"0\"), 160, rowTop + 96);\n\n      // Right Column - Client Information (using same baseline)\n      doc.save();\n      doc.rect(305, rowTop, 250, cardHeight).stroke(\"#E5E7EB\");\n      doc.rect(305, rowTop, 250, 30).fillAndStroke(\"#F3F4F6\", \"#E5E7EB\");\n      doc.restore();\n\n      doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#374151\");\n      doc.text(\"Client Information\", 315, rowTop + 8);\n\n      doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#111827\");\n      doc.text(receiptData.client.companyName, 315, rowTop + 45, { width: 230 });\n\n      doc.fontSize(10).font(\"Helvetica\").fillColor(\"#6B7280\");\n      let clientY = rowTop + 62;\n      if (receiptData.client.email) {\n        doc.text(receiptData.client.email, 315, clientY, { width: 230 });\n        clientY += 15;\n      }\n      if (receiptData.client.phone) {\n        doc.text(receiptData.client.phone, 315, clientY, { width: 230 });\n      }\n\n      // Advance Y position after both columns\n      currentY = rowTop + cardHeight + 20;\n\n      // ===== INVOICE REFERENCE BOX =====\n      doc.save();\n      doc.rect(40, currentY, 515, 110).stroke(\"#E5E7EB\");\n      doc.rect(40, currentY, 515, 30).fillAndStroke(\"#F3F4F6\", \"#E5E7EB\");\n      doc.restore();\n\n      doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#374151\");\n      doc.text(\"Invoice Reference\", 50, currentY + 8);\n\n      doc.fontSize(10).font(\"Helvetica\").fillColor(\"#6B7280\");\n      doc.text(\"Invoice Number:\", 50, currentY + 45);\n      doc.text(\"Invoice Amount:\", 50, currentY + 62);\n      doc.text(\"Due Date:\", 50, currentY + 79);\n      doc.text(\"Status:\", 350, currentY + 45);\n\n      doc.font(\"Helvetica-Bold\").fillColor(\"#111827\");\n      doc.text(receiptData.invoice.invoiceNumber, 160, currentY + 45);\n      doc.text(formatCurrency(receiptData.invoice.amount || \"0\"), 160, currentY + 62);\n      doc.text(format(new Date(receiptData.invoice.dueDate), \"MMM dd, yyyy\"), 160, currentY + 79);\n\n      // Status badge\n      const statusColors: Record<string, string> = {\n        'draft': '#9CA3AF',\n        'sent': '#3B82F6',\n        'paid': '#10B981',\n        'overdue': '#EF4444'\n      };\n      doc.fillColor(statusColors[receiptData.invoice.status] || '#10B981');\n      doc.text(receiptData.invoice.status.toUpperCase(), 410, currentY + 45);\n\n      currentY += 130;\n\n      // ===== TOTAL AMOUNT PAID - Highlighted (centered and balanced) =====\n      const totalBoxWidth = 220;\n      const totalBoxX = (595 - totalBoxWidth) / 2; // Center the box on the page\n      \n      doc.save();\n      doc.rect(totalBoxX, currentY - 5, totalBoxWidth, 40).fillAndStroke(\"#F3F4F6\", \"#E5E7EB\");\n      doc.restore();\n\n      doc.fontSize(13).font(\"Helvetica-Bold\").fillColor(\"#111827\");\n      doc.text(\"Total Amount Paid:\", totalBoxX, currentY + 8, { width: totalBoxWidth, align: \"center\" });\n      doc.fontSize(16).fillColor(\"#C8102E\");\n      doc.text(formatCurrency(receiptData.payment.amount || \"0\"), totalBoxX, currentY + 25, { width: totalBoxWidth, align: \"center\" });\n\n      currentY += 55;\n\n      // ===== NOTES SECTION =====\n      if (receiptData.payment.notes) {\n        const notesBoxHeight = Math.min(receiptData.payment.notes.length / 2 + 60, 100);\n\n        doc.save();\n        doc.rect(40, currentY, 515, notesBoxHeight).stroke(\"#E5E7EB\");\n        doc.rect(40, currentY, 515, 25).fillAndStroke(\"#F3F4F6\", \"#E5E7EB\");\n        doc.restore();\n\n        doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(\"#374151\");\n        doc.text(\"Notes:\", 50, currentY + 7);\n\n        doc.fontSize(10).font(\"Helvetica\").fillColor(\"#6B7280\");\n        doc.text(receiptData.payment.notes, 50, currentY + 35, { width: 495, align: \"left\" });\n\n        currentY += notesBoxHeight + 20;\n      }\n\n      // ===== SIGNATURE SECTION =====\n      currentY += 20;\n      const signatureY = Math.min(currentY, 600); // Ensure signatures stay on first page\n      \n      doc.fontSize(10).font(\"Helvetica\").fillColor(\"#111827\");\n      \n      // Draw professional signature lines\n      const sig1X = 100;\n      const sig2X = 350;\n      const lineLength = 130;\n      \n      doc.save();\n      doc.moveTo(sig1X, signatureY).lineTo(sig1X + lineLength, signatureY).strokeColor(\"#374151\").lineWidth(1).stroke();\n      doc.moveTo(sig2X, signatureY).lineTo(sig2X + lineLength, signatureY).strokeColor(\"#374151\").lineWidth(1).stroke();\n      doc.restore();\n      \n      doc.text(\"Received By\", sig1X, signatureY + 10, { width: lineLength, align: \"center\" });\n      doc.text(\"Authorized Signature\", sig2X, signatureY + 10, { width: lineLength, align: \"center\" });\n\n      // ===== FOOTER (inline, not fixed position) =====\n      const footerY = Math.min(signatureY + 60, 720);\n\n      doc.save();\n      doc.moveTo(40, footerY)\n         .lineTo(555, footerY)\n         .strokeColor(\"#E5E7EB\")\n         .lineWidth(1)\n         .stroke();\n      doc.restore();\n\n      doc.fontSize(8).font(\"Helvetica\").fillColor(\"#6B7280\");\n      doc.text(\n        \"MaxTech BD | 522, SK Mujib Road (4th Floor), Agrabad, Double Mooring, Chattogram, Bangladesh\",\n        40,\n        footerY + 10,\n        { width: 515, align: \"center\" }\n      );\n      doc.text(\n        \"Phone: +8801843180008 | Email: info@maxtechbd.com\",\n        40,\n        footerY + 22,\n        { width: 515, align: \"center\" }\n      );\n\n      // Finalize the PDF\n      doc.end();\n    } catch (error: any) {\n      console.error(\"Payment Receipt PDF export error:\", error);\n      res.status(500).json({ error: \"Failed to export PDF\" });\n    }\n  });\n\n  // Payment Receipt Excel Export\n  app.get(\"/api/payment-receipt/export-excel\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export payment receipts\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const paymentId = req.query.paymentId as string;\n\n      if (!paymentId) {\n        return res.status(400).json({ error: \"Payment ID is required\" });\n      }\n\n      // Fetch payment receipt data\n      const [receiptData] = await db.select({\n        payment: {\n          id: payments.id,\n          amount: payments.amount,\n          paymentDate: payments.paymentDate,\n          paymentMethod: payments.paymentMethod,\n          notes: payments.notes\n        },\n        invoice: {\n          invoiceNumber: invoices.invoiceNumber,\n          amount: invoices.amount,\n          dueDate: invoices.dueDate,\n          status: invoices.status\n        },\n        client: {\n          companyName: clients.name,\n          email: clients.email,\n          phone: clients.phone\n        }\n      })\n        .from(payments)\n        .innerJoin(invoices, eq(payments.invoiceId, invoices.id))\n        .innerJoin(clients, eq(invoices.clientId, clients.id))\n        .where(eq(payments.id, paymentId))\n        .limit(1);\n\n      if (!receiptData) {\n        return res.status(404).json({ error: \"Payment receipt not found\" });\n      }\n\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Payment Receipt\");\n\n      // Company Header\n      worksheet.mergeCells(\"A1:D1\");\n      const titleRow = worksheet.getCell(\"A1\");\n      titleRow.value = \"MaxTech BD\";\n      titleRow.font = { size: 18, bold: true, color: { argb: \"FFE11D26\" } };\n      titleRow.alignment = { horizontal: \"center\", vertical: \"middle\" };\n\n      worksheet.mergeCells(\"A2:D2\");\n      const addressRow = worksheet.getCell(\"A2\");\n      addressRow.value = \"522 SK Mujib Road, Dhaka, Bangladesh\";\n      addressRow.font = { size: 10 };\n      addressRow.alignment = { horizontal: \"center\" };\n\n      worksheet.mergeCells(\"A3:D3\");\n      const contactRow = worksheet.getCell(\"A3\");\n      contactRow.value = \"Phone: +8801843180008 | Email: info@maxtechbd.com\";\n      contactRow.font = { size: 10 };\n      contactRow.alignment = { horizontal: \"center\" };\n\n      worksheet.addRow([]);\n\n      // Receipt Title\n      worksheet.mergeCells(\"A5:D5\");\n      const receiptTitleRow = worksheet.getCell(\"A5\");\n      receiptTitleRow.value = \"PAYMENT RECEIPT\";\n      receiptTitleRow.font = { size: 14, bold: true };\n      receiptTitleRow.alignment = { horizontal: \"center\" };\n\n      worksheet.addRow([]);\n\n      // Payment Information\n      worksheet.addRow([\"Payment Information\"]).font = { bold: true, size: 12 };\n      worksheet.addRow([\"Receipt Number:\", receiptData.payment.id.substring(0, 8).toUpperCase()]);\n      worksheet.addRow([\"Payment Date:\", format(new Date(receiptData.payment.paymentDate), \"MMMM dd, yyyy\")]);\n      worksheet.addRow([\"Payment Method:\", receiptData.payment.paymentMethod]);\n\n      worksheet.addRow([]);\n\n      // Client Information\n      worksheet.addRow([\"Client Information\"]).font = { bold: true, size: 12 };\n      worksheet.addRow([\"Company Name:\", receiptData.client.companyName]);\n      worksheet.addRow([\"Email:\", receiptData.client.email]);\n      worksheet.addRow([\"Phone:\", receiptData.client.phone || \"N/A\"]);\n\n      worksheet.addRow([]);\n\n      // Invoice Reference\n      worksheet.addRow([\"Invoice Reference\"]).font = { bold: true, size: 12 };\n      worksheet.addRow([\"Invoice Number:\", receiptData.invoice.invoiceNumber]);\n      worksheet.addRow([\"Invoice Amount:\", parseFloat(receiptData.invoice.amount || \"0\")]);\n      worksheet.addRow([\"Due Date:\", format(new Date(receiptData.invoice.dueDate), \"MMM dd, yyyy\")]);\n      worksheet.addRow([\"Status:\", receiptData.invoice.status.toUpperCase()]);\n\n      worksheet.addRow([]);\n\n      // Amount Paid (highlighted)\n      const amountRow = worksheet.addRow([\"TOTAL AMOUNT PAID:\", parseFloat(receiptData.payment.amount || \"0\")]);\n      amountRow.font = { bold: true, size: 14, color: { argb: \"FFFFFFFF\" } };\n      amountRow.fill = { type: \"pattern\", pattern: \"solid\", fgColor: { argb: \"FFE11D26\" } };\n      amountRow.getCell(2).numFmt = \"#,##0.00\";\n\n      worksheet.addRow([]);\n\n      // Notes (if any)\n      if (receiptData.payment.notes) {\n        worksheet.addRow([\"Notes:\"]).font = { bold: true, size: 12 };\n        worksheet.addRow([receiptData.payment.notes]);\n        worksheet.addRow([]);\n      }\n\n      // Signature Section\n      worksheet.addRow([]);\n      worksheet.addRow([\"Received By\", \"\", \"Authorized Signature\"]);\n      worksheet.addRow([\"_______________________\", \"\", \"_______________________\"]);\n\n      // Column widths\n      worksheet.getColumn(1).width = 25;\n      worksheet.getColumn(2).width = 30;\n      worksheet.getColumn(3).width = 25;\n      worksheet.getColumn(4).width = 30;\n\n      // Write to buffer and send\n      const buffer = await workbook.xlsx.writeBuffer();\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Payment-Receipt-${receiptData.payment.id.substring(0, 8)}.xlsx`);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Payment Receipt Excel export error:\", error);\n      res.status(500).json({ error: \"Failed to export Excel\" });\n    }\n  });\n\n  // Payment Receipt Word Export\n  app.get(\"/api/payment-receipt/export-word\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export payment receipts\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const paymentId = req.query.paymentId as string;\n\n      if (!paymentId) {\n        return res.status(400).json({ error: \"Payment ID is required\" });\n      }\n\n      // Fetch payment receipt data\n      const [receiptData] = await db.select({\n        payment: {\n          id: payments.id,\n          amount: payments.amount,\n          paymentDate: payments.paymentDate,\n          paymentMethod: payments.paymentMethod,\n          notes: payments.notes\n        },\n        invoice: {\n          invoiceNumber: invoices.invoiceNumber,\n          amount: invoices.amount,\n          dueDate: invoices.dueDate,\n          status: invoices.status\n        },\n        client: {\n          companyName: clients.name,\n          email: clients.email,\n          phone: clients.phone\n        }\n      })\n        .from(payments)\n        .innerJoin(invoices, eq(payments.invoiceId, invoices.id))\n        .innerJoin(clients, eq(invoices.clientId, clients.id))\n        .where(eq(payments.id, paymentId))\n        .limit(1);\n\n      if (!receiptData) {\n        return res.status(404).json({ error: \"Payment receipt not found\" });\n      }\n\n      const doc = new Document({\n        sections: [{\n          children: [\n            // Company Header\n            new Paragraph({\n              text: \"MaxTech BD\",\n              heading: HeadingLevel.HEADING_1,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: \"522 SK Mujib Road, Dhaka, Bangladesh\",\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: \"Phone: +8801843180008 | Email: info@maxtechbd.com\",\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n\n            // Receipt Title\n            new Paragraph({\n              text: \"PAYMENT RECEIPT\",\n              heading: HeadingLevel.HEADING_2,\n              alignment: AlignmentType.CENTER,\n              spacing: { after: 400 }\n            }),\n\n            // Payment Information\n            new Paragraph({\n              text: \"Payment Information\",\n              heading: HeadingLevel.HEADING_3,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: `Receipt Number: ${receiptData.payment.id.substring(0, 8).toUpperCase()}`,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Payment Date: ${format(new Date(receiptData.payment.paymentDate), \"MMMM dd, yyyy\")}`,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Payment Method: ${receiptData.payment.paymentMethod}`,\n              spacing: { after: 300 }\n            }),\n\n            // Client Information\n            new Paragraph({\n              text: \"Client Information\",\n              heading: HeadingLevel.HEADING_3,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: `Company Name: ${receiptData.client.companyName}`,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Email: ${receiptData.client.email}`,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Phone: ${receiptData.client.phone || \"N/A\"}`,\n              spacing: { after: 300 }\n            }),\n\n            // Invoice Reference\n            new Paragraph({\n              text: \"Invoice Reference\",\n              heading: HeadingLevel.HEADING_3,\n              spacing: { after: 200 }\n            }),\n            new Paragraph({\n              text: `Invoice Number: ${receiptData.invoice.invoiceNumber}`,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Invoice Amount: ${formatCurrency(receiptData.invoice.amount || \"0\")}`,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Due Date: ${format(new Date(receiptData.invoice.dueDate), \"MMM dd, yyyy\")}`,\n              spacing: { after: 100 }\n            }),\n            new Paragraph({\n              text: `Status: ${receiptData.invoice.status.toUpperCase()}`,\n              spacing: { after: 300 }\n            }),\n\n            // Amount Paid (highlighted)\n            new Paragraph({\n              text: `TOTAL AMOUNT PAID: ${formatCurrency(receiptData.payment.amount || \"0\")}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { before: 300, after: 300 },\n              shading: {\n                type: ShadingType.SOLID,\n                color: \"E11D26\",\n                fill: \"E11D26\"\n              }\n            }),\n\n            // Notes (if any)\n            ...(receiptData.payment.notes ? [\n              new Paragraph({\n                text: \"Notes\",\n                heading: HeadingLevel.HEADING_3,\n                spacing: { before: 300, after: 200 }\n              }),\n              new Paragraph({\n                text: receiptData.payment.notes,\n                spacing: { after: 300 }\n              })\n            ] : []),\n\n            // Signature Section\n            new Paragraph({\n              text: \"\",\n              spacing: { before: 600, after: 200 }\n            }),\n            new Table({\n              width: { size: 100, type: WidthType.PERCENTAGE },\n              rows: [\n                new TableRow({\n                  children: [\n                    new TableCell({\n                      children: [new Paragraph({\n                        text: \"Received By\",\n                        alignment: AlignmentType.CENTER\n                      })],\n                      borders: { top: { style: BorderStyle.SINGLE, size: 1 }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({ text: \"\" })],\n                      borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } }\n                    }),\n                    new TableCell({\n                      children: [new Paragraph({\n                        text: \"Authorized Signature\",\n                        alignment: AlignmentType.CENTER\n                      })],\n                      borders: { top: { style: BorderStyle.SINGLE, size: 1 }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } }\n                    })\n                  ]\n                })\n              ]\n            }),\n\n            // Footer\n            new Paragraph({\n              text: `Generated on ${format(new Date(), \"MMMM dd, yyyy\")}`,\n              alignment: AlignmentType.CENTER,\n              spacing: { before: 600 }\n            })\n          ]\n        }]\n      });\n\n      const buffer = await Packer.toBuffer(doc);\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=Payment-Receipt-${receiptData.payment.id.substring(0, 8)}.docx`);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Payment Receipt Word export error:\", error);\n      res.status(500).json({ error: \"Failed to export Word document\" });\n    }\n  });\n\n  // HR Attendance Report\n  app.get(\"/api/hr-attendance-report\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can view attendance reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const { startDate, endDate, employeeId, departmentId } = req.query;\n\n      if (!startDate || !endDate) {\n        return res.status(400).json({ error: \"Start date and end date are required\" });\n      }\n\n      // Build where conditions (always include date range)\n      const whereConditions: any[] = [\n        gte(attendance.date, startDate as string),\n        lte(attendance.date, endDate as string),\n      ];\n\n      // Add employee or department filter\n      if (employeeId && employeeId !== \"all\") {\n        whereConditions.push(eq(employees.id, employeeId as string));\n      } else if (departmentId && departmentId !== \"all\") {\n        whereConditions.push(eq(employees.departmentId, departmentId as string));\n      }\n\n      // Build and execute attendance query (always has at least date range conditions)\n      // Use leftJoin for employees to show all attendance records\n      // Use CASE to check if employee record exists and provide appropriate fallback\n      const attendanceRecords = await db.select({\n        id: attendance.id,\n        userId: attendance.userId,\n        date: attendance.date,\n        checkIn: attendance.checkIn,\n        checkOut: attendance.checkOut,\n        status: attendance.status,\n        lateDuration: attendance.lateDuration,\n        notes: attendance.notes,\n        employeeId: employees.id,\n        employeeCode: employees.employeeId,\n        employeeName: sql<string>`CASE WHEN ${employees.id} IS NULL THEN 'Unassigned Employee' ELSE ${users.fullName} END`.as('employeeName'),\n        departmentId: employees.departmentId,\n        departmentName: sql<string>`CASE WHEN ${departments.id} IS NULL THEN 'N/A' ELSE ${departments.name} END`.as('departmentName'),\n      })\n      .from(attendance)\n      .innerJoin(users, eq(attendance.userId, users.id))\n      .leftJoin(employees, eq(users.id, employees.userId))\n      .leftJoin(departments, eq(employees.departmentId, departments.id))\n      .where(and(...whereConditions))\n      .orderBy(attendance.date);\n\n      // Format attendance data for frontend\n      // Note: COALESCE in SQL query handles null values, so no need for fallbacks here\n      const attendanceData = attendanceRecords.map(record => ({\n        date: record.date,\n        employeeId: record.employeeId || \"N/A\",\n        employeeName: record.employeeName, // Already has COALESCE fallback in SQL\n        employeeCode: record.employeeCode || \"N/A\",\n        department: record.departmentName, // Already has COALESCE fallback in SQL\n        status: record.status || \"Absent\", // Keep original casing - frontend handles normalization\n        checkInTime: record.checkIn ? format(new Date(record.checkIn), \"hh:mm a\") : null,\n        checkOutTime: record.checkOut ? format(new Date(record.checkOut), \"hh:mm a\") : null,\n        notes: record.notes || null,\n        lateDuration: record.lateDuration || 0,\n      }));\n\n      // Calculate summary statistics (case-insensitive matching)\n      const totalDays = attendanceData.length;\n      const presentCount = attendanceData.filter(a => a.status.toLowerCase() === \"present\").length;\n      const lateCount = attendanceData.filter(a => a.status.toLowerCase() === \"late\").length;\n      const halfDayCount = attendanceData.filter(a => a.status.toLowerCase() === \"half-day\").length;\n      const absentCount = attendanceData.filter(a => a.status.toLowerCase() === \"absent\").length;\n      // Overtime: Set to 0 as proper overtime tracking is not yet implemented\n      // TODO: Implement proper overtime calculation based on office hours settings\n      const overtimeCount = 0;\n\n      // Calculate working days (excluding Sundays for Bangladesh)\n      const start = new Date(startDate as string);\n      const end = new Date(endDate as string);\n      let workingDays = 0;\n      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {\n        // Count all days except Sundays (day 0)\n        if (d.getDay() !== 0) {\n          workingDays++;\n        }\n      }\n\n      // Fetch HR settings to get expected hours per day\n      const hrSettingsRecord = await db.select().from(hrSettings).limit(1);\n      let expectedDailyHours = 8; // Default fallback\n      if (hrSettingsRecord.length > 0) {\n        const parsedHours = parseFloat(hrSettingsRecord[0].fullDayHours || \"8\");\n        // Resilient fallback: if parseFloat returns NaN, use default\n        expectedDailyHours = !isNaN(parsedHours) && parsedHours > 0 ? parsedHours : 8;\n      }\n\n      // Calculate on-time count (present and not late, excluding half-day)\n      const onTimeCount = Math.max(0, presentCount - lateCount - halfDayCount);\n\n      // Calculate total hours worked and per-day overtime with null safety\n      let totalHoursWorked = 0;\n      let overtimeHours = 0;\n\n      attendanceData.forEach(record => {\n        // Only calculate hours if both check-in and check-out times exist\n        if (record.checkInTime && record.checkOutTime && \n            record.checkInTime.trim() !== \"\" && record.checkOutTime.trim() !== \"\") {\n          try {\n            const checkIn = new Date(`2000-01-01 ${record.checkInTime}`);\n            const checkOut = new Date(`2000-01-01 ${record.checkOutTime}`);\n            \n            // Validate that dates are valid\n            if (!isNaN(checkIn.getTime()) && !isNaN(checkOut.getTime())) {\n              const hours = (checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60);\n              // Only add positive hours (check-out after check-in)\n              if (hours > 0 && hours < 24) {\n                totalHoursWorked += hours;\n                // Calculate per-day overtime (hours worked - expected daily hours)\n                const dailyOvertime = Math.max(0, hours - expectedDailyHours);\n                overtimeHours += dailyOvertime;\n              }\n            }\n          } catch (e) {\n            // Skip invalid times silently\n          }\n        }\n      });\n\n      res.json({\n        attendanceData,\n        summary: {\n          totalDays,\n          workingDays,\n          presentCount,\n          onTimeCount,\n          lateCount,\n          halfDayCount,\n          absentCount,\n          overtimeCount,\n          overtimeHours: overtimeHours.toFixed(2),\n          totalHoursWorked: totalHoursWorked.toFixed(2),\n          presentPercentage: totalDays > 0 ? ((presentCount / totalDays) * 100).toFixed(2) : \"0\",\n          latePercentage: totalDays > 0 ? ((lateCount / totalDays) * 100).toFixed(2) : \"0\",\n          halfDayPercentage: totalDays > 0 ? ((halfDayCount / totalDays) * 100).toFixed(2) : \"0\",\n          absentPercentage: totalDays > 0 ? ((absentCount / totalDays) * 100).toFixed(2) : \"0\",\n        },\n        dateRange: {\n          start: format(new Date(startDate as string), \"MMM dd, yyyy\"),\n          end: format(new Date(endDate as string), \"MMM dd, yyyy\"),\n        },\n      });\n    } catch (error: any) {\n      console.error(\"HR Attendance Report fetch error:\", error);\n      res.status(500).json({ error: \"Failed to fetch attendance report\" });\n    }\n  });\n\n  // HR Attendance Report PDF Export - Professional Job Card Format\n  app.get(\"/api/hr-attendance-report/export-pdf\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export attendance reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const reportData = JSON.parse(decodeURIComponent(req.query.data as string));\n      const isEmployeeJobCard = reportData.attendanceData.length > 0 && \n        reportData.attendanceData.every((r: any) => r.employeeId === reportData.attendanceData[0].employeeId);\n\n      const doc = new PDFDocument({ margin: 25, size: 'A4' });\n      const fileName = isEmployeeJobCard \n        ? `Job-Card-${reportData.attendanceData[0]?.employeeName?.replace(/\\s+/g, '-')}-${format(new Date(), \"yyyy-MM-dd\")}.pdf`\n        : `Attendance-Report-${format(new Date(), \"yyyy-MM-dd\")}.pdf`;\n      \n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=${fileName}`);\n      doc.pipe(res);\n\n      // ===== PROFESSIONAL HEADER SECTION (Non-Overlapping Bounds) =====\n      let currentY = 30;\n      const headerStartY = currentY;\n      \n      // Define explicit bounding boxes to prevent overlap\n      const leftBounds = { x: 40, width: 80 };        // Logo section\n      const centerBounds = { x: 125, width: 270 };    // Company details  \n      const rightBounds = { x: 405, width: 150 };     // Job card info\n      \n      let maxHeaderHeight = 0;\n      \n      // ===== LEFT: Logo =====\n      let logoHeight = 70;\n      try {\n        const logoPath = path.join(__dirname, \"../attached_assets/Untitled design (1)_1763794635122.png\");\n        doc.image(logoPath, leftBounds.x, headerStartY, { width: 70, height: 70 });\n        maxHeaderHeight = Math.max(maxHeaderHeight, logoHeight);\n      } catch (error) {\n        console.warn(\"Logo not found, skipping logo in PDF\");\n        logoHeight = 0;\n      }\n\n      // ===== CENTER: Company Details =====\n      let centerY = headerStartY;\n      let centerHeight = 0;\n      \n      // Company name\n      doc.fontSize(16).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n      const companyNameHeight = doc.heightOfString(\"MAXTECH BD\", { width: centerBounds.width, align: \"center\" });\n      doc.text(\"MAXTECH BD\", centerBounds.x, centerY, { width: centerBounds.width, align: \"center\" });\n      centerY += companyNameHeight + 5;\n      centerHeight += companyNameHeight + 5;\n      \n      // Address line 1\n      doc.fontSize(9).font(\"Helvetica\").fillColor(BRAND_COLORS.black);\n      const addr1Height = doc.heightOfString(\"522, SK Mujib Road (4th Floor)\", { width: centerBounds.width, align: \"center\" });\n      doc.text(\"522, SK Mujib Road (4th Floor)\", centerBounds.x, centerY, { width: centerBounds.width, align: \"center\" });\n      centerY += addr1Height + 2;\n      centerHeight += addr1Height + 2;\n      \n      // Address line 2\n      const addr2Height = doc.heightOfString(\"Agrabad, Double Mooring, Chattogram\", { width: centerBounds.width, align: \"center\" });\n      doc.text(\"Agrabad, Double Mooring, Chattogram\", centerBounds.x, centerY, { width: centerBounds.width, align: \"center\" });\n      centerY += addr2Height + 3;\n      centerHeight += addr2Height + 3;\n      \n      // Contact info\n      doc.fontSize(8).font(\"Helvetica\").fillColor(BRAND_COLORS.gray);\n      const contactHeight = doc.heightOfString(\"Phone: +8801843180008\", { width: centerBounds.width, align: \"center\" });\n      doc.text(\"Phone: +8801843180008 | Email: support@maxtechbd.com\", centerBounds.x, centerY, { width: centerBounds.width, align: \"center\" });\n      centerHeight += contactHeight;\n      \n      maxHeaderHeight = Math.max(maxHeaderHeight, centerHeight);\n\n      // ===== RIGHT: Job Card Info Box =====\n      let rightY = headerStartY;\n      let rightHeight = 0;\n      \n      // Measure actual text heights for box content\n      const boxPadding = 10;\n      const boxInnerWidth = rightBounds.width - (2 * boxPadding);\n      \n      doc.fontSize(10).font(\"Helvetica-Bold\");\n      const titleText = isEmployeeJobCard ? \"Employee Job Card\" : \"Attendance Report\";\n      const titleHeight = doc.heightOfString(titleText, { width: boxInnerWidth, align: \"center\" });\n      \n      doc.fontSize(7).font(\"Helvetica\");\n      const periodText = `Period: ${reportData.dateRange.start}  ${reportData.dateRange.end}`;\n      const periodHeight = doc.heightOfString(periodText, { width: boxInnerWidth, align: \"center\" });\n      \n      const generatedText = `Generated: ${format(new Date(), \"MMM dd, yyyy\")}`;\n      const generatedHeight = doc.heightOfString(generatedText, { width: boxInnerWidth, align: \"center\" });\n      \n      // Calculate total box height based on measured content\n      const lineSpacing = 4;\n      const boxHeight = boxPadding + titleHeight + lineSpacing + periodHeight + lineSpacing + generatedHeight + boxPadding;\n      \n      // Draw box background\n      doc.save();\n      doc.roundedRect(rightBounds.x, rightY, rightBounds.width, boxHeight, 3)\n         .fillAndStroke(\"#f8f9fa\", \"#d1d5db\");\n      doc.restore();\n      \n      rightY += boxPadding;\n      \n      // Title\n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n      doc.text(titleText, rightBounds.x + boxPadding, rightY, { \n        width: boxInnerWidth, \n        align: \"center\",\n        lineBreak: false\n      });\n      rightY += titleHeight + lineSpacing;\n      \n      // Period\n      doc.fontSize(7).font(\"Helvetica\").fillColor(\"#6b7280\");\n      doc.text(periodText, rightBounds.x + boxPadding, rightY, { \n        width: boxInnerWidth, \n        align: \"center\",\n        lineBreak: false\n      });\n      rightY += periodHeight + lineSpacing;\n      \n      // Generated date\n      doc.text(generatedText, rightBounds.x + boxPadding, rightY, { \n        width: boxInnerWidth, \n        align: \"center\",\n        lineBreak: false\n      });\n      \n      rightHeight = boxHeight;\n      maxHeaderHeight = Math.max(maxHeaderHeight, rightHeight);\n      \n      // Advance cursor by maximum header height\n      currentY = headerStartY + maxHeaderHeight + 15;\n\n      // Header separator line\n      doc.moveTo(40, currentY).lineTo(555, currentY).strokeColor(BRAND_COLORS.border).lineWidth(1).stroke();\n      currentY += 20;\n\n      // ===== EMPLOYEE INFO PANEL (For Job Card) - Full-width Professional Box =====\n      if (isEmployeeJobCard) {\n        // Full-width professional box with subtle grey background\n        doc.save();\n        doc.roundedRect(40, currentY, 515, 70, 4)\n           .fillAndStroke(\"#f5f5f5\", \"#d1d5db\");\n        doc.restore();\n\n        // Employee details in clean horizontal layout\n        const infoY = currentY + 20;\n        \n        // Employee Name (Primary Info)\n        doc.fontSize(11).font(\"Helvetica\").fillColor(\"#6b7280\");\n        doc.text(\"EMPLOYEE NAME\", 55, infoY, { width: 120 });\n        doc.fontSize(12).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.black);\n        doc.text(reportData.attendanceData[0].employeeName, 55, infoY + 14, { width: 200 });\n\n        // Employee Code\n        doc.fontSize(11).font(\"Helvetica\").fillColor(\"#6b7280\");\n        doc.text(\"CODE\", 270, infoY, { width: 80 });\n        doc.fontSize(12).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.black);\n        doc.text(reportData.attendanceData[0].employeeCode, 270, infoY + 14, { width: 100 });\n\n        // Department\n        doc.fontSize(11).font(\"Helvetica\").fillColor(\"#6b7280\");\n        doc.text(\"DEPARTMENT\", 385, infoY, { width: 150 });\n        doc.fontSize(12).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.black);\n        doc.text(reportData.attendanceData[0].department, 385, infoY + 14, { width: 150 });\n\n        currentY += 90;\n      }\n\n      // ===== ATTENDANCE SUMMARY GRID (6 Cards: 32 Professional Layout) =====\n      doc.fontSize(14).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n      doc.text(\"Attendance Summary\", 40, currentY, { width: 515, align: \"center\" });\n      currentY += 30;\n\n      // Streamlined 6-card layout for cleaner look\n      const summaryItems = [\n        { label: \"Working Days\", value: reportData.summary.workingDays || reportData.summary.totalDays, color: \"#000000\" },\n        { label: \"Present\", value: reportData.summary.presentCount, color: \"#10B981\" },\n        { label: \"Late\", value: reportData.summary.lateCount, color: \"#F59E0B\" },\n        { label: \"Absent\", value: reportData.summary.absentCount, color: \"#EF4444\" },\n        { label: \"Total Hours\", value: `${reportData.summary.totalHoursWorked || \"0.00\"}`, color: \"#1E40AF\" },\n        { label: \"Overtime\", value: `${reportData.summary.overtimeHours || \"0.00\"}`, color: \"#8B5CF6\" },\n      ];\n\n      // Professional grid layout (3 columns  2 rows with even spacing)\n      const gridCols = 3;\n      const cardGap = 12;\n      const cardWidth = (515 - (cardGap * (gridCols - 1))) / gridCols;\n      const cardHeight = 65;\n\n      summaryItems.forEach((item, index) => {\n        const col = index % gridCols;\n        const row = Math.floor(index / gridCols);\n        const x = 40 + (col * (cardWidth + cardGap));\n        const y = currentY + (row * (cardHeight + cardGap));\n\n        // Card with professional border and subtle background\n        doc.save();\n        doc.roundedRect(x, y, cardWidth, cardHeight, 4)\n           .fillAndStroke(\"#fafafa\", \"#e0e0e0\");\n        doc.restore();\n\n        // Label (small, uppercase, grey)\n        doc.fontSize(9).font(\"Helvetica\").fillColor(\"#6b7280\");\n        doc.text(item.label.toUpperCase(), x + 12, y + 15, { \n          width: cardWidth - 24, \n          align: \"left\" \n        });\n\n        // Value (large, bold, colored)\n        doc.fontSize(20).font(\"Helvetica-Bold\").fillColor(item.color);\n        doc.text(String(item.value), x + 12, y + 32, { \n          width: cardWidth - 24, \n          align: \"left\" \n        });\n      });\n\n      currentY += (2 * (cardHeight + cardGap)) + 25;\n\n      // ===== DAILY ATTENDANCE TABLE (Corporate Style) =====\n      doc.fontSize(13).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n      doc.text(\"Daily Attendance Record\", 40, currentY, { width: 515, align: \"center\" });\n      currentY += 25;\n\n      // Table columns\n      const columns = isEmployeeJobCard \n        ? [\n            { label: \"Date\", width: 90, align: \"left\" as const },\n            { label: \"Day\", width: 70, align: \"left\" as const },\n            { label: \"Check In\", width: 85, align: \"left\" as const },\n            { label: \"Check Out\", width: 85, align: \"left\" as const },\n            { label: \"Status\", width: 105, align: \"left\" as const },\n            { label: \"Hours\", width: 80, align: \"right\" as const },\n          ]\n        : [\n            { label: \"Date\", width: 85, align: \"left\" as const },\n            { label: \"Employee\", width: 120, align: \"left\" as const },\n            { label: \"Dept\", width: 90, align: \"left\" as const },\n            { label: \"Status\", width: 80, align: \"center\" as const },\n            { label: \"Check In\", width: 70, align: \"center\" as const },\n            { label: \"Check Out\", width: 70, align: \"center\" as const },\n          ];\n\n      // Table header with professional styling\n      let tableY = currentY;\n      const tableX = 40;\n      const totalWidth = columns.reduce((sum, col) => sum + col.width, 0);\n      const headerHeight = 32;\n\n      // Header background\n      doc.save();\n      doc.rect(tableX, tableY, totalWidth, headerHeight).fill(\"#f5f5f5\");\n      doc.rect(tableX, tableY, totalWidth, headerHeight).strokeColor(\"#d1d5db\").lineWidth(1).stroke();\n      doc.restore();\n\n      // Header text\n      doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.black);\n      let headerX = tableX + 8;\n      columns.forEach(col => {\n        doc.text(col.label, headerX, tableY + 10, { \n          width: col.width - 16, \n          align: col.align \n        });\n        headerX += col.width;\n      });\n\n      tableY += headerHeight;\n\n      // Table rows with alternating colors\n      reportData.attendanceData.forEach((record: any, index: number) => {\n        if (tableY > 730) {\n          doc.addPage();\n          tableY = 50;\n          \n          // Repeat header on new page\n          doc.save();\n          doc.rect(tableX, tableY, totalWidth, headerHeight).fill(\"#f5f5f5\");\n          doc.rect(tableX, tableY, totalWidth, headerHeight).strokeColor(\"#d1d5db\").lineWidth(1).stroke();\n          doc.restore();\n\n          doc.fontSize(10).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.black);\n          let repeatHeaderX = tableX + 8;\n          columns.forEach(col => {\n            doc.text(col.label, repeatHeaderX, tableY + 10, { \n              width: col.width - 16, \n              align: col.align \n            });\n            repeatHeaderX += col.width;\n          });\n          tableY += headerHeight;\n        }\n\n        const rowHeight = 28;\n        const bgColor = index % 2 === 0 ? \"#ffffff\" : \"#fafafa\";\n\n        // Row background\n        doc.save();\n        doc.rect(tableX, tableY, totalWidth, rowHeight).fill(bgColor);\n        doc.rect(tableX, tableY, totalWidth, rowHeight).strokeColor(\"#e5e7eb\").lineWidth(0.5).stroke();\n        doc.restore();\n\n        // Calculate hours worked\n        let hoursWorked = \"-\";\n        if (record.checkInTime && record.checkOutTime) {\n          try {\n            const checkIn = new Date(`2000-01-01 ${record.checkInTime}`);\n            const checkOut = new Date(`2000-01-01 ${record.checkOutTime}`);\n            const hours = (checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60);\n            hoursWorked = hours > 0 ? hours.toFixed(1) : \"-\";\n          } catch (e) {\n            hoursWorked = \"-\";\n          }\n        }\n\n        const dayOfWeek = format(new Date(record.date), \"EEE\");\n\n        // Row data\n        const rowData = isEmployeeJobCard \n          ? [\n              { text: record.date, width: 90, align: \"left\" as const, bold: false },\n              { text: dayOfWeek, width: 70, align: \"left\" as const, bold: false },\n              { text: record.checkInTime || \"-\", width: 85, align: \"left\" as const, bold: false },\n              { text: record.checkOutTime || \"-\", width: 85, align: \"left\" as const, bold: false },\n              { text: record.status, width: 105, align: \"left\" as const, bold: true },\n              { text: hoursWorked, width: 80, align: \"right\" as const, bold: false },\n            ]\n          : [\n              { text: record.date, width: 85, align: \"left\" as const, bold: false },\n              { text: record.employeeName, width: 120, align: \"left\" as const, bold: false },\n              { text: record.department, width: 90, align: \"left\" as const, bold: false },\n              { text: record.status, width: 80, align: \"center\" as const, bold: true },\n              { text: record.checkInTime || \"-\", width: 70, align: \"center\" as const, bold: false },\n              { text: record.checkOutTime || \"-\", width: 70, align: \"center\" as const, bold: false },\n            ];\n\n        // Row text\n        doc.fontSize(9).fillColor(BRAND_COLORS.black);\n        let rowX = tableX + 8;\n        rowData.forEach(col => {\n          if (col.bold) {\n            doc.font(\"Helvetica-Bold\");\n          } else {\n            doc.font(\"Helvetica\");\n          }\n          doc.text(col.text, rowX, tableY + 9, { \n            width: col.width - 16, \n            align: col.align \n          });\n          rowX += col.width;\n        });\n\n        tableY += rowHeight;\n      });\n\n      // ===== PROFESSIONAL FOOTER =====\n      const footerY = 770;\n      doc.moveTo(40, footerY).lineTo(555, footerY).strokeColor(BRAND_COLORS.border).lineWidth(1).stroke();\n      \n      doc.fontSize(9).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.black);\n      doc.text(\"MaxTech BD | Smart Agency Control Hub\", 40, footerY + 12, { width: 515, align: \"center\" });\n      \n      doc.fontSize(8).font(\"Helvetica\").fillColor(BRAND_COLORS.gray);\n      doc.text(\"Developed by MaxTech BD IT Team\", 40, footerY + 26, { width: 515, align: \"center\" });\n\n      doc.end();\n    } catch (error: any) {\n      console.error(\"HR Attendance Report PDF export error:\", error);\n      res.status(500).json({ error: \"Failed to export PDF\" });\n    }\n  });\n\n  // HR Attendance Report Excel Export - Enhanced Job Card Format\n  app.get(\"/api/hr-attendance-report/export-excel\", authenticateToken, async (req: AuthRequest, res) => {\n    try {\n      // Only admin and operational_head can export attendance reports\n      if (req.userRole !== \"admin\" && req.userRole !== \"operational_head\") {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      const reportData = JSON.parse(decodeURIComponent(req.query.data as string));\n      const isEmployeeJobCard = reportData.attendanceData.length > 0 && \n        reportData.attendanceData.every((r: any) => r.employeeId === reportData.attendanceData[0].employeeId);\n\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(isEmployeeJobCard ? \"Job Card\" : \"Attendance Report\");\n\n      const maxCol = isEmployeeJobCard ? \"G\" : \"F\";\n\n      // Company header\n      worksheet.mergeCells(`A1:${maxCol}1`);\n      worksheet.getCell(\"A1\").value = COMPANY_INFO.name;\n      worksheet.getCell(\"A1\").font = { size: 18, bold: true, color: { argb: \"FFE11D26\" } };\n      worksheet.getCell(\"A1\").alignment = { horizontal: \"center\", vertical: \"middle\" };\n      worksheet.getRow(1).height = 25;\n\n      worksheet.mergeCells(`A2:${maxCol}2`);\n      worksheet.getCell(\"A2\").value = COMPANY_INFO.address1;\n      worksheet.getCell(\"A2\").alignment = { horizontal: \"center\" };\n\n      worksheet.mergeCells(`A3:${maxCol}3`);\n      worksheet.getCell(\"A3\").value = `${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`;\n      worksheet.getCell(\"A3\").alignment = { horizontal: \"center\" };\n\n      worksheet.mergeCells(`A4:${maxCol}4`);\n      worksheet.getCell(\"A4\").value = `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`;\n      worksheet.getCell(\"A4\").alignment = { horizontal: \"center\" };\n\n      // Report title\n      worksheet.mergeCells(`A6:${maxCol}6`);\n      worksheet.getCell(\"A6\").value = isEmployeeJobCard ? \"EMPLOYEE JOB CARD\" : \"HR ATTENDANCE REPORT\";\n      worksheet.getCell(\"A6\").font = { size: 16, bold: true, color: { argb: \"FFE11D26\" } };\n      worksheet.getCell(\"A6\").alignment = { horizontal: \"center\", vertical: \"middle\" };\n      worksheet.getRow(6).height = 22;\n\n      worksheet.mergeCells(`A7:${maxCol}7`);\n      worksheet.getCell(\"A7\").value = `Period: ${reportData.dateRange.start} to ${reportData.dateRange.end}`;\n      worksheet.getCell(\"A7\").alignment = { horizontal: \"center\" };\n\n      let row = 9;\n\n      // Employee info for job card\n      if (isEmployeeJobCard) {\n        worksheet.mergeCells(`A${row}:B${row}`);\n        worksheet.getCell(`A${row}`).value = \"Employee Name:\";\n        worksheet.getCell(`A${row}`).font = { bold: true };\n        worksheet.mergeCells(`C${row}:${maxCol}${row}`);\n        worksheet.getCell(`C${row}`).value = reportData.attendanceData[0].employeeName;\n        row++;\n\n        worksheet.mergeCells(`A${row}:B${row}`);\n        worksheet.getCell(`A${row}`).value = \"Employee Code:\";\n        worksheet.getCell(`A${row}`).font = { bold: true };\n        worksheet.getCell(`C${row}`).value = reportData.attendanceData[0].employeeCode;\n        worksheet.mergeCells(`D${row}:E${row}`);\n        worksheet.getCell(`D${row}`).value = \"Department:\";\n        worksheet.getCell(`D${row}`).font = { bold: true };\n        worksheet.mergeCells(`F${row}:${maxCol}${row}`);\n        worksheet.getCell(`F${row}`).value = reportData.attendanceData[0].department;\n        row += 2;\n      }\n\n      // Enhanced Summary section with all analytics\n      worksheet.mergeCells(`A${row}:${maxCol}${row}`);\n      worksheet.getCell(`A${row}`).value = \"ATTENDANCE SUMMARY\";\n      worksheet.getCell(`A${row}`).font = { size: 14, bold: true, color: { argb: \"FFFFFFFF\" } };\n      worksheet.getCell(`A${row}`).fill = {\n        type: \"pattern\",\n        pattern: \"solid\",\n        fgColor: { argb: \"FFE11D26\" }\n      };\n      worksheet.getCell(`A${row}`).alignment = { horizontal: \"center\", vertical: \"middle\" };\n      worksheet.getRow(row).height = 25;\n      row++;\n\n      // Summary grid\n      const summaryData = [\n        [\"Working Days\", reportData.summary.workingDays || reportData.summary.totalDays, \"Present\", `${reportData.summary.presentCount} (${reportData.summary.presentPercentage}%)`],\n        [\"On-Time\", reportData.summary.onTimeCount || \"0\", \"Late\", `${reportData.summary.lateCount} (${reportData.summary.latePercentage}%)`],\n        [\"Half-Day\", `${reportData.summary.halfDayCount} (${reportData.summary.halfDayPercentage}%)`, \"Absent\", `${reportData.summary.absentCount} (${reportData.summary.absentPercentage}%)`],\n        [\"Total Hours\", `${reportData.summary.totalHoursWorked || \"0\"} hrs`, \"Overtime\", `${reportData.summary.overtimeHours || \"0\"} hrs`],\n      ];\n\n      summaryData.forEach((dataRow, idx) => {\n        worksheet.getCell(`A${row + idx}`).value = dataRow[0];\n        worksheet.getCell(`A${row + idx}`).font = { bold: true };\n        worksheet.getCell(`A${row + idx}`).fill = { type: \"pattern\", pattern: \"solid\", fgColor: { argb: \"FFF3F4F6\" } };\n        \n        worksheet.getCell(`B${row + idx}`).value = dataRow[1];\n        worksheet.getCell(`B${row + idx}`).font = { bold: true, size: 12 };\n        \n        worksheet.getCell(`C${row + idx}`).value = dataRow[2];\n        worksheet.getCell(`C${row + idx}`).font = { bold: true };\n        worksheet.getCell(`C${row + idx}`).fill = { type: \"pattern\", pattern: \"solid\", fgColor: { argb: \"FFF3F4F6\" } };\n        \n        worksheet.mergeCells(`D${row + idx}:${maxCol}${row + idx}`);\n        worksheet.getCell(`D${row + idx}`).value = dataRow[3];\n        worksheet.getCell(`D${row + idx}`).font = { bold: true, size: 12 };\n      });\n      row += summaryData.length + 2;\n\n      // Daily attendance table\n      worksheet.mergeCells(`A${row}:${maxCol}${row}`);\n      worksheet.getCell(`A${row}`).value = \"DAILY ATTENDANCE RECORD\";\n      worksheet.getCell(`A${row}`).font = { size: 13, bold: true, color: { argb: \"FFFFFFFF\" } };\n      worksheet.getCell(`A${row}`).fill = {\n        type: \"pattern\",\n        pattern: \"solid\",\n        fgColor: { argb: \"FFE11D26\" }\n      };\n      worksheet.getCell(`A${row}`).alignment = { horizontal: \"center\", vertical: \"middle\" };\n      worksheet.getRow(row).height = 22;\n      row++;\n\n      // Table headers\n      if (isEmployeeJobCard) {\n        [\"A\", \"B\", \"C\", \"D\", \"E\", \"F\", \"G\"].forEach((col, i) => {\n          const headers = [\"Date\", \"Day\", \"Check In\", \"Check Out\", \"Status\", \"Hours\", \"Remarks\"];\n          const cell = worksheet.getCell(`${col}${row}`);\n          cell.value = headers[i];\n          cell.fill = { type: \"pattern\", pattern: \"solid\", fgColor: { argb: \"FF1E1E1E\" } };\n     ","path":null,"size_bytes":360000,"size_tokens":null},"client/src/pages/audit-logs.tsx":{"content":"import { FileCheck } from \"lucide-react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { type AuditLog } from \"@shared/schema\";\n\nexport default function AuditLogs() {\n  const { data: logs, isLoading } = useQuery<AuditLog[]>({\n    queryKey: [\"/api/audit-logs\"],\n  });\n\n  const getActionColor = (action: string) => {\n    if (action.includes(\"create\")) return \"bg-green-100 text-green-700 dark:bg-green-950 dark:text-green-300\";\n    if (action.includes(\"update\")) return \"bg-blue-100 text-blue-700 dark:bg-blue-950 dark:text-blue-300\";\n    if (action.includes(\"delete\")) return \"bg-red-100 text-red-700 dark:bg-red-950 dark:text-red-300\";\n    return \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\";\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"h-8 bg-muted rounded w-32 mb-6 animate-pulse\" />\n        <div className=\"space-y-2\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardContent className=\"p-4\">\n                <div className=\"h-5 bg-muted rounded w-3/4 mb-2 animate-pulse\" />\n                <div className=\"h-4 bg-muted rounded w-1/2 animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Audit Logs</h1>\n        <p className=\"text-sm text-muted-foreground\">Track all system activities</p>\n      </div>\n\n      {!logs || logs.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n              <FileCheck className=\"w-8 h-8 text-muted-foreground\" />\n            </div>\n            <h3 className=\"text-lg font-semibold mb-2\">No activity logs</h3>\n            <p className=\"text-sm text-muted-foreground\">System activities will appear here</p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-2\">\n          {logs.map((log) => (\n            <Card key={log.id} data-testid={`log-${log.id}`}>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-3 mb-1\">\n                      <Badge className={getActionColor(log.action)} data-testid={`badge-action-${log.id}`}>\n                        {log.action}\n                      </Badge>\n                      <span className=\"text-sm font-medium\">{log.resourceType}</span>\n                      {log.resourceId && (\n                        <span className=\"text-xs font-mono text-muted-foreground\">\n                          ID: {log.resourceId.slice(0, 8)}...\n                        </span>\n                      )}\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {new Date(log.createdAt).toLocaleString()}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":3364,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport path from \"path\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { schedulerService } from \"./services/scheduler\";\nimport { serializeRecord } from \"./utils/serialize\";\n\nconst app = express();\n\n// Serve uploaded files (chat uploads, etc.) as static files\napp.use(\"/uploads\", express.static(path.join(process.cwd(), \"uploads\")));\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\n// Integrated logging + serialization middleware\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: any = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    // Serialize the response payload based on type\n    let serialized: any;\n    \n    if (bodyJson === null || bodyJson === undefined) {\n      // Pass through null/undefined\n      serialized = bodyJson;\n    } else if (Array.isArray(bodyJson)) {\n      // For arrays, map over items and serialize each object\n      serialized = bodyJson.map(item => {\n        if (item && typeof item === 'object' && !(item instanceof Date)) {\n          return serializeRecord(item);\n        }\n        return item;\n      });\n    } else if (typeof bodyJson === 'object' && !(bodyJson instanceof Date)) {\n      // For objects, use serializeRecord to handle nested Dates\n      serialized = serializeRecord(bodyJson);\n    } else {\n      // For primitives (string, number, boolean), pass through\n      serialized = bodyJson;\n    }\n    \n    capturedJsonResponse = serialized;\n    return originalResJson.apply(res, [serialized, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse !== undefined) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n    \n    // Start scheduler for email reminders\n    schedulerService.start();\n  });\n\n  // Graceful shutdown\n  process.on('SIGTERM', () => {\n    log('SIGTERM received, shutting down gracefully');\n    schedulerService.stop();\n    server.close(() => {\n      log('Server closed');\n      process.exit(0);\n    });\n  });\n})();\n","path":null,"size_bytes":3639,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"shared/date-utils.ts":{"content":"/**\n * Date Handling Utilities\n * \n * Provides consistent date serialization/deserialization across the application\n * to prevent timezone drift and handle optional dates properly.\n */\n\n/**\n * Regex for date-only strings (YYYY-MM-DD)\n */\nexport const DATE_ONLY_REGEX = /^\\d{4}-\\d{2}-\\d{2}$/;\n\n/**\n * Regex for ISO datetime strings\n */\nexport const DATE_TIME_REGEX = /^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{3})?Z?$/;\n\n/**\n * Converts a Date object to an ISO datetime string\n * @param date - JavaScript Date object or ISO string\n * @returns ISO datetime string (e.g., \"2025-11-16T12:30:00.000Z\")\n */\nexport function toDateTimeString(date: Date | string | null | undefined): string | null {\n  if (!date) return null;\n  if (typeof date === 'string') return date;\n  return date.toISOString();\n}\n\n/**\n * Converts a Date object to a date-only string (YYYY-MM-DD)\n * Prevents timezone drift by extracting only the date portion\n * @param date - JavaScript Date object or date string\n * @returns Date-only string (e.g., \"2025-11-16\")\n */\nexport function toDateOnlyString(date: Date | string | null | undefined): string | null {\n  if (!date) return null;\n  \n  // If already a date-only string, return as-is\n  if (typeof date === 'string' && DATE_ONLY_REGEX.test(date)) {\n    return date;\n  }\n  \n  // Convert to Date if string, then extract date portion\n  const dateObj = typeof date === 'string' ? new Date(date) : date;\n  return dateObj.toISOString().split('T')[0];\n}\n\n/**\n * Parses an optional date string to a Date object\n * Handles null, undefined, and empty strings gracefully\n * Validates that the resulting Date is valid\n * @param value - Date string, Date object, null, undefined, or empty string\n * @returns Date object or null\n */\nexport function parseOptionalDate(value: string | Date | null | undefined): Date | null {\n  if (!value || value === '') return null;\n  if (value instanceof Date) {\n    if (isNaN(value.getTime())) return null;\n    return value;\n  }\n  const date = new Date(value);\n  if (isNaN(date.getTime())) return null;\n  return date;\n}\n\n/**\n * Parses a required date string to a Date object\n * Throws error if value is missing or invalid\n * @param value - Date string or Date object\n * @returns Date object\n */\nexport function parseRequiredDate(value: string | Date): Date {\n  if (!value || value === '') {\n    throw new Error('Date value is required');\n  }\n  if (value instanceof Date) return value;\n  const date = new Date(value);\n  if (isNaN(date.getTime())) {\n    throw new Error(`Invalid date value: ${value}`);\n  }\n  return date;\n}\n\n/**\n * Normalizes a date value from form inputs\n * Converts empty strings to null, preserves valid dates\n * @param value - Form input value (string, Date, or empty)\n * @returns Date-only string or null\n */\nexport function normalizeDateInput(value: string | Date | null | undefined): string | null {\n  if (!value || value === '') return null;\n  return toDateOnlyString(value);\n}\n","path":null,"size_bytes":2936,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"server/services/scheduler.ts":{"content":"import { db } from \"../db\";\nimport { leads, invoices, users, clients } from \"@shared/schema\";\nimport { eq, and, lte, gte, sql } from \"drizzle-orm\";\nimport { emailService } from \"./email\";\nimport { attendanceSyncService } from \"./attendanceSync\";\n\nclass SchedulerService {\n  private intervals: NodeJS.Timeout[] = [];\n\n  start() {\n    // Check for lead follow-ups every hour\n    const leadInterval = setInterval(() => {\n      this.checkLeadFollowUps();\n    }, 60 * 60 * 1000); // 1 hour\n\n    // Check for overdue invoices every hour, but only at 9 AM\n    const invoiceInterval = setInterval(() => {\n      const now = new Date();\n      if (now.getHours() === 9) {\n        this.checkInvoiceReminders();\n      }\n    }, 60 * 60 * 1000); // 1 hour\n\n    // Sync attendance devices every minute\n    const deviceSyncInterval = setInterval(() => {\n      attendanceSyncService.syncAllDevices();\n    }, 60 * 1000); // 1 minute\n\n    this.intervals.push(leadInterval, invoiceInterval, deviceSyncInterval);\n\n    // Run lead follow-ups immediately on startup\n    this.checkLeadFollowUps();\n    \n    // Only run invoice reminders if it's 9 AM\n    const now = new Date();\n    if (now.getHours() === 9) {\n      this.checkInvoiceReminders();\n    }\n\n    // Run initial device sync on startup\n    attendanceSyncService.syncAllDevices();\n\n    console.log(\"Scheduler service started (leads, invoices, device sync)\");\n  }\n\n  stop() {\n    this.intervals.forEach(interval => clearInterval(interval));\n    this.intervals = [];\n    console.log(\"Scheduler service stopped\");\n  }\n\n  private async checkLeadFollowUps() {\n    try {\n      const now = new Date();\n      const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n\n      // Get leads with follow-up date now or in the past, not reminded in last 24 hours\n      // Skip leads without a followUpDate set\n      const leadsToFollow = await db\n        .select()\n        .from(leads)\n        .where(\n          and(\n            sql`${leads.followUpDate} IS NOT NULL`,\n            lte(leads.followUpDate, now),\n            sql`${leads.status} NOT IN ('converted', 'lost')`,\n            sql`(${leads.lastFollowUpReminderAt} IS NULL OR ${leads.lastFollowUpReminderAt} < ${twentyFourHoursAgo})`\n          )\n        );\n\n      let sentCount = 0;\n      let skippedCount = 0;\n\n      for (const lead of leadsToFollow) {\n        if (!lead.assignedTo) {\n          skippedCount++;\n          console.log(`Skipped lead ${lead.name}: No assignee`);\n          continue;\n        }\n\n        const [assignedUser] = await db\n          .select()\n          .from(users)\n          .where(eq(users.id, lead.assignedTo))\n          .limit(1);\n\n        if (!assignedUser) {\n          skippedCount++;\n          console.log(`Skipped lead ${lead.name}: Assignee not found`);\n          continue;\n        }\n\n        const emailSent = await emailService.sendLeadFollowUp({ ...lead, assignedUser });\n        \n        if (emailSent) {\n          // Update last reminder timestamp\n          await db\n            .update(leads)\n            .set({ lastFollowUpReminderAt: now })\n            .where(eq(leads.id, lead.id));\n          \n          sentCount++;\n          console.log(`Follow-up email sent for lead: ${lead.name}`);\n        } else {\n          skippedCount++;\n          console.log(`Failed to send email for lead: ${lead.name}`);\n        }\n      }\n\n      if (sentCount > 0 || skippedCount > 0) {\n        console.log(`Lead follow-ups: ${sentCount} sent, ${skippedCount} skipped`);\n      }\n    } catch (error) {\n      console.error(\"Error checking lead follow-ups:\", error);\n    }\n  }\n\n  private async checkInvoiceReminders() {\n    try {\n      const now = new Date();\n      const threeDaysFromNow = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);\n      const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n\n      // Get invoices that are:\n      // 1. Overdue (dueDate < now) OR Due soon (dueDate within 3 days)\n      // 2. Status is 'sent' or 'overdue' (not paid/draft)\n      // 3. Not reminded in last 24 hours (prevent daily spam)\n      const invoicesToRemind = await db\n        .select()\n        .from(invoices)\n        .where(\n          and(\n            lte(invoices.dueDate, threeDaysFromNow),\n            sql`${invoices.status} IN ('sent', 'overdue')`,\n            sql`(${invoices.lastReminderSentAt} IS NULL OR ${invoices.lastReminderSentAt} < ${yesterday})`\n          )\n        );\n\n      let sentCount = 0;\n      let skippedCount = 0;\n      let updatedToOverdue = 0;\n\n      for (const invoice of invoicesToRemind) {\n        const [client] = await db\n          .select()\n          .from(clients)\n          .where(eq(clients.id, invoice.clientId))\n          .limit(1);\n\n        if (!client) {\n          skippedCount++;\n          console.log(`Skipped invoice ${invoice.invoiceNumber}: Client not found`);\n          continue;\n        }\n\n        const emailSent = await emailService.sendInvoiceReminder({ ...invoice, client });\n        \n        if (emailSent) {\n          // Update last reminder timestamp\n          const updates: any = { lastReminderSentAt: now };\n          \n          // Update status to overdue if past due date\n          if (new Date(invoice.dueDate) < now && invoice.status !== \"overdue\") {\n            updates.status = \"overdue\";\n            updatedToOverdue++;\n          }\n          \n          await db\n            .update(invoices)\n            .set(updates)\n            .where(eq(invoices.id, invoice.id));\n          \n          sentCount++;\n          console.log(`Invoice reminder sent: ${invoice.invoiceNumber}`);\n        } else {\n          skippedCount++;\n          console.log(`Failed to send email for invoice: ${invoice.invoiceNumber}`);\n        }\n      }\n\n      if (sentCount > 0 || skippedCount > 0) {\n        console.log(`Invoice reminders: ${sentCount} sent, ${skippedCount} skipped, ${updatedToOverdue} marked overdue`);\n      }\n    } catch (error) {\n      console.error(\"Error checking invoice reminders:\", error);\n    }\n  }\n}\n\nexport const schedulerService = new SchedulerService();\n","path":null,"size_bytes":6042,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/pages/projects.tsx":{"content":"import { useState } from \"react\";\nimport { Plus, Calendar, DollarSign } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { insertProjectSchema, type Project, type Client } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { normalizeProjectData } from \"@/lib/normalizeDateInputs\";\n\nconst projectFormSchema = insertProjectSchema.extend({\n  deadline: z.string().optional(),\n});\n\ntype ProjectFormData = z.infer<typeof projectFormSchema>;\n\nexport default function Projects() {\n  const [open, setOpen] = useState(false);\n  const [editingProject, setEditingProject] = useState<Project | null>(null);\n  const { toast } = useToast();\n  const { data: projects, isLoading } = useQuery<Project[]>({\n    queryKey: [\"/api/projects\"],\n  });\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: ProjectFormData) => apiRequest(\"POST\", \"/api/projects\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\"] });\n      toast({ title: \"Success\", description: \"Project created successfully\" });\n      setOpen(false);\n      setEditingProject(null);\n      form.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: ProjectFormData }) =>\n      apiRequest(\"PATCH\", `/api/projects/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\"] });\n      toast({ title: \"Success\", description: \"Project updated successfully\" });\n      setOpen(false);\n      setEditingProject(null);\n      form.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const form = useForm<ProjectFormData>({\n    resolver: zodResolver(projectFormSchema),\n    defaultValues: {\n      clientId: \"\",\n      name: \"\",\n      description: \"\",\n      status: \"planning\",\n      budget: \"0\",\n      progress: 0,\n    },\n  });\n\n  const onSubmit = async (data: ProjectFormData) => {\n    const normalizedData = normalizeProjectData(data);\n    if (editingProject) {\n      updateMutation.mutate({ id: editingProject.id, data: normalizedData });\n    } else {\n      createMutation.mutate(normalizedData);\n    }\n  };\n\n  const handleEdit = (project: Project) => {\n    setEditingProject(project);\n    form.reset({\n      clientId: project.clientId,\n      name: project.name,\n      description: project.description || \"\",\n      status: project.status,\n      budget: project.budget || \"0\",\n      progress: project.progress ?? 0,\n      deadline: project.deadline ? (typeof project.deadline === 'string' ? project.deadline : new Date(project.deadline).toISOString().split('T')[0]) : \"\",\n    });\n    setOpen(true);\n  };\n\n  const handleAddNew = () => {\n    setEditingProject(null);\n    form.reset({\n      clientId: \"\",\n      name: \"\",\n      description: \"\",\n      status: \"planning\",\n      budget: \"0\",\n      progress: 0,\n    });\n    setOpen(true);\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"planning\": return \"bg-blue-100 text-blue-700 dark:bg-blue-950 dark:text-blue-300\";\n      case \"active\": return \"bg-green-100 text-green-700 dark:bg-green-950 dark:text-green-300\";\n      case \"on-hold\": return \"bg-yellow-100 text-yellow-700 dark:bg-yellow-950 dark:text-yellow-300\";\n      case \"completed\": return \"bg-purple-100 text-purple-700 dark:bg-purple-950 dark:text-purple-300\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"h-8 bg-muted rounded w-32 mb-6 animate-pulse\" />\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardContent className=\"p-6\">\n                <div className=\"h-6 bg-muted rounded w-3/4 mb-3 animate-pulse\" />\n                <div className=\"h-4 bg-muted rounded w-1/2 mb-4 animate-pulse\" />\n                <div className=\"h-2 bg-muted rounded w-full animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Projects</h1>\n          <p className=\"text-sm text-muted-foreground\">Manage client projects</p>\n        </div>\n        <Button data-testid=\"button-add-project\" onClick={handleAddNew}>\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Add Project\n        </Button>\n        <Dialog open={open} onOpenChange={setOpen}>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>{editingProject ? \"Edit Project\" : \"Add New Project\"}</DialogTitle>\n              <DialogDescription>\n                {editingProject ? \"Update project information\" : \"Create a new project\"}\n              </DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Project Name</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"Website Redesign\" {...field} data-testid=\"input-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <FormField\n                    control={form.control}\n                    name=\"clientId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Client</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-client\">\n                              <SelectValue placeholder=\"Select client\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            {clients?.map((client) => (\n                              <SelectItem key={client.id} value={client.id}>\n                                {client.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"status\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Status</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-status\">\n                              <SelectValue />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            <SelectItem value=\"planning\">Planning</SelectItem>\n                            <SelectItem value=\"active\">Active</SelectItem>\n                            <SelectItem value=\"on-hold\">On Hold</SelectItem>\n                            <SelectItem value=\"completed\">Completed</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"budget\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Budget</FormLabel>\n                        <FormControl>\n                          <Input type=\"number\" placeholder=\"5000\" {...field} value={field.value ?? \"\"} data-testid=\"input-budget\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"deadline\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Deadline</FormLabel>\n                        <FormControl>\n                          <Input type=\"date\" {...field} value={field.value ?? \"\"} data-testid=\"input-deadline\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <FormField\n                  control={form.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Description</FormLabel>\n                      <FormControl>\n                        <Textarea placeholder=\"Project details...\" {...field} value={field.value ?? \"\"} data-testid=\"input-description\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"flex justify-end gap-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setOpen(false)}>Cancel</Button>\n                  <Button type=\"submit\" data-testid=\"button-submit-project\">\n                    {editingProject ? \"Update Project\" : \"Create Project\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {!projects || projects.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n              <Plus className=\"w-8 h-8 text-muted-foreground\" />\n            </div>\n            <h3 className=\"text-lg font-semibold mb-2\">No projects yet</h3>\n            <p className=\"text-sm text-muted-foreground mb-4\">Create your first project</p>\n            <Button onClick={() => setOpen(true)}>Add Project</Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {projects.map((project) => (\n            <Card \n              key={project.id} \n              className=\"hover-elevate cursor-pointer\" \n              data-testid={`card-project-${project.id}`}\n              onClick={() => handleEdit(project)}\n            >\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-start justify-between mb-3\">\n                  <h3 className=\"font-semibold text-lg\" data-testid={`text-project-name-${project.id}`}>\n                    {project.name}\n                  </h3>\n                  <Badge className={getStatusColor(project.status)} data-testid={`badge-status-${project.id}`}>\n                    {project.status}\n                  </Badge>\n                </div>\n                {project.description && (\n                  <p className=\"text-sm text-muted-foreground mb-4 line-clamp-2\">{project.description}</p>\n                )}\n                <div className=\"space-y-3\">\n                  <div>\n                    <div className=\"flex items-center justify-between text-sm mb-1\">\n                      <span className=\"text-muted-foreground\">Progress</span>\n                      <span className=\"font-medium\">{project.progress}%</span>\n                    </div>\n                    <Progress value={project.progress ?? 0} />\n                  </div>\n                  <div className=\"flex items-center justify-between text-sm\">\n                    {project.budget && (\n                      <div className=\"flex items-center gap-1 text-muted-foreground\">\n                        <DollarSign className=\"w-4 h-4\" />\n                        <span>${project.budget}</span>\n                      </div>\n                    )}\n                    {project.deadline && (\n                      <div className=\"flex items-center gap-1 text-muted-foreground\">\n                        <Calendar className=\"w-4 h-4\" />\n                        <span>{new Date(project.deadline).toLocaleDateString()}</span>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14059,"size_tokens":null},"server/middleware/auth.ts":{"content":"import { Request, Response, NextFunction } from \"express\";\nimport jwt from \"jsonwebtoken\";\n\nconst JWT_SECRET = process.env.JWT_SECRET || \"dev-secret-change-in-production\";\n\nexport interface AuthRequest extends Request {\n  userId?: string;\n  userRole?: string;\n}\n\nexport function authenticateToken(req: AuthRequest, res: Response, next: NextFunction) {\n  const authHeader = req.headers[\"authorization\"];\n  const token = authHeader && authHeader.split(\" \")[1];\n\n  if (!token) {\n    return res.status(401).json({ error: \"Access token required\" });\n  }\n\n  jwt.verify(token, JWT_SECRET, (err, decoded: any) => {\n    if (err) {\n      return res.status(403).json({ error: \"Invalid or expired token\" });\n    }\n    req.userId = decoded.userId;\n    req.userRole = decoded.role;\n    next();\n  });\n}\n\nexport function generateToken(userId: string, role: string): string {\n  return jwt.sign({ userId, role }, JWT_SECRET, { expiresIn: \"7d\" });\n}\n","path":null,"size_bytes":931,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 0 0% 100%;\n  --foreground: 220 9% 12%;\n  --border: 220 8% 88%;\n  --card: 220 4% 98%;\n  --card-foreground: 220 9% 12%;\n  --card-border: 220 6% 94%;\n  --sidebar: 220 5% 96%;\n  --sidebar-foreground: 220 9% 12%;\n  --sidebar-border: 220 6% 92%;\n  --sidebar-primary: 350 85% 42%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 220 8% 88%;\n  --sidebar-accent-foreground: 220 9% 12%;\n  --sidebar-ring: 350 85% 42%;\n  --popover: 220 6% 94%;\n  --popover-foreground: 220 9% 12%;\n  --popover-border: 220 8% 88%;\n  --primary: 350 85% 42%;\n  --primary-foreground: 0 0% 100%;\n  --secondary: 220 10% 90%;\n  --secondary-foreground: 220 9% 12%;\n  --muted: 220 12% 92%;\n  --muted-foreground: 220 8% 35%;\n  --accent: 220 15% 91%;\n  --accent-foreground: 220 9% 12%;\n  --destructive: 0 84% 48%;\n  --destructive-foreground: 0 84% 98%;\n  --input: 220 8% 78%;\n  --ring: 350 85% 42%;\n  --chart-1: 350 85% 42%;\n  --chart-2: 142 76% 36%;\n  --chart-3: 262 83% 58%;\n  --chart-4: 38 92% 50%;\n  --chart-5: 340 82% 52%;\n  --font-sans: Inter, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: JetBrains Mono, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(220 8% 12% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(220 8% 12% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(220 8% 12% / 0.00), 0px 1px 2px -1px hsl(220 8% 12% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(220 8% 12% / 0.00), 0px 1px 2px -1px hsl(220 8% 12% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(220 8% 12% / 0.00), 0px 2px 4px -1px hsl(220 8% 12% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(220 8% 12% / 0.00), 0px 4px 6px -1px hsl(220 8% 12% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(220 8% 12% / 0.00), 0px 8px 10px -1px hsl(220 8% 12% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(220 8% 12% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 220 15% 8%;\n  --foreground: 220 8% 95%;\n  --border: 220 12% 18%;\n  --card: 220 14% 10%;\n  --card-foreground: 220 8% 95%;\n  --card-border: 220 12% 14%;\n  --sidebar: 220 13% 12%;\n  --sidebar-foreground: 220 8% 95%;\n  --sidebar-border: 220 12% 16%;\n  --sidebar-primary: 350 85% 55%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 220 15% 18%;\n  --sidebar-accent-foreground: 220 8% 95%;\n  --sidebar-ring: 350 85% 55%;\n  --popover: 220 14% 15%;\n  --popover-foreground: 220 8% 95%;\n  --popover-border: 220 12% 20%;\n  --primary: 350 85% 55%;\n  --primary-foreground: 0 0% 100%;\n  --secondary: 220 16% 20%;\n  --secondary-foreground: 220 8% 95%;\n  --muted: 220 18% 22%;\n  --muted-foreground: 220 10% 65%;\n  --accent: 220 20% 24%;\n  --accent-foreground: 220 8% 95%;\n  --destructive: 0 84% 48%;\n  --destructive-foreground: 0 84% 98%;\n  --input: 220 12% 32%;\n  --ring: 350 85% 55%;\n  --chart-1: 350 85% 65%;\n  --chart-2: 142 76% 55%;\n  --chart-3: 262 83% 68%;\n  --chart-4: 38 92% 60%;\n  --chart-5: 340 82% 62%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(220 8% 95% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(220 8% 95% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(220 8% 95% / 0.00), 0px 1px 2px -1px hsl(220 8% 95% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(220 8% 95% / 0.00), 0px 1px 2px -1px hsl(220 8% 95% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(220 8% 95% / 0.00), 0px 2px 4px -1px hsl(220 8% 95% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(220 8% 95% / 0.00), 0px 4px 6px -1px hsl(220 8% 95% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(220 8% 95% / 0.00), 0px 8px 10px -1px hsl(220 8% 95% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(220 8% 95% / 0.00);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","path":null,"size_bytes":10721,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/app-sidebar.tsx":{"content":"import { LayoutDashboard, Users, UserPlus, Briefcase, CheckSquare, UsersRound, Clock, DollarSign, FileText, CreditCard, Upload, MessageSquare, FileCheck, Settings, LogOut, UserCog, Building2, Fingerprint, CalendarDays, Wallet, PieChart, FolderOpen, Receipt, TrendingUp, BookOpen, ClipboardList, ChevronDown, ChevronRight, User, KeyRound } from \"lucide-react\";\nimport { Link, useLocation } from \"wouter\";\nimport { useState } from \"react\";\nimport logoImage from \"@assets/Untitled design (1)_1763794635122.png\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSub,\n  SidebarMenuSubItem,\n  SidebarMenuSubButton,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\nimport { useAuth } from \"@/lib/auth-context\";\n\n// Main Menu Items\nconst mainMenuItems = [\n  {\n    title: \"Dashboard\",\n    url: \"/\",\n    icon: LayoutDashboard,\n    roles: [\"admin\", \"operational_head\", \"developer\", \"client\"],\n  },\n  {\n    title: \"Leads\",\n    url: \"/leads\",\n    icon: UserPlus,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Clients\",\n    url: \"/clients\",\n    icon: Users,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Projects\",\n    url: \"/projects\",\n    icon: Briefcase,\n    roles: [\"admin\", \"operational_head\", \"developer\", \"client\"],\n  },\n  {\n    title: \"Tasks\",\n    url: \"/tasks\",\n    icon: CheckSquare,\n    roles: [\"admin\", \"operational_head\", \"developer\", \"client\"],\n  },\n  {\n    title: \"Team\",\n    url: \"/team\",\n    icon: UsersRound,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Project Credentials\",\n    url: \"/project-credentials\",\n    icon: KeyRound,\n    roles: [\"admin\", \"operational_head\"],\n  },\n];\n\n// Communication with sub-items\nconst communicationItem = {\n  title: \"Communication\",\n  icon: MessageSquare,\n  roles: [\"admin\", \"operational_head\", \"developer\", \"client\"],\n  subItems: [\n    {\n      title: \"Chat\",\n      url: \"/chat\",\n      roles: [\"admin\", \"operational_head\", \"developer\", \"client\"],\n    },\n    {\n      title: \"Files\",\n      url: \"/files\",\n      roles: [\"admin\", \"operational_head\", \"developer\", \"client\"],\n    },\n  ],\n};\n\n// HR Management Items\nconst hrMenuItems = [\n  {\n    title: \"Attendance\",\n    url: \"/attendance\",\n    icon: Clock,\n    roles: [\"admin\", \"operational_head\", \"developer\"],\n  },\n  {\n    title: \"Employees\",\n    url: \"/hr/employees\",\n    icon: UserCog,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Departments\",\n    url: \"/hr/departments\",\n    icon: Building2,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Leave Management\",\n    url: \"/hr/leave\",\n    icon: CalendarDays,\n    roles: [\"admin\", \"operational_head\"],\n  },\n];\n\n// Payroll with sub-items\nconst payrollItem = {\n  title: \"Payroll\",\n  icon: Wallet,\n  url: \"/hr/payroll\",\n  roles: [\"admin\", \"operational_head\"],\n  subItems: [\n    {\n      title: \"Salary Sheet\",\n      url: \"/hr/salary-sheet\",\n      roles: [\"admin\", \"operational_head\"],\n    },\n    {\n      title: \"Salary Slip\",\n      url: \"/hr/salary-slip\",\n      roles: [\"admin\", \"operational_head\"],\n    },\n    {\n      title: \"Attendance Report\",\n      url: \"/hr/attendance-report\",\n      roles: [\"admin\", \"operational_head\"],\n    },\n    {\n      title: \"Leave Summary\",\n      url: \"/hr/leave-summary\",\n      roles: [\"admin\", \"operational_head\"],\n    },\n  ],\n};\n\n// Accounts & Finance Items\nconst accountsMenuItems = [\n  {\n    title: \"Invoices\",\n    url: \"/invoices\",\n    icon: FileText,\n    roles: [\"admin\", \"operational_head\", \"client\"],\n  },\n  {\n    title: \"Payments\",\n    url: \"/payments\",\n    icon: CreditCard,\n    roles: [\"admin\", \"operational_head\", \"client\"],\n  },\n  {\n    title: \"Expense Categories\",\n    url: \"/accounts/categories\",\n    icon: FolderOpen,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Salary Payments\",\n    url: \"/accounts/salary-payments\",\n    icon: Receipt,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Financial Reports\",\n    url: \"/accounts/reports\",\n    icon: TrendingUp,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Profit & Loss\",\n    url: \"/accounts/profit-loss\",\n    icon: FileText,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"General Ledger\",\n    url: \"/accounts/ledger\",\n    icon: BookOpen,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Payroll Report\",\n    url: \"/accounts/payroll-report\",\n    icon: Wallet,\n    roles: [\"admin\", \"operational_head\"],\n  },\n  {\n    title: \"Payment Receipt\",\n    url: \"/accounts/payment-receipt\",\n    icon: Receipt,\n    roles: [\"admin\", \"operational_head\"],\n  },\n];\n\n// Settings Items\nconst settingsItems = [\n  {\n    title: \"Office Settings\",\n    url: \"/office-settings\",\n    icon: Clock,\n    roles: [\"admin\"],\n  },\n  {\n    title: \"Profile\",\n    url: \"/settings\",\n    icon: User,\n    roles: [\"admin\", \"operational_head\", \"developer\", \"client\"],\n  },\n];\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n  const { user, logout } = useAuth();\n  const [communicationOpen, setCommunicationOpen] = useState(true);\n  const [payrollOpen, setPayrollOpen] = useState(true);\n\n  const filteredMainItems = mainMenuItems.filter(item => \n    user?.role && item.roles.includes(user.role)\n  );\n\n  const filteredCommunicationSubItems = communicationItem.subItems.filter(item => \n    user?.role && item.roles.includes(user.role)\n  );\n\n  const showCommunication = user?.role && communicationItem.roles.includes(user.role) && filteredCommunicationSubItems.length > 0;\n\n  const filteredHRItems = hrMenuItems.filter(item => \n    user?.role && item.roles.includes(user.role)\n  );\n\n  const filteredPayrollSubItems = payrollItem.subItems.filter(item => \n    user?.role && item.roles.includes(user.role)\n  );\n\n  const showPayroll = user?.role && payrollItem.roles.includes(user.role);\n\n  const filteredAccountsItems = accountsMenuItems.filter(item => \n    user?.role && item.roles.includes(user.role)\n  );\n\n  const filteredSettingsItems = settingsItems.filter(item => \n    user?.role && item.roles.includes(user.role)\n  );\n\n  return (\n    <Sidebar>\n      <SidebarHeader className=\"p-4 border-b\">\n        <div className=\"flex items-center gap-2\">\n          <img src={logoImage} alt=\"MaxTech BD\" className=\"h-8 object-contain\" />\n          <div>\n            <h2 className=\"font-semibold text-sm\">MaxTech BD</h2>\n            <p className=\"text-xs text-muted-foreground\">Control Hub</p>\n          </div>\n        </div>\n      </SidebarHeader>\n      \n      <SidebarContent>\n        {/* MAIN MENU */}\n        <SidebarGroup>\n          <SidebarGroupLabel className=\"text-xs font-bold uppercase tracking-wider text-foreground/70 px-2 mb-1\">\n            Main Menu\n          </SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {filteredMainItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton asChild isActive={location === item.url} data-testid={`nav-${item.title.toLowerCase()}`}>\n                    <Link href={item.url}>\n                      <item.icon className=\"w-4 h-4 shrink-0\" />\n                      <span className=\"text-sm\">{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n              \n              {/* Communication Expandable */}\n              {showCommunication && (\n                <>\n                  <SidebarMenuItem>\n                    <SidebarMenuButton \n                      onClick={() => setCommunicationOpen(!communicationOpen)}\n                      data-testid=\"nav-communication\"\n                    >\n                      <communicationItem.icon className=\"w-4 h-4 shrink-0\" />\n                      <span className=\"text-sm\">{communicationItem.title}</span>\n                      {communicationOpen ? (\n                        <ChevronDown className=\"ml-auto w-4 h-4\" />\n                      ) : (\n                        <ChevronRight className=\"ml-auto w-4 h-4\" />\n                      )}\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                  {communicationOpen && (\n                    <SidebarMenuSub>\n                      {filteredCommunicationSubItems.map((subItem) => (\n                        <SidebarMenuSubItem key={subItem.title}>\n                          <SidebarMenuSubButton asChild isActive={location === subItem.url} data-testid={`nav-${subItem.title.toLowerCase()}`}>\n                            <Link href={subItem.url}>\n                              <span className=\"text-sm\">{subItem.title}</span>\n                            </Link>\n                          </SidebarMenuSubButton>\n                        </SidebarMenuSubItem>\n                      ))}\n                    </SidebarMenuSub>\n                  )}\n                </>\n              )}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        {/* HR MANAGEMENT */}\n        {(filteredHRItems.length > 0 || showPayroll) && (\n          <SidebarGroup className=\"mt-4\">\n            <SidebarGroupLabel className=\"text-xs font-bold uppercase tracking-wider text-foreground/70 px-2 mb-1\">\n              HR Management\n            </SidebarGroupLabel>\n            <SidebarGroupContent>\n              <SidebarMenu>\n                {filteredHRItems.map((item) => (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton asChild isActive={location === item.url} data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                      <Link href={item.url}>\n                        <item.icon className=\"w-4 h-4 shrink-0\" />\n                        <span className=\"text-sm\">{item.title}</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                ))}\n                \n                {/* Payroll Expandable */}\n                {showPayroll && (\n                  <>\n                    <SidebarMenuItem>\n                      <SidebarMenuButton \n                        onClick={() => setPayrollOpen(!payrollOpen)}\n                        isActive={location === payrollItem.url}\n                        data-testid=\"nav-payroll\"\n                      >\n                        <payrollItem.icon className=\"w-4 h-4 shrink-0\" />\n                        <span className=\"text-sm\">{payrollItem.title}</span>\n                        {payrollOpen ? (\n                          <ChevronDown className=\"ml-auto w-4 h-4\" />\n                        ) : (\n                          <ChevronRight className=\"ml-auto w-4 h-4\" />\n                        )}\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                    {payrollOpen && (\n                      <SidebarMenuSub>\n                        {filteredPayrollSubItems.map((subItem) => (\n                          <SidebarMenuSubItem key={subItem.title}>\n                            <SidebarMenuSubButton asChild isActive={location === subItem.url} data-testid={`nav-${subItem.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                              <Link href={subItem.url}>\n                                <span className=\"text-sm\">{subItem.title}</span>\n                              </Link>\n                            </SidebarMenuSubButton>\n                          </SidebarMenuSubItem>\n                        ))}\n                      </SidebarMenuSub>\n                    )}\n                  </>\n                )}\n              </SidebarMenu>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        )}\n\n        {/* ACCOUNTS & FINANCE */}\n        {filteredAccountsItems.length > 0 && (\n          <SidebarGroup className=\"mt-4\">\n            <SidebarGroupLabel className=\"text-xs font-bold uppercase tracking-wider text-foreground/70 px-2 mb-1\">\n              Accounts & Finance\n            </SidebarGroupLabel>\n            <SidebarGroupContent>\n              <SidebarMenu>\n                {filteredAccountsItems.map((item) => (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton asChild isActive={location === item.url} data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                      <Link href={item.url}>\n                        <item.icon className=\"w-4 h-4 shrink-0\" />\n                        <span className=\"text-sm\">{item.title}</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                ))}\n              </SidebarMenu>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        )}\n\n        {/* SETTINGS */}\n        <SidebarGroup className=\"mt-4\">\n          <SidebarGroupLabel className=\"text-xs font-bold uppercase tracking-wider text-foreground/70 px-2 mb-1\">\n            Settings\n          </SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {filteredSettingsItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton asChild isActive={location === item.url} data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                    <Link href={item.url}>\n                      <item.icon className=\"w-4 h-4 shrink-0\" />\n                      <span className=\"text-sm\">{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n              <SidebarMenuItem>\n                <SidebarMenuButton onClick={logout} data-testid=\"button-logout\">\n                  <LogOut className=\"w-4 h-4 shrink-0\" />\n                  <span className=\"text-sm\">Logout</span>\n                </SidebarMenuButton>\n              </SidebarMenuItem>\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n\n      <SidebarFooter className=\"p-4 border-t\">\n        <div className=\"flex items-center gap-3 p-2 rounded-md bg-sidebar-accent\">\n          <div className=\"w-8 h-8 rounded-full bg-primary flex items-center justify-center shrink-0\">\n            <span className=\"text-primary-foreground text-xs font-semibold\">\n              {user?.fullName.charAt(0)}\n            </span>\n          </div>\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-medium truncate\">{user?.fullName}</p>\n            <p className=\"text-xs text-muted-foreground capitalize\">{user?.role}</p>\n          </div>\n        </div>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":14661,"size_tokens":null},"client/src/pages/invoices.tsx":{"content":"import { useState } from \"react\";\nimport { Plus, Send, FileText, Download } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { insertInvoiceSchema, type Invoice, type Client } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { normalizeInvoiceData } from \"@/lib/normalizeDateInputs\";\nimport { formatCurrency } from \"@shared/currency\";\n\nconst invoiceFormSchema = insertInvoiceSchema.extend({\n  dueDate: z.string(),\n});\n\ntype InvoiceFormData = z.infer<typeof invoiceFormSchema>;\n\nexport default function Invoices() {\n  const [open, setOpen] = useState(false);\n  const [editingInvoice, setEditingInvoice] = useState<Invoice | null>(null);\n  const { toast } = useToast();\n  const { data: invoices, isLoading } = useQuery<Invoice[]>({\n    queryKey: [\"/api/invoices\"],\n  });\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: InvoiceFormData) => apiRequest(\"POST\", \"/api/invoices\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/invoices\"] });\n      toast({ title: \"Success\", description: \"Invoice created successfully\" });\n      setOpen(false);\n      setEditingInvoice(null);\n      form.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: InvoiceFormData }) =>\n      apiRequest(\"PATCH\", `/api/invoices/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/invoices\"] });\n      toast({ title: \"Success\", description: \"Invoice updated successfully\" });\n      setOpen(false);\n      setEditingInvoice(null);\n      form.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const form = useForm<InvoiceFormData>({\n    resolver: zodResolver(invoiceFormSchema),\n    defaultValues: {\n      clientId: \"\",\n      invoiceNumber: `INV-${Date.now()}`,\n      amount: \"0\",\n      dueDate: \"\",\n      status: \"draft\",\n      notes: \"\",\n    },\n  });\n\n  const onSubmit = async (data: InvoiceFormData) => {\n    const normalizedData = normalizeInvoiceData(data);\n    if (editingInvoice) {\n      updateMutation.mutate({ id: editingInvoice.id, data: normalizedData });\n    } else {\n      createMutation.mutate(normalizedData);\n    }\n  };\n\n  const handleEdit = (invoice: Invoice) => {\n    setEditingInvoice(invoice);\n    form.reset({\n      clientId: invoice.clientId,\n      invoiceNumber: invoice.invoiceNumber,\n      amount: invoice.amount,\n      dueDate: invoice.dueDate ? (typeof invoice.dueDate === 'string' ? invoice.dueDate : new Date(invoice.dueDate).toISOString().split('T')[0]) : \"\",\n      status: invoice.status,\n      notes: invoice.notes || \"\",\n    });\n    setOpen(true);\n  };\n\n  const handleAddNew = () => {\n    setEditingInvoice(null);\n    form.reset({\n      clientId: \"\",\n      invoiceNumber: `INV-${Date.now()}`,\n      amount: \"0\",\n      dueDate: \"\",\n      status: \"draft\",\n      notes: \"\",\n    });\n    setOpen(true);\n  };\n\n  const handleDownloadPDF = async (invoiceId: string, invoiceNumber: string, e: React.MouseEvent) => {\n    e.stopPropagation();\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/invoices/${invoiceId}/download`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`,\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to download PDF\");\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `Invoice-${invoiceNumber}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({ title: \"Success\", description: \"Invoice PDF downloaded successfully\" });\n    } catch (error: any) {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    }\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"draft\": return \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\";\n      case \"sent\": return \"bg-blue-100 text-blue-700 dark:bg-blue-950 dark:text-blue-300\";\n      case \"paid\": return \"bg-green-100 text-green-700 dark:bg-green-950 dark:text-green-300\";\n      case \"overdue\": return \"bg-red-100 text-red-700 dark:bg-red-950 dark:text-red-300\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"h-8 bg-muted rounded w-32 mb-6 animate-pulse\" />\n        <div className=\"space-y-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardContent className=\"p-4\">\n                <div className=\"h-5 bg-muted rounded w-3/4 mb-2 animate-pulse\" />\n                <div className=\"h-4 bg-muted rounded w-1/2 animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Invoices</h1>\n          <p className=\"text-sm text-muted-foreground\">Manage client invoices</p>\n        </div>\n        <Button data-testid=\"button-add-invoice\" onClick={handleAddNew}>\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Create Invoice\n        </Button>\n        <Dialog open={open} onOpenChange={setOpen}>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>{editingInvoice ? \"Edit Invoice\" : \"Add New Invoice\"}</DialogTitle>\n              <DialogDescription>\n                {editingInvoice ? \"Update invoice information\" : \"Generate a new invoice for a client\"}\n              </DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <FormField\n                    control={form.control}\n                    name=\"invoiceNumber\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Invoice Number</FormLabel>\n                        <FormControl>\n                          <Input {...field} data-testid=\"input-invoice-number\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"clientId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Client</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-client\">\n                              <SelectValue placeholder=\"Select client\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            {clients?.map((client) => (\n                              <SelectItem key={client.id} value={client.id}>\n                                {client.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"amount\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Amount</FormLabel>\n                        <FormControl>\n                          <Input type=\"number\" placeholder=\"5000\" {...field} data-testid=\"input-amount\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"dueDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Due Date</FormLabel>\n                        <FormControl>\n                          <Input type=\"date\" {...field} data-testid=\"input-due-date\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"status\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Status</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-status\">\n                              <SelectValue />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            <SelectItem value=\"draft\">Draft</SelectItem>\n                            <SelectItem value=\"sent\">Sent</SelectItem>\n                            <SelectItem value=\"paid\">Paid</SelectItem>\n                            <SelectItem value=\"overdue\">Overdue</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <FormField\n                  control={form.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Notes</FormLabel>\n                      <FormControl>\n                        <Textarea placeholder=\"Payment terms, notes...\" {...field} value={field.value ?? \"\"} data-testid=\"input-notes\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"flex justify-end gap-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setOpen(false)}>Cancel</Button>\n                  <Button type=\"submit\" data-testid=\"button-submit-invoice\">\n                    {editingInvoice ? \"Update Invoice\" : \"Create Invoice\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {!invoices || invoices.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n              <FileText className=\"w-8 h-8 text-muted-foreground\" />\n            </div>\n            <h3 className=\"text-lg font-semibold mb-2\">No invoices yet</h3>\n            <p className=\"text-sm text-muted-foreground mb-4\">Create your first invoice</p>\n            <Button onClick={() => setOpen(true)}>Create Invoice</Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-3\">\n          {invoices.map((invoice) => (\n            <Card \n              key={invoice.id} \n              className=\"hover-elevate cursor-pointer\" \n              data-testid={`card-invoice-${invoice.id}`}\n              onClick={() => handleEdit(invoice)}\n            >\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-3 mb-2\">\n                      <h3 className=\"font-semibold font-mono\" data-testid={`text-invoice-number-${invoice.id}`}>\n                        {invoice.invoiceNumber}\n                      </h3>\n                      <Badge className={getStatusColor(invoice.status)} data-testid={`badge-status-${invoice.id}`}>\n                        {invoice.status}\n                      </Badge>\n                    </div>\n                    <div className=\"text-sm text-muted-foreground\">\n                      Due: {new Date(invoice.dueDate).toLocaleDateString()}\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"text-right\">\n                      <div className=\"text-2xl font-bold\" data-testid={`text-amount-${invoice.id}`}>\n                        {formatCurrency(invoice.amount)}\n                      </div>\n                    </div>\n                    <Button \n                      size=\"icon\" \n                      variant=\"ghost\" \n                      data-testid={`button-download-${invoice.id}`}\n                      onClick={(e) => handleDownloadPDF(invoice.id, invoice.invoiceNumber, e)}\n                      title=\"Download PDF\"\n                    >\n                      <Download className=\"w-4 h-4\" />\n                    </Button>\n                    <Button \n                      size=\"icon\" \n                      variant=\"ghost\" \n                      data-testid={`button-send-${invoice.id}`}\n                      onClick={(e) => {\n                        e.stopPropagation();\n                      }}\n                    >\n                      <Send className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14979,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, timestamp, integer, decimal, jsonb, date, boolean } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { DATE_ONLY_REGEX, parseOptionalDate, parseRequiredDate } from \"./date-utils\";\n\n// Lead source options\nexport const LEAD_SOURCES = [\n  \"Facebook\",\n  \"LinkedIn\",\n  \"Fiverr\",\n  \"Upwork\",\n  \"Freelancer.com\",\n  \"People per Hour\",\n  \"Reference\",\n  \"Local Market\",\n  \"Legit\",\n  \"Smart Lead Finder\",\n] as const;\n\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: text(\"email\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  fullName: text(\"full_name\").notNull(),\n  role: text(\"role\").notNull().default(\"developer\"),\n  clientId: varchar(\"client_id\").references(() => clients.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const leads = pgTable(\"leads\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  website: text(\"website\"),\n  category: text(\"category\"),\n  status: text(\"status\").notNull().default(\"new\"),\n  source: text(\"source\"),\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  followUpDate: timestamp(\"follow_up_date\"),\n  lastFollowUpReminderAt: timestamp(\"last_follow_up_reminder_at\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const LEAD_EMAIL_TEMPLATES = [\n  \"service_introduction\",\n  \"company_profile\",\n  \"pricing_brochure\",\n  \"follow_up_reminder\",\n] as const;\n\nexport const leadEmails = pgTable(\"lead_emails\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  leadId: varchar(\"lead_id\").references(() => leads.id).notNull(),\n  templateName: text(\"template_name\").notNull(),\n  subject: text(\"subject\").notNull(),\n  status: text(\"status\").notNull().default(\"pending\"),\n  sentBy: varchar(\"sent_by\").references(() => users.id).notNull(),\n  sentAt: timestamp(\"sent_at\"),\n  errorMessage: text(\"error_message\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const DEFAULT_LEAD_CATEGORIES = [\n  \"Software Company\",\n  \"Garments\",\n  \"Buying House\",\n  \"Marketing Agency\",\n  \"School / College\",\n  \"Restaurant\",\n  \"Hospital / Clinic\",\n  \"Real Estate\",\n  \"E-commerce\",\n  \"Manufacturing\",\n  \"IT Services\",\n  \"Consulting\",\n  \"Retail\",\n  \"Other\",\n] as const;\n\nexport const leadCategories = pgTable(\"lead_categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull().unique(),\n  description: text(\"description\"),\n  color: text(\"color\").default(\"#6366f1\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const leadMessageHistory = pgTable(\"lead_message_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  leadId: varchar(\"lead_id\").references(() => leads.id).notNull(),\n  subject: text(\"subject\").notNull(),\n  message: text(\"message\").notNull(),\n  status: text(\"status\").notNull().default(\"sent\"),\n  sentBy: varchar(\"sent_by\").references(() => users.id).notNull(),\n  sentAt: timestamp(\"sent_at\").defaultNow().notNull(),\n  errorMessage: text(\"error_message\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const clients = pgTable(\"clients\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  email: text(\"email\").notNull(),\n  phone: text(\"phone\"),\n  company: text(\"company\"),\n  whatsapp: text(\"whatsapp\"),\n  address: text(\"address\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const projects = pgTable(\"projects\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").references(() => clients.id).notNull(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  status: text(\"status\").notNull().default(\"planning\"),\n  budget: decimal(\"budget\", { precision: 10, scale: 2 }),\n  deadline: timestamp(\"deadline\"),\n  progress: integer(\"progress\").default(0),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const tasks = pgTable(\"tasks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  projectId: varchar(\"project_id\").references(() => projects.id).notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  status: text(\"status\").notNull().default(\"todo\"),\n  priority: text(\"priority\").notNull().default(\"medium\"),\n  deadline: timestamp(\"deadline\"),\n  checklist: jsonb(\"checklist\").default([]),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const messages = pgTable(\"messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  projectId: varchar(\"project_id\").references(() => projects.id).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  content: text(\"content\"),\n  fileUrl: text(\"file_url\"),\n  fileName: text(\"file_name\"),\n  fileType: text(\"file_type\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const files = pgTable(\"files\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  projectId: varchar(\"project_id\").references(() => projects.id),\n  uploadedBy: varchar(\"uploaded_by\").references(() => users.id).notNull(),\n  fileName: text(\"file_name\").notNull(),\n  fileUrl: text(\"file_url\").notNull(),\n  fileSize: integer(\"file_size\"),\n  fileType: text(\"file_type\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const attendance = pgTable(\"attendance\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  date: date(\"date\", { mode: \"string\" }).notNull(),\n  checkIn: timestamp(\"check_in\"),\n  checkOut: timestamp(\"check_out\"),\n  status: text(\"status\").notNull().default(\"pending\"),\n  lateDuration: integer(\"late_duration\").default(0),\n  notes: text(\"notes\"),\n}, (table) => ({\n  userDateUnique: sql`UNIQUE (${table.userId}, ${table.date})`,\n}));\n\nexport const income = pgTable(\"income\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  source: text(\"source\").notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  category: text(\"category\").notNull(),\n  date: timestamp(\"date\").defaultNow().notNull(),\n  description: text(\"description\"),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const expenses = pgTable(\"expenses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  category: text(\"category\").notNull(),\n  date: timestamp(\"date\").defaultNow().notNull(),\n  description: text(\"description\"),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const invoices = pgTable(\"invoices\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").references(() => clients.id).notNull(),\n  projectId: varchar(\"project_id\").references(() => projects.id),\n  invoiceNumber: text(\"invoice_number\").notNull().unique(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  dueDate: timestamp(\"due_date\").notNull(),\n  status: text(\"status\").notNull().default(\"draft\"),\n  sentDate: timestamp(\"sent_date\"),\n  lastReminderSentAt: timestamp(\"last_reminder_sent_at\"),\n  items: jsonb(\"items\").default([]),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const payments = pgTable(\"payments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  invoiceId: varchar(\"invoice_id\").references(() => invoices.id).notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  paymentDate: timestamp(\"payment_date\").defaultNow().notNull(),\n  paymentMethod: text(\"payment_method\").notNull(),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const expenseCategories = pgTable(\"expense_categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull().unique(),\n  type: text(\"type\").notNull(),\n  description: text(\"description\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  action: text(\"action\").notNull(),\n  resourceType: text(\"resource_type\").notNull(),\n  resourceId: varchar(\"resource_id\"),\n  details: jsonb(\"details\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  type: text(\"type\").notNull(),\n  message: text(\"message\").notNull(),\n  projectId: varchar(\"project_id\").references(() => projects.id),\n  isRead: boolean(\"is_read\").default(false).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// HR & Payroll Tables\nexport const departments = pgTable(\"departments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull().unique(),\n  description: text(\"description\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const designations = pgTable(\"designations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull().unique(),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  description: text(\"description\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const employees = pgTable(\"employees\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull().unique(),\n  employeeId: text(\"employee_id\").notNull().unique(),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  designationId: varchar(\"designation_id\").references(() => designations.id),\n  joiningDate: timestamp(\"joining_date\").notNull(),\n  dateOfBirth: timestamp(\"date_of_birth\"),\n  gender: text(\"gender\"),\n  phone: text(\"phone\"),\n  emergencyContact: text(\"emergency_contact\"),\n  address: text(\"address\"),\n  photo: text(\"photo\"),\n  documents: jsonb(\"documents\").default([]),\n  bankAccountNumber: text(\"bank_account_number\"),\n  bankName: text(\"bank_name\"),\n  status: text(\"status\").notNull().default(\"active\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const hrSettings = pgTable(\"hr_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  gracePeriodMinutes: integer(\"grace_period_minutes\").default(10),\n  officeStartTime: text(\"office_start_time\").default(\"09:00\"),\n  officeEndTime: text(\"office_end_time\").default(\"18:00\"),\n  workingDaysPerWeek: integer(\"working_days_per_week\").default(5),\n  lateDeductionRule: integer(\"late_deduction_rule\").default(3),\n  overtimeEnabled: boolean(\"overtime_enabled\").default(false),\n  overtimeRateMultiplier: decimal(\"overtime_rate_multiplier\", { precision: 4, scale: 2 }).default(\"1.50\"),\n  overtimeRatePerHour: decimal(\"overtime_rate_per_hour\", { precision: 10, scale: 2 }).default(\"0\"),\n  halfDayHours: decimal(\"half_day_hours\", { precision: 4, scale: 2 }).default(\"4.00\"),\n  halfDayCutoffTime: text(\"half_day_cutoff_time\").default(\"14:00\"),\n  fullDayHours: decimal(\"full_day_hours\", { precision: 4, scale: 2 }).default(\"8.00\"),\n  minimumHoursForPresent: decimal(\"minimum_hours_for_present\", { precision: 4, scale: 2 }).default(\"6.00\"),\n  weeklyOffDays: jsonb(\"weekly_off_days\").default([\"Friday\"]),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const attendanceDevices = pgTable(\"attendance_devices\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  deviceType: text(\"device_type\").notNull(),\n  ipAddress: text(\"ip_address\").notNull(),\n  port: integer(\"port\").default(80),\n  apiEndpoint: text(\"api_endpoint\"),\n  apiKey: text(\"api_key\"),\n  apiUrl: text(\"api_url\"),\n  status: text(\"status\").notNull().default(\"active\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  lastSyncAt: timestamp(\"last_sync_at\"),\n  lastSyncError: text(\"last_sync_error\"),\n  connectionParams: jsonb(\"connection_params\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const deviceLogs = pgTable(\"device_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  deviceId: varchar(\"device_id\").references(() => attendanceDevices.id).notNull(),\n  employeeId: text(\"employee_id\").notNull(),\n  punchTime: timestamp(\"punch_time\").notNull(),\n  punchType: text(\"punch_type\").notNull(),\n  deviceUserId: text(\"device_user_id\"),\n  rawData: jsonb(\"raw_data\"),\n  synced: boolean(\"synced\").notNull().default(false),\n  syncedAt: timestamp(\"synced_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const leaveTypes = pgTable(\"leave_types\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull().unique(),\n  daysPerYear: integer(\"days_per_year\").notNull(),\n  carryForward: text(\"carry_forward\").notNull().default(\"no\"),\n  requiresApproval: text(\"requires_approval\").notNull().default(\"yes\"),\n  isPaid: text(\"is_paid\").notNull().default(\"yes\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const leaveRequests = pgTable(\"leave_requests\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").references(() => employees.id).notNull(),\n  leaveTypeId: varchar(\"leave_type_id\").references(() => leaveTypes.id).notNull(),\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  totalDays: decimal(\"total_days\", { precision: 4, scale: 1 }).notNull(),\n  reason: text(\"reason\").notNull(),\n  status: text(\"status\").notNull().default(\"pending\"),\n  approvedBy: varchar(\"approved_by\").references(() => users.id),\n  approvedAt: timestamp(\"approved_at\"),\n  rejectionReason: text(\"rejection_reason\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const leaveBalances = pgTable(\"leave_balances\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").references(() => employees.id).notNull(),\n  leaveTypeId: varchar(\"leave_type_id\").references(() => leaveTypes.id).notNull(),\n  year: integer(\"year\").notNull(),\n  totalDays: decimal(\"total_days\", { precision: 4, scale: 1 }).notNull(),\n  usedDays: decimal(\"used_days\", { precision: 4, scale: 1 }).default(\"0\"),\n  remainingDays: decimal(\"remaining_days\", { precision: 4, scale: 1 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const punchCorrections = pgTable(\"punch_corrections\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  attendanceId: varchar(\"attendance_id\").references(() => attendance.id).notNull(),\n  employeeId: varchar(\"employee_id\").references(() => employees.id).notNull(),\n  requestedCheckIn: timestamp(\"requested_check_in\"),\n  requestedCheckOut: timestamp(\"requested_check_out\"),\n  reason: text(\"reason\").notNull(),\n  status: text(\"status\").notNull().default(\"pending\"),\n  approvedBy: varchar(\"approved_by\").references(() => users.id),\n  approvedAt: timestamp(\"approved_at\"),\n  rejectionReason: text(\"rejection_reason\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const salaryStructure = pgTable(\"salary_structure\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").references(() => employees.id).notNull().unique(),\n  basicSalary: decimal(\"basic_salary\", { precision: 10, scale: 2 }).notNull(),\n  houseAllowance: decimal(\"house_allowance\", { precision: 10, scale: 2 }).default(\"0\"),\n  foodAllowance: decimal(\"food_allowance\", { precision: 10, scale: 2 }).default(\"0\"),\n  travelAllowance: decimal(\"travel_allowance\", { precision: 10, scale: 2 }).default(\"0\"),\n  medicalAllowance: decimal(\"medical_allowance\", { precision: 10, scale: 2 }).default(\"0\"),\n  otherAllowances: decimal(\"other_allowances\", { precision: 10, scale: 2 }).default(\"0\"),\n  effectiveFrom: timestamp(\"effective_from\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const payroll = pgTable(\"payroll\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").references(() => employees.id).notNull(),\n  month: integer(\"month\").notNull(),\n  year: integer(\"year\").notNull(),\n  basicSalary: decimal(\"basic_salary\", { precision: 10, scale: 2 }).notNull(),\n  totalAllowances: decimal(\"total_allowances\", { precision: 10, scale: 2 }).default(\"0\"),\n  overtimeAmount: decimal(\"overtime_amount\", { precision: 10, scale: 2 }).default(\"0\"),\n  loanDeduction: decimal(\"loan_deduction\", { precision: 10, scale: 2 }).default(\"0\"),\n  lateDeduction: decimal(\"late_deduction\", { precision: 10, scale: 2 }).default(\"0\"),\n  otherDeductions: decimal(\"other_deductions\", { precision: 10, scale: 2 }).default(\"0\"),\n  grossSalary: decimal(\"gross_salary\", { precision: 10, scale: 2 }).notNull(),\n  netSalary: decimal(\"net_salary\", { precision: 10, scale: 2 }).notNull(),\n  totalLateDays: integer(\"total_late_days\").default(0),\n  totalAbsentDays: integer(\"total_absent_days\").default(0),\n  totalPresentDays: integer(\"total_present_days\").default(0),\n  totalHalfDays: integer(\"total_half_days\").default(0),\n  totalOvertimeHours: decimal(\"total_overtime_hours\", { precision: 5, scale: 2 }).default(\"0\"),\n  workingDays: integer(\"working_days\").notNull(),\n  status: text(\"status\").notNull().default(\"draft\"),\n  generatedBy: varchar(\"generated_by\").references(() => users.id),\n  paidAt: timestamp(\"paid_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const salarySlips = pgTable(\"salary_slips\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  payrollId: varchar(\"payroll_id\").references(() => payroll.id).notNull().unique(),\n  pdfUrl: text(\"pdf_url\"),\n  generatedAt: timestamp(\"generated_at\").defaultNow().notNull(),\n  emailedAt: timestamp(\"emailed_at\"),\n});\n\nexport const salaryAdjustments = pgTable(\"salary_adjustments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  payrollId: varchar(\"payroll_id\").references(() => payroll.id).notNull(),\n  type: text(\"type\").notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  reason: text(\"reason\").notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const performanceScores = pgTable(\"performance_scores\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").references(() => employees.id).notNull(),\n  month: integer(\"month\").notNull(),\n  year: integer(\"year\").notNull(),\n  attendanceScore: decimal(\"attendance_score\", { precision: 5, scale: 2 }).default(\"0\"),\n  taskCompletionScore: decimal(\"task_completion_score\", { precision: 5, scale: 2 }).default(\"0\"),\n  qualityScore: decimal(\"quality_score\", { precision: 5, scale: 2 }).default(\"0\"),\n  punctualityScore: decimal(\"punctuality_score\", { precision: 5, scale: 2 }).default(\"0\"),\n  overallScore: decimal(\"overall_score\", { precision: 5, scale: 2 }).default(\"0\"),\n  remarks: text(\"remarks\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Hosting platform options for project credentials\nexport const HOSTING_PLATFORMS = [\n  \"Render\",\n  \"Replit\",\n  \"Namecheap\",\n  \"VPS\",\n  \"Shared Hosting\",\n  \"AWS\",\n  \"DigitalOcean\",\n  \"Vercel\",\n  \"Netlify\",\n  \"Heroku\",\n  \"Other\",\n] as const;\n\n// Project Credentials Manager - stores software project credentials, hosting details, and video links\nexport const projectCredentials = pgTable(\"project_credentials\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  projectName: text(\"project_name\").notNull(),\n  clientId: varchar(\"client_id\").references(() => clients.id),\n  hostingPlatform: text(\"hosting_platform\"),\n  liveLink: text(\"live_link\"),\n  adminPanelLink: text(\"admin_panel_link\"),\n  databaseUrl: text(\"database_url\"),\n  serverCredentials: text(\"server_credentials\"),\n  thumbnailUrl: text(\"thumbnail_url\"),\n  shortDescription: text(\"short_description\"),\n  additionalNotes: text(\"additional_notes\"),\n  shortVideoUrl: text(\"short_video_url\"),\n  fullVideoUrl: text(\"full_video_url\"),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Insert Schemas\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n  role: true, // Role cannot be set during public registration - defaults to developer\n  clientId: true, // ClientId cannot be set during public registration\n});\n\nexport const insertLeadSchema = createInsertSchema(leads).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  followUpDate: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.union([\n      z.string().regex(DATE_ONLY_REGEX, \"Invalid date format, use YYYY-MM-DD\"),\n      z.date()\n    ]).optional().transform(parseOptionalDate)\n  ),\n  source: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.enum(LEAD_SOURCES).optional()\n  ),\n});\n\nexport const insertLeadEmailSchema = createInsertSchema(leadEmails).omit({\n  id: true,\n  createdAt: true,\n  sentAt: true,\n  errorMessage: true,\n  status: true,\n});\n\nexport const insertLeadCategorySchema = createInsertSchema(leadCategories).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertLeadMessageHistorySchema = createInsertSchema(leadMessageHistory).omit({\n  id: true,\n  createdAt: true,\n  sentAt: true,\n  errorMessage: true,\n  status: true,\n});\n\nexport const bulkEmailSchema = z.object({\n  leadIds: z.array(z.string()).min(1, \"Select at least one lead\"),\n  subject: z.string().min(1, \"Subject is required\"),\n  message: z.string().min(1, \"Message is required\"),\n});\n\nexport const insertClientSchema = createInsertSchema(clients).omit({\n  id: true,\n  createdAt: true,\n}).required({\n  name: true,\n  email: true,\n  phone: true,\n  company: true,\n});\n\nexport const insertProjectSchema = createInsertSchema(projects).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  deadline: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.union([\n      z.string().regex(DATE_ONLY_REGEX, \"Invalid date format, use YYYY-MM-DD\"),\n      z.date()\n    ]).optional().transform(parseOptionalDate)\n  ),\n});\n\nexport const insertTaskSchema = createInsertSchema(tasks).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  deadline: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.union([\n      z.string().regex(DATE_ONLY_REGEX, \"Invalid date format, use YYYY-MM-DD\"),\n      z.date()\n    ]).optional().transform(parseOptionalDate)\n  ),\n  assignedTo: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.string().optional()\n  ),\n});\n\nexport const insertMessageSchema = createInsertSchema(messages).omit({\n  id: true,\n  userId: true, // userId comes from authenticated token, not request body\n  createdAt: true,\n});\n\nexport const insertFileSchema = createInsertSchema(files).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAttendanceSchema = createInsertSchema(attendance).omit({\n  id: true,\n});\n\nexport const insertIncomeSchema = createInsertSchema(income).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertExpenseSchema = createInsertSchema(expenses).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertExpenseCategorySchema = createInsertSchema(expenseCategories).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Invoice Item Schema - for itemized invoices\nexport const invoiceItemSchema = z.object({\n  description: z.string().min(1, \"Description is required\"),\n  quantity: z.coerce.number().positive(\"Quantity must be positive\"),\n  rate: z.coerce.number().positive(\"Rate must be positive\"),\n  amount: z.coerce.number().positive(\"Amount must be positive\"),\n});\n\nexport type InvoiceItem = z.infer<typeof invoiceItemSchema>;\n\nexport const insertInvoiceSchema = createInsertSchema(invoices).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  dueDate: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.union([\n      z.string().regex(DATE_ONLY_REGEX, \"Invalid date format, use YYYY-MM-DD\").min(1, \"Due date is required\"),\n      z.date()\n    ]).transform(parseRequiredDate)\n  ),\n});\n\nexport const insertPaymentSchema = createInsertSchema(payments).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  amount: z.coerce.string().refine(val => !isNaN(Number(val)) && Number(val) > 0, {\n    message: \"Amount must be a positive number\"\n  }),\n  paymentDate: z.coerce.date(),\n});\n\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({\n  id: true,\n  createdAt: true,\n  isRead: true,\n});\n\n// HR & Payroll Insert Schemas\nexport const insertDepartmentSchema = createInsertSchema(departments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertDesignationSchema = createInsertSchema(designations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertEmployeeSchema = createInsertSchema(employees).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  joiningDate: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.union([\n      z.string().regex(DATE_ONLY_REGEX, \"Invalid date format, use YYYY-MM-DD\"),\n      z.date()\n    ]).transform(parseRequiredDate)\n  ),\n  dateOfBirth: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.union([\n      z.string().regex(DATE_ONLY_REGEX, \"Invalid date format, use YYYY-MM-DD\"),\n      z.date()\n    ]).optional().transform(parseOptionalDate)\n  ),\n});\n\nexport const insertHrSettingsSchema = createInsertSchema(hrSettings).omit({\n  id: true,\n});\n\nexport const insertAttendanceDeviceSchema = createInsertSchema(attendanceDevices).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertDeviceLogSchema = createInsertSchema(deviceLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertLeaveTypeSchema = createInsertSchema(leaveTypes).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertLeaveRequestSchema = createInsertSchema(leaveRequests).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  startDate: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.union([\n      z.string().regex(DATE_ONLY_REGEX, \"Invalid date format, use YYYY-MM-DD\"),\n      z.date()\n    ]).transform(parseRequiredDate)\n  ),\n  endDate: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.union([\n      z.string().regex(DATE_ONLY_REGEX, \"Invalid date format, use YYYY-MM-DD\"),\n      z.date()\n    ]).transform(parseRequiredDate)\n  ),\n  totalDays: z.preprocess(\n    (val) => (typeof val === \"number\" ? String(val) : val),\n    z.string().min(1, \"Total days is required\")\n  ),\n});\n\nexport const insertLeaveBalanceSchema = createInsertSchema(leaveBalances).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertPunchCorrectionSchema = createInsertSchema(punchCorrections).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertSalaryStructureSchema = createInsertSchema(salaryStructure).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  effectiveFrom: z.preprocess(\n    (val) => val === \"\" ? undefined : val,\n    z.union([\n      z.string().regex(DATE_ONLY_REGEX, \"Invalid date format, use YYYY-MM-DD\"),\n      z.date()\n    ]).transform(parseRequiredDate)\n  ),\n});\n\nexport const insertPayrollSchema = createInsertSchema(payroll).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertSalarySlipSchema = createInsertSchema(salarySlips).omit({\n  id: true,\n});\n\nexport const insertSalaryAdjustmentSchema = createInsertSchema(salaryAdjustments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertPerformanceScoreSchema = createInsertSchema(performanceScores).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertProjectCredentialsSchema = createInsertSchema(projectCredentials).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\n// Types\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\n\nexport type InsertLead = z.infer<typeof insertLeadSchema>;\nexport type Lead = typeof leads.$inferSelect;\n\nexport type InsertLeadEmail = z.infer<typeof insertLeadEmailSchema>;\nexport type LeadEmail = typeof leadEmails.$inferSelect;\n\nexport type InsertLeadCategory = z.infer<typeof insertLeadCategorySchema>;\nexport type LeadCategory = typeof leadCategories.$inferSelect;\n\nexport type InsertLeadMessageHistory = z.infer<typeof insertLeadMessageHistorySchema>;\nexport type LeadMessageHistory = typeof leadMessageHistory.$inferSelect;\n\nexport type BulkEmailInput = z.infer<typeof bulkEmailSchema>;\n\nexport type InsertClient = z.infer<typeof insertClientSchema>;\nexport type Client = typeof clients.$inferSelect;\n\nexport type InsertProject = z.infer<typeof insertProjectSchema>;\nexport type Project = typeof projects.$inferSelect;\n\nexport type InsertTask = z.infer<typeof insertTaskSchema>;\nexport type Task = typeof tasks.$inferSelect;\n\nexport type InsertMessage = z.infer<typeof insertMessageSchema>;\nexport type Message = typeof messages.$inferSelect;\n\nexport type InsertFile = z.infer<typeof insertFileSchema>;\nexport type File = typeof files.$inferSelect;\n\nexport type InsertAttendance = z.infer<typeof insertAttendanceSchema>;\nexport type Attendance = typeof attendance.$inferSelect;\n\nexport type InsertIncome = z.infer<typeof insertIncomeSchema>;\nexport type Income = typeof income.$inferSelect;\n\nexport type InsertExpense = z.infer<typeof insertExpenseSchema>;\nexport type Expense = typeof expenses.$inferSelect;\n\nexport type InsertExpenseCategory = z.infer<typeof insertExpenseCategorySchema>;\nexport type ExpenseCategory = typeof expenseCategories.$inferSelect;\n\nexport type InsertInvoice = z.infer<typeof insertInvoiceSchema>;\nexport type Invoice = typeof invoices.$inferSelect;\n\nexport type InsertPayment = z.infer<typeof insertPaymentSchema>;\nexport type Payment = typeof payments.$inferSelect;\n\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\nexport type AuditLog = typeof auditLogs.$inferSelect;\n\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\nexport type Notification = typeof notifications.$inferSelect;\n\nexport type InsertDepartment = z.infer<typeof insertDepartmentSchema>;\nexport type Department = typeof departments.$inferSelect;\n\nexport type InsertDesignation = z.infer<typeof insertDesignationSchema>;\nexport type Designation = typeof designations.$inferSelect;\n\nexport type InsertEmployee = z.infer<typeof insertEmployeeSchema>;\nexport type Employee = typeof employees.$inferSelect;\n\nexport type InsertHrSettings = z.infer<typeof insertHrSettingsSchema>;\nexport type HrSettings = typeof hrSettings.$inferSelect;\n\nexport type InsertAttendanceDevice = z.infer<typeof insertAttendanceDeviceSchema>;\nexport type AttendanceDevice = typeof attendanceDevices.$inferSelect;\n\nexport type InsertDeviceLog = z.infer<typeof insertDeviceLogSchema>;\nexport type DeviceLog = typeof deviceLogs.$inferSelect;\n\nexport type InsertLeaveType = z.infer<typeof insertLeaveTypeSchema>;\nexport type LeaveType = typeof leaveTypes.$inferSelect;\n\nexport type InsertLeaveRequest = z.infer<typeof insertLeaveRequestSchema>;\nexport type LeaveRequest = typeof leaveRequests.$inferSelect;\n\nexport type InsertLeaveBalance = z.infer<typeof insertLeaveBalanceSchema>;\nexport type LeaveBalance = typeof leaveBalances.$inferSelect;\n\nexport type InsertPunchCorrection = z.infer<typeof insertPunchCorrectionSchema>;\nexport type PunchCorrection = typeof punchCorrections.$inferSelect;\n\nexport type InsertSalaryStructure = z.infer<typeof insertSalaryStructureSchema>;\nexport type SalaryStructure = typeof salaryStructure.$inferSelect;\n\nexport type InsertPayroll = z.infer<typeof insertPayrollSchema>;\nexport type Payroll = typeof payroll.$inferSelect;\n\nexport type InsertSalarySlip = z.infer<typeof insertSalarySlipSchema>;\nexport type SalarySlip = typeof salarySlips.$inferSelect;\n\nexport type InsertSalaryAdjustment = z.infer<typeof insertSalaryAdjustmentSchema>;\nexport type SalaryAdjustment = typeof salaryAdjustments.$inferSelect;\n\nexport type InsertPerformanceScore = z.infer<typeof insertPerformanceScoreSchema>;\nexport type PerformanceScore = typeof performanceScores.$inferSelect;\n\nexport type InsertProjectCredentials = z.infer<typeof insertProjectCredentialsSchema>;\nexport type ProjectCredentials = typeof projectCredentials.$inferSelect;\n","path":null,"size_bytes":33455,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/lib/normalizeDateInputs.ts":{"content":"/**\n * Frontend Date Normalization Utilities\n * \n * Normalizes date inputs from forms before sending to API\n * Ensures consistent date format and handles empty strings\n */\n\n/**\n * Normalizes form data before mutation (DATE-ONLY fields)\n * - Converts empty string dates to undefined\n * - Converts Date objects to YYYY-MM-DD strings\n * - Leaves valid date strings as-is\n * \n * @param data - Form data object with potential date fields\n * @param dateFields - Array of field names that contain date-only values\n * @returns Normalized data ready for API submission\n */\nexport function normalizeDateInputs<T extends Record<string, any>>(\n  data: T,\n  dateFields: string[]\n): T {\n  const normalized: any = { ...data };\n\n  for (const field of dateFields) {\n    const value = normalized[field];\n\n    // Convert empty strings to undefined\n    if (value === \"\" || value === null) {\n      normalized[field] = undefined;\n      continue;\n    }\n\n    // Convert Date objects to YYYY-MM-DD strings\n    if (value instanceof Date) {\n      normalized[field] = value.toISOString().split('T')[0];\n      continue;\n    }\n\n    // Leave valid strings as-is\n    if (typeof value === 'string') {\n      normalized[field] = value;\n    }\n  }\n\n  return normalized as T;\n}\n\n/**\n * Normalizes form data before mutation (DATETIME fields)\n * - Converts empty string datetimes to undefined\n * - Converts Date objects to full ISO timestamp strings\n * - Leaves valid datetime strings as-is\n * \n * @param data - Form data object with potential datetime fields\n * @param dateTimeFields - Array of field names that contain datetime values\n * @returns Normalized data ready for API submission\n */\nexport function normalizeDateTimeInputs<T extends Record<string, any>>(\n  data: T,\n  dateTimeFields: string[]\n): T {\n  const normalized: any = { ...data };\n\n  for (const field of dateTimeFields) {\n    const value = normalized[field];\n\n    // Convert empty strings to undefined\n    if (value === \"\" || value === null) {\n      normalized[field] = undefined;\n      continue;\n    }\n\n    // Convert Date objects to full ISO timestamp strings\n    if (value instanceof Date) {\n      normalized[field] = value.toISOString();\n      continue;\n    }\n\n    // Leave valid strings as-is\n    if (typeof value === 'string') {\n      normalized[field] = value;\n    }\n  }\n\n  return normalized as T;\n}\n\n/**\n * Pre-configured normalization for lead data\n */\nexport function normalizeLeadData<T extends Record<string, any>>(data: T): T {\n  return normalizeDateInputs(data, ['followUpDate']);\n}\n\n/**\n * Pre-configured normalization for project data\n */\nexport function normalizeProjectData<T extends Record<string, any>>(data: T): T {\n  return normalizeDateInputs(data, ['deadline']);\n}\n\n/**\n * Pre-configured normalization for task data\n */\nexport function normalizeTaskData<T extends Record<string, any>>(data: T): T {\n  return normalizeDateInputs(data, ['deadline']);\n}\n\n/**\n * Pre-configured normalization for invoice data\n */\nexport function normalizeInvoiceData<T extends Record<string, any>>(data: T): T {\n  return normalizeDateInputs(data, ['dueDate', 'sentDate']);\n}\n\n/**\n * Pre-configured normalization for attendance data\n * date: date-only field\n * checkIn, checkOut: datetime fields\n */\nexport function normalizeAttendanceData<T extends Record<string, any>>(data: T): T {\n  let normalized = normalizeDateInputs(data, ['date']);\n  normalized = normalizeDateTimeInputs(normalized, ['checkIn', 'checkOut']);\n  return normalized;\n}\n\n/**\n * Pre-configured normalization for income data\n */\nexport function normalizeIncomeData<T extends Record<string, any>>(data: T): T {\n  return normalizeDateInputs(data, ['date']);\n}\n\n/**\n * Pre-configured normalization for expense data\n */\nexport function normalizeExpenseData<T extends Record<string, any>>(data: T): T {\n  return normalizeDateInputs(data, ['date']);\n}\n\n/**\n * Pre-configured normalization for payment data\n * paymentDate: datetime field\n */\nexport function normalizePaymentData<T extends Record<string, any>>(data: T): T {\n  return normalizeDateTimeInputs(data, ['paymentDate']);\n}\n","path":null,"size_bytes":4076,"size_tokens":null},"server/db.ts":{"content":"import { drizzle } from \"drizzle-orm/neon-serverless\";\nimport { Pool, neonConfig } from \"@neondatabase/serverless\";\nimport * as schema from \"@shared/schema\";\nimport ws from \"ws\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL must be set. Did you forget to provision a database?\");\n}\n\n// Configure Neon to use WebSocket polyfill for Node.js environment\nneonConfig.webSocketConstructor = ws;\n\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":527,"size_tokens":null},"server/services/deviceAdapters.ts":{"content":"/**\n * Device Adapter Interface for Biometric Attendance Devices\n * Supports pluggable adapters for different device manufacturers\n */\n\nexport interface DeviceLog {\n  deviceId: string;\n  employeeId: string;\n  punchTime: Date;\n  type: \"check-in\" | \"check-out\";\n  raw?: any;\n}\n\nexport interface DeviceAdapter {\n  connect(config: any): Promise<boolean>;\n  disconnect(): Promise<void>;\n  fetchLogs(lastSyncTime?: Date): Promise<DeviceLog[]>;\n  testConnection(): Promise<boolean>;\n}\n\n/**\n * ZKTeco Device Adapter\n * Supports ZKTeco biometric devices via TCP/IP\n */\nexport class ZKTecoAdapter implements DeviceAdapter {\n  private config: any;\n  private connected: boolean = false;\n\n  async connect(config: any): Promise<boolean> {\n    this.config = config;\n    \n    try {\n      // In production, this would use ZKTeco SDK or TCP socket connection\n      // For now, we'll simulate the connection\n      console.log(`Connecting to ZKTeco device at ${config.ipAddress}:${config.port || 4370}`);\n      \n      // Simulated connection validation\n      if (!config.ipAddress) {\n        throw new Error(\"IP address is required for ZKTeco device\");\n      }\n      \n      this.connected = true;\n      console.log(`ZKTeco device connected: ${config.name}`);\n      return true;\n    } catch (error: any) {\n      console.error(`Failed to connect to ZKTeco device: ${error.message}`);\n      this.connected = false;\n      return false;\n    }\n  }\n\n  async disconnect(): Promise<void> {\n    this.connected = false;\n    console.log(`ZKTeco device disconnected: ${this.config?.name}`);\n  }\n\n  async testConnection(): Promise<boolean> {\n    if (!this.connected) {\n      return this.connect(this.config);\n    }\n    return true;\n  }\n\n  async fetchLogs(lastSyncTime?: Date): Promise<DeviceLog[]> {\n    if (!this.connected) {\n      throw new Error(\"Device not connected. Call connect() first.\");\n    }\n\n    try {\n      // In production, this would fetch from actual ZKTeco device\n      // Using ZKTeco SDK commands or raw TCP protocol\n      \n      // Simulated log fetching for demonstration\n      console.log(`Fetching logs from ZKTeco device since ${lastSyncTime?.toISOString() || 'beginning'}`);\n      \n      // Return empty array for now - in production this would return actual device logs\n      // Example format:\n      // return [\n      //   { deviceId: this.config.id, employeeId: 'EMP001', punchTime: new Date(), type: 'check-in' },\n      //   { deviceId: this.config.id, employeeId: 'EMP001', punchTime: new Date(), type: 'check-out' },\n      // ];\n      \n      return [];\n    } catch (error: any) {\n      console.error(`Failed to fetch logs from ZKTeco device: ${error.message}`);\n      throw error;\n    }\n  }\n}\n\n/**\n * Suprema Device Adapter\n * Supports Suprema BioStar devices via HTTP API\n */\nexport class SupremaAdapter implements DeviceAdapter {\n  private config: any;\n  private connected: boolean = false;\n\n  async connect(config: any): Promise<boolean> {\n    this.config = config;\n    \n    try {\n      console.log(`Connecting to Suprema device at ${config.ipAddress}`);\n      \n      // In production, this would use Suprema BioStar HTTP API\n      // Authenticate with API key and test connection\n      if (!config.ipAddress || !config.apiKey) {\n        throw new Error(\"IP address and API key are required for Suprema device\");\n      }\n      \n      this.connected = true;\n      console.log(`Suprema device connected: ${config.name}`);\n      return true;\n    } catch (error: any) {\n      console.error(`Failed to connect to Suprema device: ${error.message}`);\n      this.connected = false;\n      return false;\n    }\n  }\n\n  async disconnect(): Promise<void> {\n    this.connected = false;\n    console.log(`Suprema device disconnected: ${this.config?.name}`);\n  }\n\n  async testConnection(): Promise<boolean> {\n    if (!this.connected) {\n      return this.connect(this.config);\n    }\n    return true;\n  }\n\n  async fetchLogs(lastSyncTime?: Date): Promise<DeviceLog[]> {\n    if (!this.connected) {\n      throw new Error(\"Device not connected. Call connect() first.\");\n    }\n\n    try {\n      console.log(`Fetching logs from Suprema device since ${lastSyncTime?.toISOString() || 'beginning'}`);\n      \n      // In production, this would call Suprema BioStar HTTP API\n      // Example: GET /api/events?startTime={lastSyncTime}\n      \n      return [];\n    } catch (error: any) {\n      console.error(`Failed to fetch logs from Suprema device: ${error.message}`);\n      throw error;\n    }\n  }\n}\n\n/**\n * Generic HTTP Device Adapter\n * For devices with custom HTTP/REST APIs\n */\nexport class HttpDeviceAdapter implements DeviceAdapter {\n  private config: any;\n  private connected: boolean = false;\n\n  async connect(config: any): Promise<boolean> {\n    this.config = config;\n    \n    try {\n      console.log(`Connecting to HTTP device at ${config.apiUrl}`);\n      \n      if (!config.apiUrl) {\n        throw new Error(\"API URL is required for HTTP device\");\n      }\n      \n      // Test connection with a ping/health check endpoint if available\n      this.connected = true;\n      console.log(`HTTP device connected: ${config.name}`);\n      return true;\n    } catch (error: any) {\n      console.error(`Failed to connect to HTTP device: ${error.message}`);\n      this.connected = false;\n      return false;\n    }\n  }\n\n  async disconnect(): Promise<void> {\n    this.connected = false;\n    console.log(`HTTP device disconnected: ${this.config?.name}`);\n  }\n\n  async testConnection(): Promise<boolean> {\n    if (!this.connected) {\n      return this.connect(this.config);\n    }\n    return true;\n  }\n\n  async fetchLogs(lastSyncTime?: Date): Promise<DeviceLog[]> {\n    if (!this.connected) {\n      throw new Error(\"Device not connected. Call connect() first.\");\n    }\n\n    try {\n      console.log(`Fetching logs from HTTP device since ${lastSyncTime?.toISOString() || 'beginning'}`);\n      \n      // In production, make HTTP request to custom endpoint\n      // const response = await fetch(`${this.config.apiUrl}/logs?since=${lastSyncTime}`);\n      \n      return [];\n    } catch (error: any) {\n      console.error(`Failed to fetch logs from HTTP device: ${error.message}`);\n      throw error;\n    }\n  }\n}\n\n/**\n * Device Adapter Factory\n * Creates appropriate adapter based on device type\n */\nexport function createDeviceAdapter(deviceType: string): DeviceAdapter {\n  switch (deviceType.toLowerCase()) {\n    case \"zkteco\":\n      return new ZKTecoAdapter();\n    case \"suprema\":\n      return new SupremaAdapter();\n    case \"http\":\n      return new HttpDeviceAdapter();\n    default:\n      throw new Error(`Unsupported device type: ${deviceType}`);\n  }\n}\n","path":null,"size_bytes":6610,"size_tokens":null},"server/middleware/audit.ts":{"content":"import { Request, Response, NextFunction } from \"express\";\nimport { db } from \"../db\";\nimport { auditLogs } from \"@shared/schema\";\nimport { AuthRequest } from \"./auth\";\n\nexport async function auditLog(\n  userId: string | undefined,\n  action: string,\n  resourceType: string,\n  resourceId?: string,\n  details?: any\n) {\n  try {\n    await db.insert(auditLogs).values({\n      userId: userId ?? null,\n      action,\n      resourceType,\n      resourceId: resourceId ?? null,\n      details: details ?? null,\n    });\n  } catch (error) {\n    console.error(\"Audit log error:\", error);\n  }\n}\n\nexport function auditMiddleware(action: string, resourceType: string) {\n  return (req: AuthRequest, res: Response, next: NextFunction) => {\n    const originalJson = res.json.bind(res);\n    res.json = function (data: any) {\n      if (res.statusCode >= 200 && res.statusCode < 300) {\n        const resourceId = req.params.id || data?.id;\n        auditLog(req.userId, action, resourceType, resourceId);\n      }\n      return originalJson(data);\n    };\n    next();\n  };\n}\n","path":null,"size_bytes":1047,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { useTheme } from \"@/lib/theme-provider\";\nimport { useAuth } from \"@/lib/auth-context\";\n\nexport default function Settings() {\n  const { theme, toggleTheme } = useTheme();\n  const { user } = useAuth();\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Settings</h1>\n        <p className=\"text-sm text-muted-foreground\">Manage your preferences</p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Profile</CardTitle>\n          <CardDescription>Your account information</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label>Full Name</Label>\n            <Input defaultValue={user?.fullName} data-testid=\"input-fullname\" />\n          </div>\n          <div className=\"space-y-2\">\n            <Label>Email</Label>\n            <Input defaultValue={user?.email} type=\"email\" data-testid=\"input-email\" />\n          </div>\n          <div className=\"space-y-2\">\n            <Label>Role</Label>\n            <Input defaultValue={user?.role} disabled />\n          </div>\n          <Button data-testid=\"button-save-profile\">Save Changes</Button>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Appearance</CardTitle>\n          <CardDescription>Customize how the app looks</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <Label htmlFor=\"dark-mode\">Dark Mode</Label>\n              <p className=\"text-sm text-muted-foreground\">Toggle dark mode theme</p>\n            </div>\n            <Switch\n              id=\"dark-mode\"\n              checked={theme === \"dark\"}\n              onCheckedChange={toggleTheme}\n              data-testid=\"switch-dark-mode\"\n            />\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Notifications</CardTitle>\n          <CardDescription>Configure notification preferences</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <Label htmlFor=\"email-notifications\">Email Notifications</Label>\n              <p className=\"text-sm text-muted-foreground\">Receive email updates</p>\n            </div>\n            <Switch id=\"email-notifications\" defaultChecked data-testid=\"switch-email-notifications\" />\n          </div>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <Label htmlFor=\"task-notifications\">Task Assignments</Label>\n              <p className=\"text-sm text-muted-foreground\">Get notified when assigned tasks</p>\n            </div>\n            <Switch id=\"task-notifications\" defaultChecked data-testid=\"switch-task-notifications\" />\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":3299,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"server/storage.ts":{"content":"import { type User, type InsertUser } from \"@shared/schema\";\nimport { randomUUID } from \"crypto\";\n\n// modify the interface with any CRUD methods\n// you might need\n\nexport interface IStorage {\n  getUser(id: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n}\n\nexport class MemStorage implements IStorage {\n  private users: Map<string, User>;\n\n  constructor() {\n    this.users = new Map();\n  }\n\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(\n      (user) => user.email === email,\n    );\n  }\n\n  async createUser(insertUser: InsertUser & Partial<Pick<User, 'role' | 'clientId'>>): Promise<User> {\n    const id = randomUUID();\n    const user: User = { \n      ...insertUser,\n      role: insertUser.role ?? \"developer\",\n      clientId: insertUser.clientId ?? null,\n      id,\n      createdAt: new Date(),\n    };\n    this.users.set(id, user);\n    return user;\n  }\n}\n\nexport const storage = new MemStorage();\n","path":null,"size_bytes":1154,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route, Redirect } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { ThemeProvider } from \"@/lib/theme-provider\";\nimport { AuthProvider, useAuth } from \"@/lib/auth-context\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { NotificationBell } from \"@/components/notification-bell\";\nimport ChatWidget from \"@/components/chat-widget\";\n\nimport Dashboard from \"@/pages/dashboard\";\nimport Login from \"@/pages/login\";\nimport Leads from \"@/pages/leads\";\nimport Clients from \"@/pages/clients\";\nimport Projects from \"@/pages/projects\";\nimport Tasks from \"@/pages/tasks\";\nimport Team from \"@/pages/team\";\nimport AttendancePage from \"@/pages/attendance\";\nimport Finance from \"@/pages/finance\";\nimport Invoices from \"@/pages/invoices\";\nimport Payments from \"@/pages/payments\";\nimport Files from \"@/pages/files\";\nimport Chat from \"@/pages/chat\";\nimport AuditLogs from \"@/pages/audit-logs\";\nimport Settings from \"@/pages/settings\";\nimport Employees from \"@/pages/employees\";\nimport Departments from \"@/pages/departments\";\nimport HRAttendance from \"@/pages/hr-attendance\";\nimport LeaveManagement from \"@/pages/leave-management\";\nimport Payroll from \"@/pages/payroll\";\nimport AccountsDashboard from \"@/pages/accounts-dashboard\";\nimport ExpenseCategories from \"@/pages/expense-categories\";\nimport SalaryPayments from \"@/pages/salary-payments\";\nimport FinancialReports from \"@/pages/financial-reports\";\nimport ProfitLoss from \"@/pages/profit-loss\";\nimport GeneralLedger from \"@/pages/general-ledger\";\nimport PayrollReport from \"@/pages/payroll-report\";\nimport SalarySheet from \"@/pages/salary-sheet\";\nimport SalarySlip from \"@/pages/salary-slip\";\nimport PaymentReceipt from \"@/pages/payment-receipt\";\nimport HRAttendanceReport from \"@/pages/hr-attendance-report\";\nimport LeaveSummaryReport from \"@/pages/leave-summary-report\";\nimport OfficeSettings from \"@/pages/office-settings\";\nimport ProjectCredentials from \"@/pages/project-credentials\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction ProtectedRoute({ component: Component }: { component: () => JSX.Element }) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-lg\">Loading...</div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return <Redirect to=\"/login\" />;\n  }\n\n  return <Component />;\n}\n\nfunction ProtectedRouteWithRoles({ \n  component: Component, \n  allowedRoles \n}: { \n  component: () => JSX.Element; \n  allowedRoles: string[];\n}) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-lg\">Loading...</div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return <Redirect to=\"/login\" />;\n  }\n\n  if (!allowedRoles.includes(user.role)) {\n    return <Redirect to=\"/\" />;\n  }\n\n  return <Component />;\n}\n\nfunction AuthRoute({ component: Component }: { component: () => JSX.Element }) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-lg\">Loading...</div>\n      </div>\n    );\n  }\n\n  if (user) {\n    return <Redirect to=\"/\" />;\n  }\n\n  return <Component />;\n}\n\nfunction AppRouter() {\n  return (\n    <Switch>\n      <Route path=\"/login\" component={() => <AuthRoute component={Login} />} />\n      <Route path=\"/\" component={() => <ProtectedRoute component={Dashboard} />} />\n      <Route path=\"/leads\" component={() => <ProtectedRoute component={Leads} />} />\n      <Route path=\"/clients\" component={() => <ProtectedRoute component={Clients} />} />\n      <Route path=\"/projects\" component={() => <ProtectedRoute component={Projects} />} />\n      <Route path=\"/tasks\" component={() => <ProtectedRoute component={Tasks} />} />\n      <Route path=\"/team\" component={() => <ProtectedRoute component={Team} />} />\n      <Route path=\"/project-credentials\" component={() => <ProtectedRouteWithRoles component={ProjectCredentials} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/attendance\" component={() => <ProtectedRoute component={AttendancePage} />} />\n      <Route path=\"/finance\" component={() => <ProtectedRoute component={Finance} />} />\n      <Route path=\"/invoices\" component={() => <ProtectedRoute component={Invoices} />} />\n      <Route path=\"/payments\" component={() => <ProtectedRoute component={Payments} />} />\n      <Route path=\"/files\" component={() => <ProtectedRoute component={Files} />} />\n      <Route path=\"/chat\" component={() => <ProtectedRoute component={Chat} />} />\n      <Route path=\"/audit-logs\" component={() => <ProtectedRoute component={AuditLogs} />} />\n      <Route path=\"/settings\" component={() => <ProtectedRoute component={Settings} />} />\n      <Route path=\"/office-settings\" component={() => <ProtectedRouteWithRoles component={OfficeSettings} allowedRoles={[\"admin\"]} />} />\n      <Route path=\"/hr/employees\" component={() => <ProtectedRoute component={Employees} />} />\n      <Route path=\"/hr/departments\" component={() => <ProtectedRoute component={Departments} />} />\n      <Route path=\"/hr/attendance\" component={() => <ProtectedRoute component={HRAttendance} />} />\n      <Route path=\"/hr/leave\" component={() => <ProtectedRoute component={LeaveManagement} />} />\n      <Route path=\"/hr/payroll\" component={() => <ProtectedRoute component={Payroll} />} />\n      <Route path=\"/hr/salary-sheet\" component={() => <ProtectedRouteWithRoles component={SalarySheet} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/hr/salary-slip\" component={() => <ProtectedRouteWithRoles component={SalarySlip} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/accounts/dashboard\" component={() => <ProtectedRouteWithRoles component={AccountsDashboard} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/accounts/categories\" component={() => <ProtectedRouteWithRoles component={ExpenseCategories} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/accounts/salary-payments\" component={() => <ProtectedRouteWithRoles component={SalaryPayments} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/accounts/reports\" component={() => <ProtectedRouteWithRoles component={FinancialReports} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/accounts/profit-loss\" component={() => <ProtectedRouteWithRoles component={ProfitLoss} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/accounts/ledger\" component={() => <ProtectedRouteWithRoles component={GeneralLedger} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/accounts/payroll-report\" component={() => <ProtectedRouteWithRoles component={PayrollReport} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/accounts/payment-receipt\" component={() => <ProtectedRouteWithRoles component={PaymentReceipt} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/hr/attendance-report\" component={() => <ProtectedRouteWithRoles component={HRAttendanceReport} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route path=\"/hr/leave-summary\" component={() => <ProtectedRouteWithRoles component={LeaveSummaryReport} allowedRoles={[\"admin\", \"operational_head\"]} />} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction AppLayout() {\n  const { user } = useAuth();\n\n  if (!user) {\n    return <AppRouter />;\n  }\n\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  return (\n    <>\n      <SidebarProvider style={style as React.CSSProperties}>\n        <div className=\"flex h-screen w-full\">\n          <AppSidebar />\n          <div className=\"flex flex-col flex-1\">\n            <header className=\"flex items-center justify-between p-4 border-b\">\n              <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n              <div className=\"flex items-center gap-2\">\n                <NotificationBell />\n                <ThemeToggle />\n              </div>\n            </header>\n            <main className=\"flex-1 overflow-auto\">\n              <AppRouter />\n            </main>\n          </div>\n        </div>\n      </SidebarProvider>\n      {/* Floating Chat Widget - Rendered outside layout to ensure fixed positioning works */}\n      <ChatWidget />\n    </>\n  );\n}\n\nexport default function App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider>\n        <AuthProvider>\n          <TooltipProvider>\n            <AppLayout />\n            <Toaster />\n          </TooltipProvider>\n        </AuthProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n","path":null,"size_bytes":9101,"size_tokens":null},"client/src/pages/files.tsx":{"content":"import { useState } from \"react\";\nimport { Upload, FileText, Download, Trash } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { type File as FileType, type Project } from \"@shared/schema\";\nimport { z } from \"zod\";\n\nconst fileUploadSchema = z.object({\n  projectId: z.string().optional(),\n  file: z.any(),\n});\n\ntype FileUploadData = z.infer<typeof fileUploadSchema>;\n\nexport default function Files() {\n  const [open, setOpen] = useState(false);\n  const { toast } = useToast();\n  const { data: files, isLoading } = useQuery<FileType[]>({\n    queryKey: [\"/api/files\"],\n  });\n  const { data: projects } = useQuery<Project[]>({\n    queryKey: [\"/api/projects\"],\n  });\n\n  const form = useForm<FileUploadData>({\n    resolver: zodResolver(fileUploadSchema),\n    defaultValues: {\n      projectId: \"\",\n    },\n  });\n\n  const uploadMutation = useMutation({\n    mutationFn: async (data: FileUploadData) => {\n      if (!data.file) {\n        throw new Error(\"No file selected\");\n      }\n\n      const formData = new FormData();\n      formData.append(\"file\", data.file);\n      if (data.projectId) {\n        formData.append(\"projectId\", data.projectId);\n      }\n\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(\"/api/files\", {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n        body: formData,\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Upload failed\");\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/files\"] });\n      toast({ title: \"Success\", description: \"File uploaded successfully\" });\n      setOpen(false);\n      form.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (fileId: string) => {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/files/${fileId}`, {\n        method: \"DELETE\",\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Delete failed\");\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/files\"] });\n      toast({ title: \"Success\", description: \"File deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onSubmit = async (data: FileUploadData) => {\n    uploadMutation.mutate(data);\n  };\n\n  const handleDownload = async (fileId: string, fileName: string) => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/files/${fileId}/download`, {\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n      });\n\n      if (!response.ok) throw new Error(\"Download failed\");\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = fileName;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n    } catch (error) {\n      toast({ \n        title: \"Error\", \n        description: \"Failed to download file\", \n        variant: \"destructive\" \n      });\n    }\n  };\n\n  const handleDelete = (fileId: string) => {\n    if (confirm(\"Are you sure you want to delete this file?\")) {\n      deleteMutation.mutate(fileId);\n    }\n  };\n\n  const formatFileSize = (bytes: number | null) => {\n    if (!bytes) return \"0 B\";\n    const k = 1024;\n    const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return `${(bytes / Math.pow(k, i)).toFixed(2)} ${sizes[i]}`;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"h-8 bg-muted rounded w-32 mb-6 animate-pulse\" />\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardContent className=\"p-6\">\n                <div className=\"h-12 w-12 bg-muted rounded mb-3 animate-pulse\" />\n                <div className=\"h-5 bg-muted rounded w-3/4 mb-2 animate-pulse\" />\n                <div className=\"h-4 bg-muted rounded w-1/2 animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Files</h1>\n          <p className=\"text-sm text-muted-foreground\">Manage project files</p>\n        </div>\n        <Dialog open={open} onOpenChange={setOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-upload-file\">\n              <Upload className=\"w-4 h-4 mr-2\" />\n              Upload File\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Upload File</DialogTitle>\n              <DialogDescription>Upload a file to a project</DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"projectId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Project (Optional)</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-project\">\n                            <SelectValue placeholder=\"Select project\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {projects?.map((project) => (\n                            <SelectItem key={project.id} value={project.id}>\n                              {project.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"file\"\n                  render={({ field: { onChange, value, ...field } }) => (\n                    <FormItem>\n                      <FormLabel>File</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"file\"\n                          onChange={(e) => onChange(e.target.files?.[0])}\n                          {...field}\n                          data-testid=\"input-file\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"flex justify-end gap-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setOpen(false)}>Cancel</Button>\n                  <Button type=\"submit\" disabled={uploadMutation.isPending} data-testid=\"button-submit-file\">\n                    {uploadMutation.isPending ? \"Uploading...\" : \"Upload\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {!files || files.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n              <Upload className=\"w-8 h-8 text-muted-foreground\" />\n            </div>\n            <h3 className=\"text-lg font-semibold mb-2\">No files uploaded</h3>\n            <p className=\"text-sm text-muted-foreground mb-4\">Upload your first file</p>\n            <Button onClick={() => setOpen(true)}>Upload File</Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {files.map((file) => (\n            <Card key={file.id} className=\"hover-elevate\" data-testid={`card-file-${file.id}`}>\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"p-3 rounded-md bg-muted\">\n                    <FileText className=\"w-8 h-8 text-muted-foreground\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <h3 className=\"font-semibold truncate mb-1\" data-testid={`text-filename-${file.id}`}>\n                      {file.fileName}\n                    </h3>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {formatFileSize(file.fileSize)}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {new Date(file.createdAt).toLocaleDateString()}\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2 mt-4\">\n                  <Button \n                    size=\"sm\" \n                    variant=\"outline\" \n                    className=\"flex-1\" \n                    onClick={() => handleDownload(file.id, file.fileName)}\n                    data-testid={`button-download-${file.id}`}\n                  >\n                    <Download className=\"w-4 h-4 mr-1\" />\n                    Download\n                  </Button>\n                  <Button \n                    size=\"sm\" \n                    variant=\"ghost\" \n                    onClick={() => handleDelete(file.id)}\n                    disabled={deleteMutation.isPending}\n                    data-testid={`button-delete-${file.id}`}\n                  >\n                    <Trash className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":11180,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"server/websocket.ts":{"content":"import { WebSocketServer, WebSocket } from \"ws\";\nimport { type Server } from \"http\";\nimport jwt from \"jsonwebtoken\";\nimport { db } from \"./db\";\nimport { users, projects, tasks } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\n// Use the same JWT secret as the REST API for consistency\nconst JWT_SECRET = process.env.JWT_SECRET || \"dev-secret-change-in-production\";\n\ninterface AuthenticatedWebSocket extends WebSocket {\n  userId?: string;\n  userRole?: string;\n  isAlive?: boolean;\n}\n\ninterface WebSocketMessage {\n  type: \"subscribe\" | \"unsubscribe\" | \"message\" | \"ping\";\n  projectId?: string;\n  content?: string;\n}\n\nexport class WebSocketService {\n  private wss: WebSocketServer | null = null;\n  private projectSubscriptions: Map<string, Set<AuthenticatedWebSocket>> = new Map();\n  private userConnections: Map<string, Set<AuthenticatedWebSocket>> = new Map();\n  private heartbeatInterval: NodeJS.Timeout | null = null;\n\n  initialize(server: Server) {\n    this.wss = new WebSocketServer({ \n      server,\n      path: \"/ws\"\n    });\n\n    this.wss.on(\"connection\", async (ws: AuthenticatedWebSocket, req) => {\n      console.log(\"New WebSocket connection attempt\");\n      \n      // Extract token from query string\n      const url = new URL(req.url || \"\", `http://${req.headers.host}`);\n      const token = url.searchParams.get(\"token\");\n\n      if (!token) {\n        console.log(\"WebSocket connection rejected: No token provided\");\n        ws.close(1008, \"Authentication required\");\n        return;\n      }\n\n      try {\n        // Verify JWT token using the same secret as REST API\n        const decoded = jwt.verify(token, JWT_SECRET) as {\n          userId: string;\n          role: string;\n        };\n\n        // Verify user exists\n        const [user] = await db.select().from(users).where(eq(users.id, decoded.userId)).limit(1);\n        if (!user) {\n          console.log(\"WebSocket connection rejected: User not found\");\n          ws.close(1008, \"User not found\");\n          return;\n        }\n\n        ws.userId = decoded.userId;\n        ws.userRole = decoded.role;\n        ws.isAlive = true;\n\n        // Track user connection for notification broadcasting\n        if (!this.userConnections.has(decoded.userId)) {\n          this.userConnections.set(decoded.userId, new Set());\n        }\n        this.userConnections.get(decoded.userId)!.add(ws);\n\n        console.log(`WebSocket authenticated for user: ${user.fullName} (${user.role})`);\n\n        // Handle ping/pong for connection health\n        ws.on(\"pong\", () => {\n          ws.isAlive = true;\n        });\n\n        ws.on(\"message\", (data) => {\n          try {\n            const message: WebSocketMessage = JSON.parse(data.toString());\n            this.handleMessage(ws, message);\n          } catch (error) {\n            console.error(\"Error parsing WebSocket message:\", error);\n            ws.send(JSON.stringify({ type: \"error\", message: \"Invalid message format\" }));\n          }\n        });\n\n        ws.on(\"close\", () => {\n          console.log(`WebSocket closed for user: ${ws.userId}`);\n          \n          // Remove from project subscriptions\n          this.projectSubscriptions.forEach((subscribers) => {\n            subscribers.delete(ws);\n          });\n          \n          // Remove from user connections\n          if (ws.userId) {\n            const userConnections = this.userConnections.get(ws.userId);\n            if (userConnections) {\n              userConnections.delete(ws);\n              if (userConnections.size === 0) {\n                this.userConnections.delete(ws.userId);\n              }\n            }\n          }\n        });\n\n        ws.on(\"error\", (error) => {\n          console.error(\"WebSocket error:\", error);\n        });\n\n        // AUTO-SUBSCRIBE developers/admins to all their assigned projects (Unified Inbox)\n        if (ws.userRole === \"developer\" || ws.userRole === \"admin\" || ws.userRole === \"operational_head\") {\n          await this.autoSubscribeToAllProjects(ws);\n        }\n\n        // Send welcome message\n        ws.send(JSON.stringify({ \n          type: \"connected\", \n          message: \"WebSocket connected successfully\",\n          userId: ws.userId,\n          autoSubscribed: ws.userRole !== \"client\"\n        }));\n\n      } catch (error) {\n        console.log(\"WebSocket authentication failed:\", error);\n        ws.close(1008, \"Authentication failed\");\n      }\n    });\n\n    // Start heartbeat to detect dead connections\n    this.startHeartbeat();\n\n    console.log(\"WebSocket server initialized on path /ws\");\n  }\n\n  private handleMessage(ws: AuthenticatedWebSocket, message: WebSocketMessage) {\n    switch (message.type) {\n      case \"subscribe\":\n        if (message.projectId) {\n          this.subscribeToProject(ws, message.projectId);\n        } else {\n          // Subscribe to all projects (for developers/admins)\n          this.autoSubscribeToAllProjects(ws);\n        }\n        break;\n\n      case \"unsubscribe\":\n        if (message.projectId) {\n          this.unsubscribeFromProject(ws, message.projectId);\n        }\n        break;\n\n      case \"ping\":\n        ws.send(JSON.stringify({ type: \"pong\" }));\n        break;\n\n      default:\n        ws.send(JSON.stringify({ type: \"error\", message: \"Unknown message type\" }));\n    }\n  }\n\n  // Auto-subscribe developers/admins to all their assigned projects\n  private async autoSubscribeToAllProjects(ws: AuthenticatedWebSocket) {\n    try {\n      if (!ws.userId) {\n        return;\n      }\n\n      // For clients, they must subscribe to specific projects manually\n      if (ws.userRole === \"client\") {\n        ws.send(JSON.stringify({ \n          type: \"error\", \n          message: \"Clients must subscribe to specific projects\"\n        }));\n        return;\n      }\n\n      // Determine which projects to subscribe to based on role\n      let projectIds: string[];\n      \n      if (ws.userRole === \"admin\" || ws.userRole === \"operational_head\") {\n        // Admins/ops get all projects (even without assigned tasks)\n        const allProjects = await db.select({ id: projects.id }).from(projects);\n        projectIds = allProjects.map(p => p.id);\n      } else {\n        // Developers get only projects they're assigned to via tasks\n        const assignedTasks = await db\n          .select({ projectId: tasks.projectId })\n          .from(tasks)\n          .where(eq(tasks.assignedTo, ws.userId));\n        \n        const uniqueProjectIds = new Set(assignedTasks.map(t => t.projectId));\n        projectIds = Array.from(uniqueProjectIds);\n      }\n      \n      if (projectIds.length === 0) {\n        ws.send(JSON.stringify({ \n          type: \"subscribed_all\", \n          message: \"No assigned projects found\",\n          projectCount: 0\n        }));\n        return;\n      }\n\n      // Subscribe to all accessible projects\n      let subscribed = 0;\n      for (const projectId of projectIds) {\n        if (!this.projectSubscriptions.has(projectId)) {\n          this.projectSubscriptions.set(projectId, new Set());\n        }\n        this.projectSubscriptions.get(projectId)!.add(ws);\n        subscribed++;\n      }\n\n      console.log(`User ${ws.userId} (${ws.userRole}) auto-subscribed to ${subscribed} projects`);\n      \n      ws.send(JSON.stringify({ \n        type: \"subscribed_all\", \n        message: `Auto-subscribed to ${subscribed} projects`,\n        projectCount: subscribed,\n        projectIds\n      }));\n    } catch (error) {\n      console.error(\"Error auto-subscribing to projects:\", error);\n      ws.send(JSON.stringify({ \n        type: \"error\", \n        message: \"Failed to auto-subscribe to projects\"\n      }));\n    }\n  }\n\n  private async subscribeToProject(ws: AuthenticatedWebSocket, projectId: string) {\n    // CLIENT SECURITY: Verify client owns the project before allowing subscription\n    if (ws.userRole === \"client\") {\n      try {\n        // Get user's clientId\n        const [user] = await db.select().from(users).where(eq(users.id, ws.userId!)).limit(1);\n        if (!user?.clientId) {\n          ws.send(JSON.stringify({ \n            type: \"error\", \n            message: \"No client associated with this user\"\n          }));\n          return;\n        }\n        \n        // Verify client owns this project\n        const [project] = await db.select().from(projects).where(eq(projects.id, projectId)).limit(1);\n        if (!project) {\n          ws.send(JSON.stringify({ \n            type: \"error\", \n            message: \"Project not found\"\n          }));\n          return;\n        }\n        \n        if (project.clientId !== user.clientId) {\n          ws.send(JSON.stringify({ \n            type: \"error\", \n            message: \"Access denied: You can only subscribe to your own projects\"\n          }));\n          console.log(`User ${ws.userId} (client) attempted to subscribe to unauthorized project ${projectId}`);\n          return;\n        }\n      } catch (error) {\n        console.error(\"Error verifying project ownership:\", error);\n        ws.send(JSON.stringify({ \n          type: \"error\", \n          message: \"Failed to verify project access\"\n        }));\n        return;\n      }\n    }\n    \n    if (!this.projectSubscriptions.has(projectId)) {\n      this.projectSubscriptions.set(projectId, new Set());\n    }\n    \n    this.projectSubscriptions.get(projectId)!.add(ws);\n    console.log(`User ${ws.userId} (${ws.userRole}) subscribed to project ${projectId}`);\n    \n    ws.send(JSON.stringify({ \n      type: \"subscribed\", \n      projectId,\n      message: `Subscribed to project ${projectId}`\n    }));\n  }\n\n  private unsubscribeFromProject(ws: AuthenticatedWebSocket, projectId: string) {\n    const subscribers = this.projectSubscriptions.get(projectId);\n    if (subscribers) {\n      subscribers.delete(ws);\n      console.log(`User ${ws.userId} unsubscribed from project ${projectId}`);\n      \n      if (subscribers.size === 0) {\n        this.projectSubscriptions.delete(projectId);\n      }\n    }\n\n    ws.send(JSON.stringify({ \n      type: \"unsubscribed\", \n      projectId,\n      message: `Unsubscribed from project ${projectId}`\n    }));\n  }\n\n  // Broadcast a new message to all subscribers of a project\n  public broadcastMessage(projectId: string, message: any) {\n    const subscribers = this.projectSubscriptions.get(projectId);\n    if (!subscribers || subscribers.size === 0) {\n      console.log(`No subscribers for project ${projectId}`);\n      return;\n    }\n\n    const payload = JSON.stringify({\n      type: \"new_message\",\n      projectId,\n      message\n    });\n\n    let sentCount = 0;\n    subscribers.forEach((ws) => {\n      if (ws.readyState === WebSocket.OPEN) {\n        ws.send(payload);\n        sentCount++;\n      }\n    });\n\n    console.log(`Broadcasted message to ${sentCount} subscribers in project ${projectId}`);\n  }\n\n  // Broadcast a notification to a specific user (all their connected devices/tabs)\n  public broadcastNotification(userId: string, notification: any) {\n    const userSockets = this.userConnections.get(userId);\n    if (!userSockets || userSockets.size === 0) {\n      console.log(`No active connections for user ${userId}`);\n      return;\n    }\n\n    const payload = JSON.stringify({\n      type: \"notification\",\n      notification\n    });\n\n    let sentCount = 0;\n    userSockets.forEach((ws) => {\n      if (ws.readyState === WebSocket.OPEN) {\n        ws.send(payload);\n        sentCount++;\n      }\n    });\n\n    console.log(`Broadcasted notification to ${sentCount} connections for user ${userId}`);\n  }\n\n  private startHeartbeat() {\n    // Ping clients every 30 seconds\n    this.heartbeatInterval = setInterval(() => {\n      if (!this.wss) return;\n\n      this.wss.clients.forEach((ws: AuthenticatedWebSocket) => {\n        if (ws.isAlive === false) {\n          console.log(`Terminating dead connection for user: ${ws.userId}`);\n          return ws.terminate();\n        }\n\n        ws.isAlive = false;\n        ws.ping();\n      });\n    }, 30000);\n  }\n\n  public close() {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n    }\n\n    if (this.wss) {\n      this.wss.close();\n    }\n\n    console.log(\"WebSocket server closed\");\n  }\n}\n\nexport const wsService = new WebSocketService();\n","path":null,"size_bytes":12087,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"@/lib/theme-provider\";\n\nexport function ThemeToggle() {\n  const { theme, toggleTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={toggleTheme}\n      data-testid=\"button-theme-toggle\"\n    >\n      {theme === \"light\" ? (\n        <Moon className=\"w-5 h-5\" />\n      ) : (\n        <Sun className=\"w-5 h-5\" />\n      )}\n    </Button>\n  );\n}\n","path":null,"size_bytes":500,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"server/services/payroll.ts":{"content":"/**\n * Payroll Calculation Service\n * Handles monthly payroll generation with late deduction logic\n */\n\nimport { db } from \"../db\";\nimport { \n  employees, \n  attendance, \n  salaryStructure, \n  payroll,\n  salarySlips,\n  hrSettings\n} from \"@shared/schema\";\nimport { eq, and, gte, lte, sql } from \"drizzle-orm\";\nimport { toDateOnlyString } from \"@shared/date-utils\";\n\nclass PayrollService {\n  /**\n   * Calculate late deduction based on configurable rule: floor(late_days / lateDeductionRule) * day_salary\n   */\n  private calculateLateDeduction(lateDaysCount: number, monthlySalary: number, lateDeductionRule: number, workingDaysPerMonth: number = 26): number {\n    const daySalary = monthlySalary / workingDaysPerMonth;\n    const deductionDays = Math.floor(lateDaysCount / lateDeductionRule);\n    return deductionDays * daySalary;\n  }\n\n  /**\n   * Generate payroll for a specific employee for a given month/year\n   */\n  async generateEmployeePayroll(employeeId: string, month: number, year: number): Promise<any> {\n    try {\n      // Get employee details\n      const [employee] = await db.select()\n        .from(employees)\n        .where(eq(employees.id, employeeId))\n        .limit(1);\n\n      if (!employee) {\n        throw new Error(`Employee not found: ${employeeId}`);\n      }\n\n      // Get salary structure\n      const [salary] = await db.select()\n        .from(salaryStructure)\n        .where(eq(salaryStructure.employeeId, employeeId))\n        .orderBy(sql`${salaryStructure.effectiveFrom} DESC`)\n        .limit(1);\n\n      if (!salary) {\n        throw new Error(`No salary structure found for employee: ${employeeId}`);\n      }\n\n      // Get HR settings for calculations\n      const [settings] = await db.select().from(hrSettings).limit(1);\n      \n      // Use configured office settings with fallback defaults\n      const fullDayHours = settings?.fullDayHours ? parseFloat(settings.fullDayHours.toString()) : 8;\n      const overtimeEnabled = settings?.overtimeEnabled ?? false;\n      const overtimeRateMultiplier = settings?.overtimeRateMultiplier ? parseFloat(settings.overtimeRateMultiplier.toString()) : 1.5;\n      const lateDeductionRule = settings?.lateDeductionRule ? parseInt(settings.lateDeductionRule.toString()) : 3;\n\n      // Calculate date range for the month (timezone-safe)\n      const startDate = new Date(year, month - 1, 1);\n      const endDate = new Date(year, month, 0); // Last day of month\n      const startDateStr = toDateOnlyString(startDate);\n      const endDateStr = toDateOnlyString(endDate);\n      \n      // Calculate actual working days in the month (excluding weekly offs)\n      const weeklyOffDays = (Array.isArray(settings?.weeklyOffDays) ? settings.weeklyOffDays : [\"Friday\"]) as string[];\n      const dayOfWeekMap: { [key: string]: number } = {\n        \"Sunday\": 0, \"Monday\": 1, \"Tuesday\": 2, \"Wednesday\": 3,\n        \"Thursday\": 4, \"Friday\": 5, \"Saturday\": 6\n      };\n      const offDayNumbers = weeklyOffDays.map((day: string) => dayOfWeekMap[day]).filter((num: number | undefined) => num !== undefined) as number[];\n      \n      // Count working days in the month\n      let workingDaysInMonth = 0;\n      const totalDaysInMonth = endDate.getDate();\n      for (let day = 1; day <= totalDaysInMonth; day++) {\n        const currentDate = new Date(year, month - 1, day);\n        const dayOfWeek = currentDate.getDay();\n        if (!offDayNumbers.includes(dayOfWeek)) {\n          workingDaysInMonth++;\n        }\n      }\n\n      // Get attendance records for the month\n      const attendanceRecords = await db.select()\n        .from(attendance)\n        .where(and(\n          eq(attendance.userId, employee.userId!),\n          sql`${attendance.date} >= ${startDateStr}`,\n          sql`${attendance.date} <= ${endDateStr}`\n        ));\n\n      console.log(` PAYROLL DEBUG - Employee: ${employee.fullName}`);\n      console.log(` Date Range: ${startDateStr} to ${endDateStr}`);\n      console.log(` Total attendance records fetched: ${attendanceRecords.length}`);\n      console.log(` Attendance records:`, attendanceRecords.map(r => ({ date: r.date, status: r.status })));\n\n      // Calculate attendance metrics\n      const presentDays = attendanceRecords.filter(a => a.status === 'present' || a.status === 'late').length;\n      const lateDays = attendanceRecords.filter(a => a.status === 'late').length;\n      const absentDays = attendanceRecords.filter(a => a.status === 'absent').length;\n      const halfDays = attendanceRecords.filter(a => a.status === 'half-day').length;\n\n      console.log(` CALCULATED - Present: ${presentDays}, Late: ${lateDays}, Absent: ${absentDays}, Half-Day: ${halfDays}`);\n\n      // Calculate overtime hours from actual check-in/check-out times (only if enabled)\n      let totalOvertimeHours = 0;\n      \n      if (overtimeEnabled) {\n        for (const record of attendanceRecords) {\n          if (record.checkIn && record.checkOut) {\n            const checkInTime = new Date(record.checkIn);\n            const checkOutTime = new Date(record.checkOut);\n            const hoursWorked = (checkOutTime.getTime() - checkInTime.getTime()) / (1000 * 60 * 60);\n            \n            if (hoursWorked > fullDayHours) {\n              totalOvertimeHours += (hoursWorked - fullDayHours);\n            }\n          }\n        }\n      }\n\n      // Calculate components\n      const basicSalary = parseFloat(salary.basicSalary.toString());\n      const houseAllowance = parseFloat(salary.houseAllowance?.toString() || '0');\n      const foodAllowance = parseFloat(salary.foodAllowance?.toString() || '0');\n      const travelAllowance = parseFloat(salary.travelAllowance?.toString() || '0');\n      const medicalAllowance = parseFloat(salary.medicalAllowance?.toString() || '0');\n\n      const grossSalary = basicSalary + houseAllowance + foodAllowance + travelAllowance + medicalAllowance;\n\n      // Calculate deductions using configured office settings and actual working days\n      const effectiveWorkingDays = workingDaysInMonth > 0 ? workingDaysInMonth : 26; // Fallback to 26 if calculation fails\n      const dailyRate = basicSalary / effectiveWorkingDays;\n      const hourlyRate = dailyRate / fullDayHours; // Hourly rate based on configured full-day hours\n      \n      // Late deduction: Using configured late deduction rule and actual working days\n      const lateDeduction = this.calculateLateDeduction(lateDays, basicSalary, lateDeductionRule, effectiveWorkingDays);\n      \n      console.log(` LATE CALCULATION - Late Days: ${lateDays}, Basic: ${basicSalary}, Rule: ${lateDeductionRule}, Working Days: ${effectiveWorkingDays}`);\n      console.log(` LATE DEDUCTION CALCULATED: ${lateDeduction}`);\n      \n      // Half-day deduction: 0.5  Daily Rate\n      const halfDayDeduction = halfDays * (dailyRate * 0.5);\n      \n      // Absent deduction: Daily Rate  Absent Days\n      const absentDeduction = absentDays * dailyRate;\n      \n      // Loan and advance deductions (set to 0 during initial generation - can be added via manual adjustments later)\n      const loanDeduction = 0;\n      const advanceDeduction = 0;\n\n      const totalDeductions = lateDeduction + halfDayDeduction + absentDeduction + loanDeduction + advanceDeduction;\n\n      // Calculate overtime: Using configured overtime rate multiplier\n      const overtimeAmount = overtimeEnabled ? (totalOvertimeHours * (hourlyRate * overtimeRateMultiplier)) : 0;\n\n      // Calculate net salary\n      const netSalary = grossSalary + overtimeAmount - totalDeductions;\n\n      // Create payroll record with full attendance breakdown\n      const payrollData = {\n        employeeId: employeeId,\n        month,\n        year,\n        basicSalary: basicSalary.toString(),\n        totalAllowances: (houseAllowance + foodAllowance + travelAllowance + medicalAllowance).toString(),\n        overtimeAmount: overtimeAmount.toString(),\n        lateDeduction: lateDeduction.toString(),\n        loanDeduction: loanDeduction.toString(),\n        otherDeductions: (halfDayDeduction + absentDeduction).toString(),\n        grossSalary: grossSalary.toString(),\n        netSalary: netSalary.toString(),\n        totalPresentDays: presentDays,\n        totalAbsentDays: absentDays,\n        totalLateDays: lateDays,\n        totalHalfDays: halfDays,\n        totalOvertimeHours: (Math.round(totalOvertimeHours * 100) / 100).toString(),\n        workingDays: workingDaysInMonth, // Actual working days excluding weekly offs\n      };\n\n      return payrollData;\n    } catch (error: any) {\n      console.error(`Error generating payroll for employee ${employeeId}:`, error.message);\n      throw error;\n    }\n  }\n\n  /**\n   * Generate payroll for all active employees for a given month/year\n   */\n  async generateMonthlyPayroll(month: number, year: number, generatedBy: string): Promise<number> {\n    try {\n      // Get all active employees\n      const activeEmployees = await db.select()\n        .from(employees)\n        .where(eq(employees.status, 'active'));\n\n      console.log(`Generating payroll for ${activeEmployees.length} employees for ${year}-${month}`);\n\n      let generatedCount = 0;\n\n      for (const employee of activeEmployees) {\n        try {\n          // Check if payroll already exists\n          const [existing] = await db.select()\n            .from(payroll)\n            .where(and(\n              eq(payroll.employeeId, employee.id),\n              eq(payroll.month, month),\n              eq(payroll.year, year)\n            ))\n            .limit(1);\n\n          if (existing) {\n            console.log(`Payroll already exists for employee ${employee.employeeId} for ${year}-${month}`);\n            continue;\n          }\n\n          // Generate payroll\n          const payrollData = await this.generateEmployeePayroll(employee.id, month, year);\n\n          // Insert payroll record\n          await db.insert(payroll).values({\n            ...payrollData,\n            generatedBy,\n          });\n\n          generatedCount++;\n        } catch (error: any) {\n          console.error(`Failed to generate payroll for employee ${employee.employeeId}:`, error.message);\n        }\n      }\n\n      console.log(`Successfully generated ${generatedCount} payroll records`);\n      return generatedCount;\n    } catch (error: any) {\n      console.error('Error generating monthly payroll:', error.message);\n      throw error;\n    }\n  }\n}\n\nexport const payrollService = new PayrollService();\n","path":null,"size_bytes":10372,"size_tokens":null},"client/src/pages/tasks.tsx":{"content":"import { useState } from \"react\";\nimport { Plus, Calendar, User, FolderPlus, FileX } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { insertTaskSchema, insertProjectSchema, type Task, type Project, type User as UserType, type Client } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { normalizeTaskData, normalizeProjectData } from \"@/lib/normalizeDateInputs\";\n\nconst taskFormSchema = insertTaskSchema.extend({\n  deadline: z.string().optional(),\n});\n\nconst projectFormSchema = insertProjectSchema.extend({\n  deadline: z.string().optional(),\n});\n\ntype TaskFormData = z.infer<typeof taskFormSchema>;\ntype ProjectFormData = z.infer<typeof projectFormSchema>;\n\n// Special values for project dropdown\nconst CREATE_NEW_PROJECT = \"__create_new_project__\";\nconst NO_PROJECT = \"__no_project__\";\n\nexport default function Tasks() {\n  const [taskDialogOpen, setTaskDialogOpen] = useState(false);\n  const [projectDialogOpen, setProjectDialogOpen] = useState(false);\n  const [editingTask, setEditingTask] = useState<Task | null>(null);\n  const { toast } = useToast();\n  const { user } = useAuth();\n  \n  const { data: tasks, isLoading } = useQuery<Task[]>({\n    queryKey: [\"/api/tasks\"],\n  });\n  const { data: projects } = useQuery<Project[]>({\n    queryKey: [\"/api/projects\"],\n  });\n  const { data: users } = useQuery<UserType[]>({\n    queryKey: [\"/api/users\"],\n  });\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const taskForm = useForm<TaskFormData>({\n    resolver: zodResolver(taskFormSchema),\n    defaultValues: {\n      projectId: \"\",\n      title: \"\",\n      description: \"\",\n      status: \"todo\",\n      priority: \"medium\",\n    },\n  });\n\n  const projectForm = useForm<ProjectFormData>({\n    resolver: zodResolver(projectFormSchema),\n    defaultValues: {\n      clientId: \"\",\n      name: \"\",\n      description: \"\",\n      status: \"planning\",\n      budget: \"0\",\n      progress: 0,\n    },\n  });\n\n  const createTaskMutation = useMutation({\n    mutationFn: (data: TaskFormData) => apiRequest(\"POST\", \"/api/tasks\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      toast({ title: \"Success\", description: \"Task created successfully\" });\n      setTaskDialogOpen(false);\n      setEditingTask(null);\n      taskForm.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateTaskMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: TaskFormData }) =>\n      apiRequest(\"PATCH\", `/api/tasks/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      toast({ title: \"Success\", description: \"Task updated successfully\" });\n      setTaskDialogOpen(false);\n      setEditingTask(null);\n      taskForm.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const createProjectMutation = useMutation({\n    mutationFn: (data: ProjectFormData) => apiRequest(\"POST\", \"/api/projects\", data),\n    onSuccess: (newProject: Project) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\"] });\n      toast({ title: \"Success\", description: \"Project created successfully\" });\n      setProjectDialogOpen(false);\n      projectForm.reset();\n      // Auto-select the newly created project\n      taskForm.setValue(\"projectId\", newProject.id);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onTaskSubmit = async (data: TaskFormData) => {\n    const normalizedData = normalizeTaskData(data);\n    if (editingTask) {\n      updateTaskMutation.mutate({ id: editingTask.id, data: normalizedData });\n    } else {\n      createTaskMutation.mutate(normalizedData);\n    }\n  };\n\n  const onProjectSubmit = async (data: ProjectFormData) => {\n    const normalizedData = normalizeProjectData(data);\n    createProjectMutation.mutate(normalizedData);\n  };\n\n  const handleEdit = (task: Task) => {\n    setEditingTask(task);\n    taskForm.reset({\n      projectId: task.projectId || \"\",\n      title: task.title,\n      description: task.description || \"\",\n      status: task.status,\n      priority: task.priority,\n      assignedTo: task.assignedTo || \"\",\n      deadline: task.deadline ? (typeof task.deadline === 'string' ? task.deadline : new Date(task.deadline).toISOString().split('T')[0]) : \"\",\n    });\n    setTaskDialogOpen(true);\n  };\n\n  const handleAddNew = () => {\n    setEditingTask(null);\n    taskForm.reset({\n      projectId: \"\",\n      title: \"\",\n      description: \"\",\n      status: \"todo\",\n      priority: \"medium\",\n    });\n    setTaskDialogOpen(true);\n  };\n\n  const handleProjectSelection = (value: string) => {\n    if (value === CREATE_NEW_PROJECT) {\n      // Open project creation modal\n      projectForm.reset({\n        clientId: \"\",\n        name: \"\",\n        description: \"\",\n        status: \"planning\",\n        budget: \"0\",\n        progress: 0,\n      });\n      setProjectDialogOpen(true);\n    } else if (value === NO_PROJECT) {\n      // Set projectId to empty string for general tasks\n      taskForm.setValue(\"projectId\", \"\");\n    } else {\n      // Normal project selection\n      taskForm.setValue(\"projectId\", value);\n    }\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"todo\": return \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\";\n      case \"in-progress\": return \"bg-blue-100 text-blue-700 dark:bg-blue-950 dark:text-blue-300\";\n      case \"review\": return \"bg-yellow-100 text-yellow-700 dark:bg-yellow-950 dark:text-yellow-300\";\n      case \"done\": return \"bg-green-100 text-green-700 dark:bg-green-950 dark:text-green-300\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case \"high\": return \"bg-red-100 text-red-700 dark:bg-red-950 dark:text-red-300\";\n      case \"medium\": return \"bg-yellow-100 text-yellow-700 dark:bg-yellow-950 dark:text-yellow-300\";\n      case \"low\": return \"bg-blue-100 text-blue-700 dark:bg-blue-950 dark:text-blue-300\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"h-8 bg-muted rounded w-32 mb-6 animate-pulse\" />\n        <div className=\"space-y-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardContent className=\"p-4\">\n                <div className=\"h-5 bg-muted rounded w-3/4 mb-2 animate-pulse\" />\n                <div className=\"h-4 bg-muted rounded w-1/2 animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Tasks</h1>\n          <p className=\"text-sm text-muted-foreground\">Track and manage tasks</p>\n        </div>\n        {/* Only admin and operational_head can create tasks */}\n        {(user?.role === \"admin\" || user?.role === \"operational_head\") && (\n          <Button data-testid=\"button-add-task\" onClick={handleAddNew}>\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Add Task\n          </Button>\n        )}\n      </div>\n\n      {/* Task Dialog */}\n      <Dialog open={taskDialogOpen} onOpenChange={setTaskDialogOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>{editingTask ? \"Edit Task\" : \"Add New Task\"}</DialogTitle>\n            <DialogDescription>\n              {editingTask ? \"Update task information\" : \"Create a new task\"}\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...taskForm}>\n            <form onSubmit={taskForm.handleSubmit(onTaskSubmit)} className=\"space-y-4\">\n              <FormField\n                control={taskForm.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Task Title</FormLabel>\n                    <FormControl>\n                      <Input placeholder=\"Implement user authentication\" {...field} data-testid=\"input-title\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"grid gap-4 md:grid-cols-2\">\n                <FormField\n                  control={taskForm.control}\n                  name=\"projectId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Project</FormLabel>\n                      <Select \n                        onValueChange={handleProjectSelection} \n                        value={field.value || NO_PROJECT}\n                      >\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-project\">\n                            <SelectValue placeholder=\"Select project\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent position=\"popper\">\n                          {/* Regular projects */}\n                          {projects?.map((project) => (\n                            <SelectItem key={project.id} value={project.id}>\n                              {project.name}\n                            </SelectItem>\n                          ))}\n                          \n                          {/* Separator before special options */}\n                          {projects && projects.length > 0 && <Separator className=\"my-1\" />}\n                          \n                          {/* Special options */}\n                          <SelectItem value={NO_PROJECT}>\n                            <div className=\"flex items-center gap-2\">\n                              <FileX className=\"w-4 h-4\" />\n                              <span>General Task / No Project</span>\n                            </div>\n                          </SelectItem>\n                          <SelectItem value={CREATE_NEW_PROJECT}>\n                            <div className=\"flex items-center gap-2\">\n                              <FolderPlus className=\"w-4 h-4\" />\n                              <span>Create New Project</span>\n                            </div>\n                          </SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={taskForm.control}\n                  name=\"assignedTo\"\n                  render={({ field}) => (\n                    <FormItem>\n                      <FormLabel>Assigned To</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value ?? \"\"}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-assigned-to\">\n                            <SelectValue placeholder=\"Select user\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent position=\"popper\">\n                          {users?.map((user) => (\n                            <SelectItem key={user.id} value={user.id}>\n                              {user.fullName}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={taskForm.control}\n                  name=\"status\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Status</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-status\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent position=\"popper\">\n                          <SelectItem value=\"todo\">To Do</SelectItem>\n                          <SelectItem value=\"in-progress\">In Progress</SelectItem>\n                          <SelectItem value=\"review\">Review</SelectItem>\n                          <SelectItem value=\"done\">Done</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={taskForm.control}\n                  name=\"priority\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Priority</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-priority\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent position=\"popper\">\n                          <SelectItem value=\"high\">High</SelectItem>\n                          <SelectItem value=\"medium\">Medium</SelectItem>\n                          <SelectItem value=\"low\">Low</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={taskForm.control}\n                  name=\"deadline\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Deadline</FormLabel>\n                      <FormControl>\n                        <Input type=\"date\" {...field} value={field.value ?? \"\"} data-testid=\"input-deadline\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <FormField\n                control={taskForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea placeholder=\"Task details...\" {...field} value={field.value ?? \"\"} data-testid=\"input-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"flex justify-end gap-2\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setTaskDialogOpen(false)}>Cancel</Button>\n                <Button type=\"submit\" data-testid=\"button-submit-task\">\n                  {editingTask ? \"Update Task\" : \"Create Task\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Project Creation Dialog */}\n      <Dialog open={projectDialogOpen} onOpenChange={setProjectDialogOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Create New Project</DialogTitle>\n            <DialogDescription>\n              Create a new project and it will be automatically selected for your task\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...projectForm}>\n            <form onSubmit={projectForm.handleSubmit(onProjectSubmit)} className=\"space-y-4\">\n              <FormField\n                control={projectForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Project Name</FormLabel>\n                    <FormControl>\n                      <Input placeholder=\"Website Redesign\" {...field} data-testid=\"input-project-name\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={projectForm.control}\n                name=\"clientId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Client</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-project-client\">\n                          <SelectValue placeholder=\"Select client\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent position=\"popper\">\n                        {clients?.map((client) => (\n                          <SelectItem key={client.id} value={client.id}>\n                            {client.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"grid gap-4 md:grid-cols-2\">\n                <FormField\n                  control={projectForm.control}\n                  name=\"status\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Status</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-project-status\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent position=\"popper\">\n                          <SelectItem value=\"planning\">Planning</SelectItem>\n                          <SelectItem value=\"active\">Active</SelectItem>\n                          <SelectItem value=\"on-hold\">On Hold</SelectItem>\n                          <SelectItem value=\"completed\">Completed</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={projectForm.control}\n                  name=\"budget\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Budget</FormLabel>\n                      <FormControl>\n                        <Input type=\"number\" step=\"0.01\" placeholder=\"0.00\" {...field} value={field.value ?? \"\"} data-testid=\"input-project-budget\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={projectForm.control}\n                  name=\"deadline\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Deadline</FormLabel>\n                      <FormControl>\n                        <Input type=\"date\" {...field} value={field.value ?? \"\"} data-testid=\"input-project-deadline\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <FormField\n                control={projectForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea placeholder=\"Project details...\" {...field} value={field.value ?? \"\"} data-testid=\"input-project-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"flex justify-end gap-2\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setProjectDialogOpen(false)}>Cancel</Button>\n                <Button type=\"submit\" disabled={createProjectMutation.isPending} data-testid=\"button-submit-project\">\n                  {createProjectMutation.isPending ? \"Creating...\" : \"Create Project\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {!tasks || tasks.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-16\">\n            <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n              <Plus className=\"w-8 h-8 text-muted-foreground\" />\n            </div>\n            <h3 className=\"text-lg font-semibold mb-2\">No tasks yet</h3>\n            <p className=\"text-sm text-muted-foreground mb-4\">Create your first task</p>\n            <Button onClick={() => setTaskDialogOpen(true)}>Add Task</Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-3\">\n          {tasks.map((task) => (\n            <Card \n              key={task.id} \n              className=\"hover-elevate cursor-pointer\" \n              data-testid={`card-task-${task.id}`}\n              onClick={() => handleEdit(task)}\n            >\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-start gap-4\">\n                  <Checkbox \n                    className=\"mt-1\" \n                    data-testid={`checkbox-task-${task.id}`}\n                    onClick={(e) => e.stopPropagation()}\n                  />\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-start justify-between gap-2 flex-wrap mb-2\">\n                      <h3 className=\"font-semibold\" data-testid={`text-task-title-${task.id}`}>{task.title}</h3>\n                      <div className=\"flex items-center gap-2\">\n                        <Badge className={getPriorityColor(task.priority)} data-testid={`badge-priority-${task.id}`}>\n                          {task.priority}\n                        </Badge>\n                        <Badge className={getStatusColor(task.status)} data-testid={`badge-status-${task.id}`}>\n                          {task.status}\n                        </Badge>\n                      </div>\n                    </div>\n                    {task.description && (\n                      <p className=\"text-sm text-muted-foreground mb-2\">{task.description}</p>\n                    )}\n                    <div className=\"flex items-center gap-4 text-sm text-muted-foreground flex-wrap\">\n                      {task.assignedTo && (\n                        <div className=\"flex items-center gap-1\">\n                          <User className=\"w-4 h-4\" />\n                          <span>Assigned</span>\n                        </div>\n                      )}\n                      {task.deadline && (\n                        <div className=\"flex items-center gap-1\">\n                          <Calendar className=\"w-4 h-4\" />\n                          <span>{new Date(task.deadline).toLocaleDateString()}</span>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":24769,"size_tokens":null},"server/services/attendanceSync.ts":{"content":"/**\n * Attendance Device Sync Service\n * Synchronizes biometric device logs with the database\n * Automatically determines attendance status based on grace period\n */\n\nimport { db } from \"../db\";\nimport { \n  attendanceDevices, \n  deviceLogs, \n  attendance, \n  hrSettings, \n  employees \n} from \"@shared/schema\";\nimport { eq, and, gte, sql } from \"drizzle-orm\";\nimport { createDeviceAdapter, DeviceLog } from \"./deviceAdapters\";\nimport { toDateOnlyString } from \"@shared/date-utils\";\n\nclass AttendanceSyncService {\n  private isSyncing: boolean = false;\n  private syncEnabled: boolean = true;\n\n  /**\n   * Enable or disable device sync\n   */\n  setEnabled(enabled: boolean) {\n    this.syncEnabled = enabled;\n    console.log(`Attendance device sync ${enabled ? 'enabled' : 'disabled'}`);\n  }\n\n  /**\n   * Sync all active devices\n   */\n  async syncAllDevices(): Promise<void> {\n    if (this.isSyncing) {\n      console.log(\"Device sync already in progress, skipping...\");\n      return;\n    }\n\n    if (!this.syncEnabled) {\n      return;\n    }\n\n    this.isSyncing = true;\n\n    try {\n      // Get all active devices\n      const devices = await db\n        .select()\n        .from(attendanceDevices)\n        .where(eq(attendanceDevices.isActive, true));\n\n      if (devices.length === 0) {\n        return;\n      }\n\n      console.log(`Starting device sync for ${devices.length} active device(s)`);\n\n      let totalSynced = 0;\n      let totalErrors = 0;\n\n      // Process devices in parallel for better performance\n      const syncPromises = devices.map(async (device) => {\n        try {\n          const synced = await Promise.race([\n            this.syncDevice(device),\n            new Promise<number>((_, reject) => \n              setTimeout(() => reject(new Error('Device sync timeout (60s)')), 60000)\n            )\n          ]);\n          return { success: true, synced, deviceName: device.name };\n        } catch (error: any) {\n          console.error(`Error syncing device ${device.name}:`, error.message);\n          \n          // Update device with error (non-blocking)\n          await db\n            .update(attendanceDevices)\n            .set({ \n              lastSyncError: error.message,\n              lastSyncAt: new Date()\n            })\n            .where(eq(attendanceDevices.id, device.id));\n          \n          return { success: false, error: error.message, deviceName: device.name };\n        }\n      });\n\n      const results = await Promise.allSettled(syncPromises);\n      \n      results.forEach((result) => {\n        if (result.status === 'fulfilled') {\n          if (result.value.success && result.value.synced !== undefined) {\n            totalSynced += result.value.synced;\n          } else {\n            totalErrors++;\n          }\n        } else {\n          totalErrors++;\n        }\n      });\n\n      if (totalSynced > 0 || totalErrors > 0) {\n        console.log(`Device sync complete: ${totalSynced} logs synced, ${totalErrors} errors`);\n      }\n    } catch (error: any) {\n      console.error(\"Error in device sync:\", error.message);\n    } finally {\n      this.isSyncing = false;\n    }\n  }\n\n  /**\n   * Sync a single device\n   */\n  private async syncDevice(device: any): Promise<number> {\n    try {\n      // Create appropriate device adapter\n      const adapter = createDeviceAdapter(device.deviceType);\n      \n      // Connect to device\n      const connected = await adapter.connect({\n        id: device.id,\n        name: device.name,\n        ipAddress: device.ipAddress,\n        port: device.port,\n        apiKey: device.apiKey,\n        apiUrl: device.apiUrl,\n        ...(device.connectionParams || {}),\n      });\n\n      if (!connected) {\n        throw new Error(\"Failed to connect to device\");\n      }\n\n      // Fetch logs since last sync\n      const lastSyncTime = device.lastSyncAt ? new Date(device.lastSyncAt) : undefined;\n      const logs = await adapter.fetchLogs(lastSyncTime);\n\n      // Disconnect\n      await adapter.disconnect();\n\n      if (logs.length === 0) {\n        // Update last sync time even if no new logs\n        await db\n          .update(attendanceDevices)\n          .set({ \n            lastSyncAt: new Date(),\n            lastSyncError: null \n          })\n          .where(eq(attendanceDevices.id, device.id));\n        \n        return 0;\n      }\n\n      // Process and store logs\n      const storedCount = await this.processDeviceLogs(logs);\n\n      // Update device sync status\n      await db\n        .update(attendanceDevices)\n        .set({ \n          lastSyncAt: new Date(),\n          lastSyncError: null \n        })\n        .where(eq(attendanceDevices.id, device.id));\n\n      console.log(`Synced ${storedCount} logs from device: ${device.name}`);\n      return storedCount;\n    } catch (error: any) {\n      throw error;\n    }\n  }\n\n  /**\n   * Process and store device logs\n   * Avoids duplicates and creates attendance records\n   */\n  private async processDeviceLogs(logs: DeviceLog[]): Promise<number> {\n    let storedCount = 0;\n\n    for (const log of logs) {\n      try {\n        // Check for duplicate log (same device, employee, and punch time within 1 minute)\n        const oneMinuteBefore = new Date(log.punchTime.getTime() - 60000);\n        const oneMinuteAfter = new Date(log.punchTime.getTime() + 60000);\n\n        const [existing] = await db\n          .select()\n          .from(deviceLogs)\n          .where(\n            and(\n              eq(deviceLogs.deviceId, log.deviceId),\n              eq(deviceLogs.employeeId, log.employeeId),\n              gte(deviceLogs.punchTime, oneMinuteBefore),\n              sql`${deviceLogs.punchTime} <= ${oneMinuteAfter}`\n            )\n          )\n          .limit(1);\n\n        if (existing) {\n          console.log(`Skipping duplicate log for employee ${log.employeeId} at ${log.punchTime.toISOString()}`);\n          continue;\n        }\n\n        // Find employee by employeeId\n        const [employee] = await db\n          .select()\n          .from(employees)\n          .where(eq(employees.employeeId, log.employeeId))\n          .limit(1);\n\n        if (!employee) {\n          console.warn(`Employee not found for employeeId: ${log.employeeId}`);\n          continue;\n        }\n\n        // Store device log\n        const [storedLog] = await db.insert(deviceLogs).values({\n          deviceId: log.deviceId,\n          employeeId: log.employeeId,\n          punchTime: log.punchTime,\n          punchType: log.type,\n          rawData: log.raw || null,\n        }).returning();\n\n        // Process into attendance record\n        await this.processAttendanceFromLog(employee, log);\n\n        // Mark log as synced\n        await db.update(deviceLogs)\n          .set({ \n            synced: true,\n            syncedAt: new Date()\n          })\n          .where(eq(deviceLogs.id, storedLog.id));\n\n        storedCount++;\n      } catch (error: any) {\n        console.error(`Error processing device log:`, error.message);\n      }\n    }\n\n    return storedCount;\n  }\n\n  /**\n   * Create or update attendance record from device log\n   * Implements grace period logic and auto-status detection\n   */\n  private async processAttendanceFromLog(employee: any, log: DeviceLog): Promise<void> {\n    try {\n      const punchDate = new Date(log.punchTime);\n      const dateStr = toDateOnlyString(punchDate); // Timezone-safe YYYY-MM-DD\n\n      // Get HR settings for grace period and office hours\n      const [settings] = await db.select().from(hrSettings).limit(1);\n      \n      // Guard clause: If no HR settings exist, use defaults and create default settings\n      if (!settings) {\n        console.warn(\"No HR settings found, creating default settings\");\n        await db.insert(hrSettings).values({});\n      }\n      \n      const gracePeriodMinutes = settings?.gracePeriodMinutes || 15;\n      const officeStartTime = settings?.officeStartTime || \"09:00\";\n      \n      // Parse office start time\n      const [startHour, startMinute] = officeStartTime.split(\":\").map(Number);\n      const officeStart = new Date(punchDate);\n      officeStart.setHours(startHour, startMinute, 0, 0);\n      \n      // Grace period end time\n      const graceEnd = new Date(officeStart.getTime() + gracePeriodMinutes * 60000);\n\n      // Find or create attendance record for this date\n      const [existingAttendance] = await db\n        .select()\n        .from(attendance)\n        .where(\n          and(\n            eq(attendance.userId, employee.userId!),\n            sql`${attendance.date} = ${dateStr}`\n          )\n        )\n        .limit(1);\n\n      if (log.type === \"check-in\") {\n        // Determine if on-time or late\n        const isLate = punchDate > graceEnd;\n        const status = isLate ? \"late\" : \"present\";\n\n        if (existingAttendance) {\n          // Update check-in time if this is earlier\n          if (!existingAttendance.checkIn || new Date(existingAttendance.checkIn) > punchDate) {\n            await db\n              .update(attendance)\n              .set({ \n                checkIn: log.punchTime,\n                status: status\n              })\n              .where(eq(attendance.id, existingAttendance.id));\n          }\n        } else {\n          // Create new attendance record\n          await db.insert(attendance).values({\n            userId: employee.userId!,\n            date: dateStr,\n            checkIn: log.punchTime,\n            status: status,\n          });\n        }\n\n        console.log(`Processed check-in for ${employee.fullName}: ${status} at ${log.punchTime.toISOString()}`);\n      } else if (log.type === \"check-out\") {\n        if (existingAttendance) {\n          // Update check-out time if this is later\n          if (!existingAttendance.checkOut || new Date(existingAttendance.checkOut) < punchDate) {\n            await db\n              .update(attendance)\n              .set({ checkOut: log.punchTime })\n              .where(eq(attendance.id, existingAttendance.id));\n          }\n        } else {\n          // Create attendance with only check-out (unusual but possible)\n          await db.insert(attendance).values({\n            userId: employee.userId!,\n            date: dateStr,\n            checkOut: log.punchTime,\n            status: \"present\", // Default to present\n          });\n        }\n\n        console.log(`Processed check-out for ${employee.fullName} at ${log.punchTime.toISOString()}`);\n      }\n    } catch (error: any) {\n      console.error(`Error processing attendance from log:`, error.message);\n      throw error;\n    }\n  }\n\n  /**\n   * Manual sync trigger for a specific device\n   */\n  async syncDeviceById(deviceId: string): Promise<number> {\n    const [device] = await db\n      .select()\n      .from(attendanceDevices)\n      .where(eq(attendanceDevices.id, deviceId))\n      .limit(1);\n\n    if (!device) {\n      throw new Error(\"Device not found\");\n    }\n\n    if (!device.isActive) {\n      throw new Error(\"Device is not active\");\n    }\n\n    return this.syncDevice(device);\n  }\n\n  /**\n   * Test connection to a specific device\n   */\n  async testDeviceConnection(deviceId: string): Promise<boolean> {\n    const [device] = await db\n      .select()\n      .from(attendanceDevices)\n      .where(eq(attendanceDevices.id, deviceId))\n      .limit(1);\n\n    if (!device) {\n      throw new Error(\"Device not found\");\n    }\n\n    const adapter = createDeviceAdapter(device.deviceType);\n    \n    const connected = await adapter.connect({\n      id: device.id,\n      name: device.name,\n      ipAddress: device.ipAddress,\n      port: device.port,\n      apiKey: device.apiKey,\n      apiUrl: device.apiUrl,\n      ...(device.connectionParams || {}),\n    });\n\n    await adapter.disconnect();\n\n    return connected;\n  }\n}\n\nexport const attendanceSyncService = new AttendanceSyncService();\n","path":null,"size_bytes":11656,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"design_guidelines.md":{"content":"# Smart Agency Control Hub - Design Guidelines\n\n## Design Approach: Enterprise SaaS System\n\n**Selected Framework**: Hybrid approach drawing from Linear (modern SaaS aesthetics), Notion (flexible data organization), and Material Design (enterprise patterns)\n\n**Rationale**: This is a utility-focused, information-dense business management platform requiring efficiency, scalability, and professional polish. The design prioritizes data clarity, quick navigation, and productive workflows over visual flair.\n\n**Core Principles**:\n- Clarity over decoration: Every element serves a functional purpose\n- Consistent patterns: Users learn once, apply everywhere\n- Information hierarchy: Clear visual structure for complex data\n- Responsive efficiency: Mobile-capable, desktop-optimized\n\n---\n\n## Typography System\n\n**Font Stack**: \n- Primary: Inter (via Google Fonts CDN)\n- Monospace: JetBrains Mono (for code, IDs, timestamps)\n\n**Scale**:\n- Page Headers: text-3xl font-bold (30px)\n- Section Headers: text-2xl font-semibold (24px)\n- Card/Module Titles: text-lg font-semibold (18px)\n- Body Text: text-sm (14px) - primary interface text\n- Labels/Meta: text-xs (12px) - timestamps, badges, secondary info\n- Table Headers: text-xs font-medium uppercase tracking-wide\n\n---\n\n## Layout & Spacing System\n\n**Spacing Primitives**: Use Tailwind units of **2, 4, 6, 8, 12, 16, 24** for consistent rhythm\n- Component padding: p-4 to p-6\n- Card spacing: p-6\n- Section gaps: gap-6 to gap-8\n- Page margins: px-6 lg:px-8\n- Vertical rhythm: space-y-6 for form groups, space-y-4 for lists\n\n**Grid System**:\n- Dashboard cards: grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\n- Two-column layouts: grid-cols-1 lg:grid-cols-2 gap-8\n- Forms: Single column max-w-2xl for readability\n\n**Container Strategy**:\n- Full app: Fixed sidebar (w-64) + main content area\n- Main content: max-w-7xl mx-auto px-6\n- Modals/Forms: max-w-2xl or max-w-4xl depending on complexity\n\n---\n\n## Navigation Architecture\n\n**Top Bar** (h-16, sticky):\n- Logo/Company name (left)\n- Global search bar (center, max-w-md)\n- Notifications icon + User avatar dropdown (right)\n\n**Sidebar** (w-64, fixed left, full-height):\n- Module sections with icons (Heroicons)\n- Active state: background highlight + border-l-4 accent\n- Collapsible sub-menus for complex modules\n- Hierarchy: Dashboard  CRM  Projects  Team  Finance  Settings\n\n**Breadcrumbs**: \n- Below top bar: text-sm with separators ()\n- Click to navigate parent levels\n\n---\n\n## Component Library\n\n### Data Display Components\n\n**Cards**:\n- Background: distinct from page background\n- Border: subtle border\n- Rounded corners: rounded-lg\n- Padding: p-6\n- Shadow: subtle elevation (shadow-sm)\n- Header: flex justify-between items-center mb-4\n\n**Tables**:\n- Zebra striping for alternating rows\n- Hover state on rows\n- Sticky header when scrolling\n- Actions column (right-aligned)\n- Sortable column headers with icons\n- Pagination: bottom-right, showing \"1-10 of 245\"\n\n**Stat Cards** (Dashboard KPIs):\n- Icon (top-left, size-8)\n- Large number: text-3xl font-bold\n- Label: text-sm above number\n- Trend indicator: small arrow + percentage\n- Layout: 4-column grid on desktop\n\n**Charts**:\n- Use Chart.js or Recharts\n- Minimal grid lines\n- Clear axis labels\n- Tooltips on hover\n- Consistent sizing: h-64 to h-80\n\n### Input Components\n\n**Form Fields**:\n- Label: text-sm font-medium mb-2\n- Input: px-4 py-2, rounded-md, border\n- Focus state: ring-2 outline-none\n- Error state: border-red + text-red-600 error message below\n- Help text: text-xs text-gray-600 mt-1\n\n**Buttons**:\n- Primary: px-6 py-2.5, rounded-md, font-medium\n- Secondary: outlined variant\n- Icon buttons: square, p-2\n- Sizes: sm (py-1.5 px-3), base (py-2.5 px-6), lg (py-3 px-8)\n\n**Select/Dropdowns**:\n- Custom styled (not native)\n- Searchable for long lists\n- Multi-select with tags for assignment fields\n\n**Date/Time Pickers**:\n- Inline calendar dropdown\n- Time selection with AM/PM or 24h\n- Range selection for reports\n\n### Module-Specific Components\n\n**CRM Contact Cards**:\n- Avatar (left)\n- Name + role/company\n- Status badge (Lead/Client/Active)\n- Action buttons (call, email, WhatsApp icons)\n- Last contact timestamp\n\n**Project Cards**:\n- Project name + client\n- Progress bar (completion %)\n- Deadline badge\n- Assigned team avatars (stacked, max 3 visible + count)\n- Status indicator (Planning/Active/Review/Completed)\n\n**Task Lists**:\n- Checkbox (left)\n- Task title (strikethrough when complete)\n- Priority tag (High/Medium/Low)\n- Assignee avatar\n- Due date\n- Expand for checklist sub-items\n\n**Attendance Table**:\n- User column with avatar\n- Check-in/Check-out times (monospace font)\n- Status badges (On-time/Late/Absent)\n- Late count column\n- Monthly view: calendar grid with color-coded cells\n\n**Invoice Layout**:\n- Company header with logo\n- Invoice # and date (top-right)\n- Bill to/From sections\n- Line items table\n- Subtotal/Tax/Total (right-aligned)\n- Payment status banner\n- Action buttons (Send, Download PDF, Mark Paid)\n\n**Chat Interface**:\n- Message bubbles (sent: right-aligned, received: left)\n- Timestamps: text-xs below messages\n- Input: fixed bottom with send button\n- File attachment icon\n- Project context header (sticky top)\n\n### Navigation Components\n\n**Tabs**:\n- Horizontal: border-b, active tab with border-b-2\n- Used for: Project details (Overview/Tasks/Files/Chat)\n\n**Filters Panel**:\n- Sidebar or collapsible panel\n- Filter groups: Status, Date range, Assigned to, Priority\n- Clear all button\n- Active filter count badge\n\n### Feedback Components\n\n**Badges**:\n- Rounded-full, px-3 py-1, text-xs font-medium\n- Status variations: Success/Warning/Error/Info\n- Count badges: small circle on icons\n\n**Notifications**:\n- Toast: Fixed top-right, auto-dismiss\n- Bell icon dropdown: scrollable list, max-h-96\n- Unread indicator: dot or count badge\n\n**Empty States**:\n- Centered icon (size-16)\n- Title: text-lg font-semibold\n- Description: text-sm\n- Primary action button\n\n**Loading States**:\n- Skeleton screens for cards/tables\n- Spinner for buttons (inline, small)\n- Progress bar for uploads\n\n### Modals & Overlays\n\n**Modal Structure**:\n- Backdrop: semi-transparent overlay\n- Content: max-w-2xl, centered, rounded-lg\n- Header: title + close icon (right)\n- Body: p-6, scrollable if needed\n- Footer: action buttons (right-aligned)\n\n**Slide-over Panels** (for quick actions):\n- Fixed right, w-96 to w-[32rem]\n- Form inputs or detail views\n- Close on backdrop click\n\n---\n\n## Dashboard Layout\n\n**Main Dashboard**:\n- KPI cards row: 4-column grid (Total Leads, Active Projects, Team Attendance %, Monthly Revenue)\n- Charts row: 2-column (Revenue vs Expense chart, Task completion chart)\n- Recent activity feed: 1-column, scrollable\n- Quick actions: Floating action button (bottom-right) for common tasks\n\n---\n\n## Responsive Behavior\n\n**Breakpoints**:\n- Mobile: Stack all grids to single column, hide sidebar (drawer)\n- Tablet: 2-column grids, collapsible sidebar\n- Desktop: Full layout with fixed sidebar\n\n**Mobile Adjustments**:\n- Bottom navigation for main modules\n- Tables: Horizontal scroll or card view\n- Modals: Full screen on mobile\n- Reduced padding: p-4 instead of p-6\n\n---\n\n## Icons\n\n**Library**: Heroicons (via CDN)\n- Navigation: outline style\n- Actions: solid style in buttons\n- Status indicators: mini size for badges\n\n---\n\n## Accessibility\n\n- Focus indicators: visible ring-2 on all interactive elements\n- ARIA labels on icon-only buttons\n- Keyboard navigation: Tab order, Enter/Space activation\n- Form validation: Clear error messages\n- Sufficient contrast ratios (WCAG AA minimum)","path":null,"size_bytes":7588,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"server/utils/serialize.ts":{"content":"/**\n * Response Serialization Utilities\n * \n * Ensures consistent date serialization in API responses\n * Converts JavaScript Date objects to ISO strings\n */\n\nimport { toDateTimeString, toDateOnlyString } from \"@shared/date-utils\";\n\n/**\n * Fields that should be serialized as date-only strings (YYYY-MM-DD)\n */\nconst DATE_ONLY_FIELDS = new Set([\n  \"followUpDate\",\n  \"deadline\",\n  \"dueDate\",\n  \"date\", // for attendance, income, expenses\n  \"sentDate\",\n  \"joiningDate\", // employees\n  \"dateOfBirth\", // employees\n  \"startDate\", // leave_requests\n  \"endDate\", // leave_requests\n  \"effectiveFrom\", // salary_structure\n]);\n\n/**\n * Fields that should be serialized as datetime strings\n */\nconst DATE_TIME_FIELDS = new Set([\n  \"createdAt\",\n  \"checkIn\",\n  \"checkOut\",\n  \"paymentDate\",\n  \"lastFollowUpReminderAt\",\n  \"lastReminderSentAt\",\n  \"lastSyncAt\", // attendance_devices\n  \"punchTime\", // device_logs\n  \"syncedAt\", // device_logs\n  \"approvedAt\", // leave_requests, punch_corrections\n  \"requestedCheckIn\", // punch_corrections\n  \"requestedCheckOut\", // punch_corrections\n  \"paidAt\", // payroll\n  \"generatedAt\", // salary_slips\n  \"emailedAt\", // salary_slips\n  \"updatedAt\", // hr_settings\n]);\n\n/**\n * Serializes a single record by converting Date fields to ISO strings\n * Recursively processes nested objects and arrays\n * @param record - Database record with potential Date fields\n * @returns Serialized record with string dates\n */\nexport function serializeRecord<T extends Record<string, any>>(record: T): T {\n  if (!record) return record;\n\n  const serialized: any = { ...record };\n\n  for (const [key, value] of Object.entries(serialized)) {\n    if (value === null || value === undefined) {\n      // Keep null/undefined as-is\n      serialized[key] = value;\n    } else if (value instanceof Date) {\n      // Check if this field should be date-only or datetime\n      if (DATE_ONLY_FIELDS.has(key)) {\n        serialized[key] = toDateOnlyString(value);\n      } else if (DATE_TIME_FIELDS.has(key)) {\n        serialized[key] = toDateTimeString(value);\n      } else {\n        // Default to datetime for unknown date fields\n        serialized[key] = toDateTimeString(value);\n      }\n    } else if (Array.isArray(value)) {\n      // Recursively serialize array items\n      serialized[key] = value.map(item => {\n        if (item && typeof item === 'object' && !(item instanceof Date)) {\n          return serializeRecord(item);\n        }\n        return item;\n      });\n    } else if (typeof value === 'object') {\n      // Recursively serialize nested objects\n      serialized[key] = serializeRecord(value);\n    }\n  }\n\n  return serialized as T;\n}\n\n/**\n * Serializes an array of records\n * @param records - Array of database records\n * @returns Array of serialized records\n */\nexport function serializeRecords<T extends Record<string, any>>(records: T[]): T[] {\n  return records.map(serializeRecord);\n}\n\n/**\n * Deep serializes any value, including nested objects and arrays\n * Uses explicit field name mapping to determine date vs datetime format\n * Recursively uses serializeRecord for nested objects to preserve field context\n * @param value - Any value to serialize\n * @returns Serialized value with Date objects converted to strings\n */\nfunction deepSerialize(value: any): any {\n  if (value === null || value === undefined) {\n    return value;\n  }\n\n  if (value instanceof Date) {\n    // Default to datetime for loose Date objects (no field context)\n    return toDateTimeString(value);\n  }\n\n  if (Array.isArray(value)) {\n    return value.map(item => {\n      // For arrays of objects (records), use serializeRecord to preserve field context\n      if (item && typeof item === 'object' && !(item instanceof Date)) {\n        return serializeRecord(item);\n      }\n      return deepSerialize(item);\n    });\n  }\n\n  if (typeof value === 'object') {\n    // Check if this looks like a data record (has date fields we care about)\n    const hasKnownDateFields = Object.keys(value).some(key => \n      DATE_ONLY_FIELDS.has(key) || DATE_TIME_FIELDS.has(key)\n    );\n\n    if (hasKnownDateFields) {\n      // Use serializeRecord to preserve field-specific date handling\n      return serializeRecord(value);\n    }\n\n    // For wrapper objects without known date fields, serialize values recursively\n    const serialized: any = {};\n    for (const [key, val] of Object.entries(value)) {\n      serialized[key] = deepSerialize(val);\n    }\n    return serialized;\n  }\n\n  return value;\n}\n\n/**\n * Express middleware to automatically serialize response data\n * Wraps res.json to serialize dates before sending\n * Handles nested objects, arrays, and success/error wrappers\n */\nexport function serializeResponseMiddleware(req: any, res: any, next: any) {\n  const originalJson = res.json.bind(res);\n\n  res.json = function (data: any) {\n    const serialized = deepSerialize(data);\n    return originalJson(serialized);\n  };\n\n  next();\n}\n","path":null,"size_bytes":4886,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/pages/payments.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Plus, Edit, Trash2, CreditCard, DollarSign, Calendar, FileText, Search } from \"lucide-react\";\nimport { format } from \"date-fns\";\n\ntype Payment = {\n  id: string;\n  invoiceId: string;\n  amount: string;\n  paymentDate: string;\n  paymentMethod: string;\n  notes?: string;\n  createdAt: string;\n};\n\ntype Invoice = {\n  id: string;\n  invoiceNumber: string;\n  clientId: string;\n  amount: string;\n  dueDate: string;\n  status: string;\n};\n\nconst paymentSchema = z.object({\n  invoiceId: z.string().min(1, \"Invoice is required\"),\n  amount: z.string().min(1, \"Amount is required\").regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid amount format\"),\n  paymentDate: z.string().min(1, \"Payment date is required\"),\n  paymentMethod: z.enum([\"cash\", \"bank_transfer\", \"check\", \"credit_card\", \"debit_card\", \"mobile_payment\", \"other\"]),\n  notes: z.string().optional(),\n});\n\ntype PaymentFormData = z.infer<typeof paymentSchema>;\n\nconst paymentMethodLabels: Record<string, string> = {\n  cash: \"Cash\",\n  bank_transfer: \"Bank Transfer\",\n  check: \"Check\",\n  credit_card: \"Credit Card\",\n  debit_card: \"Debit Card\",\n  mobile_payment: \"Mobile Payment\",\n  other: \"Other\",\n};\n\nexport default function Payments() {\n  const { toast } = useToast();\n  const [createOpen, setCreateOpen] = useState(false);\n  const [editOpen, setEditOpen] = useState(false);\n  const [editingPayment, setEditingPayment] = useState<Payment | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const { data: payments, isLoading } = useQuery<Payment[]>({\n    queryKey: [\"/api/payments\"],\n  });\n\n  const { data: invoices } = useQuery<Invoice[]>({\n    queryKey: [\"/api/invoices\"],\n  });\n\n  const createForm = useForm<PaymentFormData>({\n    resolver: zodResolver(paymentSchema),\n    defaultValues: {\n      invoiceId: \"\",\n      amount: \"\",\n      paymentDate: new Date().toISOString().split('T')[0],\n      paymentMethod: \"bank_transfer\",\n      notes: \"\",\n    },\n  });\n\n  const editForm = useForm<PaymentFormData>({\n    resolver: zodResolver(paymentSchema),\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: PaymentFormData) => apiRequest(\"POST\", \"/api/payments\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payments\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/invoices\"] });\n      setCreateOpen(false);\n      createForm.reset();\n      toast({ title: \"Success\", description: \"Payment recorded successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: (data: { id: string; updates: Partial<PaymentFormData> }) =>\n      apiRequest(\"PATCH\", `/api/payments/${data.id}`, data.updates),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payments\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/invoices\"] });\n      setEditOpen(false);\n      setEditingPayment(null);\n      toast({ title: \"Success\", description: \"Payment updated successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/payments/${id}`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payments\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/invoices\"] });\n      toast({ title: \"Success\", description: \"Payment deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onCreateSubmit = (data: PaymentFormData) => {\n    createMutation.mutate(data);\n  };\n\n  const onEditSubmit = (data: PaymentFormData) => {\n    if (!editingPayment) return;\n    updateMutation.mutate({ id: editingPayment.id, updates: data });\n  };\n\n  const handleEdit = (payment: Payment) => {\n    setEditingPayment(payment);\n    editForm.reset({\n      invoiceId: payment.invoiceId,\n      amount: payment.amount,\n      paymentDate: payment.paymentDate.split('T')[0],\n      paymentMethod: payment.paymentMethod as any,\n      notes: payment.notes || \"\",\n    });\n    setEditOpen(true);\n  };\n\n  const handleDelete = (payment: Payment) => {\n    if (confirm(`Are you sure you want to delete this payment of ${payment.amount}?`)) {\n      deleteMutation.mutate(payment.id);\n    }\n  };\n\n  const getInvoiceInfo = (invoiceId: string) => {\n    return invoices?.find(inv => inv.id === invoiceId);\n  };\n\n  const filteredPayments = payments?.filter(payment => {\n    const invoice = getInvoiceInfo(payment.invoiceId);\n    const searchLower = searchQuery.toLowerCase();\n    return (\n      payment.amount.includes(searchLower) ||\n      payment.paymentMethod.toLowerCase().includes(searchLower) ||\n      invoice?.invoiceNumber.toLowerCase().includes(searchLower) ||\n      (payment.notes && payment.notes.toLowerCase().includes(searchLower))\n    );\n  }) || [];\n\n  const totalAmount = filteredPayments.reduce((sum, p) => sum + parseFloat(p.amount), 0);\n\n  return (\n    <div className=\"h-full overflow-auto\">\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n          <div>\n            <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Payments</h1>\n            <p className=\"text-muted-foreground\">Track and manage payment transactions</p>\n          </div>\n          <Dialog open={createOpen} onOpenChange={setCreateOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-create-payment\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Record Payment\n              </Button>\n            </DialogTrigger>\n            <DialogContent data-testid=\"dialog-create-payment\">\n              <DialogHeader>\n                <DialogTitle>Record New Payment</DialogTitle>\n              </DialogHeader>\n              <Form {...createForm}>\n                <form onSubmit={createForm.handleSubmit(onCreateSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={createForm.control}\n                    name=\"invoiceId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Invoice</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-invoiceId\">\n                              <SelectValue placeholder=\"Select invoice\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            {invoices?.map((invoice) => (\n                              <SelectItem key={invoice.id} value={invoice.id}>\n                                {invoice.invoiceNumber} - {invoice.amount}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={createForm.control}\n                    name=\"amount\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Amount</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-amount\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={createForm.control}\n                    name=\"paymentDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Payment Date</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"date\" data-testid=\"input-paymentDate\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={createForm.control}\n                    name=\"paymentMethod\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Payment Method</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-paymentMethod\">\n                              <SelectValue />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            <SelectItem value=\"bank_transfer\">Bank Transfer</SelectItem>\n                            <SelectItem value=\"cash\">Cash</SelectItem>\n                            <SelectItem value=\"check\">Check</SelectItem>\n                            <SelectItem value=\"credit_card\">Credit Card</SelectItem>\n                            <SelectItem value=\"debit_card\">Debit Card</SelectItem>\n                            <SelectItem value=\"mobile_payment\">Mobile Payment</SelectItem>\n                            <SelectItem value=\"other\">Other</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={createForm.control}\n                    name=\"notes\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Notes (Optional)</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} placeholder=\"Payment notes...\" data-testid=\"input-notes\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <div className=\"flex gap-2 justify-end\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setCreateOpen(false)} data-testid=\"button-cancel-create\">\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit-create\">\n                      {createMutation.isPending ? \"Recording...\" : \"Record Payment\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        {/* Stats Cards */}\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Payments</CardTitle>\n              <FileText className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-total-payments\">{payments?.length || 0}</div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Amount</CardTitle>\n              <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-total-amount\">{totalAmount.toFixed(2)}</div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">This Month</CardTitle>\n              <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-month-amount\">\n                {payments?.filter(p => {\n                  const paymentMonth = new Date(p.paymentDate).getMonth();\n                  const currentMonth = new Date().getMonth();\n                  return paymentMonth === currentMonth;\n                }).reduce((sum, p) => sum + parseFloat(p.amount), 0).toFixed(2) || '0.00'}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Search */}\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search by amount, invoice, method, or notes...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search\"\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Payments List */}\n        <div className=\"grid gap-4\">\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Loading payments...\n            </div>\n          ) : filteredPayments.length === 0 ? (\n            <Card>\n              <CardContent className=\"pt-6 text-center text-muted-foreground\">\n                No payments found\n              </CardContent>\n            </Card>\n          ) : (\n            filteredPayments.map((payment) => {\n              const invoice = getInvoiceInfo(payment.invoiceId);\n              return (\n                <Card key={payment.id} data-testid={`card-payment-${payment.id}`} className=\"hover-elevate\">\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n                      <div className=\"flex-1 space-y-2 min-w-0\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <CreditCard className=\"w-5 h-5 text-muted-foreground\" />\n                          <span className=\"font-semibold text-lg\" data-testid={`text-payment-amount-${payment.id}`}>\n                            {parseFloat(payment.amount).toFixed(2)}\n                          </span>\n                          <Badge variant=\"outline\" data-testid={`badge-method-${payment.id}`}>\n                            {paymentMethodLabels[payment.paymentMethod]}\n                          </Badge>\n                        </div>\n                        \n                        <div className=\"space-y-1 text-sm\">\n                          <div className=\"flex items-center gap-2 text-muted-foreground\">\n                            <FileText className=\"w-4 h-4\" />\n                            <span>Invoice: {invoice?.invoiceNumber || 'Unknown'}</span>\n                          </div>\n                          <div className=\"flex items-center gap-2 text-muted-foreground\">\n                            <Calendar className=\"w-4 h-4\" />\n                            <span data-testid={`text-payment-date-${payment.id}`}>\n                              {format(new Date(payment.paymentDate), 'MMM dd, yyyy')}\n                            </span>\n                          </div>\n                          {payment.notes && (\n                            <p className=\"text-muted-foreground italic\" data-testid={`text-payment-notes-${payment.id}`}>\n                              {payment.notes}\n                            </p>\n                          )}\n                        </div>\n                      </div>\n                      \n                      <div className=\"flex gap-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleEdit(payment)}\n                          data-testid={`button-edit-${payment.id}`}\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => handleDelete(payment)}\n                          data-testid={`button-delete-${payment.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })\n          )}\n        </div>\n\n        {/* Edit Dialog */}\n        <Dialog open={editOpen} onOpenChange={setEditOpen}>\n          <DialogContent data-testid=\"dialog-edit-payment\">\n            <DialogHeader>\n              <DialogTitle>Edit Payment</DialogTitle>\n            </DialogHeader>\n            <Form {...editForm}>\n              <form onSubmit={editForm.handleSubmit(onEditSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={editForm.control}\n                  name=\"invoiceId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Invoice</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-edit-invoiceId\">\n                            <SelectValue placeholder=\"Select invoice\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent position=\"popper\">\n                          {invoices?.map((invoice) => (\n                            <SelectItem key={invoice.id} value={invoice.id}>\n                              {invoice.invoiceNumber} - {invoice.amount}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"amount\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Amount</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"number\" step=\"0.01\" data-testid=\"input-edit-amount\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"paymentDate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Payment Date</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"date\" data-testid=\"input-edit-paymentDate\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"paymentMethod\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Payment Method</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-edit-paymentMethod\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent position=\"popper\">\n                          <SelectItem value=\"bank_transfer\">Bank Transfer</SelectItem>\n                          <SelectItem value=\"cash\">Cash</SelectItem>\n                          <SelectItem value=\"check\">Check</SelectItem>\n                          <SelectItem value=\"credit_card\">Credit Card</SelectItem>\n                          <SelectItem value=\"debit_card\">Debit Card</SelectItem>\n                          <SelectItem value=\"mobile_payment\">Mobile Payment</SelectItem>\n                          <SelectItem value=\"other\">Other</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Notes (Optional)</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} data-testid=\"input-edit-notes\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"flex gap-2 justify-end\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setEditOpen(false)} data-testid=\"button-cancel-edit\">\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-submit-edit\">\n                    {updateMutation.isPending ? \"Updating...\" : \"Update Payment\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":22882,"size_tokens":null},"client/src/pages/team.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { UserPlus, Edit, Trash2, Users, Mail, Shield, Search } from \"lucide-react\";\n\ntype User = {\n  id: string;\n  email: string;\n  fullName: string;\n  role: string;\n  clientId?: string;\n  createdAt: string;\n};\n\ntype Client = {\n  id: string;\n  name: string;\n  email: string;\n};\n\nconst userSchema = z.object({\n  fullName: z.string().min(1, \"Full name is required\"),\n  email: z.string().email(\"Invalid email address\"),\n  role: z.enum([\"admin\", \"operational_head\", \"developer\", \"client\"]),\n  clientId: z.string().optional(),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n}).refine(\n  (data) => {\n    // If role is client, clientId must be provided\n    if (data.role === \"client\") {\n      return !!data.clientId;\n    }\n    return true;\n  },\n  {\n    message: \"Client must be selected for client role\",\n    path: [\"clientId\"],\n  }\n);\n\nconst updateUserSchema = z.object({\n  fullName: z.string().min(1, \"Full name is required\"),\n  email: z.string().email(\"Invalid email address\"),\n  role: z.enum([\"admin\", \"operational_head\", \"developer\", \"client\"]),\n  clientId: z.string().optional(),\n  password: z.string().optional(),\n});\n\ntype UserFormData = z.infer<typeof userSchema>;\ntype UpdateUserFormData = z.infer<typeof updateUserSchema>;\n\nconst roleColors: Record<string, string> = {\n  admin: \"bg-red-500/10 text-red-700 dark:text-red-400\",\n  operational_head: \"bg-blue-500/10 text-blue-700 dark:text-blue-400\",\n  developer: \"bg-green-500/10 text-green-700 dark:text-green-400\",\n  client: \"bg-purple-500/10 text-purple-700 dark:text-purple-400\",\n};\n\nconst roleLabels: Record<string, string> = {\n  admin: \"Admin\",\n  operational_head: \"Operational Head\",\n  developer: \"Developer\",\n  client: \"Client\",\n};\n\nexport default function Team() {\n  const { toast } = useToast();\n  const [createOpen, setCreateOpen] = useState(false);\n  const [editOpen, setEditOpen] = useState(false);\n  const [editingUser, setEditingUser] = useState<User | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [roleFilter, setRoleFilter] = useState<string>(\"all\");\n\n  const { data: users, isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const createForm = useForm<UserFormData>({\n    resolver: zodResolver(userSchema),\n    defaultValues: {\n      fullName: \"\",\n      email: \"\",\n      role: \"developer\",\n      password: \"\",\n    },\n  });\n\n  const editForm = useForm<UpdateUserFormData>({\n    resolver: zodResolver(updateUserSchema),\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: UserFormData) => {\n      return apiRequest(\"POST\", \"/api/users\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setCreateOpen(false);\n      createForm.reset();\n      toast({ title: \"Success\", description: \"User created successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: (data: { id: string; updates: Partial<UpdateUserFormData> }) =>\n      apiRequest(\"PATCH\", `/api/users/${data.id}`, data.updates),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setEditOpen(false);\n      setEditingUser(null);\n      toast({ title: \"Success\", description: \"User updated successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/users/${id}`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      toast({ title: \"Success\", description: \"User deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onCreateSubmit = (data: UserFormData) => {\n    createMutation.mutate(data);\n  };\n\n  const onEditSubmit = (data: UpdateUserFormData) => {\n    if (!editingUser) return;\n    const updates: Partial<UpdateUserFormData> = {};\n    \n    if (data.fullName !== editingUser.fullName) updates.fullName = data.fullName;\n    if (data.email !== editingUser.email) updates.email = data.email;\n    if (data.role !== editingUser.role) updates.role = data.role;\n    if (data.clientId !== editingUser.clientId) updates.clientId = data.clientId;\n    if (data.password) updates.password = data.password;\n\n    updateMutation.mutate({ id: editingUser.id, updates });\n  };\n\n  const handleEdit = (user: User) => {\n    setEditingUser(user);\n    editForm.reset({\n      fullName: user.fullName,\n      email: user.email,\n      role: user.role as any,\n      clientId: user.clientId || undefined,\n      password: \"\",\n    });\n    setEditOpen(true);\n  };\n\n  const handleDelete = (user: User) => {\n    if (confirm(`Are you sure you want to delete ${user.fullName}? This action cannot be undone.`)) {\n      deleteMutation.mutate(user.id);\n    }\n  };\n\n  const filteredUsers = users?.filter(user => {\n    const matchesSearch = user.fullName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n                         user.email.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesRole = roleFilter === \"all\" || user.role === roleFilter;\n    return matchesSearch && matchesRole;\n  }) || [];\n\n  const roleStats = users?.reduce((acc, user) => {\n    acc[user.role] = (acc[user.role] || 0) + 1;\n    return acc;\n  }, {} as Record<string, number>);\n\n  return (\n    <div className=\"h-full overflow-auto\">\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n          <div>\n            <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Team Management</h1>\n            <p className=\"text-muted-foreground\">Manage your team members and their roles</p>\n          </div>\n          <Dialog open={createOpen} onOpenChange={setCreateOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-create-user\">\n                <UserPlus className=\"w-4 h-4 mr-2\" />\n                Add Team Member\n              </Button>\n            </DialogTrigger>\n            <DialogContent data-testid=\"dialog-create-user\">\n              <DialogHeader>\n                <DialogTitle>Add New Team Member</DialogTitle>\n              </DialogHeader>\n              <Form {...createForm}>\n                <form onSubmit={createForm.handleSubmit(onCreateSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={createForm.control}\n                    name=\"fullName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Full Name</FormLabel>\n                        <FormControl>\n                          <Input {...field} data-testid=\"input-fullName\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={createForm.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"email\" data-testid=\"input-email\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={createForm.control}\n                    name=\"password\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Password</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"password\" data-testid=\"input-password\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={createForm.control}\n                    name=\"role\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Role</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-role\">\n                              <SelectValue />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            <SelectItem value=\"admin\">Admin</SelectItem>\n                            <SelectItem value=\"operational_head\">Operational Head</SelectItem>\n                            <SelectItem value=\"developer\">Developer</SelectItem>\n                            <SelectItem value=\"client\">Client</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  {createForm.watch(\"role\") === \"client\" && (\n                    <FormField\n                      control={createForm.control}\n                      name=\"clientId\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Client</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-clientId\">\n                                <SelectValue placeholder=\"Select client\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent position=\"popper\">\n                              {clients?.map((client) => (\n                                <SelectItem key={client.id} value={client.id}>\n                                  {client.name}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  )}\n                  <div className=\"flex gap-2 justify-end\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setCreateOpen(false)} data-testid=\"button-cancel-create\">\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit-create\">\n                      {createMutation.isPending ? \"Creating...\" : \"Create User\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        {/* Stats Cards */}\n        <div className=\"grid gap-4 md:grid-cols-4\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Users</CardTitle>\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-total-users\">{users?.length || 0}</div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Admins</CardTitle>\n              <Shield className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-admin-count\">{roleStats?.admin || 0}</div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Developers</CardTitle>\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-developer-count\">{roleStats?.developer || 0}</div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Clients</CardTitle>\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-client-count\">{roleStats?.client || 0}</div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Filters */}\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex gap-4 flex-wrap\">\n              <div className=\"flex-1 min-w-[200px]\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search by name or email...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-search\"\n                  />\n                </div>\n              </div>\n              <Select value={roleFilter} onValueChange={setRoleFilter}>\n                <SelectTrigger className=\"w-[180px]\" data-testid=\"select-role-filter\">\n                  <SelectValue placeholder=\"Filter by role\" />\n                </SelectTrigger>\n                <SelectContent position=\"popper\">\n                  <SelectItem value=\"all\">All Roles</SelectItem>\n                  <SelectItem value=\"admin\">Admin</SelectItem>\n                  <SelectItem value=\"operational_head\">Operational Head</SelectItem>\n                  <SelectItem value=\"developer\">Developer</SelectItem>\n                  <SelectItem value=\"client\">Client</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Users List */}\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {isLoading ? (\n            <div className=\"col-span-full text-center py-8 text-muted-foreground\">\n              Loading users...\n            </div>\n          ) : filteredUsers.length === 0 ? (\n            <div className=\"col-span-full text-center py-8 text-muted-foreground\">\n              No users found\n            </div>\n          ) : (\n            filteredUsers.map((user) => (\n              <Card key={user.id} data-testid={`card-user-${user.id}`} className=\"hover-elevate\">\n                <CardHeader>\n                  <div className=\"flex items-start justify-between gap-2\">\n                    <div className=\"space-y-1 flex-1 min-w-0\">\n                      <CardTitle className=\"text-lg truncate\" data-testid={`text-user-name-${user.id}`}>\n                        {user.fullName}\n                      </CardTitle>\n                      <Badge className={roleColors[user.role]} data-testid={`badge-role-${user.id}`}>\n                        {roleLabels[user.role]}\n                      </Badge>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <Mail className=\"w-4 h-4\" />\n                      <span className=\"truncate\" data-testid={`text-user-email-${user.id}`}>{user.email}</span>\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      Joined {new Date(user.createdAt).toLocaleDateString()}\n                    </div>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => handleEdit(user)}\n                      className=\"flex-1\"\n                      data-testid={`button-edit-${user.id}`}\n                    >\n                      <Edit className=\"w-4 h-4 mr-1\" />\n                      Edit\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant=\"ghost\"\n                      onClick={() => handleDelete(user)}\n                      data-testid={`button-delete-${user.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ))\n          )}\n        </div>\n\n        {/* Edit Dialog */}\n        <Dialog open={editOpen} onOpenChange={setEditOpen}>\n          <DialogContent data-testid=\"dialog-edit-user\">\n            <DialogHeader>\n              <DialogTitle>Edit Team Member</DialogTitle>\n            </DialogHeader>\n            <Form {...editForm}>\n              <form onSubmit={editForm.handleSubmit(onEditSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={editForm.control}\n                  name=\"fullName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Full Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} data-testid=\"input-edit-fullName\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"email\" data-testid=\"input-edit-email\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"password\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Password (leave blank to keep current)</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"password\" placeholder=\"Enter new password\" data-testid=\"input-edit-password\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"role\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Role</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-edit-role\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent position=\"popper\">\n                          <SelectItem value=\"admin\">Admin</SelectItem>\n                          <SelectItem value=\"operational_head\">Operational Head</SelectItem>\n                          <SelectItem value=\"developer\">Developer</SelectItem>\n                          <SelectItem value=\"client\">Client</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                {editForm.watch(\"role\") === \"client\" && (\n                  <FormField\n                    control={editForm.control}\n                    name=\"clientId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Client</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-edit-clientId\">\n                              <SelectValue placeholder=\"Select client\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            {clients?.map((client) => (\n                              <SelectItem key={client.id} value={client.id}>\n                                {client.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                )}\n                <div className=\"flex gap-2 justify-end\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setEditOpen(false)} data-testid=\"button-cancel-edit\">\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-submit-edit\">\n                    {updateMutation.isPending ? \"Updating...\" : \"Update User\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":23082,"size_tokens":null},"client/src/lib/websocket.ts":{"content":"/**\n * Centralized WebSocket URL construction for consistent connections\n * across the application (chat, notifications, etc.)\n */\n\nexport function getWebSocketUrl(): string {\n  const token = localStorage.getItem(\"token\");\n  if (!token) {\n    throw new Error(\"No authentication token found\");\n  }\n\n  // Use window.location.origin and swap http/https protocol to ws/wss\n  // This works correctly in both development and production environments\n  const origin = window.location.origin;\n  const wsOrigin = origin.replace(/^http/, 'ws');\n  \n  // Construct WebSocket URL with authentication token\n  const wsUrl = `${wsOrigin}/ws?token=${encodeURIComponent(token)}`;\n  \n  // Log connection attempt without exposing the token\n  console.log(`WebSocket: Connecting to ${wsOrigin}/ws`);\n  return wsUrl;\n}\n","path":null,"size_bytes":795,"size_tokens":null},"server/services/notification.ts":{"content":"import { db } from \"../db\";\nimport { notifications, users, projects, tasks } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport { wsService } from \"../websocket\";\n\nexport class NotificationService {\n  /**\n   * Create a notification for a user\n   */\n  private async createNotification(userId: string, type: string, message: string, projectId?: string) {\n    try {\n      const [notification] = await db.insert(notifications).values({\n        userId,\n        type,\n        message,\n        projectId: projectId || null,\n      }).returning();\n\n      // Broadcast the notification via WebSocket\n      wsService.broadcastNotification(userId, notification);\n\n      console.log(`Created notification for user ${userId}: ${message}`);\n      return notification;\n    } catch (error) {\n      console.error(\"Error creating notification:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get all users who should be notified for a project\n   * Excludes the sender\n   */\n  private async getProjectNotificationRecipients(projectId: string, senderId: string) {\n    try {\n      // Get the project details\n      const [project] = await db.select().from(projects).where(eq(projects.id, projectId)).limit(1);\n      if (!project) {\n        return [];\n      }\n\n      const recipientSet = new Set<string>();\n\n      // Add project owner (client/buyer) if not the sender\n      if (project.clientId) {\n        const [clientUser] = await db.select().from(users).where(eq(users.clientId, project.clientId)).limit(1);\n        if (clientUser && clientUser.id !== senderId) {\n          recipientSet.add(clientUser.id);\n        }\n      }\n\n      // Add project creator (usually admin/operational head) if not the sender\n      if (project.createdBy && project.createdBy !== senderId) {\n        recipientSet.add(project.createdBy);\n      }\n\n      // Add all developers assigned to tasks in this project (excluding sender)\n      const projectTasks = await db.select().from(tasks).where(eq(tasks.projectId, projectId));\n      for (const task of projectTasks) {\n        if (task.assignedTo && task.assignedTo !== senderId) {\n          recipientSet.add(task.assignedTo);\n        }\n      }\n\n      // Convert Set to Array to remove duplicates\n      return Array.from(recipientSet);\n    } catch (error) {\n      console.error(\"Error getting notification recipients:\", error);\n      return [];\n    }\n  }\n\n  /**\n   * Notify users when a new chat message is sent\n   */\n  async notifyNewMessage(projectId: string, senderId: string, messageContent: string) {\n    try {\n      const recipients = await this.getProjectNotificationRecipients(projectId, senderId);\n      const [sender] = await db.select().from(users).where(eq(users.id, senderId)).limit(1);\n      const [project] = await db.select().from(projects).where(eq(projects.id, projectId)).limit(1);\n\n      if (!sender || !project) {\n        return;\n      }\n\n      // Create notifications for all recipients\n      const notifications = [];\n      for (const recipientId of recipients) {\n        const notification = await this.createNotification(\n          recipientId,\n          \"message\",\n          `${sender.fullName} sent a message in ${project.name}: \"${messageContent.substring(0, 50)}${messageContent.length > 50 ? '...' : ''}\"`,\n          projectId\n        );\n        notifications.push(notification);\n      }\n\n      return notifications;\n    } catch (error) {\n      console.error(\"Error notifying new message:\", error);\n    }\n  }\n\n  /**\n   * Notify users when a file is uploaded to a project\n   */\n  async notifyFileUpload(projectId: string, uploaderId: string, fileName: string) {\n    try {\n      const recipients = await this.getProjectNotificationRecipients(projectId, uploaderId);\n      const [uploader] = await db.select().from(users).where(eq(users.id, uploaderId)).limit(1);\n      const [project] = await db.select().from(projects).where(eq(projects.id, projectId)).limit(1);\n\n      if (!uploader || !project) {\n        return;\n      }\n\n      // Create notifications for all recipients\n      const notifications = [];\n      for (const recipientId of recipients) {\n        const notification = await this.createNotification(\n          recipientId,\n          \"file\",\n          `${uploader.fullName} uploaded a file \"${fileName}\" to ${project.name}`,\n          projectId\n        );\n        notifications.push(notification);\n      }\n\n      return notifications;\n    } catch (error) {\n      console.error(\"Error notifying file upload:\", error);\n    }\n  }\n\n  /**\n   * Notify project members when a task is completed\n   */\n  async notifyTaskCompleted(projectId: string, completedBy: string, taskTitle: string) {\n    try {\n      const recipients = await this.getProjectNotificationRecipients(projectId, completedBy);\n      const [completedByUser] = await db.select().from(users).where(eq(users.id, completedBy)).limit(1);\n      const [project] = await db.select().from(projects).where(eq(projects.id, projectId)).limit(1);\n\n      if (!completedByUser || !project) {\n        return;\n      }\n\n      // Create notifications for all recipients\n      const notifications = [];\n      for (const recipientId of recipients) {\n        const notification = await this.createNotification(\n          recipientId,\n          \"task_completed\",\n          `${completedByUser.fullName} completed task \"${taskTitle}\" in ${project.name}`,\n          projectId\n        );\n        notifications.push(notification);\n      }\n\n      return notifications;\n    } catch (error) {\n      console.error(\"Error notifying task completed:\", error);\n    }\n  }\n\n  /**\n   * Notify when a project status changes\n   */\n  async notifyProjectStatusChange(projectId: string, newStatus: string, changedBy: string) {\n    try {\n      const recipients = await this.getProjectNotificationRecipients(projectId, changedBy);\n      const [changedByUser] = await db.select().from(users).where(eq(users.id, changedBy)).limit(1);\n      const [project] = await db.select().from(projects).where(eq(projects.id, projectId)).limit(1);\n\n      if (!changedByUser || !project) {\n        return;\n      }\n\n      // Create notifications for all recipients\n      const notifications = [];\n      for (const recipientId of recipients) {\n        const notification = await this.createNotification(\n          recipientId,\n          \"project_status\",\n          `${changedByUser.fullName} changed ${project.name} status to ${newStatus}`,\n          projectId\n        );\n        notifications.push(notification);\n      }\n\n      return notifications;\n    } catch (error) {\n      console.error(\"Error notifying project status change:\", error);\n    }\n  }\n}\n\nexport const notificationService = new NotificationService();\n","path":null,"size_bytes":6670,"size_tokens":null},"client/src/components/notification-bell.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Bell } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { getWebSocketUrl } from \"@/lib/websocket\";\nimport { formatDistanceToNow } from \"date-fns\";\n\ninterface Notification {\n  id: string;\n  userId: string;\n  type: string;\n  message: string;\n  projectId: string | null;\n  isRead: boolean;\n  createdAt: string;\n}\n\nexport function NotificationBell() {\n  const [isOpen, setIsOpen] = useState(false);\n  const wsRef = useRef<WebSocket | null>(null);\n\n  // Fetch notifications\n  const { data: notifications = [], isLoading } = useQuery<Notification[]>({\n    queryKey: [\"/api/notifications\"],\n  });\n\n  // Calculate unread count\n  const unreadCount = notifications.filter(n => !n.isRead).length;\n\n  // Mark notification as read mutation\n  const markAsReadMutation = useMutation({\n    mutationFn: async (notificationId: string) => {\n      return await apiRequest(\"PATCH\", `/api/notifications/${notificationId}/read`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n    },\n  });\n\n  // Mark all notifications as read mutation\n  const markAllAsReadMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/notifications/mark-all-read\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n    },\n  });\n\n  // Setup WebSocket connection for real-time notifications\n  useEffect(() => {\n    let wsUrl: string;\n    try {\n      wsUrl = getWebSocketUrl();\n    } catch (error) {\n      console.error(\"Notification Bell: Failed to get WebSocket URL:\", error);\n      return;\n    }\n\n    let reconnectTimer: NodeJS.Timeout | null = null;\n    let reconnectAttempts = 0;\n    const maxReconnectAttempts = 5;\n    const baseDelay = 1000;\n\n    const connect = () => {\n      console.log(\"Notification Bell: Connecting to WebSocket\");\n      const ws = new WebSocket(wsUrl);\n      wsRef.current = ws;\n\n      ws.onopen = () => {\n        console.log(\"Notification Bell: WebSocket connected\");\n        reconnectAttempts = 0;\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          \n          // Handle notification broadcasts\n          if (data.type === \"notification\") {\n            console.log(\"Notification Bell: Received notification\", data.notification);\n            // Invalidate query to refetch notifications and update badge\n            queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n          }\n        } catch (error) {\n          console.error(\"Notification Bell: Error parsing WebSocket message:\", error);\n        }\n      };\n\n      ws.onclose = () => {\n        console.log(\"Notification Bell: WebSocket closed\");\n        wsRef.current = null;\n\n        // Attempt to reconnect with exponential backoff\n        if (reconnectAttempts < maxReconnectAttempts) {\n          const delay = baseDelay * Math.pow(2, reconnectAttempts);\n          console.log(`Notification Bell: Reconnecting in ${delay}ms (attempt ${reconnectAttempts + 1}/${maxReconnectAttempts})`);\n          reconnectTimer = setTimeout(() => {\n            reconnectAttempts++;\n            connect();\n          }, delay);\n        }\n      };\n\n      ws.onerror = (error) => {\n        console.error(\"Notification Bell: WebSocket error:\", error);\n      };\n    };\n\n    connect();\n\n    return () => {\n      if (reconnectTimer) {\n        clearTimeout(reconnectTimer);\n      }\n      if (wsRef.current) {\n        wsRef.current.close();\n        wsRef.current = null;\n      }\n    };\n  }, []);\n\n  const handleNotificationClick = (notification: Notification) => {\n    // Mark as read if unread\n    if (!notification.isRead) {\n      markAsReadMutation.mutate(notification.id);\n    }\n    \n    // TODO: Navigate to relevant project/page if needed\n    setIsOpen(false);\n  };\n\n  // Handle dropdown open/close - mark all as read when opened\n  const handleOpenChange = (open: boolean) => {\n    setIsOpen(open);\n    // When dropdown opens and there are unread notifications, mark all as read\n    if (open && unreadCount > 0) {\n      markAllAsReadMutation.mutate();\n    }\n  };\n\n  return (\n    <DropdownMenu open={isOpen} onOpenChange={handleOpenChange}>\n      <DropdownMenuTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className=\"relative\"\n          data-testid=\"button-notification-bell\"\n        >\n          <Bell className=\"h-5 w-5\" />\n          {unreadCount > 0 && (\n            <Badge\n              variant=\"destructive\"\n              className=\"absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center p-0 text-xs\"\n              data-testid=\"badge-notification-count\"\n            >\n              {unreadCount > 9 ? \"9+\" : unreadCount}\n            </Badge>\n          )}\n          <span className=\"sr-only\">Notifications</span>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"w-80\">\n        <DropdownMenuLabel>Notifications</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        <ScrollArea className=\"h-80\">\n          {isLoading ? (\n            <div className=\"p-4 text-center text-sm text-muted-foreground\">\n              Loading notifications...\n            </div>\n          ) : notifications.length === 0 ? (\n            <div className=\"p-4 text-center text-sm text-muted-foreground\">\n              No notifications yet\n            </div>\n          ) : (\n            notifications.map((notification) => (\n              <DropdownMenuItem\n                key={notification.id}\n                className=\"flex flex-col items-start gap-1 p-3 cursor-pointer\"\n                onClick={() => handleNotificationClick(notification)}\n                data-testid={`notification-item-${notification.id}`}\n              >\n                <div className=\"flex items-start gap-2 w-full\">\n                  <div className=\"flex-1 min-w-0\">\n                    <p className={`text-sm ${!notification.isRead ? 'font-semibold' : 'font-normal'}`}>\n                      {notification.message}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {formatDistanceToNow(new Date(notification.createdAt), { addSuffix: true })}\n                    </p>\n                  </div>\n                  {!notification.isRead && (\n                    <div className=\"h-2 w-2 rounded-full bg-blue-500 mt-1\" data-testid=\"indicator-unread\" />\n                  )}\n                </div>\n              </DropdownMenuItem>\n            ))\n          )}\n        </ScrollArea>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n","path":null,"size_bytes":7111,"size_tokens":null},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport { users } from \"@shared/schema\";\nimport bcrypt from \"bcrypt\";\nimport { eq } from \"drizzle-orm\";\n\n/**\n * Database seeding script to create initial admin account\n * Run with: tsx server/seed.ts\n */\n\nasync function seed() {\n  console.log(\" Starting database seeding...\");\n\n  try {\n    // Check if admin already exists\n    const adminEmail = \"admin@maxtech.com\";\n    const existingAdmin = await db.select().from(users).where(eq(users.email, adminEmail)).limit(1);\n\n    if (existingAdmin.length > 0) {\n      console.log(\" Admin account already exists:\", adminEmail);\n      console.log(\"   You can log in with the existing admin credentials.\");\n      return;\n    }\n\n    // Create initial admin account\n    const defaultPassword = \"Admin@123\";\n    const hashedPassword = await bcrypt.hash(defaultPassword, 10);\n\n    const [admin] = await db.insert(users).values({\n      fullName: \"System Administrator\",\n      email: adminEmail,\n      password: hashedPassword,\n      role: \"admin\",\n      clientId: null,\n    }).returning();\n\n    console.log(\"\\n Initial admin account created successfully!\");\n    console.log(\"\");\n    console.log(\" Email:    \", adminEmail);\n    console.log(\" Password: \", defaultPassword);\n    console.log(\"\");\n    console.log(\"\\n  IMPORTANT: Change this password after first login!\");\n    console.log(\"   Go to Settings  Change Password\\n\");\n    console.log(\" You can now:\");\n    console.log(\"   1. Log in with these credentials\");\n    console.log(\"   2. Navigate to Team  Add Team Member\");\n    console.log(\"   3. Create client user accounts with Role = Client\");\n    console.log(\"   4. Assign clients to projects\\n\");\n\n  } catch (error) {\n    console.error(\" Error seeding database:\", error);\n    process.exit(1);\n  }\n\n  process.exit(0);\n}\n\nseed();\n","path":null,"size_bytes":2072,"size_tokens":null},"client/src/components/chat-widget.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport { MessageCircle, X, Send, AlertCircle, Paperclip, FileText, Image } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { getWebSocketUrl } from \"@/lib/websocket\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { type Message, type Project } from \"@shared/schema\";\nimport { useAuth } from \"@/lib/auth-context\";\n\n// Enriched message type with client/project info\ninterface EnrichedMessage {\n  id: string;\n  projectId: string;\n  userId: string;\n  content: string | null;\n  createdAt: Date;\n  projectName: string | null;\n  clientId: string | null;\n  clientName: string | null;\n  senderName: string | null;\n  senderRole: string | null;\n  fileUrl?: string | null;\n  fileName?: string | null;\n  fileType?: string | null;\n  fileSize?: number | null;\n}\n\nexport default function ChatWidget() {\n  const { user, logout } = useAuth();\n  const { toast } = useToast();\n  const [isOpen, setIsOpen] = useState(false);\n  // CRITICAL: selectedConversation must NEVER be reset after sending\n  // It determines which conversation the user is replying to\n  const [selectedConversation, setSelectedConversation] = useState<string | null>(null);\n  const [message, setMessage] = useState(\"\");\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [wsStatus, setWsStatus] = useState<\"connecting\" | \"connected\" | \"disconnected\" | \"error\">(\"connecting\");\n  const [wsError, setWsError] = useState<string | null>(null);\n  const wsRef = useRef<WebSocket | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  \n  // Fetch client's projects to enable starting new conversations\n  const { data: clientProjects } = useQuery<Project[]>({\n    queryKey: [\"/api/projects\"],\n    enabled: isOpen && user?.role === \"client\",\n  });\n\n  // UNIFIED INBOX: Fetch all messages from all projects (for developers/admins)\n  const { data: messages, isLoading, refetch } = useQuery<EnrichedMessage[]>({\n    queryKey: [\"/api/messages\"],\n    queryFn: async () => {\n      const token = localStorage.getItem(\"token\");\n      const headers: HeadersInit = {\n        \"Content-Type\": \"application/json\",\n      };\n      if (token) {\n        headers[\"Authorization\"] = `Bearer ${token}`;\n      }\n      \n      // No projectId filter - get all messages (unified inbox)\n      const url = `/api/messages`;\n      const res = await fetch(url, { headers, credentials: \"include\" });\n      \n      if (!res.ok) {\n        if (res.status === 401) {\n          localStorage.removeItem(\"token\");\n          localStorage.removeItem(\"user\");\n          window.location.href = \"/login\";\n        }\n        const errorData = await res.json().catch(() => ({ error: \"Request failed\" }));\n        throw new Error(errorData.error || `Request failed with status ${res.status}`);\n      }\n      \n      return res.json();\n    },\n    enabled: isOpen, // Only fetch when widget is open\n    refetchOnMount: true,\n    refetchOnWindowFocus: false,\n    staleTime: 0, // Always refetch to show latest messages\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: (data: { projectId: string; content: string }) => {\n      console.log(\" MUTATION: Sending message\", { projectId: data.projectId, content: data.content });\n      if (!data.projectId) {\n        throw new Error(\"No project selected. Please select a conversation first.\");\n      }\n      return apiRequest(\"POST\", \"/api/messages\", data);\n    },\n    onSuccess: async (response) => {\n      console.log(\" MUTATION SUCCESS: Message sent\", response);\n      console.log(\" KEEPING selectedConversation:\", selectedConversation);\n      \n      // Clear message input ONLY on successful send\n      setMessage(\"\");\n      \n      // CRITICAL: Do NOT reset selectedConversation here\n      // Keep it so the reply indicator stays active\n      \n      // Force refetch messages to show new message immediately\n      console.log(\" REFETCH: Calling refetch after mutation success\");\n      const result = await refetch();\n      console.log(\" REFETCH COMPLETE:\", result.data?.length, \"messages\");\n      console.log(\" selectedConversation AFTER refetch:\", selectedConversation);\n    },\n    onError: (error: Error) => {\n      console.error(\" MUTATION ERROR:\", error);\n      toast({ \n        title: \"Failed to send message\", \n        description: error.message, \n        variant: \"destructive\" \n      });\n      // Don't clear message on error - keep it so user can retry\n    },\n  });\n\n  const uploadFileMutation = useMutation({\n    mutationFn: async (data: { projectId: string; file: File; content?: string }) => {\n      const formData = new FormData();\n      formData.append(\"file\", data.file);\n      formData.append(\"projectId\", data.projectId);\n      if (data.content) {\n        formData.append(\"content\", data.content);\n      }\n\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(\"/api/messages/upload\", {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n        body: formData,\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"File upload failed\");\n      }\n\n      return response.json();\n    },\n    onSuccess: async () => {\n      setMessage(\"\");\n      setSelectedFile(null);\n      toast({ title: \"Success\", description: \"File uploaded successfully\" });\n      await refetch();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"File upload failed\", description: error.message, variant: \"destructive\" });\n      setSelectedFile(null);\n    },\n  });\n\n  // WebSocket connection - only when widget is open\n  useEffect(() => {\n    if (!isOpen) return;\n\n    let wsUrl: string;\n    try {\n      wsUrl = getWebSocketUrl();\n    } catch (error: any) {\n      setWsStatus(\"error\");\n      setWsError(error.message || \"Failed to initialize WebSocket connection\");\n      return;\n    }\n    \n    let reconnectAttempts = 0;\n    const maxReconnectAttempts = 5;\n    const reconnectDelay = 3000;\n    let authFailure = false;\n\n    const connect = () => {\n      if (authFailure) {\n        console.log(\"ChatWidget: Not reconnecting due to authentication failure\");\n        return;\n      }\n\n      console.log(\"ChatWidget: Connecting to WebSocket\");\n      setWsStatus(\"connecting\");\n      setWsError(null);\n      \n      const ws = new WebSocket(wsUrl);\n      wsRef.current = ws;\n\n      ws.onopen = () => {\n        console.log(\"ChatWidget: WebSocket connected - auto-subscribed to all projects\");\n        setWsStatus(\"connected\");\n        setWsError(null);\n        reconnectAttempts = 0;\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          console.log(\" WEBSOCKET MESSAGE:\", data);\n          \n          if (data.type === \"new_message\") {\n            console.log(\" NEW MESSAGE via WebSocket:\", data.message);\n            console.log(\" REFETCH: Calling refetch after WebSocket message\");\n            // Force refetch to show new message immediately\n            refetch().then(result => {\n              console.log(\" REFETCH COMPLETE after WebSocket:\", result.data?.length, \"messages\");\n            });\n          } else if (data.type === \"connected\") {\n            console.log(\"ChatWidget: WebSocket authentication successful\");\n            setWsStatus(\"connected\");\n          } else if (data.type === \"subscribed_all\") {\n            console.log(`ChatWidget: Auto-subscribed to ${data.projectCount} projects`);\n          }\n        } catch (error) {\n          console.error(\"ChatWidget: Error parsing WebSocket message:\", error);\n        }\n      };\n\n      ws.onerror = (error) => {\n        console.error(\"ChatWidget: WebSocket error:\", error);\n        setWsStatus(\"error\");\n      };\n\n      ws.onclose = (event) => {\n        console.log(\"ChatWidget: WebSocket disconnected\", event.code, event.reason);\n        setWsStatus(\"disconnected\");\n        \n        // Check if close was due to authentication failure\n        if (event.code === 1008 || event.reason?.includes(\"Authentication\")) {\n          authFailure = true;\n          setWsError(\"Authentication failed. Your session may have expired. Please log in again.\");\n          setWsStatus(\"error\");\n          \n          toast({\n            title: \"Authentication Error\",\n            description: \"Your session has expired. Please log in again.\",\n            variant: \"destructive\",\n          });\n          \n          setTimeout(() => {\n            logout();\n          }, 3000);\n          return;\n        }\n        \n        // Attempt to reconnect with exponential backoff\n        if (reconnectAttempts < maxReconnectAttempts && !authFailure) {\n          reconnectAttempts++;\n          console.log(`ChatWidget: Reconnecting in ${reconnectDelay}ms (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);\n          setTimeout(() => {\n            connect();\n          }, reconnectDelay * reconnectAttempts);\n        } else if (!authFailure) {\n          console.error(\"ChatWidget: Max reconnection attempts reached\");\n          setWsError(\"Failed to connect to chat server after multiple attempts.\");\n          setWsStatus(\"error\");\n        }\n      };\n    };\n\n    connect();\n\n    return () => {\n      if (wsRef.current) {\n        wsRef.current.onclose = null;\n        if (wsRef.current.readyState === WebSocket.OPEN) {\n          wsRef.current.close();\n        }\n      }\n    };\n  }, [isOpen, logout, toast, refetch]);\n\n  // Auto-scroll to BOTTOM when messages change (WhatsApp/Messenger behavior)\n  useEffect(() => {\n    // Only scroll if widget is open and messages exist\n    if (!isOpen || !messages || messages.length === 0) {\n      return;\n    }\n    \n    // Delay scroll slightly to ensure DOM has updated\n    const scrollToBottom = () => {\n      if (messagesContainerRef.current) {\n        console.log(\" AUTO-SCROLL: Scrolling to BOTTOM (newest message) for\", messages.length, \"messages\");\n        // Scroll to BOTTOM - newest messages appear at bottom (ASC order)\n        messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;\n      } else {\n        console.warn(\" AUTO-SCROLL: Container ref not found\");\n      }\n    };\n    \n    // Use setTimeout to ensure DOM has rendered the new messages\n    const timeoutId = setTimeout(scrollToBottom, 100);\n    \n    return () => clearTimeout(timeoutId);\n  }, [messages, isOpen]);\n\n  // Auto-select first conversation when messages load - ONLY if not already selected\n  useEffect(() => {\n    console.log(\" MESSAGES UPDATED:\", messages?.length || 0, \"messages\");\n    console.log(\" SELECTED CONVERSATION:\", selectedConversation);\n    \n    // CRITICAL: Only auto-select if NO conversation is currently selected\n    // This prevents resetting selectedConversation after sending a message\n    if (!selectedConversation) {\n      if (messages && messages.length > 0) {\n        // Auto-select from existing messages\n        const latestMessage = messages[0];\n        console.log(\" AUTO-SELECT: Selecting first conversation from messages\", latestMessage?.projectId);\n        if (latestMessage?.projectId) {\n          setSelectedConversation(latestMessage.projectId);\n        }\n      } else if (user?.role === \"client\" && clientProjects && clientProjects.length > 0) {\n        // CLIENT: No messages yet, but has projects - auto-select first project to start conversation\n        const firstProject = clientProjects[0];\n        console.log(\" AUTO-SELECT: Client has no messages, selecting first project\", firstProject.id);\n        setSelectedConversation(firstProject.id);\n      }\n    }\n  }, [messages, clientProjects, user?.role]); // REMOVED selectedConversation from deps to prevent resets\n\n  const handleSend = async () => {\n    console.log(\" HANDLE SEND: Called\", { \n      message: message.trim(), \n      selectedFile: selectedFile?.name,\n      selectedConversation,\n      messageLength: message.trim().length \n    });\n    \n    if (!selectedConversation) {\n      console.error(\" NO CONVERSATION SELECTED\");\n      toast({ \n        title: \"No conversation selected\", \n        description: \"Please select a conversation by clicking on a message first.\",\n        variant: \"destructive\" \n      });\n      return;\n    }\n\n    // File upload\n    if (selectedFile) {\n      uploadFileMutation.mutate({\n        projectId: selectedConversation,\n        file: selectedFile,\n        content: message.trim() || undefined,\n      });\n      return;\n    }\n    \n    // Text message\n    if (!message.trim()) {\n      toast({ \n        title: \"Empty message\", \n        description: \"Please type a message before sending.\",\n        variant: \"destructive\" \n      });\n      return;\n    }\n    \n    console.log(\" SENDING MESSAGE:\", { projectId: selectedConversation, content: message.trim() });\n    sendMessageMutation.mutate({ \n      projectId: selectedConversation, \n      content: message.trim() \n    });\n  };\n\n  const handleAttachmentClick = () => {\n    fileInputRef.current?.click();\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    // Validate file size (10MB limit)\n    const maxSize = 10 * 1024 * 1024;\n    if (file.size > maxSize) {\n      toast({\n        title: \"File too large\",\n        description: \"Maximum file size is 10MB\",\n        variant: \"destructive\",\n      });\n      e.target.value = \"\";\n      return;\n    }\n\n    // Validate file type\n    const allowedTypes = [\n      \"image/jpeg\",\n      \"image/png\",\n      \"image/gif\",\n      \"image/webp\",\n      \"application/pdf\",\n      \"application/msword\",\n      \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n      \"text/plain\",\n    ];\n\n    if (!allowedTypes.includes(file.type)) {\n      toast({\n        title: \"Invalid file type\",\n        description: \"Only images and documents (PDF, Word, TXT) are allowed\",\n        variant: \"destructive\",\n      });\n      e.target.value = \"\";\n      return;\n    }\n\n    if (!selectedConversation) {\n      toast({\n        title: \"No conversation selected\",\n        description: \"Please select a conversation first\",\n        variant: \"destructive\",\n      });\n      e.target.value = \"\";\n      return;\n    }\n\n    setSelectedFile(file);\n    e.target.value = \"\";\n  };\n\n  // Don't render widget if not authenticated\n  if (!user) {\n    return null;\n  }\n\n  const widgetContent = (\n    <>\n      {/* Floating Chat Button */}\n      {!isOpen && (\n        <button\n          onClick={() => setIsOpen(true)}\n          data-testid=\"button-open-chat\"\n          style={{\n            position: 'fixed',\n            bottom: '24px',\n            right: '24px',\n            width: '56px',\n            height: '56px',\n            borderRadius: '50%',\n            backgroundColor: 'hsl(var(--primary))',\n            color: 'hsl(var(--primary-foreground))',\n            border: 'none',\n            cursor: 'pointer',\n            boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)',\n            zIndex: 999999,\n            display: 'flex',\n            alignItems: 'center',\n            justifyContent: 'center',\n            transition: 'transform 0.2s',\n          }}\n          onMouseEnter={(e) => {\n            e.currentTarget.style.transform = 'scale(1.05)';\n          }}\n          onMouseLeave={(e) => {\n            e.currentTarget.style.transform = 'scale(1)';\n          }}\n        >\n          <MessageCircle className=\"h-6 w-6\" />\n        </button>\n      )}\n\n      {/* Chat Popup Window */}\n      {isOpen && (\n        <>\n          {/* Invisible backdrop to block click-through */}\n          <div \n            className=\"fixed inset-0\"\n            style={{ \n              zIndex: 999998,\n              backgroundColor: 'transparent',\n              pointerEvents: 'auto'\n            }}\n            onClick={() => setIsOpen(false)}\n          />\n          \n          {/* Chat popup container */}\n          <div \n            className=\"fixed w-96 h-[600px] shadow-2xl rounded-lg flex flex-col bg-card border\"\n            style={{ \n              bottom: '24px', \n              right: '24px', \n              zIndex: 999999,\n              pointerEvents: 'auto'\n            }}\n            onClick={(e) => e.stopPropagation()}\n          >\n          {/* Header */}\n          <div className=\"flex items-center justify-between gap-2 p-4 border-b\">\n            <div className=\"flex items-center gap-2\">\n              <MessageCircle className=\"h-5 w-5\" />\n              <h2 className=\"font-semibold\">Team Chat</h2>\n            </div>\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={() => setIsOpen(false)}\n              data-testid=\"button-close-chat\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n\n          {/* Content */}\n          <div className=\"flex-1 flex flex-col overflow-hidden\">\n            {/* Connection Status */}\n            {wsStatus === \"error\" && wsError && (\n              <Alert variant=\"destructive\" className=\"m-4 mb-0\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertTitle>Connection Error</AlertTitle>\n                <AlertDescription className=\"text-xs\">{wsError}</AlertDescription>\n              </Alert>\n            )}\n\n            {wsStatus === \"connecting\" && (\n              <Alert className=\"m-4 mb-0\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertTitle>Connecting...</AlertTitle>\n                <AlertDescription className=\"text-xs\">Establishing connection...</AlertDescription>\n              </Alert>\n            )}\n\n            {/* UNIFIED INBOX - Messages from all projects */}\n            <div ref={messagesContainerRef} className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n              {isLoading ? (\n                <div className=\"flex items-center justify-center h-full\">\n                  <p className=\"text-sm text-muted-foreground\">Loading messages...</p>\n                </div>\n              ) : !messages || messages.length === 0 ? (\n                <div className=\"flex items-center justify-center h-full\">\n                  <div className=\"text-center\">\n                    <MessageCircle className=\"h-8 w-8 mx-auto mb-2 text-muted-foreground\" />\n                    <p className=\"text-sm font-medium mb-1\">No messages yet</p>\n                    {user?.role === \"client\" && clientProjects && clientProjects.length > 0 ? (\n                      <p className=\"text-xs text-muted-foreground\">\n                        Type below to start a conversation about your project\n                      </p>\n                    ) : (\n                      <p className=\"text-xs text-muted-foreground\">Waiting for conversations...</p>\n                    )}\n                  </div>\n                </div>\n              ) : (\n                <>\n                  {messages.map((msg) => {\n                    const isBuyer = msg.senderRole === \"client\";\n                    const isMyMessage = msg.userId === user?.id;\n                    console.log(\" RENDERING MESSAGE:\", { \n                      id: msg.id, \n                      projectId: msg.projectId, \n                      content: msg.content?.substring(0, 30) || \"(file)\",\n                      senderName: msg.senderName,\n                      isMyMessage \n                    });\n                    \n                    return (\n                      <div\n                        key={msg.id}\n                        className={`flex gap-2 ${isMyMessage ? \"flex-row-reverse\" : \"\"} cursor-pointer hover-elevate rounded-lg p-2`}\n                        data-testid={`message-${msg.id}`}\n                        onClick={() => {\n                          console.log(\" CONVERSATION SELECTED:\", msg.projectId);\n                          setSelectedConversation(msg.projectId);\n                        }}\n                      >\n                        <Avatar className=\"w-7 h-7\">\n                          <AvatarFallback className=\"text-xs\">\n                            {msg.senderName?.charAt(0)?.toUpperCase() || \"U\"}\n                          </AvatarFallback>\n                        </Avatar>\n                        <div className={`flex flex-col flex-1 ${isMyMessage ? \"items-end\" : \"\"}`}>\n                          {/* Project Tag Above Message */}\n                          <div className={`mb-1 ${isMyMessage ? \"text-right\" : \"\"}`}>\n                            <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0 h-4\">\n                              {msg.projectName || \"Unknown Project\"}\n                            </Badge>\n                          </div>\n                          \n                          {/* Message Content with Buyer Name and Files */}\n                          <div\n                            className={`rounded-lg p-2 max-w-[250px] ${\n                              isMyMessage\n                                ? \"bg-primary text-primary-foreground\"\n                                : \"bg-muted\"\n                            }`}\n                          >\n                            {isBuyer && !isMyMessage && (\n                              <p className=\"text-xs font-semibold mb-0.5\">\n                                {msg.clientName || msg.senderName}:\n                              </p>\n                            )}\n                            {msg.content && <p className=\"text-xs break-words\">{msg.content}</p>}\n                            {msg.fileUrl && msg.fileType?.startsWith(\"image/\") && (\n                              <img\n                                src={msg.fileUrl}\n                                alt={msg.fileName || \"Image\"}\n                                className=\"max-w-full rounded-md mt-1\"\n                                data-testid={`image-${msg.id}`}\n                              />\n                            )}\n                            {msg.fileUrl && !msg.fileType?.startsWith(\"image/\") && (\n                              <a\n                                href={msg.fileUrl}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                                className=\"flex items-center gap-1 text-xs hover:underline mt-1\"\n                                data-testid={`file-link-${msg.id}`}\n                              >\n                                <FileText className=\"w-3 h-3\" />\n                                <span className=\"truncate\">{msg.fileName || \"Download file\"}</span>\n                              </a>\n                            )}\n                          </div>\n                          \n                          {/* Timestamp */}\n                          <div className=\"flex items-center gap-1 mt-0.5\">\n                            {!isBuyer && (\n                              <>\n                                <span className=\"text-[10px] text-muted-foreground\">\n                                  {msg.senderName}\n                                </span>\n                                <span className=\"text-[10px] text-muted-foreground\"></span>\n                              </>\n                            )}\n                            <span className=\"text-[10px] text-muted-foreground\">\n                              {new Date(msg.createdAt).toLocaleTimeString([], { \n                                hour: '2-digit', \n                                minute: '2-digit' \n                              })}\n                            </span>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                  <div ref={messagesEndRef} />\n                </>\n              )}\n            </div>\n\n            {/* Input Area - Shows when conversation is selected */}\n            <div className=\"p-4 border-t\">\n              {selectedConversation ? (\n                <>\n                  <div className=\"text-[10px] text-muted-foreground mb-2\">\n                    {messages && messages.length > 0 ? (\n                      <>\n                        Replying to: <span className=\"font-semibold\">\n                          {messages?.find(m => m.projectId === selectedConversation)?.projectName}\n                          {\" \"}\n                          ({messages?.find(m => m.projectId === selectedConversation)?.clientName})\n                        </span>\n                      </>\n                    ) : user?.role === \"client\" && clientProjects ? (\n                      <>\n                        Sending to: <span className=\"font-semibold\">\n                          {clientProjects.find(p => p.id === selectedConversation)?.name || \"Your Project\"}\n                        </span>\n                      </>\n                    ) : (\n                      <span className=\"font-semibold\">Ready to send</span>\n                    )}\n                  </div>\n                  <div className=\"space-y-2\">\n                    {selectedFile && (\n                      <div className=\"text-xs text-muted-foreground bg-muted p-2 rounded-md flex items-center gap-2\">\n                        <FileText className=\"w-3 h-3\" />\n                        <span className=\"flex-1 truncate\">{selectedFile.name}</span>\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          className=\"h-5 w-5\"\n                          onClick={() => setSelectedFile(null)}\n                          data-testid=\"button-remove-file\"\n                        >\n                          <X className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    )}\n                    <form\n                      onSubmit={(e) => {\n                        e.preventDefault();\n                        handleSend();\n                      }}\n                      className=\"flex gap-2\"\n                    >\n                      <input\n                        ref={fileInputRef}\n                        type=\"file\"\n                        onChange={handleFileSelect}\n                        className=\"hidden\"\n                        accept=\"image/*,.pdf,.doc,.docx,.txt\"\n                        data-testid=\"input-file-widget\"\n                      />\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"icon\"\n                        onClick={handleAttachmentClick}\n                        disabled={!selectedConversation || uploadFileMutation.isPending}\n                        data-testid=\"button-attach-widget\"\n                        className=\"flex-shrink-0\"\n                      >\n                        <Paperclip className=\"h-4 w-4\" />\n                      </Button>\n                      <Input\n                        placeholder=\"Type your reply...\"\n                        value={message}\n                        onChange={(e) => setMessage(e.target.value)}\n                        disabled={sendMessageMutation.isPending || uploadFileMutation.isPending}\n                        data-testid=\"input-message-widget\"\n                        className=\"flex-1 text-sm\"\n                      />\n                      <Button\n                        type=\"submit\"\n                        size=\"icon\"\n                        disabled={((!message.trim() && !selectedFile) || sendMessageMutation.isPending || uploadFileMutation.isPending)}\n                        data-testid=\"button-send-widget\"\n                        className=\"flex-shrink-0\"\n                      >\n                        <Send className=\"h-4 w-4\" />\n                      </Button>\n                    </form>\n                  </div>\n                </>\n              ) : (\n                <div className=\"text-center\">\n                  <p className=\"text-xs text-muted-foreground\">Click on a message to select a conversation and reply</p>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n        </>\n      )}\n    </>\n  );\n\n  // Render to document.body using Portal to ensure viewport-level positioning\n  return createPortal(widgetContent, document.body);\n}\n","path":null,"size_bytes":28933,"size_tokens":null},"client/src/pages/leave-management.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Plus,\n  Calendar,\n  CheckCircle2,\n  XCircle,\n  Clock,\n  FileText,\n} from \"lucide-react\";\n\ntype LeaveType = {\n  id: string;\n  name: string;\n  daysPerYear: number;\n  carryForward: string;\n  requiresApproval: string;\n  isPaid: string;\n  createdAt: string;\n};\n\ntype LeaveRequest = {\n  id: string;\n  employeeId: string;\n  leaveTypeId: string;\n  startDate: string;\n  endDate: string;\n  totalDays: string;\n  reason: string;\n  status: string;\n  approvedBy?: string;\n  approvedAt?: string;\n  rejectionReason?: string;\n  createdAt: string;\n};\n\ntype LeaveBalance = {\n  id: string;\n  employeeId: string;\n  leaveTypeId: string;\n  year: number;\n  totalDays: string;\n  usedDays: string;\n  remainingDays: string;\n  createdAt: string;\n};\n\ntype Employee = {\n  id: string;\n  employeeId: string;\n  userId: string;\n};\n\nconst leaveTypeSchema = z.object({\n  name: z.string().min(1, \"Leave type name is required\"),\n  daysPerYear: z.coerce.number().min(1, \"Days per year must be at least 1\"),\n  carryForward: z.string().default(\"no\"),\n  requiresApproval: z.string().default(\"yes\"),\n  isPaid: z.string().default(\"yes\"),\n});\n\nconst leaveRequestSchema = z.object({\n  employeeId: z.string().min(1, \"Employee is required\"),\n  leaveTypeId: z.string().min(1, \"Leave type is required\"),\n  startDate: z.string().min(1, \"Start date is required\"),\n  endDate: z.string().min(1, \"End date is required\"),\n  totalDays: z.coerce.number().min(0.5, \"Total days must be at least 0.5\"),\n  reason: z.string().min(1, \"Reason is required\"),\n});\n\ntype LeaveTypeFormData = z.infer<typeof leaveTypeSchema>;\ntype LeaveRequestFormData = z.infer<typeof leaveRequestSchema>;\n\nexport default function LeaveManagement() {\n  const { toast } = useToast();\n  const [typeCreateOpen, setTypeCreateOpen] = useState(false);\n  const [requestCreateOpen, setRequestCreateOpen] = useState(false);\n\n  const { data: leaveTypes, isLoading: typesLoading } = useQuery<LeaveType[]>({\n    queryKey: [\"/api/leave-types\"],\n  });\n\n  const { data: leaveRequests, isLoading: requestsLoading } = useQuery<LeaveRequest[]>({\n    queryKey: [\"/api/leave-requests\"],\n  });\n\n  const { data: leaveBalances, isLoading: balancesLoading } = useQuery<LeaveBalance[]>({\n    queryKey: [\"/api/leave-balances\"],\n  });\n\n  const { data: employees } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const typeCreateForm = useForm<LeaveTypeFormData>({\n    resolver: zodResolver(leaveTypeSchema),\n    defaultValues: {\n      name: \"\",\n      daysPerYear: 10,\n      carryForward: \"no\",\n      requiresApproval: \"yes\",\n      isPaid: \"yes\",\n    },\n  });\n\n  const requestCreateForm = useForm<LeaveRequestFormData>({\n    resolver: zodResolver(leaveRequestSchema),\n    defaultValues: {\n      employeeId: \"\",\n      leaveTypeId: \"\",\n      startDate: \"\",\n      endDate: \"\",\n      totalDays: 1,\n      reason: \"\",\n    },\n  });\n\n  const typeCreateMutation = useMutation({\n    mutationFn: async (data: LeaveTypeFormData) => {\n      return apiRequest(\"POST\", \"/api/leave-types\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-types\"] });\n      setTypeCreateOpen(false);\n      typeCreateForm.reset();\n      toast({ title: \"Success\", description: \"Leave type created successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const requestCreateMutation = useMutation({\n    mutationFn: async (data: LeaveRequestFormData) => {\n      return apiRequest(\"POST\", \"/api/leave-requests\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-requests\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-balances\"] });\n      setRequestCreateOpen(false);\n      requestCreateForm.reset();\n      toast({ title: \"Success\", description: \"Leave request submitted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const approveRequestMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"POST\", `/api/leave-requests/${id}/approve`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-requests\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-balances\"] });\n      toast({ title: \"Success\", description: \"Leave request approved\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const rejectRequestMutation = useMutation({\n    mutationFn: (data: { id: string; reason: string }) =>\n      apiRequest(\"POST\", `/api/leave-requests/${data.id}/reject`, {\n        rejectionReason: data.reason,\n      }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-requests\"] });\n      toast({ title: \"Success\", description: \"Leave request rejected\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onTypeCreateSubmit = (data: LeaveTypeFormData) => {\n    typeCreateMutation.mutate(data);\n  };\n\n  const onRequestCreateSubmit = (data: LeaveRequestFormData) => {\n    requestCreateMutation.mutate(data);\n  };\n\n  const handleApproveRequest = (id: string) => {\n    if (confirm(\"Approve this leave request?\")) {\n      approveRequestMutation.mutate(id);\n    }\n  };\n\n  const handleRejectRequest = (id: string) => {\n    const reason = prompt(\"Enter rejection reason:\");\n    if (reason) {\n      rejectRequestMutation.mutate({ id, reason });\n    }\n  };\n\n  // Get leave type name\n  const getLeaveTypeName = (typeId: string) => {\n    return leaveTypes?.find((t) => t.id === typeId)?.name || \"Unknown\";\n  };\n\n  // Get employee by ID\n  const getEmployee = (empId: string) => {\n    return employees?.find((e) => e.id === empId);\n  };\n\n  const statusColors: Record<string, string> = {\n    pending: \"bg-yellow-500/10 text-yellow-700 dark:text-yellow-400\",\n    approved: \"bg-green-500/10 text-green-700 dark:text-green-400\",\n    rejected: \"bg-red-500/10 text-red-700 dark:text-red-400\",\n  };\n\n  const requestStats = {\n    total: leaveRequests?.length || 0,\n    pending: leaveRequests?.filter((r) => r.status === \"pending\").length || 0,\n    approved: leaveRequests?.filter((r) => r.status === \"approved\").length || 0,\n    rejected: leaveRequests?.filter((r) => r.status === \"rejected\").length || 0,\n  };\n\n  return (\n    <div className=\"h-full overflow-auto\">\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">\n            Leave Management\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Manage leave types, requests, approvals, and balances\n          </p>\n        </div>\n\n        <Tabs defaultValue=\"requests\" className=\"w-full\">\n          <TabsList>\n            <TabsTrigger value=\"requests\" data-testid=\"tab-requests\">\n              <FileText className=\"w-4 h-4 mr-2\" />\n              Requests ({requestStats.pending})\n            </TabsTrigger>\n            <TabsTrigger value=\"balances\" data-testid=\"tab-balances\">\n              <Calendar className=\"w-4 h-4 mr-2\" />\n              Balances\n            </TabsTrigger>\n            <TabsTrigger value=\"types\" data-testid=\"tab-types\">\n              <Clock className=\"w-4 h-4 mr-2\" />\n              Leave Types\n            </TabsTrigger>\n          </TabsList>\n\n          {/* REQUESTS TAB */}\n          <TabsContent value=\"requests\" className=\"space-y-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <div className=\"grid gap-4 md:grid-cols-4 flex-1\">\n                <Card>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Total Requests</CardTitle>\n                    <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-2xl font-bold\">{requestStats.total}</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Pending</CardTitle>\n                    <Clock className=\"h-4 w-4 text-yellow-600\" />\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-2xl font-bold text-yellow-600\">{requestStats.pending}</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Approved</CardTitle>\n                    <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-2xl font-bold text-green-600\">{requestStats.approved}</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Rejected</CardTitle>\n                    <XCircle className=\"h-4 w-4 text-red-600\" />\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-2xl font-bold text-red-600\">{requestStats.rejected}</div>\n                  </CardContent>\n                </Card>\n              </div>\n              <Dialog open={requestCreateOpen} onOpenChange={setRequestCreateOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-create-request\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    New Request\n                  </Button>\n                </DialogTrigger>\n                <DialogContent data-testid=\"dialog-create-request\">\n                  <DialogHeader>\n                    <DialogTitle>Submit Leave Request</DialogTitle>\n                  </DialogHeader>\n                  <Form {...requestCreateForm}>\n                    <form onSubmit={requestCreateForm.handleSubmit(onRequestCreateSubmit)} className=\"space-y-4\">\n                      <FormField\n                        control={requestCreateForm.control}\n                        name=\"employeeId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Employee*</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-employee\">\n                                  <SelectValue placeholder=\"Select employee\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent position=\"popper\">\n                                {employees?.map((emp) => (\n                                  <SelectItem key={emp.id} value={emp.id}>\n                                    {emp.employeeId}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={requestCreateForm.control}\n                        name=\"leaveTypeId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Leave Type*</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-leave-type\">\n                                  <SelectValue placeholder=\"Select leave type\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent position=\"popper\">\n                                {leaveTypes?.map((type) => (\n                                  <SelectItem key={type.id} value={type.id}>\n                                    {type.name} ({type.daysPerYear} days/year)\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <FormField\n                          control={requestCreateForm.control}\n                          name=\"startDate\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Start Date*</FormLabel>\n                              <FormControl>\n                                <Input {...field} type=\"date\" data-testid=\"input-start-date\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={requestCreateForm.control}\n                          name=\"endDate\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>End Date*</FormLabel>\n                              <FormControl>\n                                <Input {...field} type=\"date\" data-testid=\"input-end-date\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </div>\n                      <FormField\n                        control={requestCreateForm.control}\n                        name=\"totalDays\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Total Days*</FormLabel>\n                            <FormControl>\n                              <Input\n                                {...field}\n                                type=\"number\"\n                                step=\"0.5\"\n                                data-testid=\"input-total-days\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={requestCreateForm.control}\n                        name=\"reason\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Reason*</FormLabel>\n                            <FormControl>\n                              <Textarea {...field} placeholder=\"Reason for leave\" data-testid=\"input-reason\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <div className=\"flex justify-end gap-2\">\n                        <Button type=\"button\" variant=\"outline\" onClick={() => setRequestCreateOpen(false)}>\n                          Cancel\n                        </Button>\n                        <Button type=\"submit\" disabled={requestCreateMutation.isPending} data-testid=\"button-submit-request\">\n                          {requestCreateMutation.isPending ? \"Submitting...\" : \"Submit Request\"}\n                        </Button>\n                      </div>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Leave Requests</CardTitle>\n              </CardHeader>\n              <CardContent>\n                {requestsLoading ? (\n                  <p className=\"text-center text-muted-foreground py-8\">Loading requests...</p>\n                ) : leaveRequests && leaveRequests.length === 0 ? (\n                  <p className=\"text-center text-muted-foreground py-8\">No leave requests found</p>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {leaveRequests?.map((request) => {\n                      const employee = getEmployee(request.employeeId);\n                      return (\n                        <Card key={request.id} className=\"hover-elevate\">\n                          <CardContent className=\"pt-4\">\n                            <div className=\"space-y-3\">\n                              <div className=\"flex items-start justify-between gap-4\">\n                                <div className=\"space-y-1 flex-1\">\n                                  <div className=\"font-medium\">\n                                    {employee?.employeeId || \"Unknown Employee\"} -{\" \"}\n                                    {getLeaveTypeName(request.leaveTypeId)}\n                                  </div>\n                                  <div className=\"text-sm text-muted-foreground\">\n                                    {new Date(request.startDate).toLocaleDateString()} to{\" \"}\n                                    {new Date(request.endDate).toLocaleDateString()} ({request.totalDays} days)\n                                  </div>\n                                  <div className=\"text-sm\">\n                                    <span className=\"text-muted-foreground\">Reason: </span>\n                                    {request.reason}\n                                  </div>\n                                  {request.rejectionReason && (\n                                    <div className=\"text-sm text-destructive\">\n                                      <span className=\"font-medium\">Rejected: </span>\n                                      {request.rejectionReason}\n                                    </div>\n                                  )}\n                                  <div className=\"text-xs text-muted-foreground\">\n                                    Requested {new Date(request.createdAt).toLocaleString()}\n                                  </div>\n                                </div>\n                                <Badge className={statusColors[request.status]}>{request.status}</Badge>\n                              </div>\n                              {request.status === \"pending\" && (\n                                <div className=\"flex gap-2\">\n                                  <Button\n                                    size=\"sm\"\n                                    variant=\"outline\"\n                                    onClick={() => handleApproveRequest(request.id)}\n                                    disabled={approveRequestMutation.isPending}\n                                    data-testid={`button-approve-${request.id}`}\n                                  >\n                                    <CheckCircle2 className=\"w-4 h-4 mr-1\" />\n                                    Approve\n                                  </Button>\n                                  <Button\n                                    size=\"sm\"\n                                    variant=\"ghost\"\n                                    onClick={() => handleRejectRequest(request.id)}\n                                    disabled={rejectRequestMutation.isPending}\n                                    data-testid={`button-reject-${request.id}`}\n                                  >\n                                    <XCircle className=\"w-4 h-4 mr-1\" />\n                                    Reject\n                                  </Button>\n                                </div>\n                              )}\n                            </div>\n                          </CardContent>\n                        </Card>\n                      );\n                    })}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* BALANCES TAB */}\n          <TabsContent value=\"balances\" className=\"space-y-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Leave Balances ({new Date().getFullYear()})</CardTitle>\n              </CardHeader>\n              <CardContent>\n                {balancesLoading ? (\n                  <p className=\"text-center text-muted-foreground py-8\">Loading balances...</p>\n                ) : leaveBalances && leaveBalances.length === 0 ? (\n                  <p className=\"text-center text-muted-foreground py-8\">No leave balances found</p>\n                ) : (\n                  <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                    {leaveBalances?.map((balance) => {\n                      const employee = getEmployee(balance.employeeId);\n                      const leaveType = leaveTypes?.find((t) => t.id === balance.leaveTypeId);\n                      return (\n                        <Card key={balance.id} className=\"hover-elevate\">\n                          <CardHeader>\n                            <CardTitle className=\"text-lg\">\n                              {employee?.employeeId || \"Unknown\"}\n                            </CardTitle>\n                            <Badge variant=\"outline\">{leaveType?.name || \"Unknown Type\"}</Badge>\n                          </CardHeader>\n                          <CardContent className=\"space-y-2\">\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Total:</span>\n                              <span className=\"font-medium\">{balance.totalDays} days</span>\n                            </div>\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Used:</span>\n                              <span className=\"font-medium text-orange-600\">{balance.usedDays} days</span>\n                            </div>\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Remaining:</span>\n                              <span className=\"font-medium text-green-600\">{balance.remainingDays} days</span>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      );\n                    })}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* LEAVE TYPES TAB */}\n          <TabsContent value=\"types\" className=\"space-y-4\">\n            <div className=\"flex items-center justify-end\">\n              <Dialog open={typeCreateOpen} onOpenChange={setTypeCreateOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-create-type\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Leave Type\n                  </Button>\n                </DialogTrigger>\n                <DialogContent data-testid=\"dialog-create-type\">\n                  <DialogHeader>\n                    <DialogTitle>Add Leave Type</DialogTitle>\n                  </DialogHeader>\n                  <Form {...typeCreateForm}>\n                    <form onSubmit={typeCreateForm.handleSubmit(onTypeCreateSubmit)} className=\"space-y-4\">\n                      <FormField\n                        control={typeCreateForm.control}\n                        name=\"name\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Leave Type Name*</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Annual Leave\" data-testid=\"input-type-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={typeCreateForm.control}\n                        name=\"daysPerYear\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Days Per Year*</FormLabel>\n                            <FormControl>\n                              <Input\n                                {...field}\n                                type=\"number\"\n                                data-testid=\"input-days-per-year\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={typeCreateForm.control}\n                        name=\"carryForward\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Carry Forward</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-carry-forward\">\n                                  <SelectValue />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent position=\"popper\">\n                                <SelectItem value=\"yes\">Yes</SelectItem>\n                                <SelectItem value=\"no\">No</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={typeCreateForm.control}\n                        name=\"requiresApproval\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Requires Approval</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-requires-approval\">\n                                  <SelectValue />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent position=\"popper\">\n                                <SelectItem value=\"yes\">Yes</SelectItem>\n                                <SelectItem value=\"no\">No</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={typeCreateForm.control}\n                        name=\"isPaid\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Is Paid Leave</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-is-paid\">\n                                  <SelectValue />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent position=\"popper\">\n                                <SelectItem value=\"yes\">Yes</SelectItem>\n                                <SelectItem value=\"no\">No</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <div className=\"flex justify-end gap-2\">\n                        <Button type=\"button\" variant=\"outline\" onClick={() => setTypeCreateOpen(false)}>\n                          Cancel\n                        </Button>\n                        <Button type=\"submit\" disabled={typeCreateMutation.isPending} data-testid=\"button-submit-type\">\n                          {typeCreateMutation.isPending ? \"Creating...\" : \"Create Leave Type\"}\n                        </Button>\n                      </div>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {typesLoading ? (\n                <Card className=\"col-span-full\">\n                  <CardContent className=\"pt-6\">\n                    <p className=\"text-center text-muted-foreground\">Loading leave types...</p>\n                  </CardContent>\n                </Card>\n              ) : leaveTypes && leaveTypes.length === 0 ? (\n                <Card className=\"col-span-full\">\n                  <CardContent className=\"pt-6\">\n                    <p className=\"text-center text-muted-foreground\">No leave types configured</p>\n                  </CardContent>\n                </Card>\n              ) : (\n                leaveTypes?.map((type) => (\n                  <Card key={type.id} data-testid={`card-type-${type.id}`} className=\"hover-elevate\">\n                    <CardHeader>\n                      <CardTitle className=\"text-lg\">{type.name}</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2\">\n                      <div className=\"flex justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Days/Year:</span>\n                        <span className=\"font-medium\">{type.daysPerYear}</span>\n                      </div>\n                      <div className=\"flex justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Carry Forward:</span>\n                        <Badge variant={type.carryForward === \"yes\" ? \"default\" : \"outline\"}>\n                          {type.carryForward}\n                        </Badge>\n                      </div>\n                      <div className=\"flex justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Paid:</span>\n                        <Badge variant={type.isPaid === \"yes\" ? \"default\" : \"outline\"}>{type.isPaid}</Badge>\n                      </div>\n                      <div className=\"flex justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Approval Required:</span>\n                        <Badge variant={type.requiresApproval === \"yes\" ? \"default\" : \"outline\"}>\n                          {type.requiresApproval}\n                        </Badge>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))\n              )}\n            </div>\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":32686,"size_tokens":null},"client/src/pages/employees.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  UserPlus,\n  Edit,\n  Search,\n  Users,\n  Briefcase,\n  Phone,\n  MapPin,\n  Calendar,\n  CreditCard,\n  Building2,\n} from \"lucide-react\";\n\ntype Employee = {\n  id: string;\n  userId: string;\n  employeeId: string;\n  departmentId?: string;\n  designationId?: string;\n  joiningDate: string;\n  dateOfBirth?: string;\n  gender?: string;\n  phone?: string;\n  emergencyContact?: string;\n  address?: string;\n  photo?: string;\n  documents?: any[];\n  bankAccountNumber?: string;\n  bankName?: string;\n  status: string;\n  createdAt: string;\n};\n\ntype User = {\n  id: string;\n  fullName: string;\n  email: string;\n  role: string;\n};\n\ntype Department = {\n  id: string;\n  name: string;\n  description?: string;\n};\n\ntype Designation = {\n  id: string;\n  title: string;\n  departmentId?: string;\n  description?: string;\n};\n\nconst employeeSchema = z.object({\n  userId: z.string().min(1, \"User is required\"),\n  employeeId: z.string().min(1, \"Employee ID is required\"),\n  departmentId: z.string().optional(),\n  designationId: z.string().optional(),\n  joiningDate: z.string().min(1, \"Joining date is required\"),\n  dateOfBirth: z.string().optional(),\n  gender: z.string().optional(),\n  phone: z.string().optional(),\n  emergencyContact: z.string().optional(),\n  address: z.string().optional(),\n  bankAccountNumber: z.string().optional(),\n  bankName: z.string().optional(),\n  status: z.string().default(\"active\"),\n});\n\ntype EmployeeFormData = z.infer<typeof employeeSchema>;\n\nexport default function Employees() {\n  const { toast } = useToast();\n  const [createOpen, setCreateOpen] = useState(false);\n  const [editOpen, setEditOpen] = useState(false);\n  const [editingEmployee, setEditingEmployee] = useState<Employee | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n\n  const { data: employees, isLoading } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const { data: users } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: departments } = useQuery<Department[]>({\n    queryKey: [\"/api/departments\"],\n  });\n\n  const { data: designations } = useQuery<Designation[]>({\n    queryKey: [\"/api/designations\"],\n  });\n\n  const createForm = useForm<EmployeeFormData>({\n    resolver: zodResolver(employeeSchema),\n    defaultValues: {\n      employeeId: \"\",\n      userId: \"\",\n      status: \"active\",\n      joiningDate: new Date().toISOString().split(\"T\")[0],\n    },\n  });\n\n  const editForm = useForm<EmployeeFormData>({\n    resolver: zodResolver(employeeSchema),\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: EmployeeFormData) => {\n      return apiRequest(\"POST\", \"/api/employees\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      setCreateOpen(false);\n      createForm.reset();\n      toast({ title: \"Success\", description: \"Employee created successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: (data: { id: string; updates: Partial<EmployeeFormData> }) =>\n      apiRequest(\"PATCH\", `/api/employees/${data.id}`, data.updates),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      setEditOpen(false);\n      setEditingEmployee(null);\n      toast({ title: \"Success\", description: \"Employee updated successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onCreateSubmit = (data: EmployeeFormData) => {\n    createMutation.mutate(data);\n  };\n\n  const onEditSubmit = (data: EmployeeFormData) => {\n    if (!editingEmployee) return;\n    updateMutation.mutate({ id: editingEmployee.id, updates: data });\n  };\n\n  const handleEdit = (employee: Employee) => {\n    setEditingEmployee(employee);\n    editForm.reset({\n      userId: employee.userId,\n      employeeId: employee.employeeId,\n      departmentId: employee.departmentId || \"\",\n      designationId: employee.designationId || \"\",\n      joiningDate: employee.joiningDate?.split(\"T\")[0] || \"\",\n      dateOfBirth: employee.dateOfBirth?.split(\"T\")[0] || \"\",\n      gender: employee.gender || \"\",\n      phone: employee.phone || \"\",\n      emergencyContact: employee.emergencyContact || \"\",\n      address: employee.address || \"\",\n      bankAccountNumber: employee.bankAccountNumber || \"\",\n      bankName: employee.bankName || \"\",\n      status: employee.status,\n    });\n    setEditOpen(true);\n  };\n\n  // Get user details for an employee\n  const getUserForEmployee = (userId: string) => {\n    return users?.find((u) => u.id === userId);\n  };\n\n  // Get department name\n  const getDepartmentName = (deptId?: string) => {\n    if (!deptId) return \"Not Assigned\";\n    return departments?.find((d) => d.id === deptId)?.name || \"Unknown\";\n  };\n\n  // Get designation title\n  const getDesignationTitle = (desigId?: string) => {\n    if (!desigId) return \"Not Assigned\";\n    return designations?.find((d) => d.id === desigId)?.title || \"Unknown\";\n  };\n\n  // Get available users (who are not already employees)\n  const getAvailableUsers = () => {\n    if (!users || !employees) return [];\n    const employeeUserIds = employees.map((e) => e.userId);\n    return users.filter((u) => !employeeUserIds.includes(u.id));\n  };\n\n  // Filter employees\n  const filteredEmployees =\n    employees?.filter((employee) => {\n      const user = getUserForEmployee(employee.userId);\n      const matchesSearch =\n        employee.employeeId.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        user?.fullName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        user?.email.toLowerCase().includes(searchQuery.toLowerCase());\n      const matchesStatus = statusFilter === \"all\" || employee.status === statusFilter;\n      return matchesSearch && matchesStatus;\n    }) || [];\n\n  const statusColors: Record<string, string> = {\n    active: \"bg-green-500/10 text-green-700 dark:text-green-400\",\n    inactive: \"bg-gray-500/10 text-gray-700 dark:text-gray-400\",\n  };\n\n  const employeeStats = {\n    total: employees?.length || 0,\n    active: employees?.filter((e) => e.status === \"active\").length || 0,\n    inactive: employees?.filter((e) => e.status === \"inactive\").length || 0,\n  };\n\n  return (\n    <div className=\"h-full overflow-auto\">\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n          <div>\n            <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">\n              Employee Management\n            </h1>\n            <p className=\"text-muted-foreground\">Manage employee profiles and information</p>\n          </div>\n          <Dialog open={createOpen} onOpenChange={setCreateOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-create-employee\">\n                <UserPlus className=\"w-4 h-4 mr-2\" />\n                Add Employee\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-create-employee\">\n              <DialogHeader>\n                <DialogTitle>Add New Employee</DialogTitle>\n              </DialogHeader>\n              <Form {...createForm}>\n                <form onSubmit={createForm.handleSubmit(onCreateSubmit)} className=\"space-y-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"userId\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Select User*</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-userId\">\n                                <SelectValue placeholder=\"Select user\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent position=\"popper\">\n                              {getAvailableUsers().map((user) => (\n                                <SelectItem key={user.id} value={user.id}>\n                                  {user.fullName} ({user.email})\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={createForm.control}\n                      name=\"employeeId\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Employee ID*</FormLabel>\n                          <FormControl>\n                            <Input {...field} placeholder=\"EMP001\" data-testid=\"input-employeeId\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"departmentId\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Department</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-departmentId\">\n                                <SelectValue placeholder=\"Select department\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent position=\"popper\">\n                              {departments?.map((dept) => (\n                                <SelectItem key={dept.id} value={dept.id}>\n                                  {dept.name}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={createForm.control}\n                      name=\"designationId\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Designation</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-designationId\">\n                                <SelectValue placeholder=\"Select designation\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent position=\"popper\">\n                              {designations?.map((desig) => (\n                                <SelectItem key={desig.id} value={desig.id}>\n                                  {desig.title}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"joiningDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Joining Date*</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"date\" data-testid=\"input-joiningDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={createForm.control}\n                      name=\"dateOfBirth\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Date of Birth</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"date\" data-testid=\"input-dateOfBirth\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"gender\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Gender</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-gender\">\n                                <SelectValue placeholder=\"Select gender\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent position=\"popper\">\n                              <SelectItem value=\"male\">Male</SelectItem>\n                              <SelectItem value=\"female\">Female</SelectItem>\n                              <SelectItem value=\"other\">Other</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={createForm.control}\n                      name=\"phone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Phone</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"tel\" placeholder=\"+880123456789\" data-testid=\"input-phone\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={createForm.control}\n                    name=\"emergencyContact\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Emergency Contact</FormLabel>\n                        <FormControl>\n                          <Input {...field} placeholder=\"Emergency contact number\" data-testid=\"input-emergencyContact\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={createForm.control}\n                    name=\"address\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Address</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} placeholder=\"Full address\" data-testid=\"input-address\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"bankName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Bank Name</FormLabel>\n                          <FormControl>\n                            <Input {...field} placeholder=\"Bank name\" data-testid=\"input-bankName\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={createForm.control}\n                      name=\"bankAccountNumber\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Bank Account Number</FormLabel>\n                          <FormControl>\n                            <Input {...field} placeholder=\"Account number\" data-testid=\"input-bankAccountNumber\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={createForm.control}\n                    name=\"status\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Status</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-status\">\n                              <SelectValue />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            <SelectItem value=\"active\">Active</SelectItem>\n                            <SelectItem value=\"inactive\">Inactive</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"flex justify-end gap-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setCreateOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit-create\">\n                      {createMutation.isPending ? \"Creating...\" : \"Create Employee\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        {/* Statistics Cards */}\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Employees</CardTitle>\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-total-employees\">\n                {employeeStats.total}\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Active</CardTitle>\n              <Users className=\"h-4 w-4 text-green-600\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-active-employees\">\n                {employeeStats.active}\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Inactive</CardTitle>\n              <Users className=\"h-4 w-4 text-gray-600\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-gray-600\" data-testid=\"text-inactive-employees\">\n                {employeeStats.inactive}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Search and Filter */}\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex gap-4 flex-wrap\">\n              <div className=\"flex-1 min-w-[200px]\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search by employee ID, name, or email...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-search\"\n                  />\n                </div>\n              </div>\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger className=\"w-[180px]\" data-testid=\"select-status-filter\">\n                  <SelectValue placeholder=\"Filter by status\" />\n                </SelectTrigger>\n                <SelectContent position=\"popper\">\n                  <SelectItem value=\"all\">All Status</SelectItem>\n                  <SelectItem value=\"active\">Active</SelectItem>\n                  <SelectItem value=\"inactive\">Inactive</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Employees List */}\n        {isLoading ? (\n          <Card>\n            <CardContent className=\"pt-6\">\n              <p className=\"text-center text-muted-foreground\">Loading employees...</p>\n            </CardContent>\n          </Card>\n        ) : filteredEmployees.length === 0 ? (\n          <Card>\n            <CardContent className=\"pt-6\">\n              <p className=\"text-center text-muted-foreground\">No employees found</p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n            {filteredEmployees.map((employee) => {\n              const user = getUserForEmployee(employee.userId);\n              return (\n                <Card key={employee.id} data-testid={`card-employee-${employee.id}`} className=\"hover-elevate\">\n                  <CardHeader>\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"space-y-1 flex-1 min-w-0\">\n                        <CardTitle className=\"text-lg truncate\" data-testid={`text-employee-name-${employee.id}`}>\n                          {user?.fullName || \"Unknown\"}\n                        </CardTitle>\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <Badge className=\"text-xs\" variant=\"outline\">\n                            {employee.employeeId}\n                          </Badge>\n                          <Badge className={statusColors[employee.status]} data-testid={`badge-status-${employee.id}`}>\n                            {employee.status}\n                          </Badge>\n                        </div>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    <div className=\"space-y-2 text-sm\">\n                      <div className=\"flex items-center gap-2 text-muted-foreground\">\n                        <Building2 className=\"w-4 h-4 flex-shrink-0\" />\n                        <span className=\"truncate\">{getDepartmentName(employee.departmentId)}</span>\n                      </div>\n                      <div className=\"flex items-center gap-2 text-muted-foreground\">\n                        <Briefcase className=\"w-4 h-4 flex-shrink-0\" />\n                        <span className=\"truncate\">{getDesignationTitle(employee.designationId)}</span>\n                      </div>\n                      {employee.phone && (\n                        <div className=\"flex items-center gap-2 text-muted-foreground\">\n                          <Phone className=\"w-4 h-4 flex-shrink-0\" />\n                          <span className=\"truncate\">{employee.phone}</span>\n                        </div>\n                      )}\n                      <div className=\"flex items-center gap-2 text-muted-foreground\">\n                        <Calendar className=\"w-4 h-4 flex-shrink-0\" />\n                        <span className=\"text-xs\">\n                          Joined {new Date(employee.joiningDate).toLocaleDateString()}\n                        </span>\n                      </div>\n                      {employee.bankAccountNumber && (\n                        <div className=\"flex items-center gap-2 text-muted-foreground\">\n                          <CreditCard className=\"w-4 h-4 flex-shrink-0\" />\n                          <span className=\"truncate text-xs\">{employee.bankName}</span>\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"pt-2\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => handleEdit(employee)}\n                        className=\"w-full\"\n                        data-testid={`button-edit-${employee.id}`}\n                      >\n                        <Edit className=\"w-4 h-4 mr-1\" />\n                        Edit Details\n                      </Button>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        )}\n\n        {/* Edit Dialog */}\n        <Dialog open={editOpen} onOpenChange={setEditOpen}>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-edit-employee\">\n            <DialogHeader>\n              <DialogTitle>Edit Employee</DialogTitle>\n            </DialogHeader>\n            <Form {...editForm}>\n              <form onSubmit={editForm.handleSubmit(onEditSubmit)} className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={editForm.control}\n                    name=\"employeeId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Employee ID*</FormLabel>\n                        <FormControl>\n                          <Input {...field} placeholder=\"EMP001\" data-testid=\"input-edit-employeeId\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={editForm.control}\n                    name=\"status\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Status</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-edit-status\">\n                              <SelectValue />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            <SelectItem value=\"active\">Active</SelectItem>\n                            <SelectItem value=\"inactive\">Inactive</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={editForm.control}\n                    name=\"departmentId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Department</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-edit-departmentId\">\n                              <SelectValue placeholder=\"Select department\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            {departments?.map((dept) => (\n                              <SelectItem key={dept.id} value={dept.id}>\n                                {dept.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={editForm.control}\n                    name=\"designationId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Designation</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-edit-designationId\">\n                              <SelectValue placeholder=\"Select designation\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            {designations?.map((desig) => (\n                              <SelectItem key={desig.id} value={desig.id}>\n                                {desig.title}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={editForm.control}\n                    name=\"joiningDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Joining Date*</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"date\" data-testid=\"input-edit-joiningDate\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={editForm.control}\n                    name=\"dateOfBirth\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Date of Birth</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"date\" data-testid=\"input-edit-dateOfBirth\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={editForm.control}\n                    name=\"gender\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Gender</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-edit-gender\">\n                              <SelectValue placeholder=\"Select gender\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            <SelectItem value=\"male\">Male</SelectItem>\n                            <SelectItem value=\"female\">Female</SelectItem>\n                            <SelectItem value=\"other\">Other</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={editForm.control}\n                    name=\"phone\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Phone</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"tel\" placeholder=\"+880123456789\" data-testid=\"input-edit-phone\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={editForm.control}\n                  name=\"emergencyContact\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Emergency Contact</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"Emergency contact number\" data-testid=\"input-edit-emergencyContact\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={editForm.control}\n                  name=\"address\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Address</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} placeholder=\"Full address\" data-testid=\"input-edit-address\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={editForm.control}\n                    name=\"bankName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Bank Name</FormLabel>\n                        <FormControl>\n                          <Input {...field} placeholder=\"Bank name\" data-testid=\"input-edit-bankName\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={editForm.control}\n                    name=\"bankAccountNumber\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Bank Account Number</FormLabel>\n                        <FormControl>\n                          <Input {...field} placeholder=\"Account number\" data-testid=\"input-edit-bankAccountNumber\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"flex justify-end gap-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setEditOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-submit-edit\">\n                    {updateMutation.isPending ? \"Updating...\" : \"Update Employee\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":36935,"size_tokens":null},"client/src/pages/payroll.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Plus,\n  DollarSign,\n  TrendingUp,\n  Calendar,\n  Users,\n  FileText,\n} from \"lucide-react\";\n\ntype SalaryStructure = {\n  id: string;\n  employeeId: string;\n  basicSalary: string;\n  houseAllowance: string;\n  transportAllowance: string;\n  medicalAllowance: string;\n  otherAllowances: string;\n  effectiveFrom: string;\n  createdAt: string;\n};\n\ntype Payroll = {\n  id: string;\n  employeeId: string;\n  month: number;\n  year: number;\n  basicSalary: string;\n  totalAllowances: string;\n  totalDeductions: string;\n  netSalary: string;\n  status: string;\n  paidAt?: string;\n  createdAt: string;\n};\n\ntype Employee = {\n  id: string;\n  employeeId: string;\n  userId: string;\n};\n\nconst salaryStructureSchema = z.object({\n  employeeId: z.string().min(1, \"Employee is required\"),\n  basicSalary: z.coerce.number().min(0, \"Basic salary must be 0 or greater\"),\n  houseAllowance: z.coerce.number().min(0).default(0),\n  transportAllowance: z.coerce.number().min(0).default(0),\n  medicalAllowance: z.coerce.number().min(0).default(0),\n  otherAllowances: z.coerce.number().min(0).default(0),\n  effectiveFrom: z.string().min(1, \"Effective date is required\"),\n});\n\ntype SalaryStructureFormData = z.infer<typeof salaryStructureSchema>;\n\nexport default function Payroll() {\n  const { toast } = useToast();\n  const [structureCreateOpen, setStructureCreateOpen] = useState(false);\n  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);\n  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());\n\n  const { data: salaryStructures, isLoading: structuresLoading } = useQuery<SalaryStructure[]>({\n    queryKey: [\"/api/salary-structure\"],\n  });\n\n  const { data: payrollRecords, isLoading: payrollLoading } = useQuery<Payroll[]>({\n    queryKey: [\"/api/payroll\", { month: selectedMonth, year: selectedYear }],\n  });\n\n  const { data: employees } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const structureCreateForm = useForm<SalaryStructureFormData>({\n    resolver: zodResolver(salaryStructureSchema),\n    defaultValues: {\n      employeeId: \"\",\n      basicSalary: 0,\n      houseAllowance: 0,\n      transportAllowance: 0,\n      medicalAllowance: 0,\n      otherAllowances: 0,\n      effectiveFrom: new Date().toISOString().split(\"T\")[0],\n    },\n  });\n\n  const structureCreateMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return apiRequest(\"POST\", \"/api/salary-structure\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/salary-structure\"] });\n      setStructureCreateOpen(false);\n      structureCreateForm.reset();\n      toast({ title: \"Success\", description: \"Salary structure created successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const generatePayrollMutation = useMutation({\n    mutationFn: (data: { month: number; year: number }) =>\n      apiRequest(\"POST\", \"/api/payroll/generate\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payroll\"] });\n      toast({ title: \"Success\", description: \"Payroll generated successfully for all employees\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onStructureCreateSubmit = (data: SalaryStructureFormData) => {\n    // Convert numeric salary fields to strings for backend API\n    const payload = {\n      ...data,\n      basicSalary: String(data.basicSalary),\n      houseAllowance: String(data.houseAllowance),\n      transportAllowance: String(data.transportAllowance),\n      medicalAllowance: String(data.medicalAllowance),\n      otherAllowances: String(data.otherAllowances),\n    };\n    structureCreateMutation.mutate(payload);\n  };\n\n  const handleGeneratePayroll = () => {\n    if (\n      confirm(\n        `Generate payroll for ${getMonthName(selectedMonth)} ${selectedYear}?\\nThis will create payroll records for all employees with salary structures.`\n      )\n    ) {\n      generatePayrollMutation.mutate({ month: selectedMonth, year: selectedYear });\n    }\n  };\n\n  // Get employee by ID\n  const getEmployee = (empId: string) => {\n    return employees?.find((e) => e.id === empId);\n  };\n\n  const getMonthName = (month: number) => {\n    const months = [\n      \"January\",\n      \"February\",\n      \"March\",\n      \"April\",\n      \"May\",\n      \"June\",\n      \"July\",\n      \"August\",\n      \"September\",\n      \"October\",\n      \"November\",\n      \"December\",\n    ];\n    return months[month - 1];\n  };\n\n  const statusColors: Record<string, string> = {\n    pending: \"bg-yellow-500/10 text-yellow-700 dark:text-yellow-400\",\n    approved: \"bg-blue-500/10 text-blue-700 dark:text-blue-400\",\n    paid: \"bg-green-500/10 text-green-700 dark:text-green-400\",\n    rejected: \"bg-red-500/10 text-red-700 dark:text-red-400\",\n  };\n\n  const payrollStats = {\n    total: payrollRecords?.length || 0,\n    pending: payrollRecords?.filter((p) => p.status === \"pending\").length || 0,\n    paid: payrollRecords?.filter((p) => p.status === \"paid\").length || 0,\n    totalAmount:\n      payrollRecords?.reduce((sum, p) => sum + parseFloat(p.netSalary || \"0\"), 0) || 0,\n  };\n\n  const months = Array.from({ length: 12 }, (_, i) => i + 1);\n  const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - i);\n\n  return (\n    <div className=\"h-full overflow-auto\">\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">\n            Payroll Management\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Manage salary structures, generate payroll, and track payments\n          </p>\n        </div>\n\n        <Tabs defaultValue=\"payroll\" className=\"w-full\">\n          <TabsList>\n            <TabsTrigger value=\"payroll\" data-testid=\"tab-payroll\">\n              <DollarSign className=\"w-4 h-4 mr-2\" />\n              Payroll Records\n            </TabsTrigger>\n            <TabsTrigger value=\"structure\" data-testid=\"tab-structure\">\n              <TrendingUp className=\"w-4 h-4 mr-2\" />\n              Salary Structure\n            </TabsTrigger>\n          </TabsList>\n\n          {/* PAYROLL RECORDS TAB */}\n          <TabsContent value=\"payroll\" className=\"space-y-4\">\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Total Records</CardTitle>\n                  <Users className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{payrollStats.total}</div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Pending</CardTitle>\n                  <Calendar className=\"h-4 w-4 text-yellow-600\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-yellow-600\">{payrollStats.pending}</div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Paid</CardTitle>\n                  <FileText className=\"h-4 w-4 text-green-600\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-green-600\">{payrollStats.paid}</div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Total Amount</CardTitle>\n                  <DollarSign className=\"h-4 w-4 text-blue-600\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-blue-600\">\n                    {payrollStats.totalAmount.toLocaleString()}\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                  <CardTitle>Payroll for {getMonthName(selectedMonth)} {selectedYear}</CardTitle>\n                  <div className=\"flex gap-2 flex-wrap\">\n                    <Select\n                      value={selectedMonth.toString()}\n                      onValueChange={(val) => setSelectedMonth(parseInt(val))}\n                    >\n                      <SelectTrigger className=\"w-[140px]\" data-testid=\"select-month\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent position=\"popper\">\n                        {months.map((month) => (\n                          <SelectItem key={month} value={month.toString()}>\n                            {getMonthName(month)}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <Select\n                      value={selectedYear.toString()}\n                      onValueChange={(val) => setSelectedYear(parseInt(val))}\n                    >\n                      <SelectTrigger className=\"w-[100px]\" data-testid=\"select-year\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent position=\"popper\">\n                        {years.map((year) => (\n                          <SelectItem key={year} value={year.toString()}>\n                            {year}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <Button\n                      onClick={handleGeneratePayroll}\n                      disabled={generatePayrollMutation.isPending}\n                      data-testid=\"button-generate-payroll\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-2\" />\n                      Generate Payroll\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {payrollLoading ? (\n                  <p className=\"text-center text-muted-foreground py-8\">Loading payroll...</p>\n                ) : payrollRecords && payrollRecords.length === 0 ? (\n                  <p className=\"text-center text-muted-foreground py-8\">\n                    No payroll records for this period\n                  </p>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {payrollRecords?.map((record) => {\n                      const employee = getEmployee(record.employeeId);\n                      return (\n                        <Card key={record.id} className=\"hover-elevate\">\n                          <CardContent className=\"pt-4\">\n                            <div className=\"space-y-3\">\n                              <div className=\"flex items-start justify-between gap-4\">\n                                <div className=\"space-y-2 flex-1\">\n                                  <div className=\"font-medium\">\n                                    {employee?.employeeId || \"Unknown Employee\"}\n                                  </div>\n                                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                                    <div>\n                                      <div className=\"text-muted-foreground\">Basic Salary</div>\n                                      <div className=\"font-medium\">{parseFloat(record.basicSalary).toLocaleString()}</div>\n                                    </div>\n                                    <div>\n                                      <div className=\"text-muted-foreground\">Allowances</div>\n                                      <div className=\"font-medium text-green-600\">\n                                        +{parseFloat(record.totalAllowances).toLocaleString()}\n                                      </div>\n                                    </div>\n                                    <div>\n                                      <div className=\"text-muted-foreground\">Deductions</div>\n                                      <div className=\"font-medium text-red-600\">\n                                        -{parseFloat(record.totalDeductions).toLocaleString()}\n                                      </div>\n                                    </div>\n                                    <div>\n                                      <div className=\"text-muted-foreground\">Net Salary</div>\n                                      <div className=\"font-bold text-lg\">\n                                        {parseFloat(record.netSalary).toLocaleString()}\n                                      </div>\n                                    </div>\n                                  </div>\n                                  {record.paidAt && (\n                                    <div className=\"text-xs text-muted-foreground\">\n                                      Paid on {new Date(record.paidAt).toLocaleDateString()}\n                                    </div>\n                                  )}\n                                </div>\n                                <Badge className={statusColors[record.status]}>{record.status}</Badge>\n                              </div>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      );\n                    })}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* SALARY STRUCTURE TAB */}\n          <TabsContent value=\"structure\" className=\"space-y-4\">\n            <div className=\"flex items-center justify-end\">\n              <Dialog open={structureCreateOpen} onOpenChange={setStructureCreateOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-create-structure\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Salary Structure\n                  </Button>\n                </DialogTrigger>\n                <DialogContent data-testid=\"dialog-create-structure\">\n                  <DialogHeader>\n                    <DialogTitle>Add Salary Structure</DialogTitle>\n                  </DialogHeader>\n                  <Form {...structureCreateForm}>\n                    <form onSubmit={structureCreateForm.handleSubmit(onStructureCreateSubmit)} className=\"space-y-4\">\n                      <FormField\n                        control={structureCreateForm.control}\n                        name=\"employeeId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Employee*</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-employee\">\n                                  <SelectValue placeholder=\"Select employee\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent position=\"popper\">\n                                {employees?.map((emp) => (\n                                  <SelectItem key={emp.id} value={emp.id}>\n                                    {emp.employeeId}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={structureCreateForm.control}\n                        name=\"basicSalary\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Basic Salary*</FormLabel>\n                            <FormControl>\n                              <Input\n                                {...field}\n                                type=\"number\"\n                                step=\"0.01\"\n                                data-testid=\"input-basic-salary\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <FormField\n                          control={structureCreateForm.control}\n                          name=\"houseAllowance\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>House Allowance</FormLabel>\n                              <FormControl>\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  data-testid=\"input-house-allowance\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={structureCreateForm.control}\n                          name=\"transportAllowance\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Transport Allowance</FormLabel>\n                              <FormControl>\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  data-testid=\"input-transport-allowance\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <FormField\n                          control={structureCreateForm.control}\n                          name=\"medicalAllowance\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Medical Allowance</FormLabel>\n                              <FormControl>\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  data-testid=\"input-medical-allowance\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={structureCreateForm.control}\n                          name=\"otherAllowances\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Other Allowances</FormLabel>\n                              <FormControl>\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  data-testid=\"input-other-allowances\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </div>\n                      <FormField\n                        control={structureCreateForm.control}\n                        name=\"effectiveFrom\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Effective From*</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"date\" data-testid=\"input-effective-from\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <div className=\"flex justify-end gap-2\">\n                        <Button type=\"button\" variant=\"outline\" onClick={() => setStructureCreateOpen(false)}>\n                          Cancel\n                        </Button>\n                        <Button type=\"submit\" disabled={structureCreateMutation.isPending} data-testid=\"button-submit-structure\">\n                          {structureCreateMutation.isPending ? \"Creating...\" : \"Create Structure\"}\n                        </Button>\n                      </div>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {structuresLoading ? (\n                <Card className=\"col-span-full\">\n                  <CardContent className=\"pt-6\">\n                    <p className=\"text-center text-muted-foreground\">Loading salary structures...</p>\n                  </CardContent>\n                </Card>\n              ) : salaryStructures && salaryStructures.length === 0 ? (\n                <Card className=\"col-span-full\">\n                  <CardContent className=\"pt-6\">\n                    <p className=\"text-center text-muted-foreground\">No salary structures configured</p>\n                  </CardContent>\n                </Card>\n              ) : (\n                salaryStructures?.map((structure) => {\n                  const employee = getEmployee(structure.employeeId);\n                  const totalAllowances =\n                    parseFloat(structure.houseAllowance || \"0\") +\n                    parseFloat(structure.transportAllowance || \"0\") +\n                    parseFloat(structure.medicalAllowance || \"0\") +\n                    parseFloat(structure.otherAllowances || \"0\");\n                  const grossSalary = parseFloat(structure.basicSalary) + totalAllowances;\n\n                  return (\n                    <Card key={structure.id} data-testid={`card-structure-${structure.id}`} className=\"hover-elevate\">\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">\n                          {employee?.employeeId || \"Unknown Employee\"}\n                        </CardTitle>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          Effective from {new Date(structure.effectiveFrom).toLocaleDateString()}\n                        </Badge>\n                      </CardHeader>\n                      <CardContent className=\"space-y-2\">\n                        <div className=\"flex justify-between text-sm\">\n                          <span className=\"text-muted-foreground\">Basic Salary:</span>\n                          <span className=\"font-medium\">{parseFloat(structure.basicSalary).toLocaleString()}</span>\n                        </div>\n                        <div className=\"flex justify-between text-sm\">\n                          <span className=\"text-muted-foreground\">House:</span>\n                          <span>{parseFloat(structure.houseAllowance).toLocaleString()}</span>\n                        </div>\n                        <div className=\"flex justify-between text-sm\">\n                          <span className=\"text-muted-foreground\">Transport:</span>\n                          <span>{parseFloat(structure.transportAllowance).toLocaleString()}</span>\n                        </div>\n                        <div className=\"flex justify-between text-sm\">\n                          <span className=\"text-muted-foreground\">Medical:</span>\n                          <span>{parseFloat(structure.medicalAllowance).toLocaleString()}</span>\n                        </div>\n                        {parseFloat(structure.otherAllowances) > 0 && (\n                          <div className=\"flex justify-between text-sm\">\n                            <span className=\"text-muted-foreground\">Other:</span>\n                            <span>{parseFloat(structure.otherAllowances).toLocaleString()}</span>\n                          </div>\n                        )}\n                        <div className=\"pt-2 border-t\">\n                          <div className=\"flex justify-between text-sm font-bold\">\n                            <span>Gross Salary:</span>\n                            <span className=\"text-lg\">{grossSalary.toLocaleString()}</span>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  );\n                })\n              )}\n            </div>\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":26691,"size_tokens":null},"client/src/pages/departments.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Plus,\n  Edit,\n  Trash2,\n  Search,\n  Building2,\n  Briefcase,\n  Users,\n} from \"lucide-react\";\n\ntype Department = {\n  id: string;\n  name: string;\n  description?: string;\n  createdAt: string;\n};\n\ntype Designation = {\n  id: string;\n  title: string;\n  departmentId?: string;\n  description?: string;\n  createdAt: string;\n};\n\nconst departmentSchema = z.object({\n  name: z.string().min(1, \"Department name is required\"),\n  description: z.string().optional(),\n});\n\nconst designationSchema = z.object({\n  title: z.string().min(1, \"Designation title is required\"),\n  departmentId: z.string().optional(),\n  description: z.string().optional(),\n});\n\ntype DepartmentFormData = z.infer<typeof departmentSchema>;\ntype DesignationFormData = z.infer<typeof designationSchema>;\n\nexport default function Departments() {\n  const { toast } = useToast();\n  const [deptCreateOpen, setDeptCreateOpen] = useState(false);\n  const [deptEditOpen, setDeptEditOpen] = useState(false);\n  const [editingDept, setEditingDept] = useState<Department | null>(null);\n  const [deptSearchQuery, setDeptSearchQuery] = useState(\"\");\n\n  const [desigCreateOpen, setDesigCreateOpen] = useState(false);\n  const [desigEditOpen, setDesigEditOpen] = useState(false);\n  const [editingDesig, setEditingDesig] = useState<Designation | null>(null);\n  const [desigSearchQuery, setDesigSearchQuery] = useState(\"\");\n  const [desigDeptFilter, setDesigDeptFilter] = useState(\"all\");\n\n  const { data: departments, isLoading: deptLoading } = useQuery<Department[]>({\n    queryKey: [\"/api/departments\"],\n  });\n\n  const { data: designations, isLoading: desigLoading } = useQuery<Designation[]>({\n    queryKey: [\"/api/designations\"],\n  });\n\n  const deptCreateForm = useForm<DepartmentFormData>({\n    resolver: zodResolver(departmentSchema),\n    defaultValues: { name: \"\", description: \"\" },\n  });\n\n  const deptEditForm = useForm<DepartmentFormData>({\n    resolver: zodResolver(departmentSchema),\n  });\n\n  const desigCreateForm = useForm<DesignationFormData>({\n    resolver: zodResolver(designationSchema),\n    defaultValues: { title: \"\", description: \"\", departmentId: \"\" },\n  });\n\n  const desigEditForm = useForm<DesignationFormData>({\n    resolver: zodResolver(designationSchema),\n  });\n\n  // Department Mutations\n  const deptCreateMutation = useMutation({\n    mutationFn: async (data: DepartmentFormData) => {\n      return apiRequest(\"POST\", \"/api/departments\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/departments\"] });\n      setDeptCreateOpen(false);\n      deptCreateForm.reset();\n      toast({ title: \"Success\", description: \"Department created successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deptUpdateMutation = useMutation({\n    mutationFn: (data: { id: string; updates: Partial<DepartmentFormData> }) =>\n      apiRequest(\"PATCH\", `/api/departments/${data.id}`, data.updates),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/departments\"] });\n      setDeptEditOpen(false);\n      setEditingDept(null);\n      toast({ title: \"Success\", description: \"Department updated successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deptDeleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/departments/${id}`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/departments\"] });\n      toast({ title: \"Success\", description: \"Department deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // Designation Mutations\n  const desigCreateMutation = useMutation({\n    mutationFn: async (data: DesignationFormData) => {\n      return apiRequest(\"POST\", \"/api/designations\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/designations\"] });\n      setDesigCreateOpen(false);\n      desigCreateForm.reset();\n      toast({ title: \"Success\", description: \"Designation created successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const desigUpdateMutation = useMutation({\n    mutationFn: (data: { id: string; updates: Partial<DesignationFormData> }) =>\n      apiRequest(\"PATCH\", `/api/designations/${data.id}`, data.updates),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/designations\"] });\n      setDesigEditOpen(false);\n      setEditingDesig(null);\n      toast({ title: \"Success\", description: \"Designation updated successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const desigDeleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/designations/${id}`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/designations\"] });\n      toast({ title: \"Success\", description: \"Designation deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // Department Handlers\n  const onDeptCreateSubmit = (data: DepartmentFormData) => {\n    deptCreateMutation.mutate(data);\n  };\n\n  const onDeptEditSubmit = (data: DepartmentFormData) => {\n    if (!editingDept) return;\n    deptUpdateMutation.mutate({ id: editingDept.id, updates: data });\n  };\n\n  const handleDeptEdit = (dept: Department) => {\n    setEditingDept(dept);\n    deptEditForm.reset({\n      name: dept.name,\n      description: dept.description || \"\",\n    });\n    setDeptEditOpen(true);\n  };\n\n  const handleDeptDelete = (id: string) => {\n    if (confirm(\"Are you sure you want to delete this department?\")) {\n      deptDeleteMutation.mutate(id);\n    }\n  };\n\n  // Designation Handlers\n  const onDesigCreateSubmit = (data: DesignationFormData) => {\n    desigCreateMutation.mutate(data);\n  };\n\n  const onDesigEditSubmit = (data: DesignationFormData) => {\n    if (!editingDesig) return;\n    desigUpdateMutation.mutate({ id: editingDesig.id, updates: data });\n  };\n\n  const handleDesigEdit = (desig: Designation) => {\n    setEditingDesig(desig);\n    desigEditForm.reset({\n      title: desig.title,\n      departmentId: desig.departmentId || \"\",\n      description: desig.description || \"\",\n    });\n    setDesigEditOpen(true);\n  };\n\n  const handleDesigDelete = (id: string) => {\n    if (confirm(\"Are you sure you want to delete this designation?\")) {\n      desigDeleteMutation.mutate(id);\n    }\n  };\n\n  // Get department name\n  const getDepartmentName = (deptId?: string) => {\n    if (!deptId) return \"No Department\";\n    return departments?.find((d) => d.id === deptId)?.name || \"Unknown\";\n  };\n\n  // Count designations per department\n  const getDesignationsCount = (deptId: string) => {\n    return designations?.filter((d) => d.departmentId === deptId).length || 0;\n  };\n\n  // Filter departments\n  const filteredDepartments =\n    departments?.filter((dept) =>\n      dept.name.toLowerCase().includes(deptSearchQuery.toLowerCase())\n    ) || [];\n\n  // Filter designations\n  const filteredDesignations =\n    designations?.filter((desig) => {\n      const matchesSearch = desig.title.toLowerCase().includes(desigSearchQuery.toLowerCase());\n      const matchesDept =\n        desigDeptFilter === \"all\" || desig.departmentId === desigDeptFilter;\n      return matchesSearch && matchesDept;\n    }) || [];\n\n  return (\n    <div className=\"h-full overflow-auto\">\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">\n            Department & Designation Management\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Organize your workforce with departments and designations\n          </p>\n        </div>\n\n        <Tabs defaultValue=\"departments\" className=\"w-full\">\n          <TabsList>\n            <TabsTrigger value=\"departments\" data-testid=\"tab-departments\">\n              <Building2 className=\"w-4 h-4 mr-2\" />\n              Departments\n            </TabsTrigger>\n            <TabsTrigger value=\"designations\" data-testid=\"tab-designations\">\n              <Briefcase className=\"w-4 h-4 mr-2\" />\n              Designations\n            </TabsTrigger>\n          </TabsList>\n\n          {/* DEPARTMENTS TAB */}\n          <TabsContent value=\"departments\" className=\"space-y-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <div className=\"flex-1 min-w-[200px]\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search departments...\"\n                    value={deptSearchQuery}\n                    onChange={(e) => setDeptSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-dept-search\"\n                  />\n                </div>\n              </div>\n              <Dialog open={deptCreateOpen} onOpenChange={setDeptCreateOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-create-dept\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Department\n                  </Button>\n                </DialogTrigger>\n                <DialogContent data-testid=\"dialog-create-dept\">\n                  <DialogHeader>\n                    <DialogTitle>Add New Department</DialogTitle>\n                  </DialogHeader>\n                  <Form {...deptCreateForm}>\n                    <form onSubmit={deptCreateForm.handleSubmit(onDeptCreateSubmit)} className=\"space-y-4\">\n                      <FormField\n                        control={deptCreateForm.control}\n                        name=\"name\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Department Name*</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Engineering\" data-testid=\"input-dept-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={deptCreateForm.control}\n                        name=\"description\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Description</FormLabel>\n                            <FormControl>\n                              <Textarea\n                                {...field}\n                                placeholder=\"Department description\"\n                                data-testid=\"input-dept-description\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <div className=\"flex justify-end gap-2\">\n                        <Button type=\"button\" variant=\"outline\" onClick={() => setDeptCreateOpen(false)}>\n                          Cancel\n                        </Button>\n                        <Button type=\"submit\" disabled={deptCreateMutation.isPending} data-testid=\"button-submit-dept\">\n                          {deptCreateMutation.isPending ? \"Creating...\" : \"Create Department\"}\n                        </Button>\n                      </div>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Building2 className=\"w-5 h-5\" />\n                  Departments ({filteredDepartments.length})\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {deptLoading ? (\n                  <p className=\"text-center text-muted-foreground py-8\">Loading departments...</p>\n                ) : filteredDepartments.length === 0 ? (\n                  <p className=\"text-center text-muted-foreground py-8\">No departments found</p>\n                ) : (\n                  <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                    {filteredDepartments.map((dept) => (\n                      <Card key={dept.id} data-testid={`card-dept-${dept.id}`} className=\"hover-elevate\">\n                        <CardHeader>\n                          <div className=\"flex items-start justify-between gap-2\">\n                            <div className=\"space-y-1 flex-1 min-w-0\">\n                              <CardTitle className=\"text-lg truncate\" data-testid={`text-dept-name-${dept.id}`}>\n                                {dept.name}\n                              </CardTitle>\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                <Users className=\"w-3 h-3 mr-1\" />\n                                {getDesignationsCount(dept.id)} Designations\n                              </Badge>\n                            </div>\n                          </div>\n                        </CardHeader>\n                        <CardContent className=\"space-y-3\">\n                          {dept.description && (\n                            <p className=\"text-sm text-muted-foreground line-clamp-2\">{dept.description}</p>\n                          )}\n                          <div className=\"text-xs text-muted-foreground\">\n                            Created {new Date(dept.createdAt).toLocaleDateString()}\n                          </div>\n                          <div className=\"flex gap-2\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleDeptEdit(dept)}\n                              className=\"flex-1\"\n                              data-testid={`button-edit-dept-${dept.id}`}\n                            >\n                              <Edit className=\"w-4 h-4 mr-1\" />\n                              Edit\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              variant=\"ghost\"\n                              onClick={() => handleDeptDelete(dept.id)}\n                              data-testid={`button-delete-dept-${dept.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </Button>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* DESIGNATIONS TAB */}\n          <TabsContent value=\"designations\" className=\"space-y-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <div className=\"flex gap-4 flex-wrap flex-1\">\n                <div className=\"flex-1 min-w-[200px]\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Search designations...\"\n                      value={desigSearchQuery}\n                      onChange={(e) => setDesigSearchQuery(e.target.value)}\n                      className=\"pl-9\"\n                      data-testid=\"input-desig-search\"\n                    />\n                  </div>\n                </div>\n                <Select value={desigDeptFilter} onValueChange={setDesigDeptFilter}>\n                  <SelectTrigger className=\"w-[200px]\" data-testid=\"select-desig-dept-filter\">\n                    <SelectValue placeholder=\"Filter by department\" />\n                  </SelectTrigger>\n                  <SelectContent position=\"popper\">\n                    <SelectItem value=\"all\">All Departments</SelectItem>\n                    {departments?.map((dept) => (\n                      <SelectItem key={dept.id} value={dept.id}>\n                        {dept.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <Dialog open={desigCreateOpen} onOpenChange={setDesigCreateOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-create-desig\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Designation\n                  </Button>\n                </DialogTrigger>\n                <DialogContent data-testid=\"dialog-create-desig\">\n                  <DialogHeader>\n                    <DialogTitle>Add New Designation</DialogTitle>\n                  </DialogHeader>\n                  <Form {...desigCreateForm}>\n                    <form onSubmit={desigCreateForm.handleSubmit(onDesigCreateSubmit)} className=\"space-y-4\">\n                      <FormField\n                        control={desigCreateForm.control}\n                        name=\"title\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Designation Title*</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Senior Developer\" data-testid=\"input-desig-title\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={desigCreateForm.control}\n                        name=\"departmentId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Department</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-desig-dept\">\n                                  <SelectValue placeholder=\"Select department\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent position=\"popper\">\n                                {departments?.map((dept) => (\n                                  <SelectItem key={dept.id} value={dept.id}>\n                                    {dept.name}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={desigCreateForm.control}\n                        name=\"description\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Description</FormLabel>\n                            <FormControl>\n                              <Textarea\n                                {...field}\n                                placeholder=\"Designation description\"\n                                data-testid=\"input-desig-description\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <div className=\"flex justify-end gap-2\">\n                        <Button type=\"button\" variant=\"outline\" onClick={() => setDesigCreateOpen(false)}>\n                          Cancel\n                        </Button>\n                        <Button type=\"submit\" disabled={desigCreateMutation.isPending} data-testid=\"button-submit-desig\">\n                          {desigCreateMutation.isPending ? \"Creating...\" : \"Create Designation\"}\n                        </Button>\n                      </div>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Briefcase className=\"w-5 h-5\" />\n                  Designations ({filteredDesignations.length})\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {desigLoading ? (\n                  <p className=\"text-center text-muted-foreground py-8\">Loading designations...</p>\n                ) : filteredDesignations.length === 0 ? (\n                  <p className=\"text-center text-muted-foreground py-8\">No designations found</p>\n                ) : (\n                  <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                    {filteredDesignations.map((desig) => (\n                      <Card key={desig.id} data-testid={`card-desig-${desig.id}`} className=\"hover-elevate\">\n                        <CardHeader>\n                          <div className=\"flex items-start justify-between gap-2\">\n                            <div className=\"space-y-1 flex-1 min-w-0\">\n                              <CardTitle className=\"text-lg truncate\" data-testid={`text-desig-title-${desig.id}`}>\n                                {desig.title}\n                              </CardTitle>\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                <Building2 className=\"w-3 h-3 mr-1\" />\n                                {getDepartmentName(desig.departmentId)}\n                              </Badge>\n                            </div>\n                          </div>\n                        </CardHeader>\n                        <CardContent className=\"space-y-3\">\n                          {desig.description && (\n                            <p className=\"text-sm text-muted-foreground line-clamp-2\">{desig.description}</p>\n                          )}\n                          <div className=\"text-xs text-muted-foreground\">\n                            Created {new Date(desig.createdAt).toLocaleDateString()}\n                          </div>\n                          <div className=\"flex gap-2\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleDesigEdit(desig)}\n                              className=\"flex-1\"\n                              data-testid={`button-edit-desig-${desig.id}`}\n                            >\n                              <Edit className=\"w-4 h-4 mr-1\" />\n                              Edit\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              variant=\"ghost\"\n                              onClick={() => handleDesigDelete(desig.id)}\n                              data-testid={`button-delete-desig-${desig.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </Button>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n\n        {/* Edit Department Dialog */}\n        <Dialog open={deptEditOpen} onOpenChange={setDeptEditOpen}>\n          <DialogContent data-testid=\"dialog-edit-dept\">\n            <DialogHeader>\n              <DialogTitle>Edit Department</DialogTitle>\n            </DialogHeader>\n            <Form {...deptEditForm}>\n              <form onSubmit={deptEditForm.handleSubmit(onDeptEditSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={deptEditForm.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Department Name*</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"Engineering\" data-testid=\"input-edit-dept-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={deptEditForm.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Description</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          {...field}\n                          placeholder=\"Department description\"\n                          data-testid=\"input-edit-dept-description\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"flex justify-end gap-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setDeptEditOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={deptUpdateMutation.isPending} data-testid=\"button-submit-edit-dept\">\n                    {deptUpdateMutation.isPending ? \"Updating...\" : \"Update Department\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n\n        {/* Edit Designation Dialog */}\n        <Dialog open={desigEditOpen} onOpenChange={setDesigEditOpen}>\n          <DialogContent data-testid=\"dialog-edit-desig\">\n            <DialogHeader>\n              <DialogTitle>Edit Designation</DialogTitle>\n            </DialogHeader>\n            <Form {...desigEditForm}>\n              <form onSubmit={desigEditForm.handleSubmit(onDesigEditSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={desigEditForm.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Designation Title*</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"Senior Developer\" data-testid=\"input-edit-desig-title\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={desigEditForm.control}\n                  name=\"departmentId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Department</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-edit-desig-dept\">\n                            <SelectValue placeholder=\"Select department\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent position=\"popper\">\n                          {departments?.map((dept) => (\n                            <SelectItem key={dept.id} value={dept.id}>\n                              {dept.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={desigEditForm.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Description</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          {...field}\n                          placeholder=\"Designation description\"\n                          data-testid=\"input-edit-desig-description\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"flex justify-end gap-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setDesigEditOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={desigUpdateMutation.isPending} data-testid=\"button-submit-edit-desig\">\n                    {desigUpdateMutation.isPending ? \"Updating...\" : \"Update Designation\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":30489,"size_tokens":null},"client/src/pages/hr-attendance.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Plus,\n  Edit,\n  Trash2,\n  Clock,\n  CheckCircle2,\n  XCircle,\n  AlertCircle,\n  RefreshCw,\n  Wifi,\n  WifiOff,\n  Calendar,\n  UserPlus,\n} from \"lucide-react\";\n\ntype AttendanceDevice = {\n  id: string;\n  name: string;\n  deviceType: string;\n  ipAddress: string;\n  port?: number;\n  apiEndpoint?: string;\n  apiKey?: string;\n  status: string;\n  isActive: boolean;\n  lastSyncAt?: string;\n  lastSyncError?: string;\n  createdAt: string;\n};\n\ntype DeviceLog = {\n  id: string;\n  deviceId: string;\n  employeeId: string;\n  punchTime: string;\n  punchType: string;\n  synced: boolean;\n  syncedAt?: string;\n  createdAt: string;\n};\n\ntype PunchCorrection = {\n  id: string;\n  attendanceId: string;\n  employeeId: string;\n  requestedCheckIn?: string;\n  requestedCheckOut?: string;\n  reason: string;\n  status: string;\n  approvedBy?: string;\n  approvedAt?: string;\n  rejectionReason?: string;\n  createdAt: string;\n};\n\nconst deviceSchema = z.object({\n  name: z.string().min(1, \"Device name is required\"),\n  deviceType: z.string().min(1, \"Device type is required\"),\n  ipAddress: z.string().min(1, \"IP address is required\"),\n  port: z.coerce.number().optional(),\n  apiEndpoint: z.string().optional(),\n  apiKey: z.string().optional(),\n  status: z.string().default(\"active\"),\n  isActive: z.boolean().default(true),\n});\n\ntype DeviceFormData = z.infer<typeof deviceSchema>;\n\nconst manualAttendanceSchema = z.object({\n  userId: z.string().min(1, \"Employee is required\"),\n  date: z.string().min(1, \"Date is required\"),\n  status: z.string().min(1, \"Status is required\"),\n  checkIn: z.string().optional(),\n  checkOut: z.string().optional(),\n  notes: z.string().optional(),\n});\n\ntype ManualAttendanceFormData = z.infer<typeof manualAttendanceSchema>;\n\ntype Employee = {\n  id: string;\n  userId: string;\n  employeeId: string;\n  user: {\n    id: string;\n    fullName: string;\n  };\n};\n\nexport default function HRAttendance() {\n  const { toast } = useToast();\n  const [deviceCreateOpen, setDeviceCreateOpen] = useState(false);\n  const [deviceEditOpen, setDeviceEditOpen] = useState(false);\n  const [editingDevice, setEditingDevice] = useState<AttendanceDevice | null>(null);\n\n  const { data: devices, isLoading: devicesLoading} = useQuery<AttendanceDevice[]>({\n    queryKey: [\"/api/attendance-devices\"],\n  });\n\n  const { data: deviceLogs, isLoading: logsLoading } = useQuery<DeviceLog[]>({\n    queryKey: [\"/api/device-logs\"],\n  });\n\n  const { data: punchCorrections, isLoading: correctionsLoading } = useQuery<PunchCorrection[]>({\n    queryKey: [\"/api/punch-corrections\"],\n  });\n\n  const { data: employees } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const deviceCreateForm = useForm<DeviceFormData>({\n    resolver: zodResolver(deviceSchema),\n    defaultValues: {\n      name: \"\",\n      deviceType: \"zkteco\",\n      ipAddress: \"\",\n      port: 4370,\n      status: \"active\",\n      isActive: true,\n    },\n  });\n\n  const deviceEditForm = useForm<DeviceFormData>({\n    resolver: zodResolver(deviceSchema),\n  });\n\n  const manualAttendanceForm = useForm<ManualAttendanceFormData>({\n    resolver: zodResolver(manualAttendanceSchema),\n    defaultValues: {\n      userId: \"\",\n      date: new Date().toISOString().split(\"T\")[0],\n      status: \"present\",\n      checkIn: \"\",\n      checkOut: \"\",\n      notes: \"\",\n    },\n  });\n\n  const deviceCreateMutation = useMutation({\n    mutationFn: async (data: DeviceFormData) => {\n      return apiRequest(\"POST\", \"/api/attendance-devices\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance-devices\"] });\n      setDeviceCreateOpen(false);\n      deviceCreateForm.reset();\n      toast({ title: \"Success\", description: \"Attendance device created successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deviceUpdateMutation = useMutation({\n    mutationFn: (data: { id: string; updates: Partial<DeviceFormData> }) =>\n      apiRequest(\"PATCH\", `/api/attendance-devices/${data.id}`, data.updates),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance-devices\"] });\n      setDeviceEditOpen(false);\n      setEditingDevice(null);\n      toast({ title: \"Success\", description: \"Device updated successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deviceDeleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/attendance-devices/${id}`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance-devices\"] });\n      toast({ title: \"Success\", description: \"Device deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deviceSyncMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"POST\", `/api/attendance-devices/${id}/sync`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance-devices\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/device-logs\"] });\n      toast({ title: \"Success\", description: \"Device synced successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const correctionApproveMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"POST\", `/api/punch-corrections/${id}/approve`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/punch-corrections\"] });\n      toast({ title: \"Success\", description: \"Punch correction approved\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const correctionRejectMutation = useMutation({\n    mutationFn: (data: { id: string; reason: string }) =>\n      apiRequest(\"POST\", `/api/punch-corrections/${data.id}/reject`, {\n        rejectionReason: data.reason,\n      }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/punch-corrections\"] });\n      toast({ title: \"Success\", description: \"Punch correction rejected\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const manualAttendanceMutation = useMutation({\n    mutationFn: async (data: ManualAttendanceFormData) => {\n      return apiRequest(\"POST\", \"/api/attendance/manual\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n      manualAttendanceForm.reset({\n        userId: \"\",\n        date: new Date().toISOString().split(\"T\")[0],\n        status: \"present\",\n        checkIn: \"\",\n        checkOut: \"\",\n        notes: \"\",\n      });\n      toast({ title: \"Success\", description: \"Attendance record added successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const onDeviceCreateSubmit = (data: DeviceFormData) => {\n    deviceCreateMutation.mutate(data);\n  };\n\n  const onManualAttendanceSubmit = (data: ManualAttendanceFormData) => {\n    console.log(\" FRONTEND - Form data before mutation:\", data);\n    console.log(\" FRONTEND - Status value:\", data.status);\n    manualAttendanceMutation.mutate(data);\n  };\n\n  const onDeviceEditSubmit = (data: DeviceFormData) => {\n    if (!editingDevice) return;\n    deviceUpdateMutation.mutate({ id: editingDevice.id, updates: data });\n  };\n\n  const handleDeviceEdit = (device: AttendanceDevice) => {\n    setEditingDevice(device);\n    deviceEditForm.reset({\n      name: device.name,\n      deviceType: device.deviceType,\n      ipAddress: device.ipAddress,\n      port: device.port,\n      apiEndpoint: device.apiEndpoint || \"\",\n      apiKey: device.apiKey || \"\",\n      status: device.status,\n      isActive: device.isActive,\n    });\n    setDeviceEditOpen(true);\n  };\n\n  const handleDeviceDelete = (id: string) => {\n    if (confirm(\"Are you sure you want to delete this device?\")) {\n      deviceDeleteMutation.mutate(id);\n    }\n  };\n\n  const handleDeviceSync = (id: string) => {\n    deviceSyncMutation.mutate(id);\n  };\n\n  const handleApproveCorrection = (id: string) => {\n    if (confirm(\"Approve this punch correction?\")) {\n      correctionApproveMutation.mutate(id);\n    }\n  };\n\n  const handleRejectCorrection = (id: string) => {\n    const reason = prompt(\"Enter rejection reason:\");\n    if (reason) {\n      correctionRejectMutation.mutate({ id, reason });\n    }\n  };\n\n  const statusColors: Record<string, string> = {\n    active: \"bg-green-500/10 text-green-700 dark:text-green-400\",\n    inactive: \"bg-gray-500/10 text-gray-700 dark:text-gray-400\",\n    pending: \"bg-yellow-500/10 text-yellow-700 dark:text-yellow-400\",\n    approved: \"bg-green-500/10 text-green-700 dark:text-green-400\",\n    rejected: \"bg-red-500/10 text-red-700 dark:text-red-400\",\n  };\n\n  const deviceStats = {\n    total: devices?.length || 0,\n    active: devices?.filter((d) => d.isActive).length || 0,\n    inactive: devices?.filter((d) => !d.isActive).length || 0,\n  };\n\n  const correctionStats = {\n    pending: punchCorrections?.filter((c) => c.status === \"pending\").length || 0,\n    approved: punchCorrections?.filter((c) => c.status === \"approved\").length || 0,\n    rejected: punchCorrections?.filter((c) => c.status === \"rejected\").length || 0,\n  };\n\n  return (\n    <div className=\"h-full overflow-auto\">\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">\n            Attendance Management\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Manage biometric devices, punch logs, and attendance corrections\n          </p>\n        </div>\n\n        <Tabs defaultValue=\"manual\" className=\"w-full\">\n          <TabsList>\n            <TabsTrigger value=\"manual\" data-testid=\"tab-manual\">\n              <UserPlus className=\"w-4 h-4 mr-2\" />\n              Manual Entry\n            </TabsTrigger>\n            <TabsTrigger value=\"devices\" data-testid=\"tab-devices\">\n              <Wifi className=\"w-4 h-4 mr-2\" />\n              Devices ({deviceStats.total})\n            </TabsTrigger>\n            <TabsTrigger value=\"logs\" data-testid=\"tab-logs\">\n              <Clock className=\"w-4 h-4 mr-2\" />\n              Punch Logs\n            </TabsTrigger>\n            <TabsTrigger value=\"corrections\" data-testid=\"tab-corrections\">\n              <AlertCircle className=\"w-4 h-4 mr-2\" />\n              Corrections ({correctionStats.pending})\n            </TabsTrigger>\n          </TabsList>\n\n          {/* MANUAL ENTRY TAB */}\n          <TabsContent value=\"manual\" className=\"space-y-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Add Manual Attendance</CardTitle>\n                <CardDescription>\n                  Manually add attendance records for employees. This is useful for backfilling data or handling special cases.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Form {...manualAttendanceForm}>\n                  <form onSubmit={manualAttendanceForm.handleSubmit(onManualAttendanceSubmit)} className=\"space-y-4\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      <FormField\n                        control={manualAttendanceForm.control}\n                        name=\"userId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Employee*</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-employee\">\n                                  <SelectValue placeholder=\"Select employee\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent position=\"popper\">\n                                {employees?.map((emp) => (\n                                  <SelectItem key={emp.userId} value={emp.userId}>\n                                    {emp.user.fullName} ({emp.employeeId})\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={manualAttendanceForm.control}\n                        name=\"date\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Date*</FormLabel>\n                            <FormControl>\n                              <Input\n                                type=\"date\"\n                                {...field}\n                                data-testid=\"input-date\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={manualAttendanceForm.control}\n                      name=\"status\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Status*</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-status\">\n                                <SelectValue />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent position=\"popper\">\n                              <SelectItem value=\"present\">Present</SelectItem>\n                              <SelectItem value=\"absent\">Absent</SelectItem>\n                              <SelectItem value=\"late\">Late</SelectItem>\n                              <SelectItem value=\"half-day\">Half Day</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      <FormField\n                        control={manualAttendanceForm.control}\n                        name=\"checkIn\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Check-in Time (Optional)</FormLabel>\n                            <FormControl>\n                              <Input\n                                type=\"time\"\n                                {...field}\n                                data-testid=\"input-checkin\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={manualAttendanceForm.control}\n                        name=\"checkOut\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Check-out Time (Optional)</FormLabel>\n                            <FormControl>\n                              <Input\n                                type=\"time\"\n                                {...field}\n                                data-testid=\"input-checkout\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={manualAttendanceForm.control}\n                      name=\"notes\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Notes (Optional)</FormLabel>\n                          <FormControl>\n                            <Textarea\n                              {...field}\n                              placeholder=\"Add any notes about this attendance record...\"\n                              data-testid=\"input-notes\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"flex gap-2\">\n                      <Button\n                        type=\"submit\"\n                        disabled={manualAttendanceMutation.isPending}\n                        data-testid=\"button-submit-attendance\"\n                      >\n                        <Plus className=\"w-4 h-4 mr-2\" />\n                        {manualAttendanceMutation.isPending ? \"Adding...\" : \"Add Attendance\"}\n                      </Button>\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        onClick={() => manualAttendanceForm.reset()}\n                        data-testid=\"button-reset-form\"\n                      >\n                        Reset Form\n                      </Button>\n                    </div>\n                  </form>\n                </Form>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* DEVICES TAB */}\n          <TabsContent value=\"devices\" className=\"space-y-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <div className=\"grid gap-4 md:grid-cols-3 flex-1\">\n                <Card>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Total Devices</CardTitle>\n                    <Wifi className=\"h-4 w-4 text-muted-foreground\" />\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-2xl font-bold\">{deviceStats.total}</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Active</CardTitle>\n                    <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-2xl font-bold text-green-600\">{deviceStats.active}</div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Inactive</CardTitle>\n                    <WifiOff className=\"h-4 w-4 text-gray-600\" />\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-2xl font-bold text-gray-600\">{deviceStats.inactive}</div>\n                  </CardContent>\n                </Card>\n              </div>\n              <Dialog open={deviceCreateOpen} onOpenChange={setDeviceCreateOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-create-device\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Device\n                  </Button>\n                </DialogTrigger>\n                <DialogContent data-testid=\"dialog-create-device\">\n                  <DialogHeader>\n                    <DialogTitle>Add Attendance Device</DialogTitle>\n                  </DialogHeader>\n                  <Form {...deviceCreateForm}>\n                    <form onSubmit={deviceCreateForm.handleSubmit(onDeviceCreateSubmit)} className=\"space-y-4\">\n                      <FormField\n                        control={deviceCreateForm.control}\n                        name=\"name\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Device Name*</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Main Entrance\" data-testid=\"input-device-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <FormField\n                          control={deviceCreateForm.control}\n                          name=\"deviceType\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Device Type*</FormLabel>\n                              <Select onValueChange={field.onChange} value={field.value}>\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-device-type\">\n                                    <SelectValue />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent position=\"popper\">\n                                  <SelectItem value=\"zkteco\">ZKTeco</SelectItem>\n                                  <SelectItem value=\"suprema\">Suprema</SelectItem>\n                                  <SelectItem value=\"other\">Other</SelectItem>\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={deviceCreateForm.control}\n                          name=\"port\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Port</FormLabel>\n                              <FormControl>\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  placeholder=\"4370\"\n                                  data-testid=\"input-port\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </div>\n                      <FormField\n                        control={deviceCreateForm.control}\n                        name=\"ipAddress\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>IP Address*</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"192.168.1.100\" data-testid=\"input-ip-address\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={deviceCreateForm.control}\n                        name=\"apiEndpoint\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>API Endpoint</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"/api/v1\" data-testid=\"input-api-endpoint\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={deviceCreateForm.control}\n                        name=\"apiKey\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>API Key</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"password\" placeholder=\"Device API key\" data-testid=\"input-api-key\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <div className=\"flex justify-end gap-2\">\n                        <Button type=\"button\" variant=\"outline\" onClick={() => setDeviceCreateOpen(false)}>\n                          Cancel\n                        </Button>\n                        <Button type=\"submit\" disabled={deviceCreateMutation.isPending} data-testid=\"button-submit-device\">\n                          {deviceCreateMutation.isPending ? \"Creating...\" : \"Create Device\"}\n                        </Button>\n                      </div>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {devicesLoading ? (\n                <Card className=\"col-span-full\">\n                  <CardContent className=\"pt-6\">\n                    <p className=\"text-center text-muted-foreground\">Loading devices...</p>\n                  </CardContent>\n                </Card>\n              ) : devices && devices.length === 0 ? (\n                <Card className=\"col-span-full\">\n                  <CardContent className=\"pt-6\">\n                    <p className=\"text-center text-muted-foreground\">No devices configured</p>\n                  </CardContent>\n                </Card>\n              ) : (\n                devices?.map((device) => (\n                  <Card key={device.id} data-testid={`card-device-${device.id}`} className=\"hover-elevate\">\n                    <CardHeader>\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <div className=\"space-y-1 flex-1 min-w-0\">\n                          <CardTitle className=\"text-lg truncate\">{device.name}</CardTitle>\n                          <div className=\"flex items-center gap-2 flex-wrap\">\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {device.deviceType}\n                            </Badge>\n                            <Badge className={statusColors[device.status]}>\n                              {device.isActive ? \"Active\" : \"Inactive\"}\n                            </Badge>\n                          </div>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3\">\n                      <div className=\"space-y-2 text-sm\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-muted-foreground\">IP Address:</span>\n                          <span className=\"font-mono\">{device.ipAddress}:{device.port || 4370}</span>\n                        </div>\n                        {device.lastSyncAt && (\n                          <div className=\"flex items-center justify-between\">\n                            <span className=\"text-muted-foreground\">Last Sync:</span>\n                            <span className=\"text-xs\">\n                              {new Date(device.lastSyncAt).toLocaleString()}\n                            </span>\n                          </div>\n                        )}\n                        {device.lastSyncError && (\n                          <div className=\"text-xs text-destructive line-clamp-2\">\n                            Error: {device.lastSyncError}\n                          </div>\n                        )}\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleDeviceSync(device.id)}\n                          disabled={deviceSyncMutation.isPending}\n                          data-testid={`button-sync-${device.id}`}\n                        >\n                          <RefreshCw className=\"w-4 h-4 mr-1\" />\n                          Sync\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleDeviceEdit(device)}\n                          data-testid={`button-edit-device-${device.id}`}\n                        >\n                          <Edit className=\"w-4 h-4 mr-1\" />\n                          Edit\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => handleDeviceDelete(device.id)}\n                          data-testid={`button-delete-device-${device.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))\n              )}\n            </div>\n          </TabsContent>\n\n          {/* LOGS TAB */}\n          <TabsContent value=\"logs\" className=\"space-y-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Recent Punch Logs (Last 200)</CardTitle>\n              </CardHeader>\n              <CardContent>\n                {logsLoading ? (\n                  <p className=\"text-center text-muted-foreground py-8\">Loading logs...</p>\n                ) : deviceLogs && deviceLogs.length === 0 ? (\n                  <p className=\"text-center text-muted-foreground py-8\">No punch logs found</p>\n                ) : (\n                  <div className=\"space-y-2\">\n                    {deviceLogs?.slice(0, 50).map((log) => (\n                      <Card key={log.id} className=\"hover-elevate\">\n                        <CardContent className=\"pt-4\">\n                          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                            <div className=\"space-y-1\">\n                              <div className=\"font-medium\">Employee ID: {log.employeeId}</div>\n                              <div className=\"text-sm text-muted-foreground\">\n                                {new Date(log.punchTime).toLocaleString()} - {log.punchType}\n                              </div>\n                            </div>\n                            <Badge className={log.synced ? statusColors.approved : statusColors.pending}>\n                              {log.synced ? \"Synced\" : \"Pending\"}\n                            </Badge>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* CORRECTIONS TAB */}\n          <TabsContent value=\"corrections\" className=\"space-y-4\">\n            <div className=\"grid gap-4 md:grid-cols-3\">\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Pending</CardTitle>\n                  <AlertCircle className=\"h-4 w-4 text-yellow-600\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-yellow-600\">{correctionStats.pending}</div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Approved</CardTitle>\n                  <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-green-600\">{correctionStats.approved}</div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Rejected</CardTitle>\n                  <XCircle className=\"h-4 w-4 text-red-600\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-red-600\">{correctionStats.rejected}</div>\n                </CardContent>\n              </Card>\n            </div>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Punch Correction Requests</CardTitle>\n              </CardHeader>\n              <CardContent>\n                {correctionsLoading ? (\n                  <p className=\"text-center text-muted-foreground py-8\">Loading corrections...</p>\n                ) : punchCorrections && punchCorrections.length === 0 ? (\n                  <p className=\"text-center text-muted-foreground py-8\">No correction requests</p>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {punchCorrections?.map((correction) => (\n                      <Card key={correction.id} className=\"hover-elevate\">\n                        <CardContent className=\"pt-4\">\n                          <div className=\"space-y-3\">\n                            <div className=\"flex items-start justify-between gap-4\">\n                              <div className=\"space-y-1 flex-1\">\n                                <div className=\"font-medium\">Employee ID: {correction.employeeId}</div>\n                                <div className=\"text-sm text-muted-foreground\">\n                                  {correction.requestedCheckIn &&\n                                    `Check-in: ${new Date(correction.requestedCheckIn).toLocaleString()}`}\n                                  {correction.requestedCheckIn && correction.requestedCheckOut && \" | \"}\n                                  {correction.requestedCheckOut &&\n                                    `Check-out: ${new Date(correction.requestedCheckOut).toLocaleString()}`}\n                                </div>\n                                <div className=\"text-sm\">\n                                  <span className=\"text-muted-foreground\">Reason: </span>\n                                  {correction.reason}\n                                </div>\n                                {correction.rejectionReason && (\n                                  <div className=\"text-sm text-destructive\">\n                                    <span className=\"font-medium\">Rejected: </span>\n                                    {correction.rejectionReason}\n                                  </div>\n                                )}\n                              </div>\n                              <Badge className={statusColors[correction.status]}>{correction.status}</Badge>\n                            </div>\n                            {correction.status === \"pending\" && (\n                              <div className=\"flex gap-2\">\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => handleApproveCorrection(correction.id)}\n                                  disabled={correctionApproveMutation.isPending}\n                                  data-testid={`button-approve-${correction.id}`}\n                                >\n                                  <CheckCircle2 className=\"w-4 h-4 mr-1\" />\n                                  Approve\n                                </Button>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"ghost\"\n                                  onClick={() => handleRejectCorrection(correction.id)}\n                                  disabled={correctionRejectMutation.isPending}\n                                  data-testid={`button-reject-${correction.id}`}\n                                >\n                                  <XCircle className=\"w-4 h-4 mr-1\" />\n                                  Reject\n                                </Button>\n                              </div>\n                            )}\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n\n        {/* Edit Device Dialog */}\n        <Dialog open={deviceEditOpen} onOpenChange={setDeviceEditOpen}>\n          <DialogContent data-testid=\"dialog-edit-device\">\n            <DialogHeader>\n              <DialogTitle>Edit Attendance Device</DialogTitle>\n            </DialogHeader>\n            <Form {...deviceEditForm}>\n              <form onSubmit={deviceEditForm.handleSubmit(onDeviceEditSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={deviceEditForm.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Device Name*</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"Main Entrance\" data-testid=\"input-edit-device-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={deviceEditForm.control}\n                    name=\"deviceType\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Device Type*</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-edit-device-type\">\n                              <SelectValue />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent position=\"popper\">\n                            <SelectItem value=\"zkteco\">ZKTeco</SelectItem>\n                            <SelectItem value=\"suprema\">Suprema</SelectItem>\n                            <SelectItem value=\"other\">Other</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={deviceEditForm.control}\n                    name=\"port\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Port</FormLabel>\n                        <FormControl>\n                          <Input\n                            {...field}\n                            type=\"number\"\n                            placeholder=\"4370\"\n                            data-testid=\"input-edit-port\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <FormField\n                  control={deviceEditForm.control}\n                  name=\"ipAddress\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>IP Address*</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"192.168.1.100\" data-testid=\"input-edit-ip-address\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"flex justify-end gap-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setDeviceEditOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={deviceUpdateMutation.isPending} data-testid=\"button-submit-edit-device\">\n                    {deviceUpdateMutation.isPending ? \"Updating...\" : \"Update Device\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":42172,"size_tokens":null},"client/src/pages/general-ledger.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowUpCircle, ArrowDownCircle, Wallet, FileText, FileSpreadsheet } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { sumAmounts } from \"@shared/currency\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport Decimal from \"decimal.js-light\";\n\ntype Income = {\n  id: string;\n  source: string;\n  amount: string;\n  category: string;\n  date: string;\n  description?: string;\n};\n\ntype Expense = {\n  id: string;\n  title: string;\n  amount: string;\n  category: string;\n  date: string;\n  description?: string;\n};\n\ntype Payroll = {\n  id: string;\n  employeeId: string;\n  month: number;\n  year: number;\n  netSalary: string;\n  status: string;\n};\n\ntype LedgerEntry = {\n  id: string;\n  date: string;\n  type: \"income\" | \"expense\" | \"payroll\";\n  description: string;\n  category: string;\n  debit: string;\n  credit: string;\n  balance: string;\n};\n\nexport default function GeneralLedger() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterType, setFilterType] = useState<\"all\" | \"income\" | \"expense\" | \"payroll\">(\"all\");\n  const { toast } = useToast();\n\n  const { data: incomes, isLoading: incomesLoading } = useQuery<Income[]>({\n    queryKey: [\"/api/income\"],\n  });\n\n  const { data: expenses, isLoading: expensesLoading } = useQuery<Expense[]>({\n    queryKey: [\"/api/expenses\"],\n  });\n\n  const { data: payrolls, isLoading: payrollsLoading } = useQuery<Payroll[]>({\n    queryKey: [\"/api/payroll\"],\n  });\n\n  const isLoading = incomesLoading || expensesLoading || payrollsLoading;\n\n  // Export to PDF\n  const exportToPDF = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/general-ledger/export-pdf`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) throw new Error(\"Failed to generate PDF\");\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'General-Ledger.pdf';\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"PDF Downloaded\",\n        description: \"General Ledger exported successfully\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to export PDF\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Export to Excel\n  const exportToExcel = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/general-ledger/export-excel`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) throw new Error(\"Failed to generate Excel\");\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'General-Ledger.xlsx';\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Excel Downloaded\",\n        description: \"General Ledger exported successfully\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to export Excel\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Export to Word\n  const exportToWord = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/general-ledger/export-word`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) throw new Error(\"Failed to generate Word document\");\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'General-Ledger.docx';\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Word Document Downloaded\",\n        description: \"General Ledger exported successfully\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to export Word document\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const ledgerEntries: LedgerEntry[] = [];\n\n  incomes?.forEach(inc => {\n    ledgerEntries.push({\n      id: inc.id,\n      date: inc.date,\n      type: \"income\",\n      description: inc.source,\n      category: inc.category,\n      debit: inc.amount,\n      credit: \"0\",\n      balance: \"0\",\n    });\n  });\n\n  expenses?.forEach(exp => {\n    ledgerEntries.push({\n      id: exp.id,\n      date: exp.date,\n      type: \"expense\",\n      description: exp.title,\n      category: exp.category,\n      debit: \"0\",\n      credit: exp.amount,\n      balance: \"0\",\n    });\n  });\n\n  payrolls?.filter(p => p.status === \"paid\").forEach(pay => {\n    ledgerEntries.push({\n      id: pay.id,\n      date: new Date(pay.year, pay.month - 1, 1).toISOString(),\n      type: \"payroll\",\n      description: `Payroll ${pay.month}/${pay.year}`,\n      category: \"Payroll\",\n      debit: \"0\",\n      credit: pay.netSalary,\n      balance: \"0\",\n    });\n  });\n\n  // Create ascending copy for balance calculation (oldest first)\n  const sortedForBalance = [...ledgerEntries].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());\n\n  // Calculate running balance using Decimal.js and create enriched array\n  let runningBalance = new Decimal(0);\n  const entriesWithBalance = sortedForBalance.map(entry => {\n    const debitAmount = new Decimal(entry.debit);\n    const creditAmount = new Decimal(entry.credit);\n    runningBalance = runningBalance.plus(debitAmount).minus(creditAmount);\n    return {\n      ...entry,\n      balance: runningBalance.toFixed(2)\n    };\n  });\n\n  // Sort enriched entries by date (newest first for display)\n  const displayEntries = [...entriesWithBalance].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());\n\n  const filteredEntries = displayEntries.filter(entry => {\n    const matchesSearch = entry.description.toLowerCase().includes(searchQuery.toLowerCase()) ||\n                         entry.category.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesType = filterType === \"all\" || entry.type === filterType;\n    return matchesSearch && matchesType;\n  });\n\n  // Calculate totals using Decimal.js for precision (keep as strings)\n  const debitAmounts = entriesWithBalance.map(e => e.debit);\n  const creditAmounts = entriesWithBalance.map(e => e.credit);\n  const totalDebits = sumAmounts(debitAmounts);\n  const totalCredits = sumAmounts(creditAmounts);\n  const finalBalance = new Decimal(totalDebits).minus(totalCredits).toFixed(2);\n  const finalBalanceNum = parseFloat(finalBalance);\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"heading-general-ledger\">General Ledger</h1>\n        <p className=\"text-muted-foreground\" data-testid=\"text-subtitle\">Comprehensive transaction history</p>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card data-testid=\"card-total-debits\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Debits (Income)</CardTitle>\n            <ArrowUpCircle className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-total-debits\">\n              {parseFloat(totalDebits).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-credits\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Credits (Expenses)</CardTitle>\n            <ArrowDownCircle className=\"h-4 w-4 text-red-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-total-credits\">\n              {parseFloat(totalCredits).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-balance\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Current Balance</CardTitle>\n            <Wallet className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${finalBalanceNum >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid=\"text-balance\">\n              {Math.abs(finalBalanceNum).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"flex flex-wrap gap-4 items-center justify-between\">\n        <div className=\"flex flex-wrap gap-4\">\n          <Input\n            placeholder=\"Search transactions...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"max-w-sm\"\n            data-testid=\"input-search\"\n          />\n          <Select value={filterType} onValueChange={(v) => setFilterType(v as typeof filterType)}>\n            <SelectTrigger className=\"w-[180px]\" data-testid=\"select-filter\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\" data-testid=\"option-all\">All Transactions</SelectItem>\n              <SelectItem value=\"income\" data-testid=\"option-income\">Income Only</SelectItem>\n              <SelectItem value=\"expense\" data-testid=\"option-expense\">Expenses Only</SelectItem>\n              <SelectItem value=\"payroll\" data-testid=\"option-payroll\">Payroll Only</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n        <div className=\"flex flex-wrap gap-2\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={exportToPDF}\n            data-testid=\"button-export-pdf\"\n          >\n            <FileText className=\"h-4 w-4 mr-2\" />\n            PDF\n          </Button>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={exportToExcel}\n            data-testid=\"button-export-excel\"\n          >\n            <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n            Excel\n          </Button>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={exportToWord}\n            data-testid=\"button-export-word\"\n          >\n            <FileText className=\"h-4 w-4 mr-2\" />\n            Word\n          </Button>\n        </div>\n      </div>\n\n      <Card data-testid=\"card-ledger\">\n        <CardHeader>\n          <CardTitle>Ledger Entries ({filteredEntries.length})</CardTitle>\n          <CardDescription>All financial transactions</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-sm text-muted-foreground\">Loading...</div>\n          ) : filteredEntries.length > 0 ? (\n            <div className=\"space-y-2\">\n              {filteredEntries.map((entry) => (\n                <div\n                  key={entry.id}\n                  className=\"flex items-center gap-4 p-3 rounded-md bg-card border hover-elevate\"\n                  data-testid={`entry-${entry.id}`}\n                >\n                  <div className=\"flex-shrink-0\">\n                    {entry.type === \"income\" ? (\n                      <ArrowUpCircle className=\"w-5 h-5 text-green-600\" />\n                    ) : (\n                      <ArrowDownCircle className=\"w-5 h-5 text-red-600\" />\n                    )}\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"font-medium truncate\" data-testid={`text-description-${entry.id}`}>{entry.description}</div>\n                    <div className=\"text-sm text-muted-foreground\">\n                      {format(new Date(entry.date), \"MMM d, yyyy\")}  {entry.category}\n                    </div>\n                  </div>\n                  <div className=\"text-right flex-shrink-0\">\n                    <div className=\"flex gap-4\">\n                      {entry.debit !== \"0\" && (\n                        <div className=\"text-sm\">\n                          <div className=\"text-muted-foreground\">Debit</div>\n                          <div className=\"font-medium text-green-600\" data-testid={`text-debit-${entry.id}`}>\n                            {parseFloat(entry.debit).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                          </div>\n                        </div>\n                      )}\n                      {entry.credit !== \"0\" && (\n                        <div className=\"text-sm\">\n                          <div className=\"text-muted-foreground\">Credit</div>\n                          <div className=\"font-medium text-red-600\" data-testid={`text-credit-${entry.id}`}>\n                            {parseFloat(entry.credit).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                          </div>\n                        </div>\n                      )}\n                      <div className=\"text-sm\">\n                        <div className=\"text-muted-foreground\">Balance</div>\n                        <div className={`font-medium ${parseFloat(entry.balance) >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid={`text-balance-${entry.id}`}>\n                          {Math.abs(parseFloat(entry.balance)).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-sm text-muted-foreground\">No transactions found</div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":14753,"size_tokens":null},"client/src/pages/accounts-dashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {TrendingUp, TrendingDown, DollarSign, CreditCard, Wallet, PieChart } from \"lucide-react\";\nimport { format, startOfMonth, endOfMonth, startOfYear, endOfYear } from \"date-fns\";\n\ntype Income = {\n  id: string;\n  source: string;\n  amount: string;\n  category: string;\n  date: string;\n  description?: string;\n  createdAt: string;\n};\n\ntype Expense = {\n  id: string;\n  title: string;\n  amount: string;\n  category: string;\n  date: string;\n  description?: string;\n  createdAt: string;\n};\n\ntype Payroll = {\n  id: string;\n  employeeId: string;\n  month: number;\n  year: number;\n  netSalary: string;\n  status: string;\n};\n\nexport default function AccountsDashboard() {\n  const [timeframe, setTimeframe] = useState<\"month\" | \"year\">(\"month\");\n\n  const { data: incomes, isLoading: incomesLoading } = useQuery<Income[]>({\n    queryKey: [\"/api/income\"],\n  });\n\n  const { data: expenses, isLoading: expensesLoading } = useQuery<Expense[]>({\n    queryKey: [\"/api/expenses\"],\n  });\n\n  const { data: payrolls, isLoading: payrollsLoading } = useQuery<Payroll[]>({\n    queryKey: [\"/api/payroll\"],\n  });\n\n  const isLoading = incomesLoading || expensesLoading || payrollsLoading;\n\n  const now = new Date();\n  const startDate = timeframe === \"month\" ? startOfMonth(now) : startOfYear(now);\n  const endDate = timeframe === \"month\" ? endOfMonth(now) : endOfYear(now);\n\n  const filterByDate = (date: string) => {\n    const itemDate = new Date(date);\n    return itemDate >= startDate && itemDate <= endDate;\n  };\n\n  const filteredIncomes = incomes?.filter(income => filterByDate(income.date)) || [];\n  const filteredExpenses = expenses?.filter(expense => filterByDate(expense.date)) || [];\n  const filteredPayrolls = payrolls?.filter(\n    p => p.status === \"paid\" && new Date(p.year, p.month - 1) >= startDate && new Date(p.year, p.month - 1) <= endDate\n  ) || [];\n\n  const totalIncome = filteredIncomes.reduce((sum, inc) => sum + Number(inc.amount), 0);\n  const totalExpenses = filteredExpenses.reduce((sum, exp) => sum + Number(exp.amount), 0);\n  const totalPayroll = filteredPayrolls.reduce((sum, pay) => sum + Number(pay.netSalary), 0);\n  const totalCosts = totalExpenses + totalPayroll;\n  const netProfit = totalIncome - totalCosts;\n\n  const incomeByCategory = filteredIncomes.reduce((acc, income) => {\n    acc[income.category] = (acc[income.category] || 0) + Number(income.amount);\n    return acc;\n  }, {} as Record<string, number>);\n\n  const expenseByCategory = filteredExpenses.reduce((acc, expense) => {\n    acc[expense.category] = (acc[expense.category] || 0) + Number(expense.amount);\n    return acc;\n  }, {} as Record<string, number>);\n\n  const topIncomeCategories = Object.entries(incomeByCategory)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 5);\n\n  const topExpenseCategories = Object.entries(expenseByCategory)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 5);\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-accounts-dashboard\">Financial Dashboard</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"text-subtitle\">Comprehensive financial overview and analytics</p>\n        </div>\n        <Tabs value={timeframe} onValueChange={(v) => setTimeframe(v as \"month\" | \"year\")} data-testid=\"tabs-timeframe\">\n          <TabsList>\n            <TabsTrigger value=\"month\" data-testid=\"tab-month\">This Month</TabsTrigger>\n            <TabsTrigger value=\"year\" data-testid=\"tab-year\">This Year</TabsTrigger>\n          </TabsList>\n        </Tabs>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <Card data-testid=\"card-total-income\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Income</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-income\">\n              {totalIncome.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">{filteredIncomes.length} transactions</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-expenses\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Expenses</CardTitle>\n            <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-expenses\">\n              {totalExpenses.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">{filteredExpenses.length} transactions</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-payroll\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Payroll Costs</CardTitle>\n            <Wallet className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-payroll\">\n              {totalPayroll.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">{filteredPayrolls.length} salary payments</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-net-profit\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Net Profit</CardTitle>\n            {netProfit >= 0 ? (\n              <TrendingUp className=\"h-4 w-4 text-green-600\" />\n            ) : (\n              <TrendingDown className=\"h-4 w-4 text-red-600\" />\n            )}\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${netProfit >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid=\"text-net-profit\">\n              {Math.abs(netProfit).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              {((netProfit / (totalIncome || 1)) * 100).toFixed(1)}% margin\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2\">\n        <Card data-testid=\"card-income-categories\">\n          <CardHeader>\n            <CardTitle>Top Income Categories</CardTitle>\n            <CardDescription>Revenue breakdown by category</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-sm text-muted-foreground\">Loading...</div>\n            ) : topIncomeCategories.length > 0 ? (\n              <div className=\"space-y-4\">\n                {topIncomeCategories.map(([category, amount]) => (\n                  <div key={category} className=\"flex items-center justify-between gap-2\" data-testid={`income-category-${category}`}>\n                    <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                      <div className=\"w-3 h-3 rounded-full bg-primary\" />\n                      <span className=\"text-sm truncate\">{category}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-sm font-medium\">{amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {((amount / totalIncome) * 100).toFixed(0)}%\n                      </span>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-sm text-muted-foreground\">No income data available</div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-expense-categories\">\n          <CardHeader>\n            <CardTitle>Top Expense Categories</CardTitle>\n            <CardDescription>Cost breakdown by category</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-sm text-muted-foreground\">Loading...</div>\n            ) : topExpenseCategories.length > 0 ? (\n              <div className=\"space-y-4\">\n                {topExpenseCategories.map(([category, amount]) => (\n                  <div key={category} className=\"flex items-center justify-between gap-2\" data-testid={`expense-category-${category}`}>\n                    <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                      <div className=\"w-3 h-3 rounded-full bg-red-500\" />\n                      <span className=\"text-sm truncate\">{category}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-sm font-medium\">{amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {((amount / totalCosts) * 100).toFixed(0)}%\n                      </span>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-sm text-muted-foreground\">No expense data available</div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card data-testid=\"card-financial-summary\">\n        <CardHeader>\n          <CardTitle>Financial Summary</CardTitle>\n          <CardDescription>\n            Period: {format(startDate, \"MMM d, yyyy\")} - {format(endDate, \"MMM d, yyyy\")}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between gap-2 p-4 rounded-md bg-card border\">\n              <div>\n                <div className=\"text-sm text-muted-foreground\">Revenue (Income)</div>\n                <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-summary-income\">\n                  {totalIncome.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                </div>\n              </div>\n              <TrendingUp className=\"h-8 w-8 text-green-600\" />\n            </div>\n            <div className=\"flex items-center justify-between gap-2 p-4 rounded-md bg-card border\">\n              <div>\n                <div className=\"text-sm text-muted-foreground\">Operating Expenses</div>\n                <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-summary-expenses\">\n                  {totalExpenses.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                </div>\n              </div>\n              <TrendingDown className=\"h-8 w-8 text-red-600\" />\n            </div>\n            <div className=\"flex items-center justify-between gap-2 p-4 rounded-md bg-card border\">\n              <div>\n                <div className=\"text-sm text-muted-foreground\">Payroll Expenses</div>\n                <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-summary-payroll\">\n                  {totalPayroll.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                </div>\n              </div>\n              <Wallet className=\"h-8 w-8 text-red-600\" />\n            </div>\n            <div className=\"h-px bg-border\" />\n            <div className=\"flex items-center justify-between gap-2 p-4 rounded-md bg-primary/10 border-2 border-primary\">\n              <div>\n                <div className=\"text-sm font-medium\">Net Profit/Loss</div>\n                <div className={`text-3xl font-bold ${netProfit >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid=\"text-summary-net\">\n                  {netProfit >= 0 ? \"+\" : \"-\"}{Math.abs(netProfit).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {netProfit >= 0 ? \"Profitable\" : \"Loss\"}  {((netProfit / (totalIncome || 1)) * 100).toFixed(1)}% margin\n                </div>\n              </div>\n              {netProfit >= 0 ? (\n                <TrendingUp className=\"h-10 w-10 text-green-600\" />\n              ) : (\n                <TrendingDown className=\"h-10 w-10 text-red-600\" />\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":13212,"size_tokens":null},"client/src/pages/expense-categories.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Plus, Edit2, Trash2, FolderOpen } from \"lucide-react\";\n\ntype ExpenseCategory = {\n  id: string;\n  name: string;\n  type: string;\n  description?: string;\n  isActive: boolean;\n  createdAt: string;\n};\n\nconst categorySchema = z.object({\n  name: z.string().min(1, \"Category name is required\"),\n  type: z.string().min(1, \"Type is required\"),\n  description: z.string().optional(),\n  isActive: z.boolean().default(true),\n});\n\ntype CategoryFormData = z.infer<typeof categorySchema>;\n\nexport default function ExpenseCategories() {\n  const [createOpen, setCreateOpen] = useState(false);\n  const [editOpen, setEditOpen] = useState(false);\n  const [editingCategory, setEditingCategory] = useState<ExpenseCategory | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: categories, isLoading } = useQuery<ExpenseCategory[]>({\n    queryKey: [\"/api/expense-categories\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: CategoryFormData) => apiRequest(\"POST\", \"/api/expense-categories\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/expense-categories\"] });\n      toast({ title: \"Success\", description: \"Category created successfully\" });\n      setCreateOpen(false);\n      createForm.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: Partial<CategoryFormData> }) =>\n      apiRequest(\"PATCH\", `/api/expense-categories/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/expense-categories\"] });\n      toast({ title: \"Success\", description: \"Category updated successfully\" });\n      setEditOpen(false);\n      setEditingCategory(null);\n      editForm.reset();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/expense-categories/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/expense-categories\"] });\n      toast({ title: \"Success\", description: \"Category deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const createForm = useForm<CategoryFormData>({\n    resolver: zodResolver(categorySchema),\n    defaultValues: {\n      name: \"\",\n      type: \"income\",\n      description: \"\",\n      isActive: true,\n    },\n  });\n\n  const editForm = useForm<CategoryFormData>({\n    resolver: zodResolver(categorySchema),\n  });\n\n  const handleEdit = (category: ExpenseCategory) => {\n    setEditingCategory(category);\n    editForm.reset({\n      name: category.name,\n      type: category.type,\n      description: category.description || \"\",\n      isActive: category.isActive,\n    });\n    setEditOpen(true);\n  };\n\n  const handleDelete = (id: string) => {\n    if (confirm(\"Are you sure you want to delete this category?\")) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  const onCreateSubmit = (data: CategoryFormData) => {\n    createMutation.mutate(data);\n  };\n\n  const onEditSubmit = (data: CategoryFormData) => {\n    if (!editingCategory) return;\n    updateMutation.mutate({ id: editingCategory.id, data });\n  };\n\n  const filteredCategories = categories?.filter(cat =>\n    cat.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    cat.type.toLowerCase().includes(searchQuery.toLowerCase())\n  ) || [];\n\n  const incomeCategories = filteredCategories.filter(c => c.type === \"income\");\n  const expenseCategories = filteredCategories.filter(c => c.type === \"expense\");\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-expense-categories\">Expense Categories</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"text-subtitle\">Manage income and expense categories</p>\n        </div>\n        <Button onClick={() => setCreateOpen(true)} data-testid=\"button-add-category\">\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Add Category\n        </Button>\n      </div>\n\n      <Input\n        placeholder=\"Search categories...\"\n        value={searchQuery}\n        onChange={(e) => setSearchQuery(e.target.value)}\n        className=\"max-w-sm\"\n        data-testid=\"input-search\"\n      />\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card data-testid=\"card-income-categories\">\n          <CardHeader>\n            <CardTitle>Income Categories ({incomeCategories.length})</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-sm text-muted-foreground\">Loading...</div>\n            ) : incomeCategories.length > 0 ? (\n              <div className=\"space-y-3\">\n                {incomeCategories.map((category) => (\n                  <div\n                    key={category.id}\n                    className=\"flex items-center justify-between gap-2 p-3 rounded-md bg-card border hover-elevate\"\n                    data-testid={`category-${category.id}`}\n                  >\n                    <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                      <FolderOpen className=\"w-4 h-4 text-green-600 flex-shrink-0\" />\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"font-medium truncate\" data-testid={`text-name-${category.id}`}>{category.name}</div>\n                        {category.description && (\n                          <div className=\"text-sm text-muted-foreground truncate\">{category.description}</div>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge variant={category.isActive ? \"default\" : \"secondary\"} data-testid={`badge-status-${category.id}`}>\n                        {category.isActive ? \"Active\" : \"Inactive\"}\n                      </Badge>\n                      <Button size=\"icon\" variant=\"ghost\" onClick={() => handleEdit(category)} data-testid={`button-edit-${category.id}`}>\n                        <Edit2 className=\"w-4 h-4\" />\n                      </Button>\n                      <Button size=\"icon\" variant=\"ghost\" onClick={() => handleDelete(category.id)} data-testid={`button-delete-${category.id}`}>\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-sm text-muted-foreground\">No income categories found</div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-expense-categories\">\n          <CardHeader>\n            <CardTitle>Expense Categories ({expenseCategories.length})</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-sm text-muted-foreground\">Loading...</div>\n            ) : expenseCategories.length > 0 ? (\n              <div className=\"space-y-3\">\n                {expenseCategories.map((category) => (\n                  <div\n                    key={category.id}\n                    className=\"flex items-center justify-between gap-2 p-3 rounded-md bg-card border hover-elevate\"\n                    data-testid={`category-${category.id}`}\n                  >\n                    <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                      <FolderOpen className=\"w-4 h-4 text-red-600 flex-shrink-0\" />\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"font-medium truncate\" data-testid={`text-name-${category.id}`}>{category.name}</div>\n                        {category.description && (\n                          <div className=\"text-sm text-muted-foreground truncate\">{category.description}</div>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge variant={category.isActive ? \"default\" : \"secondary\"} data-testid={`badge-status-${category.id}`}>\n                        {category.isActive ? \"Active\" : \"Inactive\"}\n                      </Badge>\n                      <Button size=\"icon\" variant=\"ghost\" onClick={() => handleEdit(category)} data-testid={`button-edit-${category.id}`}>\n                        <Edit2 className=\"w-4 h-4\" />\n                      </Button>\n                      <Button size=\"icon\" variant=\"ghost\" onClick={() => handleDelete(category.id)} data-testid={`button-delete-${category.id}`}>\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-sm text-muted-foreground\">No expense categories found</div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Dialog open={createOpen} onOpenChange={setCreateOpen}>\n        <DialogContent data-testid=\"dialog-create\">\n          <DialogHeader>\n            <DialogTitle>Add New Category</DialogTitle>\n          </DialogHeader>\n          <Form {...createForm}>\n            <form onSubmit={createForm.handleSubmit(onCreateSubmit)} className=\"space-y-4\">\n              <FormField\n                control={createForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Category Name*</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"e.g., Project Income\" data-testid=\"input-name\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={createForm.control}\n                name=\"type\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Type*</FormLabel>\n                    <Select value={field.value} onValueChange={field.onChange}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-type\">\n                          <SelectValue placeholder=\"Select type\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"income\" data-testid=\"option-income\">Income</SelectItem>\n                        <SelectItem value=\"expense\" data-testid=\"option-expense\">Expense</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={createForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea {...field} placeholder=\"Category description\" rows={3} data-testid=\"textarea-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"flex gap-2 justify-end\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setCreateOpen(false)} data-testid=\"button-cancel\">\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit\">\n                  {createMutation.isPending ? \"Creating...\" : \"Create Category\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={editOpen} onOpenChange={setEditOpen}>\n        <DialogContent data-testid=\"dialog-edit\">\n          <DialogHeader>\n            <DialogTitle>Edit Category</DialogTitle>\n          </DialogHeader>\n          <Form {...editForm}>\n            <form onSubmit={editForm.handleSubmit(onEditSubmit)} className=\"space-y-4\">\n              <FormField\n                control={editForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Category Name*</FormLabel>\n                    <FormControl>\n                      <Input {...field} data-testid=\"input-edit-name\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editForm.control}\n                name=\"type\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Type*</FormLabel>\n                    <Select value={field.value} onValueChange={field.onChange}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"income\" data-testid=\"option-edit-income\">Income</SelectItem>\n                        <SelectItem value=\"expense\" data-testid=\"option-edit-expense\">Expense</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea {...field} rows={3} data-testid=\"textarea-edit-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"flex gap-2 justify-end\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setEditOpen(false)} data-testid=\"button-cancel-edit\">\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-submit-edit\">\n                  {updateMutation.isPending ? \"Updating...\" : \"Update Category\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":15862,"size_tokens":null},"client/src/pages/profit-loss.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { FileText, Download, FileSpreadsheet, TrendingUp, TrendingDown, AlertCircle } from \"lucide-react\";\nimport { format, startOfMonth, endOfMonth, subMonths } from \"date-fns\";\nimport { BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from \"recharts\";\nimport { sumAmounts } from \"@shared/currency\";\n\ntype Income = {\n  id: string;\n  amount: string;\n  category: string;\n  date: string;\n};\n\ntype Expense = {\n  id: string;\n  amount: string;\n  category: string;\n  date: string;\n};\n\ntype Payroll = {\n  id: string;\n  month: number;\n  year: number;\n  netSalary: string;\n  status: string;\n};\n\nconst COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];\n\nexport default function ProfitLoss() {\n  const currentMonth = new Date().getMonth() + 1;\n  const currentYear = new Date().getFullYear();\n  const [selectedMonth, setSelectedMonth] = useState(currentMonth.toString());\n  const [selectedYear, setSelectedYear] = useState(currentYear.toString());\n  const [selectedCategory, setSelectedCategory] = useState<string>(\"all\");\n\n  const { data: incomes } = useQuery<Income[]>({\n    queryKey: [\"/api/income\"],\n  });\n\n  const { data: expenses } = useQuery<Expense[]>({\n    queryKey: [\"/api/expenses\"],\n  });\n\n  const { data: payrolls } = useQuery<Payroll[]>({\n    queryKey: [\"/api/payroll\"],\n  });\n\n  // Calculate data for current period\n  const startDate = startOfMonth(new Date(parseInt(selectedYear), parseInt(selectedMonth) - 1));\n  const endDate = endOfMonth(new Date(parseInt(selectedYear), parseInt(selectedMonth) - 1));\n\n  const filterByDate = (date: string) => {\n    const itemDate = new Date(date);\n    return itemDate >= startDate && itemDate <= endDate;\n  };\n\n  let periodIncomes = incomes?.filter(inc => filterByDate(inc.date)) || [];\n  let periodExpenses = expenses?.filter(exp => filterByDate(exp.date)) || [];\n  let periodPayrolls = payrolls?.filter(\n    p => p.status === \"paid\" && p.month === parseInt(selectedMonth) && p.year === parseInt(selectedYear)\n  ) || [];\n\n  // Apply category filter\n  if (selectedCategory !== \"all\") {\n    periodIncomes = periodIncomes.filter(inc => inc.category === selectedCategory);\n    periodExpenses = periodExpenses.filter(exp => exp.category === selectedCategory);\n    // Note: Payroll doesn't have categories, so it's excluded when a specific category is selected\n    periodPayrolls = [];\n  }\n\n  // Calculate previous month data for comparison\n  const prevMonthDate = subMonths(startDate, 1);\n  const prevMonthStart = startOfMonth(prevMonthDate);\n  const prevMonthEnd = endOfMonth(prevMonthDate);\n\n  const filterByPrevMonth = (date: string) => {\n    const itemDate = new Date(date);\n    return itemDate >= prevMonthStart && itemDate <= prevMonthEnd;\n  };\n\n  let prevMonthIncomes = incomes?.filter(inc => filterByPrevMonth(inc.date)) || [];\n  let prevMonthExpenses = expenses?.filter(exp => filterByPrevMonth(exp.date)) || [];\n  let prevMonthPayrolls = payrolls?.filter(\n    p => p.status === \"paid\" && p.month === prevMonthDate.getMonth() + 1 && p.year === prevMonthDate.getFullYear()\n  ) || [];\n\n  // Apply category filter to previous month data\n  if (selectedCategory !== \"all\") {\n    prevMonthIncomes = prevMonthIncomes.filter(inc => inc.category === selectedCategory);\n    prevMonthExpenses = prevMonthExpenses.filter(exp => exp.category === selectedCategory);\n    prevMonthPayrolls = [];\n  }\n\n  // Group by category (keep as string arrays for Decimal precision)\n  const incomeGrouped = periodIncomes.reduce((acc, inc) => {\n    if (!acc[inc.category]) acc[inc.category] = [];\n    acc[inc.category].push(inc.amount);\n    return acc;\n  }, {} as Record<string, string[]>);\n\n  const expenseGrouped = periodExpenses.reduce((acc, exp) => {\n    if (!acc[exp.category]) acc[exp.category] = [];\n    acc[exp.category].push(exp.amount);\n    return acc;\n  }, {} as Record<string, string[]>);\n\n  // Calculate category totals using Decimal.js\n  const incomeByCategory: Record<string, number> = {};\n  Object.entries(incomeGrouped).forEach(([cat, amounts]) => {\n    incomeByCategory[cat] = Number(sumAmounts(amounts));\n  });\n\n  const expenseByCategory: Record<string, number> = {};\n  Object.entries(expenseGrouped).forEach(([cat, amounts]) => {\n    expenseByCategory[cat] = Number(sumAmounts(amounts));\n  });\n\n  const totalIncome = Number(sumAmounts(periodIncomes.map(inc => inc.amount)));\n  const totalExpenses = Number(sumAmounts(periodExpenses.map(exp => exp.amount)));\n  const totalPayroll = Number(sumAmounts(periodPayrolls.map(p => p.netSalary)));\n  const totalCosts = totalExpenses + totalPayroll;\n  const grossProfit = totalIncome - totalCosts;\n  const profitMargin = ((grossProfit / (totalIncome || 1)) * 100);\n\n  // Previous month calculations\n  const prevTotalIncome = Number(sumAmounts(prevMonthIncomes.map(inc => inc.amount)));\n  const prevTotalExpenses = Number(sumAmounts(prevMonthExpenses.map(exp => exp.amount)));\n  const prevTotalPayroll = Number(sumAmounts(prevMonthPayrolls.map(p => p.netSalary)));\n  const prevGrossProfit = prevTotalIncome - (prevTotalExpenses + prevTotalPayroll);\n\n  // Calculate trends\n  const profitChange = prevGrossProfit !== 0 ? ((grossProfit - prevGrossProfit) / Math.abs(prevGrossProfit)) * 100 : 0;\n  const revenueChange = prevTotalIncome !== 0 ? ((totalIncome - prevTotalIncome) / prevTotalIncome) * 100 : 0;\n\n  // Chart data\n  const revenueVsExpensesData = [\n    { name: 'Revenue', amount: totalIncome, fill: '#10b981' },\n    { name: 'Operating Expenses', amount: totalExpenses, fill: '#ef4444' },\n    { name: 'Payroll', amount: totalPayroll, fill: '#f59e0b' },\n  ];\n\n  // Monthly trend data (last 6 months)\n  const monthlyTrendData = useMemo(() => {\n    const data = [];\n    for (let i = 5; i >= 0; i--) {\n      const date = subMonths(startDate, i);\n      const monthStart = startOfMonth(date);\n      const monthEnd = endOfMonth(date);\n      \n      let monthIncomes = incomes?.filter(inc => {\n        const itemDate = new Date(inc.date);\n        return itemDate >= monthStart && itemDate <= monthEnd;\n      }) || [];\n      \n      let monthExpenses = expenses?.filter(exp => {\n        const itemDate = new Date(exp.date);\n        return itemDate >= monthStart && itemDate <= monthEnd;\n      }) || [];\n      \n      let monthPayrolls = payrolls?.filter(\n        p => p.status === \"paid\" && p.month === date.getMonth() + 1 && p.year === date.getFullYear()\n      ) || [];\n\n      // Apply category filter to monthly trend data\n      if (selectedCategory !== \"all\") {\n        monthIncomes = monthIncomes.filter(inc => inc.category === selectedCategory);\n        monthExpenses = monthExpenses.filter(exp => exp.category === selectedCategory);\n        monthPayrolls = [];\n      }\n      \n      const monthRevenue = Number(sumAmounts(monthIncomes.map(inc => inc.amount)));\n      const monthExpense = Number(sumAmounts(monthExpenses.map(exp => exp.amount)));\n      const monthPayroll = Number(sumAmounts(monthPayrolls.map(p => p.netSalary)));\n      const monthProfit = monthRevenue - (monthExpense + monthPayroll);\n      \n      data.push({\n        month: format(date, 'MMM yy'),\n        profit: monthProfit,\n        revenue: monthRevenue,\n        expenses: monthExpense + monthPayroll,\n      });\n    }\n    return data;\n  }, [incomes, expenses, payrolls, startDate, selectedCategory]);\n\n  // Expense breakdown pie chart data\n  const expenseBreakdownData = [\n    ...Object.entries(expenseByCategory).map(([name, value]) => ({ name, value })),\n    ...(totalPayroll > 0 ? [{ name: 'Payroll', value: totalPayroll }] : [])\n  ];\n\n  const months = [\n    \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n  ];\n\n  const years = [currentYear, currentYear - 1, currentYear - 2];\n\n  // Get all unique categories\n  const allCategories = Array.from(new Set([\n    ...periodIncomes.map(i => i.category),\n    ...periodExpenses.map(e => e.category)\n  ]));\n\n  // Export to PDF\n  const exportToPDF = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/profit-loss/export-pdf?month=${selectedMonth}&year=${selectedYear}&category=${selectedCategory}`, {\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n      });\n      if (!response.ok) throw new Error(\"Failed to export PDF\");\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      const categoryLabel = selectedCategory !== \"all\" ? `-${selectedCategory}` : \"\";\n      a.download = `P&L-${months[parseInt(selectedMonth) - 1]}-${selectedYear}${categoryLabel}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      window.URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error('Export failed:', error);\n    }\n  };\n\n  // Export to Excel\n  const exportToExcel = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/profit-loss/export-excel?month=${selectedMonth}&year=${selectedYear}&category=${selectedCategory}`, {\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n      });\n      if (!response.ok) throw new Error(\"Failed to export Excel\");\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      const categoryLabel = selectedCategory !== \"all\" ? `-${selectedCategory}` : \"\";\n      a.download = `P&L-${months[parseInt(selectedMonth) - 1]}-${selectedYear}${categoryLabel}.xlsx`;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      window.URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error('Excel export failed:', error);\n    }\n  };\n\n  // Export to Word\n  const exportToWord = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/profit-loss/export-word?month=${selectedMonth}&year=${selectedYear}&category=${selectedCategory}`, {\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n      });\n      if (!response.ok) throw new Error(\"Failed to export Word\");\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      const categoryLabel = selectedCategory !== \"all\" ? `-${selectedCategory}` : \"\";\n      a.download = `P&L-${months[parseInt(selectedMonth) - 1]}-${selectedYear}${categoryLabel}.docx`;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      window.URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error('Word export failed:', error);\n    }\n  };\n\n  // Calculate insights\n  const insights = useMemo(() => {\n    const result = [];\n    \n    // Profit trend insight\n    if (Math.abs(profitChange) > 5) {\n      const direction = profitChange > 0 ? 'increased' : 'decreased';\n      result.push({\n        type: profitChange > 0 ? 'positive' : 'negative',\n        message: `Profit ${direction} by ${Math.abs(profitChange).toFixed(1)}% from last month.`\n      });\n    }\n    \n    // Expense composition insight\n    if (totalCosts > 0) {\n      const payrollPercent = (totalPayroll / totalCosts) * 100;\n      if (payrollPercent > 40) {\n        result.push({\n          type: 'warning',\n          message: `Salary expenses make up ${payrollPercent.toFixed(0)}% of total expenses.`\n        });\n      }\n    }\n    \n    // Revenue dependency insight\n    const sortedIncomeCategories = Object.entries(incomeByCategory).sort((a, b) => b[1] - a[1]);\n    if (sortedIncomeCategories.length > 0 && totalIncome > 0) {\n      const topCategoryPercent = (sortedIncomeCategories[0][1] / totalIncome) * 100;\n      if (topCategoryPercent > 60) {\n        result.push({\n          type: 'warning',\n          message: `${topCategoryPercent.toFixed(0)}% of revenue comes from ${sortedIncomeCategories[0][0]}. Consider diversifying income sources.`\n        });\n      }\n    }\n    \n    // Profit margin insight\n    if (profitMargin < 10 && profitMargin > 0) {\n      result.push({\n        type: 'warning',\n        message: `Low profit margin (${profitMargin.toFixed(1)}%). Consider reviewing expenses or pricing.`\n      });\n    } else if (profitMargin > 30) {\n      result.push({\n        type: 'positive',\n        message: `Excellent profit margin of ${profitMargin.toFixed(1)}%. Business is performing well!`\n      });\n    }\n    \n    // Revenue growth\n    if (Math.abs(revenueChange) > 10) {\n      const direction = revenueChange > 0 ? 'grew' : 'declined';\n      result.push({\n        type: revenueChange > 0 ? 'positive' : 'negative',\n        message: `Revenue ${direction} by ${Math.abs(revenueChange).toFixed(1)}% compared to last month.`\n      });\n    }\n    \n    return result;\n  }, [profitChange, totalCosts, totalPayroll, incomeByCategory, totalIncome, profitMargin, revenueChange]);\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header with Filters */}\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-profit-loss\">Profit & Loss Statement</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"text-subtitle\">Comprehensive financial analysis and insights</p>\n        </div>\n        <div className=\"flex gap-2 flex-wrap\">\n          <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n            <SelectTrigger className=\"w-[150px]\" data-testid=\"select-month\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {months.map((month, idx) => (\n                <SelectItem key={idx} value={(idx + 1).toString()} data-testid={`option-month-${idx}`}>\n                  {month}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Select value={selectedYear} onValueChange={setSelectedYear}>\n            <SelectTrigger className=\"w-[120px]\" data-testid=\"select-year\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {years.map((year) => (\n                <SelectItem key={year} value={year.toString()} data-testid={`option-year-${year}`}>\n                  {year}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n            <SelectTrigger className=\"w-[150px]\" data-testid=\"select-category\">\n              <SelectValue placeholder=\"All Categories\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\" data-testid=\"option-category-all\">All Categories</SelectItem>\n              {allCategories.map((cat) => (\n                <SelectItem key={cat} value={cat} data-testid={`option-category-${cat}`}>\n                  {cat}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Button variant=\"outline\" onClick={exportToPDF} data-testid=\"button-export-pdf\">\n            <FileText className=\"h-4 w-4 mr-2\" />\n            Export PDF\n          </Button>\n          <Button variant=\"outline\" onClick={exportToExcel} data-testid=\"button-export-excel\">\n            <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n            Export Excel\n          </Button>\n          <Button variant=\"outline\" onClick={exportToWord} data-testid=\"button-export-word\">\n            <FileText className=\"h-4 w-4 mr-2\" />\n            Export Word\n          </Button>\n        </div>\n      </div>\n\n      {/* Key Metrics Cards */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card data-testid=\"card-revenue\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Revenue</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-metric-revenue\">\n              {totalIncome.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n            {revenueChange !== 0 && (\n              <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"text-revenue-change\">\n                {revenueChange > 0 ? '+' : ''}{revenueChange.toFixed(1)}% from last month\n              </p>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-expenses\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Expenses</CardTitle>\n            <TrendingDown className=\"h-4 w-4 text-red-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-metric-expenses\">\n              {totalCosts.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"text-expense-breakdown\">\n              Operating: ${totalExpenses.toFixed(0)} | Payroll: ${totalPayroll.toFixed(0)}\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-profit\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Net Profit/Loss</CardTitle>\n            <Badge variant={grossProfit >= 0 ? \"default\" : \"destructive\"} data-testid=\"badge-profit-status\">\n              {grossProfit >= 0 ? \"Profit\" : \"Loss\"}\n            </Badge>\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${grossProfit >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid=\"text-metric-profit\">\n              {grossProfit >= 0 ? \"+\" : \"-\"}{Math.abs(grossProfit).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n            {profitChange !== 0 && (\n              <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"text-profit-change\">\n                {profitChange > 0 ? '+' : ''}{profitChange.toFixed(1)}% from last month\n              </p>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-margin\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Profit Margin</CardTitle>\n            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${profitMargin >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid=\"text-metric-margin\">\n              {profitMargin.toFixed(2)}%\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {profitMargin > 20 ? 'Excellent' : profitMargin > 10 ? 'Good' : profitMargin > 0 ? 'Fair' : 'Needs Attention'}\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Insights Section */}\n      {insights.length > 0 && (\n        <Card data-testid=\"card-insights\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <AlertCircle className=\"h-5 w-5\" />\n              Financial Insights\n            </CardTitle>\n            <CardDescription>Key observations and recommendations</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {insights.map((insight, idx) => (\n              <div\n                key={idx}\n                className={`flex items-start gap-3 p-3 rounded-md border ${\n                  insight.type === 'positive' ? 'bg-green-50 border-green-200 dark:bg-green-950 dark:border-green-800' :\n                  insight.type === 'negative' ? 'bg-red-50 border-red-200 dark:bg-red-950 dark:border-red-800' :\n                  'bg-yellow-50 border-yellow-200 dark:bg-yellow-950 dark:border-yellow-800'\n                }`}\n                data-testid={`insight-${idx}`}\n              >\n                {insight.type === 'positive' ? (\n                  <TrendingUp className=\"h-5 w-5 text-green-600 mt-0.5\" />\n                ) : insight.type === 'negative' ? (\n                  <TrendingDown className=\"h-5 w-5 text-red-600 mt-0.5\" />\n                ) : (\n                  <AlertCircle className=\"h-5 w-5 text-yellow-600 mt-0.5\" />\n                )}\n                <p className=\"text-sm flex-1\" data-testid={`insight-text-${idx}`}>{insight.message}</p>\n              </div>\n            ))}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Charts Section */}\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        {/* Revenue vs Expenses Bar Chart */}\n        <Card data-testid=\"card-chart-bar\">\n          <CardHeader>\n            <CardTitle>Revenue vs Expenses</CardTitle>\n            <CardDescription>Current period comparison</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <BarChart data={revenueVsExpensesData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"name\" />\n                <YAxis />\n                <Tooltip formatter={(value) => `${Number(value).toLocaleString()}`} />\n                <Bar dataKey=\"amount\" fill=\"#8884d8\">\n                  {revenueVsExpensesData.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={entry.fill} />\n                  ))}\n                </Bar>\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n\n        {/* Expense Breakdown Pie Chart */}\n        <Card data-testid=\"card-chart-pie\">\n          <CardHeader>\n            <CardTitle>Expense Breakdown</CardTitle>\n            <CardDescription>Distribution by category</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <PieChart>\n                <Pie\n                  data={expenseBreakdownData}\n                  cx=\"50%\"\n                  cy=\"50%\"\n                  labelLine={false}\n                  label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}\n                  outerRadius={80}\n                  fill=\"#8884d8\"\n                  dataKey=\"value\"\n                >\n                  {expenseBreakdownData.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n                  ))}\n                </Pie>\n                <Tooltip formatter={(value) => `${Number(value).toLocaleString()}`} />\n              </PieChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Monthly Profit Trend Line Chart */}\n      <Card data-testid=\"card-chart-trend\">\n        <CardHeader>\n          <CardTitle>6-Month Profit Trend</CardTitle>\n          <CardDescription>Historical performance analysis</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <ResponsiveContainer width=\"100%\" height={300}>\n            <LineChart data={monthlyTrendData}>\n              <CartesianGrid strokeDasharray=\"3 3\" />\n              <XAxis dataKey=\"month\" />\n              <YAxis />\n              <Tooltip formatter={(value) => `${Number(value).toLocaleString()}`} />\n              <Legend />\n              <Line type=\"monotone\" dataKey=\"revenue\" stroke=\"#10b981\" name=\"Revenue\" strokeWidth={2} />\n              <Line type=\"monotone\" dataKey=\"expenses\" stroke=\"#ef4444\" name=\"Expenses\" strokeWidth={2} />\n              <Line type=\"monotone\" dataKey=\"profit\" stroke=\"#3b82f6\" name=\"Net Profit\" strokeWidth={2} />\n            </LineChart>\n          </ResponsiveContainer>\n        </CardContent>\n      </Card>\n\n      {/* Detailed P&L Statement */}\n      <Card data-testid=\"card-summary\">\n        <CardHeader>\n          <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n            <div>\n              <CardTitle>Detailed P&L Statement</CardTitle>\n              <CardDescription>\n                Period: {format(startDate, \"MMMM d, yyyy\")} - {format(endDate, \"MMMM d, yyyy\")}\n              </CardDescription>\n            </div>\n            <Badge variant={grossProfit >= 0 ? \"default\" : \"destructive\"} data-testid=\"badge-status\">\n              {grossProfit >= 0 ? \"Profitable\" : \"Loss\"}\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div>\n            <h3 className=\"font-semibold mb-3 text-lg text-green-600 dark:text-green-500\">Revenue</h3>\n            <div className=\"space-y-2 pl-4\">\n              {Object.entries(incomeByCategory).map(([category, amount]) => (\n                <div key={category} className=\"flex items-center justify-between gap-2\" data-testid={`income-${category}`}>\n                  <span className=\"text-sm\">{category}</span>\n                  <span className=\"font-medium\" data-testid={`income-amount-${category}`}>\n                    {amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                  </span>\n                </div>\n              ))}\n              {Object.keys(incomeByCategory).length === 0 && (\n                <div className=\"text-sm text-muted-foreground\">No income recorded</div>\n              )}\n            </div>\n            <div className=\"h-px bg-border my-3\" />\n            <div className=\"flex items-center justify-between gap-2 font-semibold\">\n              <span>Total Revenue</span>\n              <span className=\"text-green-600 dark:text-green-500\" data-testid=\"text-total-revenue\">\n                {totalIncome.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n              </span>\n            </div>\n          </div>\n\n          <div className=\"h-px bg-border\" />\n\n          <div>\n            <h3 className=\"font-semibold mb-3 text-lg text-red-600 dark:text-red-500\">Operating Expenses</h3>\n            <div className=\"space-y-2 pl-4\">\n              {Object.entries(expenseByCategory).map(([category, amount]) => (\n                <div key={category} className=\"flex items-center justify-between gap-2\" data-testid={`expense-${category}`}>\n                  <span className=\"text-sm\">{category}</span>\n                  <span className=\"font-medium\" data-testid={`expense-amount-${category}`}>\n                    {amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                  </span>\n                </div>\n              ))}\n              {Object.keys(expenseByCategory).length === 0 && (\n                <div className=\"text-sm text-muted-foreground\">No expenses recorded</div>\n              )}\n            </div>\n            <div className=\"h-px bg-border my-3\" />\n            <div className=\"flex items-center justify-between gap-2 font-semibold\">\n              <span>Total Operating Expenses</span>\n              <span className=\"text-red-600 dark:text-red-500\" data-testid=\"text-total-expenses\">\n                {totalExpenses.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n              </span>\n            </div>\n          </div>\n\n          <div className=\"h-px bg-border\" />\n\n          <div>\n            <h3 className=\"font-semibold mb-3 text-lg text-red-600 dark:text-red-500\">Payroll Expenses</h3>\n            <div className=\"flex items-center justify-between gap-2 pl-4\">\n              <span className=\"text-sm\">Employee Salaries ({periodPayrolls.length} payments)</span>\n              <span className=\"font-medium text-red-600 dark:text-red-500\" data-testid=\"text-total-payroll\">\n                {totalPayroll.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n              </span>\n            </div>\n          </div>\n\n          <div className=\"h-px bg-border\" />\n\n          <div>\n            <div className=\"flex items-center justify-between gap-2 font-semibold\">\n              <span>Total Costs</span>\n              <span className=\"text-red-600 dark:text-red-500\" data-testid=\"text-total-costs\">\n                {totalCosts.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n              </span>\n            </div>\n          </div>\n\n          <div className=\"h-px bg-border\" />\n\n          <div className={`p-4 rounded-md border-2 ${grossProfit >= 0 ? 'bg-green-50 border-green-500 dark:bg-green-950 dark:border-green-700' : 'bg-red-50 border-red-500 dark:bg-red-950 dark:border-red-700'}`}>\n            <div className=\"flex items-center justify-between gap-2 mb-2 flex-wrap\">\n              <span className=\"text-lg font-bold\">Net Profit/Loss</span>\n              <span className={`text-2xl font-bold ${grossProfit >= 0 ? \"text-green-600 dark:text-green-500\" : \"text-red-600 dark:text-red-500\"}`} data-testid=\"text-net-profit\">\n                {grossProfit >= 0 ? \"+\" : \"-\"}{Math.abs(grossProfit).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n              </span>\n            </div>\n            <div className=\"flex items-center justify-between gap-2 text-sm text-muted-foreground\">\n              <span>Profit Margin</span>\n              <span data-testid=\"text-profit-margin\">{profitMargin.toFixed(2)}%</span>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":29965,"size_tokens":null},"client/src/pages/salary-payments.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Wallet, Users, TrendingDown } from \"lucide-react\";\nimport { format } from \"date-fns\";\n\ntype Payroll = {\n  id: string;\n  employeeId: string;\n  month: number;\n  year: number;\n  basicSalary: string;\n  totalAllowances: string;\n  overtimeAmount: string;\n  loanDeduction: string;\n  lateDeduction: string;\n  otherDeductions: string;\n  grossSalary: string;\n  netSalary: string;\n  status: string;\n  paidAt?: string;\n  createdAt: string;\n};\n\ntype Employee = {\n  id: string;\n  userId: string;\n  employeeId: string;\n};\n\ntype User = {\n  id: string;\n  fullName: string;\n};\n\nexport default function SalaryPayments() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterStatus, setFilterStatus] = useState<\"all\" | \"paid\" | \"pending\">(\"all\");\n  const currentYear = new Date().getFullYear();\n  const [selectedYear, setSelectedYear] = useState(currentYear.toString());\n\n  const { data: payrolls, isLoading: payrollsLoading } = useQuery<Payroll[]>({\n    queryKey: [\"/api/payroll\"],\n  });\n\n  const { data: employees } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const { data: users } = useQuery<User[]>({\n    queryKey: [\"/api/team\"],\n  });\n\n  const getEmployeeName = (employeeId: string) => {\n    const employee = employees?.find(e => e.id === employeeId);\n    if (!employee) return \"Unknown\";\n    const user = users?.find(u => u.id === employee.userId);\n    return user?.fullName || \"Unknown\";\n  };\n\n  const filteredPayrolls = payrolls?.filter(payroll => {\n    const employeeName = getEmployeeName(payroll.employeeId);\n    const matchesSearch = employeeName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n                         `${payroll.month}/${payroll.year}`.includes(searchQuery);\n    const matchesStatus = filterStatus === \"all\" || payroll.status === filterStatus;\n    const matchesYear = selectedYear === \"all\" || payroll.year.toString() === selectedYear;\n    return matchesSearch && matchesStatus && matchesYear;\n  }) || [];\n\n  const sortedPayrolls = [...filteredPayrolls].sort((a, b) => {\n    const dateA = new Date(a.year, a.month - 1);\n    const dateB = new Date(b.year, b.month - 1);\n    return dateB.getTime() - dateA.getTime();\n  });\n\n  const totalPaidSalaries = filteredPayrolls\n    .filter(p => p.status === \"paid\")\n    .reduce((sum, p) => sum + Number(p.netSalary), 0);\n\n  const totalPendingSalaries = filteredPayrolls\n    .filter(p => p.status === \"pending\" || p.status === \"draft\")\n    .reduce((sum, p) => sum + Number(p.netSalary), 0);\n\n  const totalPayments = filteredPayrolls.filter(p => p.status === \"paid\").length;\n\n  const years = [currentYear, currentYear - 1, currentYear - 2];\n  const months = [\n    \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n  ];\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"heading-salary-payments\">Salary Payments</h1>\n        <p className=\"text-muted-foreground\" data-testid=\"text-subtitle\">Track employee salary payments and payroll expenses</p>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card data-testid=\"card-total-paid\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Paid</CardTitle>\n            <Wallet className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-total-paid\">\n              {totalPaidSalaries.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">{totalPayments} payments</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-pending\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Pending Payments</CardTitle>\n            <TrendingDown className=\"h-4 w-4 text-orange-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-orange-600\" data-testid=\"text-total-pending\">\n              {totalPendingSalaries.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              {filteredPayrolls.filter(p => p.status === \"pending\" || p.status === \"draft\").length} pending\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-employees\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Employees</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-employees\">\n              {employees?.length || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Active employees</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"flex flex-wrap gap-4\">\n        <Input\n          placeholder=\"Search by employee or period...\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          className=\"max-w-sm\"\n          data-testid=\"input-search\"\n        />\n        <Select value={filterStatus} onValueChange={(v) => setFilterStatus(v as typeof filterStatus)}>\n          <SelectTrigger className=\"w-[180px]\" data-testid=\"select-status\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\" data-testid=\"option-all\">All Statuses</SelectItem>\n            <SelectItem value=\"paid\" data-testid=\"option-paid\">Paid Only</SelectItem>\n            <SelectItem value=\"pending\" data-testid=\"option-pending\">Pending Only</SelectItem>\n          </SelectContent>\n        </Select>\n        <Select value={selectedYear} onValueChange={setSelectedYear}>\n          <SelectTrigger className=\"w-[150px]\" data-testid=\"select-year\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\" data-testid=\"option-year-all\">All Years</SelectItem>\n            {years.map((year) => (\n              <SelectItem key={year} value={year.toString()} data-testid={`option-year-${year}`}>\n                {year}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <Card data-testid=\"card-payments\">\n        <CardHeader>\n          <CardTitle>Salary Payments ({sortedPayrolls.length})</CardTitle>\n          <CardDescription>Complete history of salary payments</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {payrollsLoading ? (\n            <div className=\"text-sm text-muted-foreground\">Loading...</div>\n          ) : sortedPayrolls.length > 0 ? (\n            <div className=\"space-y-2\">\n              {sortedPayrolls.map((payroll) => (\n                <div\n                  key={payroll.id}\n                  className=\"flex items-center gap-4 p-4 rounded-md bg-card border hover-elevate\"\n                  data-testid={`payment-${payroll.id}`}\n                >\n                  <div className=\"flex-1 min-w-0 grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <div>\n                      <div className=\"font-medium truncate\" data-testid={`text-employee-${payroll.id}`}>\n                        {getEmployeeName(payroll.employeeId)}\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {months[payroll.month - 1]} {payroll.year}\n                      </div>\n                    </div>\n                    <div>\n                      <div className=\"text-sm text-muted-foreground\">Net Salary</div>\n                      <div className=\"font-semibold text-red-600\" data-testid={`text-amount-${payroll.id}`}>\n                        {Number(payroll.netSalary).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                      </div>\n                    </div>\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <div className=\"text-sm text-muted-foreground\">Status</div>\n                        <Badge\n                          variant={\n                            payroll.status === \"paid\"\n                              ? \"default\"\n                              : payroll.status === \"pending\"\n                              ? \"secondary\"\n                              : \"outline\"\n                          }\n                          data-testid={`badge-status-${payroll.id}`}\n                        >\n                          {payroll.status}\n                        </Badge>\n                      </div>\n                      {payroll.paidAt && (\n                        <div className=\"text-right\">\n                          <div className=\"text-xs text-muted-foreground\">Paid on</div>\n                          <div className=\"text-xs font-medium\">\n                            {format(new Date(payroll.paidAt), \"MMM d, yyyy\")}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-sm text-muted-foreground\">No salary payments found</div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card data-testid=\"card-summary\">\n        <CardHeader>\n          <CardTitle>Payroll Summary</CardTitle>\n          <CardDescription>Overview of all salary payments</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between gap-2\">\n              <span className=\"text-sm text-muted-foreground\">Total Payments Made</span>\n              <span className=\"font-medium\" data-testid=\"text-summary-paid\">\n                {totalPaidSalaries.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n              </span>\n            </div>\n            <div className=\"flex items-center justify-between gap-2\">\n              <span className=\"text-sm text-muted-foreground\">Pending Payments</span>\n              <span className=\"font-medium text-orange-600\" data-testid=\"text-summary-pending\">\n                {totalPendingSalaries.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n              </span>\n            </div>\n            <div className=\"h-px bg-border\" />\n            <div className=\"flex items-center justify-between gap-2\">\n              <span className=\"font-semibold\">Total Payroll Liability</span>\n              <span className=\"font-bold text-lg\" data-testid=\"text-summary-total\">\n                {(totalPaidSalaries + totalPendingSalaries).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n              </span>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":11635,"size_tokens":null},"client/src/pages/financial-reports.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { FileText, TrendingUp, TrendingDown, FileSpreadsheet } from \"lucide-react\";\nimport { format, startOfMonth, endOfMonth, startOfYear, subMonths, subYears } from \"date-fns\";\nimport { sumAmounts } from \"@shared/currency\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport Decimal from \"decimal.js-light\";\n\ntype Income = {\n  id: string;\n  amount: string;\n  category: string;\n  date: string;\n};\n\ntype Expense = {\n  id: string;\n  amount: string;\n  category: string;\n  date: string;\n};\n\ntype MonthlyData = {\n  month: string;\n  income: string;\n  expenses: string;\n  profit: string;\n};\n\nexport default function FinancialReports() {\n  const [period, setPeriod] = useState<\"6months\" | \"12months\">(\"12months\");\n  const { toast } = useToast();\n\n  const { data: incomes, isLoading: incomesLoading } = useQuery<Income[]>({\n    queryKey: [\"/api/income\"],\n  });\n\n  const { data: expenses, isLoading: expensesLoading } = useQuery<Expense[]>({\n    queryKey: [\"/api/expenses\"],\n  });\n\n  const isLoading = incomesLoading || expensesLoading;\n\n  // Export to PDF\n  const exportToPDF = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/financial-reports/export-pdf?period=${period}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) throw new Error(\"Failed to generate PDF\");\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'Financial-Reports.pdf';\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"PDF Downloaded\",\n        description: \"Financial Reports exported successfully\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to export PDF\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Export to Excel\n  const exportToExcel = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/financial-reports/export-excel?period=${period}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) throw new Error(\"Failed to generate Excel\");\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'Financial-Reports.xlsx';\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Excel Downloaded\",\n        description: \"Financial Reports exported successfully\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to export Excel\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Export to Word\n  const exportToWord = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/financial-reports/export-word?period=${period}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) throw new Error(\"Failed to generate Word document\");\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'Financial-Reports.docx';\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Word Document Downloaded\",\n        description: \"Financial Reports exported successfully\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to export Word document\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const now = new Date();\n  const monthsCount = period === \"6months\" ? 6 : 12;\n  \n  const monthlyData: MonthlyData[] = [];\n  for (let i = monthsCount - 1; i >= 0; i--) {\n    const monthDate = subMonths(now, i);\n    const startDate = startOfMonth(monthDate);\n    const endDate = endOfMonth(monthDate);\n\n    const monthIncomes = incomes?.filter(inc => {\n      const incDate = new Date(inc.date);\n      return incDate >= startDate && incDate <= endDate;\n    }) || [];\n\n    const monthExpenses = expenses?.filter(exp => {\n      const expDate = new Date(exp.date);\n      return expDate >= startDate && expDate <= endDate;\n    }) || [];\n\n    const totalIncome = sumAmounts(monthIncomes.map(inc => inc.amount));\n    const totalExpenses = sumAmounts(monthExpenses.map(exp => exp.amount));\n    const profit = new Decimal(totalIncome).minus(totalExpenses).toFixed(2);\n\n    monthlyData.push({\n      month: format(monthDate, \"MMM yyyy\"),\n      income: totalIncome,\n      expenses: totalExpenses,\n      profit: profit,\n    });\n  }\n\n  const totalIncome = sumAmounts(monthlyData.map(m => m.income));\n  const totalExpenses = sumAmounts(monthlyData.map(m => m.expenses));\n  const totalProfit = new Decimal(totalIncome).minus(totalExpenses).toFixed(2);\n  const totalProfitNum = parseFloat(totalProfit);\n  const avgMonthlyIncome = new Decimal(totalIncome).dividedBy(monthsCount).toFixed(2);\n  const avgMonthlyExpenses = new Decimal(totalExpenses).dividedBy(monthsCount).toFixed(2);\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-financial-reports\">Financial Reports</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"text-subtitle\">Monthly and yearly financial analysis</p>\n        </div>\n        <div className=\"flex flex-wrap items-center gap-4\">\n          <Tabs value={period} onValueChange={(v) => setPeriod(v as \"6months\" | \"12months\")} data-testid=\"tabs-period\">\n            <TabsList>\n              <TabsTrigger value=\"6months\" data-testid=\"tab-6months\">Last 6 Months</TabsTrigger>\n              <TabsTrigger value=\"12months\" data-testid=\"tab-12months\">Last 12 Months</TabsTrigger>\n            </TabsList>\n          </Tabs>\n          <div className=\"flex flex-wrap gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={exportToPDF}\n              data-testid=\"button-export-pdf\"\n            >\n              <FileText className=\"h-4 w-4 mr-2\" />\n              PDF\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={exportToExcel}\n              data-testid=\"button-export-excel\"\n            >\n              <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n              Excel\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={exportToWord}\n              data-testid=\"button-export-word\"\n            >\n              <FileText className=\"h-4 w-4 mr-2\" />\n              Word\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card data-testid=\"card-total-income\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Income</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-total-income\">\n              {parseFloat(totalIncome).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Avg {parseFloat(avgMonthlyIncome).toLocaleString(undefined, { maximumFractionDigits: 0 })}/month\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-expenses\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Expenses</CardTitle>\n            <TrendingDown className=\"h-4 w-4 text-red-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-total-expenses\">\n              {parseFloat(totalExpenses).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Avg {parseFloat(avgMonthlyExpenses).toLocaleString(undefined, { maximumFractionDigits: 0 })}/month\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-net-profit\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Net Profit</CardTitle>\n            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${totalProfitNum >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid=\"text-net-profit\">\n              {Math.abs(totalProfitNum).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              {totalIncome === '0.00' ? '0.0' : new Decimal(totalProfit).dividedBy(totalIncome).times(100).toFixed(1)}% margin\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card data-testid=\"card-monthly-breakdown\">\n        <CardHeader>\n          <CardTitle>Monthly Breakdown</CardTitle>\n          <CardDescription>Income, expenses, and profit by month</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-sm text-muted-foreground\">Loading...</div>\n          ) : (\n            <div className=\"space-y-4\">\n              {monthlyData.map((data, index) => (\n                <div key={index} className=\"p-4 rounded-md bg-card border\" data-testid={`month-${index}`}>\n                  <div className=\"flex items-center justify-between gap-2 mb-3\">\n                    <h3 className=\"font-semibold\" data-testid={`text-month-${index}`}>{data.month}</h3>\n                    <Badge variant={parseFloat(data.profit) >= 0 ? \"default\" : \"destructive\"} data-testid={`badge-profit-${index}`}>\n                      {parseFloat(data.profit) >= 0 ? \"Profit\" : \"Loss\"}\n                    </Badge>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-4 text-sm\">\n                    <div>\n                      <div className=\"text-muted-foreground\">Income</div>\n                      <div className=\"font-medium text-green-600\" data-testid={`text-income-${index}`}>\n                        {parseFloat(data.income).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                      </div>\n                    </div>\n                    <div>\n                      <div className=\"text-muted-foreground\">Expenses</div>\n                      <div className=\"font-medium text-red-600\" data-testid={`text-expenses-${index}`}>\n                        {parseFloat(data.expenses).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                      </div>\n                    </div>\n                    <div>\n                      <div className=\"text-muted-foreground\">Net</div>\n                      <div className={`font-medium ${parseFloat(data.profit) >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid={`text-net-${index}`}>\n                        {parseFloat(data.profit) >= 0 ? \"+\" : \"-\"}{Math.abs(parseFloat(data.profit)).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":12582,"size_tokens":null},"shared/currency.ts":{"content":"import Decimal from 'decimal.js-light';\n\n// Configure Decimal for financial calculations\nDecimal.set({ precision: 20, rounding: Decimal.ROUND_HALF_UP });\n\n/**\n * Format currency with BDT prefix and proper decimal handling\n * Uses Decimal.js for precision-safe calculations\n */\nexport function formatCurrency(amount: string | number | Decimal, options: { prefix?: 'BDT' | '' } = { prefix: 'BDT' }): string {\n  try {\n    // Convert to Decimal for precision\n    const decimal = new Decimal(amount || 0);\n    \n    // Round to 2 decimal places (half-up rounding)\n    const rounded = decimal.toFixed(2);\n    \n    // Split into integer and decimal parts\n    const [integerPart, decimalPart] = rounded.split('.');\n    \n    // Add commas to integer part\n    const withCommas = integerPart.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\n    \n    // Construct final formatted string\n    const formatted = `${withCommas}.${decimalPart}`;\n    \n    // Add prefix if requested\n    return options.prefix ? `${options.prefix} ${formatted}` : formatted;\n  } catch (error) {\n    // Fallback for invalid inputs\n    return options.prefix === 'BDT' ? 'BDT 0.00' : '0.00';\n  }\n}\n\n/**\n * Parse currency string or number to Decimal\n * Removes commas and handles various input formats\n */\nexport function parseCurrency(value: string | number): Decimal {\n  try {\n    // Remove BDT prefix and commas\n    const cleaned = String(value)\n      .replace(/BDT/gi, '')\n      .replace(/,/g, '')\n      .trim();\n    \n    return new Decimal(cleaned || 0);\n  } catch (error) {\n    return new Decimal(0);\n  }\n}\n\n/**\n * Calculate line total from quantity and rate\n */\nexport function calculateLineTotal(quantity: string | number, rate: string | number): string {\n  const qty = new Decimal(quantity || 0);\n  const rateDecimal = new Decimal(rate || 0);\n  return qty.times(rateDecimal).toFixed(2);\n}\n\n/**\n * Sum an array of amounts\n */\nexport function sumAmounts(amounts: (string | number)[]): string {\n  const total = amounts.reduce((sum, amount) => {\n    return sum.plus(new Decimal(amount || 0));\n  }, new Decimal(0));\n  \n  return total.toFixed(2);\n}\n","path":null,"size_bytes":2101,"size_tokens":null},"server/utils/reportTemplate.ts":{"content":"import PDFDocument from \"pdfkit\";\nimport path from \"path\";\n\n/**\n * MaxTech BD Report Template Utility\n * Provides consistent branding, headers, and footers for all system reports\n */\n\nexport interface ReportConfig {\n  title: string;\n  subtitle?: string;\n  doc: typeof PDFDocument.prototype;\n  includeDate?: boolean;\n}\n\nexport const BRAND_COLORS = {\n  primary: \"#E11D26\",    // MaxTech Red\n  black: \"#1E1E1E\",      // Dark Black\n  gray: \"#444444\",       // Medium Gray\n  lightGray: \"#F8F9FA\",  // Light background\n  white: \"#FFFFFF\",\n  border: \"#E5E7EB\",\n};\n\nexport const COMPANY_INFO = {\n  name: \"MaxTech BD\",\n  address1: \"522, SK Mujib Road (4th Floor)\",\n  address2: \"Agrabad, Double Mooring\",\n  city: \"Chattogram, Bangladesh\",\n  phone: \"+8801843180008\",\n  email: \"info@maxtechbd.com\",\n};\n\n/**\n * Add MaxTech BD header to PDF report\n */\nexport function addReportHeader(config: ReportConfig): number {\n  const { doc, title, subtitle, includeDate = true } = config;\n  \n  // Background color bar for header\n  doc.save();\n  doc.rect(0, 0, 595, 120).fill(BRAND_COLORS.lightGray);\n  doc.restore();\n  \n  // Company Logo\n  try {\n    const logoPath = path.join(__dirname, \"../../attached_assets/Untitled design (1)_1763794635122.png\");\n    doc.image(logoPath, 40, 30, { width: 80, height: 80 });\n  } catch (error) {\n    console.warn(\"Logo not found, skipping logo in PDF\");\n  }\n  \n  // Company Information (right side of header)\n  doc.fontSize(14).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n  doc.text(COMPANY_INFO.name, 350, 35, { width: 200, align: \"right\" });\n  \n  doc.fontSize(9).font(\"Helvetica\").fillColor(BRAND_COLORS.black);\n  doc.text(COMPANY_INFO.address1, 350, 52, { width: 200, align: \"right\" });\n  doc.text(`${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`, 350, 64, { width: 200, align: \"right\" });\n  doc.text(`Phone: ${COMPANY_INFO.phone}`, 350, 76, { width: 200, align: \"right\" });\n  doc.text(`Email: ${COMPANY_INFO.email}`, 350, 88, { width: 200, align: \"right\" });\n  \n  // Report Title\n  doc.fontSize(20).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.black);\n  doc.text(title, 40, 140, { width: 515, align: \"center\" });\n  \n  let currentY = 165;\n  \n  // Optional Subtitle\n  if (subtitle) {\n    doc.fontSize(12).font(\"Helvetica\").fillColor(BRAND_COLORS.gray);\n    doc.text(subtitle, 40, currentY, { width: 515, align: \"center\" });\n    currentY += 25;\n  }\n  \n  // Optional Date\n  if (includeDate) {\n    doc.fontSize(10).font(\"Helvetica\").fillColor(BRAND_COLORS.gray);\n    doc.text(`Generated on: ${new Date().toLocaleString()}`, 40, currentY, { width: 515, align: \"center\" });\n    currentY += 30;\n  } else {\n    currentY += 20;\n  }\n  \n  return currentY;\n}\n\n/**\n * Add MaxTech BD footer to PDF report\n */\nexport function addReportFooter(doc: typeof PDFDocument.prototype, pageNumber?: number): void {\n  const bottomY = 750;\n  \n  // Footer separator line\n  doc.save();\n  doc.moveTo(40, bottomY)\n     .lineTo(555, bottomY)\n     .strokeColor(BRAND_COLORS.border)\n     .lineWidth(1)\n     .stroke();\n  doc.restore();\n  \n  // Footer text\n  doc.fontSize(8).font(\"Helvetica\").fillColor(BRAND_COLORS.gray);\n  doc.text(\n    `${COMPANY_INFO.name} | ${COMPANY_INFO.address1}, ${COMPANY_INFO.address2}, ${COMPANY_INFO.city}`,\n    40,\n    bottomY + 10,\n    { width: 515, align: \"center\" }\n  );\n  doc.text(\n    `Phone: ${COMPANY_INFO.phone} | Email: ${COMPANY_INFO.email}`,\n    40,\n    bottomY + 22,\n    { width: 515, align: \"center\" }\n  );\n  \n  // Optional page number\n  if (pageNumber) {\n    doc.text(`Page ${pageNumber}`, 500, bottomY + 10, { width: 55, align: \"right\" });\n  }\n}\n\n/**\n * Create a professional table header\n */\nexport function createTableHeader(\n  doc: typeof PDFDocument.prototype,\n  y: number,\n  columns: Array<{ label: string; width: number; align?: \"left\" | \"center\" | \"right\" }>\n): number {\n  const tableX = 40;\n  const totalWidth = columns.reduce((sum, col) => sum + col.width, 0);\n  const rowHeight = 35;\n  \n  // Header background\n  doc.save();\n  doc.rect(tableX, y, totalWidth, rowHeight).fillAndStroke(BRAND_COLORS.primary, BRAND_COLORS.primary);\n  doc.restore();\n  \n  // Header text\n  doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.white);\n  let currentX = tableX + 10;\n  \n  columns.forEach(col => {\n    doc.text(col.label, currentX, y + 11, { \n      width: col.width - 20, \n      align: col.align || \"left\" \n    });\n    currentX += col.width;\n  });\n  \n  return y + rowHeight;\n}\n\n/**\n * Create a table row with alternating colors\n */\nexport function createTableRow(\n  doc: typeof PDFDocument.prototype,\n  y: number,\n  columns: Array<{ text: string; width: number; align?: \"left\" | \"center\" | \"right\"; bold?: boolean }>,\n  isEven: boolean = false\n): number {\n  const tableX = 40;\n  const totalWidth = columns.reduce((sum, col) => sum + col.width, 0);\n  const rowHeight = 30;\n  \n  const bgColor = isEven ? BRAND_COLORS.lightGray : BRAND_COLORS.white;\n  \n  // Row background\n  doc.save();\n  doc.rect(tableX, y, totalWidth, rowHeight).fillAndStroke(bgColor, BRAND_COLORS.border);\n  doc.restore();\n  \n  // Row text\n  doc.fontSize(10).fillColor(BRAND_COLORS.black);\n  let currentX = tableX + 10;\n  \n  columns.forEach(col => {\n    if (col.bold) {\n      doc.font(\"Helvetica-Bold\");\n    } else {\n      doc.font(\"Helvetica\");\n    }\n    doc.text(col.text, currentX, y + 8, { \n      width: col.width - 20, \n      align: col.align || \"left\" \n    });\n    currentX += col.width;\n  });\n  \n  return y + rowHeight;\n}\n\n/**\n * Add a summary section with key-value pairs\n */\nexport function addSummarySection(\n  doc: typeof PDFDocument.prototype,\n  y: number,\n  items: Array<{ label: string; value: string; highlight?: boolean }>\n): number {\n  const labelX = 350;\n  const valueX = 480;\n  const lineHeight = 25;\n  let currentY = y;\n  \n  items.forEach(item => {\n    doc.fontSize(10).font(\"Helvetica\").fillColor(BRAND_COLORS.gray);\n    doc.text(item.label, labelX, currentY, { width: 120, align: \"right\" });\n    \n    if (item.highlight) {\n      doc.fontSize(12).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.primary);\n    } else {\n      doc.fontSize(11).font(\"Helvetica-Bold\").fillColor(BRAND_COLORS.black);\n    }\n    doc.text(item.value, valueX, currentY, { width: 75, align: \"right\" });\n    \n    currentY += lineHeight;\n  });\n  \n  return currentY;\n}\n","path":null,"size_bytes":6275,"size_tokens":null},"client/src/pages/payroll-report.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { FileText, FileSpreadsheet, Users, DollarSign, TrendingUp } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { sumAmounts } from \"@shared/currency\";\nimport Decimal from \"decimal.js-light\";\n\ntype Employee = {\n  id: string;\n  employeeId: string;\n  userId: string;\n};\n\ntype User = {\n  id: string;\n  name: string;\n};\n\ntype Payroll = {\n  id: string;\n  employeeId: string;\n  month: number;\n  year: number;\n  basicSalary: string;\n  totalAllowances: string;\n  overtimeAmount: string;\n  loanDeduction: string;\n  lateDeduction: string;\n  otherDeductions: string;\n  grossSalary: string;\n  netSalary: string;\n  totalLateDays: number;\n  totalAbsentDays: number;\n  totalPresentDays: number;\n  totalOvertimeHours: string;\n  workingDays: number;\n  status: string;\n  paidAt?: string;\n  createdAt: string;\n};\n\ntype PayrollWithEmployee = {\n  payroll: Payroll;\n  employee: Employee | null;\n  user: User | null;\n};\n\nexport default function PayrollReport() {\n  const currentMonth = new Date().getMonth() + 1;\n  const currentYear = new Date().getFullYear();\n  const [selectedMonth, setSelectedMonth] = useState(currentMonth.toString());\n  const [selectedYear, setSelectedYear] = useState(currentYear.toString());\n  const { toast } = useToast();\n\n  const { data: payrolls, isLoading } = useQuery<PayrollWithEmployee[]>({\n    queryKey: [\"/api/payroll-report\", selectedMonth, selectedYear],\n    queryFn: async () => {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/payroll-report?month=${selectedMonth}&year=${selectedYear}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) {\n        if (response.status === 403) {\n          throw new Error(\"Access denied\");\n        }\n        throw new Error(\"Failed to fetch payroll report\");\n      }\n      \n      return response.json();\n    }\n  });\n\n  // Export to PDF\n  const exportToPDF = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/payroll-report/export-pdf?month=${selectedMonth}&year=${selectedYear}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) {\n        if (response.status === 403) {\n          throw new Error(\"Access denied - insufficient permissions\");\n        }\n        throw new Error(\"Failed to generate PDF\");\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Payroll-Report-${selectedMonth}-${selectedYear}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"PDF Downloaded\",\n        description: \"Payroll Report exported successfully\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Export Failed\",\n        description: error.message || \"Failed to export PDF\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Export to Excel\n  const exportToExcel = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/payroll-report/export-excel?month=${selectedMonth}&year=${selectedYear}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) {\n        if (response.status === 403) {\n          throw new Error(\"Access denied - insufficient permissions\");\n        }\n        throw new Error(\"Failed to generate Excel\");\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Payroll-Report-${selectedMonth}-${selectedYear}.xlsx`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Excel Downloaded\",\n        description: \"Payroll Report exported successfully\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Export Failed\",\n        description: error.message || \"Failed to export Excel\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Export to Word\n  const exportToWord = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/payroll-report/export-word?month=${selectedMonth}&year=${selectedYear}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) {\n        if (response.status === 403) {\n          throw new Error(\"Access denied - insufficient permissions\");\n        }\n        throw new Error(\"Failed to generate Word document\");\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Payroll-Report-${selectedMonth}-${selectedYear}.docx`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Word Document Downloaded\",\n        description: \"Payroll Report exported successfully\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Export Failed\",\n        description: error.message || \"Failed to export Word document\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Calculate totals using Decimal.js with null-safe handling\n  const totalEmployees = payrolls?.length || 0;\n  const totalGrossSalary = sumAmounts((payrolls || []).map(p => p.payroll.grossSalary || \"0\"));\n  const totalDeductions = sumAmounts(\n    (payrolls || []).flatMap(p => [\n      p.payroll.loanDeduction || \"0\",\n      p.payroll.lateDeduction || \"0\",\n      p.payroll.otherDeductions || \"0\"\n    ])\n  );\n  const totalNetSalary = sumAmounts((payrolls || []).map(p => p.payroll.netSalary || \"0\"));\n  const totalPaidCount = (payrolls || []).filter(p => p.payroll.status === \"paid\").length;\n\n  const months = [\n    { value: \"1\", label: \"January\" },\n    { value: \"2\", label: \"February\" },\n    { value: \"3\", label: \"March\" },\n    { value: \"4\", label: \"April\" },\n    { value: \"5\", label: \"May\" },\n    { value: \"6\", label: \"June\" },\n    { value: \"7\", label: \"July\" },\n    { value: \"8\", label: \"August\" },\n    { value: \"9\", label: \"September\" },\n    { value: \"10\", label: \"October\" },\n    { value: \"11\", label: \"November\" },\n    { value: \"12\", label: \"December\" },\n  ];\n\n  const years = Array.from({ length: 11 }, (_, i) => (currentYear - 5 + i).toString());\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-payroll-report\">Payroll Report</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"text-subtitle\">Employee salary breakdown and payroll summary</p>\n        </div>\n        <div className=\"flex flex-wrap items-center gap-4\">\n          <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n            <SelectTrigger className=\"w-[140px]\" data-testid=\"select-month\">\n              <SelectValue placeholder=\"Month\" />\n            </SelectTrigger>\n            <SelectContent>\n              {months.map((month) => (\n                <SelectItem key={month.value} value={month.value} data-testid={`option-month-${month.value}`}>\n                  {month.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Select value={selectedYear} onValueChange={setSelectedYear}>\n            <SelectTrigger className=\"w-[120px]\" data-testid=\"select-year\">\n              <SelectValue placeholder=\"Year\" />\n            </SelectTrigger>\n            <SelectContent>\n              {years.map((year) => (\n                <SelectItem key={year} value={year} data-testid={`option-year-${year}`}>\n                  {year}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <div className=\"flex flex-wrap gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={exportToPDF}\n              data-testid=\"button-export-pdf\"\n            >\n              <FileText className=\"h-4 w-4 mr-2\" />\n              PDF\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={exportToExcel}\n              data-testid=\"button-export-excel\"\n            >\n              <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n              Excel\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={exportToWord}\n              data-testid=\"button-export-word\"\n            >\n              <FileText className=\"h-4 w-4 mr-2\" />\n              Word\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card data-testid=\"card-total-employees\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Employees</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-employees\">{totalEmployees}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              {totalPaidCount} paid\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-gross-salary\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Gross Salary</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-gross-salary\">\n              {parseFloat(totalGrossSalary).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Before deductions\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-deductions\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Deductions</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-red-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-total-deductions\">\n              {parseFloat(totalDeductions).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Loans, lates, other\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-net-payroll\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Net Payroll Cost</CardTitle>\n            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-net-payroll\">\n              {parseFloat(totalNetSalary).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Total payout\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Employee Breakdown */}\n      <Card data-testid=\"card-employee-breakdown\">\n        <CardHeader>\n          <CardTitle>Employee Breakdown</CardTitle>\n          <CardDescription>\n            Detailed salary information for {months.find(m => m.value === selectedMonth)?.label} {selectedYear}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">Loading payroll data...</div>\n          ) : !payrolls || payrolls.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-payroll\">\n              No payroll records found for this period\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {payrolls.map((record, index) => {\n                const totalDed = sumAmounts([\n                  record.payroll.loanDeduction || \"0\",\n                  record.payroll.lateDeduction || \"0\",\n                  record.payroll.otherDeductions || \"0\"\n                ]);\n                \n                return (\n                  <div key={record.payroll.id} className=\"p-4 rounded-md bg-card border\" data-testid={`payroll-${index}`}>\n                    <div className=\"flex items-center justify-between gap-2 mb-3\">\n                      <div>\n                        <h3 className=\"font-semibold\" data-testid={`text-employee-name-${index}`}>\n                          {record.user?.name || \"Unknown Employee\"}\n                        </h3>\n                        <p className=\"text-sm text-muted-foreground\" data-testid={`text-employee-id-${index}`}>\n                          ID: {record.employee?.employeeId || \"N/A\"}\n                        </p>\n                      </div>\n                      <Badge\n                        variant={record.payroll.status === \"paid\" ? \"default\" : record.payroll.status === \"draft\" ? \"secondary\" : \"outline\"}\n                        data-testid={`badge-status-${index}`}\n                      >\n                        {record.payroll.status}\n                      </Badge>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                      <div>\n                        <div className=\"text-muted-foreground\">Basic Salary</div>\n                        <div className=\"font-medium\" data-testid={`text-basic-${index}`}>\n                          {parseFloat(record.payroll.basicSalary).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </div>\n                      </div>\n                      <div>\n                        <div className=\"text-muted-foreground\">Allowances</div>\n                        <div className=\"font-medium text-green-600\" data-testid={`text-allowances-${index}`}>\n                          +{parseFloat(record.payroll.totalAllowances).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </div>\n                      </div>\n                      <div>\n                        <div className=\"text-muted-foreground\">Deductions</div>\n                        <div className=\"font-medium text-red-600\" data-testid={`text-deductions-${index}`}>\n                          -{parseFloat(totalDed).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </div>\n                      </div>\n                      <div>\n                        <div className=\"text-muted-foreground\">Net Salary</div>\n                        <div className=\"font-medium text-lg\" data-testid={`text-net-${index}`}>\n                          {parseFloat(record.payroll.netSalary).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-3 gap-4 text-sm mt-3 pt-3 border-t\">\n                      <div>\n                        <div className=\"text-muted-foreground\">Present Days</div>\n                        <div className=\"font-medium\" data-testid={`text-present-${index}`}>{record.payroll.totalPresentDays}/{record.payroll.workingDays}</div>\n                      </div>\n                      <div>\n                        <div className=\"text-muted-foreground\">Absent/Late</div>\n                        <div className=\"font-medium\" data-testid={`text-absent-late-${index}`}>\n                          {record.payroll.totalAbsentDays}/{record.payroll.totalLateDays}\n                        </div>\n                      </div>\n                      <div>\n                        <div className=\"text-muted-foreground\">Overtime</div>\n                        <div className=\"font-medium\" data-testid={`text-overtime-${index}`}>\n                          {parseFloat(record.payroll.totalOvertimeHours).toFixed(1)}h\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":17428,"size_tokens":null},"client/src/pages/salary-sheet.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { FileText, FileSpreadsheet, FileType, Calendar, DollarSign, Plus, Trash2, RefreshCw, Clock, CheckCircle2, Edit } from \"lucide-react\";\nimport { sumAmounts } from \"@shared/currency\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ntype User = {\n  id: string;\n  fullName: string;\n  email: string;\n};\n\ntype Employee = {\n  id: string;\n  employeeId: string;\n  userId: string;\n  departmentId: string | null;\n  designationId: string | null;\n  status: string;\n};\n\ntype Department = {\n  id: string;\n  name: string;\n} | null;\n\ntype Designation = {\n  id: string;\n  title: string;\n} | null;\n\ntype SalaryStructure = {\n  id: string;\n  employeeId: string;\n  basicSalary: string;\n  houseAllowance: string;\n  foodAllowance: string;\n  travelAllowance: string;\n  medicalAllowance: string;\n  otherAllowances: string;\n} | null;\n\ntype Payroll = {\n  id: string;\n  employeeId: string;\n  month: number;\n  year: number;\n  basicSalary: string;\n  totalAllowances: string;\n  overtimeAmount: string;\n  loanDeduction: string;\n  lateDeduction: string;\n  otherDeductions: string;\n  grossSalary: string;\n  netSalary: string;\n  totalLateDays: number;\n  totalAbsentDays: number;\n  totalPresentDays: number;\n  totalOvertimeHours: string;\n  workingDays: number;\n  status: string;\n  paidAt?: string;\n  createdAt: string;\n} | null;\n\ntype SalaryAdjustment = {\n  id: string;\n  payrollId: string;\n  type: string;\n  amount: string;\n  reason: string;\n  createdBy: string;\n  createdAt: string;\n  creator?: {\n    fullName: string;\n  };\n};\n\ntype SalarySheetRecord = {\n  employee: Employee;\n  user: User;\n  department: Department;\n  designation: Designation;\n  salaryStructure: SalaryStructure;\n  payroll: Payroll;\n};\n\nexport default function SalarySheet() {\n  const currentMonth = new Date().getMonth() + 1;\n  const currentYear = new Date().getFullYear();\n  const [selectedMonth, setSelectedMonth] = useState(currentMonth.toString());\n  const [selectedYear, setSelectedYear] = useState(currentYear.toString());\n  const [adjustmentDialogOpen, setAdjustmentDialogOpen] = useState(false);\n  const [viewAdjustmentsDialogOpen, setViewAdjustmentsDialogOpen] = useState(false);\n  const [statusDialogOpen, setStatusDialogOpen] = useState(false);\n  const [selectedPayroll, setSelectedPayroll] = useState<Payroll | null>(null);\n  const [adjustmentForm, setAdjustmentForm] = useState({\n    type: \"bonus\",\n    amount: \"\",\n    reason: \"\"\n  });\n  const { toast } = useToast();\n\n  const { data: salaryRecords, isLoading, refetch } = useQuery<SalarySheetRecord[]>({\n    queryKey: [\"/api/salary-sheet\", selectedMonth, selectedYear],\n    queryFn: async () => {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/salary-sheet?month=${selectedMonth}&year=${selectedYear}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) {\n        if (response.status === 403) {\n          throw new Error(\"Access denied\");\n        }\n        throw new Error(\"Failed to fetch salary sheet\");\n      }\n      \n      return response.json();\n    }\n  });\n\n  // Get adjustments for selected payroll\n  const { data: adjustments } = useQuery<SalaryAdjustment[]>({\n    queryKey: [\"/api/payroll\", selectedPayroll?.id, \"adjustments\"],\n    enabled: !!selectedPayroll && viewAdjustmentsDialogOpen,\n    queryFn: async () => {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/payroll/${selectedPayroll!.id}/adjustments`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) {\n        throw new Error(\"Failed to fetch adjustments\");\n      }\n      \n      return response.json();\n    }\n  });\n\n  // Generate salary mutation\n  const generateSalaryMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/payroll/generate\", {\n        month: parseInt(selectedMonth),\n        year: parseInt(selectedYear)\n      });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Salary Generated\",\n        description: \"Salary has been successfully generated for all employees\",\n      });\n      refetch();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Generation Failed\",\n        description: error.message || \"Failed to generate salary\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Add adjustment mutation\n  const addAdjustmentMutation = useMutation({\n    mutationFn: async ({ payrollId, data }: { payrollId: string; data: any }) => {\n      return apiRequest(\"POST\", `/api/payroll/${payrollId}/adjustments`, data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Adjustment Added\",\n        description: \"Salary adjustment has been applied successfully\",\n      });\n      setAdjustmentDialogOpen(false);\n      setAdjustmentForm({ type: \"bonus\", amount: \"\", reason: \"\" });\n      refetch();\n      // Invalidate both payroll records and adjustments queries\n      queryClient.invalidateQueries({ queryKey: [\"/api/payroll\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Adjustment Failed\",\n        description: error.message || \"Failed to add adjustment\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Delete adjustment mutation\n  const deleteAdjustmentMutation = useMutation({\n    mutationFn: async ({ payrollId, adjustmentId }: { payrollId: string; adjustmentId: string }) => {\n      return apiRequest(\"DELETE\", `/api/payroll/${payrollId}/adjustments/${adjustmentId}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Adjustment Deleted\",\n        description: \"Salary adjustment has been removed successfully\",\n      });\n      refetch();\n      queryClient.invalidateQueries({ queryKey: [\"/api/payroll\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Delete Failed\",\n        description: error.message || \"Failed to delete adjustment\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Update status mutation\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ payrollId, status }: { payrollId: string; status: string }) => {\n      return apiRequest(\"PATCH\", `/api/payroll/${payrollId}/status`, { status });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Status Updated\",\n        description: \"Payment status has been updated successfully\",\n      });\n      setStatusDialogOpen(false);\n      refetch();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message || \"Failed to update status\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Export to PDF\n  const exportToPDF = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/salary-sheet/export-pdf?month=${selectedMonth}&year=${selectedYear}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) {\n        if (response.status === 403) {\n          throw new Error(\"Access denied - insufficient permissions\");\n        }\n        throw new Error(\"Failed to generate PDF\");\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Salary-Sheet-${selectedMonth}-${selectedYear}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"PDF Downloaded\",\n        description: \"Salary Sheet exported successfully\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Export Failed\",\n        description: error.message || \"Failed to export PDF\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Export to Excel\n  const exportToExcel = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/salary-sheet/export-excel?month=${selectedMonth}&year=${selectedYear}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) {\n        if (response.status === 403) {\n          throw new Error(\"Access denied - insufficient permissions\");\n        }\n        throw new Error(\"Failed to generate Excel\");\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Salary-Sheet-${selectedMonth}-${selectedYear}.xlsx`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Excel Downloaded\",\n        description: \"Salary Sheet exported successfully\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Export Failed\",\n        description: error.message || \"Failed to export Excel\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Export to Word\n  const exportToWord = async () => {\n    try {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/salary-sheet/export-word?month=${selectedMonth}&year=${selectedYear}`, {\n        headers: {\n          \"Authorization\": `Bearer ${token}`\n        }\n      });\n      \n      if (!response.ok) {\n        if (response.status === 403) {\n          throw new Error(\"Access denied - insufficient permissions\");\n        }\n        throw new Error(\"Failed to generate Word document\");\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Salary-Sheet-${selectedMonth}-${selectedYear}.docx`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Word Document Downloaded\",\n        description: \"Salary Sheet exported successfully\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Export Failed\",\n        description: error.message || \"Failed to export Word document\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleAddAdjustment = () => {\n    if (!selectedPayroll) return;\n    \n    // Validate amount\n    const amountValue = parseFloat(adjustmentForm.amount);\n    if (!adjustmentForm.amount || isNaN(amountValue) || amountValue <= 0) {\n      toast({\n        title: \"Invalid Amount\",\n        description: \"Please enter a valid positive amount\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!adjustmentForm.reason.trim()) {\n      toast({\n        title: \"Reason Required\",\n        description: \"Please provide a reason for this adjustment\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Determine if amount should be negative (penalties and deductions subtract from salary)\n    const isDeduction = adjustmentForm.type === \"penalty\" || \n                        adjustmentForm.type === \"loan_deduction\" || \n                        adjustmentForm.type === \"advance\";\n    const finalAmount = isDeduction ? -Math.abs(amountValue) : Math.abs(amountValue);\n\n    addAdjustmentMutation.mutate({\n      payrollId: selectedPayroll.id,\n      data: {\n        type: adjustmentForm.type,\n        amount: Number(finalAmount.toFixed(2)), // Send as number with 2 decimal precision\n        reason: adjustmentForm.reason\n      }\n    });\n  };\n\n  const handleUpdateStatus = (newStatus: string) => {\n    if (!selectedPayroll) return;\n\n    // Prevent status regression: Cannot go back from \"paid\" to \"draft\" or \"generated\"\n    if (selectedPayroll.status === \"paid\" && (newStatus === \"draft\" || newStatus === \"generated\")) {\n      toast({\n        title: \"Invalid Status Change\",\n        description: \"Cannot change status from 'Paid' back to 'Draft' or 'Generated'. This is a one-way workflow.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Prevent going back from \"generated\" to \"draft\" (optional - uncomment if needed)\n    // if (selectedPayroll.status === \"generated\" && newStatus === \"draft\") {\n    //   toast({\n    //     title: \"Invalid Status Change\",\n    //     description: \"Cannot change status from 'Generated' back to 'Draft'.\",\n    //     variant: \"destructive\",\n    //   });\n    //   return;\n    // }\n\n    updateStatusMutation.mutate({\n      payrollId: selectedPayroll.id,\n      status: newStatus\n    });\n  };\n\n  // Calculate totals with null-safe handling\n  const totalEmployees = salaryRecords?.length || 0;\n  \n  const totalBasic = sumAmounts((salaryRecords || []).map(r => \n    r.payroll?.basicSalary || r.salaryStructure?.basicSalary || \"0\"\n  ));\n  \n  const totalAllowances = sumAmounts((salaryRecords || []).map(r => \n    r.payroll?.totalAllowances || sumAmounts([\n      r.salaryStructure?.houseAllowance || \"0\",\n      r.salaryStructure?.foodAllowance || \"0\",\n      r.salaryStructure?.travelAllowance || \"0\",\n      r.salaryStructure?.medicalAllowance || \"0\",\n      r.salaryStructure?.otherAllowances || \"0\"\n    ])\n  ));\n  \n  const totalDeductions = sumAmounts(\n    (salaryRecords || []).flatMap(r => [\n      r.payroll?.loanDeduction || \"0\",\n      r.payroll?.lateDeduction || \"0\",\n      r.payroll?.otherDeductions || \"0\"\n    ])\n  );\n  \n  const totalOvertime = sumAmounts((salaryRecords || []).map(r => r.payroll?.overtimeAmount || \"0\"));\n  \n  const totalNetSalary = sumAmounts((salaryRecords || []).map(r => {\n    if (r.payroll?.netSalary) {\n      return r.payroll.netSalary;\n    }\n    const basic = r.salaryStructure?.basicSalary || \"0\";\n    const allowances = sumAmounts([\n      r.salaryStructure?.houseAllowance || \"0\",\n      r.salaryStructure?.foodAllowance || \"0\",\n      r.salaryStructure?.travelAllowance || \"0\",\n      r.salaryStructure?.medicalAllowance || \"0\",\n      r.salaryStructure?.otherAllowances || \"0\"\n    ]);\n    return sumAmounts([basic, allowances]);\n  }));\n  \n  const totalPaidCount = (salaryRecords || []).filter(r => r.payroll?.status === \"paid\").length;\n  const hasGeneratedSalary = (salaryRecords || []).some(r => r.payroll !== null);\n\n  const months = [\n    { value: \"1\", label: \"January\" },\n    { value: \"2\", label: \"February\" },\n    { value: \"3\", label: \"March\" },\n    { value: \"4\", label: \"April\" },\n    { value: \"5\", label: \"May\" },\n    { value: \"6\", label: \"June\" },\n    { value: \"7\", label: \"July\" },\n    { value: \"8\", label: \"August\" },\n    { value: \"9\", label: \"September\" },\n    { value: \"10\", label: \"October\" },\n    { value: \"11\", label: \"November\" },\n    { value: \"12\", label: \"December\" }\n  ];\n\n  const years = Array.from({ length: 11 }, (_, i) => ({\n    value: (currentYear - 5 + i).toString(),\n    label: (currentYear - 5 + i).toString()\n  }));\n\n  const adjustmentTypes = [\n    { value: \"bonus\", label: \"Bonus\" },\n    { value: \"penalty\", label: \"Penalty\" },\n    { value: \"loan_deduction\", label: \"Loan Deduction\" },\n    { value: \"advance\", label: \"Advance\" },\n    { value: \"other\", label: \"Other\" }\n  ];\n\n  const getStatusBadgeVariant = (status: string) => {\n    switch (status) {\n      case \"paid\":\n        return \"default\";\n      case \"generated\":\n        return \"secondary\";\n      case \"draft\":\n        return \"outline\";\n      default:\n        return \"outline\";\n    }\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case \"paid\":\n        return <CheckCircle2 className=\"w-3 h-3 mr-1\" />;\n      case \"generated\":\n        return <Clock className=\"w-3 h-3 mr-1\" />;\n      default:\n        return <Edit className=\"w-3 h-3 mr-1\" />;\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-salary-sheet\">Salary Sheet</h1>\n          <p className=\"text-muted-foreground\">Monthly salary details with attendance integration</p>\n        </div>\n      </div>\n\n      {/* Period Selector and Actions */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calendar className=\"w-5 h-5\" />\n            Select Period & Actions\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex gap-4 flex-wrap items-end\">\n            <div className=\"flex-1 min-w-[200px]\">\n              <label className=\"text-sm font-medium mb-2 block\">Month</label>\n              <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                <SelectTrigger data-testid=\"select-month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {months.map((month) => (\n                    <SelectItem key={month.value} value={month.value}>\n                      {month.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex-1 min-w-[200px]\">\n              <label className=\"text-sm font-medium mb-2 block\">Year</label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger data-testid=\"select-year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {years.map((year) => (\n                    <SelectItem key={year.value} value={year.value}>\n                      {year.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"flex gap-2 flex-wrap pt-2 border-t\">\n            {/* Generate/Regenerate Salary */}\n            {hasGeneratedSalary ? (\n              <AlertDialog>\n                <AlertDialogTrigger asChild>\n                  <Button variant=\"default\" data-testid=\"button-regenerate-salary\">\n                    <RefreshCw className=\"w-4 h-4 mr-2\" />\n                    Regenerate Salary\n                  </Button>\n                </AlertDialogTrigger>\n                <AlertDialogContent>\n                  <AlertDialogHeader>\n                    <AlertDialogTitle>Regenerate Salary?</AlertDialogTitle>\n                    <AlertDialogDescription>\n                      This will delete existing salary records and adjustments for {months.find(m => m.value === selectedMonth)?.label} {selectedYear}, then recalculate based on current attendance data. This action cannot be undone.\n                    </AlertDialogDescription>\n                  </AlertDialogHeader>\n                  <AlertDialogFooter>\n                    <AlertDialogCancel data-testid=\"button-cancel-regenerate\">Cancel</AlertDialogCancel>\n                    <AlertDialogAction \n                      onClick={() => generateSalaryMutation.mutate()}\n                      disabled={generateSalaryMutation.isPending}\n                      data-testid=\"button-confirm-regenerate\"\n                    >\n                      {generateSalaryMutation.isPending ? \"Regenerating...\" : \"Regenerate\"}\n                    </AlertDialogAction>\n                  </AlertDialogFooter>\n                </AlertDialogContent>\n              </AlertDialog>\n            ) : (\n              <Button \n                onClick={() => generateSalaryMutation.mutate()}\n                disabled={generateSalaryMutation.isPending}\n                data-testid=\"button-generate-salary\"\n              >\n                <DollarSign className=\"w-4 h-4 mr-2\" />\n                {generateSalaryMutation.isPending ? \"Generating...\" : \"Generate Salary\"}\n              </Button>\n            )}\n\n            {/* Export Buttons */}\n            <Button onClick={exportToPDF} variant=\"outline\" data-testid=\"button-export-pdf\">\n              <FileText className=\"w-4 h-4 mr-2\" />\n              Export PDF\n            </Button>\n            <Button onClick={exportToExcel} variant=\"outline\" data-testid=\"button-export-excel\">\n              <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n              Export Excel\n            </Button>\n            <Button onClick={exportToWord} variant=\"outline\" data-testid=\"button-export-word\">\n              <FileType className=\"w-4 h-4 mr-2\" />\n              Export Word\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Summary Cards */}\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-6\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Employees</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-employees\">{totalEmployees}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">{totalPaidCount} paid</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Basic</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-basic\">\n              {parseFloat(totalBasic).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Allowances</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-allowances\">\n              {parseFloat(totalAllowances).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Deductions</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-total-deductions\">\n              {parseFloat(totalDeductions).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Overtime</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-overtime\">\n              {parseFloat(totalOvertime).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Net Payable</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-primary\" data-testid=\"text-net-payable\">\n              {parseFloat(totalNetSalary).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Salary Sheet Details */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Employee Salary Details</CardTitle>\n          <CardDescription>\n            Comprehensive salary sheet for {months.find(m => m.value === selectedMonth)?.label} {selectedYear}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">Loading salary data...</div>\n          ) : !salaryRecords || salaryRecords.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-records\">\n              No employees with salary structures found for this period\n            </div>\n          ) : (\n            <div className=\"rounded-md border overflow-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead data-testid=\"header-name\">Employee</TableHead>\n                    <TableHead data-testid=\"header-id\">ID</TableHead>\n                    <TableHead data-testid=\"header-dept\">Department</TableHead>\n                    <TableHead data-testid=\"header-designation\">Designation</TableHead>\n                    <TableHead className=\"text-center\" data-testid=\"header-present\">Present</TableHead>\n                    <TableHead className=\"text-center\" data-testid=\"header-absent\">Absent</TableHead>\n                    <TableHead className=\"text-center\" data-testid=\"header-late\">Late</TableHead>\n                    <TableHead className=\"text-center\" data-testid=\"header-half\">Half-Day</TableHead>\n                    <TableHead className=\"text-center\" data-testid=\"header-ot\">OT (hrs)</TableHead>\n                    <TableHead className=\"text-right\" data-testid=\"header-basic\">Basic</TableHead>\n                    <TableHead className=\"text-right\" data-testid=\"header-allowances\">Allowances</TableHead>\n                    <TableHead className=\"text-right\" data-testid=\"header-deductions\">Deductions</TableHead>\n                    <TableHead className=\"text-right\" data-testid=\"header-overtime\">Overtime</TableHead>\n                    <TableHead className=\"text-right\" data-testid=\"header-net\">Net Salary</TableHead>\n                    <TableHead className=\"text-center\" data-testid=\"header-status\">Status</TableHead>\n                    <TableHead className=\"text-center\" data-testid=\"header-actions\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {salaryRecords.map((record, index) => {\n                    const basicSalary = record.payroll?.basicSalary || record.salaryStructure?.basicSalary || \"0\";\n                    const allowances = record.payroll?.totalAllowances || sumAmounts([\n                      record.salaryStructure?.houseAllowance || \"0\",\n                      record.salaryStructure?.foodAllowance || \"0\",\n                      record.salaryStructure?.travelAllowance || \"0\",\n                      record.salaryStructure?.medicalAllowance || \"0\",\n                      record.salaryStructure?.otherAllowances || \"0\"\n                    ]);\n                    const overtime = record.payroll?.overtimeAmount || \"0\";\n                    const deductions = sumAmounts([\n                      record.payroll?.loanDeduction || \"0\",\n                      record.payroll?.lateDeduction || \"0\",\n                      record.payroll?.otherDeductions || \"0\"\n                    ]);\n                    const netSalary = record.payroll?.netSalary || sumAmounts([basicSalary, allowances, overtime, `-${deductions}`]);\n                    const status = record.payroll?.status || \"Not Generated\";\n\n                    return (\n                      <TableRow key={record.employee.id} data-testid={`salary-row-${index}`}>\n                        <TableCell className=\"font-medium\" data-testid={`text-employee-name-${index}`}>\n                          {record.user.fullName}\n                        </TableCell>\n                        <TableCell data-testid={`text-employee-id-${index}`}>\n                          {record.employee.employeeId}\n                        </TableCell>\n                        <TableCell data-testid={`text-department-${index}`}>\n                          {record.department?.name || \"N/A\"}\n                        </TableCell>\n                        <TableCell data-testid={`text-designation-${index}`}>\n                          {record.designation?.title || \"N/A\"}\n                        </TableCell>\n                        <TableCell className=\"text-center\" data-testid={`text-present-${index}`}>\n                          {record.payroll?.totalPresentDays || \"-\"}\n                        </TableCell>\n                        <TableCell className=\"text-center\" data-testid={`text-absent-${index}`}>\n                          {record.payroll?.totalAbsentDays || \"-\"}\n                        </TableCell>\n                        <TableCell className=\"text-center\" data-testid={`text-late-${index}`}>\n                          {record.payroll?.totalLateDays || \"-\"}\n                        </TableCell>\n                        <TableCell className=\"text-center\" data-testid={`text-half-${index}`}>\n                          {record.payroll?.totalHalfDays || \"-\"}\n                        </TableCell>\n                        <TableCell className=\"text-center\" data-testid={`text-ot-${index}`}>\n                          {record.payroll?.totalOvertimeHours ? parseFloat(record.payroll.totalOvertimeHours).toFixed(1) : \"-\"}\n                        </TableCell>\n                        <TableCell className=\"text-right\" data-testid={`text-basic-${index}`}>\n                          {parseFloat(basicSalary).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </TableCell>\n                        <TableCell className=\"text-right text-green-600\" data-testid={`text-allowances-${index}`}>\n                          {parseFloat(allowances).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </TableCell>\n                        <TableCell className=\"text-right text-red-600\" data-testid={`text-deductions-${index}`}>\n                          {parseFloat(deductions).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </TableCell>\n                        <TableCell className=\"text-right\" data-testid={`text-overtime-${index}`}>\n                          {parseFloat(overtime).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </TableCell>\n                        <TableCell className=\"text-right font-bold\" data-testid={`text-net-${index}`}>\n                          {parseFloat(netSalary).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </TableCell>\n                        <TableCell className=\"text-center\" data-testid={`text-payment-${index}`}>\n                          <Badge\n                            variant={getStatusBadgeVariant(status)}\n                            className=\"flex items-center justify-center whitespace-nowrap\"\n                            data-testid={`badge-status-${index}`}\n                          >\n                            {getStatusIcon(status)}\n                            {status}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <div className=\"flex gap-1 justify-center\">\n                            {/* Add Adjustment */}\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => {\n                                setSelectedPayroll(record.payroll);\n                                setAdjustmentDialogOpen(true);\n                              }}\n                              disabled={!record.payroll}\n                              data-testid={`button-add-adjustment-${index}`}\n                            >\n                              <Plus className=\"w-3 h-3\" />\n                            </Button>\n                            \n                            {/* View Adjustments */}\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => {\n                                setSelectedPayroll(record.payroll);\n                                setViewAdjustmentsDialogOpen(true);\n                              }}\n                              disabled={!record.payroll}\n                              data-testid={`button-view-adjustments-${index}`}\n                            >\n                              <Edit className=\"w-3 h-3\" />\n                            </Button>\n\n                            {/* Update Status */}\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => {\n                                setSelectedPayroll(record.payroll);\n                                setStatusDialogOpen(true);\n                              }}\n                              disabled={!record.payroll}\n                              data-testid={`button-update-status-${index}`}\n                            >\n                              <CheckCircle2 className=\"w-3 h-3\" />\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Add Adjustment Dialog */}\n      <Dialog open={adjustmentDialogOpen} onOpenChange={setAdjustmentDialogOpen}>\n        <DialogContent data-testid=\"dialog-add-adjustment\">\n          <DialogHeader>\n            <DialogTitle>Add Salary Adjustment</DialogTitle>\n            <DialogDescription>\n              Add a manual adjustment to the salary (bonus, penalty, loan deduction, etc.)\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"adjustment-type\">Adjustment Type</Label>\n              <Select \n                value={adjustmentForm.type} \n                onValueChange={(value) => setAdjustmentForm({ ...adjustmentForm, type: value })}\n              >\n                <SelectTrigger id=\"adjustment-type\" data-testid=\"select-adjustment-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {adjustmentTypes.map((type) => (\n                    <SelectItem key={type.value} value={type.value}>\n                      {type.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"adjustment-amount\">Amount</Label>\n              <Input\n                id=\"adjustment-amount\"\n                type=\"number\"\n                step=\"0.01\"\n                min=\"0\"\n                placeholder=\"Enter amount\"\n                value={adjustmentForm.amount}\n                onChange={(e) => setAdjustmentForm({ ...adjustmentForm, amount: e.target.value })}\n                data-testid=\"input-adjustment-amount\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                {adjustmentForm.type === \"bonus\" || adjustmentForm.type === \"other\" \n                  ? \"Enter positive amount (will be added to salary)\"\n                  : \"Enter positive amount (will be deducted from salary automatically)\"}\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"adjustment-reason\">Reason</Label>\n              <Textarea\n                id=\"adjustment-reason\"\n                placeholder=\"Provide a reason for this adjustment\"\n                value={adjustmentForm.reason}\n                onChange={(e) => setAdjustmentForm({ ...adjustmentForm, reason: e.target.value })}\n                data-testid=\"textarea-adjustment-reason\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => {\n                setAdjustmentDialogOpen(false);\n                setAdjustmentForm({ type: \"bonus\", amount: \"\", reason: \"\" });\n              }}\n              data-testid=\"button-cancel-adjustment\"\n            >\n              Cancel\n            </Button>\n            <Button \n              onClick={handleAddAdjustment}\n              disabled={addAdjustmentMutation.isPending}\n              data-testid=\"button-save-adjustment\"\n            >\n              {addAdjustmentMutation.isPending ? \"Adding...\" : \"Add Adjustment\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* View Adjustments Dialog */}\n      <Dialog open={viewAdjustmentsDialogOpen} onOpenChange={setViewAdjustmentsDialogOpen}>\n        <DialogContent className=\"max-w-3xl\" data-testid=\"dialog-view-adjustments\">\n          <DialogHeader>\n            <DialogTitle>Salary Adjustments</DialogTitle>\n            <DialogDescription>\n              All manual adjustments applied to this salary record\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"py-4\">\n            {!adjustments || adjustments.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                No adjustments have been added yet\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                {adjustments.map((adj, index) => (\n                  <div \n                    key={adj.id} \n                    className=\"flex items-center justify-between p-4 border rounded-md\"\n                    data-testid={`adjustment-item-${index}`}\n                  >\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <Badge variant=\"outline\" data-testid={`badge-adjustment-type-${index}`}>\n                          {adj.type.replace(\"_\", \" \").toUpperCase()}\n                        </Badge>\n                        <span className=\"font-bold\" data-testid={`text-adjustment-amount-${index}`}>\n                          {parseFloat(adj.amount).toLocaleString(undefined, { minimumFractionDigits: 2 })} BDT\n                        </span>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\" data-testid={`text-adjustment-reason-${index}`}>\n                        {adj.reason}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Added by {adj.creator?.fullName} on {new Date(adj.createdAt).toLocaleDateString()}\n                      </p>\n                    </div>\n                    <Button\n                      size=\"sm\"\n                      variant=\"destructive\"\n                      onClick={() => {\n                        if (selectedPayroll) {\n                          deleteAdjustmentMutation.mutate({\n                            payrollId: selectedPayroll.id,\n                            adjustmentId: adj.id\n                          });\n                        }\n                      }}\n                      disabled={deleteAdjustmentMutation.isPending}\n                      data-testid={`button-delete-adjustment-${index}`}\n                    >\n                      <Trash2 className=\"w-3 h-3\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setViewAdjustmentsDialogOpen(false)}\n              data-testid=\"button-close-adjustments\"\n            >\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Update Status Dialog */}\n      <Dialog open={statusDialogOpen} onOpenChange={setStatusDialogOpen}>\n        <DialogContent data-testid=\"dialog-update-status\">\n          <DialogHeader>\n            <DialogTitle>Update Payment Status</DialogTitle>\n            <DialogDescription>\n              Change the payment status for this salary record\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-3 py-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              Current Status: <Badge variant={getStatusBadgeVariant(selectedPayroll?.status || \"draft\")}>\n                {selectedPayroll?.status || \"draft\"}\n              </Badge>\n            </p>\n            \n            <div className=\"flex gap-2 flex-wrap\">\n              <Button\n                variant={selectedPayroll?.status === \"draft\" ? \"default\" : \"outline\"}\n                onClick={() => handleUpdateStatus(\"draft\")}\n                disabled={updateStatusMutation.isPending || selectedPayroll?.status === \"draft\"}\n                data-testid=\"button-status-draft\"\n              >\n                <Edit className=\"w-4 h-4 mr-2\" />\n                Draft\n              </Button>\n              <Button\n                variant={selectedPayroll?.status === \"generated\" ? \"default\" : \"outline\"}\n                onClick={() => handleUpdateStatus(\"generated\")}\n                disabled={updateStatusMutation.isPending || selectedPayroll?.status === \"generated\"}\n                data-testid=\"button-status-generated\"\n              >\n                <Clock className=\"w-4 h-4 mr-2\" />\n                Generated\n              </Button>\n              <Button\n                variant={selectedPayroll?.status === \"paid\" ? \"default\" : \"outline\"}\n                onClick={() => handleUpdateStatus(\"paid\")}\n                disabled={updateStatusMutation.isPending || selectedPayroll?.status === \"paid\"}\n                data-testid=\"button-status-paid\"\n              >\n                <CheckCircle2 className=\"w-4 h-4 mr-2\" />\n                Paid\n              </Button>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setStatusDialogOpen(false)}\n              data-testid=\"button-close-status\"\n            >\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":42980,"size_tokens":null},"client/src/pages/salary-slip.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { FileText, FileSpreadsheet, FileType, Calendar, User } from \"lucide-react\";\nimport { formatCurrency } from \"@shared/currency\";\n\ntype Employee = {\n  id: string;\n  employeeId: string;\n  userId: string;\n  departmentId: string | null;\n  designationId: string | null;\n  user: {\n    id: string;\n    fullName: string;\n  };\n  department: {\n    id: string;\n    name: string;\n  } | null;\n  designation: {\n    id: string;\n    title: string;\n  } | null;\n};\n\ntype SalarySlipData = {\n  employee: Employee;\n  payroll: {\n    id: string;\n    month: number;\n    year: number;\n    basicSalary: string;\n    totalAllowances: string;\n    overtimeAmount: string;\n    loanDeduction: string;\n    lateDeduction: string;\n    otherDeductions: string;\n    grossSalary: string;\n    netSalary: string;\n    totalLateDays: number;\n    totalAbsentDays: number;\n    totalPresentDays: number;\n    totalOvertimeHours: string;\n    workingDays: number;\n    status: string;\n    paidAt: string | null;\n  };\n  salaryStructure: {\n    basicSalary: string;\n    houseAllowance: string;\n    foodAllowance: string;\n    travelAllowance: string;\n    medicalAllowance: string;\n    otherAllowances: string;\n  } | null;\n};\n\nexport default function SalarySlip() {\n  const { toast } = useToast();\n  const currentDate = new Date();\n  const [selectedEmployee, setSelectedEmployee] = useState<string>(\"\");\n  const [selectedMonth, setSelectedMonth] = useState<number>(currentDate.getMonth() + 1);\n  const [selectedYear, setSelectedYear] = useState<number>(currentDate.getFullYear());\n\n  // Fetch all employees\n  const { data: employees = [], isLoading: isLoadingEmployees } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"]\n  });\n\n  // Fetch salary slip data\n  const { data: salarySlip, isLoading: isLoadingSlip } = useQuery<SalarySlipData>({\n    queryKey: [\"/api/salary-slip\", selectedEmployee, selectedMonth, selectedYear],\n    queryFn: async () => {\n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(\n        `/api/salary-slip?employeeId=${selectedEmployee}&month=${selectedMonth}&year=${selectedYear}`,\n        {\n          headers: {\n            Authorization: `Bearer ${token}`,\n            \"Content-Type\": \"application/json\"\n          }\n        }\n      );\n      \n      if (!response.ok) {\n        if (response.status === 404) {\n          return null;\n        }\n        throw new Error(\"Failed to fetch salary slip\");\n      }\n      \n      return response.json();\n    },\n    enabled: !!selectedEmployee && !!selectedMonth && !!selectedYear\n  });\n\n  const monthNames = [\n    \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n  ];\n\n  const handleExport = async (format: 'pdf' | 'excel' | 'word') => {\n    if (!selectedEmployee || !selectedMonth || !selectedYear) {\n      toast({\n        title: \"Missing Information\",\n        description: \"Please select employee and period first\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    try {\n      const endpoint = `/api/salary-slip/export-${format}?employeeId=${selectedEmployee}&month=${selectedMonth}&year=${selectedYear}`;\n      const response = await fetch(endpoint, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem(\"token\")}`\n        }\n      });\n\n      if (response.status === 403) {\n        toast({\n          title: \"Access Denied\",\n          description: \"You don't have permission to export salary slips\",\n          variant: \"destructive\"\n        });\n        return;\n      }\n\n      if (!response.ok) {\n        throw new Error(\"Export failed\");\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Salary-Slip-${salarySlip?.employee.employeeId}-${selectedMonth}-${selectedYear}.${format === 'excel' ? 'xlsx' : format === 'word' ? 'docx' : 'pdf'}`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Export Successful\",\n        description: `Salary slip exported as ${format.toUpperCase()}`\n      });\n    } catch (error) {\n      console.error(\"Export error:\", error);\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to export salary slip\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  const calculateTotalEarnings = () => {\n    if (!salarySlip) return \"0\";\n    const basic = parseFloat(salarySlip.payroll.basicSalary || \"0\");\n    const allowances = parseFloat(salarySlip.payroll.totalAllowances || \"0\");\n    const overtime = parseFloat(salarySlip.payroll.overtimeAmount || \"0\");\n    return (basic + allowances + overtime).toFixed(2);\n  };\n\n  const calculateTotalDeductions = () => {\n    if (!salarySlip) return \"0\";\n    const loan = parseFloat(salarySlip.payroll.loanDeduction || \"0\");\n    const late = parseFloat(salarySlip.payroll.lateDeduction || \"0\");\n    const other = parseFloat(salarySlip.payroll.otherDeductions || \"0\");\n    return (loan + late + other).toFixed(2);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"page-title\">Salary Slip</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"page-description\">\n            Generate and download individual employee salary slips\n          </p>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <Card data-testid=\"card-filters\">\n        <CardHeader>\n          <CardTitle data-testid=\"card-title-filters\">Select Employee & Period</CardTitle>\n          <CardDescription data-testid=\"card-description-filters\">\n            Choose employee and salary period to generate slip\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            {/* Employee Selector */}\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\" data-testid=\"label-employee\">\n                <User className=\"inline w-4 h-4 mr-1\" />\n                Employee\n              </label>\n              <Select\n                value={selectedEmployee}\n                onValueChange={setSelectedEmployee}\n                disabled={isLoadingEmployees}\n              >\n                <SelectTrigger data-testid=\"select-employee\">\n                  <SelectValue placeholder=\"Select employee\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {employees.map((emp) => (\n                    <SelectItem key={emp.id} value={emp.id} data-testid={`option-employee-${emp.id}`}>\n                      {emp.user?.fullName} ({emp.employeeId})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Month Selector */}\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\" data-testid=\"label-month\">\n                <Calendar className=\"inline w-4 h-4 mr-1\" />\n                Month\n              </label>\n              <Select\n                value={selectedMonth.toString()}\n                onValueChange={(val) => setSelectedMonth(parseInt(val))}\n              >\n                <SelectTrigger data-testid=\"select-month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {monthNames.map((month, index) => (\n                    <SelectItem key={index + 1} value={(index + 1).toString()} data-testid={`option-month-${index + 1}`}>\n                      {month}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Year Selector */}\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\" data-testid=\"label-year\">\n                Year\n              </label>\n              <Select\n                value={selectedYear.toString()}\n                onValueChange={(val) => setSelectedYear(parseInt(val))}\n              >\n                <SelectTrigger data-testid=\"select-year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {Array.from({ length: 5 }, (_, i) => currentDate.getFullYear() - i).map((year) => (\n                    <SelectItem key={year} value={year.toString()} data-testid={`option-year-${year}`}>\n                      {year}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Salary Slip Display */}\n      {isLoadingSlip && selectedEmployee && (\n        <Card data-testid=\"card-loading\">\n          <CardContent className=\"p-6\">\n            <p className=\"text-center text-muted-foreground\" data-testid=\"text-loading\">Loading salary slip...</p>\n          </CardContent>\n        </Card>\n      )}\n\n      {!isLoadingSlip && selectedEmployee && !salarySlip && (\n        <Card data-testid=\"card-no-data\">\n          <CardContent className=\"p-6\">\n            <p className=\"text-center text-muted-foreground\" data-testid=\"text-no-data\">\n              No salary record found for this employee in {monthNames[selectedMonth - 1]} {selectedYear}\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      {salarySlip && (\n        <>\n          {/* Export Buttons */}\n          <div className=\"flex gap-2 flex-wrap\" data-testid=\"container-export-buttons\">\n            <Button\n              onClick={() => handleExport('pdf')}\n              variant=\"outline\"\n              data-testid=\"button-export-pdf\"\n            >\n              <FileText className=\"w-4 h-4 mr-2\" />\n              Download PDF\n            </Button>\n            <Button\n              onClick={() => handleExport('excel')}\n              variant=\"outline\"\n              data-testid=\"button-export-excel\"\n            >\n              <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n              Download Excel\n            </Button>\n            <Button\n              onClick={() => handleExport('word')}\n              variant=\"outline\"\n              data-testid=\"button-export-word\"\n            >\n              <FileType className=\"w-4 h-4 mr-2\" />\n              Download Word\n            </Button>\n          </div>\n\n          {/* Salary Slip Content */}\n          <Card data-testid=\"card-salary-slip\">\n            <CardHeader className=\"bg-primary text-primary-foreground\">\n              <div className=\"text-center\">\n                <CardTitle className=\"text-2xl mb-2\" data-testid=\"text-company-name\">MaxTech BD</CardTitle>\n                <CardDescription className=\"text-primary-foreground/90\" data-testid=\"text-company-address\">\n                  522, SK Mujib Road (4th Floor), Agrabad, Double Mooring, Chattogram, Bangladesh\n                </CardDescription>\n                <p className=\"text-sm text-primary-foreground/90 mt-1\" data-testid=\"text-company-contact\">\n                  Phone: +8801843180008 | Email: info@maxtechbd.com\n                </p>\n                <h2 className=\"text-xl font-bold mt-4\" data-testid=\"text-slip-title\">SALARY SLIP</h2>\n                <p className=\"text-sm\" data-testid=\"text-slip-period\">\n                  {monthNames[salarySlip.payroll.month - 1]} {salarySlip.payroll.year}\n                </p>\n              </div>\n            </CardHeader>\n            <CardContent className=\"p-6 space-y-6\">\n              {/* Employee Information */}\n              <div className=\"border-b pb-4\" data-testid=\"section-employee-info\">\n                <h3 className=\"font-semibold mb-3\" data-testid=\"text-section-title-employee\">Employee Information</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-employee-name\">Employee Name</p>\n                    <p className=\"font-medium\" data-testid=\"text-employee-name\">{salarySlip.employee.user?.fullName}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-employee-id\">Employee ID</p>\n                    <p className=\"font-medium\" data-testid=\"text-employee-id\">{salarySlip.employee.employeeId}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-department\">Department</p>\n                    <p className=\"font-medium\" data-testid=\"text-department\">\n                      {salarySlip.employee.department?.name || \"N/A\"}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-designation\">Designation</p>\n                    <p className=\"font-medium\" data-testid=\"text-designation\">\n                      {salarySlip.employee.designation?.title || \"N/A\"}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-working-days\">Working Days</p>\n                    <p className=\"font-medium\" data-testid=\"text-working-days\">{salarySlip.payroll.workingDays} days</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-payment-status\">Payment Status</p>\n                    <p className=\"font-medium capitalize\" data-testid=\"text-payment-status\">{salarySlip.payroll.status}</p>\n                  </div>\n                </div>\n              </div>\n\n              {/* Earnings & Deductions Side by Side */}\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                {/* Earnings */}\n                <div className=\"border rounded-md p-4\" data-testid=\"section-earnings\">\n                  <h3 className=\"font-semibold mb-3 text-green-600 dark:text-green-400\" data-testid=\"text-section-title-earnings\">\n                    Earnings\n                  </h3>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm\" data-testid=\"label-basic-salary\">Basic Salary</span>\n                      <span className=\"font-medium\" data-testid=\"text-basic-salary\">\n                        {formatCurrency(salarySlip.payroll.basicSalary || \"0\")}\n                      </span>\n                    </div>\n                    {salarySlip.salaryStructure && (\n                      <>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-sm\" data-testid=\"label-house-allowance\">House Allowance</span>\n                          <span className=\"font-medium\" data-testid=\"text-house-allowance\">\n                            {formatCurrency(salarySlip.salaryStructure.houseAllowance || \"0\")}\n                          </span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-sm\" data-testid=\"label-food-allowance\">Food Allowance</span>\n                          <span className=\"font-medium\" data-testid=\"text-food-allowance\">\n                            {formatCurrency(salarySlip.salaryStructure.foodAllowance || \"0\")}\n                          </span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-sm\" data-testid=\"label-travel-allowance\">Travel Allowance</span>\n                          <span className=\"font-medium\" data-testid=\"text-travel-allowance\">\n                            {formatCurrency(salarySlip.salaryStructure.travelAllowance || \"0\")}\n                          </span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-sm\" data-testid=\"label-medical-allowance\">Medical Allowance</span>\n                          <span className=\"font-medium\" data-testid=\"text-medical-allowance\">\n                            {formatCurrency(salarySlip.salaryStructure.medicalAllowance || \"0\")}\n                          </span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-sm\" data-testid=\"label-other-allowances\">Other Allowances</span>\n                          <span className=\"font-medium\" data-testid=\"text-other-allowances\">\n                            {formatCurrency(salarySlip.salaryStructure.otherAllowances || \"0\")}\n                          </span>\n                        </div>\n                      </>\n                    )}\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm\" data-testid=\"label-overtime\">Overtime Pay</span>\n                      <span className=\"font-medium\" data-testid=\"text-overtime\">\n                        {formatCurrency(salarySlip.payroll.overtimeAmount || \"0\")}\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between pt-2 border-t\">\n                      <span className=\"font-semibold\" data-testid=\"label-total-earnings\">Total Earnings</span>\n                      <span className=\"font-bold text-green-600 dark:text-green-400\" data-testid=\"text-total-earnings\">\n                        {formatCurrency(calculateTotalEarnings())}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Deductions */}\n                <div className=\"border rounded-md p-4\" data-testid=\"section-deductions\">\n                  <h3 className=\"font-semibold mb-3 text-red-600 dark:text-red-400\" data-testid=\"text-section-title-deductions\">\n                    Deductions\n                  </h3>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm\" data-testid=\"label-loan-deduction\">Loan Deduction</span>\n                      <span className=\"font-medium\" data-testid=\"text-loan-deduction\">\n                        {formatCurrency(salarySlip.payroll.loanDeduction || \"0\")}\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm\" data-testid=\"label-late-deduction\">Late Deduction ({salarySlip.payroll.totalLateDays} days)</span>\n                      <span className=\"font-medium\" data-testid=\"text-late-deduction\">\n                        {formatCurrency(salarySlip.payroll.lateDeduction || \"0\")}\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm\" data-testid=\"label-other-deductions\">Other Deductions</span>\n                      <span className=\"font-medium\" data-testid=\"text-other-deductions\">\n                        {formatCurrency(salarySlip.payroll.otherDeductions || \"0\")}\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between pt-2 border-t\">\n                      <span className=\"font-semibold\" data-testid=\"label-total-deductions\">Total Deductions</span>\n                      <span className=\"font-bold text-red-600 dark:text-red-400\" data-testid=\"text-total-deductions\">\n                        {formatCurrency(calculateTotalDeductions())}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Attendance Summary */}\n              <div className=\"border rounded-md p-4 bg-muted/50\" data-testid=\"section-attendance\">\n                <h3 className=\"font-semibold mb-3\" data-testid=\"text-section-title-attendance\">Attendance Summary</h3>\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-present-days\">Present Days</p>\n                    <p className=\"text-lg font-bold text-green-600\" data-testid=\"text-present-days\">\n                      {salarySlip.payroll.totalPresentDays}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-absent-days\">Absent Days</p>\n                    <p className=\"text-lg font-bold text-red-600\" data-testid=\"text-absent-days\">\n                      {salarySlip.payroll.totalAbsentDays}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-late-days\">Late Days</p>\n                    <p className=\"text-lg font-bold text-orange-600\" data-testid=\"text-late-days\">\n                      {salarySlip.payroll.totalLateDays}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"label-overtime-hours\">Overtime Hours</p>\n                    <p className=\"text-lg font-bold text-blue-600\" data-testid=\"text-overtime-hours\">\n                      {salarySlip.payroll.totalOvertimeHours}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {/* Net Salary */}\n              <div className=\"border-2 border-primary rounded-md p-4 bg-primary/5\" data-testid=\"section-net-salary\">\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-lg font-semibold\" data-testid=\"label-net-salary\">Net Salary</span>\n                  <span className=\"text-2xl font-bold text-primary\" data-testid=\"text-net-salary\">\n                    {formatCurrency(salarySlip.payroll.netSalary || \"0\")}\n                  </span>\n                </div>\n              </div>\n\n              {/* Signature Section */}\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8 pt-8 border-t\" data-testid=\"section-signatures\">\n                <div className=\"text-center\">\n                  <div className=\"border-t border-foreground/20 pt-2 mt-16 inline-block min-w-48\">\n                    <p className=\"text-sm font-medium\" data-testid=\"text-employee-signature\">Employee Signature</p>\n                  </div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"border-t border-foreground/20 pt-2 mt-16 inline-block min-w-48\">\n                    <p className=\"text-sm font-medium\" data-testid=\"text-authorized-signature\">Authorized Signature</p>\n                  </div>\n                </div>\n              </div>\n\n              {/* Footer Note */}\n              <div className=\"text-center text-xs text-muted-foreground pt-4 border-t\" data-testid=\"text-footer-note\">\n                <p>This is a computer-generated salary slip and does not require a physical signature.</p>\n                <p className=\"mt-1\">For any queries, please contact HR Department at info@maxtechbd.com</p>\n              </div>\n            </CardContent>\n          </Card>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":23869,"size_tokens":null},"client/src/pages/payment-receipt.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { FileText, Download, FileSpreadsheet } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { formatCurrency } from \"@shared/currency\";\nimport { format } from \"date-fns\";\n\ninterface PaymentReceiptData {\n  payment: {\n    id: string;\n    amount: string;\n    paymentDate: string;\n    paymentMethod: string;\n    notes: string | null;\n  };\n  invoice: {\n    invoiceNumber: string;\n    amount: string;\n    dueDate: string;\n    status: string;\n  };\n  client: {\n    companyName: string;\n    email: string;\n    phone: string | null;\n  };\n}\n\nexport default function PaymentReceipt() {\n  const [selectedPaymentId, setSelectedPaymentId] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  // Fetch all payments\n  const { data: payments, isLoading: paymentsLoading } = useQuery<any[]>({\n    queryKey: [\"/api/payments\"],\n  });\n\n  // Fetch selected payment receipt details\n  const { data: receiptData, isLoading: receiptLoading } = useQuery<PaymentReceiptData>({\n    queryKey: [\"/api/payment-receipt\", selectedPaymentId],\n    queryFn: async () => {\n      if (!selectedPaymentId) {\n        throw new Error(\"Payment ID is required\");\n      }\n      const response = await fetch(`/api/payment-receipt?paymentId=${encodeURIComponent(selectedPaymentId)}`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem(\"token\")}`,\n        },\n      });\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch payment receipt\");\n      }\n      return response.json();\n    },\n    enabled: !!selectedPaymentId,\n  });\n\n  const handleExport = async (format: \"pdf\" | \"excel\" | \"word\") => {\n    if (!selectedPaymentId) {\n      toast({\n        title: \"No payment selected\",\n        description: \"Please select a payment to export the receipt\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      const response = await fetch(`/api/payment-receipt/export-${format}?paymentId=${selectedPaymentId}`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem(\"token\")}`,\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Export failed\");\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `Payment-Receipt-${receiptData?.payment?.id || \"receipt\"}.${format === \"excel\" ? \"xlsx\" : format === \"word\" ? \"docx\" : \"pdf\"}`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Export successful\",\n        description: `Payment receipt exported as ${format.toUpperCase()}`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Export failed\",\n        description: \"Failed to export payment receipt\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Payment Receipt</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"text-page-description\">\n            Generate payment receipts for client transactions\n          </p>\n        </div>\n      </div>\n\n      <Card data-testid=\"card-payment-selector\">\n        <CardHeader>\n          <CardTitle data-testid=\"text-selector-title\">Select Payment</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <Select\n            value={selectedPaymentId}\n            onValueChange={setSelectedPaymentId}\n            disabled={paymentsLoading}\n          >\n            <SelectTrigger data-testid=\"select-payment-trigger\">\n              <SelectValue placeholder=\"Select a payment\" />\n            </SelectTrigger>\n            <SelectContent>\n              {payments?.map((payment) => (\n                <SelectItem\n                  key={payment.id}\n                  value={payment.id}\n                  data-testid={`select-payment-option-${payment.id}`}\n                >\n                  Payment #{payment.id.substring(0, 8)} - {formatCurrency(payment.amount || \"0\")} - {format(new Date(payment.paymentDate), \"MMM dd, yyyy\")}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n\n          {selectedPaymentId && (\n            <div className=\"flex gap-2\">\n              <Button\n                onClick={() => handleExport(\"pdf\")}\n                disabled={receiptLoading}\n                data-testid=\"button-export-pdf\"\n              >\n                <FileText className=\"w-4 h-4 mr-2\" />\n                Export PDF\n              </Button>\n              <Button\n                onClick={() => handleExport(\"excel\")}\n                disabled={receiptLoading}\n                variant=\"outline\"\n                data-testid=\"button-export-excel\"\n              >\n                <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n                Export Excel\n              </Button>\n              <Button\n                onClick={() => handleExport(\"word\")}\n                disabled={receiptLoading}\n                variant=\"outline\"\n                data-testid=\"button-export-word\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                Export Word\n              </Button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {receiptLoading && (\n        <Card data-testid=\"card-loading\">\n          <CardContent className=\"p-6\">\n            <p className=\"text-center text-muted-foreground\" data-testid=\"text-loading\">Loading payment receipt...</p>\n          </CardContent>\n        </Card>\n      )}\n\n      {receiptData && !receiptLoading && (\n        <Card data-testid=\"card-receipt-display\">\n          <CardHeader>\n            <CardTitle data-testid=\"text-receipt-title\">Payment Receipt</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            {/* Company Header */}\n            <div className=\"text-center border-b pb-4\" data-testid=\"section-company-header\">\n              <h2 className=\"text-2xl font-bold text-primary\" data-testid=\"text-company-name\">MaxTech BD</h2>\n              <p className=\"text-sm text-muted-foreground\" data-testid=\"text-company-address\">522 SK Mujib Road, Dhaka, Bangladesh</p>\n              <p className=\"text-sm text-muted-foreground\" data-testid=\"text-company-contact\">\n                Phone: +8801843180008 | Email: info@maxtechbd.com\n              </p>\n            </div>\n\n            {/* Receipt Details */}\n            <div className=\"grid grid-cols-2 gap-6\" data-testid=\"section-receipt-details\">\n              <div className=\"space-y-2\">\n                <h3 className=\"font-semibold text-lg\" data-testid=\"text-payment-info-heading\">Payment Information</h3>\n                <div className=\"space-y-1\">\n                  <p data-testid=\"text-receipt-number\">\n                    <span className=\"font-medium\">Receipt #:</span> {receiptData.payment.id.substring(0, 8).toUpperCase()}\n                  </p>\n                  <p data-testid=\"text-payment-date\">\n                    <span className=\"font-medium\">Payment Date:</span> {format(new Date(receiptData.payment.paymentDate), \"MMMM dd, yyyy\")}\n                  </p>\n                  <p data-testid=\"text-payment-method\">\n                    <span className=\"font-medium\">Payment Method:</span> {receiptData.payment.paymentMethod}\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <h3 className=\"font-semibold text-lg\" data-testid=\"text-client-info-heading\">Client Information</h3>\n                <div className=\"space-y-1\">\n                  <p data-testid=\"text-client-name\">\n                    <span className=\"font-medium\">Name:</span> {receiptData.client.companyName}\n                  </p>\n                  <p data-testid=\"text-client-email\">\n                    <span className=\"font-medium\">Email:</span> {receiptData.client.email}\n                  </p>\n                  <p data-testid=\"text-client-phone\">\n                    <span className=\"font-medium\">Phone:</span> {receiptData.client.phone || \"N/A\"}\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            {/* Invoice Reference */}\n            <div className=\"border-t pt-4\" data-testid=\"section-invoice-reference\">\n              <h3 className=\"font-semibold text-lg mb-2\" data-testid=\"text-invoice-heading\">Invoice Reference</h3>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <p data-testid=\"text-invoice-number\">\n                  <span className=\"font-medium\">Invoice #:</span> {receiptData.invoice.invoiceNumber}\n                </p>\n                <p data-testid=\"text-invoice-amount\">\n                  <span className=\"font-medium\">Invoice Amount:</span> {formatCurrency(receiptData.invoice.amount || \"0\")}\n                </p>\n                <p data-testid=\"text-invoice-due-date\">\n                  <span className=\"font-medium\">Due Date:</span> {format(new Date(receiptData.invoice.dueDate), \"MMM dd, yyyy\")}\n                </p>\n                <p data-testid=\"text-invoice-status\">\n                  <span className=\"font-medium\">Status:</span>{\" \"}\n                  <span className=\"capitalize\">{receiptData.invoice.status}</span>\n                </p>\n              </div>\n            </div>\n\n            {/* Payment Amount */}\n            <div className=\"border-t pt-4\" data-testid=\"section-payment-amount\">\n              <div className=\"flex justify-between items-center bg-muted p-4 rounded-md\">\n                <span className=\"text-lg font-semibold\" data-testid=\"text-amount-label\">Amount Paid:</span>\n                <span className=\"text-2xl font-bold text-primary\" data-testid=\"text-amount-paid\">\n                  {formatCurrency(receiptData.payment.amount || \"0\")}\n                </span>\n              </div>\n            </div>\n\n            {/* Notes */}\n            {receiptData.payment.notes && (\n              <div className=\"border-t pt-4\" data-testid=\"section-notes\">\n                <h3 className=\"font-semibold text-lg mb-2\" data-testid=\"text-notes-heading\">Notes</h3>\n                <p className=\"text-muted-foreground\" data-testid=\"text-notes-content\">{receiptData.payment.notes}</p>\n              </div>\n            )}\n\n            {/* Signature */}\n            <div className=\"border-t pt-6 mt-6\" data-testid=\"section-signature\">\n              <div className=\"flex justify-between\">\n                <div className=\"text-center\" data-testid=\"section-receiver-signature\">\n                  <div className=\"border-t border-foreground w-48 mb-2\"></div>\n                  <p className=\"text-sm font-medium\" data-testid=\"text-receiver-label\">Received By</p>\n                </div>\n                <div className=\"text-center\" data-testid=\"section-authorized-signature\">\n                  <div className=\"border-t border-foreground w-48 mb-2\"></div>\n                  <p className=\"text-sm font-medium\" data-testid=\"text-authorized-label\">Authorized Signature</p>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":11607,"size_tokens":null},"client/src/pages/leave-summary-report.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Download, FileText, FileSpreadsheet } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ntype LeaveSummaryData = {\n  employeeId: string;\n  employeeName: string;\n  department: string;\n  leaveType: string;\n  totalDays: string;\n  usedDays: string;\n  remainingDays: string;\n  pendingRequests: number;\n  approvedRequests: number;\n  rejectedRequests: number;\n};\n\ntype ReportData = {\n  leaveSummaryData: LeaveSummaryData[];\n  summary: {\n    totalEmployees: number;\n    totalLeaveTypes: number;\n    totalPendingRequests: number;\n    totalApprovedRequests: number;\n    totalRejectedRequests: number;\n  };\n  year: number;\n};\n\nexport default function LeaveSummaryReport() {\n  const { toast } = useToast();\n  const currentYear = new Date().getFullYear();\n  const [selectedYear, setSelectedYear] = useState<string>(currentYear.toString());\n  const [selectedEmployee, setSelectedEmployee] = useState<string>(\"all\");\n  const [selectedLeaveType, setSelectedLeaveType] = useState<string>(\"all\");\n  const [reportGenerated, setReportGenerated] = useState(false);\n\n  // Generate year options (current year and 5 years back)\n  const yearOptions = Array.from({ length: 6 }, (_, i) => currentYear - i);\n\n  // Fetch employees\n  const { data: employees } = useQuery<any[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  // Fetch leave types\n  const { data: leaveTypes } = useQuery<any[]>({\n    queryKey: [\"/api/hr/leave-types\"],\n  });\n\n  // Fetch report data\n  const { data: reportData, isLoading: reportLoading, refetch } = useQuery<ReportData>({\n    queryKey: [\"/api/leave-summary-report\", selectedYear, selectedEmployee, selectedLeaveType],\n    queryFn: async () => {\n      const params = new URLSearchParams({\n        year: selectedYear,\n      });\n      if (selectedEmployee && selectedEmployee !== \"all\") params.append(\"employeeId\", selectedEmployee);\n      if (selectedLeaveType && selectedLeaveType !== \"all\") params.append(\"leaveTypeId\", selectedLeaveType);\n\n      const response = await fetch(`/api/leave-summary-report?${params}`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem(\"token\")}`,\n        },\n      });\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch leave summary report\");\n      }\n      return response.json();\n    },\n    enabled: reportGenerated,\n  });\n\n  const handleGenerateReport = () => {\n    if (!selectedYear) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a year\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setReportGenerated(true);\n    refetch();\n  };\n\n  const handleExport = async (exportFormat: \"pdf\" | \"excel\" | \"word\") => {\n    if (!reportData) {\n      toast({\n        title: \"Error\",\n        description: \"Please generate the report first\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      const endpoint = exportFormat === \"pdf\" \n        ? \"/api/leave-summary-report/export-pdf\"\n        : exportFormat === \"excel\"\n        ? \"/api/leave-summary-report/export-excel\"\n        : \"/api/leave-summary-report/export-word\";\n\n      const params = new URLSearchParams({\n        data: encodeURIComponent(JSON.stringify(reportData)),\n      });\n\n      const response = await fetch(`${endpoint}?${params}`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem(\"token\")}`,\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Export failed\");\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `Leave-Summary-Report-${selectedYear}-${new Date().toISOString().split(\"T\")[0]}.${\n        exportFormat === \"pdf\" ? \"pdf\" : exportFormat === \"excel\" ? \"xlsx\" : \"docx\"\n      }`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Success\",\n        description: `Report exported as ${exportFormat.toUpperCase()} successfully`,\n      });\n    } catch (error: any) {\n      console.error(\"Export error:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to export report\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"flex flex-col gap-6 p-6\" data-testid=\"container-leave-summary-report\">\n      <div>\n        <h1 className=\"text-2xl font-bold\" data-testid=\"heading-page-title\">Leave Summary Report</h1>\n        <p className=\"text-muted-foreground\" data-testid=\"text-page-description\">\n          Generate comprehensive leave summary reports with employee-wise balance and request statistics\n        </p>\n      </div>\n\n      <Card data-testid=\"card-filters\">\n        <CardHeader>\n          <CardTitle data-testid=\"heading-filters-title\">Report Filters</CardTitle>\n          <CardDescription data-testid=\"text-filters-description\">\n            Select filters to generate the leave summary report\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"flex flex-col gap-2\">\n              <label className=\"text-sm font-medium\" data-testid=\"label-year\">\n                Year\n              </label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger data-testid=\"select-year-trigger\">\n                  <SelectValue placeholder=\"Select year\" />\n                </SelectTrigger>\n                <SelectContent data-testid=\"select-year-content\">\n                  {yearOptions.map((year) => (\n                    <SelectItem \n                      key={year} \n                      value={year.toString()} \n                      data-testid={`select-year-option-${year}`}\n                    >\n                      {year}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex flex-col gap-2\">\n              <label className=\"text-sm font-medium\" data-testid=\"label-employee\">\n                Employee\n              </label>\n              <Select value={selectedEmployee} onValueChange={setSelectedEmployee}>\n                <SelectTrigger data-testid=\"select-employee-trigger\">\n                  <SelectValue placeholder=\"Select employee\" />\n                </SelectTrigger>\n                <SelectContent data-testid=\"select-employee-content\">\n                  <SelectItem value=\"all\" data-testid=\"select-employee-option-all\">\n                    All Employees\n                  </SelectItem>\n                  {employees?.map((emp) => {\n                    // Get the full name from the first user associated with this employee\n                    const employeeName = emp.users && emp.users.length > 0 \n                      ? emp.users[0].fullName \n                      : \"Unknown Employee\";\n                    return (\n                      <SelectItem \n                        key={emp.id} \n                        value={emp.id} \n                        data-testid={`select-employee-option-${emp.id}`}\n                      >\n                        {employeeName}\n                      </SelectItem>\n                    );\n                  })}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex flex-col gap-2\">\n              <label className=\"text-sm font-medium\" data-testid=\"label-leave-type\">\n                Leave Type\n              </label>\n              <Select value={selectedLeaveType} onValueChange={setSelectedLeaveType}>\n                <SelectTrigger data-testid=\"select-leave-type-trigger\">\n                  <SelectValue placeholder=\"Select leave type\" />\n                </SelectTrigger>\n                <SelectContent data-testid=\"select-leave-type-content\">\n                  <SelectItem value=\"all\" data-testid=\"select-leave-type-option-all\">\n                    All Leave Types\n                  </SelectItem>\n                  {leaveTypes?.map((type) => (\n                    <SelectItem \n                      key={type.id} \n                      value={type.id} \n                      data-testid={`select-leave-type-option-${type.id}`}\n                    >\n                      {type.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <Button \n            onClick={handleGenerateReport} \n            className=\"w-full md:w-auto\"\n            data-testid=\"button-generate-report\"\n          >\n            Generate Report\n          </Button>\n        </CardContent>\n      </Card>\n\n      {reportLoading && (\n        <Card data-testid=\"card-loading\">\n          <CardContent className=\"p-8\">\n            <div className=\"flex items-center justify-center\">\n              <div className=\"text-muted-foreground\" data-testid=\"text-loading\">\n                Loading report data...\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {reportData && !reportLoading && (\n        <>\n          {/* Summary Card */}\n          <Card data-testid=\"card-summary\">\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n              <div>\n                <CardTitle data-testid=\"heading-summary-title\">Summary - {reportData.year}</CardTitle>\n                <CardDescription data-testid=\"text-summary-description\">\n                  Overview of leave statistics for the selected period\n                </CardDescription>\n              </div>\n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => handleExport(\"pdf\")}\n                  data-testid=\"button-export-pdf\"\n                >\n                  <FileText className=\"mr-2 h-4 w-4\" />\n                  PDF\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => handleExport(\"excel\")}\n                  data-testid=\"button-export-excel\"\n                >\n                  <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n                  Excel\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => handleExport(\"word\")}\n                  data-testid=\"button-export-word\"\n                >\n                  <Download className=\"mr-2 h-4 w-4\" />\n                  Word\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\n                <div className=\"flex flex-col gap-1\" data-testid=\"container-summary-employees\">\n                  <div className=\"text-2xl font-bold\" data-testid=\"text-total-employees\">\n                    {reportData.summary.totalEmployees}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\" data-testid=\"label-total-employees\">\n                    Total Employees\n                  </div>\n                </div>\n                <div className=\"flex flex-col gap-1\" data-testid=\"container-summary-leave-types\">\n                  <div className=\"text-2xl font-bold\" data-testid=\"text-total-leave-types\">\n                    {reportData.summary.totalLeaveTypes}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\" data-testid=\"label-total-leave-types\">\n                    Leave Types\n                  </div>\n                </div>\n                <div className=\"flex flex-col gap-1\" data-testid=\"container-summary-pending\">\n                  <div className=\"text-2xl font-bold text-yellow-600\" data-testid=\"text-total-pending\">\n                    {reportData.summary.totalPendingRequests}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\" data-testid=\"label-total-pending\">\n                    Pending\n                  </div>\n                </div>\n                <div className=\"flex flex-col gap-1\" data-testid=\"container-summary-approved\">\n                  <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-total-approved\">\n                    {reportData.summary.totalApprovedRequests}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\" data-testid=\"label-total-approved\">\n                    Approved\n                  </div>\n                </div>\n                <div className=\"flex flex-col gap-1\" data-testid=\"container-summary-rejected\">\n                  <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-total-rejected\">\n                    {reportData.summary.totalRejectedRequests}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\" data-testid=\"label-total-rejected\">\n                    Rejected\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Leave Details Table */}\n          <Card data-testid=\"card-details\">\n            <CardHeader>\n              <CardTitle data-testid=\"heading-details-title\">Leave Details</CardTitle>\n              <CardDescription data-testid=\"text-details-description\">\n                Detailed breakdown of leave balance and requests\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {reportData.leaveSummaryData.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-data\">\n                  No leave data found for the selected filters\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table data-testid=\"table-leave-details\">\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead data-testid=\"header-employee\">Employee</TableHead>\n                        <TableHead data-testid=\"header-department\">Department</TableHead>\n                        <TableHead data-testid=\"header-leave-type\">Leave Type</TableHead>\n                        <TableHead className=\"text-right\" data-testid=\"header-total\">Total</TableHead>\n                        <TableHead className=\"text-right\" data-testid=\"header-used\">Used</TableHead>\n                        <TableHead className=\"text-right\" data-testid=\"header-remaining\">Remaining</TableHead>\n                        <TableHead className=\"text-center\" data-testid=\"header-pending\">Pending</TableHead>\n                        <TableHead className=\"text-center\" data-testid=\"header-approved\">Approved</TableHead>\n                        <TableHead className=\"text-center\" data-testid=\"header-rejected\">Rejected</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {reportData.leaveSummaryData.map((record, index) => (\n                        <TableRow key={`${record.employeeId}-${record.leaveType}-${index}`} data-testid={`row-leave-${index}`}>\n                          <TableCell className=\"font-medium\" data-testid={`cell-employee-${index}`}>\n                            {record.employeeName}\n                          </TableCell>\n                          <TableCell data-testid={`cell-department-${index}`}>\n                            {record.department}\n                          </TableCell>\n                          <TableCell data-testid={`cell-leave-type-${index}`}>\n                            {record.leaveType}\n                          </TableCell>\n                          <TableCell className=\"text-right\" data-testid={`cell-total-${index}`}>\n                            {record.totalDays}\n                          </TableCell>\n                          <TableCell className=\"text-right\" data-testid={`cell-used-${index}`}>\n                            {record.usedDays}\n                          </TableCell>\n                          <TableCell className=\"text-right\" data-testid={`cell-remaining-${index}`}>\n                            {record.remainingDays}\n                          </TableCell>\n                          <TableCell className=\"text-center\" data-testid={`cell-pending-${index}`}>\n                            <Badge variant=\"secondary\" data-testid={`badge-pending-${index}`}>\n                              {record.pendingRequests}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-center\" data-testid={`cell-approved-${index}`}>\n                            <Badge \n                              variant=\"secondary\" \n                              className=\"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-100\"\n                              data-testid={`badge-approved-${index}`}\n                            >\n                              {record.approvedRequests}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-center\" data-testid={`cell-rejected-${index}`}>\n                            <Badge \n                              variant=\"secondary\" \n                              className=\"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-100\"\n                              data-testid={`badge-rejected-${index}`}\n                            >\n                              {record.rejectedRequests}\n                            </Badge>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </>\n      )}\n\n      {!reportGenerated && !reportLoading && (\n        <Card data-testid=\"card-empty-state\">\n          <CardContent className=\"p-8\">\n            <div className=\"flex flex-col items-center justify-center gap-2\">\n              <div className=\"text-muted-foreground\" data-testid=\"text-empty-state\">\n                Select filters and click \"Generate Report\" to view leave summary data\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":18948,"size_tokens":null},"client/src/pages/hr-attendance-report.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { FileText, FileSpreadsheet, FileType, Calendar } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format, subDays } from \"date-fns\";\n\ninterface AttendanceRecord {\n  date: string;\n  employeeId: string;\n  employeeName: string;\n  employeeCode: string;\n  department: string;\n  status: \"present\" | \"late\" | \"half-day\" | \"absent\";\n  checkInTime: string | null;\n  checkOutTime: string | null;\n  notes?: string | null;\n}\n\ninterface AttendanceReportData {\n  attendanceData: AttendanceRecord[];\n  summary: {\n    totalDays: number;\n    workingDays?: number;\n    presentCount: number;\n    onTimeCount?: number;\n    lateCount: number;\n    halfDayCount: number;\n    absentCount: number;\n    overtimeCount: number;\n    overtimeHours?: string;\n    totalHoursWorked?: string;\n    presentPercentage: string;\n    latePercentage: string;\n    halfDayPercentage: string;\n    absentPercentage: string;\n  };\n  dateRange: {\n    start: string;\n    end: string;\n  };\n}\n\nexport default function HRAttendanceReport() {\n  const { toast } = useToast();\n  const [startDate, setStartDate] = useState(format(subDays(new Date(), 30), \"yyyy-MM-dd\"));\n  const [endDate, setEndDate] = useState(format(new Date(), \"yyyy-MM-dd\"));\n  const [selectedEmployee, setSelectedEmployee] = useState<string>(\"\");\n  const [selectedDepartment, setSelectedDepartment] = useState<string>(\"\");\n  const [reportGenerated, setReportGenerated] = useState(false);\n\n  // Fetch employees for filter\n  const { data: employees } = useQuery<any[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  // Fetch departments for filter\n  const { data: departments } = useQuery<any[]>({\n    queryKey: [\"/api/departments\"],\n  });\n\n  // Fetch report data\n  const { data: reportData, isLoading: reportLoading, refetch } = useQuery<AttendanceReportData>({\n    queryKey: [\"/api/hr-attendance-report\", startDate, endDate, selectedEmployee, selectedDepartment],\n    queryFn: async () => {\n      if (!startDate || !endDate) {\n        throw new Error(\"Start date and end date are required\");\n      }\n      const params = new URLSearchParams({\n        startDate: startDate,\n        endDate: endDate,\n      });\n      if (selectedEmployee && selectedEmployee !== \"all\") params.append(\"employeeId\", selectedEmployee);\n      if (selectedDepartment && selectedDepartment !== \"all\") params.append(\"departmentId\", selectedDepartment);\n\n      const response = await fetch(`/api/hr-attendance-report?${params}`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem(\"token\")}`,\n        },\n      });\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch attendance report\");\n      }\n      return response.json();\n    },\n    enabled: reportGenerated,\n  });\n\n  const handleGenerateReport = () => {\n    if (!startDate || !endDate) {\n      toast({\n        title: \"Error\",\n        description: \"Please select both start and end dates\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setReportGenerated(true);\n    refetch();\n  };\n\n  const handleExport = async (exportFormat: \"pdf\" | \"excel\" | \"word\") => {\n    if (!reportData) {\n      toast({\n        title: \"Error\",\n        description: \"Please generate the report first\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      const response = await fetch(\n        `/api/hr-attendance-report/export-${exportFormat}?data=${encodeURIComponent(JSON.stringify(reportData))}`,\n        {\n          headers: {\n            Authorization: `Bearer ${localStorage.getItem(\"token\")}`,\n          },\n        }\n      );\n\n      if (!response.ok) throw new Error(`Failed to export ${exportFormat.toUpperCase()}`);\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      const fileExt = exportFormat === \"excel\" ? \"xlsx\" : exportFormat === \"pdf\" ? \"pdf\" : \"docx\";\n      a.download = `Attendance-Report-${format(new Date(), \"yyyy-MM-dd\")}.${fileExt}`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Success\",\n        description: `Report exported as ${exportFormat.toUpperCase()} successfully`,\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to export report\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const getStatusBadgeVariant = (status: string) => {\n    const normalizedStatus = status.toLowerCase();\n    if (normalizedStatus === \"present\") return \"default\";\n    if (normalizedStatus === \"late\") return \"secondary\";\n    if (normalizedStatus === \"half-day\") return \"outline\";\n    return \"destructive\"; // absent\n  };\n\n  // Detect if this is an Employee Job Card (single employee selected)\n  const isJobCard = reportData && reportData.attendanceData.length > 0 && \n    reportData.attendanceData.every(r => r.employeeId === reportData.attendanceData[0].employeeId);\n  \n  const jobCardEmployee = isJobCard ? reportData.attendanceData[0] : null;\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-hr-attendance-report\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">HR Attendance Report</h1>\n        <p className=\"text-muted-foreground\" data-testid=\"text-page-description\">\n          View and export employee attendance records with detailed status tracking\n        </p>\n      </div>\n\n      {/* Filters Card */}\n      <Card data-testid=\"card-filters\">\n        <CardHeader>\n          <CardTitle data-testid=\"text-filters-title\">Report Filters</CardTitle>\n          <CardDescription data-testid=\"text-filters-description\">\n            Select date range and optional filters to generate attendance report\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"start-date\" data-testid=\"label-start-date\">Start Date</Label>\n              <Input\n                id=\"start-date\"\n                type=\"date\"\n                value={startDate}\n                onChange={(e) => setStartDate(e.target.value)}\n                data-testid=\"input-start-date\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"end-date\" data-testid=\"label-end-date\">End Date</Label>\n              <Input\n                id=\"end-date\"\n                type=\"date\"\n                value={endDate}\n                onChange={(e) => setEndDate(e.target.value)}\n                data-testid=\"input-end-date\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"employee\" data-testid=\"label-employee\">Employee (Optional)</Label>\n              <Select value={selectedEmployee} onValueChange={setSelectedEmployee}>\n                <SelectTrigger id=\"employee\" data-testid=\"select-employee\">\n                  <SelectValue placeholder=\"All Employees\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\" data-testid=\"select-employee-all\">All Employees</SelectItem>\n                  {employees?.map((emp) => {\n                    // Access user data from the users array returned by /api/employees\n                    // Handle both JSON string and parsed array formats\n                    let usersArray: any[] = [];\n                    if (typeof emp.users === 'string') {\n                      try {\n                        usersArray = JSON.parse(emp.users);\n                      } catch {\n                        usersArray = [];\n                      }\n                    } else if (Array.isArray(emp.users)) {\n                      usersArray = emp.users;\n                    }\n                    \n                    const user = usersArray.length > 0 ? usersArray[0] : null;\n                    const userName = user?.fullName || '';\n                    const employeeCode = emp.employeeId || emp.id;\n                    \n                    return (\n                      <SelectItem key={emp.id} value={emp.id} data-testid={`select-employee-${emp.id}`}>\n                        {employeeCode}{userName ? ` - ${userName}` : ''}\n                      </SelectItem>\n                    );\n                  })}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"department\" data-testid=\"label-department\">Department (Optional)</Label>\n              <Select value={selectedDepartment} onValueChange={setSelectedDepartment}>\n                <SelectTrigger id=\"department\" data-testid=\"select-department\">\n                  <SelectValue placeholder=\"All Departments\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\" data-testid=\"select-department-all\">All Departments</SelectItem>\n                  {departments?.map((dept) => (\n                    <SelectItem key={dept.id} value={dept.id} data-testid={`select-department-${dept.id}`}>\n                      {dept.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"flex gap-2\">\n            <Button onClick={handleGenerateReport} data-testid=\"button-generate-report\">\n              <Calendar className=\"mr-2 h-4 w-4\" />\n              Generate Report\n            </Button>\n            {selectedEmployee && (\n              <Button \n                variant=\"outline\" \n                onClick={() => setSelectedEmployee(\"\")}\n                data-testid=\"button-clear-employee\"\n              >\n                Clear Employee Filter\n              </Button>\n            )}\n            {selectedDepartment && (\n              <Button \n                variant=\"outline\" \n                onClick={() => setSelectedDepartment(\"\")}\n                data-testid=\"button-clear-department\"\n              >\n                Clear Department Filter\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Employee Job Card Indicator */}\n      {isJobCard && jobCardEmployee && (\n        <Card data-testid=\"card-job-card-indicator\" className=\"border-primary/50 bg-primary/5\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\" data-testid=\"text-job-card-title\">\n              <FileText className=\"h-5 w-5 text-primary\" />\n              Employee Job Card\n            </CardTitle>\n            <CardDescription data-testid=\"text-job-card-description\">\n              Viewing detailed job card for <strong>{jobCardEmployee.employeeName}</strong> ({jobCardEmployee.employeeCode}) - {jobCardEmployee.department}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-sm text-muted-foreground\">\n              This report shows comprehensive attendance analytics including daily check-in/check-out times, \n              working hours, overtime calculation, and on-time tracking. Export to PDF, Excel, or Word for professional documentation.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Summary Card */}\n      {reportData && (\n        <Card data-testid=\"card-summary\">\n          <CardHeader>\n            <CardTitle data-testid=\"text-summary-title\">\n              {isJobCard ? \"Job Card Summary\" : \"Attendance Summary\"}\n            </CardTitle>\n            <CardDescription data-testid=\"text-summary-description\">\n              {reportData.dateRange.start} to {reportData.dateRange.end}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n              <div className=\"space-y-1\" data-testid=\"summary-working-days\">\n                <p className=\"text-sm text-muted-foreground\">Working Days</p>\n                <p className=\"text-2xl font-bold\" data-testid=\"text-working-days\">\n                  {reportData.summary.workingDays || reportData.summary.totalDays}\n                </p>\n              </div>\n              <div className=\"space-y-1\" data-testid=\"summary-present\">\n                <p className=\"text-sm text-muted-foreground\">Present</p>\n                <p className=\"text-2xl font-bold text-green-600\" data-testid=\"text-present-count\">\n                  {reportData.summary.presentCount} ({reportData.summary.presentPercentage}%)\n                </p>\n              </div>\n              <div className=\"space-y-1\" data-testid=\"summary-on-time\">\n                <p className=\"text-sm text-muted-foreground\">On-Time</p>\n                <p className=\"text-2xl font-bold text-emerald-600\" data-testid=\"text-on-time-count\">\n                  {reportData.summary.onTimeCount || 0}\n                </p>\n              </div>\n              <div className=\"space-y-1\" data-testid=\"summary-late\">\n                <p className=\"text-sm text-muted-foreground\">Late</p>\n                <p className=\"text-2xl font-bold text-orange-600\" data-testid=\"text-late-count\">\n                  {reportData.summary.lateCount} ({reportData.summary.latePercentage}%)\n                </p>\n              </div>\n              <div className=\"space-y-1\" data-testid=\"summary-half-day\">\n                <p className=\"text-sm text-muted-foreground\">Half-Day</p>\n                <p className=\"text-2xl font-bold text-blue-600\" data-testid=\"text-half-day-count\">\n                  {reportData.summary.halfDayCount} ({reportData.summary.halfDayPercentage}%)\n                </p>\n              </div>\n              <div className=\"space-y-1\" data-testid=\"summary-absent\">\n                <p className=\"text-sm text-muted-foreground\">Absent</p>\n                <p className=\"text-2xl font-bold text-red-600\" data-testid=\"text-absent-count\">\n                  {reportData.summary.absentCount} ({reportData.summary.absentPercentage}%)\n                </p>\n              </div>\n              <div className=\"space-y-1\" data-testid=\"summary-total-hours\">\n                <p className=\"text-sm text-muted-foreground\">Total Hours</p>\n                <p className=\"text-2xl font-bold text-slate-700 dark:text-slate-300\" data-testid=\"text-total-hours\">\n                  {reportData.summary.totalHoursWorked ? parseFloat(reportData.summary.totalHoursWorked).toFixed(1) : \"0.0\"} hrs\n                </p>\n              </div>\n              <div className=\"space-y-1\" data-testid=\"summary-overtime-hours\">\n                <p className=\"text-sm text-muted-foreground\">Overtime</p>\n                <p className=\"text-2xl font-bold text-purple-600\" data-testid=\"text-overtime-hours\">\n                  {reportData.summary.overtimeHours ? parseFloat(reportData.summary.overtimeHours).toFixed(1) : \"0.0\"} hrs\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex gap-2 mt-6 flex-wrap\">\n              <Button onClick={() => handleExport(\"pdf\")} variant=\"outline\" data-testid=\"button-export-pdf\">\n                <FileText className=\"mr-2 h-4 w-4\" />\n                {isJobCard ? \"Export Job Card (PDF)\" : \"Export PDF\"}\n              </Button>\n              <Button onClick={() => handleExport(\"excel\")} variant=\"outline\" data-testid=\"button-export-excel\">\n                <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n                {isJobCard ? \"Export Job Card (Excel)\" : \"Export Excel\"}\n              </Button>\n              <Button onClick={() => handleExport(\"word\")} variant=\"outline\" data-testid=\"button-export-word\">\n                <FileType className=\"mr-2 h-4 w-4\" />\n                {isJobCard ? \"Export Job Card (Word)\" : \"Export Word\"}\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Attendance Table */}\n      {reportData && reportData.attendanceData.length > 0 && (\n        <Card data-testid=\"card-attendance-table\">\n          <CardHeader>\n            <CardTitle data-testid=\"text-table-title\">Attendance Details</CardTitle>\n            <CardDescription data-testid=\"text-table-description\">\n              Detailed attendance records for the selected period\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"rounded-md border overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead data-testid=\"header-date\">Date</TableHead>\n                    <TableHead data-testid=\"header-employee\">Employee</TableHead>\n                    <TableHead data-testid=\"header-employee-code\">Employee Code</TableHead>\n                    <TableHead data-testid=\"header-department\">Department</TableHead>\n                    <TableHead data-testid=\"header-status\">Status</TableHead>\n                    <TableHead data-testid=\"header-check-in\">Check In</TableHead>\n                    <TableHead data-testid=\"header-check-out\">Check Out</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {reportData.attendanceData.map((record, index) => (\n                    <TableRow key={`${record.employeeId}-${record.date}`} data-testid={`row-attendance-${index}`}>\n                      <TableCell data-testid={`cell-date-${index}`}>{record.date}</TableCell>\n                      <TableCell data-testid={`cell-employee-${index}`}>{record.employeeName}</TableCell>\n                      <TableCell data-testid={`cell-employee-code-${index}`}>{record.employeeCode}</TableCell>\n                      <TableCell data-testid={`cell-department-${index}`}>{record.department}</TableCell>\n                      <TableCell data-testid={`cell-status-${index}`}>\n                        <Badge variant={getStatusBadgeVariant(record.status)} data-testid={`badge-status-${index}`}>\n                          {record.status.charAt(0).toUpperCase() + record.status.slice(1)}\n                        </Badge>\n                      </TableCell>\n                      <TableCell data-testid={`cell-check-in-${index}`}>{record.checkInTime || \"-\"}</TableCell>\n                      <TableCell data-testid={`cell-check-out-${index}`}>{record.checkOutTime || \"-\"}</TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Loading State */}\n      {reportLoading && (\n        <Card data-testid=\"card-loading\">\n          <CardContent className=\"py-10\">\n            <p className=\"text-center text-muted-foreground\" data-testid=\"text-loading\">\n              Generating attendance report...\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Empty State */}\n      {reportGenerated && reportData && reportData.attendanceData.length === 0 && (\n        <Card data-testid=\"card-empty\">\n          <CardContent className=\"py-10\">\n            <p className=\"text-center text-muted-foreground\" data-testid=\"text-empty\">\n              No attendance records found for the selected period and filters.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":19942,"size_tokens":null},"client/src/pages/office-settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { HrSettings } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n  FormDescription,\n} from \"@/components/ui/form\";\nimport { Clock, DollarSign, Users, Calendar } from \"lucide-react\";\n\nconst DAYS_OF_WEEK = [\n  \"Monday\",\n  \"Tuesday\",\n  \"Wednesday\",\n  \"Thursday\",\n  \"Friday\",\n  \"Saturday\",\n  \"Sunday\",\n];\n\nconst officeSettingsSchema = z.object({\n  officeStartTime: z.string().min(1, \"Required\"),\n  officeEndTime: z.string().min(1, \"Required\"),\n  fullDayHours: z.coerce.number().min(1, \"Must be at least 1 hour\"),\n  gracePeriodMinutes: z.coerce.number().min(0, \"Cannot be negative\"),\n  halfDayCutoffTime: z.string().min(1, \"Required\"),\n  halfDayHours: z.coerce.number().min(0.5, \"Must be at least 0.5 hours\"),\n  minimumHoursForPresent: z.coerce.number().min(1, \"Must be at least 1 hour\"),\n  overtimeEnabled: z.boolean(),\n  overtimeRateMultiplier: z.coerce.number().min(1, \"Must be at least 1.0\"),\n  lateDeductionRule: z.coerce.number().min(1, \"Must be at least 1\"),\n  weeklyOffDays: z.array(z.string()).min(1, \"Select at least one day\"),\n});\n\ntype OfficeSettingsFormData = z.infer<typeof officeSettingsSchema>;\n\nexport default function OfficeSettings() {\n  const { toast } = useToast();\n  const [settingsId, setSettingsId] = useState<string>(\"\");\n\n  const { data: settings, isLoading } = useQuery<HrSettings>({\n    queryKey: [\"/api/hr-settings\"],\n  });\n\n  // Update settingsId when settings are loaded\n  useEffect(() => {\n    if (settings?.id) {\n      setSettingsId(settings.id);\n    }\n  }, [settings]);\n\n  const form = useForm<OfficeSettingsFormData>({\n    resolver: zodResolver(officeSettingsSchema),\n    values: settings\n      ? {\n          officeStartTime: settings.officeStartTime || \"09:00\",\n          officeEndTime: settings.officeEndTime || \"18:00\",\n          fullDayHours: Number(settings.fullDayHours) || 8,\n          gracePeriodMinutes: Number(settings.gracePeriodMinutes) || 10,\n          halfDayCutoffTime: settings.halfDayCutoffTime || \"14:00\",\n          halfDayHours: Number(settings.halfDayHours) || 4,\n          minimumHoursForPresent: Number(settings.minimumHoursForPresent) || 6,\n          overtimeEnabled: settings.overtimeEnabled || false,\n          overtimeRateMultiplier: Number(settings.overtimeRateMultiplier) || 1.5,\n          lateDeductionRule: Number(settings.lateDeductionRule) || 3,\n          weeklyOffDays: Array.isArray(settings.weeklyOffDays)\n            ? settings.weeklyOffDays\n            : [\"Friday\"],\n        }\n      : undefined,\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: (data: OfficeSettingsFormData) =>\n      apiRequest(\"PATCH\", `/api/hr-settings/${settingsId}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/hr-settings\"] });\n      toast({\n        title: \"Success\",\n        description: \"Office settings updated successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: OfficeSettingsFormData) => {\n    updateMutation.mutate(data);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"h-8 bg-muted rounded w-48 mb-6 animate-pulse\" />\n        <div className=\"grid gap-6\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardHeader>\n                <div className=\"h-6 bg-muted rounded w-32 mb-2 animate-pulse\" />\n                <div className=\"h-4 bg-muted rounded w-48 animate-pulse\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-20 bg-muted rounded animate-pulse\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">\n          Office Hours Settings\n        </h1>\n        <p className=\"text-sm text-muted-foreground\">\n          Configure timing rules for attendance and salary calculations\n        </p>\n      </div>\n\n      <Form {...form}>\n        <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n          {/* Office Timings */}\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <Clock className=\"w-5 h-5 text-primary\" />\n                <CardTitle>Office Timings</CardTitle>\n              </div>\n              <CardDescription>\n                Set the standard office hours and working time\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"grid gap-4 md:grid-cols-2\">\n              <FormField\n                control={form.control}\n                name=\"officeStartTime\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Office Start Time</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"time\"\n                        {...field}\n                        data-testid=\"input-office-start-time\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"officeEndTime\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Office End Time</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"time\"\n                        {...field}\n                        data-testid=\"input-office-end-time\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"fullDayHours\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Total Working Hours per Day</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        step=\"0.5\"\n                        {...field}\n                        data-testid=\"input-full-day-hours\"\n                      />\n                    </FormControl>\n                    <FormDescription>Standard hours for full day</FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"gracePeriodMinutes\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Grace Period (Minutes)</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        {...field}\n                        data-testid=\"input-grace-period\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Allowed delay before marking as late\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Attendance Rules */}\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <Users className=\"w-5 h-5 text-primary\" />\n                <CardTitle>Attendance Rules</CardTitle>\n              </div>\n              <CardDescription>\n                Configure half-day and present/absent criteria\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"grid gap-4 md:grid-cols-2\">\n              <FormField\n                control={form.control}\n                name=\"halfDayCutoffTime\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Half-Day Cutoff Time</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"time\"\n                        {...field}\n                        data-testid=\"input-half-day-cutoff\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Check-in after this time = half day\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"halfDayHours\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Half-Day Working Hours</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        step=\"0.5\"\n                        {...field}\n                        data-testid=\"input-half-day-hours\"\n                      />\n                    </FormControl>\n                    <FormDescription>Hours required for half day</FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"minimumHoursForPresent\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Minimum Hours for Present</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        step=\"0.5\"\n                        {...field}\n                        data-testid=\"input-minimum-hours\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Below this = marked absent\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"lateDeductionRule\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Late Count Threshold</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        {...field}\n                        data-testid=\"input-late-threshold\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      This many lates = 1 absent\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Overtime Settings */}\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <DollarSign className=\"w-5 h-5 text-primary\" />\n                <CardTitle>Overtime Configuration</CardTitle>\n              </div>\n              <CardDescription>\n                Configure overtime pay calculations\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"overtimeEnabled\"\n                render={({ field }) => (\n                  <FormItem className=\"flex items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-base\">\n                        Enable Overtime Calculation\n                      </FormLabel>\n                      <FormDescription>\n                        Calculate and pay for extra working hours\n                      </FormDescription>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-overtime-enabled\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"overtimeRateMultiplier\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Overtime Rate Multiplier</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        step=\"0.1\"\n                        {...field}\n                        disabled={!form.watch(\"overtimeEnabled\")}\n                        data-testid=\"input-overtime-multiplier\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      E.g., 1.5 = 1.5 normal hourly rate\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Weekly Off Days */}\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <Calendar className=\"w-5 h-5 text-primary\" />\n                <CardTitle>Weekly Off Days</CardTitle>\n              </div>\n              <CardDescription>\n                Select weekly holidays (non-working days)\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <FormField\n                control={form.control}\n                name=\"weeklyOffDays\"\n                render={() => (\n                  <FormItem>\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                      {DAYS_OF_WEEK.map((day) => (\n                        <FormField\n                          key={day}\n                          control={form.control}\n                          name=\"weeklyOffDays\"\n                          render={({ field }) => {\n                            return (\n                              <FormItem\n                                key={day}\n                                className=\"flex flex-row items-start space-x-3 space-y-0\"\n                              >\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value?.includes(day)}\n                                    onCheckedChange={(checked) => {\n                                      return checked\n                                        ? field.onChange([...field.value, day])\n                                        : field.onChange(\n                                            field.value?.filter(\n                                              (value) => value !== day\n                                            )\n                                          );\n                                    }}\n                                    data-testid={`checkbox-day-${day.toLowerCase()}`}\n                                  />\n                                </FormControl>\n                                <FormLabel className=\"font-normal\">\n                                  {day}\n                                </FormLabel>\n                              </FormItem>\n                            );\n                          }}\n                        />\n                      ))}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Save Button */}\n          <div className=\"flex justify-end\">\n            <Button\n              type=\"submit\"\n              disabled={updateMutation.isPending}\n              data-testid=\"button-save-settings\"\n            >\n              {updateMutation.isPending ? \"Saving...\" : \"Save Settings\"}\n            </Button>\n          </div>\n        </form>\n      </Form>\n    </div>\n  );\n}\n","path":null,"size_bytes":16761,"size_tokens":null},"client/src/components/smart-lead-finder.tsx":{"content":"import { useState } from \"react\";\nimport { Search, Globe, Phone, Mail, Building2, Loader2, Import, ChevronDown, ChevronUp, Plus, AlertCircle, CheckCheck } from \"lucide-react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { LeadCategory } from \"@shared/schema\";\n\ninterface BusinessResult {\n  name: string;\n  phone?: string;\n  email?: string;\n  website?: string;\n  address?: string;\n  category?: string;\n  rating?: number;\n  reviews?: number;\n  source: string;\n}\n\ninterface SearchResponse {\n  keyword: string;\n  location: string | null;\n  results: BusinessResult[];\n  totalResults?: number;\n  page: number;\n  perPage: number;\n  hasMore: boolean;\n}\n\ninterface SearchAllResponse {\n  keyword: string;\n  location: string;\n  results: BusinessResult[];\n  totalResults: number;\n}\n\ninterface ImportResponse {\n  message: string;\n  success: number;\n  skipped: number;\n  failed: number;\n  errors: { name: string; error: string }[];\n  duplicates: { name: string; reason: string }[];\n  imported: any[];\n}\n\ninterface SmartLeadFinderProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nconst DEFAULT_CATEGORIES = [\n  \"Software Company\",\n  \"Garments\",\n  \"Buying House\",\n  \"Marketing Agency\",\n  \"School / College\",\n  \"Restaurant\",\n  \"Hospital / Clinic\",\n  \"Real Estate\",\n  \"E-commerce\",\n  \"Manufacturing\",\n  \"IT Services\",\n  \"Consulting\",\n  \"Retail\",\n  \"Other\",\n];\n\nexport function SmartLeadFinder({ open, onOpenChange }: SmartLeadFinderProps) {\n  const { toast } = useToast();\n  \n  const { data: dbCategories = [] } = useQuery<LeadCategory[]>({\n    queryKey: [\"/api/lead-categories\"],\n    enabled: open,\n  });\n  \n  const categories = dbCategories.length > 0 \n    ? dbCategories.filter(c => c.isActive).map(c => c.name)\n    : DEFAULT_CATEGORIES;\n  const [keyword, setKeyword] = useState(\"\");\n  const [location, setLocation] = useState(\"\");\n  const [results, setResults] = useState<BusinessResult[]>([]);\n  const [selectedIds, setSelectedIds] = useState<Set<number>>(new Set());\n  const [showResults, setShowResults] = useState(false);\n  const [currentPage, setCurrentPage] = useState(1);\n  const [hasMore, setHasMore] = useState(false);\n  const [totalResults, setTotalResults] = useState(0);\n  const [searchKeyword, setSearchKeyword] = useState(\"\");\n  const [searchLocation, setSearchLocation] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState<string>(\"\");\n  const [selectedSource, setSelectedSource] = useState<string>(\"Smart Lead Finder\");\n  const [expandedCategories, setExpandedCategories] = useState<Set<string>>(new Set());\n  const [showImportOptions, setShowImportOptions] = useState(false);\n  const [isLoadingAllPages, setIsLoadingAllPages] = useState(false);\n  const [loadingProgress, setLoadingProgress] = useState({ loaded: 0, total: 0 });\n\n  const searchMutation = useMutation({\n    mutationFn: async (page: number) => {\n      const response = await apiRequest(\"POST\", \"/api/leads/smart-finder/search\", {\n        keyword: keyword.trim(),\n        location: location.trim() || undefined,\n        page,\n        perPage: 40,\n        previousTotal: page > 1 ? totalResults : 0, // Send previous total for monotonic accumulator\n      });\n      return response as SearchResponse;\n    },\n    onSuccess: (data, page) => {\n      if (page === 1) {\n        setResults(data.results);\n        setSelectedIds(new Set());\n        setSearchKeyword(data.keyword);\n        setSearchLocation(data.location || \"\");\n      } else {\n        setResults(prev => [...prev, ...data.results]);\n      }\n      \n      setCurrentPage(data.page);\n      setHasMore(data.hasMore);\n      // DEFENSIVE: Ensure totalResults never decreases (double-check monotonic)\n      setTotalResults(prev => Math.max(data.totalResults || data.results.length, prev));\n      setShowResults(true);\n      \n      const categories = new Set(data.results.map(r => r.category || \"Uncategorized\"));\n      setExpandedCategories(categories);\n      \n      if (page === 1) {\n        toast({\n          title: \"Search Complete\",\n          description: `Found ${data.results.length} business${data.results.length !== 1 ? \"es\" : \"\"} for \"${data.keyword}\"`,\n        });\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Search Failed\",\n        description: error.message || \"Failed to search for businesses\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const importMutation = useMutation({\n    mutationFn: async (selectedLeads: BusinessResult[]) => {\n      const response = await apiRequest(\"POST\", \"/api/leads/smart-finder/import\", {\n        selectedLeads,\n        defaultCategory: selectedCategory || undefined,\n        defaultSource: selectedSource || \"Smart Lead Finder\",\n      });\n      return response as ImportResponse;\n    },\n    onSuccess: (data) => {\n      const parts = [];\n      if (data.success > 0) parts.push(` ${data.success} imported`);\n      if (data.skipped > 0) parts.push(` ${data.skipped} duplicates`);\n      if (data.failed > 0) parts.push(` ${data.failed} failed`);\n      \n      toast({\n        title: \"Import Complete\",\n        description: parts.join(\"  \"),\n      });\n      \n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      \n      if (data.success > 0) {\n        const importedIds = data.imported.map((_, i) => Array.from(selectedIds)[i]);\n        setSelectedIds(new Set(Array.from(selectedIds).filter(id => !importedIds.includes(id))));\n        \n        if (data.duplicates.length > 0 || data.errors.length > 0) {\n          setShowImportOptions(false);\n        } else {\n          onOpenChange(false);\n          handleReset();\n        }\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Import Failed\",\n        description: error.message || \"Failed to import leads\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSearch = () => {\n    if (!keyword.trim()) {\n      toast({\n        title: \"Search Error\",\n        description: \"Please enter a search keyword\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    searchMutation.mutate(1);\n  };\n\n  const handleLoadMore = () => {\n    searchMutation.mutate(currentPage + 1);\n  };\n\n  const handleSelectAll = (checked: boolean) => {\n    if (checked) {\n      setSelectedIds(new Set(results.map((_, i) => i)));\n    } else {\n      setSelectedIds(new Set());\n    }\n  };\n\n  // Fetch ALL results at once using the search-all endpoint\n  const handleSelectAllAcrossPages = async () => {\n    if (isLoadingAllPages) return;\n    \n    const searchKw = searchKeyword || keyword.trim();\n    const searchLoc = searchLocation || location.trim();\n    \n    // If no location provided, can't use search-all\n    if (!searchLoc) {\n      toast({\n        title: \"Location Required\",\n        description: \"Please provide a location to load all results\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // Store previous state in case of error\n    const previousResults = [...results];\n    const previousSelectedIds = new Set(selectedIds);\n    const previousTotalResults = totalResults;\n    \n    setIsLoadingAllPages(true);\n    // Show more accurate progress - start at current count\n    setLoadingProgress({ loaded: results.length, total: Math.max(totalResults, results.length) });\n    \n    try {\n      // Use the search-all endpoint to fetch ALL results at once\n      const response = await apiRequest(\"POST\", \"/api/leads/smart-finder/search-all\", {\n        keyword: searchKw,\n        location: searchLoc,\n      }) as SearchAllResponse;\n      \n      // Update all state with complete results\n      setResults(response.results);\n      setTotalResults(response.totalResults);\n      setHasMore(false); // All results are now loaded\n      setCurrentPage(1);\n      setSearchKeyword(response.keyword);\n      setSearchLocation(response.location);\n      \n      // Select ALL results\n      setSelectedIds(new Set(response.results.map((_, i) => i)));\n      \n      // Expand all categories\n      const cats = new Set(response.results.map(r => r.category || \"Uncategorized\"));\n      setExpandedCategories(cats);\n      \n      toast({\n        title: \"All Results Loaded & Selected\",\n        description: `Loaded and selected all ${response.totalResults} leads`,\n      });\n    } catch (error: any) {\n      // On error, restore previous state and selections\n      setResults(previousResults);\n      setSelectedIds(previousSelectedIds);\n      setTotalResults(previousTotalResults);\n      \n      toast({\n        title: \"Error Loading All Results\",\n        description: error.message || \"Failed to load all results. Your previous selections are preserved.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoadingAllPages(false);\n      setLoadingProgress({ loaded: 0, total: 0 });\n    }\n  };\n\n  const handleSelectRow = (index: number, checked: boolean) => {\n    const newSelected = new Set(selectedIds);\n    if (checked) {\n      newSelected.add(index);\n    } else {\n      newSelected.delete(index);\n    }\n    setSelectedIds(newSelected);\n  };\n\n  const handleImport = () => {\n    const selected = Array.from(selectedIds).map(i => results[i]);\n    if (selected.length === 0) {\n      toast({\n        title: \"Selection Error\",\n        description: \"Please select at least one lead to import\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setShowImportOptions(true);\n  };\n\n  const handleConfirmImport = () => {\n    const selected = Array.from(selectedIds).map(i => results[i]);\n    importMutation.mutate(selected);\n  };\n\n  const handleReset = () => {\n    setKeyword(\"\");\n    setLocation(\"\");\n    setResults([]);\n    setSelectedIds(new Set());\n    setShowResults(false);\n    setCurrentPage(1);\n    setHasMore(false);\n    setTotalResults(0);\n    setSearchKeyword(\"\");\n    setSearchLocation(\"\");\n    setSelectedCategory(\"\");\n    setShowImportOptions(false);\n  };\n\n  const toggleCategory = (category: string) => {\n    const newExpanded = new Set(expandedCategories);\n    if (newExpanded.has(category)) {\n      newExpanded.delete(category);\n    } else {\n      newExpanded.add(category);\n    }\n    setExpandedCategories(newExpanded);\n  };\n\n  const groupByCategory = () => {\n    const grouped = new Map<string, { results: BusinessResult[]; indices: number[] }>();\n    results.forEach((result, index) => {\n      const category = result.category || \"Uncategorized\";\n      if (!grouped.has(category)) {\n        grouped.set(category, { results: [], indices: [] });\n      }\n      grouped.get(category)!.results.push(result);\n      grouped.get(category)!.indices.push(index);\n    });\n    return grouped;\n  };\n\n  const allSelected = results.length > 0 && selectedIds.size === results.length;\n  const someSelected = selectedIds.size > 0 && selectedIds.size < results.length;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-6xl max-h-[90vh]\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Search className=\"h-5 w-5\" />\n            Smart Lead Finder\n          </DialogTitle>\n          <DialogDescription>\n            Search for businesses online and import them as leads\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {/* Search Form */}\n          <div className=\"flex gap-2\">\n            <Input\n              data-testid=\"input-keyword\"\n              placeholder=\"e.g., IT Companies, Real Estate, Restaurants\"\n              value={keyword}\n              onChange={(e) => setKeyword(e.target.value)}\n              onKeyDown={(e) => e.key === \"Enter\" && handleSearch()}\n              disabled={searchMutation.isPending}\n              className=\"flex-1\"\n            />\n            <Input\n              data-testid=\"input-location\"\n              placeholder=\"Location (optional)\"\n              value={location}\n              onChange={(e) => setLocation(e.target.value)}\n              onKeyDown={(e) => e.key === \"Enter\" && handleSearch()}\n              disabled={searchMutation.isPending}\n              className=\"w-64\"\n            />\n            <Button\n              data-testid=\"button-search\"\n              onClick={handleSearch}\n              disabled={searchMutation.isPending}\n              variant=\"default\"\n            >\n              {searchMutation.isPending ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <Search className=\"h-4 w-4\" />\n              )}\n              Search\n            </Button>\n          </div>\n\n          {/* Results Section */}\n          {showResults && (\n            <>\n              {/* Summary Header */}\n              <div className=\"flex items-center justify-between p-3 bg-muted rounded-md\">\n                <div className=\"flex items-center gap-4 text-sm\">\n                  <span className=\"font-medium\" data-testid=\"text-result-count\">\n                    Found {totalResults} result{totalResults !== 1 ? 's' : ''}\n                  </span>\n                  <span className=\"text-muted-foreground\">\n                    Showing {results.length} of {totalResults}\n                  </span>\n                  {selectedIds.size > 0 && (\n                    <Badge variant=\"secondary\" data-testid=\"text-selected-count\">\n                      {selectedIds.size} selected\n                    </Badge>\n                  )}\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {/* Select All Across All Pages Button */}\n                  <Button\n                    data-testid=\"button-select-all-pages\"\n                    onClick={handleSelectAllAcrossPages}\n                    disabled={isLoadingAllPages || searchMutation.isPending}\n                    variant=\"outline\"\n                    size=\"sm\"\n                  >\n                    {isLoadingAllPages ? (\n                      <>\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                        Loading {loadingProgress.loaded}/{loadingProgress.total}...\n                      </>\n                    ) : selectedIds.size === results.length && results.length === totalResults ? (\n                      <>\n                        <CheckCheck className=\"h-4 w-4 mr-2\" />\n                        All {totalResults} Selected\n                      </>\n                    ) : (\n                      <>\n                        <CheckCheck className=\"h-4 w-4 mr-2\" />\n                        Select All ({totalResults})\n                      </>\n                    )}\n                  </Button>\n                  \n                  {/* Clear Selection */}\n                  {selectedIds.size > 0 && (\n                    <Button\n                      data-testid=\"button-clear-selection\"\n                      onClick={() => setSelectedIds(new Set())}\n                      variant=\"ghost\"\n                      size=\"sm\"\n                    >\n                      Clear\n                    </Button>\n                  )}\n                  \n                  {selectedIds.size > 0 && (\n                    <Button\n                      data-testid=\"button-import-selected\"\n                      onClick={handleImport}\n                      disabled={importMutation.isPending}\n                      size=\"sm\"\n                    >\n                      <Import className=\"h-4 w-4 mr-2\" />\n                      Import Selected ({selectedIds.size})\n                    </Button>\n                  )}\n                </div>\n              </div>\n\n              {/* Import Options */}\n              {showImportOptions && (\n                <Card className=\"p-4 border-primary\">\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <h3 className=\"font-medium\">Import Options</h3>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => setShowImportOptions(false)}\n                      >\n                        Cancel\n                      </Button>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">\n                        Category <span className=\"text-destructive\">*</span>\n                      </label>\n                      <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                        <SelectTrigger data-testid=\"select-category\">\n                          <SelectValue placeholder=\"Select a category\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {categories.map((cat) => (\n                            <SelectItem key={cat} value={cat} data-testid={`option-category-${cat}`}>\n                              {cat}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Select the category for imported leads\n                      </p>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">\n                        Source\n                      </label>\n                      <Select value={selectedSource} onValueChange={setSelectedSource}>\n                        <SelectTrigger data-testid=\"select-source\">\n                          <SelectValue placeholder=\"Select a source\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"Smart Lead Finder\">Smart Lead Finder</SelectItem>\n                          <SelectItem value=\"Google Search\">Google Search</SelectItem>\n                          <SelectItem value=\"Lead Finder\">Lead Finder</SelectItem>\n                          <SelectItem value=\"Web Search\">Web Search</SelectItem>\n                          <SelectItem value=\"Online Directory\">Online Directory</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Source tracking for leads\n                      </p>\n                    </div>\n                    <Button\n                      data-testid=\"button-confirm-import\"\n                      onClick={handleConfirmImport}\n                      disabled={importMutation.isPending}\n                      className=\"w-full\"\n                    >\n                      {importMutation.isPending ? (\n                        <>\n                          <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                          Importing...\n                        </>\n                      ) : (\n                        <>\n                          <Plus className=\"h-4 w-4 mr-2\" />\n                          Confirm Import ({selectedIds.size} leads)\n                        </>\n                      )}\n                    </Button>\n                  </div>\n                </Card>\n              )}\n\n              {/* Results Table */}\n              <ScrollArea className=\"h-[400px] border rounded-md\">\n                <Table>\n                  <TableHeader className=\"sticky top-0 bg-background z-10\">\n                    <TableRow>\n                      <TableHead className=\"w-12\">\n                        <Checkbox\n                          data-testid=\"checkbox-select-all\"\n                          checked={allSelected}\n                          onCheckedChange={handleSelectAll}\n                          aria-label=\"Select all\"\n                          className={someSelected ? \"opacity-50\" : \"\"}\n                        />\n                      </TableHead>\n                      <TableHead>Business Name</TableHead>\n                      <TableHead>Contact</TableHead>\n                      <TableHead>Website</TableHead>\n                      <TableHead>Category</TableHead>\n                      <TableHead className=\"text-right\">Rating</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {results.map((result, index) => {\n                      const hasEmail = !!result.email;\n                      const hasPhone = !!result.phone;\n                      const hasWebsite = !!result.website;\n                      \n                      return (\n                        <TableRow key={index} data-testid={`row-result-${index}`}>\n                          <TableCell>\n                            <Checkbox\n                              data-testid={`checkbox-select-${index}`}\n                              checked={selectedIds.has(index)}\n                              onCheckedChange={(checked) => handleSelectRow(index, checked as boolean)}\n                            />\n                          </TableCell>\n                          <TableCell className=\"font-medium\" data-testid={`text-name-${index}`}>\n                            {result.name}\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex flex-col gap-1\">\n                              {hasEmail ? (\n                                <div className=\"flex items-center gap-1 text-sm\">\n                                  <Mail className=\"h-3 w-3 text-muted-foreground\" />\n                                  <span data-testid={`text-email-${index}`}>{result.email}</span>\n                                </div>\n                              ) : (\n                                <span className=\"text-muted-foreground text-sm\"></span>\n                              )}\n                              {hasPhone ? (\n                                <div className=\"flex items-center gap-1 text-sm\">\n                                  <Phone className=\"h-3 w-3 text-muted-foreground\" />\n                                  <span data-testid={`text-phone-${index}`}>{result.phone}</span>\n                                </div>\n                              ) : (\n                                <span className=\"text-muted-foreground text-sm\"></span>\n                              )}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            {hasWebsite && result.website ? (\n                              <a\n                                href={result.website}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                                className=\"flex items-center gap-1 text-sm text-primary hover:underline\"\n                                data-testid={`link-website-${index}`}\n                              >\n                                <Globe className=\"h-3 w-3\" />\n                                {(() => {\n                                  try {\n                                    const url = new URL(result.website.startsWith('http') ? result.website : `https://${result.website}`);\n                                    return url.hostname;\n                                  } catch {\n                                    return result.website;\n                                  }\n                                })()}\n                              </a>\n                            ) : (\n                              <span className=\"text-muted-foreground text-sm\"></span>\n                            )}\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant=\"outline\" data-testid={`badge-category-${index}`}>\n                              {result.category || \"General\"}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            {result.rating ? (\n                              <div className=\"flex items-center justify-end gap-1\" data-testid={`text-rating-${index}`}>\n                                <span className=\"font-medium\">{result.rating}</span>\n                                <span className=\"text-muted-foreground text-xs\">\n                                  ({result.reviews || 0})\n                                </span>\n                              </div>\n                            ) : (\n                              <span className=\"text-muted-foreground text-sm\"></span>\n                            )}\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })}\n                  </TableBody>\n                </Table>\n              </ScrollArea>\n\n              {/* Load More Button */}\n              {hasMore && (\n                <div className=\"flex justify-center pt-2\">\n                  <Button\n                    data-testid=\"button-load-more\"\n                    onClick={handleLoadMore}\n                    disabled={searchMutation.isPending}\n                    variant=\"outline\"\n                  >\n                    {searchMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n                    ) : (\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                    )}\n                    Load More Results\n                  </Button>\n                </div>\n              )}\n            </>\n          )}\n\n          {/* Empty State */}\n          {!showResults && !searchMutation.isPending && (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <Search className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p className=\"text-lg font-medium\">Search for Businesses</p>\n              <p className=\"text-sm\">\n                Enter a keyword like \"Construction companies USA\" or \"Digital marketing agencies Dubai\"\n              </p>\n            </div>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":26962,"size_tokens":null},"server/services/serpapi.ts":{"content":"interface BusinessResult {\n  name: string;\n  phone?: string;\n  email?: string;\n  website?: string;\n  address?: string;\n  category?: string;\n  rating?: number;\n  reviews?: number;\n  source: string;\n}\n\ninterface SearchOptions {\n  keyword: string;\n  location?: string;\n  page?: number;\n  perPage?: number;\n  previousTotal?: number;  // For monotonic accumulator\n}\n\ninterface SearchResults {\n  results: BusinessResult[];\n  totalResults?: number;\n  page: number;\n  perPage: number;\n  hasMore: boolean;\n}\n\ninterface SearchAllResults {\n  results: BusinessResult[];\n  totalResults: number;\n}\n\ninterface SerpApiLocalResponse {\n  local_results?: Array<{\n    title?: string;\n    phone?: string;\n    website?: string;\n    address?: string;\n    type?: string;\n    rating?: number;\n    reviews?: number;\n    links?: { website?: string };\n  }>;\n  organic_results?: Array<{\n    title?: string;\n    link?: string;\n    snippet?: string;\n    displayed_link?: string;\n  }>;\n  search_information?: {\n    total_results?: string | number;\n  };\n  error?: string;\n}\n\ninterface SerpApiMapsResponse {\n  local_results?: Array<{\n    title?: string;\n    name?: string;\n    phone?: string;\n    website?: string;\n    link?: string;\n    address?: string;\n    type?: string;\n    types?: string[];\n    rating?: number;\n    reviews?: number;\n  }>;\n  place_results?: Array<{\n    title?: string;\n    name?: string;\n    phone?: string;\n    website?: string;\n    link?: string;\n    address?: string;\n    type?: string;\n    types?: string[];\n    rating?: number;\n    reviews?: number;\n  }>;\n  search_information?: {\n    total_results?: string | number;\n  };\n  error?: string;\n}\n\nclass SerpApiService {\n  private apiKey: string | undefined;\n\n  constructor() {\n    this.apiKey = process.env.SERPAPI_KEY;\n  }\n\n  isConfigured(): boolean {\n    return !!this.apiKey;\n  }\n\n  // Geocode location name to GPS coordinates using Nominatim (OpenStreetMap)\n  private async geocodeLocation(location: string): Promise<string | null> {\n    try {\n      const encodedLocation = encodeURIComponent(location);\n      const url = `https://nominatim.openstreetmap.org/search?q=${encodedLocation}&format=json&limit=1`;\n      \n      const response = await fetch(url, {\n        headers: {\n          'User-Agent': 'MaxTech-SmartLeadFinder/1.0'\n        }\n      });\n      \n      if (!response.ok) {\n        console.error(`Geocoding failed: ${response.status}`);\n        return null;\n      }\n\n      const data = await response.json();\n      \n      if (data && data.length > 0) {\n        const { lat, lon } = data[0];\n        // Format: @latitude,longitude,zoom (zoom 14 is city-level)\n        return `@${lat},${lon},14z`;\n      }\n      \n      return null;\n    } catch (error: any) {\n      console.error('Geocoding error:', error.message);\n      return null;\n    }\n  }\n\n  async searchBusinesses(options: SearchOptions): Promise<SearchResults> {\n    if (!this.apiKey) {\n      throw new Error(\"SERPAPI_KEY not configured\");\n    }\n\n    const { keyword, location, page = 1, perPage = 40, previousTotal = 0 } = options;\n    const allResults: BusinessResult[] = [];\n    const seenDomains = new Set<string>();\n    const seenNames = new Set<string>();\n\n    try {\n      console.log(`SerpAPI: Searching for \"${keyword}\" ${location ? `in ${location}` : ''} (page ${page})`);\n\n      let serpApiTotal = 0;\n      \n      // STRATEGY: Fixed Raw Results per Page (Option 2)\n      // Each page fetches exactly 80 raw results (4 Google Maps API calls  20 results)\n      // After filtering, return all qualified businesses from those 80 raw results\n      // This ensures:\n      // - Predictable pagination (no overlapping/skipping)\n      // - Consistent page boundaries\n      // - Variable but reasonable qualified count (typically 25-45 after filtering)\n      \n      const RAW_RESULTS_PER_PAGE = 80; // 4 API calls  20 results each\n      const MAPS_PER_CALL = 20; // Google Maps returns exactly 20 per call\n      const API_CALLS_PER_PAGE = 4; // 80 / 20 = 4 calls\n      \n      // Geocode location to coordinates\n      let coordinates: string | null = null;\n      if (location) {\n        coordinates = await this.geocodeLocation(location);\n        if (coordinates) {\n          console.log(`Geocoded \"${location}\" to ${coordinates}`);\n        } else {\n          // Geocoding failed - return error instead of wrong results\n          console.error(`Failed to geocode location: \"${location}\"`);\n          throw new Error(`Unable to find location: \"${location}\". Please check the spelling or try a different location.`);\n        }\n      } else {\n        // No location provided\n        throw new Error(\"Location is required for business search\");\n      }\n      \n      // Calculate starting offset for this page\n      // Page 1: offsets 0, 20, 40, 60\n      // Page 2: offsets 80, 100, 120, 140\n      // Page 3: offsets 160, 180, 200, 220\n      const pageStartOffset = (page - 1) * RAW_RESULTS_PER_PAGE;\n      \n      let totalFetched = 0;\n      let lastCallWasPartial = false;\n      \n      // Fetch exactly 4 API calls (or until API exhausted)\n      for (let i = 0; i < API_CALLS_PER_PAGE; i++) {\n        const currentOffset = pageStartOffset + (i * MAPS_PER_CALL);\n        \n        const { results: mapsResults, totalResults: mapsTotal } = await this.searchGoogleMapsWithMeta(\n          keyword,\n          coordinates,\n          currentOffset,\n          MAPS_PER_CALL\n        );\n        \n        if (mapsTotal > serpApiTotal) {\n          serpApiTotal = mapsTotal;\n        }\n        \n        // Merge with deduplication\n        this.mergeResults(allResults, mapsResults, seenDomains, seenNames);\n        totalFetched += mapsResults.length;\n        \n        // Check if API is exhausted (got fewer than requested)\n        if (mapsResults.length < MAPS_PER_CALL) {\n          lastCallWasPartial = true;\n          console.log(`API exhausted after ${i + 1} calls (${totalFetched} raw results)`);\n          break; // Stop fetching - API exhausted\n        }\n      }\n\n      // Apply smart business filtering\n      // Since organic_results are removed, ALL results come from Google Maps/Local APIs\n      // These APIs return verified business listings, not general web pages\n      // Filter requirement: At least ONE verified contact method\n      const filtered = allResults.filter(business => \n        business.email || business.phone || business.website || business.address\n      );\n\n      // Return ALL qualified results from this page's raw results\n      // No slicing - give the user everything we found\n      const pageResults = filtered;\n\n      // Calculate total results - use SerpAPI total or estimate\n      let reportedTotal: number;\n      if (serpApiTotal > 0) {\n        // SerpAPI provides a total - clamp against previous to prevent regression\n        reportedTotal = Math.max(serpApiTotal, previousTotal);\n      } else {\n        // Conservative estimate based on current results\n        const currentEstimate = pageStartOffset + totalFetched;\n        reportedTotal = Math.max(currentEstimate, previousTotal);\n      }\n\n      // hasMore calculation:\n      // 1. If API exhausted (partial results), no more data available\n      // 2. If API returned full batches AND serpApiTotal is known, check if more data exists\n      // 3. If API returned full batches BUT serpApiTotal unknown, assume more data exists\n      let hasMore: boolean;\n      if (lastCallWasPartial) {\n        // API exhausted - definitely no more data\n        hasMore = false;\n      } else if (serpApiTotal > 0) {\n        // API provided total - check if we've reached it\n        hasMore = (pageStartOffset + RAW_RESULTS_PER_PAGE) < serpApiTotal;\n      } else {\n        // API didn't provide total but returned full batches - assume more data exists\n        hasMore = true;\n      }\n\n      console.log(`SerpAPI Page ${page}: RawOffset=${pageStartOffset}, RawFetched=${totalFetched}, Unique=${allResults.length}, Qualified=${filtered.length}, Total=${reportedTotal}, hasMore=${hasMore}`);\n\n      return {\n        results: pageResults,\n        totalResults: reportedTotal,\n        page,\n        perPage, // Keep for API compatibility\n        hasMore,\n      };\n\n    } catch (error: any) {\n      console.error(\"SerpAPI search error:\", error.message);\n      throw error;\n    }\n  }\n\n  private async searchGoogleLocalWithMeta(\n    keyword: string,\n    location: string | undefined,\n    start: number,\n    num: number\n  ): Promise<{ results: BusinessResult[]; totalResults: number }> {\n    const results: BusinessResult[] = [];\n    let totalResults = 0;\n\n    try {\n      const query = location ? `${keyword} ${location}` : keyword;\n      const encodedQuery = encodeURIComponent(query);\n      const url = `https://serpapi.com/search.json?engine=google&q=${encodedQuery}&api_key=${this.apiKey}&num=${num}&start=${start}`;\n      \n      console.log(`SerpAPI Google Local: Fetching ${num} results starting at ${start}`);\n      \n      const response = await fetch(url);\n      \n      if (!response.ok) {\n        console.error(`Google Local search failed: ${response.status}`);\n        return { results, totalResults };\n      }\n\n      const data: SerpApiLocalResponse = await response.json();\n\n      if (data.error) {\n        console.error(`Google Local API error: ${data.error}`);\n        return { results, totalResults };\n      }\n\n      // Extract total results from SerpAPI metadata\n      // Handle both string (e.g., \"1,234\") and number formats\n      if (data.search_information?.total_results) {\n        const totalStr = data.search_information.total_results;\n        if (typeof totalStr === 'string') {\n          totalResults = parseInt(totalStr.replace(/,/g, ''), 10) || 0;\n        } else if (typeof totalStr === 'number') {\n          totalResults = totalStr;\n        }\n      }\n\n      // Process local_results (Google Maps pack)\n      if (data.local_results && data.local_results.length > 0) {\n        for (const result of data.local_results) {\n          const website = result.website || result.links?.website;\n          const email = website ? this.generatePotentialEmail(result.title || '', website) : undefined;\n          \n          const business: BusinessResult = {\n            name: result.title || \"Unknown Business\",\n            phone: this.normalizePhone(result.phone),\n            email,\n            website,\n            address: result.address,\n            category: result.type,\n            rating: result.rating,\n            reviews: result.reviews,\n            source: \"Google Local\",\n          };\n          \n          results.push(business);\n        }\n      }\n\n      // REMOVED: organic_results processing\n      // Organic results return web pages (articles, blogs, videos, directories) instead of real businesses\n      // We only want verified businesses from local_results and google_maps with real contact information\n\n      return { results, totalResults };\n\n    } catch (error: any) {\n      console.error(\"Google Local search error:\", error.message);\n      return { results, totalResults };\n    }\n  }\n\n  private async searchGoogleMapsWithMeta(\n    keyword: string,\n    coordinates: string, // Format: @latitude,longitude,zoom\n    start: number,\n    num: number\n  ): Promise<{ results: BusinessResult[]; totalResults: number }> {\n    const results: BusinessResult[] = [];\n    let totalResults = 0;\n\n    try {\n      const encodedQuery = encodeURIComponent(keyword);\n      const url = `https://serpapi.com/search.json?engine=google_maps&q=${encodedQuery}&ll=${coordinates}&api_key=${this.apiKey}&type=search&start=${start}`;\n      \n      console.log(`SerpAPI Google Maps: Fetching results starting at ${start}`);\n      \n      const response = await fetch(url);\n      \n      if (!response.ok) {\n        console.error(`Google Maps search failed: ${response.status}`);\n        return { results, totalResults };\n      }\n\n      const data: SerpApiMapsResponse = await response.json();\n\n      if (data.error) {\n        console.error(`Google Maps API error: ${data.error}`);\n        return { results, totalResults };\n      }\n\n      // Extract total results from SerpAPI metadata\n      if (data.search_information?.total_results) {\n        const totalStr = data.search_information.total_results;\n        if (typeof totalStr === 'string') {\n          totalResults = parseInt(totalStr.replace(/,/g, ''), 10) || 0;\n        } else if (typeof totalStr === 'number') {\n          totalResults = totalStr;\n        }\n      }\n\n      const mapResults = data.local_results || data.place_results || [];\n      \n      for (const result of mapResults) {\n        if (results.length >= num) break;\n        \n        const website = result.website || result.link;\n        const name = result.title || result.name || \"Unknown Business\";\n        const email = website ? this.generatePotentialEmail(name, website) : undefined;\n        \n        const business: BusinessResult = {\n          name,\n          phone: this.normalizePhone(result.phone),\n          email,\n          website,\n          address: result.address,\n          category: result.type || result.types?.[0],\n          rating: result.rating,\n          reviews: result.reviews,\n          source: \"Google Maps\",\n        };\n        \n        results.push(business);\n      }\n\n      return { results, totalResults };\n\n    } catch (error: any) {\n      console.error(\"Google Maps search error:\", error.message);\n      return { results, totalResults };\n    }\n  }\n\n  // REMOVED: Legacy searchGoogleLocal() and searchGoogleMaps() methods\n  // These contained organic_results processing which returned content pages instead of businesses\n\n  private mergeResults(\n    target: BusinessResult[],\n    source: BusinessResult[],\n    seenDomains: Set<string>,\n    seenNames: Set<string>\n  ): void {\n    for (const business of source) {\n      // Extract domain for deduplication\n      const domain = business.website ? this.extractDomain(business.website) : null;\n      const normalizedName = business.name.toLowerCase().trim();\n\n      // Skip if duplicate domain or name\n      if (domain && seenDomains.has(domain)) {\n        continue;\n      }\n      if (seenNames.has(normalizedName)) {\n        continue;\n      }\n\n      // Add to results and track\n      target.push(business);\n      if (domain) seenDomains.add(domain);\n      seenNames.add(normalizedName);\n    }\n  }\n\n  private extractDomain(url: string): string | null {\n    try {\n      const urlObj = new URL(url.startsWith('http') ? url : `https://${url}`);\n      return urlObj.hostname.replace(/^www\\./, '').toLowerCase();\n    } catch {\n      return null;\n    }\n  }\n\n  private normalizePhone(phone: string | undefined): string | undefined {\n    if (!phone) return undefined;\n    // Remove common phone formatting characters\n    return phone.replace(/[\\s\\-()]/g, '').trim() || undefined;\n  }\n\n  private generatePotentialEmail(name: string, website: string): string | undefined {\n    try {\n      const domain = this.extractDomain(website);\n      if (!domain) return undefined;\n      return `info@${domain}`;\n    } catch {\n      return undefined;\n    }\n  }\n\n  private extractCategory(keyword: string): string {\n    const words = keyword.toLowerCase().split(\" \");\n    const categoryWords = words.filter(w => \n      ![\"companies\", \"company\", \"businesses\", \"business\", \"agencies\", \"agency\", \n       \"firms\", \"firm\", \"services\", \"service\", \"near\", \"me\", \"in\", \"at\", \"the\",\n       \"usa\", \"uk\", \"uae\", \"dubai\", \"india\", \"bangladesh\", \"canada\", \"australia\",\n       \"dhaka\", \"chittagong\", \"sylhet\", \"khulna\", \"rajshahi\"].includes(w)\n    );\n    return categoryWords.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(\" \") || \"General\";\n  }\n\n  // Fetch ALL results in one go (for Select All functionality)\n  async searchAllBusinesses(options: { keyword: string; location?: string }): Promise<SearchAllResults> {\n    if (!this.apiKey) {\n      throw new Error(\"SERPAPI_KEY not configured\");\n    }\n\n    const { keyword, location } = options;\n    const allResults: BusinessResult[] = [];\n    const seenDomains = new Set<string>();\n    const seenNames = new Set<string>();\n\n    try {\n      console.log(`SerpAPI: Fetching ALL results for \"${keyword}\" ${location ? `in ${location}` : ''}`);\n\n      // Geocode location\n      if (!location) {\n        throw new Error(\"Location is required for business search\");\n      }\n\n      const coordinates = await this.geocodeLocation(location);\n      if (!coordinates) {\n        throw new Error(`Unable to find location: \"${location}\". Please check the spelling or try a different location.`);\n      }\n\n      console.log(`Geocoded \"${location}\" to ${coordinates}`);\n\n      const RAW_PER_CALL = 20; // Google Maps returns 20 per call\n      const MAX_PAGES = 15; // Safety limit: max 300 raw results (15  20)\n      let offset = 0;\n      let serpApiTotal = 0;\n      let consecutiveEmpty = 0;\n\n      // Keep fetching until API exhausted or max pages reached\n      for (let page = 0; page < MAX_PAGES; page++) {\n        const { results: mapsResults, totalResults: mapsTotal } = await this.searchGoogleMapsWithMeta(\n          keyword,\n          coordinates,\n          offset,\n          RAW_PER_CALL\n        );\n\n        if (mapsTotal > serpApiTotal) {\n          serpApiTotal = mapsTotal;\n        }\n\n        // Merge with deduplication\n        const beforeCount = allResults.length;\n        this.mergeResults(allResults, mapsResults, seenDomains, seenNames);\n        const newAdded = allResults.length - beforeCount;\n\n        offset += RAW_PER_CALL;\n\n        // Stop conditions:\n        // 1. Got fewer results than requested (API exhausted)\n        if (mapsResults.length < RAW_PER_CALL) {\n          console.log(`API exhausted at offset ${offset - RAW_PER_CALL} (got ${mapsResults.length}/${RAW_PER_CALL})`);\n          break;\n        }\n\n        // 2. No new unique results in 2 consecutive calls (all duplicates)\n        if (newAdded === 0) {\n          consecutiveEmpty++;\n          if (consecutiveEmpty >= 2) {\n            console.log(`Stopping: No new unique results for ${consecutiveEmpty} consecutive calls`);\n            break;\n          }\n        } else {\n          consecutiveEmpty = 0;\n        }\n\n        // 3. Reached API's reported total\n        if (serpApiTotal > 0 && offset >= serpApiTotal) {\n          console.log(`Reached API's reported total: ${serpApiTotal}`);\n          break;\n        }\n\n        // Small delay between API calls to be respectful\n        await new Promise(resolve => setTimeout(resolve, 100));\n      }\n\n      // Filter for qualified businesses\n      const filtered = allResults.filter(business => \n        business.email || business.phone || business.website || business.address\n      );\n\n      console.log(`SerpAPI Search All: Raw=${allResults.length}, Qualified=${filtered.length}, Offset=${offset}`);\n\n      return {\n        results: filtered,\n        totalResults: filtered.length,\n      };\n\n    } catch (error: any) {\n      console.error(\"SerpAPI searchAll error:\", error.message);\n      throw error;\n    }\n  }\n}\n\nexport const serpApiService = new SerpApiService();\n","path":null,"size_bytes":18969,"size_tokens":null},"client/src/pages/project-credentials.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { \n  Plus, \n  Pencil, \n  Trash2, \n  ExternalLink, \n  Copy, \n  Check, \n  Search, \n  Server, \n  Globe, \n  Database, \n  Key, \n  Play,\n  Image as ImageIcon,\n  Video,\n  Building2,\n  X\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormDescription,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { type ProjectCredentials, type Client, HOSTING_PLATFORMS } from \"@shared/schema\";\n\ninterface EnrichedCredential extends ProjectCredentials {\n  clientName: string | null;\n  clientEmail: string | null;\n  clientCompany: string | null;\n}\n\nconst formSchema = z.object({\n  projectName: z.string().min(1, \"Project name is required\"),\n  clientId: z.string().optional(),\n  hostingPlatform: z.string().optional(),\n  liveLink: z.string().url(\"Invalid URL\").optional().or(z.literal(\"\")),\n  adminPanelLink: z.string().url(\"Invalid URL\").optional().or(z.literal(\"\")),\n  databaseUrl: z.string().optional(),\n  serverCredentials: z.string().optional(),\n  shortDescription: z.string().optional(),\n  additionalNotes: z.string().optional(),\n  shortVideoUrl: z.string().url(\"Invalid URL\").optional().or(z.literal(\"\")),\n  fullVideoUrl: z.string().url(\"Invalid URL\").optional().or(z.literal(\"\")),\n});\n\ntype FormData = z.infer<typeof formSchema>;\n\nexport default function ProjectCredentialsPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingCredential, setEditingCredential] = useState<EnrichedCredential | null>(null);\n  const [deleteCredential, setDeleteCredential] = useState<EnrichedCredential | null>(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [copiedField, setCopiedField] = useState<string | null>(null);\n  const [thumbnailFile, setThumbnailFile] = useState<File | null>(null);\n  const [thumbnailPreview, setThumbnailPreview] = useState<string | null>(null);\n\n  const form = useForm<FormData>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      projectName: \"\",\n      clientId: \"none\",\n      hostingPlatform: \"\",\n      liveLink: \"\",\n      adminPanelLink: \"\",\n      databaseUrl: \"\",\n      serverCredentials: \"\",\n      shortDescription: \"\",\n      additionalNotes: \"\",\n      shortVideoUrl: \"\",\n      fullVideoUrl: \"\",\n    },\n  });\n\n  const { data: credentials, isLoading } = useQuery<EnrichedCredential[]>({\n    queryKey: [\"/api/project-credentials\"],\n  });\n\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: FormData) => {\n      const formData = new FormData();\n      Object.entries(data).forEach(([key, value]) => {\n        if (value && value !== \"none\") formData.append(key, value);\n      });\n      if (thumbnailFile) {\n        formData.append(\"thumbnail\", thumbnailFile);\n      }\n      \n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(\"/api/project-credentials\", {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n        body: formData,\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to create credential\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/project-credentials\"] });\n      toast({ title: \"Project credential created successfully\" });\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: FormData }) => {\n      const formData = new FormData();\n      Object.entries(data).forEach(([key, value]) => {\n        if (value !== undefined && value !== null && value !== \"none\") formData.append(key, value);\n      });\n      if (thumbnailFile) {\n        formData.append(\"thumbnail\", thumbnailFile);\n      }\n      \n      const token = localStorage.getItem(\"token\");\n      const response = await fetch(`/api/project-credentials/${id}`, {\n        method: \"PATCH\",\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n        body: formData,\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to update credential\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/project-credentials\"] });\n      toast({ title: \"Project credential updated successfully\" });\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/project-credentials/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/project-credentials\"] });\n      toast({ title: \"Project credential deleted successfully\" });\n      setDeleteCredential(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const resetForm = () => {\n    form.reset();\n    setEditingCredential(null);\n    setIsDialogOpen(false);\n    setThumbnailFile(null);\n    setThumbnailPreview(null);\n  };\n\n  const handleEdit = (credential: EnrichedCredential) => {\n    setEditingCredential(credential);\n    form.reset({\n      projectName: credential.projectName,\n      clientId: credential.clientId || \"none\",\n      hostingPlatform: credential.hostingPlatform || \"\",\n      liveLink: credential.liveLink || \"\",\n      adminPanelLink: credential.adminPanelLink || \"\",\n      databaseUrl: credential.databaseUrl || \"\",\n      serverCredentials: credential.serverCredentials || \"\",\n      shortDescription: credential.shortDescription || \"\",\n      additionalNotes: credential.additionalNotes || \"\",\n      shortVideoUrl: credential.shortVideoUrl || \"\",\n      fullVideoUrl: credential.fullVideoUrl || \"\",\n    });\n    if (credential.thumbnailUrl) {\n      setThumbnailPreview(`/${credential.thumbnailUrl}`);\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleThumbnailChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setThumbnailFile(file);\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setThumbnailPreview(reader.result as string);\n      };\n      reader.readAsDataURL(file);\n    }\n  };\n\n  const copyToClipboard = async (text: string, field: string) => {\n    try {\n      await navigator.clipboard.writeText(text);\n      setCopiedField(field);\n      toast({ title: \"Copied to clipboard\" });\n      setTimeout(() => setCopiedField(null), 2000);\n    } catch {\n      toast({ title: \"Failed to copy\", variant: \"destructive\" });\n    }\n  };\n\n  const onSubmit = (data: FormData) => {\n    if (editingCredential) {\n      updateMutation.mutate({ id: editingCredential.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const filteredCredentials = credentials?.filter(c => \n    c.projectName.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    c.clientName?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    c.hostingPlatform?.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const getHostingBadgeColor = (platform: string | null) => {\n    if (!platform) return \"secondary\";\n    const colors: Record<string, string> = {\n      \"Render\": \"bg-purple-500/10 text-purple-600 dark:text-purple-400\",\n      \"Replit\": \"bg-orange-500/10 text-orange-600 dark:text-orange-400\",\n      \"Namecheap\": \"bg-blue-500/10 text-blue-600 dark:text-blue-400\",\n      \"VPS\": \"bg-green-500/10 text-green-600 dark:text-green-400\",\n      \"Shared Hosting\": \"bg-yellow-500/10 text-yellow-600 dark:text-yellow-400\",\n      \"AWS\": \"bg-amber-500/10 text-amber-600 dark:text-amber-400\",\n      \"DigitalOcean\": \"bg-cyan-500/10 text-cyan-600 dark:text-cyan-400\",\n      \"Vercel\": \"bg-slate-500/10 text-slate-600 dark:text-slate-400\",\n      \"Netlify\": \"bg-teal-500/10 text-teal-600 dark:text-teal-400\",\n      \"Heroku\": \"bg-violet-500/10 text-violet-600 dark:text-violet-400\",\n    };\n    return colors[platform] || \"bg-gray-500/10 text-gray-600 dark:text-gray-400\";\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Project Credentials</h1>\n          <p className=\"text-muted-foreground\">Manage software project credentials, hosting details, and video links</p>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={(open) => {\n          if (!open) resetForm();\n          setIsDialogOpen(open);\n        }}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-add-credential\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Credential\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>{editingCredential ? \"Edit Project Credential\" : \"Add New Project Credential\"}</DialogTitle>\n              <DialogDescription>\n                Store all credentials and links for easy access and sharing with clients.\n              </DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"projectName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Project Name *</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"My Awesome Project\" {...field} data-testid=\"input-project-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"clientId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Client</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-client\">\n                              <SelectValue placeholder=\"Select a client\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"none\">No Client</SelectItem>\n                            {clients?.map((client) => (\n                              <SelectItem key={client.id} value={client.id}>\n                                {client.name} {client.company ? `(${client.company})` : \"\"}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"hostingPlatform\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Hosting Platform</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-hosting\">\n                              <SelectValue placeholder=\"Select platform\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {HOSTING_PLATFORMS.map((platform) => (\n                              <SelectItem key={platform} value={platform}>\n                                {platform}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"liveLink\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Live Link</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"https://example.com\" {...field} data-testid=\"input-live-link\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"adminPanelLink\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Admin Panel Link</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"https://example.com/admin\" {...field} data-testid=\"input-admin-link\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"databaseUrl\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Database URL</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"postgresql://...\" {...field} data-testid=\"input-database-url\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"serverCredentials\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Server Login Credentials</FormLabel>\n                      <FormControl>\n                        <Textarea \n                          placeholder=\"Username: admin&#10;Password: ****&#10;SSH Key: ...\" \n                          className=\"min-h-[80px]\"\n                          {...field} \n                          data-testid=\"input-server-credentials\"\n                        />\n                      </FormControl>\n                      <FormDescription>Store SSH, FTP, or hosting panel credentials</FormDescription>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"shortVideoUrl\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Short Presentable Video (1-2 min)</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"https://youtube.com/watch?v=...\" {...field} data-testid=\"input-short-video\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"fullVideoUrl\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Full Features Video (Demo)</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"https://youtube.com/watch?v=...\" {...field} data-testid=\"input-full-video\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div>\n                  <FormLabel>Project Thumbnail / Logo</FormLabel>\n                  <div className=\"mt-2 flex items-center gap-4\">\n                    {thumbnailPreview && (\n                      <div className=\"relative\">\n                        <img \n                          src={thumbnailPreview} \n                          alt=\"Thumbnail preview\" \n                          className=\"h-20 w-20 object-cover rounded-md border\"\n                        />\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"absolute -top-2 -right-2 h-6 w-6 rounded-full bg-destructive text-destructive-foreground\"\n                          onClick={() => {\n                            setThumbnailFile(null);\n                            setThumbnailPreview(null);\n                          }}\n                        >\n                          <X className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    )}\n                    <Input\n                      type=\"file\"\n                      accept=\"image/*\"\n                      onChange={handleThumbnailChange}\n                      data-testid=\"input-thumbnail\"\n                    />\n                  </div>\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"shortDescription\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Short Description</FormLabel>\n                      <FormControl>\n                        <Textarea \n                          placeholder=\"Brief description of the project...\" \n                          className=\"min-h-[60px]\"\n                          {...field} \n                          data-testid=\"input-description\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"additionalNotes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Additional Notes</FormLabel>\n                      <FormControl>\n                        <Textarea \n                          placeholder=\"Any other important information...\" \n                          className=\"min-h-[60px]\"\n                          {...field} \n                          data-testid=\"input-notes\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex justify-end gap-2 pt-4\">\n                  <Button type=\"button\" variant=\"outline\" onClick={resetForm} data-testid=\"button-cancel\">\n                    Cancel\n                  </Button>\n                  <Button \n                    type=\"submit\" \n                    disabled={createMutation.isPending || updateMutation.isPending}\n                    data-testid=\"button-submit\"\n                  >\n                    {createMutation.isPending || updateMutation.isPending ? \"Saving...\" : editingCredential ? \"Update\" : \"Create\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"flex items-center gap-2\">\n        <div className=\"relative flex-1 max-w-sm\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search projects, clients, or platforms...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search\"\n          />\n        </div>\n        <Badge variant=\"secondary\" className=\"whitespace-nowrap\">\n          {filteredCredentials?.length || 0} Projects\n        </Badge>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i}>\n              <CardHeader>\n                <Skeleton className=\"h-6 w-3/4\" />\n                <Skeleton className=\"h-4 w-1/2\" />\n              </CardHeader>\n              <CardContent>\n                <Skeleton className=\"h-20 w-full\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : !filteredCredentials?.length ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <Server className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium mb-1\">No Project Credentials</h3>\n            <p className=\"text-muted-foreground text-center mb-4\">\n              {searchTerm ? \"No credentials match your search.\" : \"Add your first project credential to get started.\"}\n            </p>\n            {!searchTerm && (\n              <Button onClick={() => setIsDialogOpen(true)} data-testid=\"button-add-first\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Credential\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4\">\n          {filteredCredentials.map((credential) => (\n            <Card key={credential.id} className=\"group\" data-testid={`card-credential-${credential.id}`}>\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex items-center gap-3 min-w-0\">\n                    {credential.thumbnailUrl ? (\n                      <img \n                        src={`/${credential.thumbnailUrl}`} \n                        alt={credential.projectName}\n                        className=\"h-10 w-10 rounded-md object-cover border\"\n                      />\n                    ) : (\n                      <div className=\"h-10 w-10 rounded-md bg-muted flex items-center justify-center\">\n                        <ImageIcon className=\"h-5 w-5 text-muted-foreground\" />\n                      </div>\n                    )}\n                    <div className=\"min-w-0\">\n                      <CardTitle className=\"text-base truncate\" data-testid={`text-project-name-${credential.id}`}>\n                        {credential.projectName}\n                      </CardTitle>\n                      {credential.clientName && (\n                        <CardDescription className=\"flex items-center gap-1 text-xs\">\n                          <Building2 className=\"h-3 w-3\" />\n                          <span className=\"truncate\">{credential.clientName}</span>\n                        </CardDescription>\n                      )}\n                    </div>\n                  </div>\n                  {credential.hostingPlatform && (\n                    <Badge variant=\"secondary\" className={getHostingBadgeColor(credential.hostingPlatform)}>\n                      {credential.hostingPlatform}\n                    </Badge>\n                  )}\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {credential.shortDescription && (\n                  <p className=\"text-sm text-muted-foreground line-clamp-2\">\n                    {credential.shortDescription}\n                  </p>\n                )}\n\n                <div className=\"space-y-2\">\n                  {credential.liveLink && (\n                    <div className=\"flex items-center justify-between gap-2 text-sm\">\n                      <div className=\"flex items-center gap-2 text-muted-foreground min-w-0\">\n                        <Globe className=\"h-4 w-4 shrink-0\" />\n                        <span className=\"truncate\">{credential.liveLink}</span>\n                      </div>\n                      <div className=\"flex items-center gap-1\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-7 w-7\"\n                          onClick={() => copyToClipboard(credential.liveLink!, `live-${credential.id}`)}\n                          data-testid={`button-copy-live-${credential.id}`}\n                        >\n                          {copiedField === `live-${credential.id}` ? <Check className=\"h-3 w-3\" /> : <Copy className=\"h-3 w-3\" />}\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-7 w-7\"\n                          onClick={() => window.open(credential.liveLink!, \"_blank\")}\n                          data-testid={`button-open-live-${credential.id}`}\n                        >\n                          <ExternalLink className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n\n                  {credential.adminPanelLink && (\n                    <div className=\"flex items-center justify-between gap-2 text-sm\">\n                      <div className=\"flex items-center gap-2 text-muted-foreground min-w-0\">\n                        <Key className=\"h-4 w-4 shrink-0\" />\n                        <span className=\"truncate\">Admin Panel</span>\n                      </div>\n                      <div className=\"flex items-center gap-1\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-7 w-7\"\n                          onClick={() => copyToClipboard(credential.adminPanelLink!, `admin-${credential.id}`)}\n                          data-testid={`button-copy-admin-${credential.id}`}\n                        >\n                          {copiedField === `admin-${credential.id}` ? <Check className=\"h-3 w-3\" /> : <Copy className=\"h-3 w-3\" />}\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-7 w-7\"\n                          onClick={() => window.open(credential.adminPanelLink!, \"_blank\")}\n                          data-testid={`button-open-admin-${credential.id}`}\n                        >\n                          <ExternalLink className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n\n                  {credential.databaseUrl && (\n                    <div className=\"flex items-center justify-between gap-2 text-sm\">\n                      <div className=\"flex items-center gap-2 text-muted-foreground min-w-0\">\n                        <Database className=\"h-4 w-4 shrink-0\" />\n                        <span className=\"truncate\">Database URL</span>\n                      </div>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-7 w-7\"\n                        onClick={() => copyToClipboard(credential.databaseUrl!, `db-${credential.id}`)}\n                        data-testid={`button-copy-db-${credential.id}`}\n                      >\n                        {copiedField === `db-${credential.id}` ? <Check className=\"h-3 w-3\" /> : <Copy className=\"h-3 w-3\" />}\n                      </Button>\n                    </div>\n                  )}\n                </div>\n\n                {(credential.shortVideoUrl || credential.fullVideoUrl) && (\n                  <div className=\"flex items-center gap-2 pt-2\">\n                    {credential.shortVideoUrl && (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"flex-1\"\n                        onClick={() => window.open(credential.shortVideoUrl!, \"_blank\")}\n                        data-testid={`button-short-video-${credential.id}`}\n                      >\n                        <Play className=\"h-3 w-3 mr-1\" />\n                        Short Demo\n                      </Button>\n                    )}\n                    {credential.fullVideoUrl && (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"flex-1\"\n                        onClick={() => window.open(credential.fullVideoUrl!, \"_blank\")}\n                        data-testid={`button-full-video-${credential.id}`}\n                      >\n                        <Video className=\"h-3 w-3 mr-1\" />\n                        Full Demo\n                      </Button>\n                    )}\n                  </div>\n                )}\n\n                <div className=\"flex items-center justify-end gap-1 pt-2 border-t\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleEdit(credential)}\n                    data-testid={`button-edit-${credential.id}`}\n                  >\n                    <Pencil className=\"h-4 w-4 mr-1\" />\n                    Edit\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"text-destructive hover:text-destructive\"\n                    onClick={() => setDeleteCredential(credential)}\n                    data-testid={`button-delete-${credential.id}`}\n                  >\n                    <Trash2 className=\"h-4 w-4 mr-1\" />\n                    Delete\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <AlertDialog open={!!deleteCredential} onOpenChange={() => setDeleteCredential(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Project Credential</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete \"{deleteCredential?.projectName}\"? This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              onClick={() => deleteCredential && deleteMutation.mutate(deleteCredential.id)}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":32674,"size_tokens":null}},"version":2}